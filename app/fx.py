import os
import sqlite3
import random
import re
import locale
import asyncio
import logging
import time
from datetime import datetime, timedelta, timezone, date
import json
import re
import aiosqlite
try:
    import imghdr
except ImportError:
    import PIL.Image as imghdr
match = re.match(r"(\d+)", "–ë–æ—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è...")
if match:
    print(match.group(1))
import pymorphy3
import requests

from telegram import Update, LabeledPrice, InlineKeyboardButton, InlineKeyboardMarkup, Message, CallbackQuery, \
    InputMediaPhoto
from telegram.ext import (
    ApplicationBuilder,
    CommandHandler,
    CallbackQueryHandler,
    ContextTypes,
    MessageHandler,
    PreCheckoutQueryHandler,
    filters,
    ConversationHandler,
)
from telegram.constants import ParseMode
import telegram.error
from telegram.error import Forbidden, TelegramError
import platform
import psutil
from telegram import ChatPermissions
import subprocess
import GPUtil
from zoneinfo import ZoneInfo
from telegram.helpers import escape_markdown
from html import escape
import html
import nest_asyncio
from telegram import ChatMember
from collections import defaultdict, deque
from telegram.helpers import mention_markdown, mention_html
import inspect
import traceback
from pathlib import Path
from asyncio import Semaphore
import math
from telegram import ChatMemberAdministrator, ChatMemberOwner, ChatMemberUpdated
from telegram.constants import ChatMemberStatus
from telegram import ChatMemberRestricted
from yoomoney import Client
import functools
import pytz
from telegram.error import BadRequest
from telegram.ext import (
    Application,
    CommandHandler,
    ContextTypes,
)
from telegram import User
from telegram import Update, ReplyKeyboardMarkup, KeyboardButton, WebAppInfo
from apscheduler.schedulers.asyncio import AsyncIOScheduler
import os, sys
from decimal import Decimal

from PIL import Image, ImageDraw, ImageFont
import io
from telegram import InputFile
from typing import Optional
import string
import secrets
import os
import sys
import logging
from telegram import Update
from telegram.ext import ApplicationBuilder, CommandHandler, ContextTypes
import unicodedata
import base64
from typing import List, Dict

nest_asyncio.apply()
start_time = time.time()

Transaction_ID = -1003738218334

def write_log(log_type: str, admin_id: int, target_id: str, duration: str = "-", reason: str = "-", chat_id: str = "-",
              action: str = "-", amount: int = None):
    if not os.path.exists(LOG_FILE):
        with open(LOG_FILE, "w", encoding="utf-8") as f:
            json.dump({}, f, ensure_ascii=False, indent=4)

    with open(LOG_FILE, "r", encoding="utf-8") as f:
        logs = json.load(f)

    if log_type not in logs:
        logs[log_type] = []

    log_id = len(logs[log_type]) + 1

    log_entry = {
        "id": log_id,
        "admin_id": admin_id,
        "target_id": target_id,
        "chat_id": chat_id,
        "duration": duration,
        "reason": reason,
        "action": action,
        "date": datetime.now().strftime("%Y-%m-%d"),
        "time": datetime.now().strftime("%H:%M:%S")
    }

    if amount is not None:
        log_entry["amount"] = amount

    logs[log_type].append(log_entry)

    with open(LOG_FILE, "w", encoding="utf-8") as f:
        json.dump(logs, f, ensure_ascii=False, indent=4)


ADMINS = {7406372338, 7283522738}

async def restart_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """
    –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –±–æ—Ç–∞. –î–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º.
    """
    if update.effective_user.id not in ADMINS:
        await update.message.reply_text("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞.")
        return

    await update.message.reply_text(
        "‚ôªÔ∏è <b>–ë–æ—Ç –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è...</b> ‚è≥\n\n"
        "<pre>üïî | –û–∂–∏–¥–∞–µ–º–æ–µ –≤—Ä–µ–º—è –∑–∞–ø—É—Å–∫–∞: ‚âà 2 –º–∏–Ω. (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç –Ω–∞–≥—Ä—É–∑–∫–∏)</pre>\n"
        "‚ö†Ô∏è –ï—Å–ª–∏ –∑–∞–ø—É—Å–∫ –∑–∞–Ω–∏–º–∞–µ—Ç –±–æ–ª–µ–µ 10 –º–∏–Ω, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–≤—è–∂–∏—Ç–µ—Å—å —Å —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ–º: @FernieK",
        parse_mode="HTML"
    )

    # –ü–æ–ª–Ω—ã–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Ç–µ–∫—É—â–µ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞ Python
    python = sys.executable
    os.execv(python, [python] + sys.argv)

async def id_command(update: Update, context: ContextTypes.DEFAULT_TYPE, arg_text: str = None):
    # –ï—Å–ª–∏ –∫–æ–º–∞–Ω–¥–∞ –≤ –æ—Ç–≤–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ ‚Äî –±–µ—Ä–µ–º –æ—Ç—Ç—É–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    if update.message.reply_to_message:
        user = update.message.reply_to_message.from_user
        user_id = str(user.id)
        await update.message.reply_text(
            f"üÜî ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: <code>{user_id}</code>\nüë§ {get_display_name_html_new(user)}",
            parse_mode="HTML"
        )
        return

    # –ï—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–ª–∏ –∞—Ä–≥—É–º–µ–Ω—Ç —á–µ—Ä–µ–∑ .–∏–¥ –∏–ª–∏ . –∏–¥
    if arg_text:
        search_text = arg_text

        if search_text.startswith("@"):
            username = search_text[1:]  # —É–±–∏—Ä–∞–µ–º @
            # –ò—â–µ–º –≤ –±–∞–∑–µ users
            with sqlite3.connect(DB_PATH) as conn:
                cursor = conn.cursor()
                cursor.execute("SELECT user_id FROM users WHERE username = ?", (username,))
                row = cursor.fetchone()
                if not row:
                    await update.message.reply_text(f"‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å username @{username} –Ω–µ –Ω–∞–π–¥–µ–Ω.")
                    return
                user_id = row[0]
                # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –ø–æ–ª—É—á–∏—Ç—å display_name —á–µ—Ä–µ–∑ Telegram API
                try:
                    target_user_obj = await context.bot.get_chat(int(user_id))
                    user_display = get_display_name_html_new(target_user_obj)
                except:
                    user_display = f"@{username}"

                await update.message.reply_text(
                    f"üÜî ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: <code>{user_id}</code>\nüë§ {user_display}",
                    parse_mode="HTML"
                )
                return
        else:
            # –ê—Ä–≥—É–º–µ–Ω—Ç ‚Äî —ç—Ç–æ ID –Ω–∞–ø—Ä—è–º—É—é
            try:
                user_id = int(search_text)
                target_user_obj = await context.bot.get_chat(user_id)
                user_display = get_display_name_html_new(target_user_obj)
                await update.message.reply_text(
                    f"üÜî ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: <code>{user_id}</code>\nüë§ {user_display}",
                    parse_mode="HTML"
                )
            except:
                await update.message.reply_text(f"‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å ID {search_text} –Ω–µ –Ω–∞–π–¥–µ–Ω.")
            return

    # –ù–µ—Ç reply –∏ –Ω–µ—Ç –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ ‚Äî –ø–æ–∫–∞–∂–µ–º ID –∞–≤—Ç–æ—Ä–∞ –∫–æ–º–∞–Ω–¥—ã
    user = update.message.from_user
    await update.message.reply_text(
        f"üÜî –í–∞—à ID: <code>{user.id}</code>\nüë§ {get_display_name_html_new(user)}",
        parse_mode="HTML"
    )

# –ÆMoney –¥–∞–Ω–Ω—ã–µ
CLIENT_ID = "4F3FC2DFB20C5E1C806A823BBCAF9C5702373A333559DD3B549090335CAF5456"
CLIENT_SECRET = "978B70B0231B132D5E8EA2887C61084081D57099B2EF838233F248F442E79D71A1CE2B05D55B8ECBC8FF2B0B2422058E5532D1DE682914065A4E7CDF018EA9F7"
WALLET_NUMBER = "4100118171100287"  # –≤–∞—à –∫–æ—à–µ–ª–µ–∫ –ÆMoney


def get_user_dc(telegram_id):
    conn = sqlite3.connect(DB_PATH)
    c = conn.cursor()
    c.execute("SELECT dc_balance FROM users WHERE user_id = ?", (str(telegram_id),))
    row = c.fetchone()
    conn.close()
    if row:
        return row[0]
    return 0


def add_dc(telegram_id, amount):
    conn = sqlite3.connect(DB_PATH)
    c = conn.cursor()
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ —Ç–∞–±–ª–∏—Ü–µ users
    c.execute("SELECT user_id FROM users WHERE user_id = ?", (str(telegram_id),))
    if not c.fetchone():
        # –ï—Å–ª–∏ –Ω–µ—Ç, —Å–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å
        c.execute("INSERT INTO users (user_id, dc_balance) VALUES (?, ?)",
                  (str(telegram_id), amount))
    else:
        # –ï—Å–ª–∏ –µ—Å—Ç—å, –æ–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å
        c.execute("UPDATE users SET dc_balance = dc_balance + ? WHERE user_id = ?",
                  (amount, str(telegram_id)))
    conn.commit()
    conn.close()


def is_operation_processed(operation_id):
    conn = sqlite3.connect(DB_PATH)
    c = conn.cursor()
    c.execute("SELECT operation_id FROM processed_operations WHERE operation_id = ?", (operation_id,))
    row = c.fetchone()
    conn.close()
    return row is not None


def mark_operation_processed(operation_id):
    conn = sqlite3.connect(DB_PATH)
    c = conn.cursor()
    c.execute("INSERT INTO processed_operations (operation_id) VALUES (?)", (operation_id,))
    conn.commit()
    conn.close()


# -------- –ÆMoney API --------
WALLET_NUMBER = "4100118171100287"  # —Ç–≤–æ–π –∫–æ—à–µ–ª–µ–∫


def generate_payment_link(wallet_number, user_id, amount):
    return (
        f"https://yoomoney.ru/quickpay/confirm.xml?"
        f"receiver={wallet_number}&"
        f"formcomment=–î–æ–Ω–∞—Ç&"
        f"short-dest=–î–æ–Ω–∞—Ç+–±–æ—Ç—É&"
        f"label={user_id}&"
        f"quickpay-form=donate&"
        f"targets=–î–æ–Ω–∞—Ç+–±–æ—Ç—É&"
        f"sum={amount}&"
        f"comment=–î–æ–Ω–∞—Ç+–±–æ—Ç—É&"
        f"paymentType=AC"
    )


async def donate(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    try:
        amount = int(context.args[0])
        if amount <= 0:
            await update.message.reply_text("‚ùå –°—É–º–º–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–π.")
            return
    except (IndexError, ValueError):
        await update.message.reply_text("‚ùó –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /donate {—Å—É–º–º–∞}\n–ü—Ä–∏–º–µ—Ä: /donate 15")
        return

    payment_link = generate_payment_link(WALLET_NUMBER, user_id, amount)

    keyboard = InlineKeyboardMarkup(
        [[InlineKeyboardButton("üí≥ –û–ø–ª–∞—Ç–∏—Ç—å", url=payment_link)]]
    )

    text = (
        "‚ñ∂Ô∏è –í—Å–µ –≥–æ—Ç–æ–≤–æ –¥–ª—è –æ–ø–ª–∞—Ç—ã.\n"
        "üîπ –ü–µ—Ä–µ–π–¥–∏—Ç–µ –ø–æ –∫–Ω–æ–ø–∫–µ –Ω–∏–∂–µ –∏ —Å–æ–≤–µ—Ä—à–∏—Ç–µ –æ–ø–ª–∞—Ç—É.\n"
        "üñº –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã —Å–¥–µ–ª–∞–π—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç —á–µ–∫–∞.\n"
        "‚Ü©Ô∏è –í–µ—Ä–Ω–∏—Ç–µ—Å—å –≤ –±–æ—Ç –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–º–∞–Ω–¥—É /pays, —á—Ç–æ–±—ã –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø–ª–∞—Ç–µ–∂.\n\n"
        f"üí∞ *–°—É–º–º–∞ –ø–ª–∞—Ç–µ–∂–∞:* `{amount} ‚ÇΩ`\n"
        "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
    )

    await update.message.reply_text(text, reply_markup=keyboard, parse_mode="Markdown")


ADMIN_ID = 7406372338

AMOUNT, SCREENSHOT1, SCREENSHOT2 = range(3)


def add_dc(user_id: int, amount: int):
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    cursor.execute("SELECT dc_balance FROM users WHERE user_id = ?", (str(user_id),))
    row = cursor.fetchone()
    if row:
        new_balance = row[0] + amount
        cursor.execute("UPDATE users SET dc_balance = ? WHERE user_id = ?", (new_balance, str(user_id)))
    else:
        # –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç ‚Äî –º–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å
        cursor.execute("INSERT INTO users (user_id, dc_balance) VALUES (?, ?)", (str(user_id), amount))

    conn.commit()
    conn.close()


async def paystatus_start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if update.effective_chat.type != "private":
        await update.message.reply_text("‚ö†Ô∏è –ö–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –≤ –ª–∏—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö.")
        return ConversationHandler.END

    await update.message.reply_text("üí∏ –í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –ø–ª–∞—Ç–µ–∂–∞:")
    return AMOUNT


async def paystatus_amount(update: Update, context: ContextTypes.DEFAULT_TYPE):
    try:
        amount = int(update.message.text)
        if amount <= 0:
            raise ValueError()
        context.user_data["amount"] = amount
    except ValueError:
        await update.message.reply_text("‚ùó –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —á–∏—Å–ª–æ –±–æ–ª—å—à–µ 0.")
        return AMOUNT

    await update.message.reply_text("üì∏ –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç –æ–∫–Ω–∞ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã:")
    return SCREENSHOT1


async def paystatus_screenshot1(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not update.message.photo:
        await update.message.reply_text("‚ö†Ô∏è –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ-—Å–∫—Ä–∏–Ω—à–æ—Ç.")
        return SCREENSHOT1

    context.user_data["screenshot1"] = update.message.photo[-1]
    await update.message.reply_text("üì∏ –¢–µ–ø–µ—Ä—å –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç —á–µ–∫–∞ –æ–ø–ª–∞—Ç—ã:")
    return SCREENSHOT2


async def paystatus_screenshot2(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not update.message.photo:
        await update.message.reply_text("‚ö†Ô∏è –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ-—Å–∫—Ä–∏–Ω—à–æ—Ç.")
        return SCREENSHOT2

    context.user_data["screenshot2"] = update.message.photo[-1]

    user = update.effective_user
    amount = context.user_data["amount"]
    screenshot1 = context.user_data["screenshot1"]
    screenshot2 = context.user_data["screenshot2"]
    now = datetime.now()

    text = (
        f"üí≥ <b>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞</b>\n\n"
        f"üë§ <a href=\"tg://user?id={user.id}\">{html.escape(user.full_name)}</a>\n"
        f"üÜî TelegramID: <code>{user.id}</code>\n"
        f"üìÖ –î–∞—Ç–∞: {now.strftime('%d.%m.%Y')}\n"
        f"‚è∞ –í—Ä–µ–º—è: {now.strftime('%H:%M:%S')}\n"
        f"üí∞ –°—É–º–º–∞: <b>{amount} ‚ÇΩ</b>"
    )

    keyboard = InlineKeyboardMarkup([
        [
            InlineKeyboardButton("‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å", callback_data=f"confirm_{user.id}_{amount}"),
            InlineKeyboardButton("‚ùå –û—Ç–∫–∞–∑–∞—Ç—å", callback_data=f"deny_{user.id}")
        ]
    ])

    await context.bot.send_photo(chat_id=ADMIN_ID, photo=screenshot1.file_id, caption="üñº –°–∫—Ä–∏–Ω—à–æ—Ç –æ–ø–ª–∞—Ç—ã ‚Ññ1")
    await context.bot.send_photo(chat_id=ADMIN_ID, photo=screenshot2.file_id, caption="üñº –°–∫—Ä–∏–Ω—à–æ—Ç –æ–ø–ª–∞—Ç—ã ‚Ññ2")
    await context.bot.send_message(chat_id=ADMIN_ID, text=text, reply_markup=keyboard, parse_mode="HTML")

    await update.message.reply_text(
        "üì® –í–∞—à–∞ –∑–∞—è–≤–∫–∞ –Ω–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞. –û–∂–∏–¥–∞–π—Ç–µ –æ—Ç–≤–µ—Ç–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏.\n\n"
        "‚ÑπÔ∏è –î–ª—è —Å–≤—è–∑–∏ —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–µ–π –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /ask"
    )

    context.user_data.clear()
    return ConversationHandler.END


async def admin_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    data = query.data
    print(f"Callback data received: {data}")
    await query.answer()  # –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ–º –ø–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–ª–ª–±–µ–∫–∞

    if data.startswith("confirm_"):
        try:
            parts = data.split("_")
            if len(parts) != 3:
                raise ValueError("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞")
            _, user_id_str, amount_str = parts
            user_id = int(user_id_str)
            amount = int(amount_str)

            add_dc(user_id, amount)  # –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞

            try:
                await context.bot.send_message(
                    user_id,
                    f"‚úÖ –í–∞—à –ø–ª–∞—Ç—ë–∂ –Ω–∞ —Å—É–º–º—É {amount} ‚ÇΩ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω. –ë–∞–ª–∞–Ω—Å –ø–æ–ø–æ–ª–Ω–µ–Ω."
                )
            except Exception as e:
                print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}: {e}")

            await query.edit_message_text(f"‚úÖ –ü–ª–∞—Ç—ë–∂ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω.")

        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –≤ admin_callback confirm: {e}")
            await query.answer(f"‚ùå –û—à–∏–±–∫–∞: {e}", show_alert=True)

    elif data.startswith("deny_"):
        try:
            parts = data.split("_")
            if len(parts) != 2:
                raise ValueError("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞")
            _, user_id_str = parts
            user_id = int(user_id_str)

            try:
                await context.bot.send_message(
                    user_id,
                    "‚ùå –í–∞—à –ø–ª–∞—Ç—ë–∂ –±—ã–ª –æ—Ç–∫–ª–æ–Ω—ë–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–µ–π."
                )
            except Exception as e:
                print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}: {e}")

            await query.edit_message_text(f"üö´ –ü–ª–∞—Ç—ë–∂ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} –æ—Ç–∫–ª–æ–Ω—ë–Ω.")

        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –≤ admin_callback deny: {e}")
            await query.answer(f"‚ùå –û—à–∏–±–∫–∞: {e}", show_alert=True)

    else:
        await query.answer("–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞", show_alert=True)


# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –û—Ç–º–µ–Ω–∞ –¥–∏–∞–ª–æ–≥–∞ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ #

async def cancel(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("üö´ –û—Ç–º–µ–Ω–µ–Ω–æ.")
    context.user_data.clear()
    return ConversationHandler.END

BASE_DIR = os.path.dirname(os.path.abspath(__file__))
DB_PATH = os.path.join(BASE_DIR, "FernieUI.db")  # –≥–ª–æ–±–∞–ª—å–Ω–æ

def init_db():
    conn = sqlite3.connect(
        DB_PATH,           # –∏—Å–ø–æ–ª—å–∑—É–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é
        timeout=30.0,
        check_same_thread=False
    )

    conn.execute("PRAGMA journal_mode=WAL")
    conn.execute("PRAGMA synchronous=NORMAL")
    conn.execute("PRAGMA busy_timeout=10000")

    cursor = conn.cursor()

    cursor.execute("""
        CREATE TABLE IF NOT EXISTS users (
            user_id TEXT PRIMARY KEY,
            username TEXT,
            first_name TEXT DEFAULT '',
            nickname TEXT DEFAULT NULL,
            status INTEGER DEFAULT 0,
            balance INTEGER DEFAULT 0,
            seeds INTEGER DEFAULT 0,
            property TEXT DEFAULT '',
            exp INTEGER DEFAULT 0,
            level INTEGER DEFAULT 1,
            bonus_given INTEGER DEFAULT 0,
            inventory_car TEXT DEFAULT NULL,
            inventory_phone TEXT DEFAULT NULL,
            inventory_yacht TEXT DEFAULT NULL,
            inventory_business TEXT DEFAULT NULL,
            inventory_home TEXT DEFAULT NULL,
            inventory_pet TEXT DEFAULT NULL,
            clicks INTEGER DEFAULT 0,
            last_farm INTEGER DEFAULT 0,
            crypto_wallet INTEGER DEFAULT 0,
            dc_balance INTEGER DEFAULT 0,
            ref_count INTEGER DEFAULT 0,
            vip_level INTEGER DEFAULT 0,
            vip_expiry TEXT DEFAULT NULL
        )
        """)

    cursor.execute("""
        CREATE TABLE IF NOT EXISTS block_blast_stats (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id TEXT NOT NULL,
            score INTEGER NOT NULL,
            lines INTEGER NOT NULL,
            combo INTEGER NOT NULL,
            pieces INTEGER NOT NULL,
            coins_earned INTEGER NOT NULL,
            seeds_earned INTEGER NOT NULL,
            played_at INTEGER NOT NULL,
            FOREIGN KEY (user_id) REFERENCES users(user_id)
        )
    """)

    # –ò–Ω–¥–µ–∫—Å –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –ø–æ user_id
    cursor.execute("""
        CREATE INDEX IF NOT EXISTS idx_block_blast_user 
        ON block_blast_stats(user_id)
    """)

    # –ò–Ω–¥–µ–∫—Å –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –ø–æ —Å—á—ë—Ç—É (–¥–ª—è —Ç–∞–±–ª–∏—Ü—ã –ª–∏–¥–µ—Ä–æ–≤)
    cursor.execute("""
        CREATE INDEX IF NOT EXISTS idx_block_blast_score 
        ON block_blast_stats(score DESC)
    """)

    # –ò–Ω–¥–µ–∫—Å –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –ø–æ –≤—Ä–µ–º–µ–Ω–∏
    cursor.execute("""
        CREATE INDEX IF NOT EXISTS idx_block_blast_time 
        ON block_blast_stats(played_at DESC)
    """)

    cursor.execute("""
        CREATE TABLE IF NOT EXISTS AI_Selected (
    user_id INTEGER PRIMARY KEY,
    model_name TEXT NOT NULL
);
         """)

    cursor.execute("""
CREATE TABLE IF NOT EXISTS media_partner (
    user_id TEXT PRIMARY KEY,       -- Telegram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    media_coins INTEGER DEFAULT 0,  -- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ MediaCoins
    photo_url TEXT,                 -- URL —Ñ–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è / –±–∞–Ω–Ω–µ—Ä–∞
    joined_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP  -- –î–∞—Ç–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
);
                 """)

    cursor.execute("""
       CREATE TABLE IF NOT EXISTS ChatChangeCode (
            user_id INTEGER,
            code TEXT,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            chatID TEXT
        )
        """)

    cursor.execute("""
        CREATE TABLE IF NOT EXISTS referals (
            user_id INTEGER PRIMARY KEY,
            ref_link TEXT,
            quantity INTEGER DEFAULT 0
        )
    """)

    cursor.execute("""
        CREATE TABLE IF NOT EXISTS chat_verification (
            chat_id TEXT PRIMARY KEY,
            verification TEXT DEFAULT '‚ùå',  -- –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ –Ω–µ –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–æ
            created_at TEXT DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (chat_id) REFERENCES chats_admins(chat_id) ON DELETE CASCADE
        )
        """)

    cursor.execute("""
        CREATE TABLE IF NOT EXISTS SubFerniePlus (
            user_id TEXT PRIMARY KEY,
            end_time INTEGER
        )
        """)

    cursor.execute("""
    CREATE TABLE IF NOT EXISTS fernieplus_custom (
        user_id TEXT PRIMARY KEY,
        media_type TEXT DEFAULT 'photo',
        media_path TEXT DEFAULT 'profile_def.png'
    )
    """)

    cursor.execute("""
        CREATE TABLE IF NOT EXISTS user_quests (
            user_id TEXT PRIMARY KEY,
            quest_last INTEGER DEFAULT 0,
            quest_attempts INTEGER DEFAULT 0,
            quest_collected INTEGER DEFAULT 0,
            FOREIGN KEY(user_id) REFERENCES users(user_id)
        )
        """)

    cursor.execute("""
        CREATE TABLE IF NOT EXISTS inventory (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            owner_id TEXT NOT NULL,
            item_name TEXT NOT NULL,
            quantity INTEGER DEFAULT 1,
            FOREIGN KEY(owner_id) REFERENCES users(user_id)
        )
        """)

    cursor.execute("""
        CREATE TABLE IF NOT EXISTS charity (
            user_id TEXT,
            username TEXT,
            donation_amount TEXT DEFAULT '0',
            donated_at TEXT DEFAULT CURRENT_TIMESTAMP
        )
        """)

        # –¢–∞–±–ª–∏—Ü–∞ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –æ–±—â–µ–≥–æ –±–∞–ª–∞–Ω—Å–∞ –±–ª–∞–≥–æ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
    cursor.execute("""
        CREATE TABLE IF NOT EXISTS charity_balance (
            id INTEGER PRIMARY KEY,
            total_balance TEXT DEFAULT '0'
        )
        """)

    cursor.execute("INSERT OR IGNORE INTO charity_balance (id, total_balance) VALUES (1, '0')")

    cursor.execute("""
            CREATE TABLE IF NOT EXISTS sim_cards (
                user_id INTEGER PRIMARY KEY,
                phone_number TEXT,
                operator TEXT,
                tariff TEXT,
                balance REAL,
                sms INTEGER,
                status_tariff TEXT DEFAULT '–ê–∫—Ç–∏–≤–µ–Ω'
            )
        """)

    cursor.execute("""
        CREATE TABLE IF NOT EXISTS contacts (
        user_id INTEGER,
        number TEXT,
        name TEXT
        )
            """)

    cursor.execute("""
    CREATE TABLE IF NOT EXISTS businesses_XUI (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        business_id TEXT UNIQUE NOT NULL,
        owner_id INTEGER NOT NULL,
        business_type TEXT NOT NULL,
        name TEXT NOT NULL,
        balance TEXT NOT NULL DEFAULT '0',
        level INTEGER NOT NULL DEFAULT 1,
        employees INTEGER NOT NULL DEFAULT 0,
        products TEXT DEFAULT NULL,
        hours_without_products INTEGER NOT NULL DEFAULT 0
    )
            """)

        # –¢–∞–±–ª–∏—Ü–∞ –¥–µ—Ç–µ–π —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º –µ–¥—ã –∏ last_updated
    cursor.execute("""
        CREATE TABLE IF NOT EXISTS kids (
            kid_id INTEGER PRIMARY KEY AUTOINCREMENT,
            name TEXT NOT NULL,
            gender TEXT CHECK(gender IN ('–º', '–∂')) NOT NULL,
            birthday INTEGER NOT NULL,
            parent1_id TEXT NOT NULL,
            parent2_id TEXT NOT NULL,
            hunger INTEGER DEFAULT 100,
            happiness INTEGER DEFAULT 100,
            food INTEGER DEFAULT 0,
            last_fed INTEGER DEFAULT 0,
            last_played INTEGER DEFAULT 0,
            last_updated INTEGER DEFAULT 0,
            FOREIGN KEY(parent1_id) REFERENCES users(user_id),
            FOREIGN KEY(parent2_id) REFERENCES users(user_id)
        )
        """)

        # –ù–∞–≥—Ä–∞–¥—ã
    cursor.execute("""
        CREATE TABLE IF NOT EXISTS rewards (
            reward_id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id TEXT NOT NULL,
            reward_name TEXT NOT NULL,
            received_at TEXT NOT NULL DEFAULT (datetime('now', 'localtime')),
            awarded_by TEXT NOT NULL
        )
        """)

        # ‚úÖ –¢–∞–±–ª–∏—Ü–∞ –±–∞–Ω–∫–æ–≤—Å–∫–∏—Ö —Å—á–µ—Ç–æ–≤ (–±–∞–ª–∞–Ω—Å ‚Äî TEXT)
    cursor.execute("""
        CREATE TABLE IF NOT EXISTS Bank_New (
            user_id INTEGER PRIMARY KEY,
            first_name TEXT,
            account_name TEXT,
            account_number TEXT UNIQUE,
            balance TEXT DEFAULT '0',
            created_at TEXT
        )
        """)

    cursor.execute("""
        CREATE TABLE IF NOT EXISTS Bank_Deposit (
            user_id INTEGER PRIMARY KEY,
            deposit_balance INTEGER DEFAULT 0,
            is_active INTEGER DEFAULT 0,
            start_time TEXT,
            end_time TEXT,
            FOREIGN KEY(user_id) REFERENCES Bank_New(user_id)
        )
        """)

        # —Ç–∞–±–ª–∏—Ü–∞ –∞–¥–º–∏–Ω–æ–≤
    cursor.execute("""
            CREATE TABLE IF NOT EXISTS admins (
                user_id TEXT PRIMARY KEY,
                points INTEGER DEFAULT 0,
                warnings INTEGER DEFAULT 0
            )
        """)

        # –¢–∞–±–ª–∏—Ü–∞ departament (–û—Ç–¥–µ–ª—ã)
    cursor.execute("""
        CREATE TABLE IF NOT EXISTS departament (
            user_id TEXT PRIMARY KEY,
            department_name TEXT NOT NULL,
            role INTEGER NOT NULL CHECK(role BETWEEN 1 AND 5),
            warnings INTEGER DEFAULT 0,
            join_date TEXT NOT NULL
        )
        """)

        # –¢–∞–±–ª–∏—Ü–∞ departament (–≤—ã–≥–æ–≤–æ—Ä—ã)
    cursor.execute("""
            CREATE TABLE IF NOT EXISTS department_warns (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id TEXT NOT NULL,
                issuer_id TEXT NOT NULL,
                issuer_role TEXT NOT NULL,
                reason TEXT NOT NULL,
                timestamp TEXT NOT NULL
            )
        """)

        # –¢–∞–±–ª–∏—Ü–∞ –¥–ª—è –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç
    cursor.execute("""
        CREATE TABLE IF NOT EXISTS crypto_balances (
            user_id TEXT,
            currency TEXT,
            balance INTEGER DEFAULT 0,
            PRIMARY KEY (user_id, currency),
            FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE
        )
        """)

        # –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã
    cursor.execute("""
        CREATE TABLE IF NOT EXISTS pets (
            user_id TEXT PRIMARY KEY,
            pet_type TEXT,
            pet_name TEXT,
            happiness INTEGER DEFAULT 100,
            hunger INTEGER DEFAULT 100,
            food INTEGER DEFAULT 0,
            price INTEGER DEFAULT 10000,
            last_hunger_update TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY(user_id) REFERENCES users(user_id)
        )
        """)

    cursor.execute("""
        CREATE TABLE IF NOT EXISTS settings (
            key TEXT PRIMARY KEY,
            value TEXT
        )
        """)

    cursor.execute("""
        CREATE TABLE IF NOT EXISTS taxi_profiles (
            user_id TEXT PRIMARY KEY,
            username TEXT,
            status INTEGER DEFAULT 1,
            rank TEXT DEFAULT '–ù–æ–≤–∏—á–æ–∫',
            points INTEGER DEFAULT 0,
            orders INTEGER DEFAULT 0,
            last_orders TEXT DEFAULT '[]',
            FOREIGN KEY(user_id) REFERENCES users(user_id)
        )
        """)

    cursor.execute("""
        CREATE TABLE IF NOT EXISTS bonus_timers (
            user_id TEXT,
            bonus_type INTEGER,
            last_claim INTEGER DEFAULT 0,
            PRIMARY KEY (user_id, bonus_type),
            FOREIGN KEY(user_id) REFERENCES users(user_id)
        )
        """)

    cursor.execute("""
        CREATE TABLE IF NOT EXISTS bans (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            banned_user_id TEXT NOT NULL,
            banned_by_user_id TEXT NOT NULL,
            reason TEXT,
            duration INTEGER NOT NULL,
            timestamp_start INTEGER NOT NULL,
            timestamp_end INTEGER NOT NULL,
            chat_id TEXT
        )
        """)

    cursor.execute("""
        CREATE TABLE IF NOT EXISTS user_promocodes (
            user_id TEXT,
            promo_code TEXT,
            activations INTEGER DEFAULT 0,
            PRIMARY KEY (user_id, promo_code)
        )
        """)

    cursor.execute("""
            CREATE TABLE IF NOT EXISTS custom_promo (
                promo_code TEXT PRIMARY KEY,
                owner_id TEXT,
                level INTEGER DEFAULT 1,
                activations INTEGER DEFAULT 0,
                rewards TEXT DEFAULT '',
                verified INTEGER DEFAULT 0
            )
        """)

    cursor.execute("""
        CREATE TABLE IF NOT EXISTS user_cases (
            user_id TEXT,
            case_name TEXT,
            count INTEGER DEFAULT 0,
            PRIMARY KEY (user_id, case_name),
            FOREIGN KEY(user_id) REFERENCES users(user_id)
        )
        """)

    cursor.execute("""
        CREATE TABLE IF NOT EXISTS clans (
            clan_id INTEGER PRIMARY KEY,  -- —É–±—Ä–∞–Ω–æ AUTOINCREMENT
            name TEXT NOT NULL UNIQUE,
            owner_id TEXT NOT NULL,
            created_at TEXT DEFAULT (DATE('now')),
            is_verified INTEGER DEFAULT 0,
            is_private INTEGER DEFAULT 0,
            sale_price INTEGER DEFAULT 0
        )
        """)

    cursor.execute("""
        CREATE TABLE IF NOT EXISTS clan_members (
            user_id TEXT NOT NULL PRIMARY KEY,
            clan_id INTEGER NOT NULL,
            is_owner INTEGER DEFAULT 0,
            can_invite INTEGER DEFAULT 0,
            FOREIGN KEY(clan_id) REFERENCES clans(clan_id)
        )
        """)

    cursor.execute("""
        CREATE TABLE IF NOT EXISTS admin_treasury (
            id INTEGER PRIMARY KEY CHECK (id = 1),
            balance INTEGER DEFAULT 0,
            last_update DATE DEFAULT (DATE('now'))
        )
        """)

    cursor.execute("""
        CREATE TABLE IF NOT EXISTS marriages (
            user_id1 TEXT NOT NULL,
            user_id2 TEXT NOT NULL,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            PRIMARY KEY (user_id1, user_id2),
            FOREIGN KEY(user_id1) REFERENCES users(user_id),
            FOREIGN KEY(user_id2) REFERENCES users(user_id)
        )
        """)

    cursor.execute("SELECT 1 FROM admin_treasury WHERE id=1")
    if not cursor.fetchone():
            cursor.execute(
                "INSERT INTO admin_treasury (id, balance, last_update) VALUES (1, ?, DATE('now'))",
                (999_999_999_999_999_999,)
            )

    cursor.execute("""
        CREATE TABLE IF NOT EXISTS bans (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            banned_user_id TEXT NOT NULL,
            banned_by_user_id TEXT NOT NULL,
            reason TEXT,
            duration INTEGER NOT NULL,
            timestamp_start INTEGER NOT NULL,
            timestamp_end INTEGER NOT NULL
        )
        """)

        # –¢–∞–±–ª–∏—Ü–∞ mutes
    cursor.execute("SELECT name FROM sqlite_master WHERE type='table' AND name='mutes'")
    if not cursor.fetchone():
        cursor.execute("""
            CREATE TABLE mutes (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                muted_user_id TEXT NOT NULL,
                muted_by_user_id TEXT NOT NULL,
                reason TEXT,
                duration INTEGER NOT NULL,
                timestamp_start INTEGER NOT NULL,
                timestamp_end INTEGER NOT NULL,
                chat_id INTEGER NOT NULL DEFAULT 0
            )
            """)
    else:
        cursor.execute("PRAGMA table_info(mutes)")
        columns = [col[1] for col in cursor.fetchall()]
        if 'chat_id' not in columns:
            cursor.execute("""
                CREATE TABLE mutes_new (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    muted_user_id TEXT NOT NULL,
                    muted_by_user_id TEXT NOT NULL,
                    reason TEXT,
                    duration INTEGER NOT NULL,
                    timestamp_start INTEGER NOT NULL,
                    timestamp_end INTEGER NOT NULL,
                    chat_id INTEGER NOT NULL DEFAULT 0
                )
                """)
            cursor.execute("""
                INSERT INTO mutes_new SELECT *, 0 FROM mutes
                """)
            cursor.execute("DROP TABLE mutes")
            cursor.execute("ALTER TABLE mutes_new RENAME TO mutes")

        # === –¢–∞–±–ª–∏—Ü–∞ CHATS ===
    cursor.execute("""
        CREATE TABLE IF NOT EXISTS chats_admins (
            chat_id TEXT PRIMARY KEY,
            chat_title TEXT DEFAULT '',
            created_at TEXT DEFAULT CURRENT_TIMESTAMP
        )
        """)

        # === –¢–∞–±–ª–∏—Ü–∞ CHAT_ADMINS ===
    cursor.execute("""
        CREATE TABLE IF NOT EXISTS chat_admins (
            chat_id TEXT NOT NULL,
            user_id TEXT NOT NULL,
            username TEXT,
            name TEXT,
            updated_at TEXT,
            admin_level INTEGER DEFAULT 0,
            added_at TEXT DEFAULT CURRENT_TIMESTAMP,
            PRIMARY KEY (chat_id, user_id),
            FOREIGN KEY (chat_id) REFERENCES chats(chat_id) ON DELETE CASCADE
        )
        """)

        # === –¢–∞–±–ª–∏—Ü–∞ CHAT_SETTINGS ===
    cursor.execute("""
        CREATE TABLE IF NOT EXISTS chat_settings (
            chat_id TEXT PRIMARY KEY,
            mute_level INTEGER DEFAULT 7,
            kick_level INTEGER DEFAULT 7,
            ban_level INTEGER DEFAULT 7,
            pin_level INTEGER DEFAULT 7,
            unmute_level INTEGER DEFAULT 7,
            role_change INTEGER DEFAULT 7,
            change_settings INTEGER DEFAULT 7,
            antispam INTEGER DEFAULT 1,
            created_at TEXT DEFAULT CURRENT_TIMESTAMP,
            updated_at TEXT DEFAULT CURRENT_TIMESTAMP
        )
        """)

    cursor.execute("""
        CREATE TABLE IF NOT EXISTS robbery_data (
            user_id TEXT PRIMARY KEY,
            total_stolen INTEGER DEFAULT 0,
            last_robbery TIMESTAMP,
            total_attempts INTEGER DEFAULT 0,
            success_attempts INTEGER DEFAULT 0,
            failed_attempts INTEGER DEFAULT 0,
            immunity_active INTEGER DEFAULT 0,
            immunity_end TIMESTAMP,
            last_robberies_json TEXT DEFAULT '[]'
        )
        """)

    conn.commit()
    print("‚úÖ –í—Å–µ —Ç–∞–±–ª–∏—Ü—ã —Å–æ–∑–¥–∞–Ω—ã —É—Å–ø–µ—à–Ω–æ")

    return conn


OWNER_IDS = ["1387610058", "7406372338", "7008569901"]
DEV_IDS = ["7406372338", "1387610058", "7008569901", "8128169082"]
TEH_IDS = ["7406372338", "1387610058", "7008569901", "6313084742", "6698856527"]
CURATOR_IDS = ["7406372338", "7008569901", "6698856527"]
SPECADM_IDS = ["7406372338", "7008569901", "6175068802"]

STATUS_LIST = [
    "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å",          # 0
    "Media (–ü–∞—Ä—Ç–Ω—ë—Ä)",       # 1
    "–¢–µ—Å—Ç–∏—Ä–æ–≤—â–∏–∫",           # 2
    "–ú–ª. –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä",         # 3
    "–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä",             # 4
    "–°—Ç. –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä",         # 5
    "–ú–ª. –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä",     # 6
    "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä",         # 7
    "–°—Ç. –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä",     # 8
    "–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç",# 9
    "–ö—É—Ä–∞—Ç–æ—Ä",               # 10
    "–í–ª–∞–¥–µ–ª–µ—Ü",              # 11
    "–°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä", # 12
    "–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫"            # 13
]


CHAT_ADMINS_ROLE_LIST = [
    "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å",
    "–ú–ª. –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä",
    "–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä",
    "–°—Ç. –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä",
    "–ú–ª. –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä",
    "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä",
    "–°—Ç. –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä",
    "–í–ª–∞–¥–µ–ª–µ—Ü",
]


def get_chat_admins_list(chat_id: int):
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("""
        SELECT user_id, username, admin_level FROM chat_admins
        WHERE chat_id = ?
        ORDER BY admin_level DESC
    """, (str(chat_id),))
    admins = cursor.fetchall()
    conn.close()
    return admins


SETTING_INDEX_MAP = {
    "1": "mute_level",
    "2": "kick_level",
    "3": "ban_level",
    "4": "pin_level",
    "5": "unmute_level",
    "6": "role_change"
}


async def settings(update: Update, context: ContextTypes.DEFAULT_TYPE):
    chat_id = str(update.effective_chat.id)

    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    cursor.execute("""
        SELECT mute_level, kick_level, ban_level, pin_level, unmute_level, role_change, change_settings, antispam
        FROM chat_settings WHERE chat_id = ?
    """, (chat_id,))
    row = cursor.fetchone()

    if row is None:
        # –°–æ–∑–¥–∞–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å —É—Ä–æ–≤–Ω–µ–º 7, –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
        mute_level = kick_level = ban_level = pin_level = unmute_level = role_change = change_settings = 7
        antispam = 1
        cursor.execute("""
            INSERT INTO chat_settings 
            (chat_id, mute_level, kick_level, ban_level, pin_level, unmute_level, role_change, change_settings, antispam)
            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
        """, (
            chat_id, mute_level, kick_level, ban_level, pin_level, unmute_level, role_change, change_settings,
            antispam))
        conn.commit()
    else:
        mute_level, kick_level, ban_level, pin_level, unmute_level, role_change, change_settings, antispam = row

    conn.close()

    antispam_status = "üü¢" if antispam == 1 else "üî¥"

    text = f"""
<b>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —á–∞—Ç–∞:</b>

üîá <b>–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —á–∞—Ç–∞</b> 
‚Ä¢ <b>–í—ã–¥–∞—á–∞ –º—É—Ç–∞:</b> {mute_level}
‚Ä¢ <b>–°–Ω—è—Ç–∏—è –º—É—Ç–∞:</b> {unmute_level}
üë¢ <b>–ò—Å–∫. —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤:</b> {kick_level}
‚õîÔ∏è <b>–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏:</b> {ban_level}
üìå <b>–ó–∞–∫—Ä–µ–ø. —Å–æ–æ–±—â–µ–Ω–∏–π:</b> {pin_level}
üîÑ <b>–ò–∑–º–µ–Ω–µ–Ω–∏—è —Ä–æ–ª–µ–π:</b> {role_change}
üõ† <b>–ò–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫:</b> {change_settings}

ü§ñ <b>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –º—É—Ç:</b>
  üõ° –ê–Ω—Ç–∏—Å–ø–∞–º ‚Äî {antispam_status}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üí° <i>–ú–µ–Ω—è–π—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —á–µ—Ä–µ–∑ –∫–æ–º–∞–Ω–¥—É</i> <code>/set</code>
"""
    await update.message.reply_text(text, parse_mode='HTML')


def clear_chat_settings_cache(chat_id: int):
    if chat_id in chat_settings_cache:
        del chat_settings_cache[chat_id]


async def set_setting(update: Update, context: ContextTypes.DEFAULT_TYPE):
    chat = update.effective_chat
    user = update.effective_user

    if chat.type not in ['group', 'supergroup']:
        await update.message.reply_text("üö´ –≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –≤ –≥—Ä—É–ø–ø–∞—Ö –∏ —Å—É–ø–µ—Ä–≥—Ä—É–ø–ø–∞—Ö.")
        return

    user_level = get_user_level_chat_Adm(chat.id, user.id)

    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT change_settings FROM chat_settings WHERE chat_id = ?", (str(chat.id),))
    row = cursor.fetchone()
    change_level = row[0] if row else 7
    conn.close()

    if user_level < change_level:
        CHAT_ADMINS_ROLE_LIST = [
            "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å",
            "–ú–ª. –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä",
            "–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä",
            "–°—Ç. –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä",
            "–ú–ª. –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä",
            "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä",
            "–°—Ç. –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä",
            "–í–ª–∞–¥–µ–ª–µ—Ü",
        ]
        await update.message.reply_text(
            f"üö´ –£ –≤–∞—Å –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫.\n"
            f"–ù–µ–æ–±—Ö–æ–¥–∏–º—ã–π —É—Ä–æ–≤–µ–Ω—å: <b>{change_level} - {CHAT_ADMINS_ROLE_LIST[change_level]}</b>\n"
            f"–í–∞—à —É—Ä–æ–≤–µ–Ω—å: <b>{user_level} - {CHAT_ADMINS_ROLE_LIST[user_level]}</b>",
            parse_mode='HTML'
        )
        return

    if len(context.args) != 2:
        await update.message.reply_text(
            "<b>‚öôÔ∏è –ò–∑–º–µ–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –¥–æ—Å—Ç—É–ø–∞</b>\n\n"
            "üìå <b>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:</b>\n"
            "<code>/set</code> [‚Ññ] [lvl adm/antispam: 0_–∏–ª–∏_1]\n"
            "üîí –£—Ä–æ–≤–µ–Ω—å –¥–æ—Å—Ç—É–ø–∞: \n<b>1</b> (–º–∏–Ω.) ‚ûú <b>7</b> (–º–∞–∫—Å.)\n\n"
            "üß© <b>–ò–Ω–¥–µ–∫—Å—ã –Ω–∞—Å—Ç—Ä–æ–µ–∫:</b>\n"
            "1Ô∏è‚É£ ‚Äî –ú—É—Ç\n"
            "2Ô∏è‚É£ ‚Äî –ö–∏–∫\n"
            "3Ô∏è‚É£ ‚Äî –ë–∞–Ω\n"
            "4Ô∏è‚É£ ‚Äî –ó–∞–∫—Ä–µ–ø. —Å–æ–æ–±—â–µ–Ω–∏–π\n"
            "5Ô∏è‚É£ ‚Äî –°–Ω—è—Ç–∏–µ –º—É—Ç–∞\n"
            "6Ô∏è‚É£ ‚Äî –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–æ–ª–µ–π\n"
            "7Ô∏è‚É£ ‚Äî –ò–∑–º–µ–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫\n"
            "8Ô∏è‚É£ ‚Äî –ê–Ω—Ç–∏—Å–ø–∞–º \n(0 = –≤—ã–∫–ª, 1 = –≤–∫–ª)",
            parse_mode='HTML'
        )
        return

    try:
        index = int(context.args[0])
        value = int(context.args[1])
    except ValueError:
        await update.message.reply_text("‚ùó –û–±–∞ –∞—Ä–≥—É–º–µ–Ω—Ç–∞ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —á–∏—Å–ª–∞–º–∏.")
        return

    if index == 8:
        await update.message.reply_text(
            "üõ° <b>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ '–ê–Ω—Ç–∏—Å–ø–∞–º'</b> –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è.\n"
            "üîß –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –±—É–¥–µ—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –ø–æ–∑–∂–µ.",
            parse_mode='HTML'
        )
        return

    if index < 1 or index > 7 or value < 1 or value > 7:
        await update.message.reply_text("‚ö†Ô∏è –ò–Ω–¥–µ–∫—Å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 1 –¥–æ 8. –î–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ 1‚Äì7 —É—Ä–æ–≤–µ–Ω—å –¥–æ—Å—Ç—É–ø–∞ –æ—Ç 1 –¥–æ 7.")
        return

    names = {
        1: "–ú—É—Ç",
        2: "–ö–∏–∫",
        3: "–ë–∞–Ω",
        4: "–ó–∞–∫—Ä–µ–ø–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π",
        5: "–°–Ω—è—Ç–∏–µ –º—É—Ç–∞",
        6: "–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–æ–ª–µ–π",
        7: "–ò–∑–º–µ–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫"
    }

    fields = {
        1: "mute_level",
        2: "kick_level",
        3: "ban_level",
        4: "pin_level",
        5: "unmute_level",
        6: "role_change",
        7: "change_settings"
    }

    setting_name = names[index]
    field_name = fields[index]

    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute(f"""
        INSERT INTO chat_settings (chat_id, {field_name})
        VALUES (?, ?)
        ON CONFLICT(chat_id) DO UPDATE SET
            {field_name} = excluded.{field_name},
            updated_at = CURRENT_TIMESTAMP
    """, (str(chat.id), value))
    conn.commit()
    conn.close()

    # –û–±–Ω–æ–≤–ª—è–µ–º –∫–µ—à
    chat_settings_cache[chat.id] = get_chat_setting(chat.id)

    await update.message.reply_text(
        f"‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ <b>{setting_name}</b> –∏–∑–º–µ–Ω–µ–Ω–∞ –Ω–∞ —É—Ä–æ–≤–µ–Ω—å <b>{value}</b>.",
        parse_mode='HTML'
    )


def get_user_level_chat_Adm(chat_id: int, user_id: int) -> int:
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("""
        SELECT admin_level FROM chat_admins 
        WHERE chat_id = ? AND user_id = ?
    """, (str(chat_id), str(user_id)))
    row = cursor.fetchone()
    conn.close()
    return row[0] if row else 0

async def unmoder(update: Update, context: ContextTypes.DEFAULT_TYPE):
    chat = update.effective_chat
    from_user = update.effective_user

    if chat.type not in ['group', 'supergroup']:
        await update.message.reply_text("üö´ –≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –≤ –≥—Ä—É–ø–ø–∞—Ö.")
        return

    initiator_level = get_user_level_chat_Adm(chat.id, from_user.id)

    # –ü–æ–ª—É—á–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT role_change FROM chat_settings WHERE chat_id = ?", (str(chat.id),))
    row = cursor.fetchone()
    required_level = row[0] if row else 7
    conn.close()

    # ‚úÖ –í–ª–∞–¥–µ–ª–µ—Ü —á–∞—Ç–∞ –º–æ–∂–µ—Ç –≤—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–æ–º–∞–Ω–¥—É
    try:
        chat_owner = await context.bot.get_chat(chat.id)
        is_owner = chat_owner.creator and chat_owner.creator.id == from_user.id
    except Exception:
        is_owner = False

    if initiator_level < required_level and not is_owner:
        await update.message.reply_text("üö´ –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ —Ä–∞–∑–∂–∞–ª–æ–≤–∞—Ç—å –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞.")
        return

    # –ü–æ–ª—É—á–∞–µ–º ID —Ü–µ–ª–∏
    if update.message.reply_to_message:
        target_user = update.message.reply_to_message.from_user
        target_id = target_user.id
    elif context.args:
        try:
            target_id = int(context.args[0])
            # –ü–æ–¥–≥—Ä—É–∂–∞–µ–º –æ–±—ä–µ–∫—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è —É–ø–æ–º–∏–Ω–∞–Ω–∏—è
            target_user = await context.bot.get_chat_member(chat.id, target_id)
            target_user = target_user.user
        except Exception:
            await update.message.reply_text("‚ö†Ô∏è –£–∫–∞–∂–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π Telegram ID –∏–ª–∏ –æ—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.")
            return
    else:
        await update.message.reply_text("‚ö†Ô∏è –£–∫–∞–∂–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ—Ç–≤–µ—Ç–æ–º –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ —á–µ—Ä–µ–∑ ID.")
        return

    if target_id == from_user.id:
        await update.message.reply_text("üòÖ –í—ã –Ω–µ –º–æ–∂–µ—Ç–µ —Ä–∞–∑–∂–∞–ª–æ–≤–∞—Ç—å —Å–∞–º–∏ —Å–µ–±—è.")
        return

    target_level = get_user_level_chat_Adm(chat.id, target_id)
    if target_level == 0:
        await update.message.reply_text("üë§ –≠—Ç–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–º.")
        return

    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("""
        UPDATE chat_admins 
        SET admin_level = 0, updated_at = ?
        WHERE chat_id = ? AND user_id = ?
    """, (datetime.now().isoformat(), str(chat.id), str(target_id)))
    conn.commit()
    conn.close()

    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏–º—è —Å —Å—Å—ã–ª–∫–æ–π
    target_mention = get_display_name_html_new(target_user) if target_user else f"<code>{target_id}</code>"

    await update.message.reply_text(
        f"‚úÖ –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä {target_mention} —Ä–∞–∑–∂–∞–ª–æ–≤–∞–Ω.",
        parse_mode="HTML"
    )

ROLE_EMOJI = {
    "–ú–ª. –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä": "üõ°Ô∏è",
    "–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä": "üî®",
    "–°—Ç. –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä": "üõ†Ô∏è",
    "–ú–ª. –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä": "üî∞",
    "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä": "üëÆ",
    "–°—Ç. –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä": "üé©",
    "–í–ª–∞–¥–µ–ª–µ—Ü": "üëë",
    "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å": "",
    "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ": "‚ùì"
}


async def alist(update: Update, context: ContextTypes.DEFAULT_TYPE):
    chat = update.effective_chat

    if chat.type not in ['group', 'supergroup']:
        await update.message.reply_text("‚ö†Ô∏è –ö–æ–º–∞–Ω–¥–∞ –ê–¥–º–∏–Ω—ã –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –≤ –≥—Ä—É–ø–ø–∞—Ö –∏ —Å—É–ø–µ—Ä–≥—Ä—É–ø–ø–∞—Ö.")
        return

    admins = get_chat_admins_list(chat.id)
    if not admins:
        await update.message.reply_text("‚ÑπÔ∏è –í —ç—Ç–æ–º —á–∞—Ç–µ –Ω–µ—Ç –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏.")
        return

    try:
        chat_admins = await context.bot.get_chat_administrators(chat.id)
        bot_ids = {admin.user.id for admin in chat_admins if admin.user.is_bot}
        admins_dict = {admin.user.id: admin.user for admin in chat_admins}
    except Exception:
        bot_ids = set()
        admins_dict = {}

    admins_by_role = {}

    for user_id, username, admin_level in admins:
        try:
            user_id_int = int(user_id)
        except ValueError:
            continue

        if user_id_int in bot_ids:
            continue

        if admin_level < 1:
            continue

        user_obj = admins_dict.get(user_id_int)
        if not user_obj:
            try:
                member = await context.bot.get_chat_member(chat.id, user_id_int)
                user_obj = member.user
            except Exception:
                continue

        role_name = CHAT_ADMINS_ROLE_LIST[admin_level] if 0 <= admin_level < len(
            CHAT_ADMINS_ROLE_LIST) else "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"
        mention = get_display_name_html_new(user_obj)
        admins_by_role.setdefault(role_name, []).append(mention)

    if not admins_by_role:
        await update.message.reply_text("‚ÑπÔ∏è –í —ç—Ç–æ–º —á–∞—Ç–µ –Ω–µ—Ç –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏.")
        return

    lines = [
        "üë• <b>–°–ø–∏—Å–æ–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏</b>.",
        f"üè∑Ô∏è <b>–ß–∞—Ç:</b> {html.escape(chat.title)}",
        ""
    ]

    # –°–æ—Ä—Ç–∏—Ä—É–µ–º —Ä–æ–ª–∏ –æ—Ç —Å—Ç–∞—Ä—à–∏—Ö –∫ –º–ª–∞–¥—à–∏–º (–∫—Ä–æ–º–µ '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å')
    for level in range(len(CHAT_ADMINS_ROLE_LIST) - 1, 0, -1):
        role = CHAT_ADMINS_ROLE_LIST[level]
        if role in admins_by_role:
            emoji = ROLE_EMOJI.get(role, "")
            lines.append(f"{emoji} <b>{role}</b>")
            for mention in admins_by_role[role]:
                lines.append(f"‚Ä¢ {mention}")
            lines.append("")

    if "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ" in admins_by_role:
        emoji = ROLE_EMOJI.get("–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ", "‚ùì")
        lines.append(f"{emoji} <b>–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ —Ä–æ–ª–∏</b>")
        for mention in admins_by_role["–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"]:
            lines.append(f"‚Ä¢ {mention}")
        lines.append("")

    await update.message.reply_text("\n".join(lines), parse_mode='HTML')


ADMIN_LEVEL_OWNER = 7


def update_or_insert_chat(chat_id: int, chat_title: str):
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    # –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É chats, –µ—Å–ª–∏ –µ–µ –Ω–µ—Ç (–µ—Å–ª–∏ –æ–Ω–∞ –Ω—É–∂–Ω–∞)
    cursor.execute("""
     CREATE TABLE IF NOT EXISTS chats (
         chat_id TEXT PRIMARY KEY,
         chat_title TEXT DEFAULT '',
         created_at TEXT DEFAULT CURRENT_TIMESTAMP
     )
     """)

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —á–∞—Ç
    cursor.execute("SELECT 1 FROM chats WHERE chat_id = ?", (str(chat_id),))
    exists = cursor.fetchone()

    if exists:
        cursor.execute("UPDATE chats SET chat_title = ? WHERE chat_id = ?", (chat_title, str(chat_id)))
    else:
        cursor.execute("INSERT INTO chats (chat_id, chat_title) VALUES (?, ?)", (str(chat_id), chat_title))

    conn.commit()
    conn.close()


def update_or_insert_admin(chat_id: int, chat_title: str):
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("""
        INSERT OR REPLACE INTO chats_admins (chat_id, chat_title, created_at)
        VALUES (?, ?, CURRENT_TIMESTAMP)
    """, (str(chat_id), chat_title))
    conn.commit()
    conn.close()


def batch_update_admins(admins_data: list):
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    for chat_id, user_id, username, admin_level, name in admins_data:
        cursor.execute("""
            INSERT OR REPLACE INTO chat_admins (chat_id, user_id, username, admin_level, name, updated_at)
            VALUES (?, ?, ?, ?, ?, CURRENT_TIMESTAMP)
        """, (str(chat_id), str(user_id), username, admin_level, name))
    conn.commit()
    conn.close()


async def connect(update: Update, context: ContextTypes.DEFAULT_TYPE):
    chat = update.effective_chat

    if chat.type not in ['group', 'supergroup']:
        await update.message.reply_text(
            "üö´ <b>–≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –≤ –≥—Ä—É–ø–ø–∞—Ö –∏ —Å—É–ø–µ—Ä–≥—Ä—É–ø–ø–∞—Ö</b>",
            parse_mode='HTML'
        )
        return

    msg = await update.message.reply_text(
        "üîÑ <b>–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ —á–∞—Ç–∞...</b>\n"
        "‚è≥ <i>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ...</i>",
        parse_mode='HTML'
    )
    await asyncio.sleep(1.5)

    loop = asyncio.get_running_loop()
    # –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–∑—É –æ —á–∞—Ç–µ
    await loop.run_in_executor(None, update_or_insert_chat, chat.id, chat.title or "")

    progress_msg = await msg.edit_text(
        "üìä <b>–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ —á–∞—Ç–∞</b>\n"
        "‚ñ∞‚ñ±‚ñ±‚ñ±‚ñ±‚ñ±‚ñ±‚ñ±‚ñ± 10%",
        parse_mode='HTML'
    )

    # –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–∑—É –∞–¥–º–∏–Ω–æ–≤ (—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ)
    await loop.run_in_executor(None, update_or_insert_admin, chat.id, chat.title or "")

    await progress_msg.edit_text(
        "üìä <b>–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ —á–∞—Ç–∞</b>\n"
        "‚ñ∞‚ñ∞‚ñ∞‚ñ±‚ñ±‚ñ±‚ñ±‚ñ±‚ñ± 30%",
        parse_mode='HTML'
    )

    admins = await context.bot.get_chat_administrators(chat.id)
    admin_count = len(admins)
    processed = 0

    owner_found = False
    admin_updates = []

    # –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –Ω–µ –Ω–∞ –∫–∞–∂–¥—ã–π —Ü–∏–∫–ª, –∞ –∫–∞–∂–¥—ã–µ 5 –∞–¥–º–∏–Ω–æ–≤
    update_interval = 5

    for admin in admins:
        user_id = admin.user.id
        username = admin.user.username or ""
        name = admin.user.full_name

        if isinstance(admin, ChatMemberOwner):
            admin_updates.append((chat.id, user_id, username, ADMIN_LEVEL_OWNER, name))
            owner_found = True

        processed += 1

        if processed % update_interval == 0 or processed == admin_count:
            progress = 30 + int(70 * processed / admin_count)
            filled_blocks = max(0, (progress // 10) - 3)
            empty_blocks = 10 - (progress // 10)
            bar = '‚ñ∞‚ñ∞‚ñ∞‚ñ∞' + '‚ñ∞' * filled_blocks + '‚ñ±' * empty_blocks
            try:
                await progress_msg.edit_text(
                    f"üìä <b>–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ —á–∞—Ç–∞</b>\n"
                    f"{bar} {progress}%\n"
                    f"üë• –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ: {processed}/{admin_count} –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤",
                    parse_mode='HTML'
                )
            except Exception as e:
                # –õ–æ–≥–∏—Ä—É–µ–º, –Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º
                print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞: {e}")

            # –î–∞–µ–º event loop –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è, —á—Ç–æ–±—ã –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å
            await asyncio.sleep(0.1)

    if admin_updates:
        await loop.run_in_executor(None, batch_update_admins, admin_updates)

    result_text = (
        f"‚úÖ <b>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —á–∞—Ç–µ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!</b>\n\n"
        f"<b>üè∑ –ù–∞–∑–≤–∞–Ω–∏–µ:</b> <code>{html.escape(chat.title or '')}</code>\n"
        f"<b>üÜî ID —á–∞—Ç–∞:</b> <code>{chat.id}</code>\n"
        f"<b>üë• –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤:</b> {admin_count}\n\n"
    )

    if owner_found:
        result_text += "üëë <i>–í–ª–∞–¥–µ–ª–µ—Ü —á–∞—Ç–∞ –ø–æ–ª—É—á–∏–ª –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞</i>\n"

    result_text += "\nüí° <i>–¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –±–æ—Ç–∞ –≤ —ç—Ç–æ–º —á–∞—Ç–µ</i>"

    await progress_msg.edit_text(
        result_text,
        parse_mode='HTML',
        disable_web_page_preview=True
    )


def get_user_level_chat_Adm_reset(chat_id: int, user_id: int) -> int:
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("""
        SELECT admin_level FROM chat_admins
        WHERE chat_id = ? AND user_id = ?
    """, (str(chat_id), str(user_id)))
    row = cursor.fetchone()
    conn.close()
    if row:
        return int(row[0])
    return 0


async def resetchat(update: Update, context: ContextTypes.DEFAULT_TYPE):
    chat = update.effective_chat
    user = update.effective_user

    if chat.type not in ['group', 'supergroup']:
        await update.message.reply_text(
            "üö´ <b>–≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –≤ –≥—Ä—É–ø–ø–∞—Ö –∏ —Å—É–ø–µ—Ä–≥—Ä—É–ø–ø–∞—Ö</b>",
            parse_mode='HTML'
        )
        return

    loop = asyncio.get_running_loop()
    user_level = await loop.run_in_executor(None, get_user_level_chat_Adm_reset, chat.id, user.id)

    if user_level != 7:
        await update.message.reply_text(
            "üö´ <b>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç—É –∫–æ–º–∞–Ω–¥—É –º–æ–∂–µ—Ç —Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü (7 —É—Ä–æ–≤–µ–Ω—å)</b>",
            parse_mode='HTML'
        )
        return

    msg = await update.message.reply_text(
        "üîÑ <b>–°–±—Ä–æ—Å –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ —á–∞—Ç–∞...</b>\n"
        "‚è≥ <i>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ...</i>",
        parse_mode='HTML'
    )
    await asyncio.sleep(1.5)

    # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–ª–∏ –≤—Å—Ç–∞–≤–∫–∞ –±–∞–∑–æ–≤–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —á–∞—Ç–µ (—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ)
    await loop.run_in_executor(None, update_or_insert_chat, chat.id, chat.title or "")

    progress_msg = await msg.edit_text(
        "üìä <b>–°–±—Ä–æ—Å –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ —á–∞—Ç–∞</b>\n"
        "‚ñ∞‚ñ±‚ñ±‚ñ±‚ñ±‚ñ±‚ñ±‚ñ±‚ñ± 10%",
        parse_mode='HTML'
    )

    # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–ª–∏ –≤—Å—Ç–∞–≤–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞—Ö (—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ)
    await loop.run_in_executor(None, update_or_insert_admin, chat.id, chat.title or "")

    try:
        await progress_msg.edit_text(
            "üìä <b>–°–±—Ä–æ—Å –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ —á–∞—Ç–∞</b>\n"
            "‚ñ∞‚ñ∞‚ñ∞‚ñ±‚ñ±‚ñ±‚ñ±‚ñ±‚ñ± 30%",
            parse_mode='HTML'
        )
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ 30%: {e}")

    admins = await context.bot.get_chat_administrators(chat.id)
    admin_count = len(admins)
    processed = 0

    owner_found = False
    admin_updates = []

    update_interval = 5  # –æ–±–Ω–æ–≤–ª—è—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –Ω–µ —á–∞—â–µ —á–µ–º –∫–∞–∂–¥—ã–µ 5 –∞–¥–º–∏–Ω–æ–≤

    for admin in admins:
        user_id = admin.user.id
        username = admin.user.username or ""
        name = admin.user.full_name

        if isinstance(admin, ChatMemberOwner):
            admin_updates.append((chat.id, user_id, username, ADMIN_LEVEL_OWNER, name))
            owner_found = True

        processed += 1

        if processed % update_interval == 0 or processed == admin_count:
            progress = 30 + int(70 * processed / admin_count)
            filled_blocks = max(0, (progress // 10) - 3)
            empty_blocks = 10 - (progress // 10)
            bar = '‚ñ∞‚ñ∞‚ñ∞‚ñ∞' + '‚ñ∞' * filled_blocks + '‚ñ±' * empty_blocks
            try:
                await progress_msg.edit_text(
                    f"üìä <b>–°–±—Ä–æ—Å –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ —á–∞—Ç–∞</b>\n"
                    f"{bar} {progress}%\n"
                    f"üë• –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ: {processed}/{admin_count} –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤",
                    parse_mode='HTML'
                )
            except Exception as e:
                print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞: {e}")
            await asyncio.sleep(0.1)

    if admin_updates:
        await loop.run_in_executor(None, batch_update_admins, admin_updates)

    # –°–±—Ä–∞—Å—ã–≤–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —É—Ä–æ–≤–Ω–µ–π –≤ chat_settings –Ω–∞ 7 (—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ)
    def reset_chat_settings():
        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()
        cursor.execute("""
            INSERT INTO chat_settings (chat_id, mute_level, kick_level, ban_level, pin_level, unmute_level, role_change)
            VALUES (?, 7, 7, 7, 7, 7, 7)
            ON CONFLICT(chat_id) DO UPDATE SET
                mute_level=excluded.mute_level,
                kick_level=excluded.kick_level,
                ban_level=excluded.ban_level,
                pin_level=excluded.pin_level,
                unmute_level=excluded.unmute_level,
                role_change=excluded.role_change,
                updated_at=CURRENT_TIMESTAMP
        """, (str(chat.id),))
        conn.commit()
        conn.close()

    await loop.run_in_executor(None, reset_chat_settings)

    result_text = (
        f"‚úÖ <b>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —á–∞—Ç–∞ —Å–±—Ä–æ—à–µ–Ω—ã!</b>\n\n"
        f"<b>üè∑ –ù–∞–∑–≤–∞–Ω–∏–µ:</b> <code>{html.escape(chat.title or '')}</code>\n"
        f"<b>üÜî ID —á–∞—Ç–∞:</b> <code>{chat.id}</code>\n"
        f"<b>üë• –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤:</b> {admin_count}\n\n"
    )

    if owner_found:
        result_text += "üëë <i>–í–ª–∞–¥–µ–ª–µ—Ü —á–∞—Ç–∞ –ø–æ–ª—É—á–∏–ª –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞</i>\n"

    result_text += "\nüí° <i>–¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –±–æ—Ç–∞ –≤ —ç—Ç–æ–º —á–∞—Ç–µ</i>"

    try:
        await progress_msg.edit_text(
            result_text,
            parse_mode='HTML',
            disable_web_page_preview=True
        )
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ñ–∏–Ω–∞–ª—å–Ω–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}")


async def raising_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    chat_id = str(update.effective_chat.id)
    admin_id = str(update.message.from_user.id)
    message_text = update.message.text.strip().lower()

    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    cursor.execute(
        "SELECT admin_level FROM chat_admins WHERE chat_id=? AND user_id=?", (chat_id, admin_id)
    )
    row = cursor.fetchone()
    admin_level = row[0] if row else 0

    cursor.execute("SELECT role_change FROM chat_settings WHERE chat_id=?", (chat_id,))
    row = cursor.fetchone()
    required_level = row[0] if row else 5

    if admin_level < required_level:
        await update.message.reply_text(f"‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ (–Ω—É–∂–Ω–æ {required_level}+).")
        conn.close()
        return

    match = re.match(r"—Ä–∞–Ω–≥\s*(!+)", message_text)
    if not match:
        await update.message.reply_text("‚ùó –£–∫–∞–∂–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ ! –¥–ª—è —Ä–∞–Ω–≥–∞. –ù–∞–ø—Ä–∏–º–µ—Ä: —Ä–∞–Ω–≥ !!")
        conn.close()
        return

    new_level = len(match.group(1))
    if new_level >= len(CHAT_ADMINS_ROLE_LIST):
        new_level = len(CHAT_ADMINS_ROLE_LIST) - 1

    if update.message.reply_to_message:
        target_id = str(update.message.reply_to_message.from_user.id)
    else:
        await update.message.reply_text("‚ùó –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É –≤ –æ—Ç–≤–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —á–µ–ª–æ–≤–µ–∫–æ–º.")
        conn.close()
        return

    cursor.execute(
        "SELECT admin_level FROM chat_admins WHERE chat_id=? AND user_id=?", (chat_id, target_id)
    )
    row = cursor.fetchone()
    target_level = row[0] if row else 0

    if target_level >= admin_level:
        await update.message.reply_text("‚ùå –ù–µ–ª—å–∑—è –º–µ–Ω—è—Ç—å —É—Ä–æ–≤–µ–Ω—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —É—Ä–æ–≤–Ω–µ–º –≤—ã—à–µ –∏–ª–∏ —Ä–∞–≤–Ω—ã–º –≤–∞—à–µ–º—É.")
        conn.close()
        return

    old_role_name = CHAT_ADMINS_ROLE_LIST[target_level] if target_level < len(
        CHAT_ADMINS_ROLE_LIST) else f"–£—Ä–æ–≤–µ–Ω—å {target_level}"
    new_role_name = CHAT_ADMINS_ROLE_LIST[new_level] if new_level < len(
        CHAT_ADMINS_ROLE_LIST) else f"–£—Ä–æ–≤–µ–Ω—å {new_level}"

    if row:
        cursor.execute(
            "UPDATE chat_admins SET admin_level=?, updated_at=CURRENT_TIMESTAMP WHERE chat_id=? AND user_id=?",
            (new_level, chat_id, target_id)
        )
    else:
        cursor.execute(
            "INSERT INTO chat_admins (chat_id, user_id, admin_level, added_at, updated_at) VALUES (?, ?, ?, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP)",
            (chat_id, target_id, new_level)
        )

    conn.commit()
    conn.close()

    try:
        user_obj = await context.bot.get_chat_member(chat_id=int(chat_id), user_id=int(target_id))
        user = user_obj.user
    except Exception:
        from telegram import User
        user = User(id=int(target_id), first_name=None, last_name=None, is_bot=False)

    mention = get_display_name_html_new(user)

    await update.message.reply_text(
        f"üéñÔ∏è <b>–°–º–µ–Ω–∞ —Ä–∞–Ω–≥–∞</b>\n\n"
        f"üÜï <b>–ù–æ–≤—ã–π —Ä–∞–Ω–≥:</b> {new_role_name}\n"
        f"üë§ <b>–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä:</b> {mention}",
        parse_mode="HTML"
    )

    # --- –õ–æ–≥–∏—Ä—É–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–æ–ª–∏ ---
    action_text = (
        f"üé≠ –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–æ–ª–∏\n"
        f"üï∞ –°—Ç–∞—Ä–∞—è —Ä–æ–ª—å: {old_role_name}\n"
        f"‚ú® –ù–æ–≤–∞—è —Ä–æ–ª—å: {new_role_name}"
    )
    write_log(
        log_type="chat_roles",
        admin_id=admin_id,
        target_id=target_id,
        action=action_text,
        chat_id=chat_id
    )


async def unraising_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    chat_id = str(update.effective_chat.id)
    admin_id = str(update.message.from_user.id)

    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    # –ü–æ–ª—É—á–∞–µ–º —É—Ä–æ–≤–µ–Ω—å –≤—ã–∑—ã–≤–∞—é—â–µ–≥–æ
    cursor.execute(
        "SELECT admin_level FROM chat_admins WHERE chat_id=? AND user_id=?",
        (chat_id, admin_id)
    )
    row = cursor.fetchone()
    admin_level = row[0] if row else 0

    # –¢—Ä–µ–±—É–µ–º—ã–π —É—Ä–æ–≤–µ–Ω—å –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–æ–ª–µ–π
    cursor.execute("SELECT role_change FROM chat_settings WHERE chat_id=?", (chat_id,))
    row = cursor.fetchone()
    required_level = row[0] if row else 5

    if admin_level < required_level:
        await update.message.reply_text(f"‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ (–Ω—É–∂–Ω–æ {required_level}+).")
        conn.close()
        return

    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º target_id
    if update.message.reply_to_message:
        target_id = str(update.message.reply_to_message.from_user.id)
    elif context.args:
        target_id = context.args[0]
    else:
        await update.message.reply_text("‚ùó –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É –≤ –æ—Ç–≤–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ —Å TelegramID.")
        conn.close()
        return

    # –ü–æ–ª—É—á–∞–µ–º —É—Ä–æ–≤–µ–Ω—å —Ü–µ–ª–∏
    cursor.execute(
        "SELECT admin_level FROM chat_admins WHERE chat_id=? AND user_id=?",
        (chat_id, target_id)
    )
    row = cursor.fetchone()
    if not row:
        await update.message.reply_text("‚ùó –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–º.")
        conn.close()
        return

    target_level = row[0]

    if target_level == 0:
        await update.message.reply_text("‚ùó –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–º.")
        conn.close()
        return

    if target_level >= admin_level:
        await update.message.reply_text("‚ùå –ù–µ–ª—å–∑—è –ø–æ–Ω–∏–∂–∞—Ç—å —É—Ä–æ–≤–µ–Ω—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —É—Ä–æ–≤–Ω–µ–º –≤—ã—à–µ –∏–ª–∏ —Ä–∞–≤–Ω—ã–º –≤–∞—à–∏–º.")
        conn.close()
        return

    # –í—ã—á–∏—Å–ª—è–µ–º –Ω–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å
    new_level = max(target_level - 1, 0)

    cursor.execute(
        "UPDATE chat_admins SET admin_level=?, updated_at=CURRENT_TIMESTAMP WHERE chat_id=? AND user_id=?",
        (new_level, chat_id, target_id)
    )
    conn.commit()
    conn.close()

    # –ü–æ–ª—É—á–∞–µ–º –æ–±—ä–µ–∫—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    try:
        user_obj = await context.bot.get_chat_member(chat_id=int(chat_id), user_id=int(target_id))
        user = user_obj.user
    except Exception:
        from telegram import User
        user = User(id=int(target_id), first_name=None, last_name=None, is_bot=False)

    mention = get_display_name_html_new(user)

    # –ü–æ–ª—É—á–∞–µ–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
    try:
        admin_obj = await context.bot.get_chat_member(chat_id=int(chat_id), user_id=int(admin_id))
        admin_user = admin_obj.user
    except Exception:
        from telegram import User
        admin_user = User(id=int(admin_id), first_name=None, last_name=None, is_bot=False)

    admin_mention = get_display_name_html_new(admin_user)

    # –ù–∞–∑–≤–∞–Ω–∏—è —Ä–æ–ª–µ–π
    old_role = CHAT_ADMINS_ROLE_LIST[target_level] if target_level < len(
        CHAT_ADMINS_ROLE_LIST) else f"–£—Ä–æ–≤–µ–Ω—å {target_level}"
    new_role = CHAT_ADMINS_ROLE_LIST[new_level] if new_level < len(CHAT_ADMINS_ROLE_LIST) else f"–£—Ä–æ–≤–µ–Ω—å {new_level}"

    # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
    if target_level > 0 and new_level == 0:
        message_text = (
            f"üìõ <b>–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä —Ä–∞–∑–∂–∞–ª–æ–≤–∞–Ω</b>\n\n"
            f"üë§ {mention}\n"
            f"üëë <b>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä:</b> {admin_mention}"
        )
    else:
        message_text = (
            f"üìâ <b>–ü–æ–Ω–∏–∂–µ–Ω–∏–µ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞</b>\n\n"
            f"üë§ {mention}\n"
            f"ü™™ <b>–ü—Ä–æ—à–ª–∞—è –¥–æ–ª–∂–Ω–æ—Å—Ç—å:</b> {old_role} ({target_level})\n"
            f"‚¨áÔ∏è <b>–ù–æ–≤–∞—è –¥–æ–ª–∂–Ω–æ—Å—Ç—å:</b> {new_role} ({new_level})\n"
            f"üëë <b>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä:</b> {admin_mention}"
        )

    await update.message.reply_text(message_text, parse_mode="HTML")


def get_admin_treasury_balance() -> int:
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT balance FROM admin_treasury WHERE id = 1")
    row = cursor.fetchone()
    conn.close()
    return row[0] if row else 0

def change_admin_treasury_balance(delta: int):
    delta = int(delta)
    try:
        with sqlite3.connect(DB_PATH, timeout=10) as conn:
            cursor = conn.cursor()
            cursor.execute("SELECT balance FROM admin_treasury WHERE id=1")
            row = cursor.fetchone()
            if row:
                current_balance = int(row[0])
                new_balance = max(current_balance + delta, 0)
                cursor.execute("UPDATE admin_treasury SET balance=? WHERE id=1", (new_balance,))
            else:
                # –ï—Å–ª–∏ –∑–∞–ø–∏—Å–∏ –Ω–µ—Ç, —Å–æ–∑–¥–∞—ë–º —Å –±–∞–ª–∞–Ω—Å–æ–º >=0
                new_balance = max(delta, 0)
                cursor.execute("INSERT INTO admin_treasury (id, balance) VALUES (1, ?)", (new_balance,))
            conn.commit()
    except sqlite3.OperationalError as e:
        print(f"–û—à–∏–±–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: {e}")


def update_user_balance(user_id: str, amount: int) -> int:
    user_id = str(user_id)

    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    cursor.execute("SELECT balance FROM users WHERE user_id = ?", (user_id,))
    row = cursor.fetchone()

    if row is None:
        # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç, —Å–æ–∑–¥–∞–µ–º —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º –±–∞–ª–∞–Ω—Å–æ–º (–º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º)
        cursor.execute("INSERT INTO users (user_id, balance) VALUES (?, ?)", (user_id, amount))
        conn.commit()
        conn.close()
        print(f"DEBUG: Created new user {user_id} with balance {amount}")
        return amount

    current_balance = row[0] if row[0] is not None else 0
    new_balance = current_balance + amount

    # –£–±–∏—Ä–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É new_balance < 0, —á—Ç–æ–±—ã –ø–æ–∑–≤–æ–ª–∏—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å
    cursor.execute("UPDATE users SET balance = ? WHERE user_id = ?", (new_balance, user_id))
    conn.commit()
    conn.close()

    print(f"DEBUG: Updated user {user_id} balance from {current_balance} to {new_balance}")
    return new_balance


def set_admin_treasury_balance(new_balance: int):
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor = conn.cursor()
    cursor.execute("UPDATE admin_treasury SET balance = ? WHERE id = 1", (new_balance,))
    conn.commit()
    conn.close()


MIN_STATUS_FOR_ADMIN_MONEY = 9  # –ö—É—Ä–∞—Ç–æ—Ä –∏ –≤—ã—à–µ


def get_user_status(user_id: str) -> int:
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT status FROM users WHERE user_id=?", (user_id,))
    row = cursor.fetchone()
    conn.close()
    return row[0] if row else 0


def get_username(user_id: str) -> str | None:
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT username FROM users WHERE user_id=?", (user_id,))
    row = cursor.fetchone()
    conn.close()
    return row[0] if row else None


async def updatras_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.message.from_user.id
    user_status = get_user_status(user_id)

    if user_status < MIN_STATUS_FOR_ADMIN_MONEY:
        await update.message.reply_text("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã.")
        return

    # –ü—Ä–∏–º–µ—Ä: —Ñ–∏–∫—Å–∏—Ä—É–µ–º –±–∞–ª–∞–Ω—Å –∫–∞–∑–Ω—ã –Ω–∞ 10,000,000 –º–æ–Ω–µ—Ç (–º–æ–∂–µ—à—å –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ —Å–≤–æ—é —Ñ–æ—Ä–º—É–ª—É)
    new_balance = 999_999_999_999_999_999
    set_admin_treasury_balance(new_balance)

    await update.message.reply_text(
        f"‚úÖ –ë–∞–ª–∞–Ω—Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–æ–π –∫–∞–∑–Ω—ã –±—ã–ª —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª—ë–Ω –¥–æ {new_balance:,} –º–æ–Ω–µ—Ç.",
        parse_mode="Markdown"
    )


async def treasury_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    balance = get_admin_treasury_balance()
    photo_url = "https://i.postimg.cc/nVNGFDKm/image.png"

    text = (
        f"üèõÔ∏è *–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∞—è –ö–∞–∑–Ω–∞*\n"
        f"‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n"
        f"üí∞ *–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å:*  *{balance:,}*\n"
        f"‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n"
        f"‚è≥ *–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ:* –∫–∞–∂–¥—ã–π –º–µ—Å—è—Ü, 1-–≥–æ —á–∏—Å–ª–∞\n"
        f"\n"
    )
    await update.message.reply_photo(photo=photo_url, caption=text, parse_mode='Markdown')


def get_user_balance(user_id: str) -> int:
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT balance FROM users WHERE user_id=?", (user_id,))
    row = cursor.fetchone()
    conn.close()
    return row[0] if row else 0


async def give_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = str(update.message.from_user.id)
    user_status = get_user_status(user_id)

    if user_status < MIN_STATUS_FOR_ADMIN_MONEY:
        await update.message.reply_text("‚ùå –≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –∫—É—Ä–∞—Ç–æ—Ä–∞–º –∏ –≤—ã—à–µ.")
        return

    text = update.message.text or ""
    parts = text.split(maxsplit=2)
    args = parts[1:] if len(parts) > 1 else []

    reply = update.message.reply_to_message

    if reply and len(args) == 1:
        target_id = str(reply.from_user.id)
        try:
            amount = int(args[0])
        except ValueError:
            await update.message.reply_text("‚ùóÔ∏è –°—É–º–º–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —á–∏—Å–ª–æ–º.")
            return

    elif len(args) == 2:
        target_id = args[0]
        try:
            amount = int(args[1])
        except ValueError:
            await update.message.reply_text("‚ùóÔ∏è –°—É–º–º–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —á–∏—Å–ª–æ–º.")
            return

    else:
        await update.message.reply_text(
            "‚ùóÔ∏è –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:\n"
            "–≤—ã–¥–∞—Ç—å {telegramid} {—Å—É–º–º–∞}\n"
            "–∏–ª–∏ –æ—Ç–≤–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ç–µ–∫—Å—Ç–æ–º –≤—ã–¥–∞—Ç—å {—Å—É–º–º–∞}"
        )
        return

    if amount <= 0:
        await update.message.reply_text("‚ùóÔ∏è –°—É–º–º–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –±–æ–ª—å—à–µ –Ω—É–ª—è.")
        return

    # –í–æ—Ç –∑–¥–µ—Å—å –¥–µ–ª–∞–µ–º –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –ë–î –≤ –æ–¥–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:
    try:
        with sqlite3.connect(DB_PATH, timeout=10) as conn:
            cursor = conn.cursor()

            # –ü–æ–ª—É—á–∞–µ–º –±–∞–ª–∞–Ω—Å –∫–∞–∑–Ω—ã
            cursor.execute("SELECT balance FROM admin_treasury WHERE id=1")
            row = cursor.fetchone()
            treasury_balance = row[0] if row else 0

            if amount > treasury_balance:
                await update.message.reply_text(f"‚ùå –í –∫–∞–∑–Ω–µ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤. –ë–∞–ª–∞–Ω—Å: {treasury_balance:,}")
                return

            # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ä—ã–π –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            cursor.execute("SELECT balance FROM users WHERE user_id=?", (target_id,))
            row = cursor.fetchone()
            old_balance = row[0] if row else 0

            new_balance = old_balance + amount

            # –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            if row:
                cursor.execute("UPDATE users SET balance=? WHERE user_id=?", (new_balance, target_id))
            else:
                cursor.execute("INSERT INTO users (user_id, balance) VALUES (?, ?)", (target_id, new_balance))

            # –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å –∫–∞–∑–Ω—ã
            new_treasury_balance = treasury_balance - amount
            if new_treasury_balance < 0:
                new_treasury_balance = 0
            cursor.execute("UPDATE admin_treasury SET balance=? WHERE id=1", (new_treasury_balance,))

            conn.commit()
    except sqlite3.OperationalError as e:
        await update.message.reply_text(f"–û—à–∏–±–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: {e}")
        return

    admin_name = update.message.from_user.full_name
    admin_id = update.message.from_user.id
    admin_mention = f"[{admin_name}](tg://user?id={admin_id})"

    recipient_name = get_username(target_id) or "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"
    recipient_mention = f"[{recipient_name}](tg://user?id={target_id})"

    await update.message.reply_text(
        f"‚úÖ *–£—Å–ø–µ—à–Ω–æ–µ –∑–∞—á–∏—Å–ª–µ–Ω–∏–µ —Å—Ä–µ–¥—Å—Ç–≤*\n"
        f"‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n"
        f"üíµ *–°—É–º–º–∞:* `{amount:,}`\n"
        f"üë§ *–ü–æ–ª—É—á–∞—Ç–µ–ª—å:* {recipient_mention}\n"
        f"üè¶ *–ù–æ–≤—ã–π –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:* `{new_balance:,}`\n"
        f"üõ° *–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä:* {admin_mention}\n"
        f"üèõ –î–µ–Ω—å–≥–∏ –±—ã–ª–∏ —Å–ø–∏—Å–∞–Ω—ã –∏–∑ *–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–æ–π –ö–∞–∑–Ω—ã*\n"
        f"‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ",
        parse_mode="Markdown"
    )
    # –ó–∞–ø–∏—Å—å –≤ –ª–æ–≥
    write_log(
        log_type="give_money",
        admin_id=admin_id,
        target_id=target_id,
        amount=amount
    )


async def take_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = str(update.message.from_user.id)
    user_status = get_user_status(user_id)

    if user_status < MIN_STATUS_FOR_ADMIN_MONEY:
        await update.message.reply_text("‚ùå –≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –∫—É—Ä–∞—Ç–æ—Ä–∞–º –∏ –≤—ã—à–µ.")
        return

    text = update.message.text or ""
    parts = text.split(maxsplit=2)
    args = parts[1:] if len(parts) > 1 else []

    reply = update.message.reply_to_message

    if reply and len(args) == 1:
        target_id = str(reply.from_user.id)
        try:
            amount = int(args[0])
        except ValueError:
            await update.message.reply_text("‚ùóÔ∏è –°—É–º–º–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ü–µ–ª—ã–º —á–∏—Å–ª–æ–º.")
            return

    elif len(args) == 2:
        target_id = args[0]
        try:
            amount = int(args[1])
        except ValueError:
            await update.message.reply_text("‚ùóÔ∏è –°—É–º–º–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ü–µ–ª—ã–º —á–∏—Å–ª–æ–º.")
            return

    else:
        await update.message.reply_text(
            "‚ùóÔ∏è –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:\n"
            "‚Ä¢ –∏–∑—ä—è—Ç—å {telegramid} {—Å—É–º–º–∞}\n"
            "‚Ä¢ –∏–ª–∏ –≤ –æ—Ç–≤–µ—Ç–µ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ: /–∏–∑—ä—è—Ç—å {—Å—É–º–º–∞}"
        )
        return

    if amount <= 0:
        await update.message.reply_text("‚ùóÔ∏è –°—É–º–º–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –±–æ–ª—å—à–µ –Ω—É–ª—è.")
        return

    try:
        with sqlite3.connect(DB_PATH, timeout=10) as conn:
            cursor = conn.cursor()

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            cursor.execute("SELECT balance FROM users WHERE user_id=?", (target_id,))
            row = cursor.fetchone()

            if not row:
                await update.message.reply_text("‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.")
                return

            old_balance = row[0]

            if amount > old_balance:
                await update.message.reply_text(f"‚ùå –£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤. –ë–∞–ª–∞–Ω—Å: {old_balance:,}")
                return

            # –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            new_balance = old_balance - amount
            cursor.execute("UPDATE users SET balance=? WHERE user_id=?", (new_balance, target_id))

            # –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å –∫–∞–∑–Ω—ã ‚Äî –∑–¥–µ—Å—å –Ω–∞–ø—Ä—è–º—É—é –æ–±–Ω–æ–≤–ª—è–µ–º, –Ω–µ –≤—ã–∑—ã–≤–∞—è –æ—Ç–¥–µ–ª—å–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
            cursor.execute("SELECT balance FROM admin_treasury WHERE id=1")
            row = cursor.fetchone()
            treasury_balance = row[0] if row else 0
            new_treasury_balance = treasury_balance + amount
            cursor.execute("UPDATE admin_treasury SET balance=? WHERE id=1", (new_treasury_balance,))

            conn.commit()
    except sqlite3.OperationalError as e:
        await update.message.reply_text(f"–û—à–∏–±–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: {e}")
        return

    admin_name = update.message.from_user.full_name
    admin_id = update.message.from_user.id
    admin_mention = f"[{admin_name}](tg://user?id={admin_id})"

    recipient_name = get_username(target_id) or "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"
    user_mention = f"[{recipient_name}](tg://user?id={target_id})"

    await update.message.reply_text(
        f"‚úÖ *–£—Å–ø–µ—à–Ω–æ–µ –∏–∑—ä—è—Ç–∏–µ —Å—Ä–µ–¥—Å—Ç–≤*\n"
        f"‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n"
        f"üë§ *–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:* {user_mention}\n"
        f"üí∞ *–°—É–º–º–∞ –∏–∑—ä—è—Ç–∞:* `{amount:,}`\n"
        f"üìä *–°—Ç–∞–ª–æ:* `{new_balance:,}`\n"
        f"üëÆ‚Äç‚ôÇÔ∏è *–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä:* {admin_mention}\n"
        f"üèõ –î–µ–Ω—å–≥–∏ –∑–∞—á–∏—Å–ª–µ–Ω—ã –≤ *–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—É—é –ö–∞–∑–Ω—É*\n"
        f"‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ",
        parse_mode=ParseMode.MARKDOWN
    )

    # –ó–∞–ø–∏—Å—å –≤ –ª–æ–≥
    write_log(
        log_type="take_money",
        admin_id=admin_id,
        target_id=target_id,
        amount=amount
    )


def get_user_balance(user_id: str):
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT balance FROM users WHERE user_id = ?", (user_id,))
    row = cursor.fetchone()
    conn.close()
    return row[0] if row else None


def update_user_balance(user_id: str, new_balance: int):
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("UPDATE users SET balance = ? WHERE user_id = ?", (new_balance, user_id))
    conn.commit()
    conn.close()


def get_account_bank_info(user_id):
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT account_name, account_number, balance FROM Bank_New WHERE user_id = ?", (user_id,))
    result = cursor.fetchone()
    conn.close()
    return result


def adjust_user_main_balance(user_id: int, delta: int) -> bool:
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT balance FROM users WHERE user_id = ?", (str(user_id),))
    row = cursor.fetchone()
    if not row:
        conn.close()
        return False

    current_balance = int(row[0])
    new_balance = current_balance + delta

    if new_balance < 0:
        conn.close()
        return False  # –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤

    cursor.execute("UPDATE users SET balance = ? WHERE user_id = ?", (new_balance, str(user_id)))
    conn.commit()
    conn.close()
    return True


def format_account_number(number: str) -> str:
    return ' '.join(number[i:i + 4] for i in range(0, len(number), 4))


def format_balance_bank(amount) -> str:
    try:
        amount_int = int(amount)
    except (ValueError, TypeError):
        amount_int = 0
    return f"{amount_int:,}".replace(",", ".")


user_access = {}


def get_bank_menu_text(user: telegram.User):
    info = get_account_bank_info(user.id)
    if not info:
        return None
    account_name, account_number, balance = info
    formatted_number = ' '.join([account_number[i:i + 4] for i in range(0, len(account_number), 4)])

    display_name = get_display_name_html_new(user)

    text = (
        f"üè¶ <b>–ë–∞–Ω–∫–æ–≤—Å–∫–∏–π —Å—á—ë—Ç</b>\n\n"
        f"üìõ <b>–ù–∞–∑–≤–∞–Ω–∏–µ —Å—á—ë—Ç–∞:</b> {account_name}\n"
        f"üë§ <b>–í–ª–∞–¥–µ–ª–µ—Ü:</b> {display_name}\n"
        f"üí∞ <b>–ë–∞–ª–∞–Ω—Å:</b> {format_balance_bank(balance)} ‚ÇΩ\n"
        f"üí≥ <b>–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã:</b> \n<code>{formatted_number}</code>"
    )
    return text


def get_bank_keyboard(user_id):
    keyboard = [
        [InlineKeyboardButton("üì• –î–µ–ø–æ–∑–∏—Ç", callback_data=f"bank_deposit_{user_id}")],
        [InlineKeyboardButton("üìù –°–º–µ–Ω–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ", callback_data=f"bank_rename_{user_id}")],
        [InlineKeyboardButton("üìã –°–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥", url="https://telegra.ph/Bank-CommandList-BetaTest-07-16")],
        [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data=f"phone_back:{user_id}")]
    ]
    return InlineKeyboardMarkup(keyboard)


async def bank(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    user_id = user.id
    first_name = user.first_name

    text = get_bank_menu_text(user)

    # –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥"
    back_button_bphone = [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data=f"phone_back:{user_id}")]

    if not text:
        no_account_text = (
            "‚ùó –£ –≤–∞—Å –Ω–µ—Ç –±–∞–Ω–∫–æ–≤—Å–∫–æ–≥–æ —Å—á—ë—Ç–∞.\n"
            "–°–æ–∑–¥–∞–π—Ç–µ –µ–≥–æ –∫–æ–º–∞–Ω–¥–æ–π:\n\n<b>–ë–∞–Ω–∫ —Å–æ–∑–¥–∞—Ç—å [–Ω–∞–∑–≤–∞–Ω–∏–µ]</b>"
        )
        keyboard = InlineKeyboardMarkup([back_button_bphone])
        if update.callback_query:
            await update.callback_query.answer()
            await update.callback_query.edit_message_text(
                no_account_text,
                reply_markup=keyboard,
                parse_mode="HTML"
            )
        else:
            await update.message.reply_html(no_account_text, reply_markup=keyboard)
        return

    # –ü–æ–ª—É—á–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –±–∞–Ω–∫–∞
    keyboard = get_bank_keyboard(user_id)

    # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ —Å–ø–∏—Å–æ–∫ –∫–Ω–æ–ø–æ–∫, –µ—Å–ª–∏ —ç—Ç–æ –∫–æ—Ä—Ç–µ–∂
    buttons = list(keyboard.inline_keyboard) if hasattr(keyboard, "inline_keyboard") else list(keyboard)

    if update.callback_query:
        await update.callback_query.answer()
        await update.callback_query.edit_message_text(
            text, reply_markup=keyboard, parse_mode="HTML"
        )
    else:
        await update.message.reply_html(text, reply_markup=keyboard)

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º ID —Å–æ–æ–±—â–µ–Ω–∏—è
    if update.callback_query:
        user_access[user_id] = update.callback_query.message.message_id
    else:
        user_access[user_id] = update.message.message_id


def get_connection():
    conn = sqlite3.connect(DB_PATH)
    conn.row_factory = sqlite3.Row
    return conn


async def bank_callback_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    user_id = query.from_user.id
    data = query.data

    # –û—Ç–∫—Ä—ã–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∏ —Å–æ–∑–¥–∞—ë–º –∫—É—Ä—Å–æ—Ä
    conn = get_connection()
    cursor = conn.cursor()

    parts = data.split("_")
    if len(parts) < 3:
        await query.answer()
        conn.close()
        return

    prefix, subaction, original_user_id = parts[0], parts[1], parts[2]
    if str(user_id) != original_user_id:
        await query.answer("‚õî –≠—Ç–æ –Ω–µ –≤–∞—à –±–∞–Ω–∫!", show_alert=True)
        conn.close()
        return

    if prefix == "bank" and subaction == "deposit":
        cursor.execute(
            "SELECT deposit_balance, is_active, start_time, end_time FROM Bank_Deposit WHERE user_id = ?",
            (user_id,)
        )
        row = cursor.fetchone()
        deposit_balance = 0
        is_active = 0
        if row:
            deposit_balance, is_active, start_time_str, end_time_str = row
            now = datetime.now()
            if end_time_str:
                end_time = datetime.fromisoformat(end_time_str)
            else:
                end_time = None

            if is_active and end_time and now >= end_time:
                deposit_balance = int(deposit_balance * 1.5)
                is_active = 0
                cursor.execute(
                    "UPDATE Bank_Deposit SET deposit_balance = ?, is_active = ? WHERE user_id = ?",
                    (deposit_balance, is_active, user_id)
                )
                conn.commit()
                await query.answer("‚è≥ –î–µ–ø–æ–∑–∏—Ç –∑–∞–≤–µ—Ä—à–∏–ª—Å—è! –ë–∞–ª–∞–Ω—Å —É–≤–µ–ª–∏—á–µ–Ω –≤ 1.5 —Ä–∞–∑–∞.", show_alert=True)
        else:
            deposit_balance = 0
            is_active = 0

        buttons = []
        if not is_active:
            buttons.append([InlineKeyboardButton("‚úÖ –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å", callback_data=f"activate_deposit_{user_id}")])
        else:
            buttons.append([InlineKeyboardButton("‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è", callback_data=f"deposit_info_{user_id}")])
        buttons.append([InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data=f"bank_back_{user_id}")])
        reply_markup = InlineKeyboardMarkup(buttons)

        # –ò—Å–ø–æ–ª—å–∑—É–µ–º get_display_name_html_new
        display_name = get_display_name_html_new(query.from_user)

        await query.edit_message_text(
            f"üè¶ <b>FeBank | –î–µ–ø–æ–∑–∏—Ç</b>\n"
            f"üë§ <b>{display_name}</b>\n"
            f"üí∞ <b>–ë–∞–ª–∞–Ω—Å:</b> {format_balance_bank(deposit_balance)}‚ÇΩ\n"
            f"üìå <b>–°–æ—Å—Ç–æ—è–Ω–∏–µ:</b> {'üü¢' if is_active else 'üî¥'}",
            reply_markup=reply_markup,
            parse_mode="HTML"
        )


    elif prefix == "activate" and subaction == "deposit":
        now = datetime.now()
        end_time = now + timedelta(hours=24)
        cursor.execute("SELECT deposit_balance FROM Bank_Deposit WHERE user_id = ?", (user_id,))
        row = cursor.fetchone()
        if not row or row[0] == 0:
            await query.answer("‚ùó –ù–∞ –¥–µ–ø–æ–∑–∏—Ç–µ –Ω–µ—Ç –¥–µ–Ω–µ–≥ –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏.", show_alert=True)
            return

        cursor.execute("UPDATE Bank_Deposit SET is_active = 1, start_time = ?, end_time = ? WHERE user_id = ?",
                       (now.isoformat(), end_time.isoformat(), user_id))
        conn.commit()
        await query.answer("‚úÖ –î–µ–ø–æ–∑–∏—Ç –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω! –û–Ω –±—É–¥–µ—Ç —É–≤–µ–ª–∏—á–µ–Ω —á–µ—Ä–µ–∑ 24 —á–∞—Å–∞.", show_alert=True)

    elif prefix == "deposit" and subaction == "info":
        cursor.execute("SELECT end_time FROM Bank_Deposit WHERE user_id = ?", (user_id,))
        row = cursor.fetchone()
        if row and row[0]:
            end_time = datetime.fromisoformat(row[0])
            remaining = end_time - datetime.now()
            if remaining.total_seconds() < 0:
                remaining_text = "–î–µ–ø–æ–∑–∏—Ç –∑–∞–≤–µ—Ä—à—ë–Ω."
            else:
                remaining_text = str(remaining).split('.')[0]
        else:
            remaining_text = "–î–µ–ø–æ–∑–∏—Ç –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω."

        await query.answer(f"‚è≥ –î–æ –∫–æ–Ω—Ü–∞ –¥–µ–ø–æ–∑–∏—Ç–∞: {remaining_text}", show_alert=True)

    if prefix == "bank" and subaction == "rename":
        keyboard = InlineKeyboardMarkup([
            [InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data=f"cancel_rename_{user_id}")]
        ])
        sent_message = await query.message.reply_text(
            "üìù –í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å—á—ë—Ç–∞:",
            reply_markup=keyboard
        )
        context.user_data["awaiting_bank_rename"] = user_id
        context.user_data["rename_message_id"] = sent_message.message_id
        context.user_data["rename_chat_id"] = sent_message.chat.id

        # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–∞—É—Ç –æ—Ç–º–µ–Ω—ã —á–µ—Ä–µ–∑ 3 –º–∏–Ω—É—Ç—ã
        asyncio.create_task(rename_timeout(user_id, context, timeout=180))

    elif prefix == "bank" and subaction == "back":
        # –ù–ï –ø—Ä–∏—Å–≤–∞–∏–≤–∞–µ–º update.message, –∞ –ø—Ä–æ—Å—Ç–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º callback-—Å–æ–æ–±—â–µ–Ω–∏–µ –æ–±—Ä–∞—Ç–Ω–æ –≤ –º–µ–Ω—é
        user = update.effective_user  # –∏–ª–∏ query.from_user
        text = get_bank_menu_text(user)
        keyboard = get_bank_keyboard(user_id)
        await query.edit_message_text(text, parse_mode="HTML", reply_markup=keyboard)


def update_bank_name(user_id: int, new_name: str):
    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()
        cursor.execute("UPDATE Bank_New SET account_name = ? WHERE user_id = ?", (new_name, user_id))
        conn.commit()


async def cancel_callback_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    data = query.data
    if data.startswith("cancel_rename_"):
        await cancel_rename_callback(update, context)


async def cancel_rename_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    user_id = query.from_user.id

    if context.user_data.get("awaiting_bank_rename") == user_id:
        context.user_data.pop("awaiting_bank_rename", None)
        await query.edit_message_text("‚ùå –°–º–µ–Ω–∞ –Ω–∞–∑–≤–∞–Ω–∏—è —Å—á—ë—Ç–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞.")
    else:
        await query.answer("‚ùó –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ —Å–º–µ–Ω—ã –Ω–∞–∑–≤–∞–Ω–∏—è.", show_alert=True)


async def rename_timeout(user_id: int, context: ContextTypes.DEFAULT_TYPE, timeout=180):
    await asyncio.sleep(timeout)
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –µ—â—ë –æ–∂–∏–¥–∞–Ω–∏–µ –æ—Ç —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    if context.user_data.get("awaiting_bank_rename") == user_id:
        context.user_data.pop("awaiting_bank_rename", None)
        context.user_data.pop("rename_message_id", None)
        context.user_data.pop("rename_chat_id", None)

        try:
            await context.bot.send_message(
                chat_id=user_id,
                text="‚è≥ –í—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è —Å–º–µ–Ω—ã –Ω–∞–∑–≤–∞–Ω–∏—è –∏—Å—Ç–µ–∫–ª–æ. –°–µ–∞–Ω—Å –æ—Ç–º–µ–Ω—ë–Ω."
            )
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—Ç–º–µ–Ω–µ: {e}")


async def handle_rename_bank(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not update.message or not update.message.text:
        return

    user = update.effective_user
    user_id = user.id
    if context.user_data.get("awaiting_bank_rename") != user_id:
        return

    new_name = update.message.text.strip()

    COST = 25000  # –¶–µ–Ω–∞ —Å–º–µ–Ω—ã –Ω–∞–∑–≤–∞–Ω–∏—è
    MAX_LENGTH = 20  # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ –Ω–∞–∑–≤–∞–Ω–∏—è

    # –ü–æ–ª—É—á–∞–µ–º –Ω–æ–º–µ—Ä –∫–∞—Ä—Ç—ã –∏–∑ –ë–î
    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()
        cursor.execute("SELECT account_number FROM Bank_New WHERE user_id = ?", (user_id,))
        acc_row = cursor.fetchone()
    account_number = acc_row[0] if acc_row else "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"

    if len(new_name) > MAX_LENGTH:
        result_text = f"‚ùå | –ù–∞–∑–≤–∞–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ. \n–ú–∞–∫—Å–∏–º—É–º {MAX_LENGTH} —Å–∏–º–≤–æ–ª–æ–≤."
    else:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–ª–∞–Ω—Å –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –ë–î
        with sqlite3.connect(DB_PATH) as conn:
            cursor = conn.cursor()
            cursor.execute("SELECT balance FROM Bank_New WHERE user_id = ?", (user_id,))
            row = cursor.fetchone()

            if not row:
                result_text = "‚ùå | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö."
            else:
                try:
                    balance = int(float(row[0]))
                except ValueError:
                    await update.message.reply_text("‚ùå | –û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ –±–∞–ª–∞–Ω—Å–∞ –≤–∞—à–µ–≥–æ —Å—á—ë—Ç–∞.")
                    return

                if balance < COST:
                    result_text = "‚ùå | –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ –±–∞–Ω–∫–æ–≤—Å–∫–æ–º —Å—á—ë—Ç–µ."
                else:
                    new_balance = balance - COST
                    cursor.execute("UPDATE Bank_New SET balance = ? WHERE user_id = ?", (new_balance, user_id))
                    cursor.execute("UPDATE Bank_New SET account_name = ? WHERE user_id = ?", (new_name, user_id))
                    conn.commit()
                    result_text = "‚úÖ | –ù–∞–∑–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–æ."

    rename_msg_id = context.user_data.get("rename_message_id")
    rename_chat_id = context.user_data.get("rename_chat_id")

    if rename_msg_id and rename_chat_id:
        try:
            await context.bot.delete_message(chat_id=rename_chat_id, message_id=rename_msg_id)
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –∫–Ω–æ–ø–∫–æ–π –æ—Ç–º–µ–Ω—ã: {e}")

    # –ò—Å–ø–æ–ª—å–∑—É–µ–º get_display_name_html_new –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–º–µ–Ω–∏/–Ω–∏–∫–∞
    display_name = get_display_name_html_new(user)

    text = (
        f"üè¶ <b>FeBank | –°–º–µ–Ω–∞ –Ω–∞–∑–≤–∞–Ω–∏—è</b>\n"
        f"üë§ {display_name}\n"
        f"üí≥ –ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã: <code>{account_number}</code>\n\n"
        f"üÜï –ù–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ:\n<b>{new_name}</b>\n"
        f"üí∏ –¶–µ–Ω–∞ —Å–º–µ–Ω—ã: 25,000 ‚ÇΩ\n"
        f"‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n"
        f"{result_text}"
    )

    await update.message.reply_html(text)

    # –û—á–∏—â–∞–µ–º —Ñ–ª–∞–≥–∏ –æ–∂–∏–¥–∞–Ω–∏—è –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    context.user_data.pop("awaiting_bank_rename", None)
    context.user_data.pop("rename_message_id", None)
    context.user_data.pop("rename_chat_id", None)

async def updep(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id

    conn = get_connection()
    cursor = conn.cursor()

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤
    if len(context.args) != 2:
        await update.message.reply_text("–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:\n–î–µ–ø–æ–∑–∏—Ç {+/-} {—Å—É–º–º–∞}")
        conn.close()
        return

    action = context.args[0]
    amount_str = context.args[1]

    if action not in ("+", "-"):
        await update.message.reply_text("–ü–µ—Ä–≤—ã–π –∞—Ä–≥—É–º–µ–Ω—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å '+' –∏–ª–∏ '-'")
        conn.close()
        return

    if not amount_str.isdigit():
        await update.message.reply_text("–°—É–º–º–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —á–∏—Å–ª–æ–º.")
        conn.close()
        return

    amount = int(amount_str)
    if amount <= 0:
        await update.message.reply_text("–°—É–º–º–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º.")
        conn.close()
        return

    # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å—á–µ—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Bank_New
    cursor.execute("SELECT balance FROM Bank_New WHERE user_id = ?", (user_id,))
    bank_row = cursor.fetchone()
    if not bank_row:
        await update.message.reply_text("–£ –≤–∞—Å –Ω–µ—Ç –±–∞–Ω–∫–æ–≤—Å–∫–æ–≥–æ —Å—á—ë—Ç–∞.")
        conn.close()
        return
    bank_balance = int(bank_row[0])  # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ int

    # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–µ–ø–æ–∑–∏—Ç–∞ –∏–∑ Bank_Deposit
    cursor.execute("SELECT deposit_balance, is_active FROM Bank_Deposit WHERE user_id = ?", (user_id,))
    dep_row = cursor.fetchone()

    if dep_row:
        deposit_balance = int(dep_row[0])
        is_active = dep_row[1]
    else:
        deposit_balance, is_active = 0, 0

    if is_active:
        await update.message.reply_text("‚ùó –ù–µ–ª—å–∑—è –∏–∑–º–µ–Ω—è—Ç—å –¥–µ–ø–æ–∑–∏—Ç, –ø–æ–∫–∞ –æ–Ω –∞–∫—Ç–∏–≤–µ–Ω.")
        conn.close()
        return

    if action == "+":
        if bank_balance < amount:
            await update.message.reply_text("‚ùó –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–º –±–∞–ª–∞–Ω—Å–µ –¥–ª—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –¥–µ–ø–æ–∑–∏—Ç–∞.")
            conn.close()
            return
        new_bank_balance = bank_balance - amount
        new_deposit_balance = deposit_balance + amount

        cursor.execute("UPDATE Bank_New SET balance = ? WHERE user_id = ?", (new_bank_balance, user_id))
        if dep_row:
            cursor.execute("UPDATE Bank_Deposit SET deposit_balance = ? WHERE user_id = ?",
                           (new_deposit_balance, user_id))
        else:
            cursor.execute(
                "INSERT INTO Bank_Deposit (user_id, deposit_balance, is_active) VALUES (?, ?, 0)",
                (user_id, amount)
            )
        conn.commit()
        await update.message.reply_text(
            f"‚úÖ <b>–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–µ–ø–æ–∑–∏—Ç–∞</b>\n"
            f"<b>–°—É–º–º–∞:</b> {amount} ‚ÇΩ\n"
            f"üè¶ <b>–ë–∞–ª–∞–Ω—Å –¥–µ–ø–æ–∑–∏—Ç–∞:</b> {new_deposit_balance} ‚ÇΩ\n"
            f"üí∞ <b>–ë–∞–ª–∞–Ω—Å –±–∞–Ω–∫–∞:</b> {new_bank_balance} ‚ÇΩ",
            parse_mode="HTML"
        )

    elif action == "-":
        if deposit_balance < amount:
            await update.message.reply_text("‚ùó –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ –¥–µ–ø–æ–∑–∏—Ç–µ –¥–ª—è —Å–Ω—è—Ç–∏—è.")
            conn.close()
            return

        new_deposit_balance = deposit_balance - amount
        new_bank_balance = bank_balance + amount

        cursor.execute("UPDATE Bank_New SET balance = ? WHERE user_id = ?", (new_bank_balance, user_id))
        cursor.execute("UPDATE Bank_Deposit SET deposit_balance = ? WHERE user_id = ?", (new_deposit_balance, user_id))
        conn.commit()
        await update.message.reply_text(
            f"‚úÖ <b>–°–Ω—è—Ç–∏–µ —Å—Ä–µ–¥—Å—Ç–≤ —Å –¥–µ–ø–æ–∑–∏—Ç–∞</b>\n"
            f"<b>–°—É–º–º–∞:</b> {amount} ‚ÇΩ\n"
            f"üè¶ <b>–ë–∞–ª–∞–Ω—Å –¥–µ–ø–æ–∑–∏—Ç–∞:</b> {new_deposit_balance} ‚ÇΩ\n"
            f"üí∞ <b>–ë–∞–ª–∞–Ω—Å –±–∞–Ω–∫–∞:</b> {new_bank_balance} ‚ÇΩ",
            parse_mode="HTML"
        )

    conn.close()


ACCOUNT_PREFIXES = ["2202", "2200", "2201", "4000", "4276", "5254", "3782"]


def generate_unique_account_number():
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    while True:
        prefix = random.choice(ACCOUNT_PREFIXES)
        rest = ''.join(random.choices("0123456789", k=12))
        full_number = prefix + rest

        cursor.execute("SELECT 1 FROM Bank_New WHERE account_number = ?", (full_number,))
        if not cursor.fetchone():
            break

    conn.close()
    return full_number


async def createbank(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    user_id = user.id
    first_name = user.first_name

    # –ê—Ä–≥—É–º–µ–Ω—Ç—ã
    if not context.args:
        await update.message.reply_text("‚ùó –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: –ë–∞–Ω–∫ —Å–æ–∑–¥–∞—Ç—å <–Ω–∞–∑–≤–∞–Ω–∏–µ —Å—á—ë—Ç–∞>")
        return

    account_name = ' '.join(context.args)

    # –ü—Ä–æ–≤–µ—Ä–∫–∞: —É–∂–µ –µ—Å—Ç—å?
    if get_account_bank_info(user_id):
        await update.message.reply_text("‚ùó –£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –±–∞–Ω–∫–æ–≤—Å–∫–∏–π —Å—á—ë—Ç.")
        return

    account_number = generate_unique_account_number()
    created_at = datetime.now().strftime("%Y-%m-%d %H:%M:%S")

    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("""
        INSERT INTO Bank_New (user_id, first_name, account_name, account_number, balance, created_at)
        VALUES (?, ?, ?, ?, ?, ?)
    """, (user_id, first_name, account_name, account_number, '0', created_at))
    conn.commit()
    conn.close()

    formatted_account_number = format_account_number(account_number)

    await update.message.reply_html(
        f"‚úÖ <b>–°—á—ë—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!</b>\n\n"
        f"üìõ <b>–ù–∞–∑–≤–∞–Ω–∏–µ —Å—á—ë—Ç–∞:</b> {account_name}\n"
        f"üë§ <b>–í–ª–∞–¥–µ–ª–µ—Ü:</b> {get_display_name_html_new(user)}\n"
        f"üí≥ <b>–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã:</b>\n<code>{formatted_account_number}</code>\n"
        f"üí∞ <b>–ë–∞–ª–∞–Ω—Å:</b> 0 ‚ÇΩ"
    )


async def delbank(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    user_id = user.id
    first_name = user.first_name

    account = get_account_bank_info(user_id)
    if not account:
        await update.message.reply_text("‚ùó –£ –≤–∞—Å –Ω–µ—Ç –±–∞–Ω–∫–æ–≤—Å–∫–æ–≥–æ —Å—á—ë—Ç–∞.")
        return

    account_number = account[1]  # account_number
    formatted_number = format_account_number(account_number)

    keyboard = InlineKeyboardMarkup([
        [
            InlineKeyboardButton("‚úÖ –î–∞", callback_data=f"confirm_delbank_{user_id}"),
            InlineKeyboardButton("‚ùå –ù–µ—Ç", callback_data="cancel_delbank")
        ]
    ])

    await update.message.reply_html(
        f"üè¶ <b>Bank</b> | <a href='tg://user?id={user_id}'>{first_name}</a>\n"
        f"üí≥ <b>–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã:</b> \n<code>{formatted_number}</code>\n\n"
        "–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ —Ä–∞–∑–æ—Ä–≤–∞—Ç—å –¥–æ–≥–æ–≤–æ—Ä —Å —Å–∏—Å—Ç–µ–º–æ–π <b>FeBank</b>?\n\n"
        "<pre>–£–¥–∞–ª–∏—Ç—å –±–µ–∑ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –≤–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è</pre>",
        reply_markup=keyboard
    )


async def delbank_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    user_id = query.from_user.id
    first_name = query.from_user.first_name
    data = query.data

    await query.answer()

    if data == "cancel_delbank":
        account = get_account_bank_info(user_id)
        if not account:
            await query.edit_message_text("‚ùó –£ –≤–∞—Å –Ω–µ—Ç –±–∞–Ω–∫–æ–≤—Å–∫–æ–≥–æ —Å—á—ë—Ç–∞.")
            return

        account_number = format_account_number(account[1])
        await query.edit_message_text(
            f"üè¶ <b>Bank</b> | <a href='tg://user?id={user_id}'>{first_name}</a>\n"
            f"üí≥ <b>–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã:</b> \n<code>{account_number}</code>\n\n"
            f"‚ùå <b>–†–∞—Å—Ç–æ—Ä–∂–µ–Ω–∏–µ –¥–æ–≥–æ–≤–æ—Ä–∞ –æ—Ç–º–µ–Ω–µ–Ω–æ.</b>",
            parse_mode=ParseMode.HTML
        )
        return

    if data.startswith("confirm_delbank_"):
        parts = data.split("_")
        if len(parts) != 3:
            await query.answer("‚õî –û—à–∏–±–∫–∞: –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö.", show_alert=True)
            return

        try:
            original_user_id = int(parts[2])
        except ValueError:
            await query.answer("‚õî –û—à–∏–±–∫–∞: –Ω–µ–≤–µ—Ä–Ω—ã–π ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.", show_alert=True)
            return

        if user_id != original_user_id:
            await query.answer("‚õî –¢–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä –∑–∞–ø—Ä–æ—Å–∞ –º–æ–∂–µ—Ç —É–¥–∞–ª–∏—Ç—å —Å—á—ë—Ç.", show_alert=True)
            return

        account = get_account_bank_info(user_id)
        if not account:
            await query.edit_message_text("‚ùó –£ –≤–∞—Å –Ω–µ—Ç –±–∞–Ω–∫–æ–≤—Å–∫–æ–≥–æ —Å—á—ë—Ç–∞.")
            return

        account_number = format_account_number(account[1])

        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()
        cursor.execute("DELETE FROM Bank_New WHERE user_id = ?", (user_id,))
        conn.commit()
        conn.close()

        await query.edit_message_text(
            f"üè¶ <b>Bank</b> | <a href='tg://user?id={user_id}'>{first_name}</a>\n"
            f"üí≥ <b>–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã:</b> \n<code>{account_number}</code>\n\n"
            f"‚úÖ <b>–î–æ–≥–æ–≤–æ—Ä —Ä–∞—Å—Ç–æ—Ä–≥–Ω—É—Ç.</b>",
            parse_mode=ParseMode.HTML
        )

async def bankreplenish(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    user_id = user.id
    first_name = user.first_name

    if not context.args:
        await update.message.reply_text("‚ùó –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: –ë–∞–Ω–∫ –ø–æ–ø–æ–ª–Ω–∏—Ç—å {—Å—É–º–º–∞}")
        return

    raw_amt = context.args[0]
    acc = get_account_bank_info(user_id)
    if not acc:
        await update.message.reply_text("‚ùó –£ –≤–∞—Å –Ω–µ—Ç –±–∞–Ω–∫–æ–≤—Å–∫–æ–≥–æ —Å—á—ë—Ç–∞.")
        return

    try:
        bal_raw = acc[2] or 0
        cur_bal = int(float(str(bal_raw).replace(" ", "").replace(",", ".")))
    except Exception as e:
        print(f"ERROR converting balance to int: {e} | value: {acc[2]!r}")
        await update.message.reply_text("‚ùó –û—à–∏–±–∫–∞ –≤ –¥–∞–Ω–Ω—ã—Ö –±–∞–ª–∞–Ω—Å–∞. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏.")
        return

    amt = parse_bet_input(raw_amt, cur_bal)
    if amt is None or amt <= 0:
        await update.message.reply_text("‚ùó –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Å—É–º–º–∞.")
        return

    if not adjust_user_main_balance(user_id, -amt):
        await update.message.reply_text("‚ùó –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–º –±–∞–ª–∞–Ω—Å–µ.")
        return

    # –ö–æ–º–∏—Å—Å–∏—è 5%
    commission = round(amt * 0.05)
    amt_after_commission = amt - commission
    new_bal = cur_bal + amt_after_commission

    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("UPDATE Bank_New SET balance = ? WHERE user_id = ?", (str(new_bal), user_id))
    conn.commit()
    conn.close()

    formatted = format_account_number(acc[1])
    await update.message.reply_html(
        f"üè¶ <b>Bank</b> | {get_display_name_html_new(user)}\n"
        "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n"
        f"üí≥ <b>–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã:</b> <code>{formatted}</code>\n\n"
        f"üì• <b>–û–ø–µ—Ä–∞—Ü–∏—è:</b> –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ —Å—á—ë—Ç–∞\n"
        f"‚ûï <b>–°—É–º–º–∞:</b> <code>{format_balance_bank(amt)}</code> ‚ÇΩ\n"
        f"üí∏ <b>–ö–æ–º–∏—Å—Å–∏—è 5%:</b> <code>{format_balance_bank(commission)}</code> ‚ÇΩ\n"
        f"üíº <b>–ó–∞—á–∏—Å–ª–µ–Ω–æ –Ω–∞ —Å—á—ë—Ç:</b> <code>{format_balance_bank(amt_after_commission)}</code> ‚ÇΩ\n"
        f"üí∞ <b>–ë–∞–ª–∞–Ω—Å —Å—á—ë—Ç–∞:</b> <code>{format_balance_bank(new_bal)}</code> ‚ÇΩ\n"
        "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
    )

async def bankremoved(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    user_id = user.id
    first_name = user.first_name

    if not context.args:
        await update.message.reply_text("‚ùó –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: –ë–∞–Ω–∫ —Å–Ω—è—Ç—å {—Å—É–º–º–∞}")
        return

    raw_amt = context.args[0]
    acc = get_account_bank_info(user_id)
    if not acc:
        await update.message.reply_text("‚ùó –£ –≤–∞—Å –Ω–µ—Ç –±–∞–Ω–∫–æ–≤—Å–∫–æ–≥–æ —Å—á—ë—Ç–∞.")
        return

    try:
        bal_raw = acc[2] or 0
        cur_bal = int(float(str(bal_raw).replace(" ", "").replace(",", ".")))
    except Exception as e:
        print(f"ERROR converting balance to int: {e} | value: {acc[2]!r}")
        await update.message.reply_text("‚ùó –û—à–∏–±–∫–∞ –≤ –¥–∞–Ω–Ω—ã—Ö –±–∞–ª–∞–Ω—Å–∞. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏.")
        return

    amt = parse_bet_input(raw_amt, cur_bal)
    if amt is None or amt <= 0:
        await update.message.reply_text("‚ùó –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Å—É–º–º–∞.")
        return

    if cur_bal < amt:
        await update.message.reply_text("‚ùó –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ —Å—á—ë—Ç–µ.")
        return

    commission = round(amt * 0.05)
    amt_after_commission = amt - commission
    new_bal = cur_bal - amt

    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("UPDATE Bank_New SET balance = ? WHERE user_id = ?", (str(new_bal), user_id))
    conn.commit()
    conn.close()

    if not adjust_user_main_balance(user_id, amt_after_commission):
        await update.message.reply_text("‚ùó –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞—á–∏—Å–ª–∏—Ç—å —Å—Ä–µ–¥—Å—Ç–≤–∞ –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–π –±–∞–ª–∞–Ω—Å.")
        return

    formatted_number = format_account_number(acc[1])
    await update.message.reply_html(
        f"üè¶ <b>Bank</b> | {get_display_name_html_new(user)}\n"
        "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n"
        f"üí≥ <b>–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã:</b> <code>{formatted_number}</code>\n\n"
        f"üì§ <b>–û–ø–µ—Ä–∞—Ü–∏—è:</b> –°–ø–∏—Å–∞–Ω–∏–µ —Å—Ä–µ–¥—Å—Ç–≤\n"
        f"‚ûñ <b>–°—É–º–º–∞ —Å–ø–∏—Å–∞–Ω–∏—è:</b> <code>{format_balance_bank(amt)}</code> ‚ÇΩ\n"
        f"üí∏ <b>–ö–æ–º–∏—Å—Å–∏—è 5%:</b> <code>{format_balance_bank(commission)}</code> ‚ÇΩ\n"
        f"üíº <b>–ó–∞—á–∏—Å–ª–µ–Ω–æ –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–π –±–∞–ª–∞–Ω—Å:</b> <code>{format_balance_bank(amt_after_commission)}</code> ‚ÇΩ\n"
        f"üí∞ <b>–ë–∞–ª–∞–Ω—Å —Å—á—ë—Ç–∞:</b> <code>{format_balance_bank(new_bal)}</code> ‚ÇΩ\n"
        "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
    )


def get_account_info_by_card(card_number: str):
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute(
        "SELECT user_id, first_name, account_name, account_number, balance FROM Bank_New WHERE account_number = ?",
        (card_number,)
    )
    result = cursor.fetchone()
    conn.close()
    return result  # –ö–æ—Ä—Ç–µ–∂ (user_id, first_name, account_name, account_number, balance) –∏–ª–∏ None


def format_card(number):
    return ' '.join([number[i:i + 4] for i in range(0, len(number), 4)])


async def bpay(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    user_id = user.id
    first_name = user.first_name

    if len(context.args) < 2:
        await update.message.reply_text("‚ùó –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: –ë–∞–Ω–∫ –ø–µ—Ä–µ–≤–æ–¥ {—Å—É–º–º–∞} {–Ω–æ–º–µ—Ä –∫–∞—Ä—Ç—ã}")
        return

    # –ü–∞—Ä—Å–∏–º –∞—Ä–≥—É–º–µ–Ω—Ç—ã
    amt_str = context.args[0]
    card_input = " ".join(context.args[1:])

    if not amt_str.isdigit():
        await update.message.reply_text("‚ùó –°—É–º–º–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —á–∏—Å–ª–æ–º.")
        return
    amt = int(amt_str)
    if amt <= 0:
        await update.message.reply_text("‚ùó –°—É–º–º–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–π.")
        return

    # –£–±–∏—Ä–∞–µ–º –ø—Ä–æ–±–µ–ª—ã –∏–∑ –Ω–æ–º–µ—Ä–∞ –∫–∞—Ä—Ç—ã
    card_number = card_input.replace(" ", "")

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–ª–∏–Ω—É –∫–∞—Ä—Ç—ã (–ø—Ä–∏–º–µ—Ä: 16 —Å–∏–º–≤–æ–ª–æ–≤)
    if len(card_number) != 16 or not card_number.isdigit():
        await update.message.reply_text("‚ùó –ù–µ–≤–µ—Ä–Ω—ã–π –Ω–æ–º–µ—Ä –∫–∞—Ä—Ç—ã. \n–§–æ—Ä–º–∞—Ç: 1234567898765432")
        return

    # –ü–æ–ª—É—á–∞–µ–º —Å—á–µ—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
    sender_acc = get_account_bank_info(user_id)
    if not sender_acc:
        await update.message.reply_text("‚ùó –£ –≤–∞—Å –Ω–µ—Ç –±–∞–Ω–∫–æ–≤—Å–∫–æ–≥–æ —Å—á—ë—Ç–∞.")
        return

    try:
        sender_balance = int(float(sender_acc[2]))  # –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ
    except ValueError:
        await update.message.reply_text("‚ùó –û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ –±–∞–ª–∞–Ω—Å–∞ –≤–∞—à–µ–≥–æ —Å—á—ë—Ç–∞.")
        return

    sender_card_number = sender_acc[1]

    # –ò—â–µ–º —Å—á–µ—Ç –ø–æ–ª—É—á–∞—Ç–µ–ª—è –ø–æ –Ω–æ–º–µ—Ä—É –∫–∞—Ä—Ç—ã
    recipient_acc = get_account_info_by_card(card_number)
    if not recipient_acc:
        await update.message.reply_html(
            f"üè¶ <b>FeBank | –ü–µ—Ä–µ–≤–æ–¥</b>\n"
            f"‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n"
            f"üë§ {get_display_name_html_new(user)}\n"
            f"‚ùó <b>–£–∫–∞–∑–∞–Ω–Ω—ã–π –Ω–æ–º–µ—Ä –∫–∞—Ä—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω</b>\n"
            f"üí≥ <b>–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã:</b> <code>{card_number}</code>\n"
            f"‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
        )
        return

    recipient_user_id, recipient_first_name, recipient_account_name, recipient_card_number, recipient_balance = recipient_acc

    # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –Ω–æ–º–µ—Ä–∞ –∫–∞—Ä—Ç
    def format_card(number: str) -> str:
        return ' '.join([number[i:i + 4] for i in range(0, len(number), 4)])

    formatted_sender_card = format_card(sender_card_number)
    formatted_recipient_card = format_card(recipient_card_number)

    # –ö–æ–º–∏—Å—Å–∏—è %
    commission_percent = 2
    commission_amount = int(amt * commission_percent / 100)
    total_amount = amt + commission_amount  # —Å–ø–∏—Å—ã–≤–∞–µ–º —Å –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–∞–Ω–Ω—ã–µ, –∏–º—è –Ω–µ –Ω—É–∂–Ω–æ ‚Äî –ø–æ–ª—É—á–∏–º –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏
    context.user_data['bpay'] = {
        'amount': amt,  # –ü–æ–ª—É—á–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∏—Ç —Ä–æ–≤–Ω–æ amt
        'total_amount': total_amount,  # –°–ø–∏—Å—ã–≤–∞–µ–º —Å –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
        'commission': commission_amount,
        'recipient_id': recipient_user_id,
        'recipient_card': recipient_card_number,
        'sender_card': sender_card_number,
    }

    keyboard = InlineKeyboardMarkup([
        [
            InlineKeyboardButton("‚úÖ", callback_data="bpay_confirm"),
            InlineKeyboardButton("‚ùå", callback_data="bpay_cancel")
        ]
    ])

    # –ü–æ–ª—É—á–∞–µ–º –æ–±—ä–µ–∫—Ç User –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
    recipient_user = await context.bot.get_chat(recipient_user_id)

    await update.message.reply_html(
        f"üè¶ <b>FeBank | –ü–µ—Ä–µ–≤–æ–¥</b>\n"
        f"‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n"
        f"üë§ <b>–ü–æ–ª—É—á–∞—Ç–µ–ª—å:</b> {get_display_name_html_new(recipient_user)}\n"
        f"üí≥ <b>–ö–∞—Ä—Ç–∞:</b> <code>{formatted_recipient_card}</code>\n\n"
        f"üíº <b>–í–∞—à–∞ –∫–∞—Ä—Ç–∞:</b> <code>{formatted_sender_card}</code>\n"
        f"üí∞ <b>–í–∞—à –±–∞–ª–∞–Ω—Å:</b> <b>{format_balance_bank(sender_balance)} ‚ÇΩ</b>\n\n"
        f"üí∏ <b>–°—É–º–º–∞ –ø–µ—Ä–µ–≤–æ–¥–∞:</b> <b>{format_balance_bank(amt)} ‚ÇΩ</b>\n"
        f"üíµ <b>–ö–æ–º–∏—Å—Å–∏—è {commission_percent}%:</b> <b>{format_balance_bank(commission_amount)} ‚ÇΩ</b>\n"
        f"üí∞ <b>–ë—É–¥–µ—Ç —Å–ø–∏—Å–∞–Ω–æ –≤—Å–µ–≥–æ:</b> <b>{format_balance_bank(total_amount)} ‚ÇΩ</b>\n"
        f"‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ",
        reply_markup=keyboard
    )

async def bpay_callback_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    user = query.from_user
    user_id = user.id

    if 'bpay' not in context.user_data:
        await query.answer("‚ùó –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø–µ—Ä–µ–≤–æ–¥–∞.")
        return

    data = context.user_data['bpay']

    def format_card(number):
        return ' '.join([number[i:i + 4] for i in range(0, len(number), 4)])

    if query.data == "bpay_cancel":
        formatted_recipient_card = format_card(data.get('recipient_card', ''))
        formatted_sender_card = format_card(data.get('sender_card', ''))
        amt = data.get('amount', 0)
        total_amount = data.get('total_amount', amt)

        recipient_id = data.get('recipient_id', 0)
        try:
            recipient_user = await context.bot.get_chat(recipient_id)
            recipient_display = get_display_name_html_new(recipient_user)
        except Exception:
            recipient_display = f"<a href='tg://user?id={recipient_id}'>–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ</a>"

        await query.edit_message_text(
            f"üè¶ üí≥ FeBank | –ü–µ—Ä–µ–≤–æ–¥ ‚ùå\n"
            f"‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n"
            f"üë§ –ü–æ–ª—É—á–∞—Ç–µ–ª—å: {recipient_display}\n"
            f"üí≥ –ö–∞—Ä—Ç–∞ –ø–æ–ª—É—á–∞—Ç–µ–ª—è: <code>{formatted_recipient_card}</code>\n\n"
            f"üíº –í–∞—à–∞ –∫–∞—Ä—Ç–∞: <code>{formatted_sender_card}</code>\n"
            f"üí∞ –ë–∞–ª–∞–Ω—Å: <b>–Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è</b>\n\n"
            f"üí∏ –°—É–º–º–∞ –ø–µ—Ä–µ–≤–æ–¥–∞: <b>{format_balance_bank(amt)} ‚ÇΩ</b>\n"
            f"üíµ –° –∫–æ–º–∏—Å—Å–∏–µ–π: <b>{format_balance_bank(total_amount)} ‚ÇΩ</b>\n"
            f"‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n"
            f"<pre>‚ùó | –ü–µ—Ä–µ–≤–æ–¥ –æ—Ç–º–µ–Ω—ë–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.</pre>",
            parse_mode="HTML"
        )
        context.user_data.pop('bpay', None)
        return

    if query.data == "bpay_confirm":
        sender_acc = get_account_bank_info(user_id)
        if not sender_acc:
            await query.edit_message_text("‚ùó –£ –≤–∞—Å –Ω–µ—Ç –±–∞–Ω–∫–æ–≤—Å–∫–æ–≥–æ —Å—á—ë—Ç–∞.")
            context.user_data.pop('bpay', None)
            return

        try:
            sender_balance = int(float(sender_acc[2]))
        except ValueError:
            await query.edit_message_text("‚ùó –û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ –±–∞–ª–∞–Ω—Å–∞ –≤–∞—à–µ–≥–æ —Å—á—ë—Ç–∞.")
            context.user_data.pop('bpay', None)
            return

        amt = data['amount']
        total_amount = data['total_amount']
        commission = data['commission']

        if sender_balance < total_amount:
            await query.edit_message_text(
                f"üè¶ üí≥ FeBank | –ü–µ—Ä–µ–≤–æ–¥ ‚ùå\n"
                f"‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n"
                f"‚ùó –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ –≤–∞—à–µ–º —Å—á—ë—Ç–µ.\n"
                f"üí∞ –¢—Ä–µ–±—É–µ—Ç—Å—è: <b>{format_balance_bank(total_amount)} ‚ÇΩ</b> "
                f"(–≤–∫–ª—é—á–∞—è –∫–æ–º–∏—Å—Å–∏—é {format_balance_bank(commission)} ‚ÇΩ)\n"
                f"‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ",
                parse_mode="HTML"
            )
            context.user_data.pop('bpay', None)
            return

        recipient_id = data['recipient_id']

        # –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å—ã
        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()
        cursor.execute("UPDATE Bank_New SET balance = balance - ? WHERE user_id = ?", (total_amount, user_id))
        cursor.execute("UPDATE Bank_New SET balance = balance + ? WHERE user_id = ?", (amt, recipient_id))
        conn.commit()
        conn.close()

        # –†–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º 60% –∫–æ–º–∏—Å—Å–∏–∏ –º–µ–∂–¥—É –±–∏–∑–Ω–µ—Å–∞–º–∏ –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –ë–∞–Ω–∫
        distribute_commission_to_central_banks(commission)

        sender_balance_after = sender_balance - total_amount

        try:
            sender_user = await context.bot.get_chat(user_id)
            sender_display = get_display_name_html_new(sender_user)
        except Exception:
            sender_display = f"<a href='tg://user?id={user_id}'>–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ</a>"

        try:
            recipient_user = await context.bot.get_chat(recipient_id)
            recipient_display = get_display_name_html_new(recipient_user)
        except Exception:
            recipient_display = f"<a href='tg://user?id={recipient_id}'>–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ</a>"

        await query.edit_message_text(
            f"üè¶ üí≥ FeBank | –ü–µ—Ä–µ–≤–æ–¥ ‚úÖ\n"
            f"‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n"
            f"üë§ –ü–æ–ª—É—á–∞—Ç–µ–ª—å: {recipient_display}\n"
            f"üí≥ –ö–∞—Ä—Ç–∞ –ø–æ–ª—É—á–∞—Ç–µ–ª—è: <code>{format_card(data['recipient_card'])}</code>\n\n"
            f"üíº –í–∞—à–∞ –∫–∞—Ä—Ç–∞: <code>{format_card(data['sender_card'])}</code>\n"
            f"üí∞ –ë–∞–ª–∞–Ω—Å –ø–æ—Å–ª–µ —Å–ø–∏—Å–∞–Ω–∏—è: <b>{format_balance_bank(sender_balance_after)} ‚ÇΩ</b>\n\n"
            f"üí∏ –°—É–º–º–∞ –ø–µ—Ä–µ–≤–æ–¥–∞: <b>{format_balance_bank(amt)} ‚ÇΩ</b>\n"
            f"üíµ –ö–æ–º–∏—Å—Å–∏—è 5%: <b>{format_balance_bank(commission)} ‚ÇΩ</b>\n"
            f"‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n"
            f"<pre>‚úÖ | –ü–µ—Ä–µ–≤–æ–¥ —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω!</pre>",
            parse_mode="HTML"
        )

        log_text = (
            f"üí∞ <b>–ù–æ–≤—ã–π –±–∞–Ω–∫–æ–≤—Å–∫–∏–π –ø–µ—Ä–µ–≤–æ–¥</b>\n"
            f"‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n"
            f"üë§ –û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å: {sender_display}\n"
            f"üÜî ID: <code>{user_id}</code>\n"
            f"üë• –ü–æ–ª—É—á–∞—Ç–µ–ª—å: {recipient_display}\n"
            f"üÜî ID: <code>{recipient_id}</code>\n"
            f"üí≥ –ö–∞—Ä—Ç–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è: <code>{format_card(data['sender_card'])}</code>\n"
            f"üí≥ –ö–∞—Ä—Ç–∞ –ø–æ–ª—É—á–∞—Ç–µ–ª—è: <code>{format_card(data['recipient_card'])}</code>\n"
            f"üí∏ –°—É–º–º–∞ –ø–µ—Ä–µ–≤–æ–¥–∞: <b>{format_balance_bank(amt)} ‚ÇΩ</b>\n"
            f"üíµ –ö–æ–º–∏—Å—Å–∏—è: <b>{format_balance_bank(commission)} ‚ÇΩ</b>\n"
            f"üí∞ –í—Å–µ–≥–æ —Å–ø–∏—Å–∞–Ω–æ: <b>{format_balance_bank(total_amount)} ‚ÇΩ</b>\n"
        )

        try:
            await context.bot.send_message(
                chat_id=Transaction_ID,
                text=log_text,
                parse_mode="HTML"
            )
        except Exception as e:
            print("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ª–æ–≥–∞ –±–∞–Ω–∫–æ–≤—Å–∫–æ–≥–æ –ø–µ—Ä–µ–≤–æ–¥–∞:", e)

        write_log(
            log_type="bank_transfers",
            admin_id=user_id,
            target_id=recipient_id,
            amount=amt,
            duration="-",
            reason="-",
            chat_id="-",
            action=f"üí∏ –ü–µ—Ä–µ–≤–æ–¥ {format_balance_bank(amt)} ‚ÇΩ\n"
                   f"üí≥ –° –∫–∞—Ä—Ç—ã: {format_card(data['sender_card'])}\n"
                   f"üè¶ –ù–∞ –∫–∞—Ä—Ç—É: {format_card(data['recipient_card'])}"
        )

        context.user_data.pop('bpay', None)

ADMINBANKCARD_ID = 7406372338


async def changecardnumber(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id

    if user_id != ADMINBANKCARD_ID:
        await update.message.reply_text("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —Å–º–µ–Ω—ã –Ω–æ–º–µ—Ä–∞ –∫–∞—Ä—Ç—ã.")
        return

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–æ–º–∞–Ω–¥–∞ –≤—ã–∑–≤–∞–Ω–∞ –≤ –æ—Ç–≤–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    if not update.message.reply_to_message:
        await update.message.reply_text(
            "‚ùå –ö–æ–º–∞–Ω–¥—É –Ω—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ –æ—Ç–≤–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —á–µ–π –Ω–æ–º–µ—Ä –∫–∞—Ä—Ç—ã —Ö–æ—Ç–∏—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å."
        )
        return

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞—Ä–≥—É–º–µ–Ω—Ç—ã –∫–æ–º–∞–Ω–¥—ã
    if len(context.args) != 1:
        await update.message.reply_text("–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:\n/changecardnumber {–Ω–æ–≤—ã–π –Ω–æ–º–µ—Ä –∫–∞—Ä—Ç—ã}")
        return

    new_card_number = context.args[0].strip()

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –Ω–æ–º–µ—Ä–∞ –∫–∞—Ä—Ç—ã
    if len(new_card_number) != 16 or not new_card_number.isdigit():
        await update.message.reply_text("‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –Ω–æ–º–µ—Ä–∞ –∫–∞—Ä—Ç—ã. –î–æ–ª–∂–Ω–æ –±—ã—Ç—å —Ä–æ–≤–Ω–æ 16 —Ü–∏—Ñ—Ä.")
        return

    target_user = update.message.reply_to_message.from_user
    target_user_id = target_user.id

    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    try:
        cursor.execute("UPDATE Bank_New SET account_number = ? WHERE user_id = ?", (new_card_number, target_user_id))
        if cursor.rowcount == 0:
            # –ï—Å–ª–∏ –∑–∞–ø–∏—Å–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç ‚Äî —Å–æ–∑–¥–∞—ë–º –µ—ë —Å –±–∞–ª–∞–Ω—Å–æ–º 0
            cursor.execute(
                "INSERT INTO Bank_New (user_id, account_number, balance, created_at) VALUES (?, ?, 0, datetime('now'))",
                (target_user_id, new_card_number)
            )
        conn.commit()
    except sqlite3.IntegrityError:
        await update.message.reply_text("‚ùå –¢–∞–∫–æ–π –Ω–æ–º–µ—Ä –∫–∞—Ä—Ç—ã —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –±–∞–∑–µ.")
        conn.close()
        return
    conn.close()

    await update.message.reply_html(
        f"‚úÖ –ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {get_display_name_html_new(target_user)} —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω—ë–Ω –Ω–∞:\n"
        f"<code>{new_card_number}</code>"
    )


def load_ratings():
    try:
        with open(RATING_FILE, "r", encoding="utf-8") as f:
            data = json.load(f)
            if "users" not in data:
                data = {"users": data}  # –ï—Å–ª–∏ —Å—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç –±–µ–∑ "users"
            return data
    except FileNotFoundError:
        return {"users": {}}


def get_user_from_db_stats(user_id):
    conn = sqlite3.connect(DB_PATH)
    conn.row_factory = sqlite3.Row  # –í–æ—Ç —ç—Ç–æ –Ω—É–∂–Ω–æ!
    cursor = conn.cursor()
    cursor.execute("SELECT * FROM users WHERE user_id = ?", (user_id,))
    row = cursor.fetchone()
    conn.close()
    return dict(row) if row else None


def create_user_in_db(user_id: str, username: str):
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("INSERT OR IGNORE INTO users (user_id, username) VALUES (?, ?)", (user_id, username))
    conn.commit()
    conn.close()


def get_user_business(user_id: str):
    conn = sqlite3.connect(DB_PATH)
    conn.row_factory = sqlite3.Row
    cursor = conn.cursor()
    cursor.execute("SELECT * FROM businesses WHERE user_id = ?", (user_id,))
    business = cursor.fetchone()
    conn.close()
    return business


def get_user_bussell(user_id: str):
    conn = sqlite3.connect(DB_PATH)
    conn.row_factory = sqlite3.Row
    cursor = conn.cursor()
    cursor.execute("SELECT * FROM users WHERE user_id = ?", (user_id,))
    user = cursor.fetchone()
    conn.close()
    return user


LOG_PATH = Path("corrupted_users.log")


def log_corrupted_user(user_id: int):
    """–õ–æ–≥–∏—Ä—É–µ–º user_id, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã–∑—ã–≤–∞—é—Ç –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–µ –ë–î"""
    try:
        with LOG_PATH.open("a", encoding="utf-8") as f:
            f.write(f"{user_id}\n")
    except Exception:
        pass  # –Ω–∞ —Å–ª—É—á–∞–π –ø—Ä–æ–±–ª–µ–º —Å —Å–∞–º–∏–º –ª–æ–≥-—Ñ–∞–π–ª–æ–º

def get_display_name_html_by_id(user_id: int | str) -> str:
    """–ü–æ–ª—É—á–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è –ø–æ user_id (–±–µ–∑ –æ–±—ä–µ–∫—Ç–∞ telegram.User)."""
    user_id_str = str(user_id)

    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT nickname, first_name FROM users WHERE user_id = ?", (user_id_str,))
    result = cursor.fetchone()
    conn.close()

    if result:
        nickname, first_name_db = result
    else:
        nickname = None
        first_name_db = None

    if nickname:
        display = html.escape(nickname).replace("#", "&#35;")
    elif first_name_db:
        display = html.escape(first_name_db.strip()).replace("#", "&#35;") or "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"
    else:
        display = f"#{user_id_str}"  # fallback ‚Äî –µ—Å–ª–∏ –≤ –ë–î –Ω–µ—Ç –≤–æ–æ–±—â–µ –Ω–∏—á–µ–≥–æ

    return f'<a href="tg://user?id={user_id_str}">{display}</a>'

def get_display_name_html_new(user: telegram.User) -> str:
    user_id = str(user.id)

    nickname = None
    first_name_db = None

    try:
        # –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î
        with sqlite3.connect(DB_PATH, timeout=30, check_same_thread=False) as conn:
            conn.execute("PRAGMA journal_mode=WAL;")
            cur = conn.cursor()
            try:
                cur.execute(
                    "SELECT nickname, first_name FROM users WHERE user_id = ?",
                    (user_id,)
                )
                row = cur.fetchone()
                if row:
                    nickname = row[0]
                    first_name_db = row[1]
            except sqlite3.DatabaseError:
                # –ü—Ä–æ–±–ª–µ–º–Ω–∞—è –∑–∞–ø–∏—Å—å, –ª–æ–≥–∏—Ä—É–µ–º user_id
                log_corrupted_user(user.id)
                nickname = None
                first_name_db = None

    except sqlite3.DatabaseError:
        # –§–æ–ª–ª–±–µ–∫, –µ—Å–ª–∏ –±–∞–∑–∞ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é
        fallback = user.first_name or "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"
        safe = html.escape(fallback).replace("#", "&#35;")
        return f'<a href="tg://user?id={user_id}">{safe}</a>'

    # –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    display = nickname or first_name_db or user.first_name or "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"
    display = html.escape(display).replace("#", "&#35;")
    return f'<a href="tg://user?id={user_id}">{display}</a>'

def get_level(exp: int) -> int:
    # –ü—Ä–æ—Å—Ç–∞—è —Ñ–æ—Ä–º—É–ª–∞ —É—Ä–æ–≤–Ω—è, –º–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å
    return exp // 100 + 1


def escape_md2(text: str) -> str:
    for ch in r"_*[]()~`>#+-=|{}.!":
        text = text.replace(ch, f"\\{ch}")
    return text

def get_fernie_style(user_id: str) -> str:
    with sqlite3.connect(DB_PATH) as conn:
        cur = conn.cursor()
        cur.execute("SELECT FernieStyle FROM SubFerniePlus WHERE user_id = ?", (user_id,))
        row = cur.fetchone()
        if row and row[0]:
            return row[0]
    return "–§–æ—Ç–æ"  # –¥–µ—Ñ–æ–ª—Ç, –µ—Å–ª–∏ –≤ –±–∞–∑–µ –Ω–µ—Ç –∑–Ω–∞—á–µ–Ω–∏—è


def toggle_fernie_style(user_id: str) -> str:
    current_style = get_fernie_style(user_id)
    new_style = "–¢–µ–∫—Å—Ç" if current_style == "–§–æ—Ç–æ" else "–§–æ—Ç–æ"
    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()
        cursor.execute(
            "UPDATE SubFerniePlus SET FernieStyle = ? WHERE user_id = ?",
            (new_style, user_id)
        )
        conn.commit()
    return new_style


def update_ferniestyle_to_text():
    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ø–æ–ª–µ FernieStyle
        cursor.execute("PRAGMA table_info(SubFerniePlus)")
        columns = [col[1] for col in cursor.fetchall()]

        if "FernieStyle" not in columns:
            cursor.execute("ALTER TABLE SubFerniePlus ADD COLUMN FernieStyle TEXT DEFAULT '–¢–µ–∫—Å—Ç'")
            print("–ü–æ–ª–µ FernieStyle –¥–æ–±–∞–≤–ª–µ–Ω–æ.")

        # –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–∞ '–¢–µ–∫—Å—Ç'
        cursor.execute("UPDATE SubFerniePlus SET FernieStyle = '–¢–µ–∫—Å—Ç'")
        conn.commit()
        print("–û–±–Ω–æ–≤–ª–µ–Ω–æ –ø–æ–ª–µ FernieStyle –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –Ω–∞ '–¢–µ–∫—Å—Ç'.")

async def stats(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await show_profile(update, context)

BASE_DIR = os.path.dirname(os.path.abspath(__file__))

def profile_button_menu(mode: str = "main") -> InlineKeyboardMarkup:
    if mode == "main":
        return InlineKeyboardMarkup([
            [InlineKeyboardButton("üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞–∫–∫–∞—É–Ω—Ç–∞", callback_data="profile_stats")],
            [InlineKeyboardButton("üîß –î—Ä—É–≥–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏", callback_data="profile_other")]
        ])
    elif mode == "stats":
        return InlineKeyboardMarkup([
            [InlineKeyboardButton("‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data="profile_back")]
        ])
    elif mode == "other":
        return InlineKeyboardMarkup([
            [
                InlineKeyboardButton("üèò –ò–º—É—â–µ—Å—Ç–≤–æ", callback_data="show_inventory"),
                InlineKeyboardButton("üéí –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å", callback_data="dev_soon")
            ],
            [
                InlineKeyboardButton("üéÅ –†–µ—Ñ–µ—Ä–∞–ª—ã", callback_data="show_referrals"),
                InlineKeyboardButton("üî´ –û–≥—Ä–∞–±–ª–µ–Ω–∏–µ", callback_data="robbery_menu")
            ],
            [InlineKeyboardButton("üéÆ FernieX - MiniGames", url="https://ferniex-minigame.vercel.app")],
            [InlineKeyboardButton("üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ MiniGames", callback_data="minigames_stats")],
            [InlineKeyboardButton("üîß FernieX - –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –ú–∞–∫—Ä–æ—Å–æ–≤", url="https://fernie-x-macros.vercel.app")],
            [InlineKeyboardButton("üè™ –ú–∞–≥–∞–∑–∏–Ω—ã –±–æ—Ç–∞", callback_data="profile_shops")],
            [InlineKeyboardButton("‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data="profile_back")]
        ])
    elif mode == "minigames_stats":
        return InlineKeyboardMarkup([
            [InlineKeyboardButton("üü¶ FernieX Block's", callback_data="block_blast_stats")],
            [InlineKeyboardButton("üíª CodeQuote", callback_data="cq_stats_all")],
            [InlineKeyboardButton("‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data="profile_other")]
        ])
    elif mode == "shops":
        return InlineKeyboardMarkup([
            [InlineKeyboardButton("üõí –û–±—ã—á–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã", callback_data="magaz")],
            [InlineKeyboardButton("üè¢ –ü–æ–∫—É–ø–∫–∞ –ë–∏–∑–Ω–µ—Å–∞", callback_data="biz_magaz")],
            [InlineKeyboardButton("‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data="profile_other")]
        ])
    return InlineKeyboardMarkup([])

async def show_profile(update_or_query, context, edit: bool = False):
    user = update_or_query.effective_user
    user_id = str(user.id)
    first_name = user.first_name or "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"
    username = user.username or first_name
    chat = update_or_query.effective_chat

    if not get_user_from_db_stats(user_id):
        create_user_in_db(user_id, username)

    user_data = get_user_from_db_stats(user_id)
    if not user_data:
        await chat.send_message("‚ùó –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω.")
        return

    # --- Fernie+ ---
    has_sub = False
    sub_until_str = "‚Äî"
    fernie_style = "–§–æ—Ç–æ"

    with sqlite3.connect(DB_PATH) as conn:
        cur = conn.cursor()
        cur.execute("SELECT end_time, FernieStyle FROM SubFerniePlus WHERE user_id = ?", (user_id,))
        row = cur.fetchone()
        if row:
            end_time, style = row
            if end_time and int(end_time) > int(time.time()):
                has_sub = True
                sub_until_str = time.strftime("%d.%m.%Y %H:%M", time.localtime(end_time))
                fernie_style = style or "–§–æ—Ç–æ"

    # --- –î–∞–Ω–Ω—ã–µ ---
    exp = int(user_data.get("exp", 0))
    user_level = get_level(exp)
    balance_str = f"{(user_data.get('balance') or 0):,}".replace(",", ".")
    seeds_str = f"{(user_data.get('seeds') or 0):,}".replace(",", ".")
    vip_status = int(user_data.get("vip_status", 0))
    vip_names = {0: "–ù–µ—Ç", 1: "Silver ü•à", 2: "Gold ü•á", 3: "Platinum üíé", 4: "Legend üëë"}

    ratings = load_ratings()
    rating = int(ratings.get("users", {}).get(user_id, {}).get("rating", 0))

    status_index = int(user_data.get("status", 0))
    status_name = STATUS_LIST[status_index] if 0 <= status_index < len(STATUS_LIST) else "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"

    admin_status = "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"
    if chat.type in ("group", "supergroup"):
        admins = get_chat_admins_list(chat.id)
        for uid, _, lvl in admins:
            if str(uid) == user_id and 0 <= lvl < len(CHAT_ADMINS_ROLE_LIST):
                admin_status = CHAT_ADMINS_ROLE_LIST[lvl]
                break

    fernie_status = "‚úÖ" if has_sub else "‚ùå"

    vip_end_time = user_data.get("vip_end_time")
    vip_display = vip_names.get(vip_status, "–ù–µ—Ç") if (vip_end_time and int(vip_end_time) > int(time.time())) else "–ù–µ—Ç"

    quotes = [
        "–ë–∞–ª–∞–Ω—Å ‚Äî —ç—Ç–æ –Ω–µ –ø—Ä–æ—Å—Ç–æ —á–∏—Å–ª–æ, —ç—Ç–æ –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å —Ç–≤–æ–µ–π —Å–≤–æ–±–æ–¥—ã.",
        "–ö—Ç–æ —É–ø—Ä–∞–≤–ª—è–µ—Ç —Å–≤–æ–∏–º–∏ —Ñ–∏–Ω–∞–Ω—Å–∞–º–∏, —Ç–æ—Ç —É–ø—Ä–∞–≤–ª—è–µ—Ç —Å–≤–æ–µ–π –∂–∏–∑–Ω—å—é.",
        "–§–∏–Ω–∞–Ω—Å—ã ‚Äî —ç—Ç–æ —è–∑—ã–∫, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–º –≥–æ–≤–æ—Ä–∏—Ç —É—Å–ø–µ—Ö.",
        "–ù–∞–∫–æ–ø–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ ‚Äî –ø–µ—Ä–≤—ã–π —à–∞–≥ –∫ –±–æ–ª—å—à–∏–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è–º.",

        "–ö–∞–∂–¥–∞—è —Å—ç–∫–æ–Ω–æ–º–ª–µ–Ω–Ω–∞—è –º–æ–Ω–µ—Ç–∞ ‚Äî —à–∞–≥ –∫ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏.",
        "–î–µ–Ω—å–≥–∏ –ª—é–±—è—Ç –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—É –∏ —è—Å–Ω—ã–µ —Ü–µ–ª–∏.",
        "–ö–æ–Ω—Ç—Ä–æ–ª—å –±—é–¥–∂–µ—Ç–∞ —Å–µ–≥–æ–¥–Ω—è ‚Äî —Å–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ –∑–∞–≤—Ç—Ä–∞.",
        "–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏ –≤ —Å–µ–±—è ‚Äî —Å–∞–º—ã–µ –ø—Ä–∏–±—ã–ª—å–Ω—ã–µ.",
        "–§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –≥—Ä–∞–º–æ—Ç–Ω–æ—Å—Ç—å ‚Äî —Ç–≤–æ–π —Å–∫—Ä—ã—Ç—ã–π –∞–∫—Ç–∏–≤.",
        "–ë–æ–ª—å—à–∏–µ –∫–∞–ø–∏—Ç–∞–ª—ã –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è —Å –º–∞–ª–µ–Ω—å–∫–∏—Ö —Ä–µ—à–µ–Ω–∏–π.",
        "–î–æ—Ö–æ–¥ —Ä–∞—Å—Ç—ë—Ç —Ç–∞–º, –≥–¥–µ –µ—Å—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏—è.",
        "–ù–µ –¥–æ—Ö–æ–¥ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –±–æ–≥–∞—Ç—Å—Ç–≤–æ, –∞ —É–º–µ–Ω–∏–µ –∏–º —Ä–∞—Å–ø–æ—Ä—è–∂–∞—Ç—å—Å—è.",
        "–¢–≤–æ–∏ —Ñ–∏–Ω–∞–Ω—Å—ã ‚Äî –æ—Ç—Ä–∞–∂–µ–Ω–∏–µ —Ç–≤–æ–∏—Ö –ø—Ä–∏–≤—ã—á–µ–∫.",
        "–°–æ–∑–¥–∞–≤–∞–π –∞–∫—Ç–∏–≤—ã, –∞ –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞.",
        "–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç –º–µ—á—Ç—ã –≤ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Ü–µ–ª–∏.",
        "–°–≤–æ–±–æ–¥–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π –ø–æ–¥—É—à–∫–∏.",
        "–î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞ –≤ —Ç—Ä–∞—Ç–∞—Ö ‚Äî —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç –∫–∞–ø–∏—Ç–∞–ª–∞.",
        "–î–µ–Ω—å–≥–∏ ‚Äî –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç, –∞ –Ω–µ —Ü–µ–ª—å.",
        "–£–º–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è —Å–µ–≥–æ–¥–Ω—è ‚Äî –ø–∞—Å—Å–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥ –∑–∞–≤—Ç—Ä–∞.",
        "–§–∏–Ω–∞–Ω—Å–æ–≤–∞—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å ‚Äî —ç—Ç–æ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –≤ –∫–∞–∂–¥–æ–º –¥–Ω–µ.",
        "–ö–∞–∂–¥—ã–π —Ä—É–±–ª—å –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–∞ —Ç–µ–±—è.",
        "–°—Ç—Ä–∞—Ç–µ–≥–∏—è –≤–∞–∂–Ω–µ–µ —Å–ª—É—á–∞–π–Ω–æ–π —É–¥–∞—á–∏.",
        "–ù–∞—Å—Ç–æ—è—â–µ–µ –±–æ–≥–∞—Ç—Å—Ç–≤–æ ‚Äî —ç—Ç–æ –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ —Å–≤–æ–∏–º–∏ —Ä–µ—Å—É—Ä—Å–∞–º–∏.",
        "–ù–µ —Ç—Ä–∞—Ç—å –≤—Ä–µ–º—è ‚Äî –∏–Ω–≤–µ—Å—Ç–∏—Ä—É–π –µ–≥–æ.",
        "–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Ä–æ—Å—Ç –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å —á–µ—Å—Ç–Ω–æ—Å—Ç–∏ –ø–µ—Ä–µ–¥ —Å–æ–±–æ–π."
    ]

    display_name = get_display_name_html_new(user)

    # --- –ì–ª–∞–≤–Ω—ã–π —Ç–µ–∫—Å—Ç (–∫—Ä–∞—Ç–∫–∏–π) ---
    text = (
        f"üéÆ <b>–ü—Ä–æ—Ñ–∏–ª—å</b> üéÆ\n"
        f"{display_name}\n"
        f"<blockquote>üîπ ID: <code>{user_id}</code>\n"
        f"üîπ –Æ–∑–µ—Ä: @{username}</blockquote>\n"
        f"üìä <b>–°—Ç–∞—Ç—É—Å—ã</b>\n"
        f"<blockquote>üëÆ –†–æ–ª—å: {admin_status}\n"
        f"üßæ –°—Ç–∞—Ç—É—Å: {status_name}</blockquote>\n"
        f"üí∞ <b>–§–∏–Ω–∞–Ω—Å—ã</b>\n"
        f"<blockquote>üíµ –ë–∞–ª–∞–Ω—Å: <b>{balance_str}‚ÇΩ</b>\n"
        f"üå± –°–µ–º–µ–Ω–∞: <b>{seeds_str}</b></blockquote>\n"
        f"<blockquote><i>¬´{random.choice(quotes)}¬ª</i></blockquote>"
    )

    buttons = profile_button_menu("main")

    if update_or_query.callback_query:
        await update_or_query.callback_query.answer()

    if edit and update_or_query.callback_query:
        try:
            await update_or_query.callback_query.edit_message_caption(
                caption=text, parse_mode="HTML", reply_markup=buttons
            )
        except Exception:
            try:
                await update_or_query.callback_query.edit_message_text(
                    text=text, parse_mode="HTML", reply_markup=buttons
                )
            except Exception as e:
                print("–û—à–∏–±–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è (back):", e)
        return

    # --- –û—Ç–ø—Ä–∞–≤–∫–∞ ---
    if has_sub and fernie_style != "–¢–µ–∫—Å—Ç":
        media_path = None
        media_type = "photo"

        with sqlite3.connect(DB_PATH) as conn:
            cur = conn.cursor()
            cur.execute("SELECT media_type, media_path FROM fernieplus_custom WHERE user_id = ?", (user_id,))
            row = cur.fetchone()

        if row and row[1]:
            filename = os.path.basename(row[1])
            ext = os.path.splitext(filename)[1].lower()
            if ext == ".gif":
                media_path = os.path.join(BASE_DIR, "fons", "gif", filename)
                media_type = "animation"
            else:
                media_path = os.path.join(BASE_DIR, "fons", "png", filename)

        if not media_path or not os.path.exists(media_path):
            media_path = os.path.join(BASE_DIR, "fons", "png", "profile_def.png")
            media_type = "photo"

        try:
            if media_type == "animation":
                with open(media_path, "rb") as media:
                    await chat.send_animation(animation=media, caption=text, parse_mode="HTML", reply_markup=buttons)
            else:
                with open(media_path, "rb") as media:
                    await chat.send_photo(photo=media, caption=text, parse_mode="HTML", reply_markup=buttons)
        except Exception as e:
            print("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –º–µ–¥–∏–∞:", e)
            await chat.send_message(text=text, parse_mode="HTML", reply_markup=buttons)
    else:
        await chat.send_message(text=text, parse_mode="HTML", reply_markup=buttons)

async def get_user_ratings_text(user_id: str, chat_id: Optional[int] = None) -> str:
    """–ü–æ—Å—á–∏—Ç–∞—Ç—å –ø–æ–∑–∏—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤–æ –≤—Å–µ—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏—è—Ö —Ä–µ–π—Ç–∏–Ω–≥–∞"""
    lines = []

    # –ë–∞–ª–∞–Ω—Å
    with sqlite3.connect(DB_PATH) as conn:
        cur = conn.cursor()
        cur.execute("SELECT balance FROM users WHERE user_id = ?", (user_id,))
        row = cur.fetchone()
        if row and row[0]:
            cur.execute("SELECT COUNT(*) + 1 FROM users WHERE CAST(balance AS INTEGER) > CAST(? AS INTEGER)", (row[0],))
            pos = cur.fetchone()[0]
            lines.append(f"üíµ –ë–∞–ª–∞–Ω—Å: <b>#{pos}</b>")

    # –£—Ä–æ–≤–µ–Ω—å
    with sqlite3.connect(DB_PATH) as conn:
        cur = conn.cursor()
        cur.execute("SELECT exp FROM users WHERE user_id = ?", (user_id,))
        row = cur.fetchone()
        if row and row[0]:
            user_level = (int(row[0]) // 100) + 1
            cur.execute("SELECT COUNT(*) + 1 FROM users WHERE (CAST(exp AS INTEGER) / 100 + 1) > ?", (user_level,))
            pos = cur.fetchone()[0]
            lines.append(f"üìà –£—Ä–æ–≤–µ–Ω—å: <b>#{pos}</b>")

    # DigitalCoins
    with sqlite3.connect(DB_PATH) as conn:
        cur = conn.cursor()
        cur.execute("SELECT dc_balance FROM users WHERE user_id = ?", (user_id,))
        row = cur.fetchone()
        if row and row[0] and int(row[0]) > 0:
            cur.execute("SELECT COUNT(*) + 1 FROM users WHERE CAST(dc_balance AS INTEGER) > CAST(? AS INTEGER)", (row[0],))
            pos = cur.fetchone()[0]
            lines.append(f"üí∞ DigitalCoins: <b>#{pos}</b>")

    # –ë–ª–∞–≥–æ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
    with sqlite3.connect(DB_PATH) as conn:
        cur = conn.cursor()
        cur.execute("SELECT SUM(CAST(donation_amount AS REAL)) FROM charity WHERE user_id = ?", (user_id,))
        row = cur.fetchone()
        if row and row[0]:
            user_total = row[0]
            cur.execute("""
                SELECT COUNT(*) + 1 FROM (
                    SELECT user_id, SUM(CAST(donation_amount AS REAL)) as total
                    FROM charity GROUP BY user_id HAVING total > ?
                )
            """, (user_total,))
            pos = cur.fetchone()[0]
            lines.append(f"üíñ –ë–ª–∞–≥–æ—Ç–≤–æ—Ä–∏—Ç–µ–ª–∏: <b>#{pos}</b>")

    # –°–æ–æ–±—â–µ–Ω–∏—è ‚Äî –≥–ª–æ–±–∞–ª—å–Ω—ã–µ
    if os.path.exists(SMS_FILE_GLOBAL):
        with open(SMS_FILE_GLOBAL, "r", encoding="utf-8") as f:
            sms_global = json.load(f)
        if user_id in sms_global:
            user_msgs = sms_global[user_id].get("messages", 0)
            pos = sum(1 for v in sms_global.values() if v.get("messages", 0) > user_msgs) + 1
            lines.append(f"üí¨ –°–æ–æ–±—â–µ–Ω–∏—è (–≥–ª–æ–±–∞–ª): <b>#{pos}</b>")

    # –°–æ–æ–±—â–µ–Ω–∏—è ‚Äî –ª–æ–∫–∞–ª—å–Ω—ã–µ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤—ã–∑–≤–∞–Ω–æ –∏–∑ –≥—Ä—É–ø–ø—ã)
    if chat_id and os.path.exists(SMS_FILE_CHATS):
        with open(SMS_FILE_CHATS, "r", encoding="utf-8") as f:
            sms_chats = json.load(f)
        chat_data = sms_chats.get(str(chat_id), {})
        if user_id in chat_data:
            user_msgs_local = chat_data[user_id].get("messages", 0)
            pos_local = sum(1 for v in chat_data.values() if v.get("messages", 0) > user_msgs_local) + 1
            lines.append(f"üí¨ –°–æ–æ–±—â–µ–Ω–∏—è (—á–∞—Ç): <b>#{pos_local}</b>")

    return "\n".join(lines) if lines else "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö"

async def profile_stats_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    user = query.from_user
    user_id = str(user.id)
    await query.answer()

    user_data = get_user_from_db_stats(user_id)
    if not user_data:
        await query.answer("‚ùó –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω.", show_alert=True)
        return

    username = user.username or user.first_name or "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"

    # --- Fernie+ ---
    has_sub = False
    sub_until_str = None
    fernie_status = "‚ùå"

    with sqlite3.connect(DB_PATH) as conn:
        cur = conn.cursor()
        cur.execute("SELECT end_time FROM SubFerniePlus WHERE user_id = ?", (user_id,))
        row = cur.fetchone()
        if row and row[0] and int(row[0]) > int(time.time()):
            has_sub = True
            sub_until_str = time.strftime("%d.%m.%Y %H:%M", time.localtime(row[0]))
            fernie_status = "‚úÖ"

    # --- VIP (–±–µ—Ä—ë–º –∏–∑ get_uservip_data, –∫–∞–∫ –≤ myvip_command) ---
    vip_data = get_uservip_data(user_id)
    vip_id = vip_data.get("vip_status", 0)
    vip_until_ts = vip_data.get("vip_until", 0)
    now_ts = int(time.time())

    if vip_until_ts > now_ts and vip_id > 0:
        vip_display = VIP_STATUS_MAP.get(vip_id, "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ")
    else:
        vip_display = "–ù–µ—Ç"

    exp = int(user_data.get("exp", 0))
    user_level = get_level(exp)
    balance_str = f"{(user_data.get('balance') or 0):,}".replace(",", ".")
    seeds_str = f"{(user_data.get('seeds') or 0):,}".replace(",", ".")

    ratings = load_ratings()
    rating = int(ratings.get("users", {}).get(user_id, {}).get("rating", 0))

    chat_id = update.effective_chat.id if update.effective_chat else None
    ratings_text = await get_user_ratings_text(user_id, chat_id=chat_id)
    display_name = get_display_name_html_new(user)

    info_block = (
        f"üîπ ID: <code>{user_id}</code>\n"
        f"üîπ –Æ–∑–µ—Ä: @{username}\n"
    )
    if has_sub and sub_until_str:
        info_block += f"‚è∞ –ê–∫—Ç–∏–≤–Ω–∞: {sub_until_str}\n"
    info_block += (
        f"üìà –£—Ä–æ–≤–µ–Ω—å: Lv.<b>{user_level}</b>\n"
        f"‚ö° –û–ø—ã—Ç: <code>{exp:,}</code> EXP\n"
        f"üèÜ –°–æ—Ü. –†–µ–π—Ç–∏–Ω–≥: <b>#{rating}</b>"
    )

    text = (
        f"{display_name} | <b>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞–∫–∫–∞—É–Ω—Ç–∞</b>\n\n"
        f"üéØ <b>–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</b>\n"
        f"<blockquote>{info_block}</blockquote>\n"
        f"üîî <b>–ü–æ–¥–ø–∏—Å–∫–∏:</b>\n"
        f"<blockquote>‚≠ê Fernie+: {fernie_status}\n"
        f"üíé VIP: {vip_display}</blockquote>\n"
        f"üí∞ <b>–§–∏–Ω–∞–Ω—Å—ã:</b>\n"
        f"<blockquote>üíµ –ë–∞–ª–∞–Ω—Å: <b>{balance_str}‚ÇΩ</b>\n"
        f"üå± –°–µ–º–µ–Ω–∞: <b>{seeds_str}</b></blockquote>\n"
        f"üìä <b>–ú–µ—Å—Ç–∞ –≤ —Ä–µ–π—Ç–∏–Ω–≥–µ:</b>\n"
        f"<blockquote>{ratings_text}</blockquote>"
    )

    try:
        await query.edit_message_caption(
            caption=text,
            parse_mode="HTML",
            reply_markup=profile_button_menu("stats")
        )
    except Exception:
        try:
            await query.edit_message_text(
                text=text,
                parse_mode="HTML",
                reply_markup=profile_button_menu("stats")
            )
        except Exception as e:
            print("–û—à–∏–±–∫–∞ profile_stats_callback:", e)

async def profile_other_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    user = query.from_user
    await query.answer()

    other_text = (
        f"{get_display_name_html_new(user)} | <b>–î–æ–ø–æ–ª–Ω–µ–Ω–∏–µ</b>\n"
        f"<blockquote>–ó–¥–µ—Å—å —Å–æ–±—Ä–∞–Ω—ã –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Ç–≤–æ–µ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è.</blockquote>\n"
        f"<i>üëá –í—ã–±–µ—Ä–∏ –Ω—É–∂–Ω—ã–π —Ä–∞–∑–¥–µ–ª –Ω–∏–∂–µ</i>"
    )

    try:
        # –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –º–µ–¥–∏–∞ ‚Äî —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º caption, —Ñ–æ—Ç–æ –æ—Å—Ç–∞—ë—Ç—Å—è
        await query.edit_message_caption(
            caption=other_text,
            parse_mode="HTML",
            reply_markup=profile_button_menu("other")
        )
    except Exception:
        # –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ ‚Äî —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç
        try:
            await query.edit_message_text(
                text=other_text,
                parse_mode="HTML",
                reply_markup=profile_button_menu("other")
            )
        except Exception as e:
            print("–û—à–∏–±–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è (other):", e)

async def minigames_stats_menu(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    text = (
        "üéÆ <b>FernieX - MiniGames</b>\n\n"
        "<blockquote>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ - –í—ã–±–µ—Ä–µ—Ç–µ –∏–≥—Ä—É, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∫–æ—Ç–æ—Ä–æ–π —Ö–æ—Ç–∏—Ç–µ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å</blockquote>"
    )
    try:
        await query.message.edit_text(text, parse_mode="HTML", reply_markup=profile_button_menu("minigames_stats"))
    except Exception as e:
        if "There is no text in the message" in str(e):
            try:
                await query.message.delete()
            except:
                pass
            await query.message.chat.send_message(text, parse_mode="HTML", reply_markup=profile_button_menu("minigames_stats"))
        else:
            raise

async def shops_menu(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    text = (
        "üè™ <b>–ú–∞–≥–∞–∑–∏–Ω—ã –±–æ—Ç–∞</b>\n"
        "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
        "<blockquote>–í—ã–±–µ—Ä–∏—Ç–µ –º–∞–≥–∞–∑–∏–Ω –¥–ª—è —Å–æ–≤–µ—Ä—à–µ–Ω–∏—è –ø–æ–∫—É–ø–æ–∫</blockquote>"
    )
    try:
        await query.message.edit_text(text, parse_mode="HTML", reply_markup=profile_button_menu("shops"))
    except Exception as e:
        if "There is no text in the message" in str(e):
            try:
                await query.message.delete()
            except:
                pass
            await query.message.chat.send_message(text, parse_mode="HTML", reply_markup=profile_button_menu("shops"))
        else:
            raise

async def shops_magaz(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    await shop_command(update, context)

async def shops_biz_magaz(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    items = load_items()
    await send_business_page(query, context, 0, items, query.from_user)

async def profile_back_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await show_profile(update, context, edit=True)

async def handle_dev_soon(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer(text="üöß –†–∞–∑–¥–µ–ª –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ...", show_alert=True)

async def show_inventory_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    user = update.effective_user
    user_id = str(user.id)

    # –ü–æ–ª—É—á–∞–µ–º –Ω–∏–∫ –∏–∑ –ë–î –∏–ª–∏ –∏–º—è
    display_name_html = get_display_name_html_new(user)
    match = re.search(r'>(.*?)</a>', display_name_html)
    markdown_name = escape_md2(match.group(1)) if match else escape_md2(user.first_name or "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å")

    user_data = get_user_from_db_stats(user_id)
    if not user_data:
        if query.message:
            await query.message.delete()
        await update.effective_chat.send_message(
            "‚ùó –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.",
            reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="show_profile")]]),
            parse_mode="MarkdownV2"
        )
        return

    business = get_user_business(user_id)
    business_name = business["business_name"] if business and business.get("business_name") else "–ù–µ—Ç"

    inventory = {
        "car": user_data.get("inventory_car") or "–ù–µ—Ç",
        "phone": user_data.get("inventory_phone") or "–ù–µ—Ç",
        "yacht": user_data.get("inventory_yacht") or "–ù–µ—Ç",
        "business": business_name,
        "home": user_data.get("inventory_home") or "üèö –ë–µ–∑–¥–æ–º–Ω—ã–π",
        "pet": user_data.get("inventory_pet") or "–ù–µ—Ç"
    }

    text = (
        f"üèò *–ò–º—É—â–µ—Å—Ç–≤–æ* ‚Äî [{markdown_name}](tg://user?id={user_id})\n"
        f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
        f"üöò *–ú–∞—à–∏–Ω–∞:* {escape_md2(inventory['car'])}\n"
        f"üì± *–°–º–∞—Ä—Ç—Ñ–æ–Ω:* {escape_md2(inventory['phone'])}\n"
        f"üõ•Ô∏è *–Ø—Ö—Ç–∞:* {escape_md2(inventory['yacht'])}\n"
        f"üè¢ *–ë–∏–∑–Ω–µ—Å:* {escape_md2(inventory['business'])}\n"
        f"üè° *–î–æ–º:* {escape_md2(inventory['home'])}\n"
        f"üê∂ *–ü–∏—Ç–æ–º–µ—Ü:* {escape_md2(inventory['pet'])}"
    )

    buttons = InlineKeyboardMarkup([
        [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="show_profile")]
    ])

    if query.message:
        await query.message.delete()

    await update.effective_chat.send_message(text, reply_markup=buttons, parse_mode="MarkdownV2")

async def show_profile_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    await show_profile(update, context)

ITEMS_PER_PAGE = 5


# ------------------- –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï -------------------

def get_user_balance_for_inventory(user_id):
    """–ü–æ–ª—É—á–∏—Ç—å –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT balance FROM users WHERE user_id = ?", (str(user_id),))
    result = cursor.fetchone()
    conn.close()
    return result[0] if result else 0


def update_user_balance_for_inventory(user_id, amount):
    """–û–±–Ω–æ–≤–∏—Ç—å –±–∞–ª–∞–Ω—Å (–º–æ–∂–Ω–æ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è —Å–ø–∏—Å–∞–Ω–∏—è)"""
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("UPDATE users SET balance = balance + ? WHERE user_id = ?", (amount, str(user_id)))
    conn.commit()
    conn.close()


def add_item_to_inventory(user_id, item_name, quantity=1):
    """–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–µ–¥–º–µ—Ç –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å –∏–ª–∏ —É–≤–µ–ª–∏—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ. –ï—Å–ª–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ <= 0, —É–¥–∞–ª–∏—Ç—å –ø—Ä–µ–¥–º–µ—Ç"""
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT quantity FROM inventory WHERE owner_id = ? AND item_name = ?", (str(user_id), item_name))
    result = cursor.fetchone()
    if result:
        new_quantity = result[0] + quantity
        if new_quantity <= 0:
            # –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥–º–µ—Ç –µ—Å–ª–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ <= 0
            cursor.execute(
                "DELETE FROM inventory WHERE owner_id = ? AND item_name = ?",
                (str(user_id), item_name)
            )
        else:
            cursor.execute(
                "UPDATE inventory SET quantity = ? WHERE owner_id = ? AND item_name = ?",
                (new_quantity, str(user_id), item_name)
            )
    else:
        if quantity > 0:
            cursor.execute(
                "INSERT INTO inventory (owner_id, item_name, quantity) VALUES (?, ?, ?)",
                (str(user_id), item_name, quantity)
            )
    conn.commit()
    conn.close()


def get_store_items():
    return [
        {"name": "–î–µ–∫–æ–¥–µ—Ä", "price": 50000},
        {"name": "–ù–æ–∂–Ω–∏—Ü—ã", "price": 55000},
    ]


# ------------------- –ò–ù–í–ï–ù–¢–ê–†–¨ -------------------

def get_user_inventory(user_id):
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT item_name, quantity FROM inventory WHERE owner_id = ? AND quantity > 0", (str(user_id),))
    items = cursor.fetchall()
    conn.close()
    return items


async def show_inventory(update: Update, context: ContextTypes.DEFAULT_TYPE, page: int = 1):
    user = update.effective_user
    items = get_user_inventory(user.id)
    total_items = len(items)
    total_pages = max(1, (total_items + ITEMS_PER_PAGE - 1) // ITEMS_PER_PAGE)
    page = max(1, min(page, total_pages))

    start = (page - 1) * ITEMS_PER_PAGE
    end = start + ITEMS_PER_PAGE
    items_on_page = items[start:end]

    # –§–æ—Ä–º–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏
    keyboard = [[InlineKeyboardButton(f"üéÅ {name}", callback_data=f"item_{name}")]
                for name, q in items_on_page]

    # –ù–∞–≤–∏–≥–∞—Ü–∏—è
    nav = []
    if page > 1:
        nav.append(InlineKeyboardButton("‚¨Ö", callback_data=f"inv_{page - 1}"))
    nav.append(InlineKeyboardButton(f"{page}/{total_pages}", callback_data="inv_info"))
    if page < total_pages:
        nav.append(InlineKeyboardButton("‚û°", callback_data=f"inv_{page + 1}"))
    if nav:
        keyboard.append(nav)

    markup = InlineKeyboardMarkup(keyboard) if keyboard and total_items > 0 else None

    # –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
    if total_items == 0:
        text = (
            f"üì¶ <b>–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</b> ‚Äî {get_display_name_html_new(user)}\n\n"
            f"üîπ –£ –≤–∞—Å –ø–æ–∫–∞ <b>–Ω–µ—Ç –ø—Ä–µ–¥–º–µ—Ç–æ–≤</b>."
        )
    else:
        text = f"üì¶ <b>–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</b> ‚Äî {get_display_name_html_new(user)}"

    # –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ
    if update.callback_query:
        try:
            await update.callback_query.edit_message_text(
                text=text, reply_markup=markup, parse_mode="HTML"
            )
        except:
            # –ï—Å–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–µ–ª—å–∑—è (—Å–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ), –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ
            await update.callback_query.message.chat.send_message(
                text=text, reply_markup=markup, parse_mode="HTML"
            )
    else:
        await update.message.reply_text(
            text=text, reply_markup=markup, parse_mode="HTML"
        )

async def show_item_detail(update: Update, context: ContextTypes.DEFAULT_TYPE, item_name: str):
    user = update.effective_user

    # –ü–æ–ª—É—á–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–µ–¥–º–µ—Ç–æ–≤
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute(
        "SELECT quantity FROM inventory WHERE owner_id = ? AND item_name = ?",
        (str(user.id), item_name)
    )
    result = cursor.fetchone()
    conn.close()
    quantity = result[0] if result else 0

    # –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    keyboard = [[InlineKeyboardButton("‚¨Ö –ù–∞–∑–∞–¥", callback_data="inv_1")]]
    markup = InlineKeyboardMarkup(keyboard)

    # –¢–µ–∫—Å—Ç–æ–≤–æ–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ
    text = (
        f"üì¶ <b>–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</b> ‚Äî {get_display_name_html_new(user)}\n\n"
        f"üéÅ <b>–ü—Ä–µ–¥–º–µ—Ç:</b> {item_name}\n"
        f"üî¢ <b>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</b> {quantity}\n\n"
        f"‚Ñπ –ù–∞–∂–º–∏—Ç–µ ¬´–ù–∞–∑–∞–¥¬ª, —á—Ç–æ–±—ã –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å–ø–∏—Å–∫—É."
    )

    # –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
    await update.callback_query.edit_message_text(
        text=text, reply_markup=markup, parse_mode="HTML"
    )

# ------------------- –ú–ê–ì–ê–ó–ò–ù -------------------
async def show_store(update: Update, context: ContextTypes.DEFAULT_TYPE, page: int = 1):
    user = update.effective_user
    store_items = get_store_items()
    total_items = len(store_items)
    total_pages = max(1, (total_items + ITEMS_PER_PAGE - 1) // ITEMS_PER_PAGE)
    page = max(1, min(page, total_pages))

    start = (page - 1) * ITEMS_PER_PAGE
    end = start + ITEMS_PER_PAGE
    items_on_page = store_items[start:end]

    # –§–æ—Ä–º–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏ —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º –∏ —Ü–µ–Ω–æ–π
    keyboard = [
        [InlineKeyboardButton(f"üéÅ {item['name']} ‚Äî {item['price']} üí∞", callback_data=f"store_item_{item['name']}")]
        for item in items_on_page
    ]

    # –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º
    nav = []
    if page > 1:
        nav.append(InlineKeyboardButton("‚¨Ö", callback_data=f"store_{page - 1}"))
    nav.append(InlineKeyboardButton(f"{page}/{total_pages}", callback_data="store_info"))
    if page < total_pages:
        nav.append(InlineKeyboardButton("‚û°", callback_data=f"store_{page + 1}"))
    if nav:
        keyboard.append(nav)

    # –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥" –≤ –º–µ–Ω—é —Ç–µ–ª–µ—Ñ–æ–Ω–∞
    keyboard.append([InlineKeyboardButton("‚¨Ö –ù–∞–∑–∞–¥", callback_data="phone_menu")])

    markup = InlineKeyboardMarkup(keyboard)

    # –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
    text = (
        f"üè¨ <b>–ú–∞–≥–∞–∑–∏–Ω –ø—Ä–µ–¥–º–µ—Ç–æ–≤</b>\n\n"
        f"üìÑ –°—Ç—Ä–∞–Ω–∏—Ü–∞: <b>{page}/{total_pages}</b> | –¢–æ–≤–∞—Ä–æ–≤: <b>{total_items}</b>\n"
        f"üí∞ –ù–∞–∂–º–∏—Ç–µ –Ω–∞ —Ç–æ–≤–∞—Ä, —á—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –∏ –∫—É–ø–∏—Ç—å."
    )

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
    if update.callback_query:
        await update.callback_query.edit_message_text(text=text, reply_markup=markup, parse_mode="HTML")
    else:
        await update.message.reply_text(text=text, reply_markup=markup, parse_mode="HTML")


async def show_store_item(update: Update, context: ContextTypes.DEFAULT_TYPE, item_name: str):
    store_items = get_store_items()
    item = next((x for x in store_items if x["name"] == item_name), None)
    if not item:
        await update.callback_query.answer("‚ùå –¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω!", show_alert=True)
        return

    # –ö–Ω–æ–ø–∫–∏
    keyboard = [
        [InlineKeyboardButton("üí∞ –ö—É–ø–∏—Ç—å", callback_data=f"store_buy_{item_name}")],
        [InlineKeyboardButton("‚¨Ö –ù–∞–∑–∞–¥", callback_data="store_1")]
    ]
    markup = InlineKeyboardMarkup(keyboard)

    # –¢–µ–∫—Å—Ç —Å –∫—Ä–∞—Å–∏–≤—ã–º –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ–º
    text = (
        f"üè¨ <b>–ú–∞–≥–∞–∑–∏–Ω —Ç–æ–≤–∞—Ä–æ–≤</b>\n\n"
        f"üéÅ <b>–¢–æ–≤–∞—Ä:</b> {item['name']}\n"
        f"üí∞ <b>–¶–µ–Ω–∞ –∑–∞ 1 —à—Ç:</b> {item['price']}‚ÇΩ\n\n"
        f"‚Ñπ –ù–∞–∂–º–∏—Ç–µ ¬´–ö—É–ø–∏—Ç—å¬ª, —á—Ç–æ–±—ã –ø—Ä–∏–æ–±—Ä–µ—Å—Ç–∏ —Ç–æ–≤–∞—Ä."
    )

    await update.callback_query.edit_message_text(
        text=text, reply_markup=markup, parse_mode="HTML"
    )

async def buy_item(update: Update, context: ContextTypes.DEFAULT_TYPE, item_name: str):
    """–ü–æ–∫—É–ø–∫–∞ –ø—Ä–µ–¥–º–µ—Ç–∞ –∏–∑ –º–∞–≥–∞–∑–∏–Ω–∞"""
    user = update.effective_user
    user_id = str(user.id)
    query = update.callback_query

    # –ù–∞—Ö–æ–¥–∏–º —Ç–æ–≤–∞—Ä
    store_items = get_store_items()
    item = next((x for x in store_items if x["name"] == item_name), None)
    if not item:
        await query.answer("‚ùå –¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω!", show_alert=True)
        return

    price = item["price"]
    balance = get_user_balance(user_id)

    # –ï—Å–ª–∏ –±–∞–ª–∞–Ω—Å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –∫–∞–∫ dict ‚Äî –∏–∑–≤–ª–µ–∫–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ
    if isinstance(balance, dict):
        balance = balance.get("balance", 0)

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –¥–µ–Ω–µ–≥
    if balance < price:
        await query.answer("‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤!", show_alert=True)
        return

    # –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –ø—Ä–µ–¥–º–µ—Ç–æ–≤
    limited_items = {
        "–î–µ–∫–æ–¥–µ—Ä": 10,
        "–ù–æ–∂–Ω–∏—Ü—ã": 15,
    }

    if item_name in limited_items:
        max_qty = limited_items[item_name]
        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()
        cursor.execute(
            "SELECT quantity FROM inventory WHERE owner_id = ? AND item_name = ?",
            (user_id, item_name)
        )
        result = cursor.fetchone()
        conn.close()
        current_quantity = result[0] if result else 0
        if current_quantity >= max_qty:
            await query.answer(f"‚ùå –í—ã –Ω–µ –º–æ–∂–µ—Ç–µ –∏–º–µ—Ç—å –±–æ–ª—å—à–µ {max_qty} —à—Ç. ¬´{item_name}¬ª!", show_alert=True)
            return

    # –°–ø–∏—Å–∞–Ω–∏–µ –¥–µ–Ω–µ–≥ –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞
    update_user_balance(user_id, -price)
    add_item_to_inventory(user_id, item_name, 1)
    new_balance = get_user_balance(user_id)

    if isinstance(new_balance, dict):
        new_balance = new_balance.get("balance", 0)

    # –ö—Ä–∞—Å–∏–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –ø–æ–∫—É–ø–∫–µ
    message = (
        f"‚úÖ –ü–æ–∫—É–ø–∫–∞ —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞!\n\n"
        f"üéÅ –¢–æ–≤–∞—Ä: {item_name}\n"
        f"üí∞ –¶–µ–Ω–∞: {price} –º–æ–Ω–µ—Ç\n"
        f"üíµ –ë–∞–ª–∞–Ω—Å: {new_balance} –º–æ–Ω–µ—Ç"
    )

    await query.answer(message, show_alert=True)

# ------------------- –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò -------------------

async def inventory_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await show_inventory(update, context, page=1)


async def store_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    phone_name = await get_user_phone(user_id)

    if phone_name in (None, "", "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω"):
        await update.message.reply_text("‚ùå –£ –≤–∞—Å –Ω–µ—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∞.")
        return

    await show_store(update, context, page=1)


# --- —Ñ—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–ª–±—ç–∫–æ–≤ ---
async def callback_handler_market_store(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    data = query.data

    if data.startswith("inv_"):
        if data == "inv_info":
            await query.answer()
            return
        page = int(data.split("_")[1])
        await show_inventory(update, context, page=page)

    elif data.startswith("item_"):
        item_name = data.replace("item_", "", 1)
        await show_item_detail(update, context, item_name=item_name)

    elif data.startswith("store_item_"):
        item_name = data.replace("store_item_", "", 1)
        await show_store_item(update, context, item_name=item_name)

    elif data.startswith("store_buy_"):
        item_name = data.replace("store_buy_", "", 1)
        await buy_item(update, context, item_name=item_name)

    elif data.startswith("store_"):
        if data == "store_info":
            await query.answer()
            return
        page = int(data.split("_")[1])
        await show_store(update, context, page=page)

    await query.answer()


def get_role_name(status: int) -> str:
    if 0 <= status < len(STATUS_LIST):
        return STATUS_LIST[status]
    return f"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è —Ä–æ–ª—å ({status})"


def get_role_keyboard_for_target(target_user_id: str):
    keyboard = [
        [InlineKeyboardButton("üõ†Ô∏è 13 | –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫", callback_data=f"setrole_{target_user_id}_13"),
         InlineKeyboardButton("‚≠ê 12 | –°–ø–µ—Ü. –ê–¥–º–∏–Ω", callback_data=f"setrole_{target_user_id}_12")],
        [InlineKeyboardButton("üëë 11 | –í–ª–∞–¥–µ–ª–µ—Ü", callback_data=f"setrole_{target_user_id}_11"),
         InlineKeyboardButton("üéì 10 | –ö—É—Ä–∞—Ç–æ—Ä", callback_data=f"setrole_{target_user_id}_10")],
        [InlineKeyboardButton("‚öôÔ∏è 9 | –¢–µ—Ö. –°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç", callback_data=f"setrole_{target_user_id}_9"),
         InlineKeyboardButton("üíº 8 | –°—Ç. –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä", callback_data=f"setrole_{target_user_id}_8")],
        [InlineKeyboardButton("üîß 7 | –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä", callback_data=f"setrole_{target_user_id}_7"),
         InlineKeyboardButton("üî® 6 | –ú–ª. –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä", callback_data=f"setrole_{target_user_id}_6")],
        [InlineKeyboardButton("üõ°Ô∏è 5 | –°—Ç. –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä", callback_data=f"setrole_{target_user_id}_5"),
         InlineKeyboardButton("üõ° 4 | –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä", callback_data=f"setrole_{target_user_id}_4")],
        [InlineKeyboardButton("üõ°Ô∏è 3 | –ú–ª. –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä", callback_data=f"setrole_{target_user_id}_3"),
         InlineKeyboardButton("üß™ 2 | –¢–µ—Å—Ç–∏—Ä–æ–≤—â–∏–∫", callback_data=f"setrole_{target_user_id}_2")],
        [InlineKeyboardButton("üõ°Ô∏è 1 | Media", callback_data=f"setrole_{target_user_id}_1"),
         InlineKeyboardButton("üë§ 0 | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å", callback_data=f"setrole_{target_user_id}_0")],
    ]
    return InlineKeyboardMarkup(keyboard)


def check_access(user_id: str, target_status: int) -> bool:
    # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å –ø–æ–ª–Ω—ã–º –¥–æ—Å—Ç—É–ø–æ–º –ø–æ user_id
    if user_id in OWNER_IDS or user_id in DEV_IDS or user_id in TEH_IDS or user_id in CURATOR_IDS or user_id in SPECADM_IDS:
        return True

    user_status = get_user_status(user_id)

    # –ú–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å —Ä–æ–ª–∏ –Ω–∏–∂–µ –∏–ª–∏ —Ä–∞–≤–Ω—ã–µ —Å–≤–æ–µ–π, –µ—Å–ª–∏ —Å—Ç–∞—Ç—É—Å >= 9
    if user_status >= 10 and target_status <= user_status:
        return True

    return False


def set_user_status(user_id: str, username: str, status: int):
    print(f"DEBUG: set_user_status called with user_id={user_id}, username={username}, status={status}")
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("""
        INSERT INTO users(user_id, username, status) VALUES (?, ?, ?)
        ON CONFLICT(user_id) DO UPDATE SET username=excluded.username, status=excluded.status
    """, (user_id, username, status))
    conn.commit()
    conn.close()

async def role_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = str(update.effective_user.id)
    user_status = get_user_status(user_id)

    if user_status < 9:
        await update.message.reply_text(
            "‚õî –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç—É –∫–æ–º–∞–Ω–¥—É. –¢–æ–ª—å–∫–æ –ö—É—Ä–∞—Ç–æ—Ä –∏ –≤—ã—à–µ."
        )
        return

    if update.message.reply_to_message:
        target_user = update.message.reply_to_message.from_user
    else:
        args = context.args
        if not args or not args[0].isdigit():
            await update.message.reply_text(
                "‚ùóÔ∏è‚ùå *–ù–µ–≤–µ—Ä–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã!*\n\n"
                "`—Ä–æ–ª—å 123456789` ‚Äî —Å ID\n"
                "–∏–ª–∏ –≤—ã–∑–æ–≤–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É *–≤ –æ—Ç–≤–µ—Ç* –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.",
                parse_mode=ParseMode.MARKDOWN
            )
            return
        target_user_id = args[0]

        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()
        cursor.execute("SELECT username, nickname, first_name FROM users WHERE user_id = ?", (target_user_id,))
        row = cursor.fetchone()
        conn.close()

        class FakeUser:
            def __init__(self, id, username, nickname, first_name):
                self.id = id
                self.username = username
                self.first_name = first_name
                self.nickname = nickname

        if row:
            target_user = FakeUser(target_user_id, row[0], row[1], row[2])
        else:
            target_user = FakeUser(target_user_id, "–ë–µ–∑ username", None, None)

    target_user_id = str(target_user.id)
    current_target_status = get_user_status(target_user_id)

    if current_target_status >= user_status:
        await update.message.reply_text(
            "‚ùå –í—ã –Ω–µ –º–æ–∂–µ—Ç–µ –º–µ–Ω—è—Ç—å —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —Ä–∞–≤–Ω—ã–º –∏–ª–∏ –±–æ–ª–µ–µ –≤—ã—Å–æ–∫–∏–º —Å—Ç–∞—Ç—É—Å–æ–º."
        )
        return

    display_name = get_display_name_html_new(target_user)

    await update.message.reply_text(
        f"üîî *–í—ã–±–æ—Ä –Ω–æ–≤–æ–π —Ä–æ–ª–∏*\n\n"
        f"üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {display_name}\n"
        f"üõ° –¢–µ–∫—É—â–∞—è —Ä–æ–ª—å: {get_role_name(current_target_status)}\n\n"
        f"üëá *–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É —Å –Ω—É–∂–Ω–æ–π —Ä–æ–ª—å—é –Ω–∏–∂–µ:*",
        reply_markup=get_role_keyboard_for_target(target_user_id),
        parse_mode=ParseMode.HTML
    )

async def role_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    user_id = str(query.from_user.id)
    user_status = get_user_status(user_id)

    if user_status < 9:
        await query.edit_message_text("‚õî –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –º–µ–Ω—è—Ç—å —Ä–æ–ª–∏. –¢–æ–ª—å–∫–æ –ö—É—Ä–∞—Ç–æ—Ä –∏ –≤—ã—à–µ.")
        return

    try:
        parts = query.data.split("_")
        if parts[0] != "setrole":
            await query.edit_message_text("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π callback_data.")
            return

        _, target_user_id, status_str = parts
        new_status = int(status_str)
        current_status = get_user_status(target_user_id)

        if current_status >= user_status:
            await query.answer("‚ùå –í—ã –Ω–µ –º–æ–∂–µ—Ç–µ –º–µ–Ω—è—Ç—å —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —Ä–∞–≤–Ω—ã–º –∏–ª–∏ –±–æ–ª–µ–µ –≤—ã—Å–æ–∫–∏–º —Å—Ç–∞—Ç—É—Å–æ–º.", show_alert=True)
            return

        if not check_access(user_id, new_status):
            await query.answer("‚ùå –í—ã –Ω–µ –º–æ–∂–µ—Ç–µ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ä–æ–ª—å –≤—ã—à–µ —Å–≤–æ–µ–π.", show_alert=True)
            return

        if current_status == new_status:
            await query.edit_message_text(
                f"‚ö†Ô∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∏–º–µ–µ—Ç —Ä–æ–ª—å *{get_role_name(new_status)}*.",
                parse_mode=ParseMode.MARKDOWN
            )
            return

        # –ü–æ–ª—É—á–∞–µ–º username/nickname/first_name –¥–ª—è display
        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()
        cursor.execute("SELECT username, nickname, first_name FROM users WHERE user_id = ?", (target_user_id,))
        row = cursor.fetchone()
        conn.close()

        class TargetUserObj:
            def __init__(self, id, username, nickname, first_name):
                self.id = id
                self.username = username
                self.nickname = nickname
                self.first_name = first_name

        target_user_obj = TargetUserObj(target_user_id, *(row or [None, None, None]))

        # –°–º–µ–Ω–∞ —Ä–æ–ª–∏
        set_user_status(target_user_id, target_user_obj.username or "–ë–µ–∑ username", new_status)

        # –õ–æ–≥–∏—Ä—É–µ–º —Å–º–µ–Ω—É —Ä–æ–ª–∏
        action_text = (
            f"üéñ –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–æ–ª–∏\n"
            f"üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {get_display_name_html_new(target_user_obj)} ({target_user_id})\n"
            f"‚≠ê –°—Ç–∞—Ä–∞—è —Ä–æ–ª—å: {get_role_name(current_status)}\n"
            f"‚≠ê –ù–æ–≤–∞—è —Ä–æ–ª—å: {get_role_name(new_status)}"
        )
        write_log(
            log_type="bot_roles",
            admin_id=user_id,
            target_id=target_user_id,
            action=action_text
        )

        # –û—Ç–≤–µ—Ç –≤ —á–∞—Ç–µ
        display_name_html = get_display_name_html_new(target_user_obj)
        await query.edit_message_text(
            f"üéâ *–†–æ–ª—å —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω–∞!*\n\n"
            f"üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {display_name_html}\n"
            f"‚≠ê –ù–æ–≤–∞—è —Ä–æ–ª—å: *{get_role_name(new_status)}*\n"
            f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ",
            parse_mode=ParseMode.HTML
        )

        await query.answer("‚≠ê –í—ã —Å–º–µ–Ω–∏–ª–∏ —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.", show_alert=True)

    except Exception as e:
        await query.edit_message_text(f"‚ùå –û—à–∏–±–∫–∞: {e}")

def init_admin_treasury():
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("""
        CREATE TABLE IF NOT EXISTS admin_treasury (
            id INTEGER PRIMARY KEY CHECK (id = 1),
            balance INTEGER DEFAULT 0,
            last_update DATE DEFAULT (DATE('now'))
        )
    """)
    cursor.execute("INSERT OR IGNORE INTO admin_treasury (id, balance) VALUES (1, 0)")
    conn.commit()
    conn.close()


def get_or_create_casino_user(user_id: str, username: str, first_name: str) -> dict:
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("""
        CREATE TABLE IF NOT EXISTS users (
            user_id TEXT PRIMARY KEY,
            username TEXT,
            first_name TEXT,
            balance INTEGER
        )
    """)
    cursor.execute("SELECT user_id, username, first_name, balance FROM users WHERE user_id = ?", (user_id,))
    row = cursor.fetchone()

    if row is None:
        cursor.execute(
            "INSERT INTO users (user_id, username, first_name, balance) VALUES (?, ?, ?, ?)",
            (user_id, username, first_name, 1000)
        )
        conn.commit()
        user_data = {
            "user_id": user_id,
            "username": username,
            "first_name": first_name,
            "balance": 1000
        }
    else:
        user_data = {
            "user_id": row[0],
            "username": row[1],
            "first_name": row[2],
            "balance": row[3]
        }

    conn.close()
    return user_data


def update_balance(user_id: str, new_balance: int):
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("UPDATE users SET balance = ? WHERE user_id = ?", (new_balance, user_id))
    conn.commit()
    conn.close()


def update_user_casino_balance(user_id: str, new_balance: int):
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("UPDATE users SET balance = ? WHERE user_id = ?", (new_balance, user_id))
    conn.commit()
    conn.close()


def add_to_admin_treasury(amount: int):
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute(
        "UPDATE admin_treasury SET balance = balance + ?, last_update = DATE('now') WHERE id = 1",
        (amount,)
    )
    conn.commit()
    conn.close()


def distribute_loss_to_businesses(loss_amount: int):
    """–†–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç 70% –ø—Ä–æ–∏–≥—Ä—ã—à–∞ –º–µ–∂–¥—É –≤—Å–µ–º–∏ –±–∏–∑–Ω–µ—Å–∞–º–∏ —Ç–∏–ø–∞ –ö–∞–∑–∏–Ω–æ"""
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∫–∞–∑–∏–Ω–æ-–±–∏–∑–Ω–µ—Å—ã
    cursor.execute("SELECT id, balance FROM businesses_XUI WHERE business_type = '–ö–∞–∑–∏–Ω–æ'")
    businesses = cursor.fetchall()

    if not businesses:
        conn.close()
        return

    share = loss_amount // len(businesses)

    for business_id, balance in businesses:
        new_balance = int(balance) + share
        cursor.execute("UPDATE businesses_XUI SET balance = ? WHERE id = ?", (new_balance, business_id))

    conn.commit()
    conn.close()

DC_TO_RUBLES_RATE = 300  # 1 DC = 6000 —Ä—É–±–ª–µ–π
DC_BURN_RATE = 0.18       # 18% –∫–æ–º–∏—Å—Å–∏—è –ø—Ä–∏ –ø–µ—Ä–µ–¥–∞—á–µ DC
CB_SHARE_RATE = 0.60      # 60% –æ—Ç –∫–æ–º–∏—Å—Å–∏–∏ ‚Äî –≤ –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –ë–∞–Ω–∫


def distribute_commission_to_central_banks(commission_dc: int):
    """
    –†–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç 60% –∫–æ–º–∏—Å—Å–∏–∏ (–≤ DC) –º–µ–∂–¥—É –≤—Å–µ–º–∏ –±–∏–∑–Ω–µ—Å–∞–º–∏ '–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –ë–∞–Ω–∫'.
    –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç DC ‚Üí —Ä—É–±–ª–∏ –ø–æ –∫—É—Ä—Å—É DC_TO_RUBLES_RATE –∏ –Ω–∞—á–∏—Å–ª—è–µ—Ç –Ω–∞ –±–∞–ª–∞–Ω—Å –±–∏–∑–Ω–µ—Å–∞.
    """
    rubles_to_distribute = int(commission_dc * CB_SHARE_RATE) * DC_TO_RUBLES_RATE

    conn = sqlite3.connect(DB_PATH, timeout=30.0, check_same_thread=False)
    conn.execute("PRAGMA journal_mode=WAL")
    conn.execute("PRAGMA busy_timeout=10000")
    cursor = conn.cursor()

    try:
        cursor.execute("""
            SELECT business_id, balance
            FROM businesses_XUI
            WHERE business_type = '–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –ë–∞–Ω–∫'
        """)
        businesses = cursor.fetchall()

        if not businesses:
            return

        share = rubles_to_distribute // len(businesses)
        if share <= 0:
            return

        for business_id, balance in businesses:
            new_balance = int(balance) + share
            cursor.execute(
                "UPDATE businesses_XUI SET balance = ? WHERE business_id = ?",
                (new_balance, business_id)
            )

        conn.commit()
    except Exception as e:
        conn.rollback()
        raise e
    finally:
        conn.close()

def parse_bet_input(raw_bet: str, balance: int) -> int | None:
    raw_bet = raw_bet.lower().replace(" ", "")

    # "–≤—Å–µ" –∏–ª–∏ "–≤—Å—ë"
    if raw_bet in ["–≤—Å–µ", "–≤—Å—ë"]:
        return balance

    # % —Å—Ç–∞–≤–∫–∞
    if raw_bet.startswith("%"):
        try:
            percent = int(raw_bet[1:])
            if 1 <= percent <= 100:
                return max(1, (balance * percent) // 100)
            return None
        except ValueError:
            return None

    # –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ "3–∫–∫" / "3kk"
    if raw_bet.endswith(("–∫–∫", "kk")):
        try:
            num = int(raw_bet[:-2])
            return num * 1_000_000
        except ValueError:
            return None

    # –ø–æ–¥–¥–µ—Ä–∂–∫–∞ "k", "m", "b"
    multipliers = {"k": 1_000, "–∫": 1_000, "m": 1_000_000, "–º": 1_000_000, "b": 1_000_000_000}
    for suffix, mult in multipliers.items():
        if raw_bet.endswith(suffix):
            try:
                num = float(raw_bet[:-1].replace(",", "").replace(".", ""))
                return int(num * mult)
            except ValueError:
                return None

    # —É–±–∏—Ä–∞–µ–º —Ç–æ—á–∫–∏ –∏ –∑–∞–ø—è—Ç—ã–µ-—Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏ (1.000.000 / 1,000,000)
    clean = raw_bet.replace(".", "").replace(",", "")
    if clean.isdigit():
        return int(clean)

    return None

async def casino_command(update, context):
    user = update.effective_user
    user_data = get_or_create_casino_user(str(user.id), user.username or "", user.first_name or "")
    balance = user_data.get("balance", 0)

    args = getattr(context, "args", None)
    if not args or len(args) == 0:
        # –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –ö–∞–∑–∏–Ω–æ
        keyboard = [
            [InlineKeyboardButton("üïí –ü–æ—Å–ª–µ–¥–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è", callback_data="last_actions")],
            [InlineKeyboardButton("üèÜ –¢–æ–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π", callback_data="top_users")],
            [InlineKeyboardButton("‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è", url="https://ferniex-wiki.vercel.app/")]
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)

        # --- –µ—Å–ª–∏ –∫–æ–º–∞–Ω–¥–∞ /–∫–∞–∑–∏–Ω–æ
        if update.message:
            await update.message.reply_text(
                "üé∞ <b>–ö–∞–∑–∏–Ω–æ</b>\n"
                "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ",
                reply_markup=reply_markup,
                parse_mode="HTML"
            )
        # --- –µ—Å–ª–∏ –Ω–∞–∂–∞—Ç–∏–µ –∫–Ω–æ–ø–∫–∏
        elif update.callback_query:
            await update.callback_query.edit_message_text(
                "üé∞ <b>–ö–∞–∑–∏–Ω–æ</b>\n"
                "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ",
                reply_markup=reply_markup,
                parse_mode="HTML"
            )
        return

    # --- –õ–æ–≥–∏–∫–∞ —Å—Ç–∞–≤–∫–∏, –µ—Å–ª–∏ –µ—Å—Ç—å –∞—Ä–≥—É–º–µ–Ω—Ç ---
    raw_bet = args[0]
    bet = parse_bet_input(raw_bet, balance)

    if bet is None or bet <= 0 or bet > balance:
        msg = "‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Å—Ç–∞–≤–∫–∞." if bet is None else "‚ùå –°—Ç–∞–≤–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–π." if bet <= 0 else f"‚ùó –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤.\nüí∞ –ë–∞–ª–∞–Ω—Å: {balance} –º–æ–Ω–µ—Ç."
        if update.message:
            await update.message.reply_text(msg)
        elif update.callback_query:
            await update.callback_query.edit_message_text(msg)
        return

    context.user_data["casino_bet"] = bet

    text = (
        f"üé∞ *–ö–∞–∑–∏–Ω–æ*\n"
        f"üë§ –ò–≥—Ä–æ–∫: [{user.first_name}](tg://user?id={user.id})\n"
        f"üíµ –°—Ç–∞–≤–∫–∞: *{format_number(bet)} ‚ÇΩ*\n"
        f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
        f"üî¢ –í—ã–±–µ—Ä–∏, –Ω–∞ —á—Ç–æ —Å—Ç–∞–≤–∏—à—å:"
    )

    keyboard = [
        [
            InlineKeyboardButton("‚ö™ –ß–µ—Ç–Ω–æ–µ", callback_data="casino_even"),
            InlineKeyboardButton("‚ö´ –ù–µ—á–µ—Ç–Ω–æ–µ", callback_data="casino_odd")
        ],
        [InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∏—Ç—å", callback_data="casino_cancel")]
    ]

    reply_markup = InlineKeyboardMarkup(keyboard)

    if update.message:
        await update.message.reply_text(text, reply_markup=reply_markup, parse_mode="Markdown")
    elif update.callback_query:
        await update.callback_query.edit_message_text(text, reply_markup=reply_markup, parse_mode="Markdown")

def add_casino_action(user_id, username, bet_amount, choice, result, rolled_number, change_amount):
    timestamp = datetime.now().strftime("%d.%m.%Y | %H:%M:%S")
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute('''
        INSERT INTO actions (user_id, username, bet_amount, choice, result, rolled_number, change_amount, timestamp)
        VALUES (?, ?, ?, ?, ?, ?, ?, ?)
    ''', (user_id, username, bet_amount, choice, result, rolled_number, change_amount, timestamp))
    conn.commit()
    conn.close()


def get_last_actions(limit=3):
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute('SELECT * FROM actions ORDER BY id DESC LIMIT ?', (limit,))
    rows = cursor.fetchall()
    conn.close()
    return rows

# --- –ü–æ–∫–∞–∑ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π ---
async def show_last_actions(update, context):
    query = update.callback_query
    await query.answer()
    rows = get_last_actions(limit=3)  # –º–∞–∫—Å–∏–º—É–º 3 –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –¥–µ–π—Å—Ç–≤–∏—è

    if not rows:
        text = "üìå –ü–æ—Å–ª–µ–¥–Ω–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π –ø–æ–∫–∞ –Ω–µ—Ç."
    else:
        text = "üé∞ <b>–ö–∞–∑–∏–Ω–æ</b>\n> –ü–æ—Å–ª–µ–¥–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n"

        for act in rows:
            user_field = act[1]  # user_id –∏–∑ –±–∞–∑—ã
            try:
                user_id = int(user_field)
                # —Å–æ–∑–¥–∞—ë–º –∫–ª–∏–∫–∞–µ–º—ã–π –Ω–∏–∫
                display_name = get_display_name_html_new(
                    telegram.User(id=user_id, first_name="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å", is_bot=False)
                )
            except ValueError:
                # –µ—Å–ª–∏ user_field –Ω–µ —á–∏—Å–ª–æ, –ø—Ä–æ—Å—Ç–æ –≤—ã–≤–æ–¥–∏–º —Ç–µ–∫—Å—Ç
                display_name = html.escape(str(user_field))

            bet = act[3] or 0
            choice = act[4]
            result = act[5]
            rolled = act[6]
            change = act[7] or 0
            timestamp = act[8]

            # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Å—É–º–º—ã —Å —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–µ–º —Ç—ã—Å—è—á
            bet_fmt = f"{bet:,}".replace(",", ".")
            change_fmt = f"{abs(change):,}".replace(",", ".")

            parity = "–ß—ë—Ç–Ω–æ–µ" if rolled % 2 == 0 else "–ù–µ—á—ë—Ç–Ω–æ–µ"
            change_sign = "‚ûï" if result == "–ü–æ–±–µ–¥–∞" else "‚ûñ"
            emoji_result = "‚úÖ" if result == "–ü–æ–±–µ–¥–∞" else "‚ùå"

            text += (
                f"üïí {timestamp}\n"
                f"üë§ {display_name} (ID: <code>{user_field}</code>)\n"
                f"üíµ –°—É–º–º–∞ —Å—Ç–∞–≤–∫–∏: {bet_fmt}‚ÇΩ\n"
                f"üéØ –í—ã–±–æ—Ä: {choice}\n"
                f"{emoji_result} –†–µ–∑—É–ª—å—Ç–∞—Ç: {result}\n"
                f"üî¢ –í—ã–ø–∞–ª–æ: {rolled} | {parity}\n"
                f"{change_sign} –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞–≤–∫–∏: {change_fmt}‚ÇΩ\n"
                "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n"
            )

    keyboard = [[InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="casino_menu")]]
    reply_markup = InlineKeyboardMarkup(keyboard)

    await query.edit_message_text(text=text, reply_markup=reply_markup, parse_mode="HTML")



def get_top_users(category="wins", limit=5):
    """
    category: "wins" –∏–ª–∏ "losses"
    """
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    if category == "wins":
        cursor.execute('''
            SELECT username, COUNT(*) as total, SUM(change_amount) as total_sum
            FROM actions
            WHERE result = '–ü–æ–±–µ–¥–∞'
            GROUP BY username
            ORDER BY total DESC, total_sum DESC
            LIMIT ?
        ''', (limit,))
    else:  # losses
        cursor.execute('''
            SELECT username, COUNT(*) as total, SUM(ABS(change_amount)) as total_sum
            FROM actions
            WHERE result = '–ü–æ—Ä–∞–∂–µ–Ω–∏–µ'
            GROUP BY username
            ORDER BY total DESC, total_sum DESC
            LIMIT ?
        ''', (limit,))

    rows = cursor.fetchall()
    conn.close()
    return rows

async def show_top_users_list(update, context, category="wins"):
    query = update.callback_query
    await query.answer()

    rows = get_top_users(category=category)

    if not rows:
        text = "üìå –ü–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö."
    else:
        if category == "wins":
            cat_text = "–ü–æ–±–µ–¥—ã"
            trophy_emoji = "üèÜ"
        else:
            cat_text = "–ü–æ—Ä–∞–∂–µ–Ω–∏—è"
            trophy_emoji = "üíÄ"

        rub_emoji = "üí∞"

        text = f"üé∞ <b>–ö–ê–ó–ò–ù–û ‚Äî –¢–û–ü {cat_text}</b>\n"
        text += "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n"

        for i, (username, total, total_sum) in enumerate(rows, start=1):
            total_sum = total_sum or 0

            total_fmt = f"{total:,}".replace(",", ".")
            total_sum_fmt = f"{total_sum:,}".replace(",", ".") + "‚ÇΩ"

            # ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π username –Ω–∞–ø—Ä—è–º—É—é
            display_name = f"@{username}" if username else "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"

            text += (
                f"{i}. {display_name}\n"
                f"{trophy_emoji} {cat_text}: {total_fmt}\n"
                f"{rub_emoji} –°—É–º–º–∞: {total_sum_fmt}\n"
                "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n"
            )

    keyboard = [[InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="casino_menu")]]
    reply_markup = InlineKeyboardMarkup(keyboard)

    await query.edit_message_text(
        text=text,
        reply_markup=reply_markup,
        parse_mode="HTML"
    )

async def show_top_users(update, context):
    query = update.callback_query
    await query.answer()

    # –ö–Ω–æ–ø–∫–∏ —Å —ç–º–æ–¥–∑–∏ –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ —ç—Ñ—Ñ–µ–∫—Ç–∞
    keyboard = [
        [InlineKeyboardButton("üèÖ –ü–æ–±–µ–¥—ã", callback_data="top_wins")],
        [InlineKeyboardButton("üíÄ –ü–æ—Ä–∞–∂–µ–Ω–∏—è", callback_data="top_losses")],
        [InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="casino_menu")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)

    # –ö—Ä–∞—Å–∏–≤—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ –º–µ–Ω—é
    text = (
        "üé∞ <b>–ö–∞–∑–∏–Ω–æ</b>\n"
        "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n"
        "üèÜ <b>–¢–æ–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</b>\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞:"
    )

    await query.edit_message_text(text=text, reply_markup=reply_markup, parse_mode="HTML")

async def casino_button_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    data = query.data

    if data == "casino_menu":
        context.args = []
        await casino_command(update, context)
    elif data == "last_actions":
        await show_last_actions(update, context)
    elif data == "top_users":
        await show_top_users(update, context)
    elif data == "top_wins":
        await show_top_users_list(update, context, category="wins")
    elif data == "top_losses":
        await show_top_users_list(update, context, category="losses")

async def casino_choice_handler(update, context):
    query = update.callback_query
    await query.answer()
    choice = query.data
    user = query.from_user
    bet = context.user_data.get("casino_bet", 0)

    if choice == "casino_cancel":
        await query.edit_message_text("‚ùå *–°—Ç–∞–≤–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞.*", parse_mode="Markdown")
        return

    if not bet or bet <= 0:
        await query.edit_message_text("‚ö†Ô∏è *–û—à–∏–±–∫–∞:* —Å—Ç–∞–≤–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.", parse_mode="Markdown")
        return

    number = random.randint(1, 10)
    user_wins = (
        (number % 2 == 0 and choice == "casino_even") or
        (number % 2 != 0 and choice == "casino_odd")
    )

    result_text = "–ü–æ–±–µ–¥–∞" if user_wins else "–ü–æ—Ä–∞–∂–µ–Ω–∏–µ"
    change_amount = bet if user_wins else -bet

    # –õ–æ–≥ –¥–µ–π—Å—Ç–≤–∏—è
    add_casino_action(
        str(user.id),
        user.username or user.first_name,
        bet,
        "–ß—ë—Ç–Ω–æ–µ" if choice == "casino_even" else "–ù–µ—á—ë—Ç–Ω–æ–µ",
        result_text,
        number,
        change_amount
    )

    # –ë–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user_data = get_or_create_casino_user(
        str(user.id),
        user.username or "",
        user.first_name or ""
    )
    new_balance = int(user_data.get("balance", 0)) + change_amount
    update_user_casino_balance(str(user.id), new_balance)

    # ===============================
    # üí∞ –†–ê–°–ü–†–ï–î–ï–õ–ï–ù–ò–ï –ü–†–û–ò–ì–†–´–®–ê
    # ===============================
    if not user_wins:
        treasury_part = int(bet * 0.7)
        business_part = bet - treasury_part

        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()

        # 70% –≤ –∫–∞–∑–Ω—É
        cursor.execute("""
            INSERT INTO admin_treasury (id, balance)
            VALUES (1, ?)
            ON CONFLICT(id) DO UPDATE SET
                balance = balance + excluded.balance,
                last_update = DATE('now')
        """, (treasury_part,))

        # 30% –±–∏–∑–Ω–µ—Å–∞–º —Ç–∏–ø–∞ "–ö–∞–∑–∏–Ω–æ"
        cursor.execute("""
            SELECT id, balance
            FROM businesses_XUI
            WHERE business_type = '–ö–∞–∑–∏–Ω–æ'
        """)
        businesses = cursor.fetchall()

        if businesses:
            share = business_part // len(businesses)

            for business_id, balance in businesses:
                cursor.execute("""
                    UPDATE businesses_XUI
                    SET balance = ?
                    WHERE id = ?
                """, (int(balance) + share, business_id))
        else:
            # –µ—Å–ª–∏ –∫–∞–∑–∏–Ω–æ-–±–∏–∑–Ω–µ—Å–æ–≤ –Ω–µ—Ç ‚Äî –≤—Å—ë –≤ –∫–∞–∑–Ω—É
            cursor.execute("""
                UPDATE admin_treasury
                SET balance = balance + ?
                WHERE id = 1
            """, (business_part,))

        conn.commit()
        conn.close()

    # ===============================

    await query.edit_message_text(
        f"üé∞ *–ö–∞–∑–∏–Ω–æ ‚Äî {'–ß—ë—Ç–Ω–æ–µ' if choice=='casino_even' else '–ù–µ—á—ë—Ç–Ω–æ–µ'}*\n"
        f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
        f"{'‚úÖ –ü–æ–±–µ–¥–∞!' if user_wins else '‚ùå –ü—Ä–æ–∏–≥—Ä—ã—à...'}\n"
        f"–¢—ã {'–≤—ã–∏–≥—Ä–∞–ª' if user_wins else '–ø—Ä–æ–∏–≥—Ä–∞–ª'} *{bet}*‚ÇΩ\n"
        f"üí∞ –ë–∞–ª–∞–Ω—Å: {new_balance}‚ÇΩ\n"
        f"üß† –í—ã–ø–∞–≤—à–µ–µ —á–∏—Å–ª–æ: {number}",
        parse_mode="Markdown"
    )


def init_casino_db():
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS actions (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id TEXT,
            username TEXT,
            bet_amount INTEGER,
            choice TEXT,
            result TEXT,
            rolled_number INTEGER,
            change_amount INTEGER,
            timestamp TEXT
        )
    ''')
    conn.commit()
    conn.close()


async def rin_command(update: Update, context: ContextTypes.DEFAULT_TYPE, reply_message=None):
    """
    –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è —á–∏—Å–ª–∞.
    –ï—Å–ª–∏ reply_message –ø–µ—Ä–µ–¥–∞–Ω ‚Äî —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç –µ–≥–æ, –∏–Ω–∞—á–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ.
    """
    user_id = str(update.message.from_user.id)

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø–∏—Å–∫—É
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT end_time FROM SubFerniePlus WHERE user_id = ?", (user_id,))
    result = cursor.fetchone()
    conn.close()

    if not result or result[0] < int(time.time()):
        text = "‚ùå –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º Fernie+"
        if reply_message:
            await reply_message.edit_text(text)
        else:
            await update.message.reply_text(text)
        return

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞—Ä–≥—É–º–µ–Ω—Ç—ã
    try:
        last_numbers = [int(x) for x in context.args]
    except ValueError:
        text = "‚ùå –í—Å–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —á–∏—Å–ª–∞–º–∏ –æ—Ç 1 –¥–æ 10."
        if reply_message:
            await reply_message.edit_text(text)
        else:
            await update.message.reply_text(text)
        return

    if any(n < 1 or n > 10 for n in last_numbers):
        text = "‚ùå –í—Å–µ —á–∏—Å–ª–∞ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ 1‚Äì10."
        if reply_message:
            await reply_message.edit_text(text)
        else:
            await update.message.reply_text(text)
        return

    # –ß–∞—Å—Ç–æ—Ç–Ω—ã–π –º–µ—Ç–æ–¥
    freq = {i: 0 for i in range(1, 11)}
    for n in last_numbers:
        freq[n] += 1

    weighted_list = []
    for num, count in freq.items():
        weighted_list.extend([num] * (count + 1))

    predicted = random.choice(weighted_list)
    text = f"üß† <b>FernieX-AI</b>\n<pre>–í–µ—Ä–æ—è—Ç–Ω–µ–µ –≤—Å–µ–≥–æ, –±—É–¥–µ—Ç —á–∏—Å–ª–æ: {predicted}</pre>"

    if reply_message:
        await reply_message.edit_text(text, parse_mode="HTML")
    else:
        await update.message.reply_text(text, parse_mode="HTML")


def get_user_by_username(username: str):
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT user_id, username, balance FROM users WHERE username = ?", (username,))
    user = cursor.fetchone()
    conn.close()
    return user


# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –ë–î (–≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç dict –∏–ª–∏ None)
def get_user_paycommand_data(user_id: str):
    conn = sqlite3.connect(DB_PATH)
    conn.row_factory = sqlite3.Row
    cursor = conn.cursor()
    cursor.execute("SELECT * FROM users WHERE user_id = ?", (user_id,))
    row = cursor.fetchone()
    conn.close()
    if row:
        return dict(row)
    return None


# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
def update_balance_paycommand(user_id: str, new_balance: int):
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("UPDATE users SET balance = ? WHERE user_id = ?", (new_balance, user_id))
    conn.commit()
    conn.close()


# –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—É–º–º—ã –¥–µ–Ω–µ–≥ —Å —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º —Ç—ã—Å—è—á —Ç–æ—á–∫–∞–º–∏
def format_money(value: int) -> str:
    return format(value, ',').replace(',', '.')


def get_vip_name(vip_status: int) -> str:
    """–ü–æ–ª—É—á–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ VIP —É—Ä–æ–≤–Ω—è"""
    vip_status = int(vip_status)

    names = {
        0: "üë§ –û–±—ã—á–Ω—ã–π",
        1: "üü¢ VIP Silver",
        2: "üîµ VIP Gold",
        3: "üü£ VIP Platinum",
        4: "‚≠ê VIP Legend"
    }
    return names.get(vip_status, "‚ùì Unknown")


def get_transfer_limit(vip_status: int) -> int:
    limits = {
        0: 50_000,
        1: 100_000,
        2: 300_000,
        3: 750_000,
        4: 1_000_000,
    }
    return limits.get(vip_status, 10_000)


async def pay_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    sender = update.message.from_user
    sender_id = str(sender.id)

    text = update.message.text.strip()
    args = text.split(maxsplit=1)

    if len(args) < 2 and not update.message.reply_to_message:
        await update.message.reply_text(
            "‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã:\n"
            "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
            "‚Ä¢ –¥–∞—Ç—å {telegramID} {—Å—É–º–º–∞}\n"
            "‚Ä¢ –¥–∞—Ç—å {@username} {—Å—É–º–º–∞}\n"
            "‚Ä¢ –ò–ª–∏ –æ—Ç–≤–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Å—É–º–º–æ–π\n"
            "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
        )
        return

    receiver_id = None
    amount = None

    if update.message.reply_to_message and len(args) == 2:
        amount_str = args[1].replace(".", "").replace(",", "")
        try:
            amount = int(amount_str)
        except:
            await update.message.reply_text("‚ùå –°—É–º–º–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —á–∏—Å–ª–æ–º.")
            return
        receiver = update.message.reply_to_message.from_user
        receiver_id = str(receiver.id)

    else:
        if len(args) < 2:
            await update.message.reply_text("‚ùó –£–∫–∞–∂–∏—Ç–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è –∏ —Å—É–º–º—É.")
            return

        parts = args[1].split()
        if len(parts) < 2:
            await update.message.reply_text("‚ùó –£–∫–∞–∂–∏—Ç–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è –∏ —Å—É–º–º—É.")
            return

        target, amount_str = parts[0], parts[1]
        amount_str = amount_str.replace(".", "").replace(",", "")

        if target.startswith("@"):
            username = target[1:]
            conn = sqlite3.connect(DB_PATH)
            cursor = conn.cursor()
            cursor.execute("SELECT user_id FROM users WHERE username = ?", (username,))
            row = cursor.fetchone()
            conn.close()
            if not row:
                await update.message.reply_text(f"‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å @{username} –Ω–µ –Ω–∞–π–¥–µ–Ω.")
                return
            receiver_id = str(row[0])
        elif target.isdigit():
            receiver_id = target
        else:
            await update.message.reply_text("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –ø–æ–ª—É—á–∞—Ç–µ–ª—è. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Telegram ID –∏–ª–∏ @username.")
            return

        try:
            amount = int(amount_str)
        except:
            await update.message.reply_text("‚ùå –°—É–º–º–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —á–∏—Å–ª–æ–º.")
            return

    if receiver_id == sender_id:
        await update.message.reply_text("‚ùå –í—ã –Ω–µ –º–æ–∂–µ—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–µ–Ω—å–≥–∏ —Å–∞–º–∏ —Å–µ–±–µ.")
        return

    if amount <= 0:
        await update.message.reply_text("‚ùå –°—É–º–º–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º.")
        return

    sender_db = get_user_paycommand_data(sender_id)
    receiver_db = get_user_paycommand_data(receiver_id)

    if not sender_db:
        await update.message.reply_text("‚ùå –í—ã –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –≤ —Å–∏—Å—Ç–µ–º–µ.")
        return

    if not receiver_db:
        await update.message.reply_text("‚ùå –ü–æ–ª—É—á–∞—Ç–µ–ª—å –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –≤ —Å–∏—Å—Ç–µ–º–µ.")
        return

    sender_balance = int(sender_db.get('balance', 0))
    receiver_balance = int(receiver_db.get('balance', 0))

    if sender_balance < amount:
        await update.message.reply_text(
            f"‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤.\n"
            f"üí∞ –í–∞—à –±–∞–ª–∞–Ω—Å: *{format_money(sender_balance)}*‚ÇΩ",
            parse_mode="Markdown"
        )
        return

    vip_status = int(sender_db.get('vip_status', 0))
    vip_name = get_vip_name(vip_status)
    transfer_limit = get_transfer_limit(vip_status)

    if amount > transfer_limit:
        await update.message.reply_text(
            f"‚ùå *–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç!*\n\n"
            f"üíé –í–∞—à —Å—Ç–∞—Ç—É—Å: *{vip_name}*\n"
            f"üí∞ –ú–∞–∫—Å. —Å—É–º–º–∞: *{format_money(transfer_limit)}*‚ÇΩ\n"
            f"‚ö†Ô∏è –í—ã –ø–µ—Ä–µ–≤–æ–¥–∏—Ç–µ: *{format_money(amount)}*‚ÇΩ\n",
            parse_mode="Markdown"
        )
        return

    # –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å—ã
    update_balance_paycommand(sender_id, sender_balance - amount)
    update_balance_paycommand(receiver_id, receiver_balance + amount)

    # –ü–æ–ª—É—á–∞–µ–º User –ø–æ–ª—É—á–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ –±–æ—Ç
    try:
        receiver_member = await context.bot.get_chat_member(chat_id=update.effective_chat.id, user_id=int(receiver_id))
        receiver_user_obj = receiver_member.user
    except Exception:
        # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ–±—ä–µ–∫—Ç User, —Å–æ–∑–¥–∞—ë–º –∑–∞–≥–ª—É—à–∫—É
        receiver_user_obj = User(id=int(receiver_id), first_name=receiver_db.get('first_name', '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'),
                                 is_bot=False)

    sender_display = get_display_name_html_new(sender)
    receiver_display = get_display_name_html_new(receiver_user_obj)
    amount_display = format_money(amount)

    await update.message.reply_text(
        f"‚úÖ –ü–µ—Ä–µ–≤–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!\n"
        "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
        f"üë§ –û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å: {sender_display}\n"
        f"üë• –ü–æ–ª—É—á–∞—Ç–µ–ª—å: {receiver_display}\n"
        f"üí∏ –°—É–º–º–∞ –ø–µ—Ä–µ–≤–æ–¥–∞: {amount_display} ‚ÇΩ\n"
        "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ",
        parse_mode="HTML"
    )

    # ---------- –õ–æ–≥ –ø–µ—Ä–µ–≤–æ–¥–∞ –≤ –∫–∞–Ω–∞–ª/—á–∞—Ç ----------
    log_text = (
        f"üí∞ <b>–ù–æ–≤—ã–π –ø–µ—Ä–µ–≤–æ–¥</b>\n"
        f"‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n"
        f"üë§ –û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å: {sender_display}\n"
        f"üÜî ID: <code>{sender_id}</code>\n"
        f"üë• –ü–æ–ª—É—á–∞—Ç–µ–ª—å: {receiver_display}\n"
        f"üÜî ID: <code>{receiver_id}</code>\n"
        f"üí∏ –°—É–º–º–∞ –ø–µ—Ä–µ–≤–æ–¥–∞: {amount_display} ‚ÇΩ\n"
    )

    try:
        await context.bot.send_message(
            chat_id=Transaction_ID,
            text=log_text,
            parse_mode="HTML"
        )
    except Exception as e:
        print("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ª–æ–≥–∞ –ø–µ—Ä–µ–≤–æ–¥–∞:", e)

def get_status_name(status_id):
    try:
        status_int = int(status_id)
    except (TypeError, ValueError):
        return "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"
    if 0 <= status_int < len(STATUS_LIST):
        return STATUS_LIST[status_int]
    return "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"


def format_balance(amount):
    try:
        amount_num = int(amount)
    except (ValueError, TypeError):
        amount_num = 0
    return f"{amount_num:,}".replace(",", " ")


def get_user_by_id(user_id: str):
    conn = sqlite3.connect(DB_PATH)
    conn.row_factory = sqlite3.Row
    cursor = conn.cursor()
    cursor.execute("""
        SELECT user_id, username, first_name, nickname, status, balance, seeds, property,
               exp, level, bonus_given, inventory_car, inventory_phone, inventory_yacht,
               inventory_business, inventory_home, inventory_pet, clicks, last_farm,
               dc_balance, vip_level
        FROM users WHERE user_id = ?
    """, (user_id,))
    row = cursor.fetchone()
    conn.close()
    return dict(row) if row else None


def get_user_pet(user_id: str):
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT pet_type, pet_name FROM pets WHERE user_id = ?", (user_id,))
    row = cursor.fetchone()
    conn.close()
    if not row:
        return None
    pet_type, pet_name = row
    return f"{pet_name} ({pet_type})" if pet_name else pet_type


def get_user_bus(user_id: str):
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute(
        "SELECT business_name, business_level, business_balance, business_profit FROM businesses WHERE user_id = ?",
        (user_id,))
    row = cursor.fetchone()
    conn.close()
    keys = ["business_name", "business_level", "business_balance", "business_profit"]
    return dict(zip(keys, row)) if row else dict(zip(keys, ['', 0, 0, 0]))


def get_user_bank(user_id: int):
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ Bank_New
    cursor.execute("""
        SELECT account_name, account_number, balance FROM Bank_New WHERE user_id = ?
    """, (user_id,))
    bank_row = cursor.fetchone()
    if not bank_row:
        conn.close()
        return None

    account_name, account_number, balance = bank_row

    # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–µ–ø–æ–∑–∏—Ç–∞ –∏–∑ Bank_Deposit
    cursor.execute("""
        SELECT deposit_balance, is_active, start_time, end_time FROM Bank_Deposit WHERE user_id = ?
    """, (user_id,))
    deposit_row = cursor.fetchone()
    conn.close()

    deposit_balance = 0
    deposit_active = False
    deposit_time_left_str = None

    if deposit_row:
        deposit_balance, is_active, start_time_str, end_time_str = deposit_row
        deposit_active = bool(is_active)

        if deposit_active and start_time_str and end_time_str:
            # –ü–∞—Ä—Å–∏–º —Å—Ç—Ä–æ–∫–∏ –≤—Ä–µ–º–µ–Ω–∏ –≤ timestamp
            fmt = "%Y-%m-%d %H:%M:%S"  # –ø—Ä–∏–º–µ—Ä —Ñ–æ—Ä–º–∞—Ç–∞, —É—Ç–æ—á–Ω–∏ –µ—Å–ª–∏ –¥—Ä—É–≥–æ–π
            try:
                end_time = datetime.strptime(end_time_str, fmt).timestamp()
                now = time.time()
                time_left = max(0, int(end_time - now))
                deposit_time_left_str = f"{time_left // 3600}—á {(time_left % 3600) // 60}–º" if time_left > 0 else "–∑–∞–≤–µ—Ä—à—ë–Ω"
            except Exception:
                deposit_time_left_str = "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"

    return {
        "account_name": account_name,
        "account_number": account_number,
        "balance": balance,
        "deposit_balance": deposit_balance,
        "deposit_active": deposit_active,
        "deposit_time_left": deposit_time_left_str,
    }

def build_main_menu(user_id, requester_id):
    keyboard = [
        [InlineKeyboardButton("üí∞ –û—Å–Ω–æ–≤–Ω–∞—è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è", callback_data=f"info_basic|{user_id}|{requester_id}")],
        [InlineKeyboardButton("üè¶ –ë–∞–Ω–∫", callback_data=f"info_bank|{user_id}|{requester_id}")],
        [InlineKeyboardButton("üè¢ –ë–∏–∑–Ω–µ—Å", callback_data=f"info_business|{user_id}|{requester_id}")],
        [InlineKeyboardButton("üè† –ò–º—É—â–µ—Å—Ç–≤–æ", callback_data=f"info_assets|{user_id}|{requester_id}")],
    ]
    return InlineKeyboardMarkup(keyboard)


def build_back_keyboard(user_id, requester_id):
    return InlineKeyboardMarkup(
        [[InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data=f"info_back|{user_id}|{requester_id}")]])

async def info_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.message.from_user
    args = context.args

    if args:
        search_text = args[0].strip()
    elif update.message.reply_to_message:
        search_text = str(update.message.reply_to_message.from_user.id)
    else:
        await update.message.reply_text(
            "‚ö† –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: –∏–Ω—Ñ–æ {telegramID} –∏–ª–∏ @username, –∏–ª–∏ –æ—Ç–≤–µ—Ç–æ–º –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ."
        )
        return

    searching_msg = await update.message.reply_text(
        f"üîç –ü–æ–∏—Å–∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏...\n<code>{search_text}</code>",
        parse_mode="HTML"
    )
    await asyncio.sleep(1)

    user_id = None

    if search_text.startswith("@"):
        username = search_text[1:]
        try:
            with sqlite3.connect(DB_PATH) as conn:
                cursor = conn.cursor()
                cursor.execute("SELECT user_id FROM users WHERE username = ?", (username,))
                row = cursor.fetchone()
                if not row:
                    await searching_msg.edit_text(f"‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å @{username} –Ω–µ –Ω–∞–π–¥–µ–Ω.")
                    return
                user_id = row[0]
        except sqlite3.DatabaseError:
            await searching_msg.edit_text("‚ö† –û—à–∏–±–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.")
            return
    else:
        user_id = search_text

    try:
        target_user_obj = await context.bot.get_chat(int(user_id))
    except Exception:
        await searching_msg.edit_text("‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω.")
        return

    user_display = get_display_name_html_new(target_user_obj)
    requester_display = get_display_name_html_new(user)

    text = (
        f"‚úÖ <b>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–∞–π–¥–µ–Ω–∞</b>\n\n"
        f"üë§ <b>{user_display}</b>\n"
        f"üîé –ó–∞–ø—Ä–æ—Å–∏–ª: {requester_display}\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª:"
    )

    reply_markup = build_main_menu(user_id, str(user.id))
    await searching_msg.edit_text(text, reply_markup=reply_markup, parse_mode="HTML")


def format_card_number(number: str) -> str:
    number = number.replace(" ", "")
    groups = [number[i:i + 4] for i in range(0, len(number), 4)]
    return " ".join(groups)


async def info_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    data = query.data
    parts = data.split("|")
    if len(parts) < 3:
        await query.answer(text="‚ö†Ô∏è –ö–Ω–æ–ø–∫–∞ —É—Å—Ç–∞—Ä–µ–ª–∞.", show_alert=True)
        return

    action, user_id, requester_id = parts

    target_user = get_user_by_id(user_id)
    if not target_user:
        await query.edit_message_text("‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω.")
        return

    admin_status_str = "‚Äî"
    chat = update.effective_chat
    if chat:
        chat_id = str(chat.id)
        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()
        cursor.execute(
            "SELECT admin_level FROM chat_admins WHERE chat_id = ? AND user_id = ?",
            (chat_id, user_id)
        )
        result = cursor.fetchone()
        conn.close()
        if result:
            admin_level = result[0]
            admin_status_str = CHAT_ADMINS_ROLE_LIST[admin_level] if 0 <= admin_level < len(
                CHAT_ADMINS_ROLE_LIST) else "–ê–¥–º–∏–Ω"
        else:
            admin_status_str = "–ù–µ –∞–¥–º–∏–Ω"

    if action == "info_back":
        await query.edit_message_text("üîç –ü–æ–∏—Å–∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏...")
        await asyncio.sleep(0.3)

        try:
            target_user_obj = await context.bot.get_chat(int(user_id))
        except Exception:
            await query.edit_message_text("‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω.")
            return

        user_display = get_display_name_html_new(target_user_obj)
        requester_obj = update.effective_user
        requester_display = get_display_name_html_new(requester_obj)

        text = (
            f"‚úÖ <b>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–∞–π–¥–µ–Ω–∞</b>\n\n"
            f"üë§ <b>{user_display}</b>\n"
            f"üîé –ó–∞–ø—Ä–æ—Å–∏–ª: {requester_display}\n\n"
            "–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª:"
        )

        t_user_id = str(target_user_obj.id)
        r_user_id = str(requester_obj.id)

        reply_markup = build_main_menu(t_user_id, r_user_id)
        await query.edit_message_text(text, reply_markup=reply_markup, parse_mode="HTML")

    if action == "info_basic":
        try:
            target_user_obj = await context.bot.get_chat(int(user_id))
        except Exception:
            await query.edit_message_text("‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω.")
            return

        target_user = get_user_by_id(user_id)
        if not target_user:
            await query.edit_message_text("‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω.")
            return

        balance = target_user.get("balance", 0)
        seeds = target_user.get("seeds", 0)
        exp = target_user.get("exp", 0)
        level = max(1, math.ceil(exp / 100))
        status_name = get_status_name(target_user.get("status"))
        dc_balance = target_user.get("dc_balance", 0)
        vip_level = target_user.get("vip_status", 0)

        user_display = get_display_name_html_new(target_user_obj)

        vip_names = {0: "–ù–µ—Ç", 1: "Silver ü•à", 2: "Gold ü•á", 3: "Platinum üíé", 4: "Legend üëë"}
        vip_display = vip_names.get(vip_level, "–ù–µ—Ç")

        text = (
            f"üí∞ <b>–û—Å–Ω–æ–≤–Ω–∞—è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</b>\n\n"
            f"üë§ {user_display}\n"
            f"üÜî ID: <code>{user_id}</code>\n\n"
            f"<b>–î–µ–Ω—å–≥–∏ –∏ –∞–∫—Ç–∏–≤—ã:</b>\n"
            f"üíµ –ë–∞–ª–∞–Ω—Å: <b>{format_balance(balance)}‚ÇΩ</b>\n"
            f"üå± –°–µ–º–µ–Ω–∞: <b>{format_balance(seeds)}</b>\n"
            f"üí† DC: <b>{format_balance(dc_balance)}</b>\n\n"
            f"<b>–†–∞–∑–≤–∏—Ç–∏–µ:</b>\n"
            f"‚¨ÜÔ∏è –£—Ä–æ–≤–µ–Ω—å: <b>Lv.{level}</b>\n"
            f"‚ö° –û–ø—ã—Ç: <b>{exp}</b>\n"
            f"üèÜ –†–µ–π—Ç–∏–Ω–≥: <b>#{target_user.get('rating', '‚Äî')}</b>\n\n"
            f"<b>–°—Ç–∞—Ç—É—Å—ã:</b>\n"
            f"üíé VIP: {vip_display}\n"
            f"üßæ –°—Ç–∞—Ç—É—Å: {status_name}\n"
            f"üëÆ –†–æ–ª—å: {admin_status_str}\n"
        )

        reply_markup = build_back_keyboard(user_id, requester_id)
        await query.edit_message_text(text, reply_markup=reply_markup, parse_mode="HTML")

    elif action == "info_bank":
        try:
            target_user_obj = await context.bot.get_chat(int(user_id))
        except Exception:
            await query.edit_message_text("‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω.")
            return

        user_display = get_display_name_html_new(target_user_obj)

        bank = get_user_bank(int(user_id))
        if not bank:
            text = (
                f"üè¶ <b>–ë–∞–Ω–∫</b>\n\n"
                f"üë§ {user_display}\n\n"
                "‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö"
            )
        else:
            deposit_status = "üü¢ –ê–∫—Ç–∏–≤–µ–Ω" if bank.get('deposit_active') else "üî¥ –ù–µ–∞–∫—Ç–∏–≤–µ–Ω"
            text = (
                f"üè¶ <b>–ë–∞–Ω–∫</b>\n\n"
                f"üë§ {user_display}\n"
                f"üè∑Ô∏è –°—á–µ—Ç: {bank.get('account_name', '–ù–µ —É–∫–∞–∑–∞–Ω–æ')}\n\n"
                f"üí≥ –ö–∞—Ä—Ç–∞: <code>{format_card_number(bank.get('account_number', '0000 0000 0000 0000'))}</code>\n"
                f"üí∞ –û—Å–Ω–æ–≤–Ω–æ–π: <b>{format_balance(bank.get('balance', 0))}‚ÇΩ</b>\n"
                f"üìä –î–µ–ø–æ–∑–∏—Ç: <b>{format_balance(bank.get('deposit_balance', 0))}‚ÇΩ</b>\n"
                f"‚úÖ –°—Ç–∞—Ç—É—Å: {deposit_status}"
            )

        reply_markup = build_back_keyboard(user_id, requester_id)
        await query.edit_message_text(text, reply_markup=reply_markup, parse_mode="HTML")

    elif action == "info_business":
        try:
            target_user_obj = await context.bot.get_chat(int(user_id))
        except Exception:
            await query.edit_message_text("‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω.")
            return

        user_display = get_display_name_html_new(target_user_obj)

        # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –±–∏–∑–Ω–µ—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()
        cursor.execute(
            "SELECT name, business_type, balance FROM businesses_XUI WHERE owner_id = ?",
            (int(user_id),)
        )
        businesses = cursor.fetchall()
        conn.close()

        if not businesses:
            text = (
                f"üè¢ <b>–ë–∏–∑–Ω–µ—Å</b>\n\n"
                f"üë§ {user_display}\n\n"
                "‚ùå –ù–µ—Ç –±–∏–∑–Ω–µ—Å–∞"
            )
        else:
            business_list = "\n".join([
                f"‚Ä¢ <b>{name}</b> ({business_type}): {format_balance(balance)}‚ÇΩ"
                for name, business_type, balance in businesses
            ])
            text = (
                f"üè¢ <b>–ë–∏–∑–Ω–µ—Å</b>\n\n"
                f"üë§ {user_display}\n"
                f"üìä –í—Å–µ–≥–æ –±–∏–∑–Ω–µ—Å–∞: <b>{len(businesses)}</b>\n\n"
                f"{business_list}"
            )

        reply_markup = build_back_keyboard(user_id, requester_id)
        await query.edit_message_text(text, reply_markup=reply_markup, parse_mode="HTML")

    elif action == "info_assets":
        target_user = get_user_by_id(user_id)
        if not target_user:
            await query.edit_message_text("‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω.")
            return

        car = target_user.get("inventory_car") or "‚Äî"
        phone = target_user.get("inventory_phone") or "‚Äî"
        yacht = target_user.get("inventory_yacht") or "‚Äî"
        home = target_user.get("inventory_home") or "‚Äî"
        pet = target_user.get("inventory_pet") or "‚Äî"

        try:
            target_user_obj = await context.bot.get_chat(int(user_id))
        except Exception:
            await query.edit_message_text("‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω.")
            return
        user_display = get_display_name_html_new(target_user_obj)

        text = (
            f"üè† <b>–ò–º—É—â–µ—Å—Ç–≤–æ</b>\n\n"
            f"üë§ {user_display}\n\n"
            f"üöó –ú–∞—à–∏–Ω–∞: {car}\n"
            f"üì± –¢–µ–ª–µ—Ñ–æ–Ω: {phone}\n"
            f"üõ•Ô∏è –Ø—Ö—Ç–∞: {yacht}\n"
            f"üè° –î–æ–º: {home}\n"
            f"üêæ –ü–∏—Ç–æ–º–µ—Ü: {pet}"
        )

        reply_markup = build_back_keyboard(user_id, requester_id)
        await query.edit_message_text(text, reply_markup=reply_markup, parse_mode="HTML")

# –ü—Ä–∏–º–µ—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∏ —Ç–æ–≤–∞—Ä–æ–≤
CATEGORIES = [
    ("–º–∞—à–∏–Ω—ã", "üöó –ú–∞—à–∏–Ω—ã"),
    ("—è—Ö—Ç—ã", "üõ• –Ø—Ö—Ç—ã"),
    ("–¥–æ–º–∞", "üè† –î–æ–º–∞"),
    ("—Ç–µ–ª–µ—Ñ–æ–Ω—ã", "üì± –¢–µ–ª–µ—Ñ–æ–Ω—ã"),
    ("–ø–∏—Ç–æ–º—Ü—ã", "üêï –ü–∏—Ç–æ–º—Ü—ã"),
    ("–º–∞–π–Ω–∏–Ω–≥", "üñ• –ú–∞–π–Ω–∏–Ω–≥ —Ñ–µ—Ä–º—ã"),
]

PRODUCTS = {
    "–º–∞—à–∏–Ω—ã": [
        # –î–µ—à—ë–≤—ã–µ —Ä–æ—Å—Å–∏–π—Å–∫–∏–µ –∞–≤—Ç–æ
        {"name": "Lada Granta", "price": 25000},
        {"name": "Lada Niva", "price": 28000},
        {"name": "Lada Vesta", "price": 30000},
        {"name": "GAZ Volga Siber", "price": 35000},
        {"name": "UAZ Patriot", "price": 45000},
        {"name": "KamAZ 43118", "price": 120000},

        # –ë—é–¥–∂–µ—Ç–Ω—ã–µ –∏ —Å—Ä–µ–¥–Ω–∏–µ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –∞–≤—Ç–æ
        {"name": "BMW M3", "price": 800000},
        {"name": "Kia Sportage", "price": 2100000},
        {"name": "Hyundai Tucson", "price": 2200000},
        {"name": "Mazda CX-5", "price": 2300000},
        {"name": "Volkswagen Tiguan", "price": 2400000},
        {"name": "Toyota Camry", "price": 2500000},

        # –î–æ—Ä–æ–≥–∏–µ –∞–≤—Ç–æ–º–æ–±–∏–ª–∏
        {"name": "Dodge Charger", "price": 3500000},
        {"name": "BMW M5 F90", "price": 5000000},
        {"name": "Tesla Model S", "price": 10000000},
        {"name": "Mercedes-Benz G-Class", "price": 8500000},
        {"name": "BMW M5 F90 Competition", "price": 9400000},
        {"name": "Porsche 911 Turbo", "price": 13000000},
        {"name": "Audi R8", "price": 15000000},
        {"name": "Lamborghini Huracan", "price": 22000000},
        {"name": "Ferrari F8 Tributo", "price": 30000000},
    ],

    "—è—Ö—Ç—ã": [
        {"name": "Sunseeker 50", "price": 10000000},
        {"name": "Azimut 60", "price": 17000000},
        {"name": "Riva 75", "price": 22000000},
        {"name": "Ferretti 720", "price": 25000000},
        {"name": "Princess 85", "price": 32000000},
        {"name": "Sunreef 80", "price": 35000000},
        {"name": "Heesen 55", "price": 38000000},

        # –ù–æ–≤—ã–µ —è—Ö—Ç—ã
        {"name": "Pershing 70", "price": 28000000},
        {"name": "Mangusta 108", "price": 42000000},
        {"name": "Sanlorenzo 86", "price": 33000000},
        {"name": "Beneteau Oceanis 60", "price": 9000000},  # –±–æ–ª–µ–µ –±—é–¥–∂–µ—Ç–Ω–∞—è —è—Ö—Ç–∞
        {"name": "Codecasa 60", "price": 47000000},

        {"name": "Benetti 100", "price": 45000000},
        {"name": "Baltic 112", "price": 48000000},
        {"name": "Oceanco 100", "price": 55000000},
        {"name": "L√ºrssen 90", "price": 60000000}
    ],

    "–¥–æ–º–∞": [
        {"name": "–ö–≤–∞—Ä—Ç–∏—Ä–∞ –≤ –Ω–æ–≤–æ—Å—Ç—Ä–æ–π–∫–µ", "price": 1200000},
        {"name": "–¢–∞—É–Ω—Ö–∞—É—Å", "price": 1800000},
        {"name": "–ö–æ—Ç—Ç–µ–¥–∂", "price": 2000000},
        {"name": "–ü–µ–Ω—Ç—Ö–∞—É—Å", "price": 2500000},
        {"name": "–®–∞–ª–µ –≤ –≥–æ—Ä–∞—Ö", "price": 3200000},
        {"name": "–û—Å–æ–±–Ω—è–∫", "price": 3500000},
        {"name": "–í–∏–ª–ª–∞ —É –º–æ—Ä—è", "price": 4500000},
        {"name": "–ü–µ–Ω—Ç—Ö–∞—É—Å —Å –±–∞—Å—Å–µ–π–Ω–æ–º", "price": 5500000},
        {"name": "–ó–∞–º–æ–∫", "price": 7000000},
        {"name": "–†–µ–∑–∏–¥–µ–Ω—Ü–∏—è —Å –ø–∞—Ä–∫–æ–º", "price": 8000000},

        # –ù–æ–≤—ã–µ –¥–æ–º–∞
        {"name": "–ö–æ—Ç—Ç–µ–¥–∂ —É –æ–∑–µ—Ä–∞", "price": 1500000},
        {"name": "–î–∞—á–∞ —Å —Å–∞–¥–æ–º", "price": 900000},
        {"name": "–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –ª–æ—Ñ—Ç", "price": 1300000},
        {"name": "–ú–æ—Ä—Å–∫–æ–π –æ—Å–æ–±–Ω—è–∫", "price": 6000000},
        {"name": "–≠–∫–æ-–≤–∏–ª–ª–∞", "price": 5000000}
    ],

    "—Ç–µ–ª–µ—Ñ–æ–Ω—ã": [
    # –°–∞–º—ã–µ –¥–µ—à—ë–≤—ã–µ
    {"name": "Tecno Camon 30", "price": 17000},
    {"name": "iPhone XR", "price": 20000},
    {"name": "Tecno Camon 40", "price": 30000},
    {"name": "iPhone 13", "price": 25000},

    # iPhone 15 —Å–µ—Ä–∏—è
    {"name": "iPhone 15", "price": 45000},
    {"name": "iPhone 15 Pro", "price": 70000},
    {"name": "Tecno Camon 50", "price": 55000},

    # iPhone 16 —Å–µ—Ä–∏—è
    {"name": "iPhone 16", "price": 75000},
    {"name": "iPhone 16 Pro", "price": 80000},
    {"name": "iPhone 16 Pro Max", "price": 100000},

    # iPhone 17 —Å–µ—Ä–∏—è
    {"name": "iPhone 17", "price": 85000},
    {"name": "iPhone 17 Pro", "price": 100000},
    {"name": "iPhone 17 Pro Max", "price": 170000},

    # Samsung —Å–µ—Ä–∏—è
    {"name": "Samsung Galaxy S24 Ultra", "price": 90000},
    {"name": "Samsung Galaxy S25 Ultra", "price": 140000},

    # –î—Ä—É–≥–∏–µ –±—Ä–µ–Ω–¥—ã
    {"name": "Google Pixel 8 Pro", "price": 90000},
    {"name": "OnePlus 12", "price": 85000},
    {"name": "Xiaomi Mi 14 Pro", "price": 70000},
    {"name": "Sony Xperia 1 V", "price": 95000},
    {"name": "Asus ROG Phone 7", "price": 85000},
    {"name": "Huawei P60 Pro", "price": 80000},
    {"name": "Realme GT 5 Pro", "price": 65000},
    {"name": "Motorola Edge 40 Pro", "price": 72000}
    ],

    "–ø–∏—Ç–æ–º—Ü—ã": [
        {"name": "–ó–æ–ª–æ—Ç–∞—è —Ä—ã–±–∫–∞", "price": 3000},
        {"name": "–•–æ–º—è–∫", "price": 5000},
        {"name": "–ü–æ–ø—É–≥–∞–π", "price": 6000},
        {"name": "–ö—Ä–æ–ª–∏–∫", "price": 7000},
        {"name": "–ö–æ—à–∫–∞", "price": 8000},
        {"name": "–°–æ–±–∞–∫–∞", "price": 8000},
        {"name": "–ß–µ—Ä–µ–ø–∞—Ö–∞", "price": 9000},
        {"name": "–ò–≥—É–∞–Ω–∞", "price": 12000},
        {"name": "–§—Ä–µ—Ç–∫–∞", "price": 15000},
        {"name": "–ö–∞–Ω–∞—Ä–µ–π–∫–∞", "price": 4000},
        {"name": "–ì–µ–∫–∫–æ–Ω", "price": 11000},
        {"name": "–ü–æ–ø—É–≥–∞–π –∞—Ä–∞", "price": 20000},
        {"name": "–ú–æ—Ä—Å–∫–∞—è —Å–≤–∏–Ω–∫–∞", "price": 6000},
        {"name": "–ü–∏—Ç–æ–Ω", "price": 25000}
    ],
}


def get_or_create_user(user_id, username):
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute(
        "SELECT balance, inventory_car, inventory_yacht, inventory_business, inventory_phone, inventory_home, inventory_pet FROM users WHERE user_id = ?",
        (user_id,))
    row = cursor.fetchone()
    conn.close()

    if row:
        return row  # –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤—Å–µ –ø–æ–ª—è
    else:
        return None


def update_user_inventory(user_id, inventory_field, product_name, price):
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    # –ü–æ–ª—É—á–∞–µ–º –±–∞–ª–∞–Ω—Å –∏ —Ç–µ–∫—É—â–∏–π –ø—Ä–µ–¥–º–µ—Ç –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    cursor.execute(f"SELECT balance, {inventory_field} FROM users WHERE user_id = ?", (user_id,))
    row = cursor.fetchone()
    if not row:
        conn.close()
        return False, "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω"

    balance, current_item = row

    # –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ current_item - —Å—Ç—Ä–æ–∫–∞, –µ—Å–ª–∏ NULL - –∑–∞–º–µ–Ω–∏–º –Ω–∞ –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É
    if current_item is None:
        current_item = ""

    if balance < price:
        conn.close()
        return False, "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ–Ω–µ–≥ –¥–ª—è –ø–æ–∫—É–ø–∫–∏"

    # –ï—Å–ª–∏ –ø–æ–ª–µ —Å –ø—Ä–µ–¥–º–µ—Ç–æ–º –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–µ –ø—É—Å—Ç–æ–µ, –∑–Ω–∞—á–∏—Ç —É–∂–µ –µ—Å—Ç—å –ø—Ä–µ–¥–º–µ—Ç
    if current_item.strip() != "" and current_item.strip().lower() != "–Ω–µ—Ç":
        conn.close()
        return False, f"–£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –ø—Ä–µ–¥–º–µ—Ç –≤ —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏: {current_item}. –ü—Ä–æ–¥–∞–π—Ç–µ –µ–≥–æ, —á—Ç–æ–±—ã –∫—É–ø–∏—Ç—å –Ω–æ–≤—ã–π."

    # –ï—Å–ª–∏ –ø—Ä–µ–¥–º–µ—Ç–∞ –Ω–µ—Ç ‚Äî —Å–ø–∏—Å—ã–≤–∞–µ–º –¥–µ–Ω—å–≥–∏ –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª–µ
    new_balance = balance - price
    cursor.execute(f"UPDATE users SET balance = ?, {inventory_field} = ? WHERE user_id = ?",
                   (new_balance, product_name, user_id))
    conn.commit()
    conn.close()

    return True, "–ü–æ–∫—É–ø–∫–∞ —É—Å–ø–µ—à–Ω–∞"

SHOP_PHOTO_URL = "https://i.postimg.cc/hvJbVZn1/image.png"

async def shop_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    keyboard = [
        [
            InlineKeyboardButton("üöó –ú–∞—à–∏–Ω—ã", callback_data="shop_cat_–º–∞—à–∏–Ω—ã|1"),
            InlineKeyboardButton("üõ• –Ø—Ö—Ç—ã", callback_data="shop_cat_—è—Ö—Ç—ã|1"),
        ],
        [
            InlineKeyboardButton("üêï –ü–∏—Ç–æ–º—Ü—ã", callback_data="shop_cat_–ø–∏—Ç–æ–º—Ü—ã|1"),
            InlineKeyboardButton("üè† –î–æ–º–∞", callback_data="shop_cat_–¥–æ–º–∞|1"),
        ],
        [
            InlineKeyboardButton("üì± –¢–µ–ª–µ—Ñ–æ–Ω—ã", callback_data="shop_cat_—Ç–µ–ª–µ—Ñ–æ–Ω—ã|1"),
        ],
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    caption = (
        "üè¨ <b>–ò–≥—Ä–æ–≤–æ–π –ú–∞–≥–∞–∑–∏–Ω</b>\n"
        "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
        "üëá <i>–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é:</i>"
    )

    if update.callback_query:
        msg = update.callback_query.message
        if msg.photo:
            await msg.edit_caption(caption, reply_markup=reply_markup, parse_mode="HTML")
        else:
            await msg.delete()
            await msg.chat.send_photo(
                photo=SHOP_PHOTO_URL,
                caption=caption,
                reply_markup=reply_markup,
                parse_mode="HTML"
            )
    else:
        await update.message.reply_photo(
            photo=SHOP_PHOTO_URL,
            caption=caption,
            reply_markup=reply_markup,
            parse_mode="HTML"
        )

async def shop_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    data = query.data
    user_id = str(query.from_user.id)
    username = query.from_user.username or "–ë–µ–∑ username"

    unavailable = ["–º–∞–π–Ω–∏–Ω–≥"]

    if data.startswith("shop_cat_"):
        parts = data.split("|")
        cat = parts[0][len("shop_cat_"):]
        page = int(parts[1]) if len(parts) > 1 else 1

        if cat in unavailable:
            await query.answer("‚ùå –ö–∞—Ç–µ–≥–æ—Ä–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ!", show_alert=True)
            return

        if cat not in PRODUCTS or not PRODUCTS[cat]:
            await query.answer("‚ùå –ö–∞—Ç–µ–≥–æ—Ä–∏—è –ø—É—Å—Ç–∞", show_alert=True)
            return

        total_items = len(PRODUCTS[cat])
        total_pages = (total_items - 1) // ITEMS_PER_PAGE + 1
        start = (page - 1) * ITEMS_PER_PAGE
        products_page = PRODUCTS[cat][start:start + ITEMS_PER_PAGE]

        cat_emoji = {
            "–º–∞—à–∏–Ω—ã": "üöó", "—è—Ö—Ç—ã": "üõ•", "–ø–∏—Ç–æ–º—Ü—ã": "üêï",
            "–¥–æ–º–∞": "üè†", "—Ç–µ–ª–µ—Ñ–æ–Ω—ã": "üì±"
        }.get(cat, "üõç")

        keyboard = [
            [InlineKeyboardButton(
                f"{cat_emoji} {product['name']}  ‚Ä¢  {product['price']:,} ‚ÇΩ",
                callback_data=f"shop_buy_{cat}_{start + i}"
            )]
            for i, product in enumerate(products_page)
        ]

        nav_buttons = []
        if page > 1:
            nav_buttons.append(InlineKeyboardButton("‚óÄÔ∏è", callback_data=f"shop_cat_{cat}|{page - 1}"))
        nav_buttons.append(InlineKeyboardButton(f"¬∑ {page} / {total_pages} ¬∑", callback_data="noop"))
        if page < total_pages:
            nav_buttons.append(InlineKeyboardButton("‚ñ∂Ô∏è", callback_data=f"shop_cat_{cat}|{page + 1}"))

        keyboard.append(nav_buttons)
        keyboard.append([InlineKeyboardButton("üè¨ –í –º–∞–≥–∞–∑–∏–Ω", callback_data="shop_back")])

        caption = (
            f"{cat_emoji} <b>{cat.capitalize()}</b>\n"
            "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
            f"üì¶ –¢–æ–≤–∞—Ä–æ–≤: {total_items}  ‚Ä¢  –°—Ç—Ä. {page}/{total_pages}\n"
            "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
            "üëá <i>–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä:</i>"
        )

        await query.edit_message_caption(caption, reply_markup=InlineKeyboardMarkup(keyboard), parse_mode="HTML")
        return

    elif data == "shop_back":
        keyboard = [
            [
                InlineKeyboardButton("üöó –ú–∞—à–∏–Ω—ã", callback_data="shop_cat_–º–∞—à–∏–Ω—ã|1"),
                InlineKeyboardButton("üõ• –Ø—Ö—Ç—ã", callback_data="shop_cat_—è—Ö—Ç—ã|1"),
            ],
            [
                InlineKeyboardButton("üêï –ü–∏—Ç–æ–º—Ü—ã", callback_data="shop_cat_–ø–∏—Ç–æ–º—Ü—ã|1"),
                InlineKeyboardButton("üè† –î–æ–º–∞", callback_data="shop_cat_–¥–æ–º–∞|1"),
            ],
            [
                InlineKeyboardButton("üì± –¢–µ–ª–µ—Ñ–æ–Ω—ã", callback_data="shop_cat_—Ç–µ–ª–µ—Ñ–æ–Ω—ã|1"),
            ],
        ]
        caption = (
            "üè¨ <b>–ò–≥—Ä–æ–≤–æ–π –ú–∞–≥–∞–∑–∏–Ω</b>\n"
            "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
            "üëá <i>–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é:</i>"
        )
        await query.edit_message_caption(caption, reply_markup=InlineKeyboardMarkup(keyboard), parse_mode="HTML")
        return

    elif data.startswith("shop_buy_"):
        parts = data.split("_")
        cat = parts[2]
        idx = int(parts[3])

        if cat not in PRODUCTS or idx >= len(PRODUCTS[cat]):
            await query.answer("‚ùå –¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω", show_alert=True)
            return

        product = PRODUCTS[cat][idx]
        inventory_field = {
            "–º–∞—à–∏–Ω—ã": "inventory_car",
            "—è—Ö—Ç—ã": "inventory_yacht",
            "–¥–æ–º–∞": "inventory_home",
            "—Ç–µ–ª–µ—Ñ–æ–Ω—ã": "inventory_phone",
            "–ø–∏—Ç–æ–º—Ü—ã": "inventory_pet",
        }.get(cat)

        if inventory_field is None:
            await query.answer("‚ùå –û—à–∏–±–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏", show_alert=True)
            return

        get_or_create_user(user_id, username)
        success, message = update_user_inventory(user_id, inventory_field, product["name"], product["price"])

        if success:
            user_data = get_or_create_user(user_id, username)
            balance = user_data[0]
            cat_emoji = {
                "–º–∞—à–∏–Ω—ã": "üöó", "—è—Ö—Ç—ã": "üõ•", "–ø–∏—Ç–æ–º—Ü—ã": "üêï",
                "–¥–æ–º–∞": "üè†", "—Ç–µ–ª–µ—Ñ–æ–Ω—ã": "üì±"
            }.get(cat, "üõç")

            caption = (
                "‚úÖ <b>–ü–æ–∫—É–ø–∫–∞ —Å–æ–≤–µ—Ä—à–µ–Ω–∞!</b>\n"
                "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
                f"{cat_emoji} <b>{product['name']}</b>\n"
                f"üí∏ –¶–µ–Ω–∞: <b>{product['price']:,} ‚ÇΩ</b>\n"
                f"üí∞ –û—Å—Ç–∞—Ç–æ–∫: <b>{balance:,} ‚ÇΩ</b>\n"
                "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            )
            keyboard = [[InlineKeyboardButton("üè¨ –í –º–∞–≥–∞–∑–∏–Ω", callback_data="shop_back")]]
            await query.edit_message_caption(caption, reply_markup=InlineKeyboardMarkup(keyboard), parse_mode="HTML")
        else:
            await query.answer(f"‚ùå {message}", show_alert=True)
        return

    else:
        await query.answer()

def sell_user_inventory(user_id, category):
    category_map = {
        "–º–∞—à–∏–Ω–∞": ("inventory_car", PRODUCTS.get("–º–∞—à–∏–Ω—ã", [])),
        "—è—Ö—Ç–∞": ("inventory_yacht", PRODUCTS.get("—è—Ö—Ç—ã", [])),
        "–¥–æ–º": ("inventory_home", PRODUCTS.get("–¥–æ–º–∞", [])),
        "–ø–∏—Ç–æ–º—Ü—ã": ("inventory_pet", PRODUCTS.get("–ø–∏—Ç–æ–º—Ü—ã", [])),
        "—Ç–µ–ª–µ—Ñ–æ–Ω": ("inventory_phone", PRODUCTS.get("—Ç–µ–ª–µ—Ñ–æ–Ω—ã", [])),
    }

    inventory_field, product_list = category_map[category]

    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute(f"SELECT balance, {inventory_field} FROM users WHERE user_id = ?", (user_id,))
    row = cursor.fetchone()
    if not row:
        conn.close()
        return False, "‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ."

    balance, inventory = row
    if not inventory:
        conn.close()
        return False, f"üö´ –£ –≤–∞—Å –Ω–µ—Ç –Ω–∏ –æ–¥–Ω–æ–≥–æ –ø—Ä–µ–¥–º–µ—Ç–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ¬´{category}¬ª."

    items = [item.strip() for item in inventory.split(",") if item.strip()]
    if not items:
        conn.close()
        return False, f"üö´ –í–∞—à –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ¬´{category}¬ª –ø—É—Å—Ç."

    item_to_sell = items[0]

    product = next((p for p in product_list if p["name"].lower() == item_to_sell.lower()), None)
    if product is None:
        conn.close()
        return False, "‚ö†Ô∏è –û—à–∏–±–∫–∞: –ø—Ä–µ–¥–º–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–ø–∏—Å–∫–µ —Ç–æ–≤–∞—Ä–æ–≤."

    sell_price = int(product["price"] * 0.8)

    items.remove(item_to_sell)
    new_inventory = ",".join(items)

    new_balance = balance + sell_price

    cursor.execute(
        f"UPDATE users SET balance = ?, {inventory_field} = ? WHERE user_id = ?",
        (new_balance, new_inventory, user_id)
    )
    conn.commit()
    conn.close()

    logging.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –ø—Ä–æ–¥–∞–ª {item_to_sell} –∑–∞ {sell_price} (–±–∞–ª–∞–Ω—Å: {balance} ‚Üí {new_balance})")
    return True, (
        f"üì¶ <b>–ü—Ä–µ–¥–º–µ—Ç:</b> <i>¬´{item_to_sell}¬ª</i>\n"
        f"üí∞ <b>–¶–µ–Ω–∞:</b> <code>{sell_price}</code> –º–æ–Ω–µ—Ç\n"
        f"üè¶ <b>–ë–∞–ª–∞–Ω—Å:</b> <code>{new_balance}</code> üí∞"
    )


async def sell_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = str(update.effective_user.id)
    message_text = update.message.text.strip()

    parts = message_text.split(maxsplit=1)
    if len(parts) < 2:
        await update.message.reply_text(
            "‚ö†Ô∏è <b>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã:</b>\n"
            "‚û§ <code>/–ø—Ä–æ–¥–∞—Ç—å &lt;–∫–∞—Ç–µ–≥–æ—Ä–∏—è&gt;</code>\n\n"
            "üöó <b>–ü—Ä–∏–º–µ—Ä—ã:</b>\n"
            "  –ø—Ä–æ–¥–∞—Ç—å –º–∞—à–∏–Ω–∞\n"
            "  –ø—Ä–æ–¥–∞—Ç—å —è—Ö—Ç–∞\n"
            "  –ø—Ä–æ–¥–∞—Ç—å –¥–æ–º\n"
            "  –ø—Ä–æ–¥–∞—Ç—å –ø–∏—Ç–æ–º—Ü—ã\n"
            "–∏ —Ç.–¥\n\n"
            "<i>–í—ã –ø–æ–ª—É—á–∏—Ç–µ <b>80%</b> –æ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –ø—Ä–µ–¥–º–µ—Ç–∞ –≤ –º–∞–≥–∞–∑–∏–Ω–µ.</i>",
            parse_mode=ParseMode.HTML
        )
        return

    category = parts[1].lower().strip()

    # --- –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—é ---
    valid_categories = ["–º–∞—à–∏–Ω–∞", "—è—Ö—Ç–∞", "–¥–æ–º", "–ø–∏—Ç–æ–º—Ü—ã", "—Ç–µ–ª–µ—Ñ–æ–Ω"]
    if category not in valid_categories:
        await update.message.reply_text(
            f"‚ùå –ö–∞—Ç–µ–≥–æ—Ä–∏—è ¬´{category}¬ª –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.\n"
            f"–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏: {', '.join(valid_categories)}",
            parse_mode=ParseMode.HTML
        )
        return

    success, message = sell_user_inventory(user_id, category)

    if success:
        await update.message.reply_text(
            f"‚úÖ <b>–ü—Ä–æ–¥–∞–∂–∞ —É—Å–ø–µ—à–Ω–∞!</b>\n\n{message}",
            parse_mode=ParseMode.HTML
        )
    else:
        await update.message.reply_text(
            f"‚ùå <b>–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–¥–∞–∂–µ:</b>\n\n"
            f"‚ö†Ô∏è {message}\n\n"
            "üõ† –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏ –Ω–∞–ª–∏—á–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞ –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ.",
            parse_mode=ParseMode.HTML
        )

async def business_distributor(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = str(update.effective_user.id)
    message_text = update.message.text.strip()
    args = message_text.split()

    # –ö–æ–º–∞–Ω–¥–∞ –±–µ–∑ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤: /–±–∏–∑–Ω–µ—Å
    if len(args) == 1:
        await business_info(update, context)
        return

    # –ö–æ–º–∞–Ω–¥–∞ —Å –∞—Ä–≥—É–º–µ–Ω—Ç–∞–º–∏
    if len(args) >= 2:
        command = args[1].lower()

        if command == "–º–∞–≥–∞–∑":
            await bshop(update, context)
            return
        elif command == "–±–æ–Ω—É—Å":
            await bbonus(update, context)
            return
        elif command == "–ø—Ä–∏–±—ã–ª—å":
            await business_profit(update, context)
            return
        elif command == "—É–ª—É—á—à–µ–Ω–∏–µ":
            await business_upgrade(update, context)
            return
        elif command == "–ø—Ä–æ–¥–∞—Ç—å":
            await business_sell(update, context)
            return
        else:
            await update.message.reply_text(
                "üì¶ *–ö–æ–º–∞–Ω–¥—ã –¥–ª—è –±–∏–∑–Ω–µ—Å–∞:*\n\n"
                "üßæ `–ë–∏–∑–Ω–µ—Å` ‚Äî –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–∏–∑–Ω–µ—Å–µ\n"
                "üõç `–ë–∏–∑–Ω–µ—Å –º–∞–≥–∞–∑` ‚Äî –æ—Ç–∫—Ä—ã—Ç—å –º–∞–≥–∞–∑–∏–Ω –±–∏–∑–Ω–µ—Å–æ–≤\n"
                "üéÅ `–ë–∏–∑–Ω–µ—Å –±–æ–Ω—É—Å` ‚Äî –ø–æ–ª—É—á–∏—Ç—å –±–æ–Ω—É—Å (—Ä–∞–∑ –≤ 12—á)\n"
                "üí∏ `–ë–∏–∑–Ω–µ—Å –ø—Ä–∏–±—ã–ª—å` ‚Äî –∑–∞–±—Ä–∞—Ç—å –ø—Ä–∏–±—ã–ª—å –±–∏–∑–Ω–µ—Å–∞\n"
                "üìà `–ë–∏–∑–Ω–µ—Å —É–ª—É—á—à–µ–Ω–∏–µ` ‚Äî —É–ª—É—á—à–∏—Ç—å –±–∏–∑–Ω–µ—Å\n"
                "üóë `–ë–∏–∑–Ω–µ—Å –ø—Ä–æ–¥–∞—Ç—å` ‚Äî –ø—Ä–æ–¥–∞—Ç—å –±–∏–∑–Ω–µ—Å\n\n"
                "‚ùó –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –ø–æ–¥–∫–æ–º–∞–Ω–¥–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.",
                parse_mode="Markdown"
            )
            return

    await business_info(update, context)


async def business_distributor_tehwork(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(
        "üõ†Ô∏è‚öôÔ∏è *–¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ* ‚öôÔ∏èüõ†Ô∏è\n\n"
        "üöß –≠—Ç–æ—Ç —Ä–∞–∑–¥–µ–ª –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.\n"
        "‚è≥ –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≥–ª—è–Ω–∏—Ç–µ —á—É—Ç—å –ø–æ–∑–∂–µ ‚Äî –º—ã —É–∂–µ —Ä–∞–±–æ—Ç–∞–µ–º –Ω–∞–¥ —É–ª—É—á—à–µ–Ω–∏–µ–º! üí°",
        parse_mode="Markdown"
    )
    return


def get_top_charity():
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("""
        SELECT user_id, username, SUM(CAST(donation_amount AS REAL)) as total_donated
        FROM charity
        GROUP BY user_id
        ORDER BY total_donated DESC
        LIMIT 5
    """)
    rows = cursor.fetchall()
    conn.close()

    # –ü–µ—Ä–µ–≤–æ–¥–∏–º —Å—É–º–º—ã –≤ Decimal –¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏
    users = []
    for user_id, username, total in rows:
        total_decimal = Decimal(str(total)) if total is not None else Decimal(0)
        users.append((user_id, username, total_decimal))
    return users


async def top_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.message.from_user
    user_id = str(user.id)
    first_name = user.first_name or ""

    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute(
        "UPDATE users SET first_name = ? WHERE user_id = ? AND (first_name IS NULL OR first_name = '')",
        (first_name, user_id)
    )
    conn.commit()
    conn.close()

    keyboard = [
        [
            InlineKeyboardButton("üí∞ –ë–∞–ª–∞–Ω—Å ‚ÇΩ", callback_data="top_balance"),
            InlineKeyboardButton("üìà –£—Ä–æ–≤–µ–Ω—å", callback_data="top_level")
        ],
        [
            InlineKeyboardButton("üí∞ DigitalCoins", callback_data="top_dc_balance"),
            InlineKeyboardButton("üí¨ –°–æ–æ–±—â–µ–Ω–∏—è", callback_data="top_messages_menu")
        ],
        [
            InlineKeyboardButton("üíñ –ë–ª–∞–≥–æ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å", callback_data="top_charity")
        ]
    ]

    markup = InlineKeyboardMarkup(keyboard)
    await update.message.reply_text(
        "üèÜ <b>–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–ø, –∫–æ—Ç–æ—Ä—ã–π —Ö–æ—Ç–∏—Ç–µ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å:</b>",
        reply_markup=markup,
        parse_mode="HTML"
    )


def get_top_users_by(field: str):
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    if field == "level":
        cursor.execute("""
            SELECT user_id, first_name, exp, (CAST(exp / 100 AS INTEGER) + 1) AS level_calc
            FROM users
            ORDER BY level_calc DESC
            LIMIT 5
        """)
        users = cursor.fetchall()
    else:
        cursor.execute(f"""
            SELECT user_id, first_name, {field}
            FROM users
            ORDER BY CAST({field} AS INTEGER) DESC
            LIMIT 5
        """)
        users = cursor.fetchall()
    conn.close()
    return users


# --- –†–∞–±–æ—Ç–∞ —Å —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ ---

SMS_FILE_GLOBAL = "SMSChat.json"
SMS_FILE_CHATS = "SMSChatChats.json"


def load_sms_data_global():
    if os.path.exists(SMS_FILE_GLOBAL):
        with open(SMS_FILE_GLOBAL, "r") as f:
            return json.load(f)
    return {}


def load_sms_data_chats():
    if os.path.exists(SMS_FILE_CHATS):
        with open(SMS_FILE_CHATS, "r") as f:
            return json.load(f)
    return {}


async def get_top_messages_global():
    data = load_sms_data_global()
    if not data:
        return "–ü–æ–∫–∞ —á—Ç–æ –Ω–∏–∫—Ç–æ –Ω–µ –ø–∏—Å–∞–ª —Å–æ–æ–±—â–µ–Ω–∏–π."

    top_users = sorted(data.items(), key=lambda x: x[1]["messages"], reverse=True)[:5]
    msg = "üåê <b>–ì–ª–æ–±–∞–ª—å–Ω—ã–π –¢–æ–ø 5 –ø–æ —Å–æ–æ–±—â–µ–Ω–∏—è–º:</b>\n\n"
    for idx, (user_id, info) in enumerate(top_users, 1):
        user_obj = User(
            id=int(user_id),
            first_name=info.get("first_name", info.get("name", "")),
            last_name=info.get("last_name", ""),
            is_bot=False
        )
        display_html = get_display_name_html_new(user_obj)
        msg += f"{idx}. {display_html} ‚Äî <b>{info['messages']}</b> —Å–æ–æ–±—â–µ–Ω–∏–π\n"
    return msg


async def get_top_messages_local(chat_id: str):
    data = load_sms_data_chats()
    if chat_id not in data or not data[chat_id]:
        return "–í —ç—Ç–æ–º —á–∞—Ç–µ –ø–æ–∫–∞ –Ω–∏–∫—Ç–æ –Ω–µ –ø–∏—Å–∞–ª —Å–æ–æ–±—â–µ–Ω–∏–π."

    top_users = sorted(data[chat_id].items(), key=lambda x: x[1]["messages"], reverse=True)[:5]
    msg = "üè† <b>–¢–æ–ø 5 —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —ç—Ç–æ–º —á–∞—Ç–µ:</b>\n\n"
    for idx, (user_id, info) in enumerate(top_users, 1):
        user_obj = User(
            id=int(user_id),
            first_name=info.get("first_name", info.get("name", "")),
            last_name=info.get("last_name", ""),
            is_bot=False
        )
        display_html = get_display_name_html_new(user_obj)
        msg += f"{idx}. {display_html} ‚Äî <b>{info['messages']}</b> —Å–æ–æ–±—â–µ–Ω–∏–π\n"
    return msg


# --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–ª–±—ç–∫–æ–≤ ---

async def top_callback_handler(update, context):
    query = update.callback_query
    await query.answer()
    data = query.data

    if data == "top_balance":
        users = get_top_users_by("balance")  # –í–µ—Ä–Ω–∏ [(user_id, first_name, balance), ...]
        title = "üíé <b><u>–¢–û–ü-5 –ë–û–ì–ê–¢–ï–ô–®–ò–•</u></b>\n\n"
        medals = ["ü•á", "ü•à", "ü•â", "‚ú®", "üåü"]

        lines = []
        for i, (user_id, first_name, value) in enumerate(users):
            if value <= 0:
                continue
            value_str = f"{value:,}".replace(",", ".")
            user_obj = User(id=int(user_id), first_name=first_name or "", last_name="", is_bot=False)
            display_name = get_display_name_html_new(user_obj)

            lines.append(
                f"{medals[i]} {display_name}\n"
                f"üÜî <code>{user_id}</code>\n"
                f"üí∞ –ë–∞–ª–∞–Ω—Å: <b><u>{value_str}</u></b>\n"
                f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
            )
        text = title + ("".join(lines) if lines else "üòï <i>–ü–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è...</i>")

    elif data == "top_level":
        users = get_top_users_by("level")
        title = "üöÄ <b><u>–¢–û–ü-5 –ü–û –£–†–û–í–ù–Æ</u></b>\n\n"
        medals = ["üëë", "‚öîÔ∏è", "üõ°", "üéØ", "üìà"]

        lines = []
        for i, (user_id, first_name, exp, level_calc) in enumerate(users):
            if user_id is None or level_calc < 1:  # ‚Üê –î–û–ë–ê–í–¨ –ü–†–û–í–ï–†–ö–£
                continue
            value_str = f"{level_calc:,}".replace(",", ".")
            user_obj = User(id=int(user_id), first_name=first_name or "", last_name="", is_bot=False)
            display_name = get_display_name_html_new(user_obj)

            lines.append(
                f"{medals[i]} {display_name}\n"
                f"üÜî <code>{user_id}</code>\n"
                f"üèÜ –£—Ä–æ–≤–µ–Ω—å: <b><u>{value_str}</u></b>\n"
                f"üí° EXP: {exp}\n"
                f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
            )
        text = title + ("".join(lines) if lines else "üòï <i>–ü–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è...</i>")

    elif data == "top_charity":
        users = get_top_charity()
        title = "üíñ <b><u>–¢–û–ü-5 –ë–õ–ê–ì–û–¢–í–û–†–ò–¢–ï–õ–ï–ô</u></b>\n\n"
        medals = ["ü•á", "ü•à", "ü•â", "‚ú®", "üåü"]

        lines = []
        for i, (user_id, username, total_donated) in enumerate(users):
            user_obj = User(id=int(user_id), first_name=username or "", last_name="", is_bot=False)
            display_name = get_display_name_html_new(user_obj)

            # –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º Decimal –≤ –∫—Ä–∞—Å–∏–≤—É—é —Å—Ç—Ä–æ–∫—É
            value_str = f"{int(total_donated):,}".replace(",", ".")

            lines.append(
                f"{medals[i]} {display_name}\n"
                f"üÜî <code>{user_id}</code>\n"
                f"üíñ –ü–æ–∂–µ—Ä—Ç–≤–æ–≤–∞–Ω–æ: <b><u>{value_str}</u></b>\n"
                f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
            )

        text = title + ("".join(lines) if lines else "üòï <i>–ü–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è...</i>")

        keyboard = [[InlineKeyboardButton("‚¨Ö –ù–∞–∑–∞–¥", callback_data="back_to_top_menu")]]
        markup = InlineKeyboardMarkup(keyboard)

        try:
            await query.edit_message_text(
                text=text,
                reply_markup=markup,
                parse_mode="HTML"
            )
        except BadRequest as e:
            if "Message is not modified" in str(e):
                pass
            else:
                raise


    elif data == "top_dc_balance":
        users = get_top_users_by("dc_balance")  # —Ç–æ–ø –ø–æ DigitalCoins
        title = "üí∞ <b><u>–¢–û–ü-5 –ü–û DigitalCoins</u></b>\n\n"
        medals = ["ü•á", "ü•à", "ü•â", "‚ú®", "üåü"]

        lines = []
        for i, (user_id, first_name, value) in enumerate(users):
            if value <= 0:
                continue
            value_str = f"{value:,}".replace(",", ".")
            user_obj = User(id=int(user_id), first_name=first_name or "", last_name="", is_bot=False)
            display_name = get_display_name_html_new(user_obj)

            lines.append(
                f"{medals[i]} {display_name}\n"
                f"üÜî <code>{user_id}</code>\n"
                f"üí∞ DigitalCoins: <b><u>{value_str}</u></b>\n"
                f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
            )
        text = title + ("".join(lines) if lines else "üòï <i>–ü–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è...</i>")

    elif data == "top_messages_menu":
        keyboard = [
            [InlineKeyboardButton("üåê –ì–ª–æ–±–∞–ª—å–Ω—ã–π", callback_data="top_messages_global")],
            [InlineKeyboardButton("üè† –õ–æ–∫–∞–ª—å–Ω—ã–π", callback_data="top_messages_local")],
            [InlineKeyboardButton("‚¨Ö –ù–∞–∑–∞–¥", callback_data="back_to_top_menu")]
        ]
        markup = InlineKeyboardMarkup(keyboard)
        await query.edit_message_text(
            "üèÜ <b>–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –¥–ª—è –ø–æ—Å–º–æ—Ç—Ä–∞:</b>",
            reply_markup=markup,
            parse_mode="HTML"
        )
        return

    elif data == "top_messages_global":
        msg = await get_top_messages_global()
        keyboard = [[InlineKeyboardButton("‚¨Ö –ù–∞–∑–∞–¥", callback_data="top_messages_menu")]]
        markup = InlineKeyboardMarkup(keyboard)
        await query.edit_message_text(
            msg,
            reply_markup=markup,
            parse_mode="HTML"
        )
        return

    elif data == "top_messages_local":
        chat_id = str(update.effective_chat.id)
        msg = await get_top_messages_local(chat_id)
        keyboard = [[InlineKeyboardButton("‚¨Ö –ù–∞–∑–∞–¥", callback_data="top_messages_menu")]]
        markup = InlineKeyboardMarkup(keyboard)
        await query.edit_message_text(
            msg,
            reply_markup=markup,
            parse_mode="HTML"
        )
        return

    elif data == "back_to_top_menu":
        keyboard = [
            [
                InlineKeyboardButton("üí∞ –ë–∞–ª–∞–Ω—Å ‚ÇΩ", callback_data="top_balance"),
                InlineKeyboardButton("üìà –£—Ä–æ–≤–µ–Ω—å", callback_data="top_level")
            ],
            [
                InlineKeyboardButton("üí∞ DigitalCoins", callback_data="top_dc_balance"),
                InlineKeyboardButton("üí¨ –°–æ–æ–±—â–µ–Ω–∏—è", callback_data="top_messages_menu")
            ],
            [
                InlineKeyboardButton("üíñ –ë–ª–∞–≥–æ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å", callback_data="top_charity")
            ]
        ]

        markup = InlineKeyboardMarkup(keyboard)
        await query.edit_message_text(
            "üèÜ <b>–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–ø, –∫–æ—Ç–æ—Ä—ã–π —Ö–æ—Ç–∏—Ç–µ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å:</b>",
            reply_markup=markup,
            parse_mode="HTML"
        )
        return

    else:
        await query.answer("–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞", show_alert=True)
        return

    # –û—Ç–æ–±—Ä–∞–∑–∏—Ç—å —Ç–æ–ø (–±–∞–ª–∞–Ω—Å –∏–ª–∏ —É—Ä–æ–≤–µ–Ω—å)
    keyboard = [[InlineKeyboardButton("‚¨Ö –ù–∞–∑–∞–¥", callback_data="back_to_top_menu")]]
    markup = InlineKeyboardMarkup(keyboard)

    await query.edit_message_text(
        text=text,
        reply_markup=markup,
        parse_mode="HTML"
    )


COOLDOWN_SECONDS = 60 * 60  # 1 —á–∞—Å –≤ —Å–µ–∫—É–Ω–¥–∞—Ö


def get_user_last_farm(user_id: str) -> int:
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT last_farm FROM users WHERE user_id = ?", (user_id,))
    row = cursor.fetchone()
    conn.close()
    return row[0] if row and row[0] else 0


def update_user_last_farm(user_id: str, timestamp: int):
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("UPDATE users SET last_farm = ? WHERE user_id = ?", (timestamp, user_id))
    conn.commit()
    conn.close()


def update_user_seeds(user_id: str, new_seeds: int):
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("UPDATE users SET seeds = seeds + ? WHERE user_id = ?", (new_seeds, user_id))
    conn.commit()
    conn.close()

CHANNEL_USERNAME = "FernieX"

async def farm(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = str(update.effective_user.id)

    # --- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ –∫–∞–Ω–∞–ª ---
    try:
        member = await context.bot.get_chat_member(f"@{CHANNEL_USERNAME}", user_id)
        if member.status not in ("member", "administrator", "creator"):
            await update.message.reply_text(
                "‚ùå –î–ª—è —Ä–∞–±–æ—Ç—ã –Ω–∞ —Ñ–µ—Ä–º–µ, –Ω—É–∂–Ω–æ –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –∫–∞–Ω–∞–ª:\n"
                f"https://t.me/{CHANNEL_USERNAME}"
            )
            return
    except Exception:
        await update.message.reply_text(
            "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É."
        )
        return

    # --- –ú–µ—Ö–∞–Ω–∏–∫–∞ —Ñ–µ—Ä–º—ã ---
    user_id_int = int(user_id)
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT 1 FROM users WHERE user_id = ?", (user_id,))
    if not cursor.fetchone():
        cursor.execute(
            "INSERT INTO users (user_id, username, last_farm) VALUES (?, ?, ?)",
            (user_id, update.effective_user.username or "", 0)
        )
        conn.commit()
    conn.close()

    now = int(time.time())
    last_farm = get_user_last_farm(user_id)
    time_passed = now - last_farm
    if time_passed < COOLDOWN_SECONDS:
        remaining = COOLDOWN_SECONDS - time_passed
        minutes = remaining // 60
        seconds = remaining % 60
        await update.message.reply_text(
            f"‚ùå –ù–ï–ó–ê–ß–Å–¢!\n"
            f"–§–∞—Ä–º–∏—Ç—å –º–æ–∂–Ω–æ —Ä–∞–∑ –≤ 1 —á–∞—Å.\n"
            f"–°–ª–µ–¥—É—é—â–∞—è –¥–æ–±—ã—á–∞ —á–µ—Ä–µ–∑ {minutes} –º–∏–Ω—É—Ç {seconds} —Å–µ–∫"
        )
        return

    rand1 = random.randint(1, 9)
    rand2 = random.randint(1, 9)
    rand100 = random.randint(1, 100)
    product = rand1 * rand2
    total_seeds = product + rand100

    update_user_seeds(user_id, total_seeds)
    update_user_last_farm(user_id, now)

    message = (
        f"‚úÖ –ó–ê–ß–Å–¢! ‚ò¢Ô∏è +{rand100} i¬¢ = {rand1}√ó{rand2}\n\n"
        f"–ü–æ–ª—É—á–µ–Ω–æ: {total_seeds} —Å–µ–º—è–Ω"
    )

    await update.message.reply_text(message)

def get_taxi_info(user_id, username):
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute(
        "SELECT user_id, username, status, rank, points, orders, last_orders FROM taxi_profiles WHERE user_id = ?",
        (user_id,))
    row = cursor.fetchone()
    if row:
        last_orders = json.loads(row[6]) if row[6] else []
        taxi_data = {
            "user_id": row[0],
            "username": row[1],
            "status": row[2],
            "rank": row[3],
            "points": row[4],
            "orders": row[5],
            "last_orders": last_orders
        }
    else:
        taxi_data = {
            "user_id": user_id,
            "username": username,
            "status": 1,
            "rank": "–ù–æ–≤–∏—á–æ–∫",
            "points": 0,
            "orders": 0,
            "last_orders": []
        }
        save_taxi_info(user_id, taxi_data)
    conn.close()
    return taxi_data


def save_taxi_info(user_id, taxi_data):
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    last_orders_json = json.dumps(taxi_data.get("last_orders", []), ensure_ascii=False)
    cursor.execute("""
    INSERT INTO taxi_profiles (user_id, username, status, rank, points, orders, last_orders)
    VALUES (?, ?, ?, ?, ?, ?, ?)
    ON CONFLICT(user_id) DO UPDATE SET
        username=excluded.username,
        status=excluded.status,
        rank=excluded.rank,
        points=excluded.points,
        orders=excluded.orders,
        last_orders=excluded.last_orders
    """, (
        user_id,
        taxi_data.get("username", ""),
        taxi_data.get("status", 1),
        taxi_data.get("rank", "–ù–æ–≤–∏—á–æ–∫"),
        taxi_data.get("points", 0),
        taxi_data.get("orders", 0),
        last_orders_json
    ))
    conn.commit()
    conn.close()


async def complete_taxi_order(user_id, username, rank):
    taxi_data = get_taxi_info(user_id, username)
    now = int(time.time())

    recent_orders = [t for t in taxi_data["last_orders"] if now - t < 300]

    if len(recent_orders) >= 5:
        remaining_seconds = 300 - (now - recent_orders[0])
        remaining_min = round(remaining_seconds / 60, 1)

        message = (
            "‚ùó –í—ã –≤—ã–ø–æ–ª–Ω–∏–ª–∏ 5 –∑–∞–∫–∞–∑–æ–≤ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 –º–∏–Ω—É—Ç.\n\n"
            f"‚è≥ –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ **{remaining_min}** –º–∏–Ω—É—Ç, –ø—Ä–µ–∂–¥–µ —á–µ–º –ø—Ä–∏–Ω–∏–º–∞—Ç—å –Ω–æ–≤—ã–µ –∑–∞–∫–∞–∑—ã."
        )

        keyboard = [
            [InlineKeyboardButton("üöñ –ú–µ–Ω—é —Ç–∞–∫—Å–∏—Å—Ç–∞", callback_data="taxi_start")],
        ]

        return message, InlineKeyboardMarkup(keyboard)

    if rank == "–ù–æ–≤–∏—á–æ–∫":
        coins = random.randint(50, 1000)
        points = random.randint(1, 10)
    elif rank == "–û–ø—ã—Ç–Ω—ã–π":
        coins = random.randint(1000, 6000)
        points = random.randint(3, 13)
    elif rank == "–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª":
        coins = random.randint(6000, 20000)
        points = random.randint(5, 20)
    elif rank == "–≠–ª–∏—Ç–∞":
        coins = random.randint(20000, 50000)
        points = random.randint(20, 50)
    elif rank == "–õ–µ–≥–µ–Ω–¥–∞":
        coins = random.randint(50000, 100000)
        points = random.randint(20, 50)
    else:
        coins = 0
        points = 0

    taxi_data["points"] += points
    taxi_data["orders"] += 1
    taxi_data["last_orders"] = recent_orders + [now]

    prev_rank = taxi_data["rank"]
    new_rank = prev_rank
    new_status = taxi_data["status"]

    if taxi_data["points"] >= 10000:
        new_rank = "–õ–µ–≥–µ–Ω–¥–∞"
        new_status = 5
    elif taxi_data["points"] >= 5000:
        new_rank = "–≠–ª–∏—Ç–∞"
        new_status = 4
    elif taxi_data["points"] >= 1000:
        new_rank = "–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª"
        new_status = 3
    elif taxi_data["points"] >= 500:
        new_rank = "–û–ø—ã—Ç–Ω—ã–π"
        new_status = 2
    else:
        new_rank = "–ù–æ–≤–∏—á–æ–∫"
        new_status = 1

    taxi_data["rank"] = new_rank
    taxi_data["status"] = new_status

    save_taxi_info(user_id, taxi_data)

    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT balance FROM users WHERE user_id = ?", (user_id,))
    user_row = cursor.fetchone()
    if user_row:
        new_balance = user_row[0] + coins
        cursor.execute("UPDATE users SET balance = ? WHERE user_id = ?", (new_balance, user_id))
        conn.commit()
    conn.close()

    message = (
        f"‚úÖ **–ó–∞–∫–∞–∑ –≤—ã–ø–æ–ª–Ω–µ–Ω!**\n\n"
        f"üí∞ –ü–æ–ª—É—á–µ–Ω–æ –º–æ–Ω–µ—Ç: **{coins}**\n"
        f"‚≠ê –ü–æ–ª—É—á–µ–Ω–æ –æ—á–∫–æ–≤: **{points}**\n"
        f"üìä –¢–µ–∫—É—â–∏–π —Ä–µ–π—Ç–∏–Ω–≥: **{taxi_data['points']} –æ—á–∫–æ–≤**\n"
        f"üèÖ –°—Ç–∞—Ç—É—Å: **{taxi_data['rank']}**\n"
        f"üìù –í—Å–µ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤: **{taxi_data['orders']}**\n"
    )

    keyboard = [
        [InlineKeyboardButton("üìà –†–µ–π—Ç–∏–Ω–≥–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞", callback_data="taxi_rating")],
        [InlineKeyboardButton("üöñ –í—ã–ø–æ–ª–Ω–∏—Ç—å –∑–∞–∫–∞–∑", callback_data="taxi_order")],
        [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é", callback_data="taxi_start")]
    ]

    return message, InlineKeyboardMarkup(keyboard)


async def taxi_command(update: Update, context: ContextTypes.DEFAULT_TYPE, from_callback=False):
    user = update.effective_user
    user_id = str(user.id)
    username = user.username or user.first_name

    taxi_data = get_taxi_info(user_id, username)

    message = (
        f"üìäüöñ **–í–∞—à —Ä–µ–π—Ç–∏–Ω–≥:** **{taxi_data['points']} –æ—á–∫–æ–≤**\n"
        f"üèÖ –°—Ç–∞—Ç—É—Å: **{taxi_data['rank']}**\n"
        f"üìù –í—ã–ø–æ–ª–Ω–µ–Ω–æ –∑–∞–∫–∞–∑–æ–≤: **{taxi_data['orders']}**\n"
    )

    keyboard = [
        [InlineKeyboardButton("üìà –†–µ–π—Ç–∏–Ω–≥–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞", callback_data="taxi_rating")],
        [InlineKeyboardButton("üöñ –í—ã–ø–æ–ª–Ω–∏—Ç—å –∑–∞–∫–∞–∑", callback_data="taxi_order")],
    ]
    markup = InlineKeyboardMarkup(keyboard)

    if from_callback:
        await update.callback_query.edit_message_text(message, reply_markup=markup, parse_mode='Markdown')
    else:
        await update.message.reply_text(message, reply_markup=markup, parse_mode='Markdown')

    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    return message, markup


async def taxi_callback_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    user = query.from_user
    user_id = str(user.id)
    username = user.username or user.first_name

    data = query.data

    if data == "taxi_start":
        await taxi_command(update, context, from_callback=True)
    elif data == "taxi_order":
        taxi_data = get_taxi_info(user_id, username)
        msg, kb = await complete_taxi_order(user_id, username, taxi_data["rank"])
        await query.edit_message_text(msg, reply_markup=kb, parse_mode='Markdown')
    elif data == "taxi_rating":
        rating_text = (
            "üéñ **–†–µ–π—Ç–∏–Ω–≥–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ç–∞–∫—Å–∏—Å—Ç–∞:**\n\n"
            "üü¢ 1Ô∏è‚É£ –ù–æ–≤–∏—á–æ–∫ - 0 –æ—á–∫–æ–≤\n"
            "üîµ 2Ô∏è‚É£ –û–ø—ã—Ç–Ω—ã–π - –æ—Ç 500 –æ—á–∫–æ–≤\n"
            "üü° 3Ô∏è‚É£ –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª - –æ—Ç 1000 –æ—á–∫–æ–≤\n"
            "üü† 4Ô∏è‚É£ –≠–ª–∏—Ç–∞ - –æ—Ç 5000 –æ—á–∫–æ–≤\n"
            "üî¥ 5Ô∏è‚É£ –õ–µ–≥–µ–Ω–¥–∞ - –æ—Ç 10000 –æ—á–∫–æ–≤\n"
        )

        keyboard = [
            [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="taxi_start")]
        ]

        await query.edit_message_text(
            rating_text,
            reply_markup=InlineKeyboardMarkup(keyboard),
            parse_mode='Markdown'
        )


# --- –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ë–î –±–∏–∑–Ω–µ—Å–∞ ---

def get_or_cr_user(user_id: str, username: str = "", first_name: str = "") -> dict:
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    cursor.execute("SELECT user_id, username, balance FROM users WHERE user_id=?", (user_id,))
    row = cursor.fetchone()

    if not row:
        # –ï—Å–ª–∏ –Ω–µ—Ç ‚Äî —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º
        cursor.execute(
            "INSERT INTO users (user_id, username, first_name, balance) VALUES (?, ?, ?, ?)",
            (user_id, username, first_name, 0)
        )
        conn.commit()
        row = (user_id, username, 0)

    conn.close()

    return {
        "user_id": row[0],
        "username": row[1],
        "balance": row[2]
    }


def get_user_business(user_id: str):
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT business_name, business_level, business_balance FROM businesses WHERE user_id=?", (user_id,))
    row = cursor.fetchone()
    conn.close()
    if row:
        return {"business_name": row[0], "business_level": row[1], "business_balance": row[2]}
    return None


def set_user_business(user_id: str, business_name: str, business_level=1, business_balance=0):
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    # –í—Å—Ç–∞–≤–ª—è–µ–º –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
    cursor.execute("""
    INSERT INTO businesses (user_id, business_name, business_level, business_balance)
    VALUES (?, ?, ?, ?)
    ON CONFLICT(user_id) DO UPDATE SET
        business_name=excluded.business_name,
        business_level=excluded.business_level,
        business_balance=excluded.business_balance
    """, (user_id, business_name, business_level, business_balance))
    conn.commit()
    conn.close()


def update_user_balance(user_id: str, new_balance: int):
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("UPDATE users SET balance=? WHERE user_id=?", (new_balance, user_id))
    conn.commit()
    conn.close()


# --- –õ–æ–∫–∞–ª—å –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —á–∏—Å–µ–ª ---

locale.setlocale(locale.LC_ALL, '')

# --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /bshop ---
ITEMS_PER_PAGE = 5


def get_user_bisbuycallback(user_id: str):
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT * FROM users WHERE user_id = ?", (user_id,))
    row = cursor.fetchone()

    if row is None:
        conn.close()
        return None

    keys = [desc[0] for desc in cursor.description]
    user_data = dict(zip(keys, row))

    conn.close()
    return user_data


async def show_business_list(update_or_query, context, page=0):
    items = load_items()
    per_page = 5
    total_pages = (len(items) - 1) // per_page + 1
    start = page * per_page
    end = start + per_page
    page_items = items[start:end]

    nav_buttons = []
    if page > 0:
        nav_buttons.append(InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data=f"bshop_page_{page - 1}"))
    if page < total_pages - 1:
        nav_buttons.append(InlineKeyboardButton("–í–ø–µ—Ä—ë–¥ ‚û°Ô∏è", callback_data=f"bshop_page_{page + 1}"))
    keyboard = [nav_buttons] if nav_buttons else []

    for i, item in enumerate(page_items, start=start):
        keyboard.append([
            InlineKeyboardButton(f"{item['name']} - {locale.format_string('%d', item['price'], grouping=True)} ‚ÇΩ",
                                 callback_data=f"buybiz_{i}")
        ])

    reply_markup = InlineKeyboardMarkup(keyboard)
    text = f"üè¢ –í—ã–±–µ—Ä–∏—Ç–µ –±–∏–∑–Ω–µ—Å –¥–ª—è –ø–æ–∫—É–ø–∫–∏ (—Å—Ç—Ä–∞–Ω–∏—Ü–∞ {page + 1} –∏–∑ {total_pages}):"

    if isinstance(update_or_query, Message):
        await update_or_query.reply_text(text, reply_markup=reply_markup, parse_mode="Markdown")
    elif isinstance(update_or_query, CallbackQuery):
        await update_or_query.edit_message_text(text, reply_markup=reply_markup, parse_mode="Markdown")


def get_user_business_data(user_id: str):
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    # –ü–æ–ª—É—á–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    cursor.execute("SELECT * FROM users WHERE user_id = ?", (user_id,))
    user_row = cursor.fetchone()
    if user_row is None:
        conn.close()
        return None

    user_keys = [desc[0] for desc in cursor.description]
    user_data = dict(zip(user_keys, user_row))

    # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –±–∏–∑–Ω–µ—Å–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å) ‚Äî –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: user_id ‚Üí owner_id
    cursor.execute("SELECT * FROM businesses_XUI WHERE owner_id = ?", (user_id,))
    biz_row = cursor.fetchone()
    if biz_row is None:
        biz_data = None
    else:
        biz_keys = [desc[0] for desc in cursor.description]
        biz_data = dict(zip(biz_keys, biz_row))

    conn.close()

    return {"user": user_data, "business": biz_data}


def update_user_business_balance(user_id: str, amount: int) -> int:
    user_id = str(user_id)
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    cursor.execute("SELECT balance FROM users WHERE user_id = ?", (user_id,))
    row = cursor.fetchone()

    if row is None:
        if amount < 0:
            conn.close()
            raise ValueError("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ —É –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.")
        cursor.execute("INSERT INTO users (user_id, balance) VALUES (?, ?)", (user_id, amount))
        conn.commit()
        conn.close()
        return amount

    current_balance = row[0]
    new_balance = current_balance + amount

    if new_balance < 0:
        conn.close()
        raise ValueError("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.")

    cursor.execute("UPDATE users SET balance = ? WHERE user_id = ?", (new_balance, user_id))
    conn.commit()
    conn.close()

    return new_balance


locale.setlocale(locale.LC_ALL, '')  # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ª–æ–∫–∞–ª—å —Å–∏—Å—Ç–µ–º—ã, –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —á–∏—Å–µ–ª


def format_rubles(amount: int) -> str:
    return f"{amount:,}".replace(',', ' ') + "‚ÇΩ"


async def business_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    data = query.data
    user_id = str(query.from_user.id)

    if data.startswith("buybiz_"):
        index = int(data.split("_")[1])
        user_data = get_user_business_data(user_id)
        if not user_data or "user" not in user_data:
            await query.message.reply_text(
                "‚ùó *–í—ã –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –≤ —Å–∏—Å—Ç–µ–º–µ.*\n–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å.",
                parse_mode="Markdown"
            )
            return

        items = load_items()
        if index >= len(items):
            keyboard = [[InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="bshop_page_0")]]
            await query.edit_message_text("‚ö†Ô∏è –û—à–∏–±–∫–∞ –≤—ã–±–æ—Ä–∞! –í—ã–±–µ—Ä–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –±–∏–∑–Ω–µ—Å.",
                                          reply_markup=InlineKeyboardMarkup(keyboard))
            return

        selected_item = items[index]
        price = selected_item["price"]

        keyboard = [[InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="bshop_page_0")]]
        reply_markup = InlineKeyboardMarkup(keyboard)

        user_balance = user_data["user"].get("balance", 0)

        if user_balance < price:
            await query.edit_message_text(
                f"‚ùó *–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤.*\nüíº –ë–∞–ª–∞–Ω—Å: *{format_rubles(user_balance)}*‚ÇΩ\nüí∏ –¶–µ–Ω–∞: *{format_rubles(price)}*‚ÇΩ",
                parse_mode="Markdown",
                reply_markup=reply_markup
            )
            return

        business = user_data.get("business")
        current_business_name = business.get("business_name") if business else ""
        if current_business_name:
            await query.edit_message_text(
                f"‚ùó –£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –±–∏–∑–Ω–µ—Å: {current_business_name}. –ü—Ä–æ–¥–∞–π—Ç–µ –µ–≥–æ —Å–Ω–∞—á–∞–ª–∞.",
                reply_markup=reply_markup
            )
            return

        try:
            new_balance = update_user_business_balance(user_id, -price)
        except ValueError as e:
            await query.edit_message_text(f"‚ùó –û—à–∏–±–∫–∞: {str(e)}", reply_markup=reply_markup)
            return

        set_user_business(user_id, selected_item["name"], business_level=1, business_balance=0)

        await query.edit_message_text(
            f"‚úÖ –ö—É–ø–ª–µ–Ω –±–∏–∑–Ω–µ—Å: __{selected_item['name']}__ –∑–∞ *{format_rubles(price)}*‚ÇΩ\nüí∞ –ù–æ–≤—ã–π –±–∞–ª–∞–Ω—Å: *{format_rubles(new_balance)}*‚ÇΩ",
            parse_mode="Markdown",
            reply_markup=reply_markup
        )

    elif data.startswith("bshop_page_"):
        page = int(data.split("_")[2])
        await show_business_list(query, context, page)


async def business_profit(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if update.callback_query:
        user_id = str(update.callback_query.from_user.id)
        send_func = update.callback_query.message.reply_text
        await update.callback_query.answer()
    else:
        user_id = str(update.message.from_user.id)
        send_func = update.message.reply_text

    data = get_user_business_data(user_id)

    if not data:
        await send_func(
            "‚ùó *–í—ã –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –≤ —Å–∏—Å—Ç–µ–º–µ.*\n–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å.",
            parse_mode="Markdown"
        )
        return

    biz = data.get("business")
    if not biz:
        await send_func(
            "üö´ –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –±–∏–∑–Ω–µ—Å–∞.\n–ü—Ä–∏–æ–±—Ä–µ—Ç–∏—Ç–µ –µ–≥–æ, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å!"
        )
        return

    business_name = biz.get("business_name")
    business_balance = biz.get("business_balance", 0)

    if business_balance <= 0:
        await send_func(
            "‚ùå *–ü—Ä–∏–±—ã–ª—å –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç.*\nüíº *–ë–∞–ª–∞–Ω—Å –±–∏–∑–Ω–µ—Å–∞:* 0",
            parse_mode='Markdown'
        )
        return

    # –û–±–Ω—É–ª—è–µ–º –±–∞–ª–∞–Ω—Å –±–∏–∑–Ω–µ—Å–∞
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("UPDATE businesses SET business_balance=? WHERE user_id=?", (0, user_id))
    conn.commit()
    conn.close()

    # –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∏–±—ã–ª—å –∫ –±–∞–ª–∞–Ω—Å—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    update_user_business_balance(user_id, business_balance)

    # –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    new_data = get_user_business_data(user_id)
    new_balance = new_data["user"].get("balance", 0)

    await send_func(
        (f"üí∞ *–í—ã —Å–Ω—è–ª–∏ –ø—Ä–∏–±—ã–ª—å —Å –±–∏–∑–Ω–µ—Å–∞*\n"
         f"üè¢ –ë–∏–∑–Ω–µ—Å: __{business_name}__\n\n"
         f"üíµ –°–Ω—è—Ç–æ: *{format_balance(business_balance)}*‚ÇΩ\n"
         f"üìà –í–∞—à –±–∞–ª–∞–Ω—Å: *{format_balance(new_balance)}*‚ÇΩ\n"
         f"üè¶ –ë–∞–ª–∞–Ω—Å –±–∏–∑–Ω–µ—Å–∞: *0*‚ÇΩ"),
        parse_mode="Markdown"
    )


async def business_upgrade(update: Update, context: ContextTypes.DEFAULT_TYPE):
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º user_id –∏ —Ñ—É–Ω–∫—Ü–∏—é –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–≤–µ—Ç–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    if update.callback_query:
        user_id = str(update.callback_query.from_user.id)
        send_func = update.callback_query.message.reply_text
        await update.callback_query.answer()  # –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –æ—Ç–≤–µ—á–∞–µ–º –Ω–∞ callback_query, —á—Ç–æ–±—ã —É–±—Ä–∞—Ç—å "—á–∞—Å–∏–∫–∏"
    else:
        user_id = str(update.message.from_user.id)
        send_func = update.message.reply_text

    data = get_user_business_data(user_id)
    if not data or not data["user"]:
        await send_func(
            "‚ùó *–í—ã –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –≤ —Å–∏—Å—Ç–µ–º–µ.*\n"
            "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å, —á—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –±–∏–∑–Ω–µ—Å–æ–º.",
            parse_mode="Markdown"
        )
        return

    biz = data["business"]
    if not biz or not biz["business_name"]:
        await send_func(
            "‚ÑπÔ∏è –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –±–∏–∑–Ω–µ—Å–∞ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è. \n–ü—Ä–∏–æ–±—Ä–µ—Ç–∏—Ç–µ –±–∏–∑–Ω–µ—Å, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å.",
            parse_mode='Markdown'
        )
        return

    user_balance = data["user"]["balance"]
    business_name = biz["business_name"]
    current_level = biz["business_level"]

    max_level = max(business_profits.get(business_name, {}).keys()) if business_name in business_profits else 10

    if current_level >= max_level:
        await send_func("üèÜ –í–∞—à –±–∏–∑–Ω–µ—Å —É–∂–µ –¥–æ—Å—Ç–∏–≥ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ —É—Ä–æ–≤–Ω—è!",
                        parse_mode='Markdown')
        return

    items = load_items()
    biz_price = next((item["price"] for item in items if item["name"] == business_name), None)
    if not biz_price:
        await send_func(
            "‚ö†Ô∏è *–û—à–∏–±–∫–∞:* \n"
            "–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å –≤–∞—à–µ–≥–æ –±–∏–∑–Ω–µ—Å–∞. \n"
            "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.",
            parse_mode='Markdown')
        return

    upgrade_price = int(biz_price * 0.05 * current_level)

    if user_balance < upgrade_price:
        await send_func(
            f"‚ùó –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –±–∏–∑–Ω–µ—Å–∞.\n"
            f"–í–∞—à –±–∞–ª–∞–Ω—Å: {locale.format_string('%d', user_balance, grouping=True)}‚ÇΩ\n"
            f"–°—Ç–æ–∏–º–æ—Å—Ç—å —É–ª—É—á—à–µ–Ω–∏—è: {locale.format_string('%d', upgrade_price, grouping=True)}‚ÇΩ"
        )
        return

    # —Å–ø–∏—Å—ã–≤–∞–µ–º –¥–µ–Ω—å–≥–∏
    try:
        new_balance = update_user_business_balance(user_id, -upgrade_price)
    except ValueError as e:
        await send_func(f"‚ùó –û—à–∏–±–∫–∞: {str(e)}")
        return

    # –ø–æ–≤—ã—à–∞–µ–º —É—Ä–æ–≤–µ–Ω—å
    set_user_business(user_id, business_name, business_level=current_level + 1,
                      business_balance=biz["business_balance"])

    await send_func(
        f"‚úÖ *–ë–∏–∑–Ω–µ—Å* __{business_name}__ *—É–ª—É—á—à–µ–Ω –¥–æ —É—Ä–æ–≤–Ω—è* *{current_level + 1}*!\n"
        f"üí∏ –°—Ç–æ–∏–º–æ—Å—Ç—å —É–ª—É—á—à–µ–Ω–∏—è: *{locale.format_string('%d', upgrade_price, grouping=True)}*‚ÇΩ\n"
        f"üí∞ –í–∞—à –Ω–æ–≤—ã–π –±–∞–ª–∞–Ω—Å: *{locale.format_string('%d', new_balance, grouping=True)}*‚ÇΩ",
        parse_mode="Markdown"
    )

async def business_sell(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if update.callback_query:
        query = update.callback_query
        user_id = str(query.from_user.id)
        message = query.message
        callback_data = query.data
        await query.answer()
    else:
        user_id = str(update.message.from_user.id)
        message = update.message
        callback_data = ""

    # –ü–µ—Ä–≤—ã–π —à–∞–≥ ‚Äî –Ω–∞–∂–∞—Ç–∞ –∫–Ω–æ–ø–∫–∞ "–ü—Ä–æ–¥–∞—Ç—å" –∏–∑ –º–µ–Ω—é –±–∏–∑–Ω–µ—Å–∞
    if callback_data.startswith("sellbiz_"):
        parts = callback_data.split("_")
        biz_id = parts[1]
        owner_id = parts[2]

        if user_id != owner_id:
            await query.answer("‚ùå –≠—Ç–æ –Ω–µ –≤–∞—à –±–∏–∑–Ω–µ—Å.", show_alert=True)
            return

        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()
        cursor.execute(
            "SELECT business_id, name, business_type FROM businesses_XUI WHERE business_id = ? AND owner_id = ?",
            (biz_id, user_id)
        )
        biz = cursor.fetchone()
        conn.close()

        if not biz:
            await query.answer("‚ùó –ë–∏–∑–Ω–µ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω.", show_alert=True)
            return

        business_id, name, business_type = biz

        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–µ–Ω—É
        items = load_items()
        biz_price = next((item["price"] for item in items if item["name"] == business_type), None)

        if not biz_price:
            dc_item = next((item for item in DIGITAL_SHOP_ITEMS if item["name"] == business_type), None)
            if dc_item:
                sell_price = int(dc_item["price"] * 1000 * 1)
            else:
                await message.reply_text("‚ùó –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å –≤–∞—à–µ–≥–æ –±–∏–∑–Ω–µ—Å–∞.")
                return
        else:
            sell_price = int(biz_price * 0.7)

        context.user_data['confirm_sell'] = {
            'business_id': business_id,
            'business_name': business_type,
            'sell_price': sell_price
        }

        keyboard = InlineKeyboardMarkup([
            [InlineKeyboardButton("‚úÖ –î–∞, –ø—Ä–æ–¥–∞—Ç—å", callback_data=f"confirm_sell_yes_{business_id}_{user_id}")],
            [InlineKeyboardButton("‚ùå –ù–µ—Ç, –æ—Ç–º–µ–Ω–∞", callback_data=f"confirm_sell_no_{business_id}_{user_id}")]
        ])

        await query.edit_message_text(
            f"‚ö†Ô∏è <b>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø—Ä–æ–¥–∞–∂–∏ –±–∏–∑–Ω–µ—Å–∞</b>\n\n"
            f"üè¢ –ë–∏–∑–Ω–µ—Å: <b>{html.escape(name)}</b>\n"
            f"üìÇ –¢–∏–ø: <b>{html.escape(business_type)}</b>\n"
            f"üíµ –¶–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏: <b>{format_number(sell_price)}‚ÇΩ</b>\n\n"
            f"–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ –ø—Ä–æ–¥–∞—Ç—å –±–∏–∑–Ω–µ—Å?",
            parse_mode="HTML",
            reply_markup=keyboard
        )
        return

    # –í—Ç–æ—Ä–æ–π —à–∞–≥ ‚Äî –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
    if callback_data.startswith("confirm_sell_yes_"):
        parts = callback_data.split("_")
        biz_id = parts[3]
        owner_id = parts[4]

        if user_id != owner_id:
            await query.answer("‚ùå –≠—Ç–æ –Ω–µ –≤–∞—à–µ –¥–µ–π—Å—Ç–≤–∏–µ.", show_alert=True)
            return

        confirm_data = context.user_data.get('confirm_sell')
        if not confirm_data:
            await query.answer("‚ùó –î–∞–Ω–Ω—ã–µ —É—Å—Ç–∞—Ä–µ–ª–∏, –Ω–∞—á–Ω–∏—Ç–µ –∑–∞–Ω–æ–≤–æ.", show_alert=True)
            return

        business_name = confirm_data['business_name']
        sell_price = confirm_data['sell_price']

        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()
        cursor.execute(
            "DELETE FROM businesses_XUI WHERE business_id = ? AND owner_id = ?",
            (biz_id, user_id)
        )
        conn.commit()
        conn.close()

        try:
            new_balance = update_user_business_balance(user_id, sell_price)
        except ValueError as e:
            await query.edit_message_text(f"‚ùó –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –±–∞–ª–∞–Ω—Å–∞: {str(e)}")
            return

        del context.user_data['confirm_sell']

        await query.edit_message_text(
            f"‚úÖ <b>–ü—Ä–æ–¥–∞–∂–∞ –±–∏–∑–Ω–µ—Å–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞</b>\n\n"
            f"üè¢ –ë–∏–∑–Ω–µ—Å: <b>{html.escape(business_name)}</b>\n"
            f"üíµ –ü–æ–ª—É—á–µ–Ω–æ: <b>{format_number(sell_price)}‚ÇΩ</b>\n"
            f"üí∞ –í–∞—à –Ω–æ–≤—ã–π –±–∞–ª–∞–Ω—Å: <b>{format_number(new_balance)}‚ÇΩ</b>",
            parse_mode="HTML"
        )

    elif callback_data.startswith("confirm_sell_no_"):
        context.user_data.pop('confirm_sell', None)
        await query.edit_message_text("‚ùå –ü—Ä–æ–¥–∞–∂–∞ –±–∏–∑–Ω–µ—Å–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞.")

async def business_info(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = str(update.message.from_user.id)
    data = get_user_business_data(user_id)
    biz = data["business"] if data else None

    if not biz or not biz.get("business_type"):
        await update.message.reply_text("‚ùó –£ –≤–∞—Å –Ω–µ—Ç –±–∏–∑–Ω–µ—Å–∞.")
        return

    await edit_business_message(update, context, user_id)


async def edit_business_message(update_or_query, context: ContextTypes.DEFAULT_TYPE, user_id: str):
    data = get_user_business_data(user_id)
    biz = data["business"] if data else None

    if not biz or not biz.get("business_type"):
        text = "‚ùó –£ –≤–∞—Å –Ω–µ—Ç –±–∏–∑–Ω–µ—Å–∞."
        markup = None
    else:
        name = biz["business_type"]
        level = biz["level"]
        balance = biz.get("balance", 0)
        hourly_profit = business_profits.get(name, {}).get(level, 0)

        text = (
            f"üìä *–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–∞—à–µ–º –±–∏–∑–Ω–µ—Å–µ*\n\n"
            f"üè∑ –ù–∞–∑–≤–∞–Ω–∏–µ: *{name}*\n"
            f"üìà –£—Ä–æ–≤–µ–Ω—å: *{level}*\n"
            f"üí∏ –ü—Ä–∏–±—ã–ª—å –≤ —á–∞—Å: *{locale.format_string('%d', hourly_profit, grouping=True)}* üí≤\n"
            f"üí∞ –ë–∞–ª–∞–Ω—Å –±–∏–∑–Ω–µ—Å–∞: *{locale.format_string('%d', balance, grouping=True)}* üí≤"
        )

        markup = InlineKeyboardMarkup([
            [InlineKeyboardButton("üì• –°–æ–±—Ä–∞—Ç—å –ø—Ä–∏–±—ã–ª—å", callback_data=f"business_profit|{user_id}")],
            [
                InlineKeyboardButton("üéÅ –ë–æ–Ω—É—Å", callback_data=f"business_bonus|{user_id}"),
                InlineKeyboardButton("‚è´ –£–ª—É—á—à–∏—Ç—å", callback_data=f"business_upgrade|{user_id}")
            ],
            [InlineKeyboardButton("üíµ –ü—Ä–æ–¥–∞—Ç—å", callback_data=f"business_sell|{user_id}")]
        ])

    if hasattr(update_or_query, "callback_query") and update_or_query.callback_query:
        query = update_or_query.callback_query
        await query.edit_message_text(text, parse_mode="Markdown", reply_markup=markup)
    else:
        await update_or_query.message.reply_text(text, parse_mode="Markdown", reply_markup=markup)


async def handle_business_buttons(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    data = query.data

    command, owner_id = data.split("|")
    user_id = str(query.from_user.id)

    if user_id != owner_id:
        await query.answer(text="‚ùå –≠—Ç–æ –Ω–µ –≤–∞—à–µ –º–µ–Ω—é.", show_alert=True)
        return

    await query.answer()

    if command == "business_profit":
        await business_profit(update, context)
        await edit_business_message(update, context, user_id)
    elif command == "business_bonus":
        await bbonus(update, context)
        await edit_business_message(update, context, user_id)
    elif command == "business_sell":
        await business_sell(update, context)
    elif command == "business_upgrade":
        await business_upgrade(update, context)
        await edit_business_message(update, context, user_id)

async def bbonus(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if update.callback_query:
        user_id = str(update.callback_query.from_user.id)
        send_func = update.callback_query.message.reply_text
        await update.callback_query.answer()
    else:
        user_id = str(update.message.from_user.id)
        send_func = update.message.reply_text

    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    cursor.execute("SELECT business_balance FROM businesses WHERE user_id = ?", (user_id,))
    result = cursor.fetchone()
    if not result:
        await send_func("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –±–∏–∑–Ω–µ—Å–∞.")
        conn.close()
        return

    business_balance = result[0]

    cursor.execute("SELECT bonus_given FROM users WHERE user_id = ?", (user_id,))
    user_row = cursor.fetchone()

    if not user_row:
        await send_func("‚ùå –í–∞—à –ø—Ä–æ—Ñ–∏–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞—á–Ω–∏—Ç–µ —Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.")
        conn.close()
        return

    last_bonus_time = user_row[0] or 0
    current_time = int(time.time())
    cooldown = 12 * 60 * 60

    if current_time - last_bonus_time < cooldown:
        remaining_seconds = cooldown - (current_time - last_bonus_time)
        hours = remaining_seconds // 3600
        minutes = (remaining_seconds % 3600) // 60
        await send_func(
            f" üéâ *–ë–∏–∑–Ω–µ—Å | –ë–æ–Ω—É—Å* üíº\n"
            f"‚è≥*–í—ã —É–∂–µ –ø–æ–ª—É—á–∞–ª–∏ –±–æ–Ω—É—Å!* üíº\n"
            f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
            f"‚è± –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞ —á–µ—Ä–µ–∑: *{hours:02}—á. {minutes:02}–º–∏–Ω.* ‚è≥\n",
            parse_mode="Markdown"
        )
        conn.close()
        return

    bonus = random.randint(1000, 50000)
    new_balance = business_balance + bonus

    cursor.execute(
        "UPDATE businesses SET business_balance = ? WHERE user_id = ?",
        (new_balance, user_id)
    )
    cursor.execute(
        "UPDATE users SET bonus_given = ? WHERE user_id = ?",
        (current_time, user_id)
    )

    conn.commit()
    conn.close()

    await send_func(
        f"üéâ *–ë–∏–∑–Ω–µ—Å | –ë–æ–Ω—É—Å* üíº\n\n"
        f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
        f"üí∏ *–°—É–º–º–∞ –±–æ–Ω—É—Å–∞:* *{bonus}* –º–æ–Ω–µ—Ç üí∞\n"
        f"üè¶ *–ë–∞–ª–∞–Ω—Å –±–∏–∑–Ω–µ—Å–∞:* *{new_balance}* üíº\n\n",
        parse_mode="Markdown"
    )


def get_system_info():
    system_info = {
        "Python Version": platform.python_version(),
        "System": platform.system(),
        "Release": platform.release(),
        "Processor": platform.processor(),
        "CPU Cores": psutil.cpu_count(logical=False),
        "Logical CPUs": psutil.cpu_count(logical=True),
    }
    memory = psutil.virtual_memory()
    cpu_load = psutil.cpu_percent(interval=1)
    system_info.update({
        "CPU Load (%)": cpu_load,
        "Memory Used (MB)": memory.used / (1024 ** 2),
        "Memory Free (MB)": memory.free / (1024 ** 2),
        "Total Memory (MB)": memory.total / (1024 ** 2),
        "Memory Percent (%)": memory.percent,
    })
    return system_info


def get_user_status(user_id: int) -> int:
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT status FROM users WHERE user_id = ?", (str(user_id),))
    result = cursor.fetchone()
    conn.close()
    return result[0] if result else 0


async def sinfo(update: Update, context: ContextTypes.DEFAULT_TYPE):
    message = await update.message.reply_text("üîé –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∑–∞–ø—Ä–æ—Å–∏–≤—à–µ–≥–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é...")
    await asyncio.sleep(1)

    user_id = update.message.from_user.id
    user_status = get_user_status(user_id)

    if user_status < 8:  # –¢–æ–ª—å–∫–æ —Å—Ç–∞—Ç—É—Å 8 –∏ –≤—ã—à–µ
        await message.edit_text("‚ùå –£ –≤–∞—Å –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —ç—Ç–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.")
        return

    await message.edit_text("‚úÖ –î–æ—Å—Ç—É–ø –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω.")
    await asyncio.sleep(1)
    await message.edit_text("üíª –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å —Å–µ—Ä–≤–µ—Ä–∞...")
    await asyncio.sleep(1)

    system_info = get_system_info()
    uptime = timedelta(seconds=time.time() - start_time)

    info_text = (
        f"üîß –¢–µ—Ö. –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è | FernieX\n\n"
        f"üêç –í–µ—Ä—Å–∏—è Python:\n{system_info['Python Version']}\n"
        f"üíª –û–°:\n{system_info['System']} {system_info['Release']}\n"
        f"üñ•Ô∏è –ü—Ä–æ—Ü–µ—Å—Å–æ—Ä:\n{system_info['Processor']}\n"
        f"‚öôÔ∏è –§–∏–∑. —è–¥—Ä–∞:\n{system_info['CPU Cores']}\n"
        f"üî¢ –õ–æ–≥. —è–¥—Ä–∞: {system_info['Logical CPUs']}\n"
        f"üìä CPU –Ω–∞–≥—Ä—É–∑–∫–∞:\n{system_info['CPU Load (%)']}%\n"
        f"üíæ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ –ø–∞–º—è—Ç–∏:\n{system_info['Memory Used (MB)']:.2f} MB\n"
        f"üÜì –°–≤–æ–±–æ–¥–Ω–æ –ø–∞–º—è—Ç–∏:\n{system_info['Memory Free (MB)']:.2f} MB\n"
        f"üß† –û–±—â–∞—è –ø–∞–º—è—Ç—å:\n{system_info['Total Memory (MB)']:.2f} MB\n"
        f"üìâ –ó–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç—å –ø–∞–º—è—Ç–∏:\n{system_info['Memory Percent (%)']}%\n"
        f"‚è≥ –ê–ø—Ç–∞–π–º –±–æ—Ç–∞:\n{uptime}\n"
    )

    await message.edit_text(info_text)


async def reset_account(update: Update, context: ContextTypes.DEFAULT_TYPE, message_text=None):
    if message_text is None:
        message_text = update.message.text
    admin_user = update.effective_user

    pattern = r"/reset_account\s+(\d+)\s+\(([^()]*)\)\s+\(([^()]*)\)\s+\(([^()]*)\)"
    match = re.match(pattern, message_text)

    if not match:
        await update.message.reply_text("‚ùå –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /reset_account telegramID (–±–∞–ª–∞–Ω—Å) (exp) (—Å–µ–º–µ–Ω–∞)")
        return

    telegram_id, balance_arg, exp_arg, seeds_arg = match.groups()

    updates = []
    values = []
    changes = []

    if balance_arg != "-":
        updates.append("balance = balance + ?")
        values.append(int(balance_arg))
        changes.append(("üí∞ –î–µ–Ω—å–≥–∏", int(balance_arg)))
    if exp_arg != "-":
        updates.append("exp = exp + ?")
        values.append(int(exp_arg))
        changes.append(("‚≠ê EXP", int(exp_arg)))
    if seeds_arg != "-":
        updates.append("seeds = seeds + ?")
        values.append(int(seeds_arg))
        changes.append(("üå± –°–µ–º–µ–Ω–∞", int(seeds_arg)))

    if not updates:
        await update.message.reply_text("‚ùå –í—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø—Ä–æ–ø—É—â–µ–Ω—ã. –ù—É–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω.")
        return

    try:
        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()

        sql = f"UPDATE users SET {', '.join(updates)} WHERE user_id = ?"
        values.append(telegram_id)
        cursor.execute(sql, values)
        conn.commit()

        cursor.execute("SELECT balance, exp, seeds, username FROM users WHERE user_id = ?", (telegram_id,))
        row = cursor.fetchone()
        conn.close()

        if not row:
            await update.message.reply_text(f"‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å ID {telegram_id} –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ.")
            return

        balance_now, exp_now, seeds_now, username = row

        msg = "*‚úÖ –î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã:*\n"
        msg += "\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"

        for name, change in changes:
            if name == "–î–µ–Ω—å–≥–∏":
                emoji = "üí≤"
            elif name == "EXP":
                emoji = "‚ú®"
            elif name == "–°–µ–º–µ–Ω–∞":
                emoji = "üå±"
            else:
                emoji = ""
            msg += f"{emoji} *{name}:* +{change}\n"

        msg += "\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"

        msg += "*üìä –ù–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ:*\n"
        msg += f"üí∞ *–î–µ–Ω—å–≥–∏:* {balance_now}üí≤\n"
        msg += f"‚≠ê *EXP:* {exp_now} ‚ú®\n"
        msg += f"üå± *–°–µ–º–µ–Ω–∞:* {seeds_now} üåø\n"

        msg += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"

        msg += f"üë§ *–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:* [{username}](tg://user?id={telegram_id})\n"
        msg += f"üõ°Ô∏è *–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä:* [{admin_user.first_name}](tg://user?id={admin_user.id})"

        await update.message.reply_text(msg, parse_mode="Markdown")

    except Exception as e:
        await update.message.reply_text(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏: {e}")


BONUS_SETTINGS = {
    1: {'cooldown': 1800, 'money': (1000, 15000), 'exp': (1, 3)},
    2: {'cooldown': 3600, 'money': (5000, 25000), 'exp': (2, 5)},
    3: {'cooldown': 7200, 'money': (10000, 50000), 'exp': (2, 10)},
}

async def bonus(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    display_name = get_display_name_html_new(user)

    keyboard = [
        [
            InlineKeyboardButton("–ë–æ–Ω—É—Å 1", callback_data="bonus_1"),
            InlineKeyboardButton("–ë–æ–Ω—É—Å 2", callback_data="bonus_2"),
            InlineKeyboardButton("–ë–æ–Ω—É—Å 3", callback_data="bonus_3")
        ]
    ]
    markup = InlineKeyboardMarkup(keyboard)

    await update.message.reply_text(
        f"üéÅ –ë–æ–Ω—É—Å | {display_name}",
        reply_markup=markup,
        parse_mode=ParseMode.HTML
    )


async def bonus_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    user_id = str(query.from_user.id)
    bonus_type = int(query.data.split("_")[1])
    setting = BONUS_SETTINGS[bonus_type]
    now = int(time.time())

    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    # –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –µ—Å—Ç—å
    cursor.execute("INSERT OR IGNORE INTO users (user_id, username, first_name) VALUES (?, ?, ?)",
                   (user_id, query.from_user.username or query.from_user.first_name,
                    query.from_user.first_name or query.from_user.username or ""))

    # –ü—Ä–æ–≤–µ—Ä–∏–º –ö–î
    cursor.execute("SELECT last_claim FROM bonus_timers WHERE user_id = ? AND bonus_type = ?",
                   (user_id, bonus_type))
    row = cursor.fetchone()
    last_claim = row[0] if row else 0
    elapsed = now - last_claim

    if elapsed < setting['cooldown']:
        left = setting['cooldown'] - elapsed
        minutes, seconds = divmod(left, 60)
        await query.answer(
            text=f"‚è≥ –ü–æ–¥–æ–∂–¥–∏ {minutes} –º–∏–Ω {seconds} —Å–µ–∫ –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ –±–æ–Ω—É—Å–∞ {bonus_type}.",
            show_alert=True
        )
        conn.close()
        return

    # –í—ã–¥–∞–µ–º –Ω–∞–≥—Ä–∞–¥—ã
    money = random.randint(*setting['money'])
    exp = random.randint(*setting['exp'])

    cursor.execute("UPDATE users SET balance = balance + ?, exp = exp + ? WHERE user_id = ?",
                   (money, exp, user_id))

    cursor.execute("""
        INSERT OR REPLACE INTO bonus_timers (user_id, bonus_type, last_claim)
        VALUES (?, ?, ?)
    """, (user_id, bonus_type, now))

    conn.commit()
    conn.close()

    # –í—Å–ø–ª—ã–≤–∞—é—â–µ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø–æ–ª—É—á–µ–Ω–Ω–æ–º –±–æ–Ω—É—Å–µ
    await query.answer(
        text=f"üéÅ –ë–æ–Ω—É—Å –ø–æ–ª—É—á–µ–Ω!\nüòé –¢–∏–ø –±–æ–Ω—É—Å–∞: {bonus_type}\nüí∞ {money:,}‚ÇΩ\n‚≠ê {exp} –æ–ø—ã—Ç–∞",
        show_alert=True
    )


def can_user_activate_promo(user_id: str, promo_code: str) -> bool:
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–ª –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —ç—Ç–æ—Ç –ø—Ä–æ–º–æ–∫–æ–¥
    cursor.execute("SELECT 1 FROM promo_usage WHERE user_id=? AND promo_code=?", (user_id, promo_code))
    if cursor.fetchone():
        conn.close()
        return False  # –£–∂–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–ª

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–º–∏—Ç –∞–∫—Ç–∏–≤–∞—Ü–∏–π –ø—Ä–æ–º–æ–∫–æ–¥–∞
    cursor.execute("SELECT max_activations, activations FROM promo_limits WHERE promo_code=?", (promo_code,))
    row = cursor.fetchone()
    if not row:
        conn.close()
        return False  # –ü—Ä–æ–º–æ–∫–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ª–∏–º–∏—Ç–∞—Ö (–∏–ª–∏ —Å—á–∏—Ç–∞–µ–º, —á—Ç–æ –Ω–µ–ª—å–∑—è –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å)
    max_activations, activations = row
    if activations >= max_activations:
        conn.close()
        return False  # –õ–∏–º–∏—Ç –∞–∫—Ç–∏–≤–∞—Ü–∏–π –∏—Å—á–µ—Ä–ø–∞–Ω

    conn.close()
    return True


def mark_promo_activated(user_id: str, promo_code: str):
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    # –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–ø–∏—Å—å, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–ª –ø—Ä–æ–º–æ–∫–æ–¥
    cursor.execute("INSERT INTO promo_usage (user_id, promo_code) VALUES (?, ?)", (user_id, promo_code))

    # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–∞—Ü–∏–π –ø—Ä–æ–º–æ–∫–æ–¥–∞
    cursor.execute("UPDATE promo_limits SET activations = activations + 1 WHERE promo_code=?", (promo_code,))

    conn.commit()
    conn.close()


def update_user_rewards(user_id, balance=0, seeds=0, exp=0, dc_balance=0):
    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()
        cursor.execute("""
            UPDATE users
            SET balance = balance + ?,
                seeds = seeds + ?,
                exp = exp + ?,
                dc_balance = dc_balance + ?
            WHERE user_id = ?
        """, (balance, seeds, exp, dc_balance, user_id))
        conn.commit()


PROMO_CODES = {
    "Palov": {"balance": 20000, "seeds": 100, "exp": 100, "max_activations": None},
    "FernieX": {"balance": 15000, "seeds": 200, "max_activations": None},
    #"-": {"name": "üí´ –ö–∞—Å–æ–º–∏–∑–∞—Ç–æ—Ä", "by": "FernieX", "balance": 10000, "max_activations": 100},
    #"WEBX": {"balance": 60000, "vip_level": "Legend", "vip_days": 3, "max_activations": None},
    #"FX+": {"balance": 50000, "exp": 60, "max_activations": 1000},
    "GLB12": {"balance": 200000, "seeds": 1000, "vip_level": "Legend", "vip_days": 3, "max_activations": None},
    "Birthday1": {"balance": 100000, "seeds": 10000, "exp": 600, "max_activations": None},
    "Years1": {"balance": 300000, "seeds": 10000, "exp": 600, "max_activations": None},
    "Old1": {"balance": 400000, "seeds": 4000, "exp": 400, "max_activations": None},
    #"NY2026": {"balance": 20262026, "seeds": 2026, "exp": 2026, "vip_level": "Legend", "vip_days": 15, "max_activations": None},

}

VIP_STATUS_MAP = {
    0: "–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç",
    1: "Silver",
    2: "Gold",
    3: "Platinum",
    4: "Legend"
}

VIP_NAME_TO_ID = {v: k for k, v in VIP_STATUS_MAP.items() if k != 0}


def get_user_promo_activations(user_id: str, promo_code: str) -> int:
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT activations FROM user_promocodes WHERE user_id=? AND promo_code=?", (user_id, promo_code))
    row = cursor.fetchone()
    conn.close()
    return row[0] if row else 0


def increment_user_promo_activation(user_id: str, promo_code: str):
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    current = get_user_promo_activations(user_id, promo_code)
    if current == 0:
        cursor.execute("INSERT INTO user_promocodes (user_id, promo_code, activations) VALUES (?, ?, ?)",
                       (user_id, promo_code, 1))
    else:
        cursor.execute("UPDATE user_promocodes SET activations=activations+1 WHERE user_id=? AND promo_code=?",
                       (user_id, promo_code))
    conn.commit()
    conn.close()


def get_total_promo_activations(promo_code: str) -> int:
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT SUM(activations) FROM user_promocodes WHERE promo_code=?", (promo_code,))
    row = cursor.fetchone()
    conn.close()
    return row[0] if row[0] else 0


def get_total_promo_activations(promo_code: str) -> int:
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT SUM(activations) FROM user_promocodes WHERE promo_code=?", (promo_code,))
    row = cursor.fetchone()
    conn.close()
    return row[0] if row[0] else 0


def add_custom_reward(user_id: str, reward_name: str, awarded_by: str):
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute(
        "INSERT INTO rewards (user_id, reward_name, awarded_by) VALUES (?, ?, ?)",
        (user_id, reward_name, awarded_by)
    )
    conn.commit()
    conn.close()


def update_user_vip(user_id: str, vip_level: str, vip_days: int = 0):
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –∑–∞–ø–∏—Å—å –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
    cursor.execute("SELECT vip_level, vip_expiry FROM users WHERE user_id=?", (user_id,))
    row = cursor.fetchone()

    from datetime import datetime, timedelta

    now = datetime.utcnow()
    expiry = None

    if vip_days > 0:
        expiry = now + timedelta(days=vip_days)

    if row:
        # –û–±–Ω–æ–≤–ª—è–µ–º VIP
        cursor.execute(
            "UPDATE users SET vip_level=?, vip_expiry=? WHERE user_id=?",
            (vip_level, expiry.isoformat() if expiry else None, user_id)
        )
    else:
        # –°–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å, –µ—Å–ª–∏ –Ω–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        cursor.execute(
            "INSERT INTO users (user_id, vip_level, vip_expiry) VALUES (?, ?, ?)",
            (user_id, vip_level, expiry.isoformat() if expiry else None)
        )

    conn.commit()
    conn.close()

async def promo_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    message = update.message
    user_id = str(message.from_user.id)
    text = message.text or ""
    parts = text.split(maxsplit=1)

    if len(parts) < 2:
        await message.reply_text(
            "‚ùå <b>–û—à–∏–±–∫–∞:</b> –ù–µ —É–∫–∞–∑–∞–Ω –ø—Ä–æ–º–æ–∫–æ–¥.\n‚ÑπÔ∏è –§–æ—Ä–º–∞—Ç: <code>–ø—Ä–æ–º–æ {–∫–æ–¥}</code>",
            parse_mode="HTML"
        )
        return

    promo_code = parts[1].strip()
    status_msg = await message.reply_text(
        f"‚è≥ –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –ø—Ä–æ–º–æ–∫–æ–¥ <b>{promo_code}</b>...",
        parse_mode="HTML"
    )
    await asyncio.sleep(1)

    # --- –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –ø—Ä–æ–º–æ–∫–æ–¥—ã ---
    if promo_code in PROMO_CODES:
        promo = PROMO_CODES[promo_code]
        max_acts = promo.get("max_activations")
        user_acts = get_user_promo_activations(user_id, promo_code)
        total_acts = get_total_promo_activations(promo_code)

        if max_acts is not None and total_acts >= max_acts:
            await status_msg.edit_text(
                f"‚ùå –ü—Ä–æ–º–æ–∫–æ–¥ <b>{promo_code}</b> –¥–æ—Å—Ç–∏–≥ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–π.",
                parse_mode="HTML"
            )
            return
        if user_acts >= 1:
            await status_msg.edit_text(
                f"‚ùå –í—ã —É–∂–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–ª–∏ —ç—Ç–æ—Ç –ø—Ä–æ–º–æ–∫–æ–¥.\n–ü—Ä–æ–º–æ–∫–æ–¥: <b>{promo_code}</b>",
                parse_mode="HTML"
            )
            return

        # –ø—Ä–∏–º–µ–Ω—è–µ–º –Ω–∞–≥—Ä–∞–¥—ã
        parts_text = []
        if "balance" in promo:
            update_user_rewards(user_id, balance=promo["balance"])
            parts_text.append(f"üí∞ –î–µ–Ω—å–≥–∏: {promo['balance']}")
        if "seeds" in promo:
            update_user_rewards(user_id, seeds=promo["seeds"])
            parts_text.append(f"üå± –°–µ–º–µ–Ω–∞: {promo['seeds']}")
        if "exp" in promo:
            update_user_rewards(user_id, exp=promo["exp"])
            parts_text.append(f"‚ú® –û–ø—ã—Ç: {promo['exp']}")
        if "vip_level" in promo:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–∏–π VIP
            conn = sqlite3.connect(DB_PATH)
            cursor = conn.cursor()
            cursor.execute("SELECT vip_level, vip_expiry FROM users WHERE user_id=?", (user_id,))
            row = cursor.fetchone()
            conn.close()

            current_vip, vip_expiry = (row if row else (None, None))
            vip_expired = False

            if vip_expiry:
                try:
                    expiry_dt = datetime.fromisoformat(vip_expiry)
                    if expiry_dt < datetime.utcnow():
                        vip_expired = True
                except Exception:
                    vip_expired = True

            # –í—ã–¥–∞—ë–º VIP —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ—Ç –∏–ª–∏ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω
            if current_vip in (None, 0, "0", "–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç") or vip_expired:
                update_user_vip(user_id, promo["vip_level"], promo.get("vip_days", 0))
                parts_text.append(f"üëë VIP: {promo['vip_level']} ({promo.get('vip_days', 0)} –¥–Ω–µ–π)")
            else:
                # VIP —É–∂–µ –µ—Å—Ç—å –∏ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω ‚Äî –≤—ã–¥–∞—ë–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—É
                seeds_reward = promo.get("seeds_if_vip", 100)
                update_user_rewards(user_id, seeds=seeds_reward)
                parts_text.append(f"üå± –°–µ–º–µ–Ω–∞ (–∑–∞ –ø–æ–≤—Ç–æ—Ä VIP): {seeds_reward}")

        if "name" in promo:
            add_custom_reward(user_id, promo["name"], awarded_by="–°–∏—Å—Ç–µ–º–∞")
            parts_text.append(f"üèÜ –û—Å–æ–±–∞—è –Ω–∞–≥—Ä–∞–¥–∞: {promo['name']}")

        increment_user_promo_activation(user_id, promo_code)

        await status_msg.edit_text(
            f"‚ú® –ü—Ä–æ–º–æ–∫–æ–¥ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!\nüîë –ö–æ–¥: <b>{promo_code}</b>\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nüîπ " +
            "\nüîπ ".join(parts_text),
            parse_mode="HTML"
        )
        return

    # --- –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥—ã ---
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute(
        "SELECT owner_id, level, activations, rewards, verified FROM custom_promo WHERE promo_code=?",
        (promo_code,)
    )
    row = cursor.fetchone()
    if not row:
        await status_msg.edit_text(
            f"‚ùå –ü—Ä–æ–º–æ–∫–æ–¥ <b>{promo_code}</b> –Ω–µ –Ω–∞–π–¥–µ–Ω.",
            parse_mode="HTML"
        )
        conn.close()
        return

    owner_id, level, total_activations, reward_json, verified = row
    user_acts = get_user_promo_activations(user_id, promo_code)
    if user_acts >= 1:
        await status_msg.edit_text(
            f"‚ùå –í—ã —É–∂–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–ª–∏ —ç—Ç–æ—Ç –ø—Ä–æ–º–æ–∫–æ–¥.\n–ü—Ä–æ–º–æ–∫–æ–¥: <b>{promo_code}</b>",
            parse_mode="HTML"
        )
        conn.close()
        return

    # --- –Ω–∞–≥—Ä–∞–¥—ã –∏–≥—Ä–æ–∫—É –ø–æ —É—Ä–æ–≤–Ω—é ---
    player_rewards = PROMO_REWARDS_PLAYER.get(level, {})
    parts_text = []
    if "balance" in player_rewards:
        update_user_rewards(user_id, balance=player_rewards["balance"])
        parts_text.append(f"üí∞ –î–µ–Ω—å–≥–∏: {player_rewards['balance']}")
    if "seeds" in player_rewards:
        update_user_rewards(user_id, seeds=player_rewards["seeds"])
        parts_text.append(f"üå± –°–µ–º–µ–Ω–∞: {player_rewards['seeds']}")
    if "dc" in player_rewards:
        update_user_rewards(user_id, dc_balance=player_rewards["dc"])
        parts_text.append(f"üåÄ DC: {player_rewards['dc']}")
    if "vip" in player_rewards:
        update_user_vip(user_id, player_rewards["vip"])
        parts_text.append(f"üëë VIP: {player_rewards['vip']}")

    # --- —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∞–∫—Ç–∏–≤–∞—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ---
    increment_user_promo_activation(user_id, promo_code)

    # --- –Ω–∞–≥—Ä–∞–¥—ã –≤–ª–∞–¥–µ–ª—å—Ü—É ---
    if owner_id != user_id:
        owner_rewards = PROMO_REWARDS_OWNER.get(level, {})
        if "balance" in owner_rewards:
            update_user_rewards(owner_id, balance=owner_rewards["balance"])
        if "seeds" in owner_rewards:
            update_user_rewards(owner_id, seeds=owner_rewards["seeds"])
        if "dc" in owner_rewards:
            update_user_rewards(owner_id, dc_balance=owner_rewards["dc"])
        if "vip" in owner_rewards:
            update_user_vip(owner_id, owner_rewards["vip"])
        increment_user_promo_activation(owner_id, promo_code)

    # --- —É–≤–µ–ª–∏—á–µ–Ω–∏–µ –æ–±—â–µ–≥–æ —á–∏—Å–ª–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–π –ø—Ä–æ–º–æ–∫–æ–¥–∞ ---
    total_activations += 1
    for lvl, req in sorted(PROMO_LEVEL_REQUIREMENTS.items()):
        if total_activations >= req and lvl > level:
            level = lvl

    cursor.execute(
        "UPDATE custom_promo SET activations=?, level=? WHERE promo_code=?",
        (total_activations, level, promo_code)
    )
    conn.commit()
    conn.close()

    await status_msg.edit_text(
        f"‚ú® –ü—Ä–æ–º–æ–∫–æ–¥ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!\nüîë –ö–æ–¥: <b>{promo_code}</b>\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nüîπ " +
        "\nüîπ ".join(parts_text),
        parse_mode="HTML"
    )


async def verify_promo_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.message.from_user.id
    if user_id not in ADMIN_IDS:
        await update.message.reply_text("‚õî –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤.")
        return

    if len(context.args) != 1:
        await update.message.reply_text("–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /verifypromo <–∫–æ–¥>")
        return

    promo_code = context.args[0].strip()

    cursor.execute("SELECT promo_code FROM custom_promo WHERE promo_code = ?", (promo_code,))
    if not cursor.fetchone():
        await update.message.reply_text("‚ùå –ü—Ä–æ–º–æ–∫–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω.")
        return

    cursor.execute("UPDATE custom_promo SET verified = 1 WHERE promo_code = ?", (promo_code,))
    conn.commit()

    await update.message.reply_text(f"‚úÖ –ü—Ä–æ–º–æ–∫–æ–¥ <code>{promo_code}</code> —É—Å–ø–µ—à–Ω–æ –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω!", parse_mode="HTML")


async def custom_promo_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if len(context.args) != 1:
        await update.message.reply_text("–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /—Å–æ–∑–¥–∞—Ç—å <–ø—Ä–æ–º–æ–∫–æ–¥>")
        return

    promo_code = context.args[0].strip()
    code_len = len(promo_code)

    if code_len < 3 or code_len > 20:
        await update.message.reply_text("‚ùå –î–ª–∏–Ω–∞ –ø—Ä–æ–º–æ–∫–æ–¥–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ç 3 –¥–æ 20 —Å–∏–º–≤–æ–ª–æ–≤.")
        return

    # –æ–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–µ–Ω—É
    if 15 <= code_len <= 20:
        price = 50
    elif 10 <= code_len <= 14:
        price = 300
    else:  # 3‚Äì9
        price = 1000

    # –ø—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–Ω—è—Ç –ª–∏ –ø—Ä–æ–º–æ–∫–æ–¥
    cursor.execute("SELECT promo_code FROM custom_promo WHERE promo_code = ?", (promo_code,))
    if cursor.fetchone():
        await update.message.reply_text("‚ùå –¢–∞–∫–æ–π –ø—Ä–æ–º–æ–∫–æ–¥ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.")
        return

    # —Å–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–π context.user_data
    context.user_data["promo_create"] = {
        "code": promo_code,
        "price": price,
        "length": code_len
    }

    # –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é
    kb = InlineKeyboardMarkup([
        [InlineKeyboardButton("‚úÖ –°–æ–∑–¥–∞—Ç—å", callback_data="promo_create_confirm")],
        [InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data="promo_create_cancel")]
    ])

    await update.message.reply_text(
        f"üÜï <b>–°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞</b>\n\n"
        f"üîë –ö–æ–¥: <code>{promo_code}</code>\n"
        f"üî¢ –ö–æ–ª-–≤–æ —Å–∏–º–≤–æ–ª–æ–≤: <b>{code_len}</b>\n"
        f"üí∞ –¶–µ–Ω–∞ —Å–æ–∑–¥–∞–Ω–∏—è: <b>{price} DC</b>\n\n"
        f"–í—ã —É–≤–µ—Ä–µ–Ω—ã?",
        parse_mode="HTML",
        reply_markup=kb
    )


async def promo_create_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    if "promo_create" not in context.user_data:
        await query.edit_message_text("‚ö†Ô∏è –î–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã, –Ω–∞—á–Ω–∏—Ç–µ –∑–∞–Ω–æ–≤–æ: /—Å–æ–∑–¥–∞—Ç—å <–∫–æ–¥>")
        return

    data = context.user_data["promo_create"]

    if query.data == "promo_create_cancel":
        await query.edit_message_text("‚ùå –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞ –æ—Ç–º–µ–Ω–µ–Ω–æ.")
        context.user_data.pop("promo_create", None)
        return

    if query.data == "promo_create_confirm":
        user_id = str(query.from_user.id)

        # –ø–æ–ª—É—á–∞–µ–º –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        cursor.execute("SELECT dc_balance FROM users WHERE user_id = ?", (user_id,))
        row = cursor.fetchone()
        if not row:
            await query.edit_message_text("‚ö†Ô∏è –í—ã –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –≤ —Å–∏—Å—Ç–µ–º–µ.")
            return

        dc_balance = row[0]
        if dc_balance < data["price"]:
            await query.edit_message_text(
                f"‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤!\n"
                f"–ë–∞–ª–∞–Ω—Å: {dc_balance} DC\n"
                f"–ù—É–∂–Ω–æ: {data['price']} DC"
            )
            return

        # —Å–ø–∏—Å—ã–≤–∞–µ–º –¥–µ–Ω—å–≥–∏ –∏ —Å–æ–∑–¥–∞—ë–º –ø—Ä–æ–º–æ–∫–æ–¥
        cursor.execute("UPDATE users SET dc_balance = dc_balance - ? WHERE user_id = ?", (data["price"], user_id))
        cursor.execute("INSERT INTO custom_promo (promo_code, owner_id) VALUES (?, ?)", (data["code"], user_id))
        conn.commit()

        await query.edit_message_text(
            f"‚úÖ –ü—Ä–æ–º–æ–∫–æ–¥ <code>{data['code']}</code> —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!\n\n"
            f"üí∞ –°–ø–∏—Å–∞–Ω–æ: {data['price']} DC\n"
            f"üìâ –û—Å—Ç–∞—Ç–æ–∫ –Ω–∞ –±–∞–ª–∞–Ω—Å–µ: {dc_balance - data['price']} DC",
            parse_mode="HTML"
        )
        context.user_data.pop("promo_create", None)


PROMO_LEVEL_REQUIREMENTS = {
    1: 5,
    2: 15,
    3: 20,
    4: 30,
    5: 50,
    6: 65,
    7: 80,
    8: 90,
    9: 150,
}

# –ù–∞–≥—Ä–∞–¥—ã –¥–ª—è –∏–≥—Ä–æ–∫–∞, –∞–∫—Ç–∏–≤–∏—Ä—É—é—â–µ–≥–æ –ø—Ä–æ–º–æ–∫–æ–¥
PROMO_REWARDS_PLAYER = {
    1: {"balance": 15000, "seeds": 50},
    2: {"balance": 20000, "seeds": 100},
    3: {"balance": 30000, "seeds": 150, "dc": 30},
    4: {"balance": 50000, "seeds": 200, "dc": 70},
    5: {"balance": 65000, "seeds": 225, "dc": 100},
    6: {"balance": 70000, "seeds": 250, "dc": 130, "vip": "Gold"},
    7: {"balance": 100000, "seeds": 300, "dc": 175, "vip": "Gold"},
    8: {"balance": 125000, "seeds": 450, "dc": 200, "vip": "Gold"},
    9: {"balance": 125000, "seeds": 475, "dc": 250, "vip": "Platinum"},
    10: {"balance": 1000000, "seeds": 1000, "dc": 1000, "vip": "Legend"},
}

# –ù–∞–≥—Ä–∞–¥—ã –¥–ª—è –≤–ª–∞–¥–µ–ª—å—Ü–∞ –ø—Ä–æ–º–æ–∫–æ–¥–∞
PROMO_REWARDS_OWNER = {
    1: {"balance": 25000, "seeds": 50, "dc": 50},
    2: {"balance": 25000, "seeds": 50, "dc": 50},
    3: {"balance": 25000, "seeds": 100, "dc": 100},
    4: {"balance": 25000, "seeds": 125, "dc": 150},
    5: {"balance": 50000, "seeds": 150, "dc": 150},
    6: {"balance": 50000, "seeds": 150, "dc": 150},
    7: {"balance": 75000, "seeds": 450, "dc": 400},
    8: {"balance": 75000, "seeds": 450, "dc": 400},
    9: {"balance": 80000, "seeds": 500, "dc": 450},
    10: {"balance": 150000, "seeds": 600, "dc": 500},
}


async def mpromo_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    user_id = str(user.id)

    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    # –ü–æ–ª—É—á–∞–µ–º –ø—Ä–æ–º–æ–∫–æ–¥, —É—Ä–æ–≤–µ–Ω—å –∏ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏
    cursor.execute("SELECT promo_code, level, activations FROM Custom_promo WHERE owner_id=?", (user_id,))
    row = cursor.fetchone()

    if not row:
        conn.close()
        await update.message.reply_text(
            "‚ö†Ô∏è <b>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –ø—Ä–æ–º–æ–∫–æ–¥–∞!</b>\n"
            "<pre>üìå –°–æ–∑–¥–∞–π—Ç–µ –µ–≥–æ! /—Å–æ–∑–¥–∞—Ç—å ¬´–ø—Ä–æ–º–æ–∫–æ–¥¬ª</pre>",
            parse_mode="HTML"
        )

        return

    promo_code, level, activations = row

    # –ê–≤—Ç–æ–∞–ø–≥—Ä–µ–π–¥ —É—Ä–æ–≤–Ω—è
    while True:
        next_req = PROMO_LEVEL_REQUIREMENTS.get(level)
        if next_req is None:  # –¥–æ—Å—Ç–∏–≥–Ω—É—Ç –º–∞–∫—Å. —É—Ä–æ–≤–µ–Ω—å
            break
        if activations >= next_req:
            level += 1
            cursor.execute("UPDATE Custom_promo SET level=? WHERE owner_id=?", (level, user_id))
            conn.commit()
        else:
            break

    # –°–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å –¥–ª—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
    next_req = PROMO_LEVEL_REQUIREMENTS.get(level, None)
    next_text = f"{activations} / {next_req}" if next_req else "–ú–∞–∫—Å. —É—Ä–æ–≤–µ–Ω—å"

    # –†–∏—Å—É–µ–º –∫–Ω–æ–ø–∫–∏ —É—Ä–æ–≤–Ω–µ–π
    buttons = []
    for i in range(1, 11):
        if i < level:
            emoji = "üü¢"
        elif i == level:
            emoji = "üü°"
        else:
            emoji = "üî¥"
        buttons.append(
            InlineKeyboardButton(f"[{emoji} | {i}]", callback_data=f"promo_level_{promo_code}_{i}_{user_id}"))

    keyboard = [buttons[i:i + 2] for i in range(0, 10, 2)]
    keyboard.append([InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data=f"promo_back_{promo_code}_{user_id}")])

    conn.close()  # –∑–∞–∫—Ä—ã–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –∑–¥–µ—Å—å

    await update.message.reply_text(
        f"üìä <b>–ù–∞–≥—Ä–∞–¥—ã –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤</b>\n"
        f"‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n"
        f"üîë –ö–æ–¥: <code>{promo_code}</code>\n"
        f"üìà –£—Ä–æ–≤–µ–Ω—å: <b>{level}</b>\n"
        f"üü° –í—Å–µ–≥–æ –∞–∫—Ç–∏–≤–∞—Ü–∏–π: {activations}\n"
        f"‚è≠Ô∏è –°–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å: {next_text}\n"
        f"‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n"
        f"‚ÑπÔ∏è –ù–∞–∂–º–∏—Ç–µ –Ω–∞ —É—Ä–æ–≤–µ–Ω—å, —á—Ç–æ–±—ã –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞–≥—Ä–∞–¥—ã.",
        parse_mode="HTML",
        reply_markup=InlineKeyboardMarkup(keyboard)
    )


async def promo_level_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query

    try:
        data = query.data.split("_", 3)
        promo_code = data[2]

        # data[3] –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –≤–∏–¥–∞ "—á–∏—Å–ª–æ_ownerid"
        if len(data) < 4 or "_" not in data[3]:
            await query.answer("‚ö†Ô∏è –û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ callback_data!", show_alert=True)
            print(f"[ERROR] –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç callback_data: {query.data}")
            return

        level_str, owner_id = data[3].split("_", 1)

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ —É—Ä–æ–≤–µ–Ω—å —á–∏—Å–ª–æ
        if not level_str.isdigit():
            await query.answer("‚ö†Ô∏è –û—à–∏–±–∫–∞: —É—Ä–æ–≤–µ–Ω—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º!", show_alert=True)
            print(f"[ERROR] level_str –Ω–µ —á–∏—Å–ª–æ: {level_str} (data={query.data})")
            return

        level = int(level_str)

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–Ω–æ—Å—Ç–∏ –º–µ–Ω—é
        if str(query.from_user.id) != owner_id:
            await query.answer("‚õî –≠—Ç–æ –º–µ–Ω—é –Ω–µ –¥–ª—è –≤–∞—Å!", show_alert=True)
            return

    except Exception as e:
        await query.answer("‚ö†Ô∏è –û—à–∏–±–∫–∞ —Ä–∞–∑–±–æ—Ä–∞ callback_data!", show_alert=True)
        print(f"[EXCEPTION] –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–∑–±–æ—Ä–µ callback_data {query.data}: {e}")
        return

    # –†–∞–±–æ—Ç–∞ —Å –±–∞–∑–æ–π
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    cursor.execute("SELECT activations, level FROM Custom_promo WHERE promo_code=?", (promo_code,))
    row = cursor.fetchone()
    if not row:
        await query.answer("‚ùå –ü—Ä–æ–º–æ–∫–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω!", show_alert=True)
        conn.close()
        return

    activations, current_level = row

    # –ê–≤—Ç–æ–ø–æ–≤—ã—à–µ–Ω–∏–µ —É—Ä–æ–≤–Ω—è
    while True:
        next_req = PROMO_LEVEL_REQUIREMENTS.get(current_level)
        if next_req is None:  # –º–∞–∫—Å–∏–º—É–º
            break
        if activations >= next_req:
            current_level += 1
            cursor.execute("UPDATE Custom_promo SET level=? WHERE promo_code=?", (current_level, promo_code))
            conn.commit()
        else:
            break

    conn.close()

    # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
    if level > current_level:
        req = PROMO_LEVEL_REQUIREMENTS.get(level, None)
        if req is None:
            status = "üèÜ –º–∞–∫—Å–∏–º—É–º"
        elif activations >= req:
            status = "üü¢ –ø—Ä–æ–π–¥–µ–Ω"
        else:
            status = f"üî¥ {activations}/{req} (–Ω–µ –ø—Ä–æ–π–¥–µ–Ω)"
    elif level == current_level:
        status = "üü° –í–∞—à —É—Ä–æ–≤–µ–Ω—å"
    else:
        status = "üü¢ –ø—Ä–æ–π–¥–µ–Ω"

    # –ü–æ–ª—É—á–∞–µ–º –Ω–∞–≥—Ä–∞–¥—ã
    player_rewards = PROMO_REWARDS_PLAYER.get(level, {})
    owner_rewards = PROMO_REWARDS_OWNER.get(level, {})

    def fmt_rewards(r):
        parts = []
        if "balance" in r: parts.append(f"üí∞ {r['balance']}")
        if "seeds" in r: parts.append(f"üå± {r['seeds']}")
        if "dc" in r: parts.append(f"üåÄ DC: {r['dc']}")
        if "vip" in r: parts.append(f"üëë VIP: {r['vip']}")
        return "\n".join(parts) if parts else "‚Äî"

    # –í—ã–≤–æ–¥ —Å–æ–æ–±—â–µ–Ω–∏—è
    await query.edit_message_text(
        f"üéÅ <b>–ù–∞–≥—Ä–∞–¥—ã –ø—Ä–æ–º–æ–∫–æ–¥–∞</b>\n\n"
        f"üîë –ö–æ–¥: <code>{promo_code}</code>\n"
        f"üìà –£—Ä–æ–≤–µ–Ω—å: <b>{level}</b>\n"
        f"üìä –°—Ç–∞—Ç—É—Å: {status}\n\n"
        f"üë§ <b>–ò–≥—Ä–æ–∫—É:</b>\n{fmt_rewards(player_rewards)}\n\n"
        f"‚≠ê <b>–í–ª–∞–¥–µ–ª—å—Ü—É:</b>\n{fmt_rewards(owner_rewards)}",
        parse_mode="HTML",
        reply_markup=InlineKeyboardMarkup([
            [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data=f"mpromo_back_{promo_code}_{owner_id}")]
        ])
    )


async def mpromo_back_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    data = query.data.split("_", 3)
    promo_code, owner_id = data[2], data[3]

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–Ω–æ–ø–∫—É –∂–º—ë—Ç –∏–º–µ–Ω–Ω–æ –≤–ª–∞–¥–µ–ª–µ—Ü
    if str(query.from_user.id) != owner_id:
        await query.answer("‚õî –≠—Ç–æ –º–µ–Ω—é –Ω–µ –¥–ª—è –≤–∞—Å!", show_alert=True)
        return

    # –î–æ—Å—Ç–∞—ë–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞ –∏–∑ –ë–î
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT level, activations FROM Custom_promo WHERE promo_code=?", (promo_code,))
    row = cursor.fetchone()
    conn.close()

    if not row:
        await query.edit_message_text("‚ùå –ü—Ä–æ–º–æ–∫–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω.")
        return

    level, activations = row

    # –°–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å
    next_req = PROMO_LEVEL_REQUIREMENTS.get(level, None)
    next_text = f"{activations} / {next_req}" if next_req else "–ú–∞–∫—Å. —É—Ä–æ–≤–µ–Ω—å"

    # –†–∏—Å—É–µ–º –∫–Ω–æ–ø–∫–∏ —É—Ä–æ–≤–Ω–µ–π
    buttons = []
    for i in range(1, 11):
        if i < level:
            emoji = "üü¢"
        elif i == level:
            emoji = "üü°"
        else:
            emoji = "üî¥"
        buttons.append(
            InlineKeyboardButton(f"[{emoji} | {i}]", callback_data=f"promo_level_{promo_code}_{i}_{owner_id}"))

    # –°–µ—Ç–∫–∞ 2x5
    keyboard = [buttons[i:i + 2] for i in range(0, 10, 2)]
    keyboard.append([InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data=f"mpromo_back_{promo_code}_{owner_id}")])

    # –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
    await query.edit_message_text(
        f"üìä <b>–ù–∞–≥—Ä–∞–¥—ã –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤</b>\n"
        f"‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n"
        f"üîë –ö–æ–¥: <code>{promo_code}</code>\n"
        f"üìà –£—Ä–æ–≤–µ–Ω—å: <b>{level}</b>\n"
        f"‚è≠Ô∏è –°–ª–µ–¥. —É—Ä–æ–≤–µ–Ω—å: {next_text}\n"
        f"‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n"
        f"‚ÑπÔ∏è –ù–∞–∂–º–∏—Ç–µ –Ω–∞ —É—Ä–æ–≤–µ–Ω—å, —á—Ç–æ–±—ã –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞–≥—Ä–∞–¥—ã.",
        parse_mode="HTML",
        reply_markup=InlineKeyboardMarkup(keyboard)
    )


async def pinfo_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    message = update.message
    user_id = str(message.from_user.id)
    user_status = get_user_status(user_id)

    if user_status < 9:
        await message.reply_text("‚ùå –≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –∫—É—Ä–∞—Ç–æ—Ä–∞–º –∏ –≤—ã—à–µ.")
        return

    if message.chat.type != "private":
        await message.reply_text("‚ö†Ô∏è –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç—Ç—É –∫–æ–º–∞–Ω–¥—É –≤ –ª–∏—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö —Å –±–æ—Ç–æ–º.")
        return

    promo_list = []
    for code, rewards in PROMO_CODES.items():
        parts = []

        # –ë–∞–ª–ª—ã –∏ –≤–∞–ª—é—Ç—ã
        if "balance" in rewards:
            parts.append(f"üí∞ {rewards['balance']} –¥–µ–Ω—å–≥–∏")
        if "seeds" in rewards:
            parts.append(f"üå± {rewards['seeds']} —Å–µ–º–µ–Ω–∞")
        if "exp" in rewards:
            parts.append(f"‚ú® {rewards['exp']} –æ–ø—ã—Ç")

        # VIP-–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
        vip_level = rewards.get("vip_level")
        vip_days = rewards.get("vip_days")
        if vip_level and vip_days:
            parts.append(f"üëë VIP: {vip_level} –Ω–∞ {vip_days} –¥–Ω.")

        # –õ–∏–º–∏—Ç –∞–∫—Ç–∏–≤–∞—Ü–∏–π
        max_activations = rewards.get("max_activations")
        if max_activations is not None:
            total_activated = get_total_promo_activations(code)
            left = max_activations - total_activated
            left = max(left, 0)
            parts.append(f"‚è≥ –û—Å—Ç–∞–ª–æ—Å—å –∞–∫—Ç–∏–≤–∞—Ü–∏–π: {left}")
        else:
            parts.append("‚àû –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –º–æ–∂–Ω–æ –Ω–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ")

        promo_list.append(f"*{code}* ‚Äî {', '.join(parts)}")

    text = "üéü *–î–æ—Å—Ç—É–ø–Ω—ã–µ –ø—Ä–æ–º–æ–∫–æ–¥—ã:*\n\n" + "\n".join(promo_list)

    await message.reply_text(text, parse_mode=ParseMode.MARKDOWN)


CASE_PRICES = {
    "QuantumVault": 488,    # –±—ã–ª–æ 750, -35%
    "CandyChest": 975,      # –±—ã–ª–æ 1500, -35%
    "StellarPack": 1950,    # –±—ã–ª–æ 3000, -35%
    "MysticVault": 4550,    # –±—ã–ª–æ 7000, -35%
    "KefirX": 3500,         # –±—ã–ª–æ 7000, -50%
    "FernieX 1 Years": 4500  # –±—ã–ª–æ 9000, -50%
}

CASE_CONTENTS = {
    "QuantumVault": [
        ("500üå±", 30),
        ("250 exp", 25),
        ("500 exp", 20),
        ("100.000‚ÇΩ", 15),
        ("150.000‚ÇΩ", 10)
    ],
    "CandyChest": [
        ("1000üå±", 25),
        ("1000 exp", 20),
        ("1500 exp", 15),
        ("200.000‚ÇΩ", 25),
        ("300.000‚ÇΩ", 15)
    ],
    "StellarPack": [
        ("3000üå±", 20),
        ("2500 exp", 20),
        ("3000 exp", 15),
        ("500.000‚ÇΩ", 15),
        ("800.000‚ÇΩ", 10),
        ("200 dc", 4),
    ],
    "MysticVault": [
        ("3000üå±", 15),
        ("2500 exp", 15),
        ("3000 exp", 10),
        ("500.000‚ÇΩ", 15),
        ("2.500.000‚ÇΩ", 5),
        ("500 dc", 4),
        ("500 dc", 4),
        ("1000 dc", 1)
    ],
    "KefirX": [
        ("1000üå±", 15),
        ("500 exp", 15),
        ("200.000‚ÇΩ", 15),
        ("1.000.000‚ÇΩ", 5),
        ("500 dc", 4),
        ("1000 dc", 2)
    ],
    "FernieX 1 Years": [
        ("3000üå±", 15),
        ("2500 exp", 15),
        ("3000 exp", 10),
        ("500.000‚ÇΩ", 15),
        ("2.500.000‚ÇΩ", 5),
        ("500 dc", 4),
        ("500 dc", 4),
        ("1000 dc", 1)
    ]
}


def case_menu_keyboard():
    return InlineKeyboardMarkup([
        [InlineKeyboardButton("üóùÔ∏è QuantumVault - 488 (-35%) üå±", callback_data="case_QuantumVault")],
        [InlineKeyboardButton("üç¨ CandyChest - 975 (-35%) üå±", callback_data="case_CandyChest")],
        [InlineKeyboardButton("üåå StellarPack - 1950 (-35%) üå±", callback_data="case_StellarPack")],
        [InlineKeyboardButton("üîÆ MysticVault - 4550 (-35%) üå±", callback_data="case_MysticVault")],
        [InlineKeyboardButton("ü•õ KefirX - 3500 (-50%) üå±", callback_data="case_KefirX")],
        [InlineKeyboardButton("üí´ FernieX 1 Years - 4500 (-50%) üå±", callback_data="case_FernieX 1 Years")],
    ])


def case_actions_keyboard(case_name):
    return InlineKeyboardMarkup([
        [InlineKeyboardButton("üìÇ –ù–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–µ–π—Å–∞", callback_data=f"contents_{case_name}")],
        [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="back_to_menu")]
    ])


def back_to_case_keyboard(case_name):
    return InlineKeyboardMarkup([
        [InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data=f"case_{case_name}")]
    ])


# –ü–æ–ª—É—á–∏—Ç—å –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –≤–µ—Ä–Ω—É—Ç—å —Å–µ–º–µ–Ω–∞
def get_user(user_id, username=None):
    conn = sqlite3.connect(DB_PATH)
    cur = conn.cursor()
    cur.execute("SELECT seeds FROM users WHERE user_id=?", (str(user_id),))
    row = cur.fetchone()
    if not row:
        if username is None:
            username = "Unknown"
        cur.execute(
            "INSERT INTO users (user_id, username, seeds) VALUES (?, ?, ?)",
            (str(user_id), username, 1000)
        )
        conn.commit()
        seeds = 1000
    else:
        seeds = row[0]
    conn.close()
    return seeds


def parse_reward_amount(reward: str) -> int:
    amount_match = re.search(r"[\d\.]+", reward)
    if amount_match:
        return int(amount_match.group(0).replace(".", ""))
    return 0


def format_case_amount(amount: int) -> str:
    return "{:,}".format(amount).replace(",", ".")


# –û–±–Ω–æ–≤–∏—Ç—å —Å–µ–º–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
def update_seeds(user_id, amount):
    conn = sqlite3.connect(DB_PATH)
    cur = conn.cursor()
    cur.execute("UPDATE users SET seeds = ? WHERE user_id = ?", (amount, str(user_id)))
    conn.commit()
    conn.close()


# –ü–æ–ª—É—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–µ–π—Å–æ–≤ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
def get_case_quantity(user_id, case_name):
    conn = sqlite3.connect(DB_PATH)
    cur = conn.cursor()
    cur.execute("SELECT count FROM user_cases WHERE user_id=? AND case_name=?", (str(user_id), case_name))
    row = cur.fetchone()
    conn.close()
    return row[0] if row else 0


def change_case_quantity(user_id, case_name, delta):
    conn = sqlite3.connect(DB_PATH)
    cur = conn.cursor()
    cur.execute("SELECT count FROM user_cases WHERE user_id=? AND case_name=?", (str(user_id), case_name))
    row = cur.fetchone()
    if row is None:
        if delta > 0:
            cur.execute("INSERT INTO user_cases (user_id, case_name, count) VALUES (?, ?, ?)",
                        (str(user_id), case_name, delta))
    else:
        current = row[0]
        new_qty = current + delta
        if new_qty < 0:
            new_qty = 0
        cur.execute("UPDATE user_cases SET count = ? WHERE user_id = ? AND case_name = ?",
                    (new_qty, str(user_id), case_name))
    conn.commit()
    conn.close()


def add_reward_to_user(user_id: int, reward: str):
    conn = sqlite3.connect(DB_PATH)
    cur = conn.cursor()
    cur.execute(
        "SELECT balance, seeds, exp, dc_balance FROM users WHERE user_id=?",
        (str(user_id),)
    )
    row = cur.fetchone()
    if not row:
        conn.close()
        return

    balance, seeds, exp, dc_balance = row
    reward = reward.lower()
    amount_match = re.search(r"[\d\.]+", reward)
    if not amount_match:
        conn.close()
        return

    amount = int(amount_match.group(0).replace(".", ""))

    if "‚ÇΩ" in reward:
        balance += amount
        cur.execute("UPDATE users SET balance=? WHERE user_id=?", (balance, str(user_id)))
    elif "üå±" in reward:
        seeds += amount
        cur.execute("UPDATE users SET seeds=? WHERE user_id=?", (seeds, str(user_id)))
    elif "exp" in reward:
        exp += amount
        cur.execute("UPDATE users SET exp=? WHERE user_id=?", (exp, str(user_id)))
    elif "dc" in reward:
        dc_balance += amount
        cur.execute(
            "UPDATE users SET dc_balance=? WHERE user_id=?",
            (dc_balance, str(user_id))
        )

    conn.commit()
    conn.close()


def get_user_cases_data(user_id: str):
    conn = sqlite3.connect(DB_PATH)
    cur = conn.cursor()
    cur.execute("SELECT seeds FROM users WHERE user_id = ?", (user_id,))
    row = cur.fetchone()
    conn.close()
    if row:
        return {"seeds": row[0]}
    return None


def get_user_seeds(user_id):
    conn = sqlite3.connect(DB_PATH)
    cur = conn.cursor()
    cur.execute("SELECT seeds FROM users WHERE user_id=?", (str(user_id),))
    row = cur.fetchone()
    if not row:
        cur.execute(
            "INSERT INTO users (user_id, username, seeds) VALUES (?, ?, ?)",
            (str(user_id), "Unknown", 0)
        )
        conn.commit()
        seeds = 0
    else:
        seeds = row[0]
    conn.close()
    return seeds


async def start_case(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    context.user_data["case_menu_opened"] = True
    context.user_data["case_menu_user_id"] = user.id
    await send_cases_message(update, context)


async def send_error_cases_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    user_mention_html = get_display_name_html_new(user)
    text = (
        f"üì¶ –ö–µ–π—Å—ã | {user_mention_html}\n\n"
        "‚ö†Ô∏è –ö–µ–π—Å—ã –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã.\n\n"
        "üôè –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
    )
    await update.message.reply_text(
        text,
        parse_mode=ParseMode.HTML,
        disable_web_page_preview=True
    )


async def send_cases_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    user_mention_html = get_display_name_html_new(user)
    text = (
        f"üì¶ –ö–µ–π—Å—ã | {user_mention_html}\n\n"
        "–í—ã–±–µ—Ä–∏ –∫–µ–π—Å –∏ –∏—Å–ø—ã—Ç–∞–π —É–¥–∞—á—É\n\n"
        "‚ú® –û—Ç–∫—Ä–æ–π –∏ –ø–æ–ª—É—á–∞–π –∫—Ä—É—Ç—ã–µ –Ω–∞–≥—Ä–∞–¥—ã! üçÄ"
    )
    await update.message.reply_text(
        text,
        reply_markup=case_menu_keyboard(),
        parse_mode=ParseMode.HTML,
        disable_web_page_preview=True
    )


async def Casecallback_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    user = query.from_user
    user_id = user.id
    data = query.data
    case_menu_user_id = context.user_data.get("case_menu_user_id")

    if case_menu_user_id is None or user.id != case_menu_user_id:
        await query.answer("‚ùå –≠—Ç–æ –Ω–µ –≤–∞—à–µ –º–µ–Ω—é", show_alert=True)
        return

    async def safe_edit(text, keyboard):
        try:
            await query.edit_message_text(text, reply_markup=keyboard, parse_mode="HTML")
        except Exception:
            await query.message.reply_html(text, reply_markup=keyboard)

    conn = sqlite3.connect(DB_PATH)
    cur = conn.cursor()
    cur.execute("SELECT seeds, dc_balance FROM users WHERE user_id=?", (str(user_id),))
    row = cur.fetchone()
    conn.close()
    seeds, dc_balance = row if row else (0, 0)

    # –ù–∞–∑–∞–¥ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
    if data == "back_to_menu":
        user_mention = get_display_name_html_new(user)
        text = (
            f"üéâ –ö–µ–π—Å—ã | {user_mention}\n\n"
            f"üîé –í—ã–±–µ—Ä–∏—Ç–µ –Ω—É–∂–Ω—ã–π –∫–µ–π—Å –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —É–¥–∞—á—É\n\n"
            f"‚ú® –û—Ç–∫—Ä—ã–≤–∞–π—Ç–µ –∫–µ–π—Å—ã –∏ –ø–æ–ª—É—á–∞–π—Ç–µ –∫—Ä—É—Ç—ã–µ –Ω–∞–≥—Ä–∞–¥—ã! üçÄ"
        )
        keyboard = case_menu_keyboard()
        await safe_edit(text, keyboard)
        return

    # –í—ã–±–æ—Ä –∫–µ–π—Å–∞
    if data.startswith("case_"):
        case_name = data.split("_", 1)[1]
        case_qty = get_case_quantity(user_id, case_name)
        user_mention = get_display_name_html_new(user)
        text = (
            f"üéÅ –ö–µ–π—Å—ã ‚Äî {user_mention}\n\n"
            f"üíé –ë–∞–ª–∞–Ω—Å: {seeds} üå± | {dc_balance} DC\n"
            f"üì¶ –ö–µ–π—Å: {case_name}\n"
            f"üé≤ –£ –≤–∞—Å: {case_qty} —à—Ç."
        )
        keyboard = case_actions_keyboard(case_name)
        await safe_edit(text, keyboard)
        return

    # –ü—Ä–æ—Å–º–æ—Ç—Ä —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –∫–µ–π—Å–∞
    if data.startswith("contents_"):
        case_name = data.split("_", 1)[1]
        contents = CASE_CONTENTS.get(case_name, [])
        lines = [f"üéØ {i + 1}. {item} ‚Äî {chance}%" for i, (item, chance) in enumerate(contents)]
        user_mention = get_display_name_html_new(user)
        text = (
                f"üéÅ –ö–µ–π—Å—ã | {user_mention}\n\n"
                f"üì¶ –ö–µ–π—Å: {case_name}\n"
                f"üìã –ù–∞–ø–æ–ª–Ω–µ–Ω–∏–µ:\n"
                + "\n".join(lines)
        )
        keyboard = back_to_case_keyboard(case_name)
        await safe_edit(text, keyboard)
        return

_case_buy_log = defaultdict(list)   # user_id -> [timestamps]
_case_open_log = defaultdict(list)  # user_id -> [timestamps]

CASE_LIMIT = 10        # –º–∞–∫—Å–∏–º—É–º –¥–µ–π—Å—Ç–≤–∏–π
CASE_WINDOW = 7 * 60  # –æ–∫–Ω–æ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö (7 –º–∏–Ω—É—Ç)

def case_check_limit(log: dict, user_id: int) -> tuple[bool, int]:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç (–º–æ–∂–Ω–æ_–ª–∏, —Å–µ–∫—É–Ω–¥_–¥–æ_—Å–±—Ä–æ—Å–∞)"""
    now = time.time()
    timestamps = log[user_id]
    # –ß–∏—Å—Ç–∏–º —Å—Ç–∞—Ä—ã–µ
    timestamps = [t for t in timestamps if now - t < CASE_WINDOW]
    log[user_id] = timestamps

    if len(timestamps) >= CASE_LIMIT:
        wait = int(CASE_WINDOW - (now - timestamps[0]))
        return False, wait

    timestamps.append(now)
    log[user_id] = timestamps
    return True, 0


async def case_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    user_id = user.id

    if len(context.args) < 3:
        await update.message.reply_text(
            "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç\n\n"
            "–ò—Å–ø–æ–ª—å–∑—É–π:\n"
            "<code>–∫–µ–π—Å –∫—É–ø–∏—Ç—å 1 QuantumVault</code>\n"
            "<code>–∫–µ–π—Å –æ—Ç–∫—Ä—ã—Ç—å 1 QuantumVault</code>\n\n"
            "–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–µ–π—Å—ã:\n"
            "üóùÔ∏è QuantumVault\n"
            "üç¨ CandyChest\n"
            "üåå StellarPack\n"
            "üîÆ MysticVault\n"
            "ü•õ KefirX\n"
            "üí´ FernieX 1 Years",
            parse_mode=ParseMode.HTML
        )
        return

    action = context.args[0].lower()

    try:
        qty = int(context.args[1])
    except ValueError:
        await update.message.reply_text(
            "‚ùå –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —á–∏—Å–ª–æ–º\n\n–§–æ—Ä–º–∞—Ç: <code>–∫–µ–π—Å –∫—É–ø–∏—Ç—å 1 QuantumVault</code>",
            parse_mode=ParseMode.HTML
        )
        return

    case_name = " ".join(context.args[2:])

    if qty < 1 or qty > 200:
        await update.message.reply_text("‚ùå –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç 1 –¥–æ 200")
        return

    if case_name not in CASE_PRICES:
        await update.message.reply_text(
            f"‚ùå –ö–µ–π—Å '<b>{case_name}</b>' –Ω–µ –Ω–∞–π–¥–µ–Ω\n\n"
            "–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–µ–π—Å—ã:\n"
            "üóùÔ∏è QuantumVault\n"
            "üç¨ CandyChest\n"
            "üåå StellarPack\n"
            "üîÆ MysticVault\n"
            "ü•õ KefirX\n"
            "üí´ FernieX 1 Years",
            parse_mode=ParseMode.HTML
        )
        return

    user_mention = get_display_name_html_new(user)

    # ======================= –ü–û–ö–£–ü–ö–ê =========================

    if action == "–∫—É–ø–∏—Ç—å":

        allowed, wait = case_check_limit(_case_buy_log, user_id)
        if not allowed:
            mins = wait // 60
            secs = wait % 60
            await update.message.reply_text(
                f"‚è≥ –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ø–æ–∫—É–ø–æ–∫!\n\n"
                f"–õ–∏–º–∏—Ç: {CASE_LIMIT} –ø–æ–∫—É–ø–æ–∫ –∑–∞ 7 –º–∏–Ω—É—Ç\n"
                f"–ü–æ–¥–æ–∂–¥–∏ –µ—â—ë: {mins}–º {secs}—Å"
            )
            return

        price = CASE_PRICES[case_name]
        total_price = price * qty

        conn = sqlite3.connect(DB_PATH)
        cur = conn.cursor()
        cur.execute("SELECT seeds FROM users WHERE user_id=?", (str(user_id),))
        row = cur.fetchone()
        conn.close()

        seeds = row[0] if row else 0

        if seeds < total_price:
            await update.message.reply_text(
                f"‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å–µ–º—è–Ω\n\n"
                f"üí∞ –ë–∞–ª–∞–Ω—Å: {seeds} üå±\n"
                f"üí∏ –°—Ç–æ–∏–º–æ—Å—Ç—å: {total_price} üå±\n"
                f"üìâ –ù–µ —Ö–≤–∞—Ç–∞–µ—Ç: {total_price - seeds} üå±"
            )
            return

        update_seeds(user_id, seeds - total_price)
        change_case_quantity(user_id, case_name, qty)

        await update.message.reply_html(
            f"‚úÖ –£—Å–ø–µ—à–Ω–∞—è –ø–æ–∫—É–ø–∫–∞\n\n"
            f"üë§ {user_mention}\n"
            f"üì¶ –ö–µ–π—Å: {case_name}\n"
            f"üé≤ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: {qty} —à—Ç.\n"
            f"üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å: {format_case_amount(total_price)} üå±"
        )
        return

    # ======================= –û–¢–ö–†–´–¢–ò–ï ========================

    elif action == "–æ—Ç–∫—Ä—ã—Ç—å":

        allowed, wait = case_check_limit(_case_open_log, user_id)
        if not allowed:
            mins = wait // 60
            secs = wait % 60
            await update.message.reply_text(
                f"‚è≥ –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –æ—Ç–∫—Ä—ã—Ç–∏–π!\n\n"
                f"–õ–∏–º–∏—Ç: {CASE_LIMIT} –æ—Ç–∫—Ä—ã—Ç–∏–π –∑–∞ 7 –º–∏–Ω—É—Ç\n"
                f"–ü–æ–¥–æ–∂–¥–∏ –µ—â—ë: {mins}–º {secs}—Å"
            )
            return

        have = get_case_quantity(user_id, case_name)

        if have < qty:
            await update.message.reply_html(
                f"‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫–µ–π—Å–æ–≤\n\n"
                f"üë§ {user_mention}\n"
                f"üì¶ –£ –≤–∞—Å: {have} —à—Ç.\n"
                f"üìä –ù—É–∂–Ω–æ: {qty} —à—Ç.\n"
                f"üìâ –ù–µ —Ö–≤–∞—Ç–∞–µ—Ç: {qty - have} —à—Ç."
            )
            return

        progress_msg = await update.message.reply_html(
            f"üé∞ –û—Ç–∫—Ä—ã–≤–∞–µ–º –∫–µ–π—Å—ã...\n"
            f"üë§ {user_mention}\n"
            f"üì¶ –ö–µ–π—Å: {case_name}\n"
            f"üé≤ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: {qty} —à—Ç.\n\n"
            f"‚è≥ –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ..."
        )

        change_case_quantity(user_id, case_name, -qty)

        items = CASE_CONTENTS.get(case_name, [])
        choices = []
        for item, chance in items:
            choices.extend([item] * chance)

        summary = {"‚ÇΩ": 0, "üå±": 0, "dc": 0, "exp": 0}

        for _ in range(qty):
            reward = random.choice(choices)
            add_reward_to_user(user_id, reward)

            amount_match = re.search(r"[\d\.]+", reward)
            if amount_match:
                amount = int(amount_match.group(0).replace(".", ""))
                if "‚ÇΩ" in reward:
                    summary["‚ÇΩ"] += amount
                elif "üå±" in reward:
                    summary["üå±"] += amount
                elif "dc" in reward:
                    summary["dc"] += amount
                elif "exp" in reward:
                    summary["exp"] += amount

        text = (
            f"üéâ –ö–µ–π—Å—ã –æ—Ç–∫—Ä—ã—Ç—ã\n"
            f"üë§ {user_mention}\n"
            f"üì¶ –ö–µ–π—Å: {case_name}\n"
            f"üé≤ –û—Ç–∫—Ä—ã—Ç–æ: {qty} —à—Ç.\n\n"
            f"üìä –°–≤–æ–¥–∫–∞:\n"
            f"üí∞ –î–µ–Ω—å–≥–∏: {format_case_amount(summary['‚ÇΩ'])} ‚ÇΩ\n"
            f"üå± –°–µ–º–µ–Ω–∞: {format_case_amount(summary['üå±'])}\n"
            f"üíé DC: {format_case_amount(summary['dc'])}\n"
            f"‚≠ê EXP: {format_case_amount(summary['exp'])}"
        )

        await progress_msg.edit_text(text, parse_mode="HTML")
        return

    else:
        await update.message.reply_text(
            "‚ùå –î–æ—Å—Ç—É–ø–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è: –∫—É–ø–∏—Ç—å / –æ—Ç–∫—Ä—ã—Ç—å\n\n"
            "–§–æ—Ä–º–∞—Ç: <code>–∫–µ–π—Å –∫—É–ø–∏—Ç—å 1 QuantumVault</code>",
            parse_mode=ParseMode.HTML
        )

async def ogrfake(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.message.from_user
    user_id = str(user.id)
    username = f"@{user.username}" if user.username else ""

    # –û–±–Ω–æ–≤–ª—è–µ–º username –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –µ—Å–ª–∏ –ø—É—Å—Ç–æ –≤ –±–∞–∑–µ
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute(
        "UPDATE users SET username = ? WHERE user_id = ? AND (username IS NULL OR username = '')",
        (username, user_id)
    )
    conn.commit()
    conn.close()

    await update.message.reply_text(
        "‚ùå *–ö–æ–º–∞–Ω–¥–∞* ‚ùóÔ∏è *\"–æ–≥—Ä–∞–±–∏—Ç—å\"* ‚ùå\n\n"
        "üö´ *–Ω–µ –¥–æ—Å—Ç—É–ø–Ω–∞* –≤ —ç—Ç–æ–π –≤–µ—Ä—Å–∏–∏ –±–æ—Ç–∞.",
        parse_mode="Markdown"
    )


async def handle_russian_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not update.message or not update.message.text:
        print("–û—à–∏–±–∫–∞: –°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–µ–∫—Å—Ç–∞ –∏–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.")
        return

    message_text = update.message.text.strip()
    message_text_lower = message_text.lower()
    parts = message_text.split(maxsplit=1)
    command = parts[0]
    args_text = parts[1] if len(parts) > 1 else ""
    context.args = args_text.split() if args_text else []

    # ===== –ü–†–û–í–ï–†–ö–ê –ú–ê–ö–†–û–°–û–í =====
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –ª–∏ –∫–æ–º–∞–Ω–¥–∞ —Å /
    if command.startswith("/"):
        trigger = command[1:]  # –£–±–∏—Ä–∞–µ–º /

        # –ü—ã—Ç–∞–µ–º—Å—è –≤—ã–ø–æ–ª–Ω–∏—Ç—å –º–∞–∫—Ä–æ—Å
        macro_executed = await execute_macro(update, context, trigger)

        # –ï—Å–ª–∏ –º–∞–∫—Ä–æ—Å –±—ã–ª –≤—ã–ø–æ–ª–Ω–µ–Ω, –≤—ã—Ö–æ–¥–∏–º
        if macro_executed:
            return

    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥ —Å —Ç–æ—á–Ω—ã–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ–º
    if command in ("—Ä–æ–ª—å", "/—Ä–æ–ª—å"):
        await role_command(update, context)
        return

    if message_text_lower == "–±–æ—Ç":
        await ver_command(update, context)
        return

    if message_text_lower == "/–∏–≤–µ–Ω—Ç":
        await event_error_command(update, context)
        return

    if message_text_lower.startswith("/–±–∞–≥"):
        await bug_report(update, context)
        return

    if message_text_lower.startswith("–ø—Ä–æ–º–æ"):
        await promo_command(update, context)
        return

    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ—Å—Ç—ã—Ö –∫–æ–º–∞–Ω–¥ –±–µ–∑ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤
    if message_text_lower == "—è":
        await stats(update, context)
        return

    if message_text_lower == "/–Ω–∞—Å—Ç—Ä–æ–∏—Ç—å":
        await changecode(update, context)
        return

    if message_text_lower == "/—á–∞—Ç":
        await chat_info(update, context)
        return

    if message_text_lower == "/—Å–ª–æ–≤–∞":
        await word_quest_handler(update, context)
        return

    if message_text_lower == "/–ø–æ–¥–ø–∏—Å–∫–∞":
        await subvip(update, context)
        return

    if message_text_lower == "/—Ä–µ—Å—Ç–∞—Ä—Ç":
        await restart_command(update, context)
        return

    if message_text_lower == "/–º–æ–π –ø—Ä–æ–º–æ":
        await mpromo_command(update, context)
        return

    if message_text_lower.startswith("/—Å–æ–∑–¥–∞—Ç—å"):
        await custom_promo_command(update, context)
        return

    if message_text_lower == "/—Ç–µ–ª–µ—Ñ–æ–Ω":
        await phone_menu(update, context)
        return

    if message_text_lower == "–∫–µ–π—Å—ã":
        await start_case(update, context)
        return

    if message_text_lower == "/—Ö–∞–∫":
        await hack_command(update, context)
        return

    if message_text_lower == "/–ª–∏–º–∏—Ç":
        await limit_list_vip_command(update, context)
        return

    if message_text_lower == "—Ç–µ—Ö":
        await sinfo(update, context)
        return

    if message_text_lower == "–¥–µ—Ç–∏":
        await baby(update, context)
        return

    if message_text_lower == "–ø—Ä–µ–∑–∏–∫":
        await condom_entry(update, context)
        return

    if message_text_lower == "—Å–µ–∫—Å":
        await sex_command(update, context)
        return

    if message_text_lower == "–ø–∏—Ç–æ–º–µ—Ü":
        await pet_info_command(update, context)
        return

    if message_text_lower.startswith("—Ä–∞–Ω–≥"):
        await raising_command(update, context)
        return

    if message_text_lower.startswith("–∫–µ–π—Å"):
        await case_command(update, context)
        return

    if message_text_lower.startswith("–º—Ä–ø-"):
        await delete_rp(update, context)
        return

    if message_text_lower == "–º—Ä–ø":
        await list_rp(update, context)
        return

    if message_text_lower == "–º–∞–∫—Ä–æ—Å—ã":
        await macros_list_command(update, context)
        return

    if message_text_lower.startswith("/—É–¥–∞–ª–∏—Ç—å_–º–∞–∫—Ä–æ—Å"):
        await delete_macro_command(update, context)
        return

    if message_text_lower.startswith("/–¥–æ–∫—Å"):
        await dox(update, context)
        return

    if message_text_lower == "-—Ä–∞–Ω–≥":
        await unraising_command(update, context)
        return

    if message_text_lower == "—Ä–∞–∑–∂–∞–ª–æ–≤–∞—Ç—å":
        await unmoder(update, context)
        return

    if message_text_lower == "–∞–¥–º–∏–Ω—ã":
        await alist(update, context)
        return

    if message_text_lower == "—Ç–æ–ø":
        await top_command(update, context)
        return

    if message_text_lower == "–∑–∞–∫—Ä–µ–ø":
        await pinmms_command(update, context)
        return

    if message_text_lower == "–∑–∞–∫—Ä–µ–ø–∏—Ç—å":
        await pinmms_command(update, context)
        return

    if message_text_lower == "–æ—Ç–∫—Ä–µ–ø":
        await unpinmms_command(update, context)
        return

    if message_text_lower == "–æ—Ç–∫—Ä–µ–ø–∏—Ç—å":
        await unpinmms_command(update, context)
        return

    if message_text_lower == "—Ñ–∞—Ä–º":
        await farm(update, context)
        return

    if message_text_lower == "–º–∏–Ω—Ñ–æ":
        await minfo_command(update, context)
        return

    if message_text_lower == "–±–∏–Ω—Ñ–æ":
        await binfo_command(update, context)
        return

    if message_text_lower == "–∫–æ–º–∞–Ω–¥—ã":
        await command_list(update, context)
        return

    if message_text_lower == "–¥—Ä":
        await dbday(update, context)
        return

    if message_text_lower == "-—Å–º—Å":
        await delsms_command(update, context)
        return

    if message_text_lower == "/–∞–¥–º–∏–Ω":
        await checkadmin_command(update, context)
        return


    if message_text_lower == "–ø—Ä–∞–≤–∏–ª–∞":
        await show_rules(update, context)
        return

    if message_text_lower == "-–ø—Ä–∞–≤–∏–ª–∞":
        await delete_rules(update, context)
        return

    if message_text_lower == "–±—Ä–∞–∫":
        await brak(update, context)
        return

    if message_text_lower == "—Ä–∞–∑–≤–æ–¥":
        await devorce(update, context)
        return

    if message_text_lower == "–º–æ–π –±—Ä–∞–∫":
        await mybrak(update, context)
        return

    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥ —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º
    if message_text_lower.startswith("+–Ω–∏–∫"):
        await nick_command(update, context)
        return

    if message_text_lower.startswith("/–≤—á–∞—Ç"):
        await set_chat_verification(update, context)
        return

    if message_text_lower == "–Ω–∏–∫":
        await nickname_info(update, context)
        return

    if message_text_lower.startswith("–∫–ª–∞–Ω"):
        await clan_handler(update, context)
        return

    if message_text_lower.startswith("/–±–ª–∞–≥–æ"):
        await charity_command(update, context)
        return

    if message_text_lower.startswith("/—Ñ–æ–Ω–¥"):
        await blagofond_command(update, context)
        return

    if message_text_lower.startswith("—Å–µ–º–µ–Ω–∞"):
        await setseeds_command(update, context)
        return

    if message_text_lower.startswith("/–ª–∏—Ü"):
        await license_handler(update, context)
        return

    if message_text_lower.startswith("/—Å–ª–∏—Ü"):
        await slic_handler(update, context)
        return

    if message_text_lower.startswith("–æ–≥—Ä–∞–±–∏—Ç—å"):
        await robbing_command(update, context)
        return

    if message_text_lower.startswith("—Ñ–µ—Ä–Ω–∏"):
        await fernie(update, context)
        return

    if message_text_lower.startswith("–ø–æ–∂–µ–Ω–∏—Ç—å"):
        await ibrak(update, context)
        return

    if message_text_lower.startswith("–∫—Ä–∏–ø—Ç–∞"):
        await crypto_command_handler(update, context)
        return

    if message_text_lower.startswith("–º–æ–Ω–µ—Ç–∫–∞"):
        await coin_game(update, context)
        return

    if message_text_lower.startswith("/—Å–Ω–∏–∫"):
        await snick_command(update, context)
        return

    if message_text_lower.startswith("—Ä–µ–π—Ç–∏–Ω–≥"):
        await rating_general_handler(update, context)
        return

    if message_text_lower.startswith("–≤–∏–ø"):
        await global_vip_commands_hendler(update, context)
        return

    if message_text_lower.startswith("/–∏–¥–µ—è"):
        await idea_handler(update, context)
        return

    if message_text_lower.startswith("–¥–µ–ø–æ–∑–∏—Ç"):
        await updep(update, context)
        return

    if message_text_lower.startswith("+–ø—Ä–∞–≤–∏–ª–∞"):
        await add_rule(update, context)
        return

    if message_text_lower.startswith("–ø–µ—Ä–µ–¥–∞—Ç—å"):
        await give_currency(update, context)
        return

    if message_text_lower.startswith("–∏–Ω—Ñ–æ"):
        await info_command(update, context)
        return

    if message_text_lower.startswith("–¥–∞—Ç—å"):
        await pay_command(update, context)
        return

    if message_text_lower.startswith("@all"):
        await all_command(update, context)
        return

    if message_text_lower.startswith("–∫–∞–∑–∏–Ω–æ"):
        await casino_command(update, context)
        return

    if message_text_lower.startswith("—Ä–æ–ª—å"):
        await role_command(update, context)
        return

    if message_text_lower.startswith("–º–∞–≥–∞–∑"):
        await shop_command(update, context)
        return

    if message_text_lower.startswith("–≥—Ä–∞—Ñ–∏–∫"):
        await handle_start_game(update, context)
        return

    if message_text_lower.startswith("–ø—Ä–æ–¥–∞—Ç—å"):
        await sell_command(update, context)
        return

    if message_text_lower.startswith(".–∏–¥") or message_text_lower.startswith(". –∏–¥"):
        if message_text_lower.startswith(". –∏–¥"):
            arg_text = message_text[4:].strip()
        else:
            arg_text = message_text[3:].strip()
        await id_command(update, context, arg_text)
        return

    if message_text_lower.startswith("–±–∏–∑–Ω–µ—Å"):
        await handle_business_command(update, context)
        return

    if message_text_lower.startswith("–±–∞–Ω–∫"):
        await bank_handler(update, context)
        return
        # bank_command
    if message_text_lower == "–±–æ–Ω—É—Å":
        await bonus(update, context)
        return

    if message_text_lower.startswith("+–Ω–∞–≥—Ä–∞–¥–∞"):
        await reward_command(update, context)
        return

    if message_text_lower.startswith("-–Ω–∞–≥—Ä–∞–¥–∞"):
        await creward_command(update, context)
        return

    if (
            message_text_lower.startswith("+")
            or message_text_lower in ("–∂–∏–∑–∞", "—Å–æ–≥–ª")
    ):
        await upraiting(update, context)
        return

    if message_text_lower.startswith("-"):
        await downraiting(update, context)
        return

    if message_text_lower.startswith("–Ω–∞–≥—Ä–∞–¥—ã"):
        await rewards_command(update, context)
        return

    if message_text_lower.startswith("—Ç–∞–∫—Å–∏"):
        await taxi_command(update, context)
        return

    if message_text_lower.startswith("–ø–∏–Ω—Ñ–æ"):
        await pinfo_command(update, context)
        return

    if message_text_lower.startswith("–≤—ã–¥–∞—Ç—å"):
        await give_command(update, context)
        return

    if message_text_lower.startswith("–∏–∑—ä—è—Ç—å"):
        await take_command(update, context)
        return

    if message_text_lower.startswith("–∫–∞–∑–Ω–∞"):
        await treasury_command(update, context)
        return

    if message_text_lower.startswith("–º—É—Ç"):
        await mute_command(update, context)
        return

    if message_text_lower.startswith("—Ä–∞–∑–º—É—Ç"):
        await unmute_command(update, context)
        return

    if message_text_lower.startswith("–±–∞–Ω"):
        await ban_command(update, context)
        return

    if message_text_lower.startswith("—Ä–∞–∑–±–∞–Ω"):
        await unban_command(update, context)
        return

    if message_text_lower.startswith("–∫–∏–∫"):
        await kick_command(update, context)
        return

    if message_text_lower.startswith("/–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å"):
        converted_text = message_text_lower.replace("/–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å", "/reset_account", 1)
        await reset_account(update, context, message_text=converted_text)
        return

    # –í—Å–µ–≥–æ: #14 –†–ü –∫–æ–º–∞–Ω–¥
    commands_map = {
        "–æ–±–Ω—è—Ç—å": cud,
        "—É–¥–∞—Ä–∏—Ç—å": hit,
        "–ø–æ—Ü–µ–ª–æ–≤–∞—Ç—å": kiss,
        "–ø–æ–≥–ª–∞–¥–∏—Ç—å": stroke,
        "—Ç—Ä–∞—Ö–Ω—É—Ç—å": fuck,
        "–≤—ã–µ–±–∞—Ç—å": viebal,
        "—É–±–∏—Ç—å": kill,
        "–≤–æ—Å–∫—Ä–µ—Å–∏—Ç—å": resurrect,
        "–∫—É—Å—å": kus,
        "—á–º–æ–∫–Ω—É—Ç—å": chmok,
        "–æ—Ç—Å–æ—Å–∞—Ç—å": otsos,
        "–æ—Ç–ª–∏–∑–∞—Ç—å": otliz,
        "–∫–æ–Ω—á–∏—Ç—å": cum,
        "–∫–∞—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å": kastrirovat,
    }

    for cmd, func in commands_map.items():
        if message_text_lower.startswith(cmd):
            await func(update, context)
            return


# x1
VIP_STATUS_REWARDS = {
 0: {"exp": 4, "coins": 5000, "seeds": 60, "dc": 1},
 1: {"exp": 8, "coins": 10000, "seeds": 70, "dc": 10},
 2: {"exp": 12, "coins": 20000, "seeds": 100, "dc": 25},
 3: {"exp": 20, "coins": 30000, "seeds": 150, "dc": 50},
 4: {"exp": 40, "coins": 50000, "seeds": 300, "dc": 100},
 }
# x2
#VIP_STATUS_REWARDS = {
    #0: {"exp": 8, "coins": 10000, "seeds": 120, "dc": 2},
    # 1: {"exp": 16, "coins": 20000, "seeds": 140, "dc": 20},
    #2: {"exp": 24, "coins": 40000, "seeds": 200, "dc": 50},
    # 3: {"exp": 40, "coins": 60000, "seeds": 300, "dc": 100},
    # 4: {"exp": 80, "coins": 100000, "seeds": 600, "dc": 200},
#}

CHAT_ID = -1003209289725  # –¢–≤–æ–π —á–∞—Ç

MOSCOW_TZ = pytz.timezone("Europe/Moscow")


async def give_payday(context: ContextTypes.DEFAULT_TYPE):
    try:
        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()

        cursor.execute("SELECT user_id, vip_status FROM users")
        users = cursor.fetchall()

        for user_id, vip_status in users:
            rewards = VIP_STATUS_REWARDS.get(vip_status, VIP_STATUS_REWARDS[0])
            cursor.execute(
                """
                UPDATE users
                SET 
                    balance = balance + ?,
                    seeds = seeds + ?,
                    exp = exp + ?,
                    dc_balance = dc_balance + ?
                WHERE user_id = ?
                """,
                (
                    rewards["coins"],
                    rewards["seeds"],
                    rewards["exp"],
                    rewards["dc"],
                    user_id,
                ),
            )

        conn.commit()

        now_moscow = datetime.now(MOSCOW_TZ)
        log_message = f"[{now_moscow.strftime('%Y-%m-%d %H:%M:%S')}] PayDay –Ω–∞—á–∏—Å–ª–µ–Ω."
        print(log_message)
        # √ó2
        chat_message = (
            f"ü§ë <b>PayDay –Ω–∞—á–∏—Å–ª–µ–Ω!</b>\n"
            f"<blockquote>‚è∞ {now_moscow.strftime('%d.%m.%Y %H:%M:%S')}</blockquote>"
        )

        await context.bot.send_message(
            chat_id=CHAT_ID,
            text=chat_message,
            parse_mode='HTML'
        )


    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–∏ PayDay: {e}")
    finally:
        if 'conn' in locals():
            conn.close()


async def job_give_payday(context: ContextTypes.DEFAULT_TYPE):
    await give_payday(context)


async def give_business_profits():
    try:
        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()

        cursor.execute("SELECT owner_id, name, level, balance FROM businesses_XUI")
        businesses = cursor.fetchall()

        for owner_id, name, level, balance in businesses:
            profit = business_profits.get(name, {}).get(level, 0)
            if profit > 0:
                # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º balance –≤ —á–∏—Å–ª–æ (int/float)
                try:
                    current_balance = float(balance)
                except:
                    current_balance = 0

                new_balance = current_balance + profit

                cursor.execute(
                    "UPDATE businesses_XUI SET balance = ? WHERE owner_id = ? AND name = ?",
                    (str(new_balance), owner_id, name),
                )

        # –ù–∞—á–∏—Å–ª—è–µ–º –æ–ø—ã—Ç –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
        cursor.execute("UPDATE users SET exp = exp + 3")

        conn.commit()
        print(f"[{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}] –ü—Ä–∏–±—ã–ª—å –∏ –æ–ø—ã—Ç –Ω–∞—á–∏—Å–ª–µ–Ω—ã.")
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–∏ –ø—Ä–∏–±—ã–ª–∏: {e}")
    finally:
        conn.close()

async def job_give_business_profits(context: ContextTypes.DEFAULT_TYPE):
    await give_business_profits()


def schedule_jobs(app):
    now = datetime.now()
    first_run = (now.replace(minute=0, second=0, microsecond=0) + timedelta(hours=1)) - now
    app.job_queue.run_repeating(job_give_business_profits, interval=3600, first=first_run.total_seconds())
    app.job_queue.run_repeating(job_give_payday, interval=3600, first=first_run.total_seconds())

async def mute_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    chat = update.effective_chat
    user = update.effective_user

    if chat.type not in ['group', 'supergroup']:
        await update.message.reply_text("‚ùå –ö–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –≤ –≥—Ä—É–ø–ø–∞—Ö.")
        return

    admin_level = get_user_level_chat_Adm(chat.id, user.id)
    if admin_level == 0:
        await update.message.reply_text("‚ùå –í—ã –Ω–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —ç—Ç–æ–≥–æ —á–∞—Ç–∞.")
        return

    message_text = update.message.text or ""
    lines = message_text.strip().split("\n")

    if len(lines) < 1:
        await update.message.reply_text(
            "‚ùó –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:\n–º—É—Ç 3 –º–∏–Ω / —á / –¥–Ω [ID]\n[–ø—Ä–∏—á–∏–Ω–∞ –Ω–∞—Ä—É—à–µ–Ω–∏—è, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ]"
        )
        return

    first_line = lines[0].strip().split()
    reason = lines[1].strip() if len(lines) > 1 else "-"  # –ø—Ä–∏—á–∏–Ω–∞ –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞

    # –£–±–∏—Ä–∞–µ–º —Å–ª–æ–≤–æ –∫–æ–º–∞–Ω–¥—ã "–º—É—Ç" –≤ –Ω–∞—á–∞–ª–µ, –µ—Å–ª–∏ –µ—Å—Ç—å
    if first_line[0].lower() == "–º—É—Ç":
        first_line = first_line[1:]

    # ------------------------------
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–µ–ª—å –∏ –≤—Ä–µ–º—è
    # ------------------------------
    if update.message.reply_to_message:
        target_id = str(update.message.reply_to_message.from_user.id)
        if len(first_line) < 2:
            await update.message.reply_text("‚ùó –£–∫–∞–∂–∏—Ç–µ –≤—Ä–µ–º—è –∏ –µ–¥–∏–Ω–∏—Ü—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, 3 –º–∏–Ω).")
            return
        time_part = first_line[0]
        unit_part = first_line[1]
    else:
        if len(first_line) < 3:
            await update.message.reply_text("‚ùó –£–∫–∞–∂–∏—Ç–µ ID, –≤—Ä–µ–º—è –∏ –µ–¥–∏–Ω–∏—Ü—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, 123456789 3 –º–∏–Ω).")
            return
        target_id = first_line[0]
        time_part = first_line[1]
        unit_part = first_line[2]

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ ID
    try:
        target_id_int = int(target_id)
    except ValueError:
        await update.message.reply_text("‚ùó ID –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º.")
        return

    # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤—Ä–µ–º—è –≤ —Å–µ–∫—É–Ω–¥—ã
    try:
        duration_value = int(time_part)
    except ValueError:
        await update.message.reply_text("‚ùó –í—Ä–µ–º—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —á–∏—Å–ª–æ–º.")
        return

    unit_part = unit_part.lower()
    if unit_part.startswith("–º–∏–Ω"):
        duration_seconds = duration_value * 60
    elif unit_part.startswith("—á"):
        duration_seconds = duration_value * 3600
    elif unit_part.startswith("–¥–Ω") or unit_part.startswith("–¥–Ω—è") or unit_part.startswith("–¥–Ω–µ–π"):
        duration_seconds = duration_value * 86400
    else:
        await update.message.reply_text("‚ùó –ù–µ–≤–µ—Ä–Ω–∞—è –µ–¥–∏–Ω–∏—Ü–∞ –≤—Ä–µ–º–µ–Ω–∏: –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–∏–Ω, —á –∏–ª–∏ –¥–Ω/–¥–Ω—è/–¥–Ω–µ–π")
        return

    now = int(time.time())
    until_date = now + duration_seconds

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Ä–æ–≤–Ω—è —Ü–µ–ª–∏
    target_level = get_user_level_chat_Adm(chat.id, target_id_int)
    if target_level >= admin_level:
        await update.message.reply_text(
            "‚ùå –ù–µ–ª—å–∑—è –≤—ã–¥–∞—Ç—å –º—É—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å —É—Ä–æ–≤–Ω–µ–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ —Ä–∞–≤–Ω—ã–º –∏–ª–∏ –≤—ã—à–µ –≤–∞—à–µ–≥–æ."
        )
        return

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –º—É—Ç–∞
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute(
        "SELECT * FROM mutes WHERE muted_user_id=? AND chat_id=? AND timestamp_end > ?",
        (str(target_id_int), str(chat.id), now)
    )
    active_mute = cursor.fetchone()
    if active_mute:
        await update.message.reply_text("‚ùå –£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É–∂–µ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π –º—É—Ç –≤ —ç—Ç–æ–º —á–∞—Ç–µ.")
        conn.close()
        return

    # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    try:
        member = await context.bot.get_chat_member(chat.id, target_id_int)
    except Exception:
        await update.message.reply_text("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —ç—Ç–æ–º —á–∞—Ç–µ.")
        conn.close()
        return

    # –ù–∞–∫–ª–∞–¥—ã–≤–∞–µ–º –º—É—Ç
    try:
        await context.bot.restrict_chat_member(
            chat.id,
            target_id_int,
            permissions=ChatPermissions(
                can_send_messages=False,
                can_send_polls=False,
                can_send_other_messages=False,
                can_add_web_page_previews=False,
                can_change_info=False,
                can_invite_users=False,
                can_pin_messages=False
            ),
            until_date=until_date
        )
    except Exception as e:
        await update.message.reply_text(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏–º–µ–Ω–∏—Ç—å –º—É—Ç: {e}")
        conn.close()
        return

    # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –≤ —Ç–∞–±–ª–∏—Ü—É mutes
    cursor.execute("""
        INSERT INTO mutes (muted_user_id, muted_by_user_id, reason, duration, timestamp_start, timestamp_end, chat_id)
        VALUES (?, ?, ?, ?, ?, ?, ?)
    """, (
        str(target_id_int),
        str(user.id),
        reason,
        duration_seconds,
        now,
        until_date,
        str(chat.id)
    ))
    conn.commit()
    conn.close()

    change_user_rating(target_id_int, -2)

    muted_mention = get_display_name_html_new(member.user)
    admin_mention = get_display_name_html_new(user)

    keyboard = InlineKeyboardMarkup([
        [InlineKeyboardButton("üì© –û–±–∂–∞–ª–æ–≤–∞—Ç—å", url="https://t.me/FernieXBot?start=appealmenu")]
    ])

    await update.message.reply_text(
        f"üîá <b>–ú—É—Ç –≤—ã–¥–∞–Ω</b>\n\n"
        f"üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {muted_mention}\n"
        f"üõ° –ê–¥–º–∏–Ω: {admin_mention}\n"
        f"‚è≥ –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: {duration_value} {unit_part}\n"
        f"üìù –ü—Ä–∏—á–∏–Ω–∞: {html.escape(reason)}",
        reply_markup=keyboard,
        parse_mode='HTML'
    )

    # –õ–æ–≥
    write_log(
        log_type="mutes",
        admin_id=user.id,
        target_id=target_id_int,
        duration=f"{duration_value} {unit_part}",
        reason=reason,
        chat_id=str(chat.id),
        action="–í—ã–¥–∞—á–∞ –º—É—Ç–∞"
    )
async def unmute_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = str(update.message.from_user.id)
    chat = update.effective_chat
    chat_id = str(chat.id)

    # –ü–æ–ª—É—á–∞–µ–º —É—Ä–æ–≤–µ–Ω—å –∞–¥–º–∏–Ω–∞ –≤ —ç—Ç–æ–º —á–∞—Ç–µ
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute(
        "SELECT admin_level FROM chat_admins WHERE chat_id=? AND user_id=?",
        (chat_id, user_id)
    )
    admin_level_row = cursor.fetchone()
    admin_level = admin_level_row[0] if admin_level_row else 0  # 0 - –æ–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å

    # –ü–æ–ª—É—á–∞–µ–º —Ç—Ä–µ–±—É–µ–º—ã–π —É—Ä–æ–≤–µ–Ω—å –¥–ª—è —Å–Ω—è—Ç–∏—è –º—É—Ç–∞
    cursor.execute(
        "SELECT unmute_level FROM chat_settings WHERE chat_id=?",
        (chat_id,)
    )
    setting_row = cursor.fetchone()
    required_level = setting_row[0] if setting_row else 7

    if admin_level < required_level:
        await update.message.reply_text(
            f"‚ùå –î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã —Ç—Ä–µ–±—É–µ—Ç—Å—è —É—Ä–æ–≤–µ–Ω—å {required_level} –∏–ª–∏ –≤—ã—à–µ."
        )
        conn.close()
        return

    # –†–∞–∑–±–æ—Ä –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤
    message_text = update.message.text or ""
    args = message_text.strip().split()[1:]  # —É–¥–∞–ª—è–µ–º –∫–æ–º–∞–Ω–¥—É

    if args:
        target_id = args[0]
    elif update.message.reply_to_message:
        target_id = str(update.message.reply_to_message.from_user.id)
    else:
        await update.message.reply_text(
            "‚ùóÔ∏è –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:\n—Ä–∞–∑–º—É—Ç {TelegramID}\n"
            "–ò–ª–∏ –≤—ã–∑–æ–≤–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É –≤ –æ—Ç–≤–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."
        )
        conn.close()
        return

    now = int(time.time())
    cursor.execute(
        "SELECT * FROM mutes WHERE muted_user_id=? AND timestamp_end > ?",
        (target_id, now)
    )
    active_mute = cursor.fetchone()
    if not active_mute:
        await update.message.reply_text("‚úÖ –£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –º—É—Ç–∞.")
        conn.close()
        return

    # –°–Ω–∏–º–∞–µ–º –º—É—Ç
    try:
        await context.bot.restrict_chat_member(
            chat.id,
            int(target_id),
            permissions=ChatPermissions(
                can_send_messages=True,
                can_send_polls=True,
                can_send_other_messages=True,
                can_add_web_page_previews=True,
                can_change_info=False,
                can_invite_users=True,
                can_pin_messages=True
            ),
            until_date=0
        )
    except Exception as e:
        await update.message.reply_text(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–Ω—è—Ç—å –º—É—Ç: {e}")
        conn.close()
        return

    # –£–¥–∞–ª—è–µ–º –∑–∞–ø–∏—Å—å –æ –º—é—Ç–µ
    cursor.execute(
        "DELETE FROM mutes WHERE muted_user_id=? AND timestamp_end > ?",
        (target_id, now)
    )
    conn.commit()

    change_user_rating(int(target_id), +3)

    # –ù–∞—á–∏—Å–ª—è–µ–º 10 –æ—á–∫–æ–≤ –∞–¥–º–∏–Ω—É
    cursor.execute("""
        CREATE TABLE IF NOT EXISTS admins (
            user_id TEXT PRIMARY KEY,
            points INTEGER DEFAULT 0,
            warnings INTEGER DEFAULT 0
        )
    """)
    cursor.execute("SELECT points FROM admins WHERE user_id = ?", (user_id,))
    row = cursor.fetchone()
    if row:
        cursor.execute("UPDATE admins SET points = points + 10 WHERE user_id = ?", (user_id,))
    else:
        cursor.execute("INSERT INTO admins (user_id, points, warnings) VALUES (?, ?, ?)", (user_id, 10, 0))
    conn.commit()
    conn.close()

    # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –¥–ª—è —É–ø–æ–º–∏–Ω–∞–Ω–∏—è
    try:
        muted_member = await context.bot.get_chat_member(chat.id, int(target_id))
        muted_mention = get_display_name_html_new(muted_member.user)
    except Exception:
        muted_mention = f'<a href="tg://user?id={target_id}">{target_id}</a>'

    admin_mention = get_display_name_html_new(update.message.from_user)

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Ä–∞–∑–º—É—Ç–µ
    await update.message.reply_text(
        f"‚úÖ <b>–ú—É—Ç —Å–Ω—è—Ç</b>\n\n"
        f"üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {muted_mention}\n"
        f"üõ° –ê–¥–º–∏–Ω: {admin_mention}\n"
        f"üéØ –ê–¥–º–∏–Ω –ø–æ–ª—É—á–∏–ª <b>10 –æ—á–∫–æ–≤</b>",
        parse_mode='HTML'
    )

    # –õ–æ–≥–∏—Ä—É–µ–º –¥–µ–π—Å—Ç–≤–∏–µ
    write_log(
        log_type="mutes",
        admin_id=user_id,
        target_id=target_id,
        duration="-",
        reason="-",
        chat_id=chat_id,
        action="–°–Ω—è—Ç–∏–µ –º—É—Ç–∞"
    )


async def minfo_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    message_text = update.message.text or ""
    args = message_text.strip().split()[1:]

    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫–æ–≥–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å
    if args:
        target_id = args[0]
    elif update.message.reply_to_message:
        target_id = str(update.message.reply_to_message.from_user.id)
    else:
        await update.message.reply_text(
            "‚ùóÔ∏è –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:\n<code>–º–∏–Ω—Ñ–æ {TelegramID}</code> –∏–ª–∏ –æ—Ç–≤–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ",
            parse_mode="HTML"
        )
        return

    now = int(time.time())

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –º—É—Ç–∞
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute(
        "SELECT muted_by_user_id, reason, timestamp_end FROM mutes WHERE muted_user_id=? AND timestamp_end > ?",
        (target_id, now)
    )
    mute = cursor.fetchone()
    conn.close()

    if not mute:
        await update.message.reply_text("‚úÖ –£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –º—É—Ç–∞.")
        return

    muted_by_id, reason, timestamp_end = mute

    # –ü–æ–ª—É—á–∞–µ–º —É–ø–æ–º–∏–Ω–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —á–µ—Ä–µ–∑ get_display_name_html_new
    try:
        admin_member = await context.bot.get_chat_member(update.effective_chat.id, muted_by_id)
        admin_mention = get_display_name_html_new(admin_member.user)
    except Exception:
        admin_mention = f'<a href="tg://user?id={muted_by_id}">{muted_by_id}</a>'

    try:
        muted_member = await context.bot.get_chat_member(update.effective_chat.id, int(target_id))
        muted_mention = get_display_name_html_new(muted_member.user)
    except Exception:
        muted_mention = f'<a href="tg://user?id={target_id}">{target_id}</a>'

    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ –æ–∫–æ–Ω—á–∞–Ω–∏—è
    try:
        timestamp_end = int(timestamp_end)
        if timestamp_end > 1e12:
            timestamp_end //= 1000  # –µ—Å–ª–∏ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥—ã
        if timestamp_end < 0 or timestamp_end > 1e10:
            raise ValueError("Invalid timestamp")

        dt_utc = datetime.fromtimestamp(timestamp_end, timezone.utc)
        moscow_tz = timezone(timedelta(hours=3))
        dt_msk = dt_utc.astimezone(moscow_tz)
        mute_end_str = dt_msk.strftime("%Y-%m-%d %H:%M:%S")

        seconds_left = max(timestamp_end - now, 0)
        minutes_left = seconds_left // 60
        seconds_remainder = seconds_left % 60
        time_left_str = f"{minutes_left} –º–∏–Ω {seconds_remainder} —Å–µ–∫"
    except Exception:
        mute_end_str = "–ù–∏–∫–æ–≥–¥–∞"
        time_left_str = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"

    # –°—Å—ã–ª–∫–∞ –Ω–∞ —á–∞—Ç
    chat_title = html.escape(update.effective_chat.title or "–ß–∞—Ç")
    chat_id = str(update.effective_chat.id)
    if chat_id.startswith("-100"):
        short_id = chat_id[4:]
        chat_link = f'<a href="https://t.me/c/{short_id}/1">{chat_title}</a>'
    else:
        chat_link = chat_title

    # –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç
    text = (
        f"üö´ <b>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º—É—Ç–µ</b>\n\n"
        f"üë§ <b>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</b> {muted_mention}\n"
        f"üõ° <b>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä:</b> {admin_mention}\n"
        f"üìù <b>–ü—Ä–∏—á–∏–Ω–∞:</b> {html.escape(reason)}\n\n"
        f"‚ùó <b>–°—Ç–∞—Ç—É—Å:</b> –ú—É—Ç –∞–∫—Ç–∏–≤–µ–Ω\n"
        f"üïí <b>–û—Å—Ç–∞–ª–æ—Å—å –¥–æ —Å–Ω—è—Ç–∏—è:</b> {time_left_str}\n\n"
        f"üìÖ <b>–í—Ä–µ–º—è —Å–Ω—è—Ç–∏—è –º—É—Ç–∞ (–ú–°–ö):</b> {mute_end_str}\n\n"
        f"üè∑ <b>–ß–∞—Ç –≥–¥–µ –≤—ã–¥–∞–Ω –º—É—Ç:</b> {chat_link}"
    )

    await update.message.reply_text(text, parse_mode="HTML")


MIN_ADMIN_STATUS = 5
MIN_ADMIN_STATUS_PERMBAN = 7
MIN_ADMIN_STATUS_UNBAN = 6


async def is_admin_in_db(user_id: int, min_required_status: int) -> bool:
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT status FROM users WHERE user_id = ?", (str(user_id),))
    row = cursor.fetchone()
    conn.close()
    if row is None:
        return False
    status = row[0]
    return status >= min_required_status


def save_ban_to_db(banned_user_id, banned_by_user_id, reason, duration,
                   timestamp_start, timestamp_end, chat_id):
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("""
        INSERT INTO bans (
            banned_user_id,
            banned_by_user_id,
            reason,
            duration,
            timestamp_start,
            timestamp_end,
            chat_id
        ) VALUES (?, ?, ?, ?, ?, ?, ?)
    """, (str(banned_user_id), str(banned_by_user_id), reason,
          duration, timestamp_start, timestamp_end, str(chat_id)))
    conn.commit()
    conn.close()

async def ban_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    chat = update.effective_chat
    text = update.message.text or ""

    if not text.lower().startswith("–±–∞–Ω ") and text.lower() != "–±–∞–Ω":
        return

    if not chat or chat.type == 'private':
        await update.message.reply_text("‚ùå –≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤ –≥—Ä—É–ø–ø–∞—Ö.")
        return

    args = context.args

    # -----------------------------
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    # -----------------------------
    if update.message.reply_to_message:
        banned_user_id = update.message.reply_to_message.from_user.id
        if args:
            try:
                duration_days = int(args[0])
            except ValueError:
                duration_days = 1
            reason = " ".join(args[1:]) if len(args) > 1 else "–Ω–µ —É–∫–∞–∑–∞–Ω–∞"
        else:
            duration_days = 1
            reason = "–Ω–µ —É–∫–∞–∑–∞–Ω–∞"
    elif args:
        try:
            banned_user_id = int(args[0])
        except ValueError:
            await update.message.reply_text("‚ùó ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º.")
            return

        if len(args) == 1:
            duration_days = 1
            reason = "–Ω–µ —É–∫–∞–∑–∞–Ω–∞"
        elif len(args) == 2:
            try:
                duration_days = int(args[1])
                reason = "–Ω–µ —É–∫–∞–∑–∞–Ω–∞"
            except ValueError:
                duration_days = 1
                reason = args[1]
        else:
            try:
                duration_days = int(args[1])
            except ValueError:
                duration_days = 1
            reason = " ".join(args[2:])
    else:
        await update.message.reply_text(
            "‚ùó –£–∫–∞–∂–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ ID –∏–ª–∏ –æ—Ç–≤–µ—Ç–æ–º –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ.\n"
            "–ü—Ä–∏–º–µ—Ä—ã:\n"
            "/ban 123456789 7 –ù–∞—Ä—É—à–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª\n"
            "/ban 5 –ù–∞—Ä—É—à–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª (–≤ –æ—Ç–≤–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ)"
        )
        return

    if banned_user_id == user.id:
        await update.message.reply_text("‚ùå –í—ã –Ω–µ –º–æ–∂–µ—Ç–µ –∑–∞–±–∞–Ω–∏—Ç—å —Å–µ–±—è.")
        return

    # -----------------------------
    # –í—Ä–µ–º—è –±–∞–Ω–∞
    # -----------------------------
    duration_seconds = duration_days * 86400
    timestamp_start = int(time.time())
    timestamp_end = timestamp_start + duration_seconds

    # -----------------------------
    # –ü—Ä–∏–º–µ–Ω—è–µ–º –±–∞–Ω
    # -----------------------------
    try:
        await context.bot.ban_chat_member(
            chat_id=chat.id,
            user_id=banned_user_id,
            until_date=timestamp_end,
            revoke_messages=True
        )
    except Exception as e:
        await update.message.reply_text(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–±–∞–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {html.escape(str(e))}")
        return

    # -----------------------------
    # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –≤ –ë–î
    # -----------------------------
    try:
        save_ban_to_db(
            banned_user_id=banned_user_id,
            banned_by_user_id=str(user.id),
            reason=reason,
            duration=duration_seconds,
            timestamp_start=timestamp_start,
            timestamp_end=timestamp_end,
            chat_id=str(chat.id)
        )
    except Exception as e:
        await update.message.reply_text(f"‚ö† –ë–∞–Ω –≤—ã–ø–æ–ª–Ω–µ–Ω, –Ω–æ –Ω–µ –∑–∞–ø–∏—Å–∞–Ω –≤ –±–∞–∑—É: {html.escape(str(e))}")

    # -----------------------------
    # –†–µ–π—Ç–∏–Ω–≥
    # -----------------------------
    change_user_rating(banned_user_id, -5)  # –æ–±—ã—á–Ω—ã–π –±–∞–Ω: -5

    # -----------------------------
    # –£–ø–æ–º–∏–Ω–∞–Ω–∏—è
    # -----------------------------
    try:
        banned_user = await context.bot.get_chat(banned_user_id)
        banned_mention = get_display_name_html_new(banned_user)
    except:
        banned_mention = f"<code>{html.escape(str(banned_user_id))}</code>"

    admin_mention = get_display_name_html_new(user)

    # -----------------------------
    # –°–æ–æ–±—â–µ–Ω–∏–µ –æ –±–∞–Ω–µ
    # -----------------------------
    await update.message.reply_text(
        f"üö´ <b>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω</b>\n\n"
        f"‚Ä¢ <b>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</b> {banned_mention}\n"
        f"‚Ä¢ <b>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä:</b> {admin_mention}\n"
        f"‚Ä¢ <b>–°—Ä–æ–∫:</b> {duration_days} –¥–Ω.\n"
        f"‚Ä¢ <b>–ü—Ä–∏—á–∏–Ω–∞:</b> {html.escape(reason)}",
        parse_mode=ParseMode.HTML
    )

    # -----------------------------
    # –õ–æ–≥
    # -----------------------------
    write_log(
        log_type="bans",
        admin_id=user.id,
        target_id=banned_user_id,
        duration=f"{duration_days} –¥–Ω.",
        reason=reason or "-",
        chat_id=str(chat.id),
        action="–í—ã–¥–∞—á–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏"
    )

async def pinmms_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    chat = update.effective_chat
    message = update.message

    if not chat or chat.type == 'private':
        await message.reply_text("‚ùå –≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤ –≥—Ä—É–ø–ø–æ–≤—ã—Ö —á–∞—Ç–∞—Ö.")
        return

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–æ–º–∞–Ω–¥–∞ ‚Äî –æ—Ç–≤–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ
    if not message.reply_to_message:
        await message.reply_text("‚ùó –ö–æ–º–∞–Ω–¥–∞ –¥–æ–ª–∂–Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –≤ –æ—Ç–≤–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –Ω—É–∂–Ω–æ –∑–∞–∫—Ä–µ–ø–∏—Ç—å.")
        return

    message_id_to_pin = message.reply_to_message.message_id

    user_id_str = str(user.id)
    chat_id_str = str(chat.id)

    try:
        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()

        # –ü–æ–ª—É—á–∞–µ–º —É—Ä–æ–≤–µ–Ω—å, –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–π –¥–ª—è –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏—è
        cursor.execute("SELECT pin_level FROM chat_settings WHERE chat_id = ?", (chat_id_str,))
        row = cursor.fetchone()
        pin_level_required = row[0] if row else 7

        # –ü–æ–ª—É—á–∞–µ–º —É—Ä–æ–≤–µ–Ω—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        cursor.execute(
            "SELECT admin_level FROM chat_admins WHERE chat_id = ? AND user_id = ?",
            (chat_id_str, user_id_str)
        )
        row = cursor.fetchone()

        if not row:
            await message.reply_text("‚ùå –í—ã –Ω–µ —è–≤–ª—è–µ—Ç–µ—Å—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º —ç—Ç–æ–≥–æ —á–∞—Ç–∞.")
            return

        user_admin_level = row[0]

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞—Ç–µ–ª–µ–º —á–∞—Ç–∞
        chat_member = await context.bot.get_chat_member(chat.id, user.id)
        is_creator = chat_member.status == "creator"

        if not is_creator and user_admin_level < pin_level_required:
            required_role = CHAT_ADMINS_ROLE_LIST[pin_level_required] if 0 <= pin_level_required < len(
                CHAT_ADMINS_ROLE_LIST) else str(pin_level_required)
            user_role = CHAT_ADMINS_ROLE_LIST[user_admin_level] if 0 <= user_admin_level < len(
                CHAT_ADMINS_ROLE_LIST) else str(user_admin_level)

            await message.reply_text(
                (
                    f"‚ùå *–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞!* üîí\n\n"
                    f"üõ°Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è —Ä–∞–Ω–≥ *{required_role}* –∏–ª–∏ –≤—ã—à–µ –¥–ª—è –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π.\n"
                    f"üë§ –í–∞—à —Ç–µ–∫—É—â–∏–π —Ä–∞–Ω–≥: *{user_role}*"
                ),
                parse_mode=ParseMode.MARKDOWN
            )
            return

        # –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–∫—Ä–µ–ø–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
        try:
            await context.bot.pin_chat_message(chat.id, message_id_to_pin)
            await message.reply_text(f"‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–æ.")
        except Exception as e:
            await message.reply_text(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–∫—Ä–µ–ø–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ: {e}")

    finally:
        conn.close()


async def unpinmms_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    chat = update.effective_chat
    message = update.message

    if not chat or chat.type == 'private':
        await message.reply_text("‚ùå –≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤ –≥—Ä—É–ø–ø–æ–≤—ã—Ö —á–∞—Ç–∞—Ö.")
        return

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–æ–º–∞–Ω–¥–∞ ‚Äî –æ—Ç–≤–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ
    if not message.reply_to_message:
        await message.reply_text("‚ùó –ö–æ–º–∞–Ω–¥–∞ –¥–æ–ª–∂–Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –≤ –æ—Ç–≤–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –Ω—É–∂–Ω–æ –æ—Ç–∫—Ä–µ–ø–∏—Ç—å.")
        return

    message_id_to_unpin = message.reply_to_message.message_id

    user_id_str = str(user.id)
    chat_id_str = str(chat.id)

    try:
        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()

        # –ü–æ–ª—É—á–∞–µ–º —É—Ä–æ–≤–µ–Ω—å, –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–π –¥–ª—è –æ—Ç–∫—Ä–µ–ø–ª–µ–Ω–∏—è
        cursor.execute("SELECT pin_level FROM chat_settings WHERE chat_id = ?", (chat_id_str,))
        row = cursor.fetchone()
        pin_level_required = row[0] if row else 7

        # –ü–æ–ª—É—á–∞–µ–º —É—Ä–æ–≤–µ–Ω—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        cursor.execute(
            "SELECT admin_level FROM chat_admins WHERE chat_id = ? AND user_id = ?",
            (chat_id_str, user_id_str)
        )
        row = cursor.fetchone()

        if not row:
            await message.reply_text("‚ùå –í—ã –Ω–µ —è–≤–ª—è–µ—Ç–µ—Å—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º —ç—Ç–æ–≥–æ —á–∞—Ç–∞.")
            return

        user_admin_level = row[0]

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞—Ç–µ–ª–µ–º —á–∞—Ç–∞
        chat_member = await context.bot.get_chat_member(chat.id, user.id)
        is_creator = chat_member.status == "creator"

        if not is_creator and user_admin_level < pin_level_required:
            required_role = CHAT_ADMINS_ROLE_LIST[pin_level_required] if 0 <= pin_level_required < len(
                CHAT_ADMINS_ROLE_LIST) else str(pin_level_required)
            user_role = CHAT_ADMINS_ROLE_LIST[user_admin_level] if 0 <= user_admin_level < len(
                CHAT_ADMINS_ROLE_LIST) else str(user_admin_level)

            await message.reply_text(
                (
                    f"‚ùå *–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞!* üîí\n\n"
                    f"üõ°Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è —Ä–∞–Ω–≥ *{required_role}* –∏–ª–∏ –≤—ã—à–µ –¥–ª—è –æ—Ç–∫—Ä–µ–ø–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π.\n"
                    f"üë§ –í–∞—à —Ç–µ–∫—É—â–∏–π —Ä–∞–Ω–≥: *{user_role}*"
                ),
                parse_mode=ParseMode.MARKDOWN
            )
            return

        # –ü—ã—Ç–∞–µ–º—Å—è –æ—Ç–∫—Ä–µ–ø–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
        try:
            await context.bot.unpin_chat_message(chat.id, message_id_to_unpin)
            await message.reply_text(f"‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–∫—Ä–µ–ø–ª–µ–Ω–æ.")
        except Exception as e:
            await message.reply_text(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä–µ–ø–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ: {e}")

    finally:
        conn.close()


async def permban_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    chat = update.effective_chat

    if not chat or chat.type == 'private':
        await update.message.reply_text("‚ùå –≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤ –≥—Ä—É–ø–ø–æ–≤—ã—Ö —á–∞—Ç–∞—Ö.")
        return

    user_id_str = str(user.id)
    chat_id_str = str(chat.id)

    try:
        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Ä–æ–≤–µ–Ω—å –¥–æ—Å—Ç—É–ø–∞ –¥–ª—è –≤–µ—á–Ω–æ–≥–æ –±–∞–Ω–∞
        cursor.execute("SELECT ban_level FROM chat_settings WHERE chat_id = ?", (chat_id_str,))
        row = cursor.fetchone()
        permban_level_required = row[0] if row else 7  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é 7

        # –ü–æ–ª—É—á–∞–µ–º —É—Ä–æ–≤–µ–Ω—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
        cursor.execute(
            "SELECT admin_level FROM chat_admins WHERE chat_id = ? AND user_id = ?",
            (chat_id_str, user_id_str)
        )
        row = cursor.fetchone()

        if not row:
            await update.message.reply_text("‚ùå –í—ã –Ω–µ —è–≤–ª—è–µ—Ç–µ—Å—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º —ç—Ç–æ–≥–æ —á–∞—Ç–∞.")
            return

        user_admin_level = row[0]

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å–æ–∑–¥–∞—Ç–µ–ª–µ–º
        chat_member = await context.bot.get_chat_member(chat.id, user.id)
        is_creator = chat_member.status == "creator"

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Ä–æ–≤–µ–Ω—å –ø—Ä–∞–≤
        if not is_creator and user_admin_level < permban_level_required:
            required_role = CHAT_ADMINS_ROLE_LIST[permban_level_required] if 0 <= permban_level_required < len(
                CHAT_ADMINS_ROLE_LIST) else str(permban_level_required)
            user_role = CHAT_ADMINS_ROLE_LIST[user_admin_level] if 0 <= user_admin_level < len(
                CHAT_ADMINS_ROLE_LIST) else str(user_admin_level)

            await update.message.reply_text(
                (
                    f"‚ùå <b>–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∫–æ–º–∞–Ω–¥—É...</b>\n\n"
                    f"üõ°Ô∏è –î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã —Ç—Ä–µ–±—É–µ—Ç—Å—è —Ä–∞–Ω–≥ <b>{html.escape(required_role)}</b> –∏–ª–∏ –≤—ã—à–µ.\n"
                    f"üë§ –í–∞—à —Ç–µ–∫—É—â–∏–π —Ä–∞–Ω–≥: <b>{html.escape(user_role)}</b>"
                ),
                parse_mode=ParseMode.HTML
            )
            return

    except Exception as e:
        await update.message.reply_text(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –ø—Ä–∞–≤: {html.escape(str(e))}")
        return
    finally:
        conn.close()

    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫–æ–≥–æ –±–∞–Ω–∏–º
    if context.args:
        try:
            banned_user_id = int(context.args[0])
        except ValueError:
            await update.message.reply_text("‚ùó ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º.")
            return

        reason = ' '.join(context.args[1:]) if len(context.args) > 1 else None

    elif update.message.reply_to_message:
        banned_user_id = update.message.reply_to_message.from_user.id
        reason = ' '.join(context.args) if context.args else None
    else:
        await update.message.reply_text(
            "‚ùó –£–∫–∞–∂–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ ID –∏–ª–∏ –æ—Ç–≤–µ—Ç–æ–º –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ.\n"
            "–ü—Ä–∏–º–µ—Ä—ã:\n"
            "/permban 123456789 –ø—Ä–∏—á–∏–Ω–∞\n"
            "/permban (–≤ –æ—Ç–≤–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ)"
        )
        return

    if banned_user_id == user.id:
        await update.message.reply_text("‚ùå –í—ã –Ω–µ –º–æ–∂–µ—Ç–µ –∑–∞–±–∞–Ω–∏—Ç—å —Å–µ–±—è.")
        return

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –º–æ–∂–Ω–æ –ª–∏ –±–∞–Ω–∏—Ç—å
    try:
        chat_member = await context.bot.get_chat_member(chat.id, banned_user_id)
        if chat_member.status == "kicked":
            await update.message.reply_text("‚ùó –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω.")
            return

        if chat_member.status in ["administrator", "creator"]:
            target_admin_level = 999 if chat_member.status == "creator" else (
                    getattr(chat_member, 'custom_title', 0) or 0
            )

            if not is_creator and user_admin_level <= target_admin_level:
                await update.message.reply_text(
                    "‚ùå –í—ã –Ω–µ –º–æ–∂–µ—Ç–µ –∑–∞–±–∞–Ω–∏—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ —Å —Ä–∞–≤–Ω—ã–º –∏–ª–∏ –±–æ–ª–µ–µ –≤—ã—Å–æ–∫–∏–º —Ä–∞–Ω–≥–æ–º."
                )
                return

    except BadRequest as e:
        if "user not found" in str(e).lower():
            await update.message.reply_text("‚ùó –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω.")
        else:
            await update.message.reply_text(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {html.escape(str(e))}")
        return

    # –ü—Ä–∏–º–µ–Ω—è–µ–º –±–∞–Ω
    try:
        await context.bot.ban_chat_member(
            chat_id=chat.id,
            user_id=banned_user_id,
            until_date=None,  # –±–µ—Å—Å—Ä–æ—á–Ω—ã–π –±–∞–Ω
            revoke_messages=True
        )
    except Exception as e:
        await update.message.reply_text(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–±–∞–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {html.escape(str(e))}")
        return

    timestamp_start = int(time.time())
    try:
        save_ban_to_db(
            banned_user_id=banned_user_id,
            banned_by_user_id=user_id_str,
            reason=reason,
            duration=-1,  # –±–µ—Å—Å—Ä–æ—á–Ω—ã–π –±–∞–Ω
            timestamp_start=timestamp_start,
            timestamp_end=-1,
            chat_id=chat_id_str
        )
    except Exception as e:
        await update.message.reply_text(f"‚ö† –ë–∞–Ω –≤—ã–ø–æ–ª–Ω–µ–Ω, –Ω–æ –Ω–µ –∑–∞–ø–∏—Å–∞–Ω –≤ –±–∞–∑—É: {html.escape(str(e))}")

    # –£–ø–æ–º–∏–Ω–∞–Ω–∏—è —á–µ—Ä–µ–∑ —Ç–≤–æ—é —Ñ—É–Ω–∫—Ü–∏—é
    try:
        banned_user = await context.bot.get_chat(banned_user_id)
        banned_mention = get_display_name_html_new(banned_user)
    except:
        banned_mention = f"<code>{html.escape(str(banned_user_id))}</code>"

    admin_mention = get_display_name_html_new(user)

    ban_message = (
        f"‚õî <b>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –Ω–∞–≤—Å–µ–≥–¥–∞</b>\n\n"
        f"‚Ä¢ <b>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</b> {banned_mention}\n"
        f"‚Ä¢ <b>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä:</b> {admin_mention}\n"
        f"‚Ä¢ <b>–ü—Ä–∏—á–∏–Ω–∞:</b> {html.escape(reason) if reason else '–Ω–µ —É–∫–∞–∑–∞–Ω–∞'}"
    )

    await update.message.reply_text(ban_message, parse_mode=ParseMode.HTML)


    # –õ–æ–≥
    write_log(
        log_type="bans",
        admin_id=user.id,
        target_id=banned_user_id,
        duration="–Ω–∞–≤—Å–µ–≥–¥–∞",
        reason=reason or "-",
        chat_id=str(chat.id),
        action="–í—ã–¥–∞—á–∞ –≤–µ—á–Ω–æ–π –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏"
    )
async def unban_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    chat = update.effective_chat

    if not chat or chat.type == 'private':
        await update.message.reply_text("‚ùå –≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤ –≥—Ä—É–ø–ø–æ–≤—ã—Ö —á–∞—Ç–∞—Ö.")
        return

    user_id_str = str(user.id)
    chat_id_str = str(chat.id)

    try:
        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()

        # –ü–æ–ª—É—á–∞–µ–º —Ç—Ä–µ–±—É–µ–º—ã–π —É—Ä–æ–≤–µ–Ω—å –¥–æ—Å—Ç—É–ø–∞ –¥–ª—è —Ä–∞–∑–±–∞–Ω–∞
        cursor.execute("SELECT ban_level FROM chat_settings WHERE chat_id = ?", (chat_id_str,))
        row = cursor.fetchone()
        unban_level_required = row[0] if row else 7

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞—Ç–µ–ª–µ–º
        chat_member = await context.bot.get_chat_member(chat.id, user.id)
        is_creator = chat_member.status == "creator"

        if not is_creator:
            cursor.execute(
                "SELECT admin_level FROM chat_admins WHERE chat_id = ? AND user_id = ?",
                (chat_id_str, user_id_str)
            )
            row = cursor.fetchone()
            if not row:
                await update.message.reply_text("‚ùå –í—ã –Ω–µ —è–≤–ª—è–µ—Ç–µ—Å—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º —ç—Ç–æ–≥–æ —á–∞—Ç–∞.")
                return
            user_admin_level = row[0]

            if user_admin_level < unban_level_required:
                required_role = CHAT_ADMINS_ROLE_LIST[unban_level_required] if 0 <= unban_level_required < len(
                    CHAT_ADMINS_ROLE_LIST) else str(unban_level_required)
                user_role = CHAT_ADMINS_ROLE_LIST[user_admin_level] if 0 <= user_admin_level < len(
                    CHAT_ADMINS_ROLE_LIST) else str(user_admin_level)

                await update.message.reply_text(
                    (
                        f"‚ùå <b>–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∫–æ–º–∞–Ω–¥—É...</b>\n\n"
                        f"üõ°Ô∏è –î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã —Ç—Ä–µ–±—É–µ—Ç—Å—è —Ä–∞–Ω–≥ <b>{html.escape(required_role)}</b> –∏–ª–∏ –≤—ã—à–µ.\n"
                        f"üë§ –í–∞—à —Ç–µ–∫—É—â–∏–π —Ä–∞–Ω–≥: <b>{html.escape(user_role)}</b>"
                    ),
                    parse_mode=ParseMode.HTML
                )
                return
        else:
            user_admin_level = "–°–æ–∑–¥–∞—Ç–µ–ª—å"

        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫–æ–≥–æ —Ä–∞–∑–±–∞–Ω–∏—Ç—å
        if context.args and len(context.args) >= 1:
            user_identifier = context.args[0]
            try:
                if user_identifier.startswith("@"):
                    user_data = await context.bot.get_chat(user_identifier)
                    target_id = user_data.id
                else:
                    target_id = int(user_identifier)
            except (ValueError, BadRequest):
                await update.message.reply_text("‚ùó –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.")
                return
            except Exception as e:
                await update.message.reply_text(f"‚ùó –û—à–∏–±–∫–∞: {html.escape(str(e))}")
                return
        elif update.message.reply_to_message:
            target_id = update.message.reply_to_message.from_user.id
        else:
            await update.message.reply_text(
                "‚ùó –£–∫–∞–∂–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è —Ä–∞–∑–±–∞–Ω–∞:\n"
                "- –ß–µ—Ä–µ–∑ ID (/unban 123456789)\n"
                "- –ß–µ—Ä–µ–∑ @username (/unban @user)\n"
                "- –ò–ª–∏ –æ—Ç–≤–µ—Ç–æ–º –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ"
            )
            return

        if target_id == user.id:
            await update.message.reply_text("‚ùå –í—ã –Ω–µ –º–æ–∂–µ—Ç–µ —Ä–∞–∑–±–∞–Ω–∏—Ç—å —Å–µ–±—è.")
            return

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –±–∞–Ω–µ
        try:
            target_member = await context.bot.get_chat_member(chat.id, target_id)
            is_banned = target_member.status == "kicked"
        except BadRequest:
            is_banned = False

        # –£–¥–∞–ª—è–µ–º –∑–∞–ø–∏—Å—å –æ –±–∞–Ω–µ –∏–∑ –±–∞–∑—ã
        cursor.execute(
            "DELETE FROM bans WHERE banned_user_id = ? AND chat_id = ?",
            (str(target_id), chat_id_str)
        )
        deleted_count = cursor.rowcount
        conn.commit()

        # –£–ø–æ–º–∏–Ω–∞–Ω–∏—è
        try:
            unbanned_user = await context.bot.get_chat(target_id)
            unbanned_mention = get_display_name_html_new(unbanned_user)
        except:
            unbanned_mention = f"<code>{html.escape(str(target_id))}</code>"

        admin_mention = get_display_name_html_new(user)

        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –≤—ã–ø–æ–ª–Ω—è–µ–º —Ä–∞–∑–±–∞–Ω
        if deleted_count > 0:
            change_user_rating(target_id, +7)
            if is_banned:
                await context.bot.unban_chat_member(chat_id=chat.id, user_id=target_id, only_if_banned=True)
            message = (
                f"‚úÖ <b>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω</b>\n\n"
                f"‚Ä¢ <b>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</b> {unbanned_mention}\n"
                f"‚Ä¢ <b>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä:</b> {admin_mention}\n"
                f"‚Ä¢ <b>–£—Ä–æ–≤–µ–Ω—å –¥–æ—Å—Ç—É–ø–∞:</b> {user_admin_level}"
            )
        elif is_banned:
            # –í Telegram –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω, –Ω–æ –≤ –ë–î –∑–∞–ø–∏—Å–∏ –Ω–µ—Ç ‚Äî –≤—Å—ë —Ä–∞–≤–Ω–æ —Ä–∞–∑–±–∞–Ω–∏–≤–∞–µ–º
            await context.bot.unban_chat_member(chat_id=chat.id, user_id=target_id, only_if_banned=True)
            message = (
                f"‚ÑπÔ∏è <b>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω</b>\n\n"
                f"‚Ä¢ <b>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</b> {unbanned_mention}"
            )
        else:
            message = "‚ÑπÔ∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –±—ã–ª –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω."

        await update.message.reply_text(message, parse_mode=ParseMode.HTML)

    except Exception as e:
        await update.message.reply_text(f"‚ùå –û—à–∏–±–∫–∞: {html.escape(str(e))}")
    finally:
        conn.close()

        write_log(
            log_type="bans",
            admin_id=user.id,
            target_id=target_id if 'target_id' in locals() else None,
            duration="-",
            reason="-",
            chat_id=str(chat.id),
            action="–°–Ω—è—Ç–∏–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏"
        )

async def kick_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    chat = update.effective_chat

    if chat.type == "private":
        await update.message.reply_text("‚ùå –≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤ –≥—Ä—É–ø–ø–æ–≤—ã—Ö —á–∞—Ç–∞—Ö.")
        return

    user_id_str = str(user.id)
    chat_id_str = str(chat.id)

    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    cursor.execute("SELECT kick_level FROM chat_settings WHERE chat_id = ?", (chat_id_str,))
    row = cursor.fetchone()
    kick_level_required = row[0] if row else 7  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é 7 (–í–ª–∞–¥–µ–ª–µ—Ü)

    chat_member = await context.bot.get_chat_member(chat.id, user.id)
    is_creator = chat_member.status == "creator"

    if not is_creator:
        cursor.execute(
            "SELECT admin_level FROM chat_admins WHERE chat_id = ? AND user_id = ?",
            (chat_id_str, user_id_str)
        )
        row = cursor.fetchone()
        if not row:
            await update.message.reply_text("‚ùå –í—ã –Ω–µ —è–≤–ª—è–µ—Ç–µ—Å—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º —ç—Ç–æ–≥–æ —á–∞—Ç–∞.")
            conn.close()
            return

        user_admin_level = row[0]
        if user_admin_level < kick_level_required:
            required_role = CHAT_ADMINS_ROLE_LIST[kick_level_required] if 0 <= kick_level_required < len(
                CHAT_ADMINS_ROLE_LIST) else str(kick_level_required)
            user_role = CHAT_ADMINS_ROLE_LIST[user_admin_level] if 0 <= user_admin_level < len(
                CHAT_ADMINS_ROLE_LIST) else str(user_admin_level)

            await update.message.reply_text(
                (
                    f"‚ùå <b>–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∫–æ–º–∞–Ω–¥—É...</b>\n\n"
                    f"üõ°Ô∏è –î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã —Ç—Ä–µ–±—É–µ—Ç—Å—è —Ä–∞–Ω–≥ <b>{html.escape(required_role)}</b> –∏–ª–∏ –≤—ã—à–µ.\n"
                    f"üë§ –í–∞—à —Ç–µ–∫—É—â–∏–π —Ä–∞–Ω–≥: <b>{html.escape(user_role)}</b>"
                ),
                parse_mode=ParseMode.HTML
            )
            conn.close()
            return

    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –∫–∏–∫–∞
    if context.args:
        try:
            kicked_user_id = int(context.args[0])
        except ValueError:
            await update.message.reply_text("‚ùó ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º.")
            conn.close()
            return
    elif update.message.reply_to_message:
        kicked_user_id = update.message.reply_to_message.from_user.id
    else:
        await update.message.reply_text(
            "‚ùó –£–∫–∞–∂–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ ID –∏–ª–∏ –æ—Ç–≤–µ—Ç–æ–º –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ.\n"
            "–ü—Ä–∏–º–µ—Ä: –∫–∏–∫ 123456789"
        )
        conn.close()
        return

    try:
        chat_member = await context.bot.get_chat_member(chat.id, kicked_user_id)
        if chat_member.status in ("left", "kicked"):
            await update.message.reply_text("‚ùó –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –Ω–µ –≤ —á–∞—Ç–µ.")
            conn.close()
            return
    except BadRequest as e:
        await update.message.reply_text(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {html.escape(str(e))}")
        conn.close()
        return

    try:
        await context.bot.ban_chat_member(chat.id, kicked_user_id)
        await context.bot.unban_chat_member(chat.id, kicked_user_id)
    except BadRequest as e:
        await update.message.reply_text(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–≥–Ω–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {html.escape(str(e))}")
        conn.close()
        return

    try:
        kicked_user_obj = await context.bot.get_chat(kicked_user_id)
        kicked_mention = get_display_name_html_new(kicked_user_obj)
    except:
        kicked_mention = f"<code>{html.escape(str(kicked_user_id))}</code>"

    admin_mention = get_display_name_html_new(user)

    text = (
        f"üë¢ <b>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–≥–Ω–∞–Ω</b>\n\n"
        f"üë§ <b>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</b> {kicked_mention}\n"
        f"üõ°Ô∏è <b>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä:</b> {admin_mention}"
    )

    await update.message.reply_text(text, parse_mode=ParseMode.HTML)
    conn.close()

async def binfo_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    chat = update.effective_chat

    if not chat or chat.type == "private":
        await update.message.reply_text("‚ùå –≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤ –≥—Ä—É–ø–ø–æ–≤—ã—Ö —á–∞—Ç–∞—Ö.")
        return

    user_id_str = str(user.id)
    chat_id_str = str(chat.id)

    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    cursor.execute("SELECT ban_level FROM chat_settings WHERE chat_id = ?", (chat_id_str,))
    row = cursor.fetchone()
    ban_level_required = row[0] if row else 7

    chat_member = await context.bot.get_chat_member(chat.id, user.id)
    is_creator = chat_member.status == "creator"

    if not is_creator:
        cursor.execute(
            "SELECT admin_level FROM chat_admins WHERE chat_id = ? AND user_id = ?",
            (chat_id_str, user_id_str)
        )
        row = cursor.fetchone()
        if not row:
            await update.message.reply_text("‚ùå –í—ã –Ω–µ —è–≤–ª—è–µ—Ç–µ—Å—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º —ç—Ç–æ–≥–æ —á–∞—Ç–∞.")
            conn.close()
            return
        user_admin_level = row[0]

        if user_admin_level < ban_level_required:
            required_role = CHAT_ADMINS_ROLE_LIST[ban_level_required] if 0 <= ban_level_required < len(
                CHAT_ADMINS_ROLE_LIST) else f"–£—Ä–æ–≤–µ–Ω—å {ban_level_required}"
            user_role = CHAT_ADMINS_ROLE_LIST[user_admin_level] if 0 <= user_admin_level < len(
                CHAT_ADMINS_ROLE_LIST) else f"–£—Ä–æ–≤–µ–Ω—å {user_admin_level}"

            await update.message.reply_text(
                (
                    f"‚ùå <b>–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∫–æ–º–∞–Ω–¥—É...</b>\n\n"
                    f"üõ°Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è: <b>{html.escape(required_role)}</b> –∏–ª–∏ –≤—ã—à–µ.\n"
                    f"üë§ –í–∞—à–∞ —Ä–æ–ª—å: <b>{html.escape(user_role)}</b>"
                ),
                parse_mode=ParseMode.HTML
            )
            conn.close()
            return

    message_text = update.message.text or ""
    args = message_text.strip().split()[1:]

    if args:
        target_id = args[0]
    elif update.message.reply_to_message:
        target_id = str(update.message.reply_to_message.from_user.id)
    else:
        await update.message.reply_text(
            "‚ùó –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:\n<code>–±–∏–Ω—Ñ–æ {TelegramID}</code> –∏–ª–∏ –æ—Ç–≤–µ—Ç–æ–º –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ",
            parse_mode="HTML"
        )
        conn.close()
        return

    now = int(time.time())

    # –ò—â–µ–º –±–∞–Ω: –æ–±—ã—á–Ω—ã–π (timestamp_end > now) –∏–ª–∏ –≤–µ—á–Ω—ã–π (timestamp_end = -1)
    cursor.execute(
        "SELECT banned_by_user_id, reason, timestamp_end FROM bans WHERE banned_user_id = ? AND (timestamp_end > ? OR timestamp_end = -1)",
        (target_id, now)
    )
    ban = cursor.fetchone()
    conn.close()

    if not ban:
        await update.message.reply_text("‚úÖ –£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –±–∞–Ω–∞.")
        return

    banned_by_id, reason, timestamp_end = ban

    # –ü–æ–ª—É—á–∞–µ–º –∏–º–µ–Ω–∞
    try:
        admin_member = await context.bot.get_chat_member(chat.id, int(banned_by_id))
        admin_mention = get_display_name_html_new(admin_member.user)
    except:
        admin_mention = f"<code>{html.escape(str(banned_by_id))}</code>"

    try:
        banned_member = await context.bot.get_chat(int(target_id))
        banned_mention = get_display_name_html_new(banned_member)
    except:
        banned_mention = f"<code>{html.escape(str(target_id))}</code>"

    # –§–æ—Ä–º–∞—Ç –≤—Ä–µ–º–µ–Ω–∏
    try:
        timestamp_end = int(timestamp_end)
        if timestamp_end == -1:
            ban_end_str = "–ù–∞–≤—Å–µ–≥–¥–∞"
            time_left_str = "–ë–µ—Å—Å—Ä–æ—á–Ω–æ"
        else:
            if timestamp_end > 1e12:
                timestamp_end //= 1000

            dt_utc = datetime.fromtimestamp(timestamp_end, timezone.utc)
            dt_msk = dt_utc.astimezone(timezone(timedelta(hours=3)))
            ban_end_str = dt_msk.strftime("%Y-%m-%d %H:%M:%S")

            seconds_left = timestamp_end - now
            days = seconds_left // 86400
            hours = (seconds_left % 86400) // 3600
            minutes = (seconds_left % 3600) // 60
            secs = seconds_left % 60
            time_left_str = f"{days} –¥–Ω {hours} —á {minutes} –º–∏–Ω {secs} —Å–µ–∫"
    except:
        ban_end_str = "–ù–∞–≤—Å–µ–≥–¥–∞"
        time_left_str = "–ë–µ—Å—Å—Ä–æ—á–Ω–æ"

    chat_title = html.escape(chat.title or "–ß–∞—Ç")
    if str(chat.id).startswith("-100"):
        short_id = str(chat.id)[4:]
        chat_link = f'<a href="https://t.me/c/{short_id}/1">{chat_title}</a>'
    else:
        chat_link = chat_title

    text = (
        f"üö´ <b>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ</b>\n\n"
        f"üë§ <b>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</b> {banned_mention}\n"
        f"üõ°Ô∏è <b>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä:</b> {admin_mention}\n"
        f"üìù <b>–ü—Ä–∏—á–∏–Ω–∞:</b> {html.escape(reason or '–Ω–µ —É–∫–∞–∑–∞–Ω–∞')}\n\n"
        f"‚ùó <b>–°—Ç–∞—Ç—É—Å:</b> –ë–∞–Ω –∞–∫—Ç–∏–≤–µ–Ω\n"
        f"üïí <b>–û—Å—Ç–∞–ª–æ—Å—å:</b> {time_left_str}\n"
        f"üìÖ <b>–î–∞—Ç–∞ —Å–Ω—è—Ç–∏—è (–ú–°–ö):</b> {ban_end_str}\n\n"
        f"üè∑ <b>–ß–∞—Ç:</b> {chat_link}"
    )

    await update.message.reply_text(text, parse_mode=ParseMode.HTML)

async def check_expired_mutes(context: ContextTypes.DEFAULT_TYPE):
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    now = int(time.time())
    cursor.execute("""
        SELECT muted_user_id, muted_by_user_id, reason, timestamp_end, chat_id FROM mutes
        WHERE timestamp_end <= ?
    """, (now,))
    expired = cursor.fetchall()

    for mute in expired:
        muted_user_id, muted_by_user_id, reason, timestamp_end, chat_id = mute

        print(f"–ü–æ–ø—ã—Ç–∫–∞ —Å–Ω—è—Ç—å –º—É—Ç: chat_id={chat_id}, muted_user_id={muted_user_id}")

        try:
            await context.bot.restrict_chat_member(
                chat_id=chat_id,
                user_id=muted_user_id,
                permissions=ChatPermissions(
                    can_send_messages=True,
                    can_send_polls=True,
                    can_send_other_messages=True,
                    can_add_web_page_previews=True,
                    can_change_info=False,
                    can_invite_users=True,
                    can_pin_messages=False,
                ),
                until_date=0
            )
        except Exception as e:
            print(f"–ù–µ —É–¥–∞–ª–æ—Å—å —Å–Ω—è—Ç—å –º—É—Ç (chat_id={chat_id}, user_id={muted_user_id}): {e}")
            # –£–¥–∞–ª—è–µ–º –∑–∞–ø–∏—Å—å –∏–∑ –±–∞–∑—ã, —á—Ç–æ–±—ã –Ω–µ –ø—ã—Ç–∞—Ç—å—Å—è —Å–Ω–æ–≤–∞
            cursor.execute("DELETE FROM mutes WHERE muted_user_id=? AND chat_id=?", (muted_user_id, chat_id))
            conn.commit()
            continue

        # –ï—Å–ª–∏ —Å–Ω—è—Ç–∏–µ –ø—Ä–æ—à–ª–æ —É—Å–ø–µ—à–Ω–æ ‚Äî —É–¥–∞–ª—è–µ–º –∑–∞–ø–∏—Å—å –∏–∑ –±–∞–∑—ã
        cursor.execute("DELETE FROM mutes WHERE muted_user_id=? AND chat_id=?", (muted_user_id, chat_id))
        conn.commit()

        try:
            member = await context.bot.get_chat_member(chat_id, muted_user_id)
            user_name = member.user.full_name
            user_mention = f"[{user_name}](tg://user?id={muted_user_id})"
        except Exception:
            user_mention = f"`{muted_user_id}`"

        try:
            await context.bot.send_message(
                chat_id=chat_id,
                text=f"‚úÖ –í—Ä–µ–º—è –º—É—Ç–∞ –≤—ã—à–ª–æ, –º—É—Ç —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_mention} —Å–Ω—è—Ç.",
                parse_mode="Markdown"
            )
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ —Å–Ω—è—Ç–∏–∏ –º—É—Ç–∞ (chat_id={chat_id}): {e}")

    conn.close()


async def check_expired_bans(context: ContextTypes.DEFAULT_TYPE):
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    now = int(time.time())
    cursor.execute("""
        SELECT banned_user_id, banned_by_user_id, reason, timestamp_end, chat_id FROM bans
        WHERE timestamp_end != -1 AND timestamp_end <= ?
    """, (now,))
    expired = cursor.fetchall()

    for ban in expired:
        banned_user_id, banned_by_user_id, reason, timestamp_end, chat_id = ban

        if not chat_id:
            cursor.execute("DELETE FROM bans WHERE banned_user_id=? AND (chat_id IS NULL OR chat_id='')",
                           (banned_user_id,))
            conn.commit()
            continue

        print(f"–ü–æ–ø—ã—Ç–∫–∞ —Å–Ω—è—Ç—å –±–∞–Ω: chat_id={chat_id}, banned_user_id={banned_user_id}")

        try:
            await context.bot.unban_chat_member(
                chat_id=chat_id,
                user_id=banned_user_id,
                only_if_banned=True
            )
        except Exception as e:
            print(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–Ω—è—Ç—å –±–∞–Ω: {e}")
            cursor.execute("DELETE FROM bans WHERE banned_user_id=? AND chat_id=?", (banned_user_id, chat_id))
            conn.commit()
            continue

        cursor.execute("DELETE FROM bans WHERE banned_user_id=? AND chat_id=?", (banned_user_id, chat_id))
        conn.commit()

        try:
            user = await context.bot.get_chat_member(chat_id, banned_user_id)
            user_mention = f"[{user.user.full_name}](tg://user?id={banned_user_id})"
        except:
            user_mention = f"`{banned_user_id}`"

        try:
            await context.bot.send_message(
                chat_id=chat_id,
                text=f"‚úÖ –í—Ä–µ–º—è –±–∞–Ω–∞ –≤—ã—à–ª–æ, –±–∞–Ω —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_mention} —Å–Ω—è—Ç.",
                parse_mode="Markdown"
            )
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: {e}")

    conn.close()


def get_seeds(user_id: int) -> int:
    conn = sqlite3.connect(DB_PATH)
    cur = conn.cursor()
    cur.execute("SELECT seeds FROM users WHERE user_id = ?", (str(user_id),))
    row = cur.fetchone()
    conn.close()
    return row[0] if row else 0


def update_seeds(user_id: int, new_seeds: int):
    conn = sqlite3.connect(DB_PATH)
    cur = conn.cursor()
    cur.execute("SELECT 1 FROM users WHERE user_id = ?", (str(user_id),))
    if cur.fetchone():
        # –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∑–∞–ø–∏—Å—å
        cur.execute("UPDATE users SET seeds = ? WHERE user_id = ?", (new_seeds, str(user_id)))
    else:
        # –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å —Å seeds –∏ user_id
        cur.execute("INSERT INTO users (user_id, seeds) VALUES (?, ?)", (str(user_id), new_seeds))
    conn.commit()
    conn.close()

def get_user_from_db(user_id: str):
    """–ü–æ–ª—É—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –ë–î"""
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT * FROM users WHERE user_id = ?", (user_id,))
    row = cursor.fetchone()
    conn.close()
    return row


async def setseeds_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.message.from_user
    user_id = str(user.id)

    user_row = get_user_from_db(user_id)
    if not user_row:
        await update.message.reply_text("‚ùå –í—ã –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –≤ —Å–∏—Å—Ç–µ–º–µ.")
        return

    user_status = user_row[3]
    if user_status is None:
        user_status = 0
    else:
        try:
            user_status = int(user_status)
        except (TypeError, ValueError):
            user_status = 0

    user_status = get_user_status(user_id)
    if user_status < 9:  # –Ω–∏–∂–µ –ö—É—Ä–∞—Ç–æ—Ä–∞
        await update.message.reply_text("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç—É –∫–æ–º–∞–Ω–¥—É.")
        return
    if not update.message.reply_to_message:
        await update.message.reply_text("–≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ç–≤–µ—Ç–æ–º –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.")
        return

    args = context.args or []
    if len(args) != 2:
        await update.message.reply_text("–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: —Å–µ–º–µ–Ω–∞ {+/-} {–∫–æ–ª-–≤–æ}")
        return

    op = args[0]
    if op not in ["+", "-"]:
        await update.message.reply_text("–ü–µ—Ä–≤—ã–π –∞—Ä–≥—É–º–µ–Ω—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å '+' –∏–ª–∏ '-'")
        return

    try:
        amount = int(args[1])
        if amount < 0:
            await update.message.reply_text("–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º.")
            return
    except ValueError:
        await update.message.reply_text("–í—Ç–æ—Ä–æ–π –∞—Ä–≥—É–º–µ–Ω—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º.")
        return

    target_user = update.message.reply_to_message.from_user
    target_user_id = str(target_user.id)

    seeds = get_seeds(target_user_id)

    if op == "+":
        new_seeds = seeds + amount
    else:
        new_seeds = max(seeds - amount, 0)

    update_seeds(target_user_id, new_seeds)

    await update.message.reply_text(
        f"–£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è [{target_user.first_name}](tg://user?id={target_user_id}) —Ç–µ–ø–µ—Ä—å {new_seeds} —Å–µ–º—è–Ω.",
        parse_mode="Markdown"
    )


# –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä
def get_status_keyboard():
    keyboard = [
        [InlineKeyboardButton(text=status, callback_data=f"admins_status_{i}")]
        for i, status in enumerate(STATUS_LIST) if i > 0
    ]
    return InlineKeyboardMarkup(keyboard)


def get_back_button():
    return InlineKeyboardMarkup([[InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="admins_back")]])


STATUS_EMOJI = {
    0: "üë§",
    1: "üü¢",
    2: "üîµ",
    3: "üü£",
    4: "üü†",
    5: "üî¥",
    6: "‚≠ê",
    7: "üëë",
}


def get_admins_list():
    """–ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ—Ö –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ (—Å—Ç–∞—Ç—É—Å 1+)"""
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute(
        "SELECT user_id, username, first_name, status FROM users WHERE status > 0 ORDER BY status DESC, username ASC"
    )
    rows = cursor.fetchall()
    conn.close()
    return rows


def format_admins_message():
    """
    –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –∫—Ä–∞—Å–∏–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ —Å–ø–∏—Å–∫–æ–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏
    –í–∞—Ä–∏–∞–Ω—Ç: –º–æ–¥–µ—Ä–Ω —Å –∫—Ä–∞—Å–∏–≤—ã–º–∏ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è–º–∏
    """
    admins = get_admins_list()

    if not admins:
        return (
            "üõ°Ô∏è <b>–°–ø–∏—Å–æ–∫ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏</b>\n\n"
            "‚õî <i>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</i>"
        )

    # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º
    admins_by_status = {}
    for user_id, username, first_name, status in admins:
        if status not in admins_by_status:
            admins_by_status[status] = []
        admins_by_status[status].append((user_id, username, first_name))

    # –°—Ç—Ä–æ–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ
    text = "üõ°Ô∏è <b>–°–ø–∏—Å–æ–∫ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏</b>\n\n"

    for status in sorted(admins_by_status.keys(), reverse=True):
        status_name = STATUS_LIST[status] if status < len(STATUS_LIST) else "Unknown"
        emoji = STATUS_EMOJI.get(status, "‚Ä¢")
        count = len(admins_by_status[status])

        # –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç–∞—Ç—É—Å–∞
        text += f"{emoji} <b>{status_name}</b> <code>({count})</code>\n"
        text += "‚îÅ" * 10 + "\n"

        # –°–ø–∏—Å–æ–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ —ç—Ç–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞
        for i, (user_id, username, first_name) in enumerate(admins_by_status[status], 1):
            name = username if username else first_name or "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"
            text += f"  {i}. <a href='tg://user?id={user_id}'><b>{name}</b></a>\n"
            text += f"      <code>{user_id}</code>\n"

        text += "\n"

    # –ü–æ–¥–≤–∞–ª
    text += "‚îÅ" * 10 + "\n"
    text += f"<i>–í—Å–µ–≥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤:</i> <code>{len(admins)}</code>"

    return text


async def admins_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = format_admins_message()

    await update.message.reply_text(
        text,
        parse_mode='HTML'
    )


async def ver_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    PATCH_VERSION = "12.1"
    PATCH_MODER_VERSION = "7"
    FernieX_AI = "5ai"
    UpdateDate = "20.02.2026"

    # –í—Ä–µ–º–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    msg = await update.message.reply_text(
        "<b>‚è≥ –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö...</b>\n<pre>–ü–æ–¥–æ–∂–¥–∏—Ç–µ –Ω–µ–º–Ω–æ–≥–æ...</pre>",
        parse_mode="HTML"
    )
    await asyncio.sleep(1)

    # –ò–∑–º–µ—Ä—è–µ–º ping
    start_time = time.perf_counter()
    await context.bot.send_chat_action(chat_id=update.effective_chat.id, action="typing")
    end_time = time.perf_counter()
    ping_ms = (end_time - start_time) * 1000

    # CPU load
    cpu_load = psutil.cpu_percent(interval=1)

    # RAM load
    ram = psutil.virtual_memory()
    ram_load = ram.percent

    # GPU load
    gpu_load = "‚ùå"
    try:
        import GPUtil
        gpus = GPUtil.getGPUs()
        if gpus:
            gpu_loads = [gpu.load * 100 for gpu in gpus]
            gpu_load = f"{sum(gpu_loads) / len(gpu_loads):.1f}%"
    except Exception:
        gpu_load = "‚ùå"

    # –°–∫–æ—Ä–æ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∏
    start_proc = time.perf_counter()
    await context.bot.send_chat_action(chat_id=update.effective_chat.id, action="typing")
    end_proc = time.perf_counter()
    processing_speed_ms = (end_proc - start_proc) * 1000

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ user_data –¥–ª—è callback
    context.user_data["ver_stats"] = {
        "PATCH_VERSION": PATCH_VERSION,
        "PATCH_MODER_VERSION": PATCH_MODER_VERSION,
        "FernieX_AI": FernieX_AI,
        "ping_ms": ping_ms,
        "cpu_load": cpu_load,
        "ram_load": ram_load,
        "gpu_load": gpu_load,
        "processing_speed_ms": processing_speed_ms,
        "UpdateDate": UpdateDate
    }

    # –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
    text = "üöÄ <b>FernieX - Game / Manager Bot</b>\n\n–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª –Ω–∏–∂–µ ‚¨áÔ∏è"
    keyboard = [
        [InlineKeyboardButton("üíª –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è", callback_data="ver:tech")],
        [InlineKeyboardButton("üìù –û –±–æ—Ç–µ", callback_data="ver:about")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)

    await msg.delete()
    await context.bot.send_photo(
        chat_id=update.effective_chat.id,
        photo=open("botinfo.png", "rb"),
        caption=text,
        parse_mode="HTML",
        reply_markup=reply_markup
    )


async def ver_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    stats = context.user_data.get("ver_stats")
    if not stats:
        await query.edit_message_caption(
            "<b>‚ùå –û—à–∏–±–∫–∞: –¥–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</b>\n<pre>–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É `–ë–æ—Ç` –∑–∞–Ω–æ–≤–æ.</pre>",
            parse_mode="HTML"
        )
        return

    if query.data == "ver:tech":
        text = (
            f"üìñ <b>–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</b>\n\n"
            f"üèì Ping: <code>{stats['ping_ms']:.1f} ms</code>\n"
            f"‚ö° –û–±—Ä–∞–±–æ—Ç–∫–∞: <code>~{stats['processing_speed_ms']:.1f} ms</code>\n"
            f"üíª CPU: <b>{stats['cpu_load']:.1f}%</b>\n"
            f"üéÆ GPU: <b>{stats['gpu_load']}</b>\n"
            f"üñ•Ô∏è RAM: <b>{stats['ram_load']:.1f}%</b>"
        )
        keyboard = [[InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="ver:menu")]]

    elif query.data == "ver:about":
        text = (
            f"ü§ñ <b>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–æ—Ç–µ</b>\n\n"
            f"üõ†Ô∏è <b>–í–µ—Ä—Å–∏—è FernieX:</b> <code>{stats['PATCH_VERSION']}</code>\n"
            f"ü§ñ <b>FernieX-AI:</b> <code>{stats['FernieX_AI']}</code>\n"
            f"üõ°Ô∏è <b>–ü–∞—Ç—á –º–æ–¥–µ—Ä–∞—Ü–∏–∏:</b> <code>{stats['PATCH_MODER_VERSION']}</code>\n"
            f"üóìÔ∏è <b>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:</b> <code>{stats['UpdateDate']}</code>"
        )
        keyboard = [
            [InlineKeyboardButton("üë®‚Äçüíª –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫", url="https://t.me/FernieX")],
            [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="ver:menu")]
        ]

    elif query.data == "ver:menu":
        text = "üöÄ <b>FernieX - Game / Manager Bot</b>\n\n–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª –Ω–∏–∂–µ ‚¨áÔ∏è"
        keyboard = [
            [InlineKeyboardButton("üíª –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è", callback_data="ver:tech")],
            [InlineKeyboardButton("üìù –û –±–æ—Ç–µ", callback_data="ver:about")]
        ]

    reply_markup = InlineKeyboardMarkup(keyboard)
    await query.edit_message_caption(caption=text, parse_mode="HTML", reply_markup=reply_markup)


def get_display_name(user: telegram.User) -> str:
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT nickname FROM users WHERE user_id = ?", (str(user.id),))
    result = cursor.fetchone()
    conn.close()

    if result and result[0]:
        # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –Ω–∏–∫
        return escape_markdown(result[0], version=2)
    else:
        # Telegram –∏–º—è –∏–ª–∏ "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"
        first = user.first_name or ""
        last = user.last_name or ""
        full_name = f"{first} {last}".strip() or "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"
        full_name = escape_markdown(full_name, version=2)
        return f"[{full_name}](tg://user?id={user.id})"


# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —ç–º–æ–¥–∑–∏ –∏–∑ —Å—Ç—Ä–æ–∫–∏
def remove_emojis(text: str) -> str:
    emoji_pattern = re.compile(
        "["
        "\U0001F600-\U0001F64F"  # emoticons
        "\U0001F300-\U0001F5FF"  # symbols & pictographs
        "\U0001F680-\U0001F6FF"  # transport & map symbols
        "\U0001F1E0-\U0001F1FF"  # flags (iOS)
        "]+",
        flags=re.UNICODE
    )
    return emoji_pattern.sub(r'', text)


async def nickname_info(update: Update, context: ContextTypes.DEFAULT_TYPE):
    # –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ ‚Äî –±–µ—Ä—ë–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ reply
    if update.message.reply_to_message:
        user = update.message.reply_to_message.from_user
    else:
        # –ò–Ω–∞—á–µ ‚Äî –±–µ—Ä—ë–º –∞–≤—Ç–æ—Ä–∞ –∫–æ–º–∞–Ω–¥—ã
        user = update.message.from_user

    mention = get_display_name_html_new(user)
    text = f"üë§ <b>NickName –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</b>\n{mention}"

    await update.message.reply_text(text, parse_mode="HTML")


async def nick_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = str(update.effective_user.id)
    args = context.args

    if not args:
        await update.message.reply_text("‚ùó –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: +–Ω–∏–∫ {–≤–∞—à_–Ω–∏–∫–Ω–µ–π–º}")
        return

    nickname = " ".join(args).strip()

    # –£–¥–∞–ª—è–µ–º —ç–º–æ–¥–∑–∏ (—Å–º–∞–π–ª—ã)
    nickname = remove_emojis(nickname)

    if len(nickname) == 0:
        await update.message.reply_text("‚ùó –ù–∏–∫–Ω–µ–π–º –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º –∏–ª–∏ —Å–æ—Å—Ç–æ—è—Ç—å —Ç–æ–ª—å–∫–æ –∏–∑ –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤.")
        return

    if len(nickname) > 32:
        await update.message.reply_text("‚ùó –ù–∏–∫–Ω–µ–π–º —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π. –ú–∞–∫—Å–∏–º—É–º 32 —Å–∏–º–≤–æ–ª–∞.")
        return

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –±–∞–∑—É
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("INSERT OR IGNORE INTO users (user_id) VALUES (?)", (user_id,))
    cursor.execute("UPDATE users SET nickname = ? WHERE user_id = ?", (nickname, user_id))
    conn.commit()
    conn.close()

    escaped_nickname = escape_markdown(nickname, version=2)

    await update.message.reply_text(
        f"‚úÖ *–í–∞—à –Ω–∏–∫–Ω–µ–π–º —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω:* _{escaped_nickname}_\n\n"
        f"‚úèÔ∏è –ß—Ç–æ–±—ã –≤–µ—Ä–Ω—É—Ç—å –Ω–∏–∫–Ω–µ–π–º –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É: /—Å–Ω–∏–∫",
        parse_mode="MarkdownV2"
    )


async def snick_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = str(update.effective_user.id)
    first_name = update.effective_user.first_name or ""

    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∏–∫–Ω–µ–π–º
    cursor.execute("SELECT nickname FROM users WHERE user_id = ?", (user_id,))
    result = cursor.fetchone()

    if result and result[0]:
        # –ï—Å–ª–∏ –Ω–∏–∫ –µ—Å—Ç—å ‚Äî —Å–±—Ä–∞—Å—ã–≤–∞–µ–º (—Å—Ç–∞–≤–∏–º NULL)
        cursor.execute("UPDATE users SET nickname = NULL WHERE user_id = ?", (user_id,))
        conn.commit()
        await update.message.reply_text(
            f"‚úÖ –í–∞—à –Ω–∏–∫–Ω–µ–π–º —Å–±—Ä–æ—à–µ–Ω. \n–¢–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–∞—à–µ –∏–º—è: *{first_name}*",
            parse_mode="Markdown"
        )
    else:
        await update.message.reply_text(
            "‚ÑπÔ∏è –£ –≤–∞—Å –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∏–∫–Ω–µ–π–º —á–µ—Ä–µ–∑ +–Ω–∏–∫.",
            parse_mode="Markdown"
        )

    conn.close()


BOT_USERNAME = "FernieXBot"


def get_display_name_start(user_id: str, default_first_name: str) -> str:
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT nickname FROM users WHERE user_id = ?", (user_id,))
    result = cursor.fetchone()
    conn.close()

    if result and result[0]:
        return result[0]
    else:
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏–º—è —Å tg-—Å—Å—ã–ª–∫–æ–π –≤ Markdown —Ñ–æ—Ä–º–∞—Ç–µ
        return f"[{default_first_name}](tg://user?id={user_id})"


# --- –ë–ê–ó–ê –î–ê–ù–ù–´–• ---
def is_user_in_db(user_id: int) -> bool:
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT 1 FROM users WHERE user_id = ?", (str(user_id),))
    exists = cursor.fetchone() is not None
    conn.close()
    return exists


def add_user_to_db(user_id: int):
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("""
        INSERT OR IGNORE INTO users (user_id, balance, ref_count)
        VALUES (?, 0, 0)
    """, (str(user_id),))
    conn.commit()
    conn.close()


# –£–≤–µ–ª–∏—á–∏—Ç—å —Å—á–µ—Ç—á–∏–∫ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤
def increment_ref_count(user_id: int):
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute(
        "UPDATE users SET ref_count = ref_count + 1 WHERE user_id = ?",
        (str(user_id),)
    )
    conn.commit()
    conn.close()


def activate_subscription_fpl(user_id, duration_key, payment_method):
    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()

        cursor.execute("""
            CREATE TABLE IF NOT EXISTS SubFerniePlus (
                user_id TEXT PRIMARY KEY,
                end_time INTEGER
            )
        """)

        pm = payment_method.lower()

        if pm in ["dc", "digitalcoins", "digitalcoinsbalance"]:
            cost_dc = int(DURATIONS_FPL[duration_key][3])
            cursor.execute(
                "UPDATE users SET dc_balance = dc_balance - ? WHERE user_id=?",
                (cost_dc, user_id)
            )
        elif pm == "seeds":
            cost_seeds = int(DURATIONS_FPL[duration_key][2])
            cursor.execute(
                "UPDATE users SET seeds = seeds - ? WHERE user_id=?",
                (cost_seeds, user_id)
            )
        else:
            print(f"[ERROR] –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –º–µ—Ç–æ–¥ –æ–ø–ª–∞—Ç—ã: {payment_method}")
            return

        duration_seconds = int(DURATIONS_FPL[duration_key][1])
        expire_time = int(time.time()) + duration_seconds

        cursor.execute("""
            INSERT OR REPLACE INTO SubFerniePlus(user_id, end_time)
            VALUES (?, ?)
        """, (user_id, expire_time))

        conn.commit()

def get_user_background(user_id: str) -> tuple[str, str]:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç (media_type, media_path)
    """
    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()
        cursor.execute(
            "SELECT media_type, media_path FROM fernieplus_custom WHERE user_id = ?",
            (user_id,)
        )
        result = cursor.fetchone()

    if result:
        return (
            result[0] or "photo",
            result[1] or "profile_def.png"
        )

    return "photo", "profile_def.png"

def save_user_background(user_id: str, media_type: str, media_path: str):
    """
    media_type: 'photo' | 'animation'
    media_path: –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É
    """
    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()
        cursor.execute(
            "SELECT user_id FROM fernieplus_custom WHERE user_id = ?",
            (user_id,)
        )
        exists = cursor.fetchone()

        if exists:
            cursor.execute(
                """
                UPDATE fernieplus_custom
                SET media_type = ?, media_path = ?
                WHERE user_id = ?
                """,
                (media_type, media_path, user_id)
            )
        else:
            cursor.execute(
                """
                INSERT INTO fernieplus_custom (user_id, media_type, media_path)
                VALUES (?, ?, ?)
                """,
                (user_id, media_type, media_path)
            )

    print(f"[DB] –ú–µ–¥–∏–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ: {media_type} ‚Üí {media_path}")



def ensure_backgrounds_table():
    """–°–æ–∑–¥–∞–µ—Ç —Ç–∞–±–ª–∏—Ü—É user_backgrounds, –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç"""
    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()
        cursor.execute("""
        CREATE TABLE IF NOT EXISTS user_backgrounds (
            user_id TEXT NOT NULL,
            buy_id TEXT NOT NULL,
            PRIMARY KEY (user_id, buy_id),
            FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE
        )
        """)
        conn.commit()


def has_user_background(user_id: str, buy_id: str) -> bool:
    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()
        cursor.execute("SELECT 1 FROM user_backgrounds WHERE user_id = ? AND buy_id = ?", (user_id, buy_id))
        return cursor.fetchone() is not None


def add_user_background(user_id: str, buy_id: str):
    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()
        cursor.execute("INSERT OR IGNORE INTO user_backgrounds (user_id, buy_id) VALUES (?, ?)", (user_id, buy_id))
        conn.commit()


def get_user_seeds_fon(user_id):
    """–ü–æ–ª—É—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–µ–º—è–Ω —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()
        cursor.execute("SELECT seeds FROM users WHERE user_id = ?", (user_id,))
        result = cursor.fetchone()
        return result[0] if result else 0


def update_user_seeds_fon(user_id, amount):
    """–°–ø–∏—Å–∞—Ç—å —Å–µ–º–µ–Ω–∞ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()
        cursor.execute("UPDATE users SET seeds = seeds - ? WHERE user_id = ?", (amount, user_id))
        conn.commit()

# --- –¢–∞–±–ª–∏—Ü–∞ AI_Selected ---
def ensure_ai_selected_table():
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("""
        CREATE TABLE IF NOT EXISTS AI_Selected (
            user_id INTEGER PRIMARY KEY,
            model_name TEXT NOT NULL
        )
    """)
    conn.commit()
    conn.close()

def save_user_model(user_id: int, model_name: str):
    ensure_ai_selected_table()
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute(
        "INSERT OR REPLACE INTO AI_Selected (user_id, model_name) VALUES (?, ?)",
        (user_id, model_name)
    )
    conn.commit()
    conn.close()

AI_MODELS_NAME = {
    "grok41fast": "Grok 4.1 fast",
    "ClaudeOpus_45": "Solar Pro 3",
    "step35_flash": "Step 3.5 Flash",
    "Grok": "Grok 3 Mini Beta",
}


def get_user_media(user_id: str) -> tuple[str, str]:
    with sqlite3.connect(DB_PATH) as conn:
        cur = conn.cursor()
        cur.execute(
            "SELECT media_type, media_path FROM fernieplus_custom WHERE user_id = ?",
            (user_id,)
        )
        row = cur.fetchone()

    if row:
        return row[0] or "photo", row[1] or "fons/png/profile_def.png"

    return "photo", "fons/png/profile_def.png"

def save_user_media(user_id: str, media_type: str, media_path: str):
    with sqlite3.connect(DB_PATH) as conn:
        cur = conn.cursor()
        cur.execute("""
            INSERT INTO fernieplus_custom (user_id, media_type, media_path)
            VALUES (?, ?, ?)
            ON CONFLICT(user_id) DO UPDATE SET
                media_type = excluded.media_type,
                media_path = excluded.media_path
        """, (user_id, media_type, media_path))


async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    message = update.message

    print(f"[DEBUG] ========== START COMMAND ==========")
    print(f"[DEBUG] User ID: {user.id}")
    print(f"[DEBUG] Username: {user.username}")
    print(f"[DEBUG] context.args: {context.args}")

    if message is None:
        print(f"[DEBUG] Message is None, returning")
        return

    user_id = str(user.id)
    username = user.username or "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"
    display_name = get_display_name_html_new(user)

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤
    if context.args and len(context.args) > 0:
        arg = context.args[0]
        print(f"[DEBUG] Received arg: {arg}")
        print(f"[DEBUG] Arg length: {len(arg)}")

        # ===== –û–ë–†–ê–ë–û–¢–ö–ê BLOCK BLAST =====
        if arg.startswith("BB_"):
            print(f"[DEBUG] Detected Block Blast game data, passing to handler")
            # –£–±–∏—Ä–∞–µ–º –ø—Ä–µ—Ñ–∏–∫—Å "BlockBlast_" –∏ –ø–µ—Ä–µ–¥–∞—ë–º –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
            encrypted_data = arg[3:]
            await handle_block_blast_simple(update, context, encrypted_data)
            return

        if arg.startswith("codeQuest_"):
            await handle_code_quest(update, context, arg[10:])
            return

        # ===== –û–ë–†–ê–ë–û–¢–ö–ê –ú–ê–ö–†–û–°–û–í =====
        if arg.startswith("macro_"):
            print(f"[DEBUG] Detected macro format (macro_ prefix)")
            macro_data = arg[6:]  # –£–±–∏—Ä–∞–µ–º "macro_"
            print(f"[DEBUG] Macro data after removing prefix: {macro_data}")

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç (—Å _A_) –∏–ª–∏ —Å—Ç–∞—Ä—ã–π (base64)
            if '_A_' in macro_data:
                print(f"[DEBUG] New format detected (_A_ separator)")
                await macros_connect(update, context, macro_data)
            else:
                print(f"[DEBUG] Old format detected (base64)")
                await update.message.reply_text(
                    "‚ùå –£—Å—Ç–∞—Ä–µ–≤—à–∏–π —Ñ–æ—Ä–º–∞—Ç –º–∞–∫—Ä–æ—Å–∞. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π –º–∞–∫—Ä–æ—Å –Ω–∞ —Å–∞–π—Ç–µ.",
                    parse_mode="HTML"
                )
            return

        # ===== –û–ë–†–ê–ë–û–¢–ö–ê SIM-–∫–∞—Ä—Ç—ã =====
        if arg.startswith("PhoneNumber-"):
            print(f"[DEBUG] Detected PhoneNumber")
            await handle_sim_card_start(update, context, user_id)
            return

        # ===== –û–ë–†–ê–ë–û–¢–ö–ê –ê–ü–ï–õ–õ–Ø–¶–ò–ô =====
        if arg.lower() == "appealmenu":
            print(f"[DEBUG] Detected appealmenu")
            await appeal_command(update, context)
            return

        # === –û–ë–†–ê–ë–û–¢–ö–ê –§–û–ù–û–í ===
        if arg.startswith("CustF"):
            print(f"[DEBUG] Detected background setup")
            ensure_backgrounds_table()
            bg_arg = arg[5:]

            if bg_arg.lower() == "coms":
                await message.reply_text("‚ùå –§–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω...")
                return

            if not has_subscription_fpl(user_id):
                await message.reply_text("‚ùå –£ –≤–∞—Å –Ω–µ—Ç Fernie+!")
                return

            for bg in BACKGROUNDS:
                if bg["arg"].lower() == bg_arg.lower():
                    current_type, current_path = get_user_media(user_id)
                    if current_path == bg["file"]:
                        await message.reply_text("‚ö† –£ –≤–∞—Å —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —ç—Ç–æ—Ç —Ñ–æ–Ω.")
                        return

                    media_type = "photo"
                    media_path = bg["file"]

                    # –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π —Ñ–æ–Ω
                    if "buy_id" not in bg:
                        save_user_media(user_id, media_type, media_path)
                        await message.reply_text(
                            f"‚úÖ –§–æ–Ω <b>{bg['name']}</b> —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!",
                            parse_mode="HTML"
                        )
                        return

                    # –ü—Ä–µ–º–∏—É–º —Ñ–æ–Ω
                    buy_id = bg["buy_id"]
                    price = int(bg.get("price", 0))

                    if has_user_background(user_id, buy_id):
                        save_user_media(user_id, media_type, media_path)
                        await message.reply_text(
                            f"‚úÖ –§–æ–Ω <b>{bg['name']}</b> —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!",
                            parse_mode="HTML"
                        )
                        return

                    user_seeds = get_user_seeds_fon(user_id)
                    if user_seeds < price:
                        await message.reply_text(
                            f"üå± –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å–µ–º—è–Ω!\n"
                            f"–§–æ–Ω: <b>{bg['name']}</b>\n"
                            f"–ù—É–∂–Ω–æ: {price} üå±, —É –≤–∞—Å: {user_seeds} üå±",
                            parse_mode="HTML"
                        )
                        return

                    update_user_seeds_fon(user_id, price)
                    add_user_background(user_id, buy_id)
                    save_user_media(user_id, media_type, media_path)

                    await message.reply_text(
                        f"‚úÖ –§–æ–Ω <b>{bg['name']}</b> –∫—É–ø–ª–µ–Ω –∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!\n"
                        f"–ü–æ—Ç—Ä–∞—á–µ–Ω–æ: {price} üå±",
                        parse_mode="HTML"
                    )
                    return

        # === –û–ë–†–ê–ë–û–¢–ö–ê –í–´–ë–û–†–ê AI ===
        if arg.startswith("select_AI_"):
            print(f"[DEBUG] Detected AI selection")
            ensure_ai_selected_table()
            model_id = arg[10:]
            save_user_model(user_id, model_id)
            model_name = AI_MODELS_NAME.get(model_id, model_id)
            await message.reply_text(
                f"‚úÖ –í—ã –≤—ã–±—Ä–∞–ª–∏ –Ω–µ–π—Ä–æ—Å–µ—Ç—å: <b>{model_name}</b>",
                parse_mode="HTML"
            )
            return

        # === –ü–û–î–ü–ò–°–ö–ê FERNIE+ ===
        if arg.startswith("fernieplus"):
            print(f"[DEBUG] Detected fernieplus subscription")
            loading_msg = await message.reply_text(
                "<b>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞ –ø–æ–¥–æ–∂–¥–∏—Ç–µ...</b>\n<pre>–ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –ø–æ–¥–ø–∏—Å–∫–µ...</pre>",
                parse_mode="HTML"
            )
            await asyncio.sleep(1)

            args = arg.split("_")
            print(f"[DEBUG] Subscription args: {args}")

            if len(args) == 3:
                _, duration_key, payment_method = args

                if has_subscription_fpl(user_id):
                    await loading_msg.delete()
                    await message.reply_text("‚ö† –£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å —ç—Ç–∞ –ø–æ–¥–ø–∏—Å–∫–∞.")
                    return

                if not has_enough_fpl(user_id, payment_method, duration_key):
                    await loading_msg.delete()
                    await message.reply_text("‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏.")
                    return

                activate_subscription_fpl(user_id, duration_key, payment_method)

                await loading_msg.delete()
                await message.reply_text(
                    f"‚úÖ <b>Fernie+ - –æ—Ñ–æ—Ä–º–ª–µ–Ω–∞!</b>\n\n"
                    f"üìÖ –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è: <b>{DURATIONS_FPL[duration_key][0]}</b>\n"
                    f"‚ú® –°–ø–∞—Å–∏–±–æ –∑–∞ –ø–æ–∫—É–ø–∫—É!",
                    parse_mode="HTML"
                )
                return
    else:
        print(f"[DEBUG] No args provided")

    # === –°–¢–ê–ù–î–ê–†–¢–ù–û–ï –ü–†–ò–í–ï–¢–°–¢–í–ò–ï ===
    print(f"[DEBUG] Showing standard welcome message")
    add_bot_button = InlineKeyboardButton(
        text="ü§ñ –î–æ–±–∞–≤–∏—Ç—å –±–æ—Ç–∞ –≤ —á–∞—Ç",
        callback_data="show_group_info"
    )
    markup_buttons = [[add_bot_button]]

    welcome_text = (
        f"üëã –ü—Ä–∏–≤–µ—Ç, {display_name}!\n"
        f"–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –º–∏—Ä <b>FernieX</b> ‚Äî –∏–≥—Ä—É –º–µ—á—Ç—ã!\n\n"
        f"üéÆ –ü–æ–≥—Ä—É–∂–∞–π—Å—è –≤ –∏–≥—Ä—É, —Ä–∞–±–æ—Ç–∞–π, —Ä–∞–∑–≤–∏–≤–∞–π—Å—è –∏ —Å—Ç–∞–Ω—å –ª–µ–≥–µ–Ω–¥–æ–π –≤—Å–µ–ª–µ–Ω–Ω–æ–π <b>FernieX</b>! üöÄ"
    )

    await message.reply_text(welcome_text, reply_markup=InlineKeyboardMarkup(markup_buttons), parse_mode="HTML")
    print(f"[DEBUG] ========== END START COMMAND ==========")

def has_subscription_fpl(user_id):
    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()
        cursor.execute("""
            SELECT end_time FROM SubFerniePlus
            WHERE user_id=?
        """, (user_id,))
        row = cursor.fetchone()
        if not row:
            return False
        end_time = row[0]
        return end_time > int(time.time())


def has_enough_fpl(user_id, payment_method, subscription_key):
    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()
        cursor.execute("SELECT balance, dc_balance, seeds FROM users WHERE user_id=?", (user_id,))
        row = cursor.fetchone()
        if not row:
            print(f"[DEBUG] –ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î: {user_id}")
            return False

        balance, dc_balance, seeds = row
        dc_balance = int(dc_balance or 0)
        seeds = int(seeds or 0)

        print(
            f"[DEBUG] –ü—Ä–æ–≤–µ—Ä–∫–∞: user_id={user_id}, balance={balance}, dc_balance={dc_balance}, seeds={seeds}, payment_method={payment_method}, subscription_key={subscription_key}")

        try:
            pm = payment_method.lower()
            if pm in ["dc", "digitalcoins", "digitalcoinsbalance"]:
                cost_dc = int(DURATIONS_FPL[subscription_key.lower()][3])
                print(f"[DEBUG] cost_dc={cost_dc}")
                return dc_balance >= cost_dc
            elif pm in ["seeds"]:
                cost_seeds = int(DURATIONS_FPL[subscription_key.lower()][2])
                print(f"[DEBUG] cost_seeds={cost_seeds}")
                return seeds >= cost_seeds
        except Exception as e:
            print(f"[ERROR] –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ä–µ–¥—Å—Ç–≤: {e}")
            return False

    return False


async def show_group_info(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()  # —É–±–∏—Ä–∞–µ–º "—á–∞—Å–∏–∫–∏" —É –∫–Ω–æ–ø–∫–∏

    info_text = (
        "üö® *–í–∞–∂–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –±–æ—Ç–∞ –≤ –≥—Ä—É–ø–ø—É:*\n\n"
        "üîë –î–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ–π –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤—å—Ç–µ –µ–º—É –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞:\n\n"
        "‚Ä¢ üßê *–ü—Ä–æ—Å–º–æ—Ç—Ä —Å–æ–æ–±—â–µ–Ω–∏–π*\n"
        "‚Ä¢ üóëÔ∏è *–£–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π*\n"
        "‚Ä¢ üõ°Ô∏è *–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤* (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è –∞–Ω—Ç–∏—Å–ø–∞–º–∞)\n"
        "‚Ä¢ ‚öôÔ∏è *–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–ø–∏—Å–∫–æ–π*\n\n"
        "‚ùó *–ë–µ–∑ —ç—Ç–∏—Ö –ø—Ä–∞–≤ –±–æ—Ç –Ω–µ —Å–º–æ–∂–µ—Ç –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ –≤—ã–ø–æ–ª–Ω—è—Ç—å —Å–≤–æ–∏ —Ñ—É–Ω–∫—Ü–∏–∏.*\n\n"
        "‚ö†Ô∏è *–ü–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –±–æ—Ç–∞ –≤ –≥—Ä—É–ø–ø—É –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –≤–≤–µ–¥–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É* \n`/connect` *–¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –±–æ—Ç–∞ –∫ —á–∞—Ç—É.*\n\n"
        "üëá –ñ–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ –∏ –¥–æ–±–∞–≤–ª—è–π—Ç–µ –±–æ—Ç–∞ –≤ —Å–≤–æ—é –≥—Ä—É–ø–ø—É:"
    )

    add_group_button = InlineKeyboardButton(
        text="‚ûï –î–æ–±–∞–≤–∏—Ç—å –≤ —á–∞—Ç",
        url=f"https://t.me/{BOT_USERNAME}?startgroup=true"
    )
    back_button = InlineKeyboardButton(
        text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—é",
        callback_data="back_to_start"
    )
    markup = InlineKeyboardMarkup([[add_group_button], [back_button]])

    await query.edit_message_text(text=info_text, reply_markup=markup, parse_mode="Markdown")


async def back_to_start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    user = query.from_user

    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤–∞—à—É —Ñ—É–Ω–∫—Ü–∏—é get_display_name_html_new —Å –æ–±—ä–µ–∫—Ç–æ–º user
    display_name = get_display_name_html_new(user)

    add_button = InlineKeyboardButton(
        text="ü§ñ –î–æ–±–∞–≤–∏—Ç—å –±–æ—Ç–∞ –≤ —á–∞—Ç",
        callback_data="show_group_info"
    )
    markup = InlineKeyboardMarkup([[add_button]])

    welcome_text = (
        f"üéâ –ü—Ä–∏–≤–µ—Ç, {display_name}!\n"
        f"–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –º–∏—Ä <b>FernieX</b> ‚Äî –∏–≥—Ä—É –º–µ—á—Ç—ã!\n\n"
        f"üéÆ –ü–æ–≥—Ä—É–∂–∞–π—Å—è –≤ –∏–≥—Ä—É, —Ä–∞–±–æ—Ç–∞–π, —Ä–∞–∑–≤–∏–≤–∞–π—Å—è –∏ —Å—Ç–∞–Ω—å –ª–µ–≥–µ–Ω–¥–æ–π –≤—Å–µ–ª–µ–Ω–Ω–æ–π <b>FernieX</b>! üöÄ"
    )

    await query.edit_message_text(welcome_text, reply_markup=markup, parse_mode="HTML")


DEVELOPER_ID = 7406372338
DEVELOPER_NAME = "Fernie"
BIRTHDAY_MONTH = 6
BIRTHDAY_DAY = 22


async def dbday(update: Update, context: ContextTypes.DEFAULT_TYPE):
    # –ò—Ä–∫—É—Ç—Å–∫–∏–π —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å
    irkutsk_tz = ZoneInfo("Asia/Irkutsk")

    # –¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞ –ø–æ –ò—Ä–∫—É—Ç—Å–∫–æ–º—É –≤—Ä–µ–º–µ–Ω–∏
    today = datetime.now(irkutsk_tz).date()
    current_year = today.year

    birthday_this_year = datetime(year=current_year, month=BIRTHDAY_MONTH, day=BIRTHDAY_DAY, tzinfo=irkutsk_tz).date()

    if birthday_this_year < today:
        birthday_next = datetime(year=current_year + 1, month=BIRTHDAY_MONTH, day=BIRTHDAY_DAY,
                                 tzinfo=irkutsk_tz).date()
    else:
        birthday_next = birthday_this_year

    days_left = (birthday_next - today).days

    today_str = today.strftime("%d.%m.%Y")

    message = (
        f"üéâüéÇ *–û–±—Ä–∞—Ç–Ω—ã–π –æ—Ç—á—ë—Ç –¥–æ –î–† —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞!*\n\n"
        f"üë®‚Äçüíª *–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫:* [{DEVELOPER_NAME}](tg://user?id={DEVELOPER_ID})\n"
        f"‚è≥ *–û—Å—Ç–∞–ª–æ—Å—å –¥–Ω–µ–π:* *{days_left}*\n"
        f"üéà *–î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è:* {BIRTHDAY_DAY:02d}.{BIRTHDAY_MONTH:02d}.2026\n\n"
        f"üìÖ *–°–µ–≥–æ–¥–Ω—è* {today_str}"
    )

    await update.message.reply_text(message, parse_mode="Markdown")


def get_display_name_html(user_id: str, default_first_name: str | None) -> str:
    user_id_str = str(user_id)

    try:
        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()
        cursor.execute("SELECT nickname FROM users WHERE user_id = ?", (user_id_str,))
        result = cursor.fetchone()
        conn.close()
    except Exception:
        result = None

    if result and result[0] and result[0].strip():
        name = result[0].strip()
    elif default_first_name and default_first_name.strip():
        name = default_first_name.strip()
    else:
        name = "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"

    escaped_name = escape(name)
    return f'<a href="tg://user?id={user_id_str}">{escaped_name}</a>'


async def fernie(update: Update, context: ContextTypes.DEFAULT_TYPE):
    message = update.message
    if not context.args:
        # –ü—Ä–æ—Å—Ç–æ "—Ñ–µ—Ä–Ω–∏" –±–µ–∑ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ ‚Äî –æ—Ç–≤–µ—Ç–∏–º "–Ω–∞ –º–µ—Å—Ç–µ (–≥–∞–ª–æ—á–∫–∞)"
        await message.reply_text("‚úÖ –ù–∞ –º–µ—Å—Ç–µ")
        return

    subcommand = context.args[0].lower()

    if subcommand == "–≤—ã–±–µ—Ä–∏":
        match = re.search(r'–≤—ã–±–µ—Ä–∏\s+(.+?)\s+–∏–ª–∏\s+(.+)', message.text, re.IGNORECASE)
        if not match:
            await message.reply_text(
                "‚ùó –§–æ—Ä–º–∞—Ç: <code>–§–µ—Ä–Ω–∏ –≤—ã–±–µ—Ä–∏ (–≤–∞—Ä–∏–∞–Ω—Ç 1) –∏–ª–∏ (–≤–∞—Ä–∏–∞–Ω—Ç 2)</code>",
                parse_mode=ParseMode.HTML
            )
            return

        choice1, choice2 = match.group(1), match.group(2)
        selected = random.choice([choice1, choice2])
        responses = [
            f"üé≤ –°—É–¥—å–±–∞ –≤—ã–±—Ä–∞–ª–∞: <b>{escape(selected)}</b>",
            f"üîÆ –ö–∞—Ä—Ç—ã —à–µ–ø—á—É—Ç: <b>{escape(selected)}</b> ‚Äî –ª—É—á—à–∏–π –≤—ã–±–æ—Ä!",
            f"üåü –ß—É–π–∫–∞ –≥–æ–≤–æ—Ä–∏—Ç ‚Äî <b>{escape(selected)}</b>!"
        ]
        response = random.choice(responses)
        await message.reply_text(response, parse_mode=ParseMode.HTML)

    elif subcommand == "–∫—Ç–æ":
        phrase = message.text.partition("–∫—Ç–æ")[2].strip()
        if not phrase:
            await message.reply_text(
                "‚ùó –§–æ—Ä–º–∞—Ç: <code>–§–µ—Ä–Ω–∏ –∫—Ç–æ (—Ñ—Ä–∞–∑–∞)</code>",
                parse_mode=ParseMode.HTML
            )
            return

        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()
        cursor.execute("SELECT user_id, first_name FROM users")
        all_users = cursor.fetchall()
        conn.close()

        if not all_users:
            await message.reply_text(
                "‚ö†Ô∏è –í –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–∫–∞ –Ω–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.",
                parse_mode=ParseMode.HTML
            )
            return

        selected_user = random.choice(all_users)
        user_id, first_name = selected_user
        display = get_display_name_html(user_id, first_name)
        escaped_phrase = escape(phrase)
        responses = [
            f"üïµÔ∏è –Ø —á—É–≤—Å—Ç–≤—É—é, —á—Ç–æ {display} {escaped_phrase}.",
            f"üîÆ –ö–∞—Ä—Ç—ã –ø–æ–∫–∞–∑–∞–ª–∏ –º–Ω–µ ‚Äî —ç—Ç–æ {display} {escaped_phrase}!",
            f"üòà –û–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ {display} {escaped_phrase}!"
        ]
        response = random.choice(responses)
        await message.reply_text(response, parse_mode=ParseMode.HTML)

    elif subcommand in ["—à–∞–Ω—Å", "–∏–Ω—Ñ–∞"]:
        phrase = message.text.partition(subcommand)[2].replace("—á—Ç–æ", "", 1).strip()
        if not phrase:
            await message.reply_text(
                f"‚ùó –§–æ—Ä–º–∞—Ç: <code>–§–µ—Ä–Ω–∏ {subcommand} —á—Ç–æ (—Ñ—Ä–∞–∑–∞)</code>",
                parse_mode=ParseMode.HTML
            )
            return

        percent = random.randint(0, 100)
        escaped_phrase = escape(phrase)
        responses = [
            f"üìä –®–∞–Ω—Å —Ç–æ–≥–æ, —á—Ç–æ <b>{escaped_phrase}</b> ‚Äî <b>{percent}%</b>",
            f"üîÆ –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ: –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å <b>{escaped_phrase}</b> —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç <b>{percent}%</b>",
            f"üåà –û—â—É—â–µ–Ω–∏—è –ø–æ–¥—Å–∫–∞–∑—ã–≤–∞—é—Ç –º–Ω–µ: <b>{percent}%</b> —á—Ç–æ <b>{escaped_phrase}</b>"
        ]
        response = random.choice(responses)
        await message.reply_text(response, parse_mode=ParseMode.HTML)

    else:
        await message.reply_text(
            "üö´ <b>–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø–æ–¥–∑–∞–ø—Ä–æ—Å!</b>\n\n"
            "üìå –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:\n"
            "<code>–§–µ—Ä–Ω–∏ –≤—ã–±–µ—Ä–∏ (–∞) –∏–ª–∏ (–±)</code>\n"
            "<code>–§–µ—Ä–Ω–∏ –∫—Ç–æ (—Ñ—Ä–∞–∑–∞)</code>\n"
            "<code>–§–µ—Ä–Ω–∏ —à–∞–Ω—Å —á—Ç–æ (—Ñ—Ä–∞–∑–∞)</code>",
            parse_mode=ParseMode.HTML
        )


BANNED_PHRASES = [
    # –ú–∞—Ç—å / –º–∞–º–∞
    "–º–∞–º–∞—à–∞ –±–ª—è–¥–∏–Ω–∞", "–º–∞–º–∫–∞ –±–ª—è–¥–∏–Ω–∞", "–º–∞–º–æ—á–∫–∞ —à–ª—é—Ö–∞", "–º–∞–º–æ—á–∫–∞ —Å–æ—Å–∞–ª–∞",
    "–º–∞–º—É–ª—è —à–ª—é—Ö–∞", "–º–∞–º—É–ª—è –µ–±–∞–Ω–∞—è", "–º–∞–º—É–ª—è —Ç—Ä–∞—Ö–∞–Ω–Ω–∞—è",
    "–º–∞–º–∞—à–∫–∞ —à–ª—é—Ö–∞", "–º–∞–º–∞—à–∫–∞ –µ–±–∞–Ω–∞—è", "–º–∞–º–∞—à–∫–∞ —Å–æ—Å–∞–ª–∞",
    "–º–∞–º–∫–∞ –µ–±–∞–Ω–∞—è", "–º–∞–º–∫–∞ –µ–±–Ω—É—Ç–∞—è", "–º–∞–º–∫–∞ —Ç—Ä–∞—Ö–∞–Ω–∞—è", "–º–∞–º–∫–∞ –±–ª—è–¥–æ–≤–∫–∞",
    "–º–∞–º–∞—à–∞ –≥–∞–Ω–¥–æ–Ω—à–∞", "–º–∞–º–∞—à–∞ –º—Ä–∞–∑—å", "–º–∞–º–∞—à–∞ —Ç–≤–∞—Ä—å", "–º–∞–º–∫–∞ —Ç–≤–∞—Ä—å", "–º–∞–º–∫–∞ –º—Ä–∞–∑—å",
    "–º–∞–º–∞—à–∞ –ø–∏–∑–¥–∞", "–º–∞–º–∞—à–∞ —Å—É—á–∫–∞", "–º–∞–º–∫–∞ —Å—É—á–∫–∞", "–º–∞–º–∞—à–∞ —à–∞–ª–∞–≤–∞", "–º–∞–º–∫–∞ —à–∞–ª–∞–≤–∞",
    "–º–∞–º—É–ª—è —à–∞–ª–∞–≤–∞", "–º–∞–º–æ—á–∫–∞ —à–∞–ª–∞–≤–∞", "–º–∞—Ç—å —à–∞–ª–∞–≤–∞", "–º–∞–º–∞—à–∞ —á–º–æ", "–º–∞–º–∫–∞ —á–º–æ",
    "–º–∞–º—É –µ–±–∞–ª", "–º–∞—Ç—å –µ–±–∞–ª", "–º–∞–º—É —Ç—Ä–∞—Ö–∞–ª", "–º–∞—Ç—å —Ç—Ä–∞—Ö–∞–ª",
    "–º–∞–º—É –µ–±–∞–ª –∫—Ç–æ-—Ç–æ", "–º–∞—Ç—å –µ–±–∞–ª –∫—Ç–æ-—Ç–æ", "–º–∞–º—É —Å–æ—Å–∞–ª", "–º–∞—Ç—å —Å–æ—Å–∞–ª",
    "–º–∞–º—É –ø–∏–∑–¥–∏–ª", "–º–∞—Ç—å –ø–∏–∑–¥–∏–ª", "–º–∞–º—É —É–Ω–∏–∂–∞–ª", "–º–∞—Ç—å —É–Ω–∏–∂–∞–ª",
    "–º–∞–º—É –æ–±–æ—Å—Å–∞–ª", "–º–∞—Ç—å –æ–±–æ—Å—Å–∞–ª", "–º–∞–º—É –ø–æ—Ü–∞—Ä–∞–ø–∞–ª", "–º–∞—Ç—å –ø–æ—Ü–∞—Ä–∞–ø–∞–ª",
    "–º–∞–º—É –æ—Å–∫–æ—Ä–±–∏–ª", "–º–∞—Ç—å –æ—Å–∫–æ—Ä–±–∏–ª", "–º–∞–º—É –ø–Ω—É–ª", "–º–∞—Ç—å –ø–Ω—É–ª",
    "–º–∞–º—É —É–¥–∞—Ä–∏–ª", "–º–∞—Ç—å —É–¥–∞—Ä–∏–ª", "–º–∞–º—É —Ç—Ä–∞—Ö–Ω—É–ª", "–º–∞—Ç—å —Ç—Ä–∞—Ö–Ω—É–ª",
    "–º–∞–º—É —É–Ω–∏–∑–∏–ª", "–º–∞—Ç—å —É–Ω–∏–∑–∏–ª", "–º–∞–º—É –æ–±—Ä—É–≥–∞–ª", "–º–∞—Ç—å –æ–±—Ä—É–≥–∞–ª",
    "–º–∞–º—É –æ–±–ª–∏–ª", "–º–∞—Ç—å –æ–±–ª–∏–ª", "–º–∞–º—É —Ç–æ–ª–∫–Ω—É–ª", "–º–∞—Ç—å —Ç–æ–ª–∫–Ω—É–ª",
    "–º–∞–º—É –¥–∞–ª –≤ —Ä–æ—Ç", "–º–∞—Ç—å –¥–∞–ª –≤ —Ä–æ—Ç", "–º–∞—Ç—å –µ–±–∞–ª", "–º–∞—Ç—å –ø–∏–¥–æ—Ä–∞—Å–∫–∞", "–º–∞—Ç—å —à–ª—é—Ö–∞",

    "–±–µ–∑–º–∞–º–Ω—ã–π", "–±–µ–∑–º–∞–º–Ω–∞—è", "–º–∞–º—É –µ–±–∞–ª", "–º–∞–º–∞ –ø–∏–¥–æ—Ä–∞—Å–∫–∞", "–º–∞–º–∞ —à–ª—é—Ö–∞", "–º–∞–º–∞ —É–µ–±–∏—â–µ", "–º–∞–º–∞ —É—ë–±–∏—â–µ",
    "–º–∞–º–∫—É –µ–±", "–º–∞—Ç—å –µ–±", "–º–∞–º–∫—É–µ–±", "–º–∞—Ç—å–µ–±", "–º–∞–º–∞—à—É –µ–±", "–º–∞–º–∞—à—É–µ–±", "–µ–±–∞–ª —Ç–≤–æ—é –º–∞—Ç—å", "–µ–±–∞–ª —Ç–≤–æ–µ–≥–æ –æ—Ç—Ü–∞",

    # –û—Ç–µ—Ü / –±–∞—Ç—è / –ø–∞–ø–∞
    "–±–∞—Ç—è —à–ª—é—Ö–∞", "–±–∞—Ç—è –±–ª—è–¥–∏–Ω–∞", "–±–∞—Ç—è –ø–æ–∑–æ—Ä", "–±–∞—Ç—è –º—É—Å–æ—Ä", "–±–∞—Ç—è –º—Ä–∞–∑—å",
    "–±–∞—Ç—è –≥–∞–Ω–¥–æ–Ω", "–±–∞—Ç—è —Ö—É–π–ª–æ", "–±–∞—Ç—è —Ç–≤–∞—Ä—å", "–±–∞—Ç—è –ø–∏–¥–æ—Ä", "–±–∞—Ç—è –ø–µ–¥–∏–∫",
    "–ø–∞–ø–∞—à–∞ —à–ª—é—Ö–∞", "–ø–∞–ø–∞—à–∞ –º—Ä–∞–∑—å", "–ø–∞–ø–∞—à–∞ —Ö—É–π–ª–æ",
    "–ø–∞–ø–∫–∞ —à–ª—é—Ö–∞", "–ø–∞–ø–∫–∞ —Ö—É–π–ª–æ", "–ø–∞–ø–∫–∞ –º—Ä–∞–∑—å", "–ø–∞–ø–∫–∞ –ø–∏–¥–æ—Ä",
    "–ø–∞–ø—É–ª—è —à–ª—é—Ö–∞", "–ø–∞–ø—É–ª—è –µ–±–∞–Ω—ã–π", "–ø–∞–ø—É–ª—è –ø–µ–¥–∏–∫",
    "–ø–∞–ø–æ—á–∫–∞ —à–ª—é—Ö–∞", "–ø–∞–ø–æ—á–∫–∞ –º—Ä–∞–∑—å", "–ø–∞–ø–æ—á–∫–∞ –≥–∞–Ω–¥–æ–Ω",
    "–±–∞—Ç—è–Ω—è —à–ª—é—Ö–∞", "–±–∞—Ç—è–Ω—è —Ö—É–π–ª–æ", "–±–∞—Ç—è–Ω—è –ø–∏–¥–æ—Ä",
    "–ø–∞–ø—É –µ–±–∞–ª", "–æ—Ç—Ü–∞ –µ–±–∞–ª", "–ø–∞–ø—É —Ç—Ä–∞—Ö–∞–ª", "–æ—Ç—Ü–∞ —Ç—Ä–∞—Ö–∞–ª",
    "–ø–∞–ø—É —É–Ω–∏–∂–∞–ª", "–æ—Ç—Ü–∞ —É–Ω–∏–∂–∞–ª", "–ø–∞–ø—É –æ–±–æ—Å—Å–∞–ª", "–æ—Ç—Ü–∞ –æ–±–æ—Å—Å–∞–ª",
    "–ø–∞–ø—É –æ–±—Ä—É–≥–∞–ª", "–æ—Ç—Ü–∞ –æ–±—Ä—É–≥–∞–ª", "–ø–∞–ø—É —É–¥–∞—Ä–∏–ª", "–æ—Ç—Ü–∞ —É–¥–∞—Ä–∏–ª",
    "–ø–∞–ø—É –ø–Ω—É–ª", "–æ—Ç—Ü–∞ –ø–Ω—É–ª", "–ø–∞–ø—É –¥–∞–ª –≤ —Ä–æ—Ç", "–æ—Ç—Ü–∞ –¥–∞–ª –≤ —Ä–æ—Ç",
    "–ø–∞–ø—É —Ç—Ä–∞—Ö–Ω—É–ª", "–æ—Ç—Ü–∞ —Ç—Ä–∞—Ö–Ω—É–ª", "–ø–∞–ø—É —É–Ω–∏–∑–∏–ª", "–æ—Ç—Ü–∞ —É–Ω–∏–∑–∏–ª",
    "–ø–∞–ø—É –æ–±–ª–∏–ª", "–æ—Ç—Ü–∞ –æ–±–ª–∏–ª", "–ø–∞–ø—É –ø–æ—Ü–∞—Ä–∞–ø–∞–ª", "–æ—Ç—Ü–∞ –ø–æ—Ü–∞—Ä–∞–ø–∞–ª",
    "–ø–∞–ø–∞—à–∞ –µ–±–∞–Ω—ã–π", "–ø–∞–ø–∞—à–∞ —Å–æ—Å–∞–ª", "–ø–∞–ø–∫–∞ –µ–±–∞–Ω–∞—è", "–ø–∞–ø–∫–∞ —Å–æ—Å–∞–ª–∞",
    "–±–∞—Ç—è —Ç—Ä–∞—Ö–∞–Ω—ã–π", "–æ—Ç–µ—Ü —Ç—Ä–∞—Ö–∞–Ω—ã–π", "–ø–∞–ø—É–ª—è –µ–±–Ω—É—Ç–∞—è", "–ø–∞–ø–æ—á–∫–∞ —Ç—Ä–∞—Ö–∞–Ω–∞—è",
    "–ø–∞–ø—É–ª—è —Å–æ—Å–∞–ª–∞", "–ø–∞–ø—É–ª—è —à–ª—é—Ö–æ–π", "–æ—Ç–µ—Ü —à–ª—é—Ö–æ–π", "–ø–∞–ø–∫–∞ —à–ª—é—Ö–æ–π"

    # –ë–∞–±–∫–∏ –∏ –¥–µ–¥—É—à–∫–∏
                                                     "–±–∞–±–∫–∞ –µ–±–∞–Ω–∞—è", "–±–∞–±–∫–∞ —Ç—Ä–∞—Ö–∞–Ω–∞—è", "–±–∞–±–∫–∞ —Å–æ—Å–∞–ª–∞", "–±–∞–±–∫–∞ –ø–∏–∑–¥–∞",
    "–±–∞–±–∫–∞ –º—Ä–∞–∑—å",
    "–±–∞–±—É—à–∫–∞ –µ–±–∞–Ω–∞—è", "–±–∞–±—É—à–∫–∞ —Ç—Ä–∞—Ö–∞–Ω–∞—è", "–±–∞–±—É—à–∫–∞ –±–ª—è–¥–∏–Ω–∞", "–±–∞–±—É—à–∫–∞ —à–∞–ª–∞–≤–∞",
    "–¥–µ–¥ –µ–±–∞–Ω—ã–π", "–¥–µ–¥ –º—Ä–∞–∑—å", "–¥–µ–¥ –±–ª—è–¥–∏–Ω–∞", "–¥–µ–¥ –≥–∞–Ω–¥–æ–Ω", "–¥–µ–¥—É—à–∫–∞ —à–ª—é—Ö–∞",
    "–¥–µ–¥—É—à–∫–∞ –º—Ä–∞–∑—å", "–¥–µ–¥—É—à–∫–∞ –±–ª—è–¥–∏–Ω–∞",
    "–±–∞–±–∫—É –µ–±–∞–ª", "–±–∞–±—É—à–∫—É –µ–±–∞–ª", "–¥–µ–¥–∫—É –µ–±–∞–ª", "–¥–µ–¥—É—à–∫—É –µ–±–∞–ª",

    # –î–µ—Ç–∏
    "—Å—ã–Ω –µ–±–∞–Ω—ã–π", "—Å—ã–Ω –µ–±—É—á–∏–π", "—Å—ã–Ω –º—Ä–∞–∑–∏", "—Å—ã–Ω —à–ª—é—Ö–∏ –µ–±–∞–Ω–æ–π", "—Å—ã–Ω –±–ª—è–¥–∏ –µ–±–∞–Ω–æ–π",
    "—Å—ã–Ω —à–∞–ª–∞–≤—ã –µ–±–∞–Ω–æ–π", "—Å—ã–Ω –µ–±–∞–Ω—É—Ç–æ–π", "—Å—ã–Ω —É–±–ª—é–¥–∫–∞", "—Å—ã–Ω –≥–∞–Ω–¥–æ–Ω–∞",
    "–¥–æ—á—å –µ–±–∞–Ω–∞—è", "–¥–æ—á—å —à–ª—é—Ö–∞", "–¥–æ—á—å –º—Ä–∞–∑—å", "–¥–æ—á—å —Å—É—á–∫–∞", "–¥–æ—á—å —à–∞–ª–∞–≤–∞",
    "–¥–æ—á–∫–∞ –±–ª—è–¥–∏–Ω–∞", "–¥–æ—á–∫–∞ —à–ª—é—Ö–∞", "–¥–æ—á–∫–∞ —à–∞–ª–∞–≤–∞", "–¥–æ—á–∫–∞ –º—Ä–∞–∑—å", "–¥–æ—á–∫–∞ —Å—É—á–∫–∞",
    "—Å—ã–Ω—É –¥–∞–ª –≤ —Ä–æ—Ç", "–¥–æ—á–µ—Ä–∏ –¥–∞–ª –≤ —Ä–æ—Ç", "—Å—ã–Ω—É –µ–±–∞–ª", "–¥–æ—á–µ—Ä–∏ –µ–±–∞–ª", "—Å—ã–Ω—É —Ç—Ä–∞—Ö–Ω—É–ª", "–¥–æ—á–µ—Ä–∏ —Ç—Ä–∞—Ö–Ω—É–ª",
    "—Å—ã–Ω —à–ª—é—Ö–∏", "—Å—ã–Ω –ø–∏–¥–æ—Ä–∞—Å–∫–∏", "—Å—ã–Ω –¥–∞—É–Ω–∞", "—Å—ã–Ω –¥—É—Ä—ã", "—Å—ã–Ω –æ–±—å–µ–±—ã—à–∞", "—Å—ã–Ω —Ö—É–π–Ω–∏", "–¥–æ—á—å —à–ª—é—Ö–∏",
    "–¥–æ—á—å –ø–∏–¥–æ—Ä–∞—Å–∫–∏", "–¥–æ—á—å –¥–∞—É–Ω—ã", "–¥–æ—á—å –¥–∞—É–Ω–∞", "–¥–æ—á—å –¥—É—Ä—ã", "–¥–æ—á—å –æ–±—å–µ–±—ã—à–∞", "–¥–æ—á—å —Ö—É–π–Ω–∏",

    # –í–Ω—É–∫–∏
    "–≤–Ω—É–∫ —à–ª—é—Ö–∏", "–≤–Ω—É–∫ –±–ª—è–¥–∏", "–≤–Ω—É–∫ –º—Ä–∞–∑–∏", "–≤–Ω—É–∫ –≥–∞–Ω–¥–æ–Ω–∞", "–≤–Ω—É–∫ —à–∞–ª–∞–≤—ã",
    "–≤–Ω—É–∫ –µ–±–∞–Ω—ã–π", "–≤–Ω—É–∫ –±–ª—è–¥–∏–Ω–∞", "–≤–Ω—É–∫ —Å—É—á–∫–∏",
    "–≤–Ω—É—á–∫–∞ —à–ª—é—Ö–∞", "–≤–Ω—É—á–∫–∞ –±–ª—è–¥–∏–Ω–∞", "–≤–Ω—É—á–∫–∞ —Å—É—á–∫–∞", "–≤–Ω—É—á–∫–∞ –º—Ä–∞–∑—å",
    "–≤–Ω—É—á–∫–∞ –µ–±–∞–Ω–∞—è", "–≤–Ω—É—á–∫–∞ —Ç—Ä–∞—Ö–∞–Ω–∞—è", "–≤–Ω—É—á–∫–∞ —à–∞–ª–∞–≤–∞",
    "–≤–Ω—É–∫—É –µ–±–∞–ª", "–≤–Ω—É—á–∫–µ –µ–±–∞–ª", "–≤–Ω—É–∫—É —Ç—Ä–∞—Ö–Ω—É–ª", "–≤–Ω—É—á–∫–µ —Ç—Ä–∞—Ö–Ω—É–ª", "–≤–Ω—É–∫—É –¥–∞–ª –≤ —Ä–æ—Ç", "–≤–Ω—É—á–∫–µ –¥–∞–ª –≤ —Ä–æ—Ç"

]
LATIN_TO_CYRILLIC = {
    'a': '–∞', 'b': '–≤', 'c': '—Å', 'e': '–µ', 'h': '–Ω',
    'k': '–∫', 'm': '–º', 'n': '–ø', 'o': '–æ', 'p': '—Ä',
    'r': '—Ä', 's': '—Å', 't': '—Ç', 'u': '—É', 'x': '—Ö',
    'y': '—É', 'z': '–∑', 'd': '–¥', 'l': '–ª', 'f': '—Ñ',
    'g': '–≥', 'q': '–∫', 'j': '–π', 'w': '–≤',
    '6': '–±', '4': '—á', '3': '–∑', '@': '–∞', '0': '–æ', '1': '–∏'
}


def normalize_text(text: str) -> str:
    text = unicodedata.normalize("NFKC", text)  # –ø—Ä–∏–≤–µ–¥–µ–Ω–∏–µ —é–Ω–∏–∫–æ–¥–∞
    text = text.lower()
    # –ø–µ—Ä–µ–≤–æ–¥ –ª–∞—Ç–∏–Ω–∏—Ü—ã –≤ –∫–∏—Ä–∏–ª–ª–∏—Ü—É
    text = ''.join(LATIN_TO_CYRILLIC.get(ch, ch) for ch in text)
    # –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã/—Ü–∏—Ñ—Ä—ã
    text = re.sub(r'[^–∞-—è—ë0-9]', '', text)
    return text


# –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –±–∞–Ω-—Ñ—Ä–∞–∑
NORMALIZED_BANNED_PHRASES = [normalize_text(p) for p in BANNED_PHRASES]

user_message_times = defaultdict(lambda: deque())

last_spam_mute_time = {}
last_offense_mute_time = {}


def get_user_status(user_id: int) -> int:
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT status FROM users WHERE user_id = ?", (str(user_id),))
    result = cursor.fetchone()
    conn.close()
    return result[0] if result else 0


CHAT_SETTINGS_FILE = "chatsetting.json"


def load_chat_settings():
    if not os.path.exists(CHAT_SETTINGS_FILE):
        return {}
    with open(CHAT_SETTINGS_FILE, "r", encoding="utf-8") as f:
        return json.load(f)


def save_chat_settings(settings):
    with open(CHAT_SETTINGS_FILE, "w", encoding="utf-8") as f:
        json.dump(settings, f, ensure_ascii=False, indent=2)


def get_chat_setting(chat_id):
    settings = load_chat_settings()
    chat_key = str(chat_id)
    # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: —Ä–∞–∑—Ä–µ—à–µ–Ω—ã —Å—Å—ã–ª–∫–∏ –∏ –ø–µ—Ä–µ—Å—ã–ª–∫–∞ (0 = —Ä–∞–∑—Ä–µ—à–µ–Ω–æ)
    default = {"link_setting": 0, "fw_setting": 0}
    return settings.get(chat_key, default)


def set_chat_setting(chat_id, link_setting=None, fw_setting=None):
    settings = load_chat_settings()
    chat_key = str(chat_id)
    current = settings.get(chat_key, {"link_setting": 1, "fw_setting": 1})
    if link_setting is not None:
        current["link_setting"] = link_setting
    if fw_setting is not None:
        current["fw_setting"] = fw_setting
    settings[chat_key] = current
    save_chat_settings(settings)


async def cmd_link(update: Update, context: ContextTypes.DEFAULT_TYPE):
    chat = update.effective_chat
    user = update.effective_user

    if not await is_user_admin(update, context, user.id):
        await update.message.reply_text("‚ùå –¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω—ã –º–æ–≥—É—Ç –º–µ–Ω—è—Ç—å —ç—Ç—É –Ω–∞—Å—Ç—Ä–æ–π–∫—É.")
        return

    # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é –Ω–∞—Å—Ç—Ä–æ–π–∫—É
    current_setting = get_chat_setting(chat.id).get("link_setting", 0)  # –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ä–∞–∑—Ä–µ—à–µ–Ω—ã

    args = context.args
    if not args:
        status_text = "—Ä–∞–∑—Ä–µ—à–µ–Ω—ã ‚úÖ" if current_setting == 0 else "–∑–∞–ø—Ä–µ—â–µ–Ω—ã ‚ùå"
        await update.message.reply_text(
            f"üìä *–¢–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—Å—ã–ª–æ–∫:*\nüîó –°—Å—ã–ª–∫–∏ –≤ —ç—Ç–æ–º —á–∞—Ç–µ *{status_text}*",
            parse_mode="Markdown"
        )
        return

    if args[0] not in ("0", "1"):
        await update.message.reply_text(
            "üìå –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:\n"
            "`/link 0` ‚Äî —Ä–∞–∑—Ä–µ—à–∏—Ç—å —Å—Å—ã–ª–∫–∏\n"
            "`/link 1` ‚Äî –∑–∞–ø—Ä–µ—Ç–∏—Ç—å —Å—Å—ã–ª–∫–∏",
            parse_mode="Markdown"
        )
        return

    # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–æ–≤–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    setting = int(args[0])
    set_chat_setting(chat.id, link_setting=setting)

    status_text = "—Ä–∞–∑—Ä–µ—à–µ–Ω—ã ‚úÖ" if setting == 0 else "–∑–∞–ø—Ä–µ—â–µ–Ω—ã ‚ùå"

    keyboard = InlineKeyboardMarkup([
        [
            InlineKeyboardButton("üîÑ –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å", callback_data=f"toggle_link_{1 - setting}")
        ]
    ])

    await update.message.reply_text(
        f"‚úÖ *–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã.*\n"
        f"üîó –°—Å—ã–ª–∫–∏ –≤ —ç—Ç–æ–º —á–∞—Ç–µ: *{status_text}*",
        reply_markup=keyboard,
        parse_mode="Markdown"
    )


async def toggle_link_setting_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    data = query.data
    chat_id = query.message.chat.id
    user_id = query.from_user.id

    if not await is_user_admin(update, context, user_id):
        await query.answer("‚ùå –¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω—ã –º–æ–≥—É—Ç –º–µ–Ω—è—Ç—å —ç—Ç—É –Ω–∞—Å—Ç—Ä–æ–π–∫—É.", show_alert=True)
        return

    if data.startswith("toggle_link_"):
        new_setting = int(data.split("_")[-1])
        set_chat_setting(chat_id, link_setting=new_setting)

        status_text = "—Ä–∞–∑—Ä–µ—à–µ–Ω—ã ‚úÖ" if new_setting == 0 else "–∑–∞–ø—Ä–µ—â–µ–Ω—ã ‚ùå"
        keyboard = InlineKeyboardMarkup([
            [
                InlineKeyboardButton("üîÑ –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å", callback_data=f"toggle_link_{1 - new_setting}")
            ]
        ])

        # ‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞–µ–º alert –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        await query.answer("‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!", show_alert=True)

        await query.edit_message_text(
            f"‚úÖ *–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã.*\n"
            f"üîó –°—Å—ã–ª–∫–∏ –≤ —ç—Ç–æ–º —á–∞—Ç–µ: *{status_text}*",
            reply_markup=keyboard,
            parse_mode="Markdown"
        )


async def is_user_admin(update: Update, context: ContextTypes.DEFAULT_TYPE, user_id: int) -> bool:
    try:
        member = await context.bot.get_chat_member(update.effective_chat.id, user_id)
        return member.status in [ChatMember.ADMINISTRATOR, ChatMember.OWNER]
    except Exception:
        return False


def escape_md_v2(text: str) -> str:
    # –ù–µ —ç–∫—Ä–∞–Ω–∏—Ä—É–µ–º '*', —á—Ç–æ–±—ã –∂–∏—Ä–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç–∞–ª–∞
    escape_chars = r'_[]()~`>#+-=|{}.!\\'
    return ''.join(f'\\{c}' if c in escape_chars else c for c in text)


chat_settings_cache = {}


def get_chat_setting_automute(chat_id: int) -> dict:
    if chat_id in chat_settings_cache:
        return chat_settings_cache[chat_id]

    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("""
        SELECT antispam, mute_level, kick_level, ban_level, pin_level,
               unmute_level, role_change, change_settings
        FROM chat_settings
        WHERE chat_id = ?
    """, (str(chat_id),))
    row = cursor.fetchone()
    conn.close()

    if row:
        settings = {
            "antispam": row[0] if row[0] is not None else 1,
            "mute_level": row[1] if row[1] is not None else 7,
            "kick_level": row[2] if row[2] is not None else 7,
            "ban_level": row[3] if row[3] is not None else 7,
            "pin_level": row[4] if row[4] is not None else 7,
            "unmute_level": row[5] if row[5] is not None else 7,
            "role_change": row[6] if row[6] is not None else 7,
            "change_settings": row[7] if row[7] is not None else 7,
        }
    else:
        settings = {
            "antispam": 1,
            "mute_level": 7,
            "kick_level": 7,
            "ban_level": 7,
            "pin_level": 7,
            "unmute_level": 7,
            "role_change": 7,
            "change_settings": 7,
        }

    chat_settings_cache[chat_id] = settings
    return settings


async def auto_mute_check(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if update.message is None:
        return

    user = update.message.from_user
    chat = update.effective_chat
    msg = update.message
    now = int(time.time())

    # --- –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —á–∞—Ç–∞ ---
    chat_settings = get_chat_setting_automute(chat.id)
    link_setting = chat_settings.get("link_setting", 0)
    antispam_enabled = chat_settings.get("antispam", 1)

    # --- –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–∫–ª—é—á—ë–Ω–Ω–æ–≥–æ –∞–Ω—Ç–∏—Å–ø–∞–º–∞ ---
    if antispam_enabled == 0:
        if user.id in user_message_times:
            user_message_times[user.id].clear()
        return

    # --- –ø–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç, –µ—Å–ª–∏ –µ—Å—Ç—å ---
    text_original = msg.text or msg.caption or ""
    text_lower = text_original.strip().lower()

    # --- –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Å—ã–ª–æ–∫ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å —Ç–µ–∫—Å—Ç) ---
    if text_lower and link_setting == 1 and "https://" in text_lower:
        member = await context.bot.get_chat_member(chat.id, user.id)
        if member.status not in [ChatMember.ADMINISTRATOR, ChatMember.OWNER]:
            try:
                await msg.delete()
                await msg.reply_text("üö´ –í —ç—Ç–æ–º —á–∞—Ç–µ –∑–∞–ø—Ä–µ—â–µ–Ω—ã —Å—Å—ã–ª–∫–∏.")
            except Exception as e:
                print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å—Å—ã–ª–∫–∏: {e}")

    # --- –°–ü–ê–ú-–ü–†–û–í–ï–†–ö–ê (–ª—é–±–æ–π —Ç–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è) ---
    if antispam_enabled == 1:
        if user.id not in user_message_times:
            user_message_times[user.id] = deque()
        times = user_message_times[user.id]
        times.append(now)

        # –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 15 —Å–µ–∫—É–Ω–¥
        while times and times[0] < now - 15:
            times.popleft()

        last_mute_spam = last_spam_mute_time.get(user.id, 0)

        if len(times) >= 10 and (now - last_mute_spam) > 1800:
            try:
                member = await context.bot.get_chat_member(chat.id, user.id)
                if member.status not in [ChatMember.ADMINISTRATOR, ChatMember.OWNER]:
                    await context.bot.restrict_chat_member(
                        chat_id=chat.id,
                        user_id=user.id,
                        permissions=ChatPermissions(can_send_messages=False),
                        until_date=now + 30 * 60
                    )

                    conn = sqlite3.connect(DB_PATH)
                    cursor = conn.cursor()
                    cursor.execute("""
                        INSERT INTO mutes 
                        (muted_user_id, muted_by_user_id, reason, duration, timestamp_start, timestamp_end, chat_id) 
                        VALUES (?, ?, ?, ?, ?, ?, ?)
                    """, (str(user.id), str(context.bot.id), "—Å–ø–∞–º", 30 * 60, now, now + 30 * 60, chat.id))
                    conn.commit()
                    conn.close()

                    change_user_rating(user.id, -2)  # –∞–≤—Ç–æ–º—É—Ç –∑–∞ —Å–ø–∞–º: -2

                    last_spam_mute_time[user.id] = now

                    keyboard = InlineKeyboardMarkup(
                        [[InlineKeyboardButton("üì© –û–±–∂–∞–ª–æ–≤–∞—Ç—å", url="https://t.me/FernieXBot?start=appealmenu")]]
                    )

                    await msg.reply_text(
                        f"üîá –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –º—É—Ç\n"
                        f"üë§ {user.mention_html()}\n"
                        f"‚è± 30 –º–∏–Ω—É—Ç\n"
                        f"üìÑ –ü—Ä–∏—á–∏–Ω–∞: —Å–ø–∞–º",
                        reply_markup=keyboard,
                        parse_mode="HTML"
                    )
            except Exception as e:
                print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–¥–∞—á–µ –º—É—Ç–∞ –∑–∞ —Å–ø–∞–º: {e}")

    # --- –ü–†–û–í–ï–†–ö–ê –ù–ê –û–°–ö–û–†–ë–õ–ï–ù–ò–Ø (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å —Ç–µ–∫—Å—Ç) ---
    if text_original:
        normalized_msg = normalize_text(text_original).replace(" ", "")
        last_mute_offense = last_offense_mute_time.get(user.id, 0)
        if (now - last_mute_offense) > 3600:
            for phrase in NORMALIZED_BANNED_PHRASES:
                if phrase in normalized_msg:
                    await apply_mute_and_notify(
                        update, context, user, chat, now,
                        "–æ—Å–∫–æ—Ä–±–ª–µ–Ω–∏–µ/—É–ø–æ–º–∏–Ω–∞–Ω–∏–µ —Ä–æ–¥–Ω—ã—Ö",
                        60 * 60,
                        last_offense_mute_time
                    )
                    return


SPECIAL_REVIEW_CHAT_ID = -1002717991572


async def apply_mute_and_notify(update, context, user, chat, now, reason, duration_seconds, last_mute_dict):
    try:
        member = await context.bot.get_chat_member(chat.id, user.id)

        user_status = get_user_status(user.id)

        if member.status in [ChatMember.ADMINISTRATOR, ChatMember.OWNER] or user_status >= 2:
            try:
                await update.message.reply_text(
                    "‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–º–µ–µ—Ç –≤—ã—Å–æ–∫–∏–π —Å—Ç–∞—Ç—É—Å –∏–ª–∏ —è–≤–ª—è–µ—Ç—Å—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –º—É—Ç –Ω–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è."
                )
            except Exception as e:
                print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –ø—Ä–∏–≤–∏–ª–µ–≥–∏–∏: {e}")
            return

        until_date = now + duration_seconds

        try:
            await context.bot.restrict_chat_member(
                chat.id,
                user.id,
                permissions=ChatPermissions(can_send_messages=False),
                until_date=until_date
            )

            conn = sqlite3.connect(DB_PATH)
            cursor = conn.cursor()
            cursor.execute("""
                INSERT INTO mutes 
                (muted_user_id, muted_by_user_id, reason, duration, timestamp_start, timestamp_end, chat_id) 
                VALUES (?, ?, ?, ?, ?, ?, ?)
            """, (str(user.id), str(context.bot.id), reason, duration_seconds, now, until_date, chat.id))
            conn.commit()
            conn.close()

            change_user_rating(user.id, -2)  # –∞–≤—Ç–æ–º—É—Ç –∑–∞ –æ—Å–∫–æ—Ä–±–ª–µ–Ω–∏–µ: -2

        except Exception as e:
            print(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–¥–∞—Ç—å –º—É—Ç ({reason}): {e}")
            try:
                await update.message.reply_text("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–¥–∞—Ç—å –º—É—Ç ‚Äî –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –∏–ª–∏ –æ—à–∏–±–∫–∞ —É –±–æ—Ç–∞.")
            except Exception:
                pass
            return

        last_mute_dict[user.id] = now

        keyboard = InlineKeyboardMarkup([
            [InlineKeyboardButton("üì© –û–±–∂–∞–ª–æ–≤–∞—Ç—å", url="https://t.me/FernieXBot?start=appealmenu")]
        ])

        name_safe = escape_markdown(user.full_name, version=2)
        reason_safe = escape_markdown(reason, version=2)

        text = (
            f"üîá *–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –º—É—Ç*\n"
            f"üë§ [{name_safe}](tg://user?id={user.id})\n"
            f"‚è± –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: {duration_seconds // 60} –º–∏–Ω\n"
            f"üìÑ –ü—Ä–∏—á–∏–Ω–∞: {reason_safe}\n\n"
            f"```–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –î–ª—è –æ–±–∂–∞–ª–æ–≤–∞–Ω–∏—è –ø–µ—Ä–µ–π–¥–∏—Ç–µ –ø–æ –∫–Ω–æ–ø–∫–µ –Ω–∏–∂–µ```"
        )

        try:
            await update.message.reply_text(
                text=text,
                reply_markup=keyboard,
                parse_mode="MarkdownV2"
            )
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –º—É—Ç–µ ({reason}): {e}")

    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–¥–∞—á–µ –º—É—Ç–∞ ({reason}): {e}")

# --- –∫–æ–º–∞–Ω–¥–∞ /appeal ---
async def appeal_command(update: Update, context: ContextTypes.DEFAULT_TYPE):

    user = update.effective_user
    user_id = str(user.id)
    message = update.message or update.callback_query.message

    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    punishments = []

    # –ú—É—Ç—ã
    cursor.execute("""
        SELECT 'mute', reason, duration, timestamp_start, timestamp_end, chat_id
        FROM mutes
        WHERE muted_user_id = ? AND timestamp_end > ?
    """, (user_id, int(time.time())))
    punishments += cursor.fetchall()

    # –ë–∞–Ω—ã
    cursor.execute("""
        SELECT 'ban', reason, duration, timestamp_start, timestamp_end, chat_id
        FROM bans
        WHERE banned_user_id = ? AND (timestamp_end > ? OR timestamp_end = -1)
    """, (user_id, int(time.time())))
    punishments += cursor.fetchall()

    conn.close()

    if not punishments:
        await message.reply_text("–£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –Ω–∞–∫–∞–∑–∞–Ω–∏–π.")
        return

    context.user_data["appeal_list"] = punishments

    # –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å–æ –≤—Å–µ–º–∏ –Ω–∞–∫–∞–∑–∞–Ω–∏—è–º–∏
    keyboard = []
    for idx, (ptype, reason, duration, ts_start, ts_end, chat_id) in enumerate(punishments):
        try:
            chat = await context.bot.get_chat(chat_id)
            title = chat.title or str(chat_id)
        except:
            title = str(chat_id)
        label = f"{'–ú—É—Ç' if ptype=='mute' else '–ë–∞–Ω'} | {title}"
        keyboard.append([InlineKeyboardButton(label, callback_data=f"appeal_select:{idx}")])

    await message.reply_text(
        "–£ –≤–∞—Å –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ –Ω–∞–∫–∞–∑–∞–Ω–∏—è. –í—ã–±–µ—Ä–∏—Ç–µ –æ–¥–Ω–æ –¥–ª—è –æ–±–∂–∞–ª–æ–≤–∞–Ω–∏—è:",
        reply_markup=InlineKeyboardMarkup(keyboard)
    )

# --- –≤—ã–±–æ—Ä –Ω–∞–∫–∞–∑–∞–Ω–∏—è ---
async def appeal_select_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    _, idx = query.data.split(":")
    idx = int(idx)

    punishment = context.user_data.get("appeal_list", [])[idx]
    if not punishment:
        await query.edit_message_text("‚ö†Ô∏è –ù–∞–∫–∞–∑–∞–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.")
        return

    ptype, reason, duration_sec, ts_start, ts_end, chat_id = punishment

    # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Å–µ–∫—É–Ω–¥—ã –≤ –¥.—á.–º.—Å
    days, remainder = divmod(duration_sec, 86400)
    hours, remainder = divmod(remainder, 3600)
    minutes, seconds = divmod(remainder, 60)

    duration_str = f"{days}–¥ {hours}—á {minutes}–º {seconds}—Å" if duration_sec > 0 else "–Ω–∞–≤—Å–µ–≥–¥–∞"

    try:
        chat = await context.bot.get_chat(chat_id)
        title = chat.title or str(chat_id)
    except:
        title = str(chat_id)

    text = (
        "‚öñÔ∏è <b>–û–±–∂–∞–ª–æ–≤–∞–Ω–∏–µ –Ω–∞–∫–∞–∑–∞–Ω–∏—è</b>\n"
        "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n"
        f"üè∑ <b>–ß–∞—Ç:</b> {title}\n"
        f"üÜî <b>ID —á–∞—Ç–∞:</b> <code>{chat_id}</code>\n\n"
        f"üö´ <b>–¢–∏–ø –Ω–∞–∫–∞–∑–∞–Ω–∏—è:</b> {'üîá –ú—É—Ç' if ptype == 'mute' else '‚õî –ë–∞–Ω'}\n"
        f"üìÑ <b>–ü—Ä–∏—á–∏–Ω–∞:</b>\n<code>{reason}</code>\n\n"
        f"‚è± <b>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</b> {duration_str}\n\n"
        "–ï—Å–ª–∏ –≤—ã —Å—á–∏—Ç–∞–µ—Ç–µ –Ω–∞–∫–∞–∑–∞–Ω–∏–µ –æ—à–∏–±–æ—á–Ω—ã–º –∏–ª–∏ –Ω–µ—Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤—ã–º,\n"
        "–≤—ã –º–æ–∂–µ—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∞–ø–µ–ª–ª—è—Ü–∏—é –Ω–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ."
    )

    keyboard = InlineKeyboardMarkup([
        [
            InlineKeyboardButton("üìÆ –û–±–∂–∞–ª–æ–≤–∞—Ç—å", callback_data=f"appeal_send:{ptype}:{idx}"),
            InlineKeyboardButton("‚¨Ö –ù–∞–∑–∞–¥", callback_data="appeal_back")
        ]
    ])

    await query.edit_message_text(text, reply_markup=keyboard, parse_mode=ParseMode.HTML)


async def appeal_back_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    message = update.message or query.message
    await appeal_command(update, context)

async def appeal_send_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    user = query.from_user
    _, ptype, idx = query.data.split(":")
    idx = int(idx)

    punishment = context.user_data["appeal_list"][idx]
    _, reason, duration_sec, ts_start, ts_end, chat_id = punishment

    # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Å–µ–∫—É–Ω–¥—ã –≤ –¥.—á.–º.—Å
    if duration_sec <= 0:
        duration_str = "–Ω–∞–≤—Å–µ–≥–¥–∞"
    else:
        days, remainder = divmod(duration_sec, 86400)
        hours, remainder = divmod(remainder, 3600)
        minutes, seconds = divmod(remainder, 60)
        duration_str = f"{days}–¥ {hours}—á {minutes}–º {seconds}—Å"

    text = (
        "‚öñÔ∏è <b>–ó–∞–ø—Ä–æ—Å –Ω–∞ –æ–±–∂–∞–ª–æ–≤–∞–Ω–∏–µ –Ω–∞–∫–∞–∑–∞–Ω–∏—è</b>\n"
        "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n"
        f"üë§ <b>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</b> "
        f"<a href='tg://user?id={user.id}'>{user.full_name}</a>\n\n"
        f"üö´ <b>–¢–∏–ø –Ω–∞–∫–∞–∑–∞–Ω–∏—è:</b> {'üîá –ú—É—Ç' if ptype == 'mute' else '‚õî –ë–∞–Ω'}\n"
        f"üìÑ <b>–ü—Ä–∏—á–∏–Ω–∞:</b>\n<code>{reason}</code>\n\n"
        f"‚è± <b>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</b> {duration_str}\n\n"
        "üì¨ <i>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –Ω–∏–∂–µ, —á—Ç–æ–±—ã –ø—Ä–∏–Ω—è—Ç—å —Ä–µ—à–µ–Ω–∏–µ –ø–æ –∞–ø–µ–ª–ª—è—Ü–∏–∏.</i>"
    )

    keyboard = InlineKeyboardMarkup([
        [
            InlineKeyboardButton("‚úÖ –û–±–∂–∞–ª–æ–≤–∞—Ç—å", callback_data=f"appeal_accept:{ptype}:{user.id}:{chat_id}"),
            InlineKeyboardButton("‚ùå –û—Ç–∫–∞–∑–∞—Ç—å", callback_data=f"appeal_reject:{ptype}:{user.id}:{chat_id}")
        ]
    ])

    await context.bot.send_message(
        chat_id=chat_id,
        text=text,
        reply_markup=keyboard,
        parse_mode=ParseMode.HTML
    )

    await query.edit_message_text("üì® –ó–∞–ø—Ä–æ—Å –Ω–∞ –æ–±–∂–∞–ª–æ–≤–∞–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏ —á–∞—Ç–∞, –≥–¥–µ –≤—ã–¥–∞–Ω–æ –Ω–∞–∫–∞–∑–∞–Ω–∏–µ.")


async def appeal_decision_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    action, ptype, target_user_id, chat_id = query.data.split(":")
    target_user_id = int(target_user_id)
    chat_id = int(chat_id)

    # –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
    admin = await context.bot.get_chat_member(chat_id, query.from_user.id)
    if admin.status not in ("administrator", "creator"):
        await query.answer(
            "‚ùå –¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —á–∞—Ç–∞ –º–æ–∂–µ—Ç –ø—Ä–∏–Ω—è—Ç—å —Ä–µ—à–µ–Ω–∏–µ.",
            show_alert=True
        )
        return

    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    table = "mutes" if ptype == "mute" else "bans"
    user_field = "muted_user_id" if ptype == "mute" else "banned_user_id"

    cursor.execute(
        f"SELECT reason, duration FROM {table} WHERE {user_field} = ?",
        (str(target_user_id),)
    )
    data = cursor.fetchone()

    if not data:
        await query.edit_message_text(
            "‚ÑπÔ∏è <b>–ù–∞–∫–∞–∑–∞–Ω–∏–µ —É–∂–µ —Å–Ω—è—Ç–æ</b>.",
            parse_mode=ParseMode.HTML
        )
        conn.close()
        return

    reason, duration = data

    # –ø—Ä–∏–Ω—è—Ç–∏–µ —Ä–µ—à–µ–Ω–∏—è
    if action == "appeal_accept":
        # —É–¥–∞–ª—è–µ–º –Ω–∞–∫–∞–∑–∞–Ω–∏–µ –∏–∑ –ë–î
        cursor.execute(
            f"DELETE FROM {table} WHERE {user_field} = ?",
            (str(target_user_id),)
        )
        conn.commit()

        if ptype == "mute":
            # —Å–Ω–∏–º–∞–µ–º –º—É—Ç –∏ —Ä–∞–∑—Ä–µ—à–∞–µ–º –í–°–Å
            await context.bot.restrict_chat_member(
                chat_id=chat_id,
                user_id=target_user_id,
                permissions=ChatPermissions(
                    can_send_messages=True,
                    can_send_audios=True,
                    can_send_documents=True,
                    can_send_photos=True,
                    can_send_videos=True,
                    can_send_video_notes=True,
                    can_send_voice_notes=True,
                    can_send_polls=True,
                    can_send_other_messages=True,
                    can_add_web_page_previews=True,
                    can_change_info=False,
                    can_invite_users=True,
                    can_pin_messages=False
                )
            )

        elif ptype == "ban":
            # —Å–Ω–∏–º–∞–µ–º –±–∞–Ω –≤ Telegram
            await context.bot.unban_chat_member(
                chat_id=chat_id,
                user_id=target_user_id,
                only_if_banned=True  # –≤–∞–∂–Ω–æ, —á—Ç–æ–±—ã –Ω–µ —Ä—É–≥–∞–ª—Å—è, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Ä–∞–∑–±–∞–Ω–µ–Ω
            )

        result = "‚úÖ –ù–∞–∫–∞–∑–∞–Ω–∏–µ —Å–Ω—è—Ç–æ"
    else:
        result = "‚ùå –í –æ–±–∂–∞–ª–æ–≤–∞–Ω–∏–∏ –æ—Ç–∫–∞–∑–∞–Ω–æ"

    conn.close()

    # —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    try:
        await context.bot.send_message(
            chat_id=target_user_id,
            text=(
                "‚öñÔ∏è <b>–†–µ–∑—É–ª—å—Ç–∞—Ç –æ–±–∂–∞–ª–æ–≤–∞–Ω–∏—è</b>\n"
                "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n"
                f"üè∑ <b>–ß–∞—Ç:</b> {query.message.chat.title}\n"
                f"üÜî <b>ID —á–∞—Ç–∞:</b> <code>{chat_id}</code>\n\n"
                f"üìå <b>–†–µ—à–µ–Ω–∏–µ:</b> {result}\n\n"
                "üëÆ <b>–†–∞—Å—Å–º–æ—Ç—Ä–µ–ª –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä:</b>\n"
                f"‚Ä¢ {query.from_user.full_name}\n"
                f"‚Ä¢ ID: <code>{query.from_user.id}</code>"
            ),
            parse_mode=ParseMode.HTML
        )
    except Exception:
        pass

    # –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –∞–¥–º–∏–Ω-—á–∞—Ç–µ
    await query.edit_message_text(
        (
            "‚öñÔ∏è <b>–†–µ—à–µ–Ω–∏–µ –ø–æ –æ–±–∂–∞–ª–æ–≤–∞–Ω–∏—é</b>\n"
            "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n"
            f"üë§ <b>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ID:</b> <code>{target_user_id}</code>\n"
            f"üö´ <b>–¢–∏–ø –Ω–∞–∫–∞–∑–∞–Ω–∏—è:</b> {'üîá –ú—É—Ç' if ptype == 'mute' else '‚õî –ë–∞–Ω'}\n"
            f"üìå <b>–ò—Ç–æ–≥:</b> {result}\n\n"
            f"üëÆ <b>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä:</b> {query.from_user.full_name}"
        ),
        parse_mode=ParseMode.HTML
    )


async def cwallet_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = str(update.effective_user.id)
    user_name = update.effective_user.full_name
    tg_link = f"[{user_name}](tg://user?id={user_id})"

    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    currencies = ["FTC", "PLO", "LUX"]
    balances = {}

    for currency in currencies:
        cursor.execute(
            "SELECT balance FROM crypto_balances WHERE user_id = ? AND currency = ?",
            (user_id, currency)
        )
        row = cursor.fetchone()
        balances[currency] = row[0] if row else 0

    conn.close()

    text = (
        "üíº *–ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞ | –ö–æ—à–µ–ª—ë–∫*\n"
        "‚ú¶‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ãÜ‚ãÖ‚òÜ‚ãÖ‚ãÜ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ú¶\n"
        f"üë§ *–í–ª–∞–¥–µ–ª–µ—Ü:* {tg_link}\n"
        "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
        "üí∞ *–ë–∞–ª–∞–Ω—Å –ø–æ –≤–∞–ª—é—Ç–∞–º:*\n"
        f"ü™ô *FTC:* `{balances['FTC']}`\n"
        f"ü™ô *PLO:* `{balances['PLO']}`\n"
        f"ü™ô *LUX:* `{balances['LUX']}`\n"
        "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
    )

    await update.message.reply_text(text, parse_mode=ParseMode.MARKDOWN)


JSON_PATH = Path("cryptocurs.json")
CURRENCIES = ["FTC", "PLO", "LUX"]

def update_prices():
    if not JSON_PATH.exists():
        data = {
            c: {
                "price": random.uniform(100, 800),
                "last_price": None,
                "trend": random.choice([1, -1]),
                "trend_duration": random.randint(10, 30),
                "volatility": random.uniform(0.02, 0.06)
            }
            for c in CURRENCIES
        }
        with open(JSON_PATH, "w", encoding="utf-8") as f:
            json.dump(data, f, indent=4, ensure_ascii=False)
        print(f"üìÑ –§–∞–π–ª {JSON_PATH} –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π —Å –Ω–∞—á–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏.")
    else:
        with open(JSON_PATH, "r", encoding="utf-8") as f:
            data = json.load(f)

        for c in CURRENCIES:
            if c not in data:
                data[c] = {
                    "price": random.uniform(100, 800),
                    "last_price": None,
                    "trend": random.choice([1, -1]),
                    "trend_duration": random.randint(10, 30),
                    "volatility": random.uniform(0.02, 0.06)
                }

    for c in CURRENCIES:
        old_price = data[c]["price"]
        trend = data[c].get("trend", 1)
        trend_duration = data[c].get("trend_duration", 0)
        volatility = data[c].get("volatility", 0.04)

        # --- –°–º–µ–Ω–∞ —Ç—Ä–µ–Ω–¥–∞ ---
        if trend_duration <= 0:
            trend = random.choice([1, -1])
            trend_duration = random.randint(10, 40)
            volatility = random.uniform(0.02, 0.07)

        # --- –°—Ä–µ–¥–Ω–µ–≤–æ–∑–≤—Ä–∞—Ç (–Ω–µ –¥–∞—ë—Ç —É–ª–µ—Ç–∞—Ç—å —Å–ª–∏—à–∫–æ–º –¥–∞–ª–µ–∫–æ) ---
        TARGET = 500
        mean_pull = (TARGET - old_price) * 0.015

        # --- –†–µ–¥–∫–∏–µ —Å–æ–±—ã—Ç–∏—è ---
        event = random.random()
        if event < 0.02:
            # Pump +15-40%
            step = random.uniform(0.15, 0.40)
            print(f"üöÄ PUMP {c}!")
        elif event < 0.04:
            # Dump -15-35%
            step = random.uniform(-0.35, -0.15)
            print(f"üí• DUMP {c}!")
        else:
            # –û–±—ã—á–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ —Å —É—á—ë—Ç–æ–º —Ç—Ä–µ–Ω–¥–∞
            # –¢—Ä–µ–Ω–¥ —Å–ª–µ–≥–∫–∞ —Å–º–µ—â–∞–µ—Ç –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –≤ —Å–≤–æ—é —Å—Ç–æ—Ä–æ–Ω—É
            bias = 0.01 * trend
            step = random.uniform(-volatility + bias, volatility + bias)

        # --- –ò—Ç–æ–≥–æ–≤–∞—è —Ü–µ–Ω–∞ ---
        new_price = old_price * (1 + step) + mean_pull

        # –ú–∏–Ω–∏–º—É–º 1, –º–∞–∫—Å–∏–º—É–º 1500
        new_price = max(1.0, min(1500.0, new_price))

        # --- –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ ---
        data[c]["last_price"] = old_price
        data[c]["price"] = round(new_price, 2)
        data[c]["trend"] = trend
        data[c]["trend_duration"] = trend_duration - 1
        data[c]["volatility"] = volatility

        arrow = "üìà" if new_price > old_price else "üìâ" if new_price < old_price else "‚ûñ"
        print(f"{arrow} {c}: {old_price:.2f} ‚û°Ô∏è {new_price:.2f} (—Ç—Ä–µ–Ω–¥: {'‚ñ≤' if trend == 1 else '‚ñº'}, –≤–æ–ª–∞—Ç: {volatility:.3f})")

    print("‚ú®‚ú¶‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ãÜ‚ãÖ‚òÜ‚ãÖ‚ãÜ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ú¶‚ú®")

    with open(JSON_PATH, "w", encoding="utf-8") as f:
        json.dump(data, f, indent=4, ensure_ascii=False)


async def scheduled_price_update(context):
    update_prices()


def escape_md_v2(text):
    import re
    return re.sub(r'([_*\[\]()~`>#+\-=|{}.!])', r'\\\1', str(text))


def format_number_with_dots(number):
    return f"{number:,}".replace(",", ".")

async def ccurs_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    rp_msg = await update.message.reply_text(
        "üß† <b>–û—Ç–∫—Ä—ã–≤–∞–µ–º –∫—Ä–∏–ø—Ç–æ–±–∏—Ä–∂—É...</b>\n"
        "<pre>–ü–æ–¥–≥—Ä—É–∂–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ...</pre>",
        parse_mode=ParseMode.HTML
    )
    await asyncio.sleep(2)

    with open(JSON_PATH, "r", encoding="utf-8") as f:
        data = json.load(f)

    lines = []
    lines.append("üìä <b>–ö–†–ò–ü–¢–û –ë–ò–†–ñ–ê</b>\n")

    for c in CURRENCIES:
        price = data[c]["price"]
        last = data[c].get("last_price")
        trend = data[c].get("trend", 1)
        volatility = data[c].get("volatility", 0.04)

        # –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ü–µ–Ω—ã
        if last is None:
            arrow = "‚ûñ"
            change_str = "–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö"
            color = "‚ö™Ô∏è"
        elif price > last:
            diff = price - last
            pct = (diff / last) * 100
            arrow = "üìà"
            change_str = f"+{diff:.2f} (+{pct:.1f}%)"
            color = "üü¢"
        elif price < last:
            diff = last - price
            pct = (diff / last) * 100
            arrow = "üìâ"
            change_str = f"-{diff:.2f} (-{pct:.1f}%)"
            color = "üî¥"
        else:
            arrow = "‚ûñ"
            change_str = "–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π"
            color = "üü°"

        # –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ —Ä—ã–Ω–∫–∞
        if volatility > 0.055:
            mood = "üî• –¢—É—Ä–±—É–ª–µ–Ω—Ç–Ω–æ—Å—Ç—å"
        elif trend == 1:
            mood = "üü¢ –ë—ã—á–∏–π"
        else:
            mood = "üî¥ –ú–µ–¥–≤–µ–∂–∏–π"

        lines.append(
            f"{color} <b>{c}</b> {arrow}\n"
            f"<blockquote>"
            f"üí∞ <b>{price:.2f}‚ÇΩ</b>\n"
            f"üìä {change_str}\n"
            f"üì° {mood}"
            f"</blockquote>"
        )

    lines.append(f"\nüïê <i>{time.strftime('%d.%m.%Y %H:%M')}</i>")

    await rp_msg.edit_text(
        "\n".join(lines),
        parse_mode=ParseMode.HTML
    )


def get_crypto_price(currency):
    with open(JSON_PATH, "r", encoding="utf-8") as f:
        data = json.load(f)
    return int(data[currency]["price"])  # –±–µ–∑ –∫–æ–ø–µ–µ–∫, —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ


def get_user_balance(user_id):
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT balance FROM users WHERE user_id = ?", (str(user_id),))
    result = cursor.fetchone()
    conn.close()
    return result[0] if result else None


def get_crypto_balance(user_id, currency):
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT balance FROM crypto_balances WHERE user_id = ? AND currency = ?", (str(user_id), currency))
    result = cursor.fetchone()
    conn.close()
    return result[0] if result else 0


def update_crypto_balance(user_id, currency, new_balance):
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    # –ü—Ä–æ–≤–µ—Ä–∏–º –µ—Å—Ç—å –ª–∏ –∑–∞–ø–∏—Å—å
    cursor.execute("SELECT balance FROM crypto_balances WHERE user_id = ? AND currency = ?", (str(user_id), currency))
    if cursor.fetchone():
        cursor.execute("UPDATE crypto_balances SET balance = ? WHERE user_id = ? AND currency = ?",
                       (new_balance, str(user_id), currency))
    else:
        cursor.execute("INSERT INTO crypto_balances (user_id, currency, balance) VALUES (?, ?, ?)",
                       (str(user_id), currency, new_balance))
    conn.commit()
    conn.close()


def upd_user_balance(user_id, new_balance):
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("UPDATE users SET balance = ? WHERE user_id = ?", (new_balance, str(user_id)))
    conn.commit()
    conn.close()


def escape_crypto_v2(text: str) -> str:
    import re
    escape_chars = r'_*\[\]()~`>#+\-=|{}.!:'
    return re.sub(rf'([{re.escape(escape_chars)}])', r'\\\1', text)


async def buycrypto_command(update: Update, context: ContextTypes.DEFAULT_TYPE, index: int, amount: int):
    user_id = update.effective_user.id

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤
    if amount <= 0:
        await update.message.reply_text(
            "‚ö†Ô∏è *–û—à–∏–±–∫–∞ –≤–≤–æ–¥–∞!*\n\n"
            "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å *–ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —Ü–µ–ª—ã–º —á–∏—Å–ª–æ–º*.",
            parse_mode="Markdown"
        )
        return

    if index < 1 or index > len(CURRENCIES):
        await update.message.reply_text(
            f"‚ùóÔ∏è *–û—à–∏–±–∫–∞:* –∏–Ω–¥–µ–∫—Å –≤–∞–ª—é—Ç—ã –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 1 –¥–æ {len(CURRENCIES)}.\n"
            "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä –∏–∑ —Å–ø–∏—Å–∫–∞.",
            parse_mode="Markdown"
        )
        return

    currency = CURRENCIES[index - 1]
    price_per_unit = get_crypto_price(currency)
    total_price = price_per_unit * amount

    # üí∞ –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–º–∏—Å—Å–∏—é 10%
    commission_percent = 0.05
    commission = total_price * commission_percent
    final_price = total_price + commission

    # RP —à–∞–≥ 1
    msg = await update.message.reply_text(
        "ü§ù <b>–ü—Ä–æ—Ü–µ—Å—Å —Å–¥–µ–ª–∫–∏...</b>\n<pre>–°–≤—è–∑—ã–≤–∞–µ–º—Å—è —Å –∫—Ä–∏–ø—Ç–æ–±–∏—Ä–∂–µ–π...</pre>",
        parse_mode=ParseMode.HTML
    )
    await asyncio.sleep(1)

    # RP —à–∞–≥ 2
    await msg.edit_text(
        "ü§ù <b>–ü—Ä–æ—Ü–µ—Å—Å —Å–¥–µ–ª–∫–∏...</b>\n<pre>–ó–∞–ø–æ–ª–Ω—è–µ–º –¥–æ–∫—É–º–µ–Ω—Ç—ã...</pre>",
        parse_mode=ParseMode.HTML
    )
    await asyncio.sleep(2)

    # RP —à–∞–≥ 3
    await msg.edit_text(
        "ü§ù <b>–ü—Ä–æ—Ü–µ—Å—Å —Å–¥–µ–ª–∫–∏...</b>\n<pre>–ó–∞–∫–ª—é—á–∞–µ–º —Å–¥–µ–ª–∫—É...</pre>",
        parse_mode=ParseMode.HTML
    )
    await asyncio.sleep(3)

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞
    user_balance = get_user_balance(user_id)
    if user_balance is None:
        text = "‚ùå *–û—à–∏–±–∫–∞:* –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.\n"
        await msg.edit_text(escape_md_v2(text), parse_mode=ParseMode.MARKDOWN_V2)
        return

    if user_balance < final_price:
        balance = escape_crypto_v2(format_number_with_dots(user_balance))
        price = escape_crypto_v2(format_number_with_dots(final_price))

        text = (
            "ü§ù* –°–¥–µ–ª–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞*\n"
            "‚ùå –ü—Ä–∏—á–∏–Ω–∞: *–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤*\n"
            f"> üí∞ –í–∞—à –±–∞–ª–∞–Ω—Å: *{balance}*‚ÇΩ\n"
            f"> üí∏ –¢—Ä–µ–±—É–µ—Ç—Å—è: *{price}*‚ÇΩ"
        )

        await msg.edit_text(text, parse_mode=ParseMode.MARKDOWN_V2)
        return

    # –°–ø–∏—Å–∞–Ω–∏–µ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–æ–≤
    new_balance = user_balance - final_price
    upd_user_balance(user_id, new_balance)

    current_crypto_balance = get_crypto_balance(user_id, currency)
    new_crypto_balance = current_crypto_balance + amount
    update_crypto_balance(user_id, currency, new_crypto_balance)

    # –£—Å–ø–µ—à–Ω–∞—è –ø–æ–∫—É–ø–∫–∞
    await msg.edit_text(
        f"ü§ù *–°–¥–µ–ª–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞.*\n\n"
        f"ü™ô –¢–∏–ø: –ü–æ–∫—É–ø–∫–∞\n"
        f"üí± –í–∞–ª—é—Ç–∞: *{currency}*\n"
        f"üî¢ –ö–æ–ª-–≤–æ: *{amount}*\n"
        f"üìà –¢–µ–∫—É—â–∏–π –∫—É—Ä—Å: *{format_number_with_dots(price_per_unit)}*/1\n"
        f"üí∏ –¶–µ–Ω–∞ –±–µ–∑ –∫–æ–º–∏—Å—Å–∏–∏: *{format_number_with_dots(total_price)}*\n"
        f"üìâ –ö–æ–º–∏—Å—Å–∏—è (10%): *{format_number_with_dots(commission)}*\n"
        f"üí∏ –ò—Ç–æ–≥–æ–≤–∞—è —Ü–µ–Ω–∞: *{format_number_with_dots(final_price)}*\n"
        f"üí∞ –í–∞—à –±–∞–ª–∞–Ω—Å: *{format_number_with_dots(new_balance)}*\n"
        f"üìä –ë–∞–ª–∞–Ω—Å –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç—ã *{currency}*: *{format_number_with_dots(new_crypto_balance)}*",
        parse_mode=ParseMode.MARKDOWN
    )

async def sellcrypto_command(update: Update, context: ContextTypes.DEFAULT_TYPE, index: int, amount: int):
    user_id = update.effective_user.id

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤
    if amount <= 0:
        await update.message.reply_text(
            "‚ö†Ô∏è *–û—à–∏–±–∫–∞ –≤–≤–æ–¥–∞!*\n\n"
            "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å *–ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —Ü–µ–ª—ã–º —á–∏—Å–ª–æ–º*.",
            parse_mode="Markdown"
        )
        return

    if index < 1 or index > len(CURRENCIES):
        await update.message.reply_text(
            f"‚ùóÔ∏è *–û—à–∏–±–∫–∞:* –∏–Ω–¥–µ–∫—Å –≤–∞–ª—é—Ç—ã –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 1 –¥–æ {len(CURRENCIES)}.\n"
            "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä –∏–∑ —Å–ø–∏—Å–∫–∞.",
            parse_mode="Markdown"
        )
        return

    currency = CURRENCIES[index - 1]
    price_per_unit = get_crypto_price(currency)
    total_value = price_per_unit * amount

    # üí∞ –í—ã—á–∏—Ç–∞–µ–º –∫–æ–º–∏—Å—Å–∏—é 35%
    commission_percent = 0.20
    commission = total_value * commission_percent
    user_receives = total_value - commission

    # RP —à–∞–≥ 1
    msg = await update.message.reply_text(
        "ü§ù <b>–ü—Ä–æ—Ü–µ—Å—Å —Å–¥–µ–ª–∫–∏...</b>\n<pre>–°–≤—è–∑—ã–≤–∞–µ–º—Å—è —Å –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–º...</pre>",
        parse_mode=ParseMode.HTML
    )
    await asyncio.sleep(1)

    # RP —à–∞–≥ 2
    await msg.edit_text(
        "ü§ù <b>–ü—Ä–æ—Ü–µ—Å—Å —Å–¥–µ–ª–∫–∏...</b>\n<pre>–ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ª–∏–Ω–Ω–æ—Å—Ç—å –∞–∫—Ç–∏–≤–∞...</pre>",
        parse_mode=ParseMode.HTML
    )
    await asyncio.sleep(2)

    # RP —à–∞–≥ 3
    await msg.edit_text(
        "ü§ù <b>–ü—Ä–æ—Ü–µ—Å—Å —Å–¥–µ–ª–∫–∏...</b>\n<pre>–ó–∞–∫–ª—é—á–∞–µ–º —Å–¥–µ–ª–∫—É...</pre>",
        parse_mode=ParseMode.HTML
    )
    await asyncio.sleep(3)

    current_crypto_balance = get_crypto_balance(user_id, currency)
    if current_crypto_balance < amount:
        crypto = escape_crypto_v2(format_number_with_dots(current_crypto_balance))
        needed = escape_crypto_v2(format_number_with_dots(amount))

        text = (
            "ü§ù* –°–¥–µ–ª–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞*\n"
            "‚ùå –ü—Ä–∏—á–∏–Ω–∞: *–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç—ã*\n"
            f"> üìä –í–∞—à –±–∞–ª–∞–Ω—Å {currency}: *{crypto}*\n"
            f"> üî¢ –¢—Ä–µ–±—É–µ—Ç—Å—è: *{needed}*"
        )

        await msg.edit_text(text, parse_mode=ParseMode.MARKDOWN_V2)
        return

    # –°–Ω–∏–º–∞–µ–º –∫—Ä–∏–ø—Ç—É –∏ –¥–æ–±–∞–≤–ª—è–µ–º –¥–µ–Ω—å–≥–∏ (—Å —É—á—ë—Ç–æ–º –∫–æ–º–∏—Å—Å–∏–∏)
    new_crypto_balance = current_crypto_balance - amount
    update_crypto_balance(user_id, currency, new_crypto_balance)

    user_balance = get_user_balance(user_id)
    if user_balance is None:
        text = "‚ùå *–û—à–∏–±–∫–∞:* –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.\n"
        await msg.edit_text(escape_md_v2(text), parse_mode=ParseMode.MARKDOWN_V2)
        return

    new_user_balance = user_balance + user_receives
    upd_user_balance(user_id, new_user_balance)

    # –ò—Ç–æ–≥–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    await msg.edit_text(
        f"ü§ù *–°–¥–µ–ª–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞.*\n\n"
        f"ü™ô –¢–∏–ø: –ü—Ä–æ–¥–∞–∂–∞\n"
        f"üí± –í–∞–ª—é—Ç–∞: *{currency}*\n"
        f"üî¢ –ö–æ–ª-–≤–æ: *{amount}*\n"
        f"üìâ –¢–µ–∫—É—â–∏–π –∫—É—Ä—Å: *{format_number_with_dots(price_per_unit)}*/1\n"
        f"üíµ –ü–æ–ª—É—á–µ–Ω–æ (—Å —É—á—ë—Ç–æ–º –∫–æ–º–∏—Å—Å–∏–∏): *{format_number_with_dots(user_receives)}*\n"
        f"üìâ –ö–æ–º–∏—Å—Å–∏—è (35%): *{format_number_with_dots(commission)}*\n"
        f"üí∞ –í–∞—à –±–∞–ª–∞–Ω—Å: *{format_number_with_dots(new_user_balance)}*\n"
        f"üìä –ë–∞–ª–∞–Ω—Å –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç—ã *{currency}*: *{format_number_with_dots(new_crypto_balance)}*",
        parse_mode=ParseMode.MARKDOWN
    )

async def cryptocommand(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = (
        "üì¶ *–ö—Ä–∏–ø—Ç–æ-–∫–æ–º–∞–Ω–¥—ã:*\n\n"
        "‚Ä¢ `–∫—Ä–∏–ø—Ç–∞ !`\n"
        "‚Ä¢ `–∫—Ä–∏–ø—Ç–∞ –∫—É—Ä—Å`\n"
        "‚Ä¢ `–∫—Ä–∏–ø—Ç–∞ –∫–æ—à–µ–ª–µ–∫`\n"
        "‚Ä¢ `–∫—Ä–∏–ø—Ç–∞ –∫—É–ø–∏—Ç—å` {–∏–Ω–¥–µ–∫—Å} {–∫–æ–ª-–≤–æ}\n"
        "‚Ä¢ `–∫—Ä–∏–ø—Ç–∞ –ø—Ä–æ–¥–∞—Ç—å` {–∏–Ω–¥–µ–∫—Å} {–∫–æ–ª-–≤–æ}"
    )

    await update.message.reply_text(text, parse_mode="Markdown")


async def crypto_command_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    message = update.message.text.lower().strip()

    if message == "–∫—Ä–∏–ø—Ç–∞" or message == "–∫—Ä–∏–ø—Ç–∞ !":
        await cryptocommand(update, context)

    elif message == "–∫—Ä–∏–ø—Ç–∞ –∫—É—Ä—Å":
        await ccurs_handler(update, context)

    elif message in ["–∫—Ä–∏–ø—Ç–∞ –∫–æ—à–µ–ª–µ–∫", "–∫—Ä–∏–ø—Ç–∞ –∫–æ—à–µ–ª—ë–∫"]:
        await cwallet_handler(update, context)

    elif message.startswith("–∫—Ä–∏–ø—Ç–∞ –ø—Ä–æ–¥–∞—Ç—å"):
        parts = message.split()
        if len(parts) == 4 and parts[2].isdigit() and parts[3].isdigit():
            index = int(parts[2])
            amount = int(parts[3])
            await sellcrypto_command(update, context, index, amount)
        else:
            await update.message.reply_text("‚ùå –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç: –∫—Ä–∏–ø—Ç–∞ –ø—Ä–æ–¥–∞—Ç—å {–∏–Ω–¥–µ–∫—Å} {–∫–æ–ª-–≤–æ}")

    elif message.startswith("–∫—Ä–∏–ø—Ç–∞ –∫—É–ø–∏—Ç—å"):
        parts = message.split()
        if len(parts) == 4 and parts[2].isdigit() and parts[3].isdigit():
            index = int(parts[2])
            amount = int(parts[3])
            await buycrypto_command(update, context, index, amount)
        else:
            await update.message.reply_text("‚ùå –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç: –∫—Ä–∏–ø—Ç–∞ –∫—É–ø–∏—Ç—å {–∏–Ω–¥–µ–∫—Å} {–∫–æ–ª-–≤–æ}")

    else:
        await update.message.reply_text("‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞. \n"
                                        "–ù–∞–ø–∏—à–∏ `–∫—Ä–∏–ø—Ç–∞ !` —á—Ç–æ–±—ã –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫—Ä–∏–ø—Ç–æ-–∫–æ–º–∞–Ω–¥.")


def get_clan_name(clan_id):
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT name FROM clans WHERE clan_id = ?", (clan_id,))
    result = cursor.fetchone()
    conn.close()
    return result[0] if result else None


def is_clan_owner(user_id, clan_id):
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT is_owner FROM clan_members WHERE user_id = ? AND clan_id = ?", (str(user_id), clan_id))
    result = cursor.fetchone()
    conn.close()
    return result and result[0] == 1


def get_user_clan_id(user_id):
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT clan_id FROM clan_members WHERE user_id = ?", (str(user_id),))
    result = cursor.fetchone()
    conn.close()
    return result[0] if result else None


def get_clan_info(clan_id):
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT name, owner_id FROM clans WHERE clan_id = ?", (clan_id,))
    result = cursor.fetchone()
    conn.close()
    if result:
        return {'name': result[0], 'owner_id': result[1]}
    return None


def remove_user_from_clan(user_id):
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("DELETE FROM clan_members WHERE user_id = ?", (str(user_id),))
    conn.commit()
    conn.close()


def delete_clan(clan_id):
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    # –£–¥–∞–ª–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
    cursor.execute("DELETE FROM clan_members WHERE clan_id = ?", (clan_id,))
    # –£–¥–∞–ª–∏—Ç—å —Å–∞–º –∫–ª–∞–Ω
    cursor.execute("DELETE FROM clans WHERE clan_id = ?", (clan_id,))
    conn.commit()
    conn.close()


def generate_unique_clan_id():
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT clan_id FROM clans")
    existing_ids = set(row[0] for row in cursor.fetchall())
    conn.close()

    while True:
        new_id = random.randint(10000, 99999)
        if new_id not in existing_ids:
            return new_id


def add_user_to_clan(user_id: int, clan_id: int):
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –ª—é–±–æ–º –∫–ª–∞–Ω–µ
    cursor.execute("SELECT clan_id FROM clan_members WHERE user_id = ?", (str(user_id),))
    if cursor.fetchone() is not None:
        conn.close()
        return False  # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –≤ –∫–ª–∞–Ω–µ

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –≤ —ç—Ç–æ–º –∫–ª–∞–Ω–µ (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
    cursor.execute("SELECT * FROM clan_members WHERE user_id = ? AND clan_id = ?", (str(user_id), clan_id))
    if cursor.fetchone() is not None:
        conn.close()
        return False  # –£–∂–µ –µ—Å—Ç—å –≤ —ç—Ç–æ–º –∫–ª–∞–Ω–µ

    # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∫–ª–∞–Ω (is_owner = 0, —Ç.–∫. –¥–æ–±–∞–≤–ª—è–µ–º—ã–π –Ω–µ –≤–ª–∞–¥–µ–ª–µ—Ü)
    cursor.execute("INSERT INTO clan_members (user_id, clan_id, is_owner) VALUES (?, ?, 0)", (str(user_id), clan_id))
    conn.commit()
    conn.close()
    return True


async def makeclan(update: Update, context: ContextTypes.DEFAULT_TYPE, args):
    user_id = update.effective_user.id
    clan_name = ' '.join(args).strip()

    if not clan_name:
        await update.message.reply_text("‚ùó –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–ª–∞–Ω–∞:\n–ö–ª–∞–Ω —Å–æ–∑–¥–∞—Ç—å {–Ω–∞–∑–≤–∞–Ω–∏–µ}")
        return

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —Å–æ—Å—Ç–æ–∏—Ç –≤ –¥—Ä—É–≥–æ–º –∫–ª–∞–Ω–µ
    if get_user_clan_id(user_id) is not None:
        await update.message.reply_text("‚ùå –í—ã —É–∂–µ —Å–æ—Å—Ç–æ–∏—Ç–µ –≤ –∫–ª–∞–Ω–µ –∏–ª–∏ –≤–ª–∞–¥–µ–µ—Ç–µ –∏–º.")
        return

    clan_name_lower = clan_name.lower()

    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –ø–æ –Ω–∏–∂–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É
    cursor.execute("SELECT 1 FROM clans WHERE LOWER(name) = ?", (clan_name_lower,))
    if cursor.fetchone():
        await update.message.reply_text("‚ùå –ö–ª–∞–Ω —Å —Ç–∞–∫–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç. –í—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ.")
        conn.close()
        return

    clan_id = generate_unique_clan_id()
    created_date = date.today().isoformat()

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–ª–∞–Ω–∞ –∏–º–µ–Ω–Ω–æ —Ç–∞–∫, –∫–∞–∫ –≤–≤—ë–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    cursor.execute("""
        INSERT INTO clans (clan_id, name, owner_id, created_at, is_verified, is_private, sale_price)
        VALUES (?, ?, ?, ?, ?, ?, ?)
    """, (clan_id, clan_name, str(user_id), created_date, 0, 0, 0))

    cursor.execute("""
        INSERT INTO clan_members (user_id, clan_id, is_owner, can_invite)
        VALUES (?, ?, ?, ?)
    """, (str(user_id), clan_id, 1, 1))

    conn.commit()
    conn.close()

    await update.message.reply_html(
        f"üè∞ <b>–ö–ª–∞–Ω —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!</b>\n\n"
        f"üìõ <b>–ù–∞–∑–≤–∞–Ω–∏–µ:</b> <i>{clan_name}</i>\n"
        f"üÜî <b>ID –∫–ª–∞–Ω–∞:</b> <code>{clan_id}</code>\n"
        f"üëë <b>–í–ª–∞–¥–µ–ª–µ—Ü:</b> <a href='tg://user?id={user_id}'>–ü—Ä–æ—Ñ–∏–ª—å</a>\n\n"
        f"üéâ <b>–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!</b> –í—ã —Ç–µ–ø–µ—Ä—å –≤–ª–∞–¥–µ–ª–µ—Ü —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∫–ª–∞–Ω–∞!"
    )


async def delclan(update: Update, context: ContextTypes.DEFAULT_TYPE):
    global delclan_allowed_user
    user_id = update.effective_user.id
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT clan_id FROM clan_members WHERE user_id = ?", (str(user_id),))
    result = cursor.fetchone()
    if not result:
        await update.message.reply_text("‚ùå –í—ã –Ω–µ —Å–æ—Å—Ç–æ–∏—Ç–µ –≤ –∫–ª–∞–Ω–µ.")
        conn.close()
        return
    clan_id = result[0]
    cursor.execute("SELECT is_owner FROM clan_members WHERE user_id = ? AND clan_id = ?", (str(user_id), clan_id))
    owner_check = cursor.fetchone()
    if not owner_check or owner_check[0] != 1:
        await update.message.reply_text("‚ùå –¢–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü –º–æ–∂–µ—Ç —É–¥–∞–ª–∏—Ç—å –∫–ª–∞–Ω.")
        conn.close()
        return
    conn.close()

    delclan_allowed_user = user_id
    keyboard = [
        [
            InlineKeyboardButton("–£–¥–∞–ª–∏—Ç—å", callback_data=f"delclan_confirm_{user_id}"),
            InlineKeyboardButton("–û—Ç–º–µ–Ω–∏—Ç—å", callback_data=f"delclan_cancel_{user_id}"),
        ]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    await update.message.reply_text("–í—ã —Ç–æ—á–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∫–ª–∞–Ω?", reply_markup=reply_markup)


async def delclan_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    user_id = query.from_user.id
    data = query.data

    if data.startswith("delclan_confirm_") or data.startswith("delclan_cancel_"):
        allowed_user_id = int(data.split("_")[-1])
        if user_id != allowed_user_id:
            await query.answer("‚ùå –í–∞–º –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–æ —ç—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ", show_alert=True)
            return

        if data.startswith("delclan_confirm_"):
            conn = sqlite3.connect(DB_PATH)
            cursor = conn.cursor()
            cursor.execute("SELECT clan_id FROM clan_members WHERE user_id = ?", (str(user_id),))
            result = cursor.fetchone()
            if not result:
                await query.edit_message_text("‚ùå –ö–ª–∞–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω.")
                conn.close()
                return
            clan_id = result[0]
            cursor.execute("DELETE FROM clan_members WHERE clan_id = ?", (clan_id,))
            cursor.execute("DELETE FROM clans WHERE clan_id = ?", (clan_id,))
            conn.commit()
            conn.close()
            await query.edit_message_text("‚úÖ –ö–ª–∞–Ω —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª—ë–Ω.")
        else:
            await query.edit_message_text("‚ùå –£–¥–∞–ª–µ–Ω–∏–µ –∫–ª–∞–Ω–∞ –æ—Ç–º–µ–Ω–µ–Ω–æ.")


async def nclan(update: Update, context: ContextTypes.DEFAULT_TYPE, args):
    user_id = str(update.effective_user.id)
    new_name = ' '.join(args).strip()

    if not new_name:
        await update.message.reply_text("‚ùó –í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ:\n–ö–ª–∞–Ω –Ω–∞–∑–≤–∞–Ω–∏–µ {–Ω–∞–∑–≤–∞–Ω–∏–µ}")
        return

    clan_id = get_user_clan_id(user_id)
    if not clan_id:
        await update.message.reply_text("‚ùå –í—ã –Ω–µ —Å–æ—Å—Ç–æ–∏—Ç–µ –≤ –∫–ª–∞–Ω–µ.")
        return

    if not is_clan_owner(user_id, clan_id):
        await update.message.reply_text("‚ùå –¢–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü –º–æ–∂–µ—Ç –∏–∑–º–µ–Ω–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–ª–∞–Ω–∞.")
        return

    new_name_lower = new_name.lower()

    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –Ω–æ–≤–æ–≥–æ –Ω–∞–∑–≤–∞–Ω–∏—è –±–µ–∑ —É—á—ë—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞
    cursor.execute("SELECT 1 FROM clans WHERE LOWER(name) = ?", (new_name_lower,))
    if cursor.fetchone():
        await update.message.reply_text("‚ùå –ö–ª–∞–Ω —Å —Ç–∞–∫–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.")
        conn.close()
        return

    cursor.execute("UPDATE clans SET name = ? WHERE clan_id = ?", (new_name, clan_id))
    conn.commit()
    conn.close()

    await update.message.reply_text("‚úÖ –ù–∞–∑–≤–∞–Ω–∏–µ –∫–ª–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω–æ.")


async def clans(update: Update, context: ContextTypes.DEFAULT_TYPE):
    page = int(context.args[0]) if context.args else 1

    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT clan_id, name, is_verified FROM clans")
    rows = cursor.fetchall()
    conn.close()

    data = {}
    for row in rows:
        clan_id, name, is_verified = row
        data[clan_id] = {
            'name': name,
            'verified': bool(is_verified)
        }

    clans_list = list(data.items())
    start = (page - 1) * 10
    end = start + 10
    buttons = []
    for cid, clan in clans_list[start:end]:
        emoji = '‚úÖ' if clan['verified'] else '‚ùå'
        buttons.append([InlineKeyboardButton(f"{emoji} {clan['name']}", callback_data=f"clan_info_{cid}")])

    nav = []
    if start > 0:
        nav.append(InlineKeyboardButton("‚¨ÖÔ∏è", callback_data=f"clans_{page - 1}"))
    if end < len(clans_list):
        nav.append(InlineKeyboardButton("‚û°Ô∏è", callback_data=f"clans_{page + 1}"))
    if nav:
        buttons.append(nav)

    text = (
        "üõ°Ô∏è <b>–ö–ª–∞–Ω—ã | –°–ø–∏—Å–æ–∫</b>\n\n"
        f"üìã –í—Å–µ–≥–æ –∫–ª–∞–Ω–æ–≤: <b>{len(data)}</b>\n"
        f"‚úÖ –í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö: <b>{sum(1 for c in data.values() if c['verified'])}</b>"
    )

    if update.message:
        await update.message.reply_text(
            text,
            reply_markup=InlineKeyboardMarkup(buttons),
            parse_mode='HTML'  # –≠—Ç–æ –∫–ª—é—á–µ–≤–æ–π –ø–∞—Ä–∞–º–µ—Ç—Ä!
        )
    elif update.callback_query:
        await update.callback_query.edit_message_text(
            text,
            reply_markup=InlineKeyboardMarkup(buttons),
            parse_mode='HTML'  # –ò –∑–¥–µ—Å—å —Ç–æ–∂–µ
        )


async def clan_info_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()  # –ß—Ç–æ–±—ã —É–±—Ä–∞—Ç—å "—á–∞—Å–∏–∫–∏" –≤ Telegram

    data = query.data  # —Ñ–æ—Ä–º–∞—Ç "clan_info_<clan_id>"
    clan_id = data.split("_")[-1]

    # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–ª–∞–Ω–µ –∏–∑ –±–∞–∑—ã
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT name, is_verified, owner_id FROM clans WHERE clan_id = ?", (clan_id,))
    row = cursor.fetchone()

    if not row:
        conn.close()
        await query.edit_message_text("‚ùó –ö–ª–∞–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω.")
        return

    name, is_verified, owner_id = row

    # –ü–æ–ª—É—á–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∫–ª–∞–Ω–∞
    cursor.execute("SELECT COUNT(*) FROM clan_members WHERE clan_id = ?", (clan_id,))
    members_count = cursor.fetchone()[0]

    conn.close()

    verified = "‚úÖ" if is_verified else "‚ùå"

    text = (
        f"üè∑ <b>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∞–Ω–µ</b>\n"
        f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
        f"üåü <b>–ù–∞–∑–≤–∞–Ω–∏–µ:</b> <i>{name}</i>\n"
        f"üÜî <b>ID –ö–ª–∞–Ω–∞:</b> <code>{clan_id}</code>\n\n"
        f"üëë <b>–í–ª–∞–¥–µ–ª–µ—Ü:</b> <a href='tg://user?id={owner_id}'>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</a>\n"
        f"üë• <b>–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤:</b> {members_count}\n"
        f"üìú <b>–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è:</b> {verified}\n"
        f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
    )

    buttons = [
        [
            InlineKeyboardButton("‚úÖ –í—Å—Ç—É–ø–∏—Ç—å", callback_data=f"join_clan_{clan_id}"),
            InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="clans_1"),
        ]
    ]

    await query.edit_message_text(text, reply_markup=InlineKeyboardMarkup(buttons), parse_mode="HTML")


async def join_clan_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    data = query.data  # —Ñ–æ—Ä–º–∞—Ç: join_clan_<clan_id>
    clan_id = data.split("_")[-1]
    user_id = query.from_user.id

    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    # –ü—Ä–æ–≤–µ—Ä–∫–∞, —Å–æ—Å—Ç–æ–∏—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –≤ –∫–ª–∞–Ω–µ
    cursor.execute("SELECT clan_id FROM clan_members WHERE user_id = ?", (str(user_id),))
    user_clan = cursor.fetchone()
    if user_clan:
        await query.edit_message_text("‚ùå –í—ã —É–∂–µ —Å–æ—Å—Ç–æ–∏—Ç–µ –≤ –¥—Ä—É–≥–æ–º –∫–ª–∞–Ω–µ –∏ –Ω–µ –º–æ–∂–µ—Ç–µ –≤—Å—Ç—É–ø–∏—Ç—å –≤ —ç—Ç–æ—Ç.")
        conn.close()
        return

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏ –∫–ª–∞–Ω–∞
    cursor.execute("SELECT is_private, name FROM clans WHERE clan_id = ?", (clan_id,))
    clan_data = cursor.fetchone()
    if not clan_data:
        await query.edit_message_text("‚ùó –ö–ª–∞–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω.")
        conn.close()
        return

    is_private, clan_name = clan_data
    if is_private:
        await query.edit_message_text("‚ùå –≠—Ç–æ—Ç –∫–ª–∞–Ω –ø—Ä–∏–≤–∞—Ç–Ω—ã–π. –í—ã –Ω–µ –º–æ–∂–µ—Ç–µ –≤ –Ω–µ–≥–æ –≤—Å—Ç—É–ø–∏—Ç—å –±–µ–∑ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è.")
        conn.close()
        return

    # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∫–ª–∞–Ω
    cursor.execute("""
        INSERT INTO clan_members (user_id, clan_id, is_owner, can_invite)
        VALUES (?, ?, 0, 0)
    """, (str(user_id), clan_id))
    conn.commit()
    conn.close()

    await query.edit_message_text(f"‚úÖ –í—ã —É—Å–ø–µ—à–Ω–æ –≤—Å—Ç—É–ø–∏–ª–∏ –≤ –∫–ª–∞–Ω '{clan_name}'!")


async def mclan(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id_str = str(update.effective_user.id)

    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    cursor.execute("""
        SELECT clans.clan_id, clans.name, clans.owner_id, clans.created_at, clans.is_verified, clans.is_private,
               users.username, users.first_name
        FROM clans
        JOIN clan_members ON clans.clan_id = clan_members.clan_id
        LEFT JOIN users ON clans.owner_id = users.user_id
        WHERE clan_members.user_id = ?
    """, (user_id_str,))
    clan = cursor.fetchone()

    if not clan:
        await update.message.reply_text("‚ùå –í—ã –Ω–µ —Å–æ—Å—Ç–æ–∏—Ç–µ –≤ –∫–ª–∞–Ω–µ.")
        conn.close()
        return

    clan_id, name, owner_id, created_at, is_verified, is_private, owner_username, owner_first_name = clan

    cursor.execute("SELECT COUNT(*) FROM clan_members WHERE clan_id = ?", (clan_id,))
    members_count = cursor.fetchone()[0]

    conn.close()

    owner_name = owner_first_name or owner_username or f"ID {owner_id}"
    owner_display = f'<a href="tg://user?id={owner_id}">{owner_name}</a>'
    status_text = "üîì –ü—É–±–ª–∏—á–Ω—ã–π" if is_private == 0 else "üîí –ü—Ä–∏–≤–∞—Ç–Ω—ã–π"

    text = (
        f"üè∑ <b>–ú–æ–π –∫–ª–∞–Ω | –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</b>\n\n"
        f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
        f"üÜî <b>ID –∫–ª–∞–Ω–∞:</b> <code>{clan_id}</code>\n"
        f"üìõ <b>–ù–∞–∑–≤–∞–Ω–∏–µ:</b> <i>{name}</i>\n"
        f"üëë <b>–í–ª–∞–¥–µ–ª–µ—Ü:</b> {owner_display}\n"
        f"üìÖ <b>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:</b> {created_at}\n"
        f"üë• <b>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤:</b> {members_count}\n"
        f"üåê <b>–°—Ç–∞—Ç—É—Å:</b> {status_text}\n"
        f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
        f"‚ùáÔ∏è <b>–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è:</b> {'‚úÖ' if is_verified else '‚ùå'}\n"
        f"<pre>–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –∫–ª–∞–Ω –±—ã–ª –ø—Ä–æ–≤–µ—Ä–µ–Ω –∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–µ–π.</pre>"
    )

    buttons = []
    buttons.append([InlineKeyboardButton("üë• –°–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤", callback_data=f"clan_members_{clan_id}_page_1")])
    buttons.append([InlineKeyboardButton("üö™ –ü–æ–∫–∏–Ω—É—Ç—å –∫–ª–∞–Ω", callback_data=f"uninvitec_{clan_id}")])
    buttons.append([InlineKeyboardButton("‚úÖ –í—Å—Ç—É–ø–∏—Ç—å –≤ –∫–ª–∞–Ω", callback_data=f"join_clan_{clan_id}")])
    reply_markup = InlineKeyboardMarkup(buttons)

    await update.message.reply_text(text, parse_mode='HTML', reply_markup=reply_markup)


async def uninvite_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    clan_id = query.data.split("_")[-1]
    user_id = query.from_user.id

    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –∫–ª–∞–Ω–µ
    cursor.execute("SELECT is_owner FROM clan_members WHERE clan_id = ? AND user_id = ?", (clan_id, user_id))
    row = cursor.fetchone()
    if row is None:
        await query.edit_message_text("‚ùå –í—ã –Ω–µ —Å–æ—Å—Ç–æ–∏—Ç–µ –≤ —ç—Ç–æ–º –∫–ª–∞–Ω–µ.")
        conn.close()
        return

    is_owner = row[0]

    if is_owner:
        await query.answer("‚õî –í–ª–∞–¥–µ–ª—å—Ü—É –∫–ª–∞–Ω–∞ –Ω–µ–ª—å–∑—è –ø–æ–∫–∏–¥–∞—Ç—å –∫–ª–∞–Ω —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É. \n–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É –ö–ª–∞–Ω –ø–æ–∫–∏–Ω—É—Ç—å.",
                           show_alert=True)
        conn.close()
        return

    # –£–¥–∞–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –∫–ª–∞–Ω–∞
    cursor.execute("DELETE FROM clan_members WHERE clan_id = ? AND user_id = ?", (clan_id, user_id))
    conn.commit()
    conn.close()

    await query.edit_message_text("‚úÖ –í—ã –ø–æ–∫–∏–Ω—É–ª–∏ –∫–ª–∞–Ω.")


async def mclan_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    data = query.data  # —Ñ–æ—Ä–º–∞—Ç: mclan_<clan_id>
    clan_id_str = data.split("_")[1]
    try:
        clan_id = int(clan_id_str)
    except ValueError:
        await query.edit_message_text("‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π ID –∫–ª–∞–Ω–∞.")
        return

    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    cursor.execute("""
        SELECT clans.clan_id, clans.name, clans.owner_id, clans.created_at, clans.is_verified, clans.is_private,
               users.username, users.first_name
        FROM clans
        LEFT JOIN users ON clans.owner_id = users.user_id
        WHERE clans.clan_id = ?
    """, (clan_id,))
    clan = cursor.fetchone()

    if not clan:
        await query.edit_message_text("‚ùå –ö–ª–∞–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω.")
        conn.close()
        return

    clan_id, name, owner_id, created_at, is_verified, is_private, owner_username, owner_first_name = clan

    cursor.execute("SELECT COUNT(*) FROM clan_members WHERE clan_id = ?", (clan_id,))
    members_count = cursor.fetchone()[0]
    conn.close()

    owner_name = owner_first_name or owner_username or f"ID {owner_id}"
    owner_display = f'<a href="tg://user?id={owner_id}">{owner_name}</a>'
    status_text = "üîì –ü—É–±–ª–∏—á–Ω—ã–π" if is_private == 0 else "üîí –ü—Ä–∏–≤–∞—Ç–Ω—ã–π"

    text = (
        f"üè∑ <b>–ú–æ–π –∫–ª–∞–Ω | –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</b>\n\n"
        f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
        f"üÜî <b>ID –∫–ª–∞–Ω–∞:</b> <code>{clan_id}</code>\n"
        f"üìõ <b>–ù–∞–∑–≤–∞–Ω–∏–µ:</b> <i>{name}</i>\n"
        f"üëë <b>–í–ª–∞–¥–µ–ª–µ—Ü:</b> {owner_display}\n"
        f"üìÖ <b>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:</b> {created_at}\n"
        f"üë• <b>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤:</b> {members_count}\n"
        f"üåê <b>–°—Ç–∞—Ç—É—Å:</b> {status_text}\n"
        f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
        f"‚ùáÔ∏è <b>–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è:</b> {'‚úÖ' if is_verified else '‚ùå'}\n"
        f"<pre>–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –∫–ª–∞–Ω –±—ã–ª –ø—Ä–æ–≤–µ—Ä–µ–Ω –∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–µ–π.</pre>"
    )

    buttons = []
    buttons.append([InlineKeyboardButton("üë• –°–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤", callback_data=f"clan_members_{clan_id}_page_1")])
    buttons.append([InlineKeyboardButton("üö™ –ü–æ–∫–∏–Ω—É—Ç—å –∫–ª–∞–Ω", callback_data=f"uninvitec_{clan_id}")])
    buttons.append([InlineKeyboardButton("‚úÖ –í—Å—Ç—É–ø–∏—Ç—å –≤ –∫–ª–∞–Ω", callback_data=f"join_clan_{clan_id}")])
    reply_markup = InlineKeyboardMarkup(buttons)

    await query.edit_message_text(text, parse_mode='HTML', reply_markup=reply_markup)


async def clan_members_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    data = query.data
    parts = data.split("_")
    clan_id = parts[2]
    page = int(parts[4])

    items_per_page = 10
    offset = (page - 1) * items_per_page

    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    cursor.execute("SELECT name FROM clans WHERE clan_id = ?", (clan_id,))
    clan_name_row = cursor.fetchone()
    if not clan_name_row:
        await query.edit_message_text("‚ùó <b>–ö–ª–∞–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω.</b>", parse_mode='HTML')
        conn.close()
        return
    clan_name = clan_name_row[0]

    cursor.execute("SELECT COUNT(*) FROM clan_members WHERE clan_id = ?", (clan_id,))
    total_members = cursor.fetchone()[0]

    cursor.execute("""
        SELECT user_id, is_owner FROM clan_members 
        WHERE clan_id = ? 
        ORDER BY is_owner DESC, user_id ASC 
        LIMIT ? OFFSET ?
    """, (clan_id, items_per_page, offset))
    members = cursor.fetchall()

    text = (
        f"üè∑ <b>–ö–ª–∞–Ω | –°–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</b>\n"
        f"üìõ –ù–∞–∑–≤–∞–Ω–∏–µ: <i>{clan_name}</i>\n"
        f"üë• –£—á–∞—Å—Ç–Ω–∏–∫–æ–≤: {total_members}\n"
        f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n"
    )

    if not members:
        text += "–í —ç—Ç–æ–º —Ä–∞–∑–¥–µ–ª–µ –Ω–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤."
    else:
        for idx, (user_id, is_owner) in enumerate(members, start=offset + 1):
            status = "üëë –í–ª–∞–¥–µ–ª–µ—Ü" if is_owner else "üë§ –£—á–∞—Å—Ç–Ω–∏–∫"

            # –ü–æ–ª—É—á–∞–µ–º –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Ç–∞–±–ª–∏—Ü—ã users
            cursor.execute("SELECT username, first_name FROM users WHERE user_id = ?", (user_id,))
            user_data = cursor.fetchone()
            if user_data:
                username, first_name = user_data
                display_name = username or first_name or f"ID {user_id}"
            else:
                display_name = f"ID {user_id}"

            user_link = f'<a href="tg://user?id={user_id}">{display_name}</a>'

            text += (
                f"<b>{idx}. {status}</b>\n"
                f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {user_link}\n"
                f"ID: <code>{user_id}</code>\n\n"
            )

    conn.close()

    buttons = []

    # –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º
    nav_buttons = []
    if page > 1:
        nav_buttons.append(
            InlineKeyboardButton("‚èÆ –ü—Ä–æ—à–ª–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞", callback_data=f"clan_members_{clan_id}_page_{page - 1}"))
    if offset + items_per_page < total_members:
        nav_buttons.append(
            InlineKeyboardButton("–°–ª–µ–¥—É—é—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ ‚è≠", callback_data=f"clan_members_{clan_id}_page_{page + 1}"))

    if nav_buttons:
        buttons.append(nav_buttons)

    # –ö–Ω–æ–ø–∫–∞ –Ω–∞–∑–∞–¥
    buttons.append([InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data=f"mclan_{clan_id}")])

    reply_markup = InlineKeyboardMarkup(buttons)

    await query.edit_message_text(text, parse_mode='HTML', reply_markup=reply_markup)


async def transferclan(update, context, args):
    user_id = update.effective_user.id

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –∞—Ä–≥—É–º–µ–Ω—Ç–∞ (–∫–æ–º—É –ø–µ—Ä–µ–¥–∞—Ç—å)
    if len(args) < 1:
        await update.message.reply_text("‚ùó –£–∫–∞–∂–∏—Ç–µ Telegram ID –Ω–æ–≤–æ–≥–æ –≤–ª–∞–¥–µ–ª—å—Ü–∞: \n–ö–ª–∞–Ω –ø–µ—Ä–µ–¥–∞—Ç—å <TelegramID>")
        return

    new_owner_id = args[0]

    # –ü–æ–ª—É—á–∞–µ–º ID –∫–ª–∞–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    clan_id = get_user_clan_id(user_id)
    if not clan_id:
        await update.message.reply_text("‚ùó –í—ã –Ω–µ —Å–æ—Å—Ç–æ–∏—Ç–µ –≤ –∫–ª–∞–Ω–µ.")
        return

    # –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Äî –≤–ª–∞–¥–µ–ª–µ—Ü
    if not is_clan_owner(user_id, clan_id):
        await update.message.reply_text("‚ùó –¢–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü –∫–ª–∞–Ω–∞ –º–æ–∂–µ—Ç –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å –µ–≥–æ.")
        return

    # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–ª–∞–Ω–µ
    clan_info = get_clan_info(clan_id)
    if not clan_info:
        await update.message.reply_text("‚ùó –ö–ª–∞–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω.")
        return

    clan_name = clan_info['name']
    owner_id = clan_info['owner_id']

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º
    keyboard = InlineKeyboardMarkup([
        [
            InlineKeyboardButton("‚úÖ –ü–µ—Ä–µ–¥–∞—Ç—å", callback_data=f"confirm_transfer:{clan_id}:{new_owner_id}:{user_id}"),
            InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data=f"cancel_transfer:{user_id}")
        ]
    ])

    try:
        new_owner_id_int = int(new_owner_id)
        new_owner = await context.bot.get_chat(new_owner_id_int)
        new_owner_name = new_owner.full_name
    except Exception:
        new_owner_name = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"

    try:
        owner = await context.bot.get_chat(owner_id)
        owner_name = owner.full_name
    except Exception:
        owner_name = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"

    text = (
        f"üè∑ <b>–ö–ª–∞–Ω | –ü–µ—Ä–µ–¥–∞—á–∞</b>\n"
        f"üÜî <b>ID –ö–ª–∞–Ω–∞:</b> {clan_id}\n"
        f"üìõ <b>–ù–∞–∑–≤–∞–Ω–∏–µ –∫–ª–∞–Ω–∞:</b> {clan_name}\n"
        f"üëë <b>–í–ª–∞–¥–µ–ª–µ—Ü:</b> <a href='tg://user?id={owner_id}'>{owner_name}</a>\n"
        f"üë§ <b>–ö–æ–º—É –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è:</b> <a href='tg://user?id={new_owner_id}'>{new_owner_name}</a>"
    )
    await update.message.reply_html(text, reply_markup=keyboard)


async def handle_clan_transfer_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    data = query.data
    user_id = query.from_user.id

    if data.startswith("confirm_transfer"):
        _, clan_id, new_owner_id, old_owner_id = data.split(":")
        clan_id = int(clan_id)
        new_owner_id = int(new_owner_id)
        old_owner_id = int(old_owner_id)

        # ‚õî –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –Ω–∞–∂–∏–º–∞–µ—Ç —Ç–µ–∫—É—â–∏–π –≤–ª–∞–¥–µ–ª–µ—Ü –∫–ª–∞–Ω–∞
        if user_id != old_owner_id:
            await query.answer("‚ùå –¢–æ–ª—å–∫–æ —Ç–µ–∫—É—â–∏–π –≤–ª–∞–¥–µ–ª–µ—Ü –∫–ª–∞–Ω–∞ –º–æ–∂–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø–µ—Ä–µ–¥–∞—á—É.", show_alert=True)
            return

        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()

        # –ü—Ä–æ–≤–µ—Ä–∫–∞, —Å–æ—Å—Ç–æ–∏—Ç –ª–∏ –Ω–æ–≤—ã–π –≤–ª–∞–¥–µ–ª–µ—Ü –≤ —ç—Ç–æ–º –∫–ª–∞–Ω–µ
        cursor.execute("SELECT 1 FROM clan_members WHERE user_id = ? AND clan_id = ?", (new_owner_id, clan_id))
        if not cursor.fetchone():
            await query.edit_message_text("‚ùå –ù–æ–≤—ã–π –≤–ª–∞–¥–µ–ª–µ—Ü –Ω–µ —Å–æ—Å—Ç–æ–∏—Ç –≤ —ç—Ç–æ–º –∫–ª–∞–Ω–µ.")
            conn.close()
            return

        # –û–±–Ω–æ–≤–ª–µ–Ω–∏—è
        cursor.execute("UPDATE clan_members SET is_owner = 0 WHERE user_id = ? AND clan_id = ?",
                       (old_owner_id, clan_id))
        cursor.execute("UPDATE clan_members SET is_owner = 1 WHERE user_id = ? AND clan_id = ?",
                       (new_owner_id, clan_id))
        cursor.execute("UPDATE clans SET owner_id = ? WHERE clan_id = ?", (new_owner_id, clan_id))

        conn.commit()
        conn.close()

        await query.edit_message_text("‚úÖ –ö–ª–∞–Ω —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–¥–∞–Ω –Ω–æ–≤–æ–º—É –≤–ª–∞–¥–µ–ª—å—Ü—É.")

    elif data.startswith("cancel_transfer"):
        _, expected_user_id = data.split(":")
        expected_user_id = int(expected_user_id)

        # ‚õî –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –Ω–∞–∂–∏–º–∞–µ—Ç —Ç–æ—Ç, –∫—Ç–æ –Ω–∞—á–∞–ª –æ—Ç–º–µ–Ω—É
        if user_id != expected_user_id:
            await query.answer("‚ùå –¢–æ–ª—å–∫–æ —Ç–µ–∫—É—â–∏–π –≤–ª–∞–¥–µ–ª–µ—Ü –∫–ª–∞–Ω–∞ –º–æ–∂–µ—Ç –æ—Ç–º–µ–Ω–∏—Ç—å –ø–µ—Ä–µ–¥–∞—á—É –∫–ª–∞–Ω–∞.", show_alert=True)
            return

        await query.edit_message_text("‚ùå –ü–µ—Ä–µ–¥–∞—á–∞ –∫–ª–∞–Ω–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞.")


async def kickclan(update: Update, context: ContextTypes.DEFAULT_TYPE, args):
    user_id = update.effective_user.id

    if len(args) < 1:
        await update.message.reply_text("–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: –ö–ª–∞–Ω –≤—ã–≥–Ω–∞—Ç—å {id} [–ø—Ä–∏—á–∏–Ω–∞]")
        return

    try:
        target_id = int(args[0])
    except ValueError:
        await update.message.reply_text("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.")
        return

    if target_id == user_id:
        await update.message.reply_text("‚ùå –ù–µ–ª—å–∑—è –∫–∏–∫–Ω—É—Ç—å —Å–µ–±—è.")
        return

    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - –≤–ª–∞–¥–µ–ª–µ—Ü –∫–ª–∞–Ω–∞ –∏ –ø–æ–ª—É—á–∞–µ–º clan_id
    cursor.execute("""
        SELECT clans.clan_id FROM clans
        JOIN clan_members ON clans.clan_id = clan_members.clan_id
        WHERE clan_members.user_id = ? AND clan_members.is_owner = 1
    """, (str(user_id),))
    result = cursor.fetchone()
    if not result:
        await update.message.reply_text("‚ùå –í—ã –Ω–µ –≤–ª–∞–¥–µ–ª–µ—Ü –∫–ª–∞–Ω–∞.")
        conn.close()
        return

    clan_id = result[0]

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ target_id –≤ —ç—Ç–æ–º –∫–ª–∞–Ω–µ
    cursor.execute("""
        SELECT is_owner FROM clan_members WHERE user_id = ? AND clan_id = ?
    """, (str(target_id), clan_id))
    member = cursor.fetchone()
    if not member:
        await update.message.reply_text("‚ùå –≠—Ç–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤ –∫–ª–∞–Ω–µ.")
        conn.close()
        return

    is_owner_flag = member[0]
    if is_owner_flag == 1:
        await update.message.reply_text("‚ùå –ù–µ–ª—å–∑—è –∫–∏–∫–Ω—É—Ç—å –≤–ª–∞–¥–µ–ª—å—Ü–∞.")
        conn.close()
        return

    # –£–¥–∞–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ clan_members
    cursor.execute("""
        DELETE FROM clan_members WHERE user_id = ? AND clan_id = ?
    """, (str(target_id), clan_id))

    conn.commit()
    conn.close()

    user_link = f'<a href="tg://user?id={target_id}">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</a>'
    await update.message.reply_text(f"‚úÖ {user_link} –∫–∏–∫–Ω—É—Ç.", parse_mode='HTML')


async def sclan(update: Update, context: ContextTypes.DEFAULT_TYPE, args):
    user_id = update.effective_user.id

    if len(args) != 1 or args[0] not in ['1', '2']:
        await update.message.reply_text("–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: –ö–ª–∞–Ω —Å—Ç–∞—Ç—É—Å {1/2}\n1 - public\n2 - private")
        return

    is_private = 0 if args[0] == '1' else 1

    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    # –ù–∞–π–¥–µ–º –∫–ª–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –≥–¥–µ –æ–Ω –≤–ª–∞–¥–µ–ª–µ—Ü
    cursor.execute("""
        SELECT clans.clan_id FROM clans
        JOIN clan_members ON clans.clan_id = clan_members.clan_id
        WHERE clan_members.user_id = ? AND clan_members.is_owner = 1
    """, (str(user_id),))
    result = cursor.fetchone()
    if not result:
        await update.message.reply_text("‚ùå –í—ã –Ω–µ –≤–ª–∞–¥–µ–ª–µ—Ü –∫–ª–∞–Ω–∞.")
        conn.close()
        return

    clan_id = result[0]

    # –û–±–Ω–æ–≤–∏–º —Ç–∏–ø –∫–ª–∞–Ω–∞
    cursor.execute("""
        UPDATE clans SET is_private = ? WHERE clan_id = ?
    """, (is_private, clan_id))

    conn.commit()
    conn.close()

    clan_type_str = "private" if is_private else "public"
    await update.message.reply_text(f"‚úÖ –°—Ç–∞—Ç—É—Å –∫–ª–∞–Ω–∞ –∏–∑–º–µ–Ω—ë–Ω –Ω–∞ {clan_type_str}.")


async def verclan(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = str(update.effective_user.id)

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤
    if len(context.args) != 2:
        await update.message.reply_text(
            "‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /verclan {clan_id} {1/2}\n1 - —Å–Ω—è—Ç—å –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é\n2 - –≤—ã–¥–∞—Ç—å –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é")
        return

    try:
        clan_id = int(context.args[0])
        action = int(context.args[1])
    except ValueError:
        await update.message.reply_text("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ ID –∏ –¥–µ–π—Å—Ç–≤–∏–µ ‚Äî —ç—Ç–æ —á–∏—Å–ª–∞.")
        return

    if action not in (1, 2):
        await update.message.reply_text("‚ùå –î–µ–π—Å—Ç–≤–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å 1 (—Å–Ω—è—Ç—å) –∏–ª–∏ 2 (–≤—ã–¥–∞—Ç—å).")
        return

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT status FROM users WHERE user_id = ?", (user_id,))
    row = cursor.fetchone()
    if not row or row[0] != 12:
        await update.message.reply_text(
            "‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã. –¢–æ–ª—å–∫–æ –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ –º–æ–∂–µ—Ç —ç—Ç–æ –¥–µ–ª–∞—Ç—å.")
        conn.close()
        return

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –∫–ª–∞–Ω–∞
    cursor.execute("SELECT name FROM clans WHERE clan_id = ?", (clan_id,))
    result = cursor.fetchone()
    if not result:
        await update.message.reply_text("‚ùå –ö–ª–∞–Ω —Å —Ç–∞–∫–∏–º ID –Ω–µ –Ω–∞–π–¥–µ–Ω.")
        conn.close()
        return

    clan_name = result[0]
    new_status = 1 if action == 2 else 0
    cursor.execute("UPDATE clans SET is_verified = ? WHERE clan_id = ?", (new_status, clan_id))
    conn.commit()
    conn.close()

    if new_status == 1:
        await update.message.reply_text(f"‚úÖ –ö–ª–∞–Ω '{clan_name}' —Ç–µ–ø–µ—Ä—å –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω.")
    else:
        await update.message.reply_text(f"‚ÑπÔ∏è –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è —Å–Ω—è—Ç–∞ —Å –∫–ª–∞–Ω–∞ '{clan_name}'.")


async def uninvitec(update: Update, context: ContextTypes.DEFAULT_TYPE, args):
    user = update.effective_user
    user_id = user.id
    clan_id = get_user_clan_id(user_id)
    if not clan_id:
        await update.message.reply_text("‚ùå –í—ã –Ω–µ —Å–æ—Å—Ç–æ–∏—Ç–µ –≤ –∫–ª–∞–Ω–µ.")
        return

    clan_info = get_clan_info(clan_id)
    if not clan_info:
        await update.message.reply_text("‚ùå –ö–ª–∞–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω.")
        return

    clan_name = clan_info["name"]
    is_owner = is_clan_owner(user_id, clan_id)

    text = (
        f"<b>üè∑ –ö–ª–∞–Ω | –í—ã—Ö–æ–¥</b>\n"
        f"üôç‚Äç‚ôÇÔ∏è <b>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</b> <a href='tg://user?id={user_id}'>{user.first_name}</a>\n"
        f"üè∞ <b>–ö–ª–∞–Ω:</b> <i>{clan_name}</i>\n"
    )

    if is_owner:
        text += (
            f"\n‚ö†Ô∏è <b>–ï—Å–ª–∏ –≤—ã –ø–æ–∫–∏–Ω–µ—Ç–µ –∫–ª–∞–Ω, –æ–Ω –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω, "
            f"–∞ –≤—Å–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏ –±—É–¥—É—Ç –∏—Å–∫–ª—é—á–µ–Ω—ã!</b>"
        )

    keyboard = InlineKeyboardMarkup([[
        InlineKeyboardButton("üö™ –í—ã–π—Ç–∏ –∏–∑ –∫–ª–∞–Ω–∞", callback_data=f"confirm_leaveclan:{user_id}:{clan_id}"),
        InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∏—Ç—å", callback_data=f"cancel_leaveclan:{user_id}")
    ]])

    await update.message.reply_html(text, reply_markup=keyboard)


async def confirm_leave_clan(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query

    data_parts = query.data.split(":")
    if len(data_parts) < 3:
        await query.answer("‚ùó –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ –∑–∞–ø—Ä–æ—Å–µ.", show_alert=True)
        return

    try:
        user_id = int(data_parts[1])
        clan_id = int(data_parts[2])
    except ValueError:
        await query.answer("‚ùó –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–Ω–µ —á–∏—Å–ª–∞).", show_alert=True)
        return

    if update.effective_user.id != user_id:
        await query.answer("‚õî –í—ã –Ω–µ –º–æ–∂–µ—Ç–µ –≤—ã–ø–æ–ª–Ω–∏—Ç—å —ç—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ.", show_alert=True)
        return

    # –¢–æ–ª—å–∫–æ —Ç–µ–ø–µ—Ä—å, –µ—Å–ª–∏ –≤—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ—à–ª–∏, –≤—ã–∑—ã–≤–∞–π query.answer() –±–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤, —á—Ç–æ–±—ã —É–±—Ä–∞—Ç—å "—á–∞—Å–∏–∫–∏"
    await query.answer()

    is_owner = is_clan_owner(user_id, clan_id)

    if is_owner:
        delete_clan(clan_id)
        await query.edit_message_text("‚ùå –í—ã –ø–æ–∫–∏–Ω—É–ª–∏ –∫–ª–∞–Ω, –æ–Ω –±—ã–ª —É–¥–∞–ª—ë–Ω –≤–º–µ—Å—Ç–µ —Å–æ –≤—Å–µ–º–∏ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏.")
    else:
        remove_user_from_clan(user_id)
        await query.edit_message_text("‚úÖ –í—ã –ø–æ–∫–∏–Ω—É–ª–∏ –∫–ª–∞–Ω.")


async def cancel_leave_clan(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    user_id = int(query.data.split(":")[1])

    if update.effective_user.id != user_id:
        await query.answer("‚õî –í—ã –Ω–µ –º–æ–∂–µ—Ç–µ –æ—Ç–º–µ–Ω–∏—Ç—å —ç—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ.", show_alert=True)
        return

    await query.answer()
    await query.edit_message_text("‚ùé –í—ã—Ö–æ–¥ –∏–∑ –∫–ª–∞–Ω–∞ –æ—Ç–º–µ–Ω—ë–Ω.")


async def invitec(update: Update, context: ContextTypes.DEFAULT_TYPE, args):
    user_id = str(update.effective_user.id)

    if len(args) != 1:
        await update.message.reply_text("–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: –ö–ª–∞–Ω –≤—Å—Ç—É–ø–∏—Ç—å {id_–∫–ª–∞–Ω–∞}")
        return

    try:
        clan_id = int(args[0])
    except ValueError:
        await update.message.reply_text("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç ID –∫–ª–∞–Ω–∞.")
        return

    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–ª–∞–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –ø—É–±–ª–∏—á–Ω—ã–π
    cursor.execute("SELECT is_private FROM clans WHERE clan_id = ?", (clan_id,))
    clan = cursor.fetchone()
    if not clan:
        await update.message.reply_text("‚ùå –ö–ª–∞–Ω —Å —Ç–∞–∫–∏–º ID –Ω–µ –Ω–∞–π–¥–µ–Ω.")
        conn.close()
        return
    is_private = clan[0]
    if is_private == 1:
        await update.message.reply_text(
            "‚ùå <b>–ù–µ —É–¥–∞–ª–æ—Å—å –≤—Å—Ç—É–ø–∏—Ç—å –≤ –∫–ª–∞–Ω.</b>\n"
            "üîí <b>–°—Ç–∞—Ç—É—Å –∫–ª–∞–Ω–∞:</b> <i>–ü—Ä–∏–≤–∞—Ç–Ω—ã–π</i>\n\n",
            parse_mode='HTML'
        )
        conn.close()
        return

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤ –¥—Ä—É–≥–æ–º –∫–ª–∞–Ω–µ
    cursor.execute("SELECT clan_id FROM clan_members WHERE user_id = ?", (user_id,))
    existing = cursor.fetchone()
    if existing:
        await update.message.reply_text("‚ùå –í—ã —É–∂–µ —Å–æ—Å—Ç–æ–∏—Ç–µ –≤ –¥—Ä—É–≥–æ–º –∫–ª–∞–Ω–µ.")
        conn.close()
        return

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤–ª–∞–¥–µ–ª–µ—Ü –¥–∞–Ω–Ω–æ–≥–æ –∫–ª–∞–Ω–∞ (—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å, –Ω–æ –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
    cursor.execute("""
        SELECT is_owner FROM clan_members WHERE user_id = ? AND clan_id = ?
    """, (user_id, clan_id))
    owner_check = cursor.fetchone()
    if owner_check and owner_check[0] == 1:
        await update.message.reply_text("‚ùå –í—ã –Ω–µ –º–æ–∂–µ—Ç–µ –≤—Å—Ç—É–ø–∏—Ç—å –≤ –∫–ª–∞–Ω, –≥–¥–µ –≤—ã –≤–ª–∞–¥–µ–ª–µ—Ü.")
        conn.close()
        return

    # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∫–ª–∞–Ω (–æ–±—ã—á–Ω—ã–π —á–ª–µ–Ω, –±–µ–∑ –ø—Ä–∞–≤ –≤–ª–∞–¥–µ–ª—å—Ü–∞ –∏ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è)
    cursor.execute("""
        INSERT INTO clan_members (user_id, clan_id, is_owner, can_invite)
        VALUES (?, ?, 0, 0)
    """, (user_id, clan_id))

    conn.commit()
    conn.close()

    await update.message.reply_text(f"‚úÖ –í—ã —É—Å–ø–µ—à–Ω–æ –≤—Å—Ç—É–ø–∏–ª–∏ –≤ –∫–ª–∞–Ω —Å ID {clan_id}.")


async def cinfo(update: Update, context: ContextTypes.DEFAULT_TYPE, args=None):
    if args is None or len(args) < 1:
        await update.message.reply_text("‚ùóÔ∏è –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É —Ç–∞–∫:\n–ö–ª–∞–Ω –∏–Ω—Ñ–æ <clan_id>")
        return

    try:
        clan_id = int(args[0])
    except ValueError:
        await update.message.reply_text("‚ùóÔ∏è ID –∫–ª–∞–Ω–∞ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º.")
        return

    msg = await update.message.reply_text("üîç –ò—â–µ–º –∫–ª–∞–Ω... "
                                          "\n–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ ‚è≥")
    await asyncio.sleep(2)

    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute(
        "SELECT name, owner_id, created_at, is_private, is_verified FROM clans WHERE clan_id = ?",
        (clan_id,)
    )
    clan_data = cursor.fetchone()
    if not clan_data:
        await msg.edit_text("‚ùå –ö–ª–∞–Ω —Å —Ç–∞–∫–∏–º ID –Ω–µ –Ω–∞–π–¥–µ–Ω.")
        conn.close()
        return

    name, owner_id, created_at, is_private, is_verified = clan_data

    cursor.execute("SELECT user_id, is_owner FROM clan_members WHERE clan_id = ?", (clan_id,))
    members_data = cursor.fetchall()
    conn.close()

    members_list = []
    for user_id, is_owner in members_data:
        try:
            user = await context.bot.get_chat(user_id)
            name_user = user.first_name
            if user.last_name:
                name_user += f" {user.last_name}"
        except Exception:
            name_user = str(user_id)
        mention = f'<a href="tg://user?id={user_id}">{name_user}</a>'
        if is_owner:
            mention += " üëë"
        members_list.append(mention)

    members_text = "\n".join(members_list) if members_list else "–ù–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤"

    public_status = "–ü—Ä–∏–≤–∞—Ç–Ω—ã–π üîí" if is_private else "–ü—É–±–ª–∏—á–Ω—ã–π ‚úÖ"
    verified_status = "‚úÖ" if is_verified else "‚ùå"

    text = (
        f"üè∞ <b>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∞–Ω–µ:</b>\n\n"
        f"üÜî <b>ID –∫–ª–∞–Ω–∞:</b> {clan_id}\n"
        f"üìõ <b>–ù–∞–∑–≤–∞–Ω–∏–µ:</b> {name}\n"
        f"üëë <b>–í–ª–∞–¥–µ–ª–µ—Ü:</b> <a href=\"tg://user?id={owner_id}\">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</a>\n"
        f"üìÖ <b>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:</b> {created_at}\n"
        f"üîì <b>–°—Ç–∞—Ç—É—Å:</b> {public_status}\n"
        f"‚ùáÔ∏è <b>–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è:</b> {verified_status}\n"
        f"<pre>–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –∫–ª–∞–Ω –±—ã–ª –ø—Ä–æ–≤–µ—Ä–µ–Ω –∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–µ–π.</pre>\n\n"
        f"üë• <b>–£—á–∞—Å—Ç–Ω–∏–∫–∏ ({len(members_list)})</b>"
    )

    await msg.edit_text(text, parse_mode="HTML")


async def addmembc(update: Update, context: ContextTypes.DEFAULT_TYPE, args):
    user = update.effective_user
    user_id = user.id

    if not args or len(args) < 1:
        await update.message.reply_text("‚ùó –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É —Ç–∞–∫:\n–ö–ª–∞–Ω –¥–æ–±–∞–≤–∏—Ç—å <TelegramID>")
        return

    try:
        target_id = int(args[0])
    except ValueError:
        await update.message.reply_text("‚ùó Telegram ID –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º.")
        return

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ Telegram
    try:
        target_user = await context.bot.get_chat(target_id)
    except Exception:
        await update.message.reply_text("‚ùó –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º Telegram ID –Ω–µ –Ω–∞–π–¥–µ–Ω.")
        return

    clan_id = get_user_clan_id(user_id)
    if not clan_id:
        await update.message.reply_text("‚ùå –í—ã –Ω–µ —Å–æ—Å—Ç–æ–∏—Ç–µ –≤ –∫–ª–∞–Ω–µ –∏ –Ω–µ –º–æ–∂–µ—Ç–µ –¥–æ–±–∞–≤–ª—è—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤.")
        return

    target_clan_id = get_user_clan_id(target_id)
    if target_clan_id == clan_id:
        await update.message.reply_text("‚ùó –≠—Ç–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Å–æ—Å—Ç–æ–∏—Ç –≤ –≤–∞—à–µ–º –∫–ª–∞–Ω–µ.")
        return
    elif target_clan_id is not None:
        await update.message.reply_text("‚ùó –≠—Ç–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Å–æ—Å—Ç–æ–∏—Ç –≤ –¥—Ä—É–≥–æ–º –∫–ª–∞–Ω–µ.")
        return

    success = add_user_to_clan(target_id, clan_id)
    if success:
        mention = f'<a href="tg://user?id={target_id}">{target_user.first_name}'
        if target_user.last_name:
            mention += f" {target_user.last_name}"
        mention += "</a>"

        text = (
            f"üéâ <b>–ü–æ–ª—É—á–∏–ª–æ—Å—å!</b>\n\n"
            f"–¢–µ–ø–µ—Ä—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {mention} –≤ –∫–ª–∞–Ω–µ"
        )
        await update.message.reply_html(text)
    else:
        await update.message.reply_text("‚ùó –ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∫–ª–∞–Ω. \n–í–æ–∑–º–æ–∂–Ω–æ, –æ–Ω —É–∂–µ –≤ –∫–ª–∞–Ω–µ.")


async def delete_userA_account(update: Update, context: ContextTypes.DEFAULT_TYPE):
    message = update.message
    admin_user = message.from_user
    admin_user_id = str(admin_user.id)

    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT status FROM users WHERE user_id = ?", (admin_user_id,))
    row = cursor.fetchone()

    if not row or row[0] < 11:
        conn.close()
        await message.reply_text("üö´ –£–ø—Å! –ü–æ—Ö–æ–∂–µ, —É –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–æ–≤.")
        return

    args = context.args
    if len(args) < 2:
        conn.close()
        await message.reply_text("‚ùå –ò—Å–ø–æ–ª—å–∑—É–π: /delac TelegramID –ü—Ä–∏—á–∏–Ω–∞")
        return

    target_user_id = args[0]
    reason = " ".join(args[1:])

    from telegram import User
    temp_user = User(id=int(target_user_id), first_name="", is_bot=False)

    display_name_html = get_display_name_html_new(temp_user)

    cursor.execute("SELECT username FROM users WHERE user_id = ?", (target_user_id,))
    result = cursor.fetchone()

    if not result:
        conn.close()
        await message.reply_text("‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω.")
        return

    await perform_deletion(update, context, target_user_id, display_name_html,
                           admin_user.first_name or "", admin_user.last_name or "",
                           admin_user_id, reason, conn, cursor)

    conn.close()


async def perform_deletion(update, context, target_user_id, display_name_html,
                           admin_first_name, admin_last_name, admin_user_id, reason, conn, cursor):
    msg = await update.message.reply_text("‚è≥ <b>–£–¥–∞–ª—è–µ–º –∞–∫–∫–∞—É–Ω—Ç...</b>", parse_mode="HTML")
    await asyncio.sleep(2)

    delete_queries = [
        ("DELETE FROM users WHERE user_id = ?", (target_user_id,)),
        ("DELETE FROM pets WHERE user_id = ?", (target_user_id,)),
        ("DELETE FROM taxi_profiles WHERE user_id = ?", (target_user_id,)),
        ("DELETE FROM businesses_XUI WHERE owner_id = ?", (target_user_id,)),
        ("DELETE FROM bonus_timers WHERE user_id = ?", (target_user_id,)),
        ("DELETE FROM Bank_New WHERE user_id = ?", (target_user_id,)),
        ("DELETE FROM user_promocodes WHERE user_id = ?", (target_user_id,)),
        ("DELETE FROM user_cases WHERE user_id = ?", (target_user_id,)),
        ("DELETE FROM clan_members WHERE user_id = ?", (target_user_id,)),
        ("DELETE FROM admins WHERE user_id = ?", (target_user_id,)),
        ("DELETE FROM departament WHERE user_id = ?", (target_user_id,)),
        ("DELETE FROM crypto_balances WHERE user_id = ?", (target_user_id,)),
        ("DELETE FROM department_warns WHERE user_id = ?", (target_user_id,)),
        ("DELETE FROM kids WHERE parent1_id = ? OR parent2_id = ?", (target_user_id, target_user_id)),
        ("DELETE FROM marriages WHERE user_id1 = ? OR user_id2 = ?", (target_user_id, target_user_id)),
        ("DELETE FROM custom_promo WHERE owner_id = ?", (target_user_id,))
    ]

    for query, params in delete_queries:
        cursor.execute(query, params)

    conn.commit()

    admin_mention = f'<a href="tg://user?id={admin_user_id}">{html.escape(admin_first_name)} {html.escape(admin_last_name)}</a>'

    final_text = (
        "‚úÖ <b>–ê–∫–∫–∞—É–Ω—Ç —É–¥–∞–ª—ë–Ω</b>\n\n"
        f"üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {display_name_html}\n"
        f"üÜî Telegram ID: <code>{target_user_id}</code>\n\n"
        f"üõ° <b>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä:</b>\n"
        f"{admin_mention}\n"
        f"üìã <b>–ü—Ä–∏—á–∏–Ω–∞:</b> {html.escape(reason)}"
    )

    await msg.edit_text(final_text, parse_mode="HTML")


async def clan_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text.lower()

    if text.startswith("–∫–ª–∞–Ω—ã"):
        cmd_text = text[len("–∫–ª–∞–Ω—ã"):].strip()
        if cmd_text == "":
            await clans(update, context)
            return
    elif text.startswith("–∫–ª–∞–Ω"):
        cmd_text = text[len("–∫–ª–∞–Ω"):].strip()
    else:
        return

    if not cmd_text:
        await mclan(update, context)
        return

    parts = cmd_text.split()
    subcommand = parts[0]
    args = parts[1:]  # –∞—Ä–≥—É–º–µ–Ω—Ç—ã

    commands_map = {
        "": mclan,
        "!": ccommands,
        "–¥–æ–±–∞–≤–∏—Ç—å": addmembc,
        "—Å–æ–∑–¥–∞—Ç—å": makeclan,
        "—É–¥–∞–ª–∏—Ç—å": delclan,
        "–≤—ã–≥–Ω–∞—Ç—å": kickclan,
        "–≤—Å—Ç—É–ø–∏—Ç—å": invitec,
        "–Ω–∞–∑–≤–∞–Ω–∏–µ": nclan,
        "–ø–µ—Ä–µ–¥–∞—Ç—å": transferclan,
        "—Å—Ç–∞—Ç—É—Å": sclan,
        "–ø–æ–∫–∏–Ω—É—Ç—å": uninvitec,
        "–∏–Ω—Ñ–æ": cinfo,
    }

    func = commands_map.get(subcommand)
    if func:
        sig = inspect.signature(func)
        params = sig.parameters
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –ª–∏ —Ñ—É–Ω–∫—Ü–∏—è —Ç—Ä–µ—Ç–∏–π –ø–∞—Ä–∞–º–µ—Ç—Ä (–Ω–∞–∑–æ–≤—ë–º –µ–≥–æ 'args')
        if len(params) == 3:
            # –ü–µ—Ä–µ–¥–∞—ë–º 3 –∞—Ä–≥—É–º–µ–Ω—Ç–∞
            await func(update, context, args)
        else:
            # –ü–µ—Ä–µ–¥–∞—ë–º 2 –∞—Ä–≥—É–º–µ–Ω—Ç–∞
            await func(update, context)
    else:
        buttons = [
            [InlineKeyboardButton("üìñ –°–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥ –∫–ª–∞–Ω–æ–≤", url="https://telegra.ph/Klan--Spisok-komand-06-08")]
        ]

        await update.message.reply_text(
            "‚ö†Ô∏è <b>–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞ –∫–ª–∞–Ω–∞</b>\n\n"
            "‚ùó –ò—Å–ø–æ–ª—å–∑—É–π –æ–¥–Ω—É –∏–∑ —Å–ª–µ–¥—É—é—â–∏—Ö –∫–æ–º–∞–Ω–¥:\n"
            "üìå <i>–ö–ª–∞–Ω</i>, <i>–ö–ª–∞–Ω—ã</i>, <i>–ö–ª–∞–Ω —Å–æ–∑–¥–∞—Ç—å</i>, <i>–ö–ª–∞–Ω –¥–æ–±–∞–≤–∏—Ç—å</i> –∏ –¥—Ä—É–≥–∏–µ.\n\n"
            "üí° –ß—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å –ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥, –≤–æ—Å–ø–æ–ª—å–∑—É–π—Å—è –∫–æ–º–∞–Ω–¥–æ–π <code>–∫–ª–∞–Ω !</code> –∏–ª–∏ –Ω–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ.",
            parse_mode="HTML",
            reply_markup=InlineKeyboardMarkup(buttons)
        )


async def ccommands(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = (
        "<b>üè∞ –ö–ª–∞–Ω | –ö–æ–º–∞–Ω–¥—ã</b>\n\n"
        "üëá –ü–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥ –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∫–Ω–æ–ø–∫–µ –Ω–∏–∂–µ"
    )

    buttons = [
        [InlineKeyboardButton("üìñ –°–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥ –∫–ª–∞–Ω–æ–≤", url="https://telegra.ph/Klan--Spisok-komand-06-08")]
    ]

    await update.message.reply_html(text, reply_markup=InlineKeyboardMarkup(buttons))


# –•—Ä–∞–Ω–∏–ª–∏—â–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–ø—Ä–∏–º–µ—Ä)
user_post_data = {}


def escape_md_v2(text: str) -> str:
    # –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª–æ–≤ MarkdownV2
    return re.sub(r'([_\*\[\]\(\)~`>#+\-=|{}\.!\\])', r'\\\1', text)


async def chat_id_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    chat_id = update.effective_chat.id
    await update.message.reply_text(f"üÜî ID —ç—Ç–æ–≥–æ —á–∞—Ç–∞: `{chat_id}`", parse_mode="Markdown")


async def post(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    if user_id not in ADMINS_FOR_POST:
        await update.message.reply_text("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥–µ.")
        return

    message_text = update.message.text
    if message_text.startswith("/post"):
        message_text = message_text[len("/post"):].lstrip()
    if not message_text:
        await update.message.reply_text("‚ùå –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –ø—É—Å—Ç–æ–π.")
        return

    safe_text = escape_markdown(message_text, version=2)  # —ç–∫—Ä–∞–Ω–∏—Ä—É–µ–º

    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()
        cursor.execute("SELECT chat_id FROM chat_settings WHERE broadcast_enabled = 1")
        chat_ids = [row[0] for row in cursor.fetchall()]
        cursor.execute("SELECT user_id FROM users")
        user_ids = [row[0] for row in cursor.fetchall()]

    semaphore = asyncio.Semaphore(100)
    sent_count = 0
    error_count = 0

    async def send_safe(chat_or_user_id):
        nonlocal sent_count, error_count
        async with semaphore:
            try:
                await context.bot.send_message(
                    chat_id=chat_or_user_id,
                    text=safe_text,
                    parse_mode="MarkdownV2",
                    disable_web_page_preview=True
                )
                sent_count += 1
            except Exception:
                error_count += 1

    # –†–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ –±–∞—Ç—á–∏, —á—Ç–æ–±—ã –±–æ—Ç –Ω–µ –∑–∞–≤–∏—Å
    batch_size = 50
    tasks = [send_safe(cid) for cid in chat_ids] + [send_safe(uid) for uid in user_ids]
    for i in range(0, len(tasks), batch_size):
        batch = tasks[i:i + batch_size]
        await asyncio.gather(*batch)
        await asyncio.sleep(0.05)  # –¥–∞—ë–º event loop –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –¥—Ä—É–≥–∏–µ –∫–æ–º–∞–Ω–¥—ã

    await update.message.reply_text(
        f"‚úÖ –†–∞—Å—Å—ã–ª–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞.\nüì® –£—Å–ø–µ—à–Ω–æ: {sent_count}\n‚ö†Ô∏è –û—à–∏–±–æ–∫: {error_count}"
    )


ADMINS_CHAT_ID = -1002579983709  # —á–∞—Ç –¥–ª—è –∞–¥–º–∏–Ω–æ–≤
ADMIN_IDS = {7406372338, 7283522738}  # —Ç–≤–æ–∏ –∞–¥–º–∏–Ω ID

PASCODES_FILE = 'pascods.json'


def load_pascodes():
    try:
        with open(PASCODES_FILE, 'r') as f:
            return json.load(f)
    except:
        return {}


def save_pascodes(data):
    with open(PASCODES_FILE, 'w') as f:
        json.dump(data, f)


def generate_code():
    return ''.join(str(random.randint(0, 9)) for _ in range(6))


async def del_accounts_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–∞–∑–µ
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT status FROM users WHERE user_id = ?", (str(user_id),))
    row = cursor.fetchone()
    conn.close()

    if not row:
        await update.message.reply_text("‚ùå –í—ã –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.")
        return

    user_status = row[0]
    if user_status < 12:  # –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ –∏ –≤—ã—à–µ - —Å—Ç–∞—Ç—É—Å 12+
        await update.message.reply_text("‚ùå –ö–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫—É –∏ –≤—ã—à–µ.")
        return

    # –û—Ç–º–µ—Ç–∏–º, –∫—Ç–æ –≤–ª–∞–¥–µ–ª–µ—Ü —Å–µ—Å—Å–∏–∏
    context.user_data['del_accounts_owner'] = user_id
    context.user_data['awaiting_del_code'] = False

    keyboard = InlineKeyboardMarkup([
        [
            InlineKeyboardButton("‚úÖ –î–∞", callback_data=f"del_acc_yes_{user_id}"),
            InlineKeyboardButton("‚ùå –ù–µ—Ç", callback_data=f"del_acc_no_{user_id}")
        ]
    ])

    await update.message.reply_text(
        "‚ö†Ô∏è –í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ *—É–¥–∞–ª–∏—Ç—å –í–°–ï –∞–∫–∫–∞—É–Ω—Ç—ã* –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –±–æ—Ç–∞?\n\n",
        reply_markup=keyboard,
        parse_mode="Markdown"
    )


async def button_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    data = query.data
    user_id = query.from_user.id

    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–º–µ–Ω—ã –≤–≤–æ–¥–∞ –∫–æ–¥–∞
    if data == "cancel_code_wait":
        await query.answer()
        if context.user_data.get('awaiting_del_code'):
            context.user_data['awaiting_del_code'] = False
            await query.edit_message_text("‚ùå –í–≤–æ–¥ –∫–æ–¥–∞ –æ—Ç–º–µ–Ω—ë–Ω.")
        else:
            await query.answer("‚ö†Ô∏è –°–µ–π—á–∞—Å –Ω–µ –æ–∂–∏–¥–∞–µ—Ç—Å—è –≤–≤–æ–¥ –∫–æ–¥–∞.", show_alert=True)
        return

    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–æ–∫ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è
    if data.startswith("del_acc_"):
        await query.answer()
        try:
            # –ü—Ä–∏–º–µ—Ä callback_data: del_acc_yes_123456789
            _, _, answer, owner_id_str = data.split('_', 3)
            owner_id = int(owner_id_str)
        except Exception:
            return

        if user_id != owner_id:
            await query.answer("‚ùå –≠—Ç–æ –Ω–µ –≤–∞—à–∞ –∫–Ω–æ–ø–∫–∞!", show_alert=True)
            return

        if answer == "no":
            await query.edit_message_text("‚ùå –î–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.")
            context.user_data['awaiting_del_code'] = False
            return

        if answer == "yes":
            pascodes = load_pascodes()
            code = generate_code()
            timestamp = time.time()
            pascodes['del_accounts'] = {
                'code': code,
                'timestamp': timestamp,
                'used': False,
                'owner_id': owner_id
            }
            save_pascodes(pascodes)

            await context.bot.send_message(
                chat_id=ADMINS_CHAT_ID,
                text=(
                    "üîê *–û–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–π –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è*\n\n"
                    "_–ü—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –∫–æ–¥–∞: —É–¥–∞–ª–µ–Ω–∏–µ –í–°–ï–• –∞–∫–∫–∞—É–Ω—Ç–æ–≤ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –±–æ—Ç–∞._\n\n"
                    f"üÜî *–ö–æ–¥:* `{code}`\n\n"
                    "‚ö†Ô∏è *–í–Ω–∏–º–∞–Ω–∏–µ:* –∫–æ–¥ –¥–µ–π—Å—Ç–≤—É–µ—Ç —Ç–æ–ª—å–∫–æ 5 –º–∏–Ω—É—Ç."
                ),
                parse_mode="Markdown"
            )

            cancel_kb = InlineKeyboardMarkup([
                [InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data="cancel_code_wait")]
            ])
            await query.edit_message_text(
                "üîê *–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è*, –∫–æ—Ç–æ—Ä—ã–π –±—ã–ª –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ —á–∞—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏.\n\n"
                "‚è≥ –ö–æ–¥ –¥–µ–π—Å—Ç–≤—É–µ—Ç *5 –º–∏–Ω—É—Ç*.\n\n"
                "–ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–º–µ–Ω–∏—Ç—å –≤–≤–æ–¥, –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ.",
                reply_markup=cancel_kb,
                parse_mode="Markdown"
            )

            context.user_data['awaiting_del_code'] = True
            context.user_data['del_accounts_owner'] = owner_id
            return


async def code_message_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ–∂–∏–¥–∞–µ—Ç—Å—è –ª–∏ –≤–≤–æ–¥ –∫–æ–¥–∞ –∏ –∫—Ç–æ –∞–≤—Ç–æ—Ä
    if not context.user_data.get('awaiting_del_code'):
        return
    if update.effective_user.id != context.user_data.get('del_accounts_owner'):
        return  # –∫—Ç–æ-—Ç–æ –¥—Ä—É–≥–æ–π –ø—ã—Ç–∞–µ—Ç—Å—è –≤–≤–µ—Å—Ç–∏ –∫–æ–¥

    user_code = update.message.text.strip()
    pascodes = load_pascodes()
    entry = pascodes.get('del_accounts')

    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º "–ø—Ä–æ–≤–µ—Ä–∫–∞..."
    sent_msg = await update.message.reply_text("‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è...")
    await asyncio.sleep(1)

    # –ù–µ—Ç –∫–æ–¥–∞ –≤–æ–æ–±—â–µ
    if not entry:
        await sent_msg.edit_text("‚ùå *–ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –∏—Å—Ç—ë–∫.*", parse_mode="Markdown")
        context.user_data['awaiting_del_code'] = False
        return

    # –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –∫–æ–¥–∞
    if time.time() - entry['timestamp'] > 300:
        pascodes.pop('del_accounts')
        save_pascodes(pascodes)
        await sent_msg.edit_text("‚åõ *–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –∫–æ–¥–∞ –∏—Å—Ç—ë–∫. –ó–∞–ø—Ä–æ—Å–∏—Ç–µ –Ω–æ–≤—ã–π –∫–æ–¥.*", parse_mode="Markdown")
        context.user_data['awaiting_del_code'] = False
        return

    # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –ª–∏ –∫–æ–¥
    if entry.get('used'):
        await sent_msg.edit_text("‚ö†Ô∏è *–≠—Ç–æ—Ç –∫–æ–¥ —É–∂–µ –±—ã–ª –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω.*", parse_mode="Markdown")
        context.user_data['awaiting_del_code'] = False
        return

    # –°–æ–≤–ø–∞–¥–∞–µ—Ç –ª–∏ –∫–æ–¥
    if user_code != entry.get('code'):
        await sent_msg.edit_text("‚ùå *–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.*", parse_mode="Markdown")
        return

    # –ö–æ–¥ –ø–æ–¥—Ö–æ–¥–∏—Ç ‚Äî –ø—Ä–∏–º–µ–Ω—è–µ–º
    pascodes['del_accounts']['used'] = True
    save_pascodes(pascodes)
    context.user_data['awaiting_del_code'] = False

    await sent_msg.edit_text("‚úÖ *–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–π–¥–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ ‚Äî –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω!*", parse_mode="Markdown")

    # –£–¥–∞–ª–µ–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–æ–≤
    deleting_msg = await update.message.reply_text("üóëÔ∏è –£–¥–∞–ª–µ–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–æ–≤ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö...", parse_mode="Markdown")
    await asyncio.sleep(2)

    try:
        conn = sqlite3.connect("FernieUI.db")
        cursor = conn.cursor()

        # –£–¥–∞–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü
        cursor.execute("DELETE FROM users")
        cursor.execute("DELETE FROM pets")
        cursor.execute("DELETE FROM taxi_profiles")
        cursor.execute("DELETE FROM businesses")
        cursor.execute("DELETE FROM bonus_timers")
        cursor.execute("DELETE FROM banks")
        cursor.execute("DELETE FROM user_promocodes")
        cursor.execute("DELETE FROM user_cases")
        cursor.execute("DELETE FROM clan_members")

        conn.commit()
        conn.close()

        await deleting_msg.edit_text("‚úÖ *–í—Å–µ –∞–∫–∫–∞—É–Ω—Ç—ã —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω—ã!*", parse_mode="Markdown")

    except Exception as e:
        await deleting_msg.edit_text(f"‚ùå *–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏:* `{e}`", parse_mode="Markdown")


def format_rub(value):
    return f"{value:,}".replace(",", ".") + " ‚ÇΩ"


async def dbusers_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    msg = await update.message.reply_text(
        "‚è≥ –°–±–æ—Ä –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏..\n<pre>üìÇ –ß–∏—Ç–∞–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö... üîç</pre>",
        parse_mode="HTML"
    )
    await asyncio.sleep(2)

    await msg.edit_text(
        "‚è≥ –°–±–æ—Ä –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏..\n<pre>‚öôÔ∏è –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–∞–Ω–Ω—ã–µ...</pre>",
        parse_mode="HTML"
    )
    await asyncio.sleep(1)

    await msg.edit_text(
        "‚è≥ –°–±–æ—Ä –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏..\n<pre>üë• –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...</pre>",
        parse_mode="HTML"
    )
    await asyncio.sleep(1)

    await msg.edit_text(
        "‚è≥ –°–±–æ—Ä –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏..\n<pre>üìà –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Ç—á–µ—Ç—ã... üìù</pre>",
        parse_mode="HTML"
    )
    await asyncio.sleep(1)

    # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è
    now = datetime.now()
    date_str = now.strftime("%d.%m.%Y")
    time_str = now.strftime("%H:%M:%S")

    context.user_data['report_date'] = date_str
    context.user_data['report_time'] = time_str

    # –ö–Ω–æ–ø–∫–∏ —Å–æ–∑–¥–∞—ë–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —Å–±–æ—Ä–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
    keyboard = [
        [
            InlineKeyboardButton("üë§ –ê–∫–∫–∞—É–Ω—Ç—ã", callback_data="db_info_accounts"),
            InlineKeyboardButton("üè¢ –ë–∏–∑–Ω–µ—Å—ã", callback_data="db_info_businesses"),
        ],
        [
            InlineKeyboardButton("üè¶ –ë–∞–Ω–∫", callback_data="db_info_bank"),
            InlineKeyboardButton("üîá –ú—É—Ç—ã", callback_data="db_info_mutes"),
        ],
        [
            InlineKeyboardButton("‚õî –ë–∞–Ω—ã", callback_data="db_info_bans"),
            InlineKeyboardButton("üí¨ –ß–∞—Ç—ã", callback_data="db_info_chats"),
        ],
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)

    await msg.edit_text(
        "üóÇÔ∏è <b>–û—Ç—á–µ—Ç –æ–± –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏</b>\n"
        "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
        f"üìù –û—Ç—á–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω:\n"
        f"üìÖ –î–∞—Ç–∞: {date_str}\n"
        f"‚è∞ –í—Ä–µ–º—è: {time_str}",
        parse_mode="HTML",
        reply_markup=reply_markup
    )


async def db_info_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    text = ""
    cb = query.data

    if cb == "db_info_accounts":
        cursor.execute("SELECT COUNT(*) FROM users")
        total = cursor.fetchone()[0]

        cursor.execute("SELECT COUNT(*) FROM users WHERE status >= 1")
        admins = cursor.fetchone()[0]

        cursor.execute("SELECT SUM(balance) FROM users")
        total_balance = cursor.fetchone()[0] or 0

        text = (
            "<b>üë• –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è ‚Äî –ê–∫–∫–∞—É–Ω—Ç—ã</b>\n\n"
            f"üìã <b>–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:</b> <code>{total}</code>\n"
            f"üõ°Ô∏è <b>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏—è:</b> <code>{admins}</code>\n"
            f"üí∞ <b>–û–±—â–∏–π –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:</b> <code>{format_rub(total_balance)}</code>"
        )

    elif cb == "db_info_businesses":
        cursor.execute("SELECT COUNT(*) FROM businesses")
        total = cursor.fetchone()[0]

        cursor.execute("SELECT SUM(business_balance) FROM businesses")
        balance = cursor.fetchone()[0] or 0

        text = (
            "<b>üè¢ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è ‚Äî –ë–∏–∑–Ω–µ—Å—ã</b>\n\n"
            f"üìä <b>–í—Å–µ–≥–æ –±–∏–∑–Ω–µ—Å–æ–≤:</b> <code>{total}</code>\n"
            f"üí∞ <b>–û–±—â–∏–π –±–∞–ª–∞–Ω—Å –±–∏–∑–Ω–µ—Å–æ–≤:</b> <code>{format_rub(balance)}</code>"
        )

    elif cb == "db_info_bank":
        cursor.execute("SELECT COUNT(*) FROM Bank_New")
        total = cursor.fetchone()[0]

        cursor.execute("SELECT balance FROM Bank_New")
        balances = cursor.fetchall()
        total_balance = sum(int(b[0]) for b in balances if b[0].isdigit())

        cursor.execute("SELECT deposit_balance FROM Bank_Deposit")
        deposits = cursor.fetchall()
        total_deposits = sum(d[0] for d in deposits)

        text = (
            "<b>üè¶ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è ‚Äî –ë–∞–Ω–∫–æ–≤—Å–∫–∏–µ —Å—á–µ—Ç–∞</b>\n\n"
            f"üìÅ <b>–í—Å–µ–≥–æ —Å—á–µ—Ç–æ–≤:</b> <code>{total}</code>\n"
            f"üí≥ <b>–û–±—â–∏–π –±–∞–ª–∞–Ω—Å —Å—á–µ—Ç–æ–≤:</b> <code>{format_rub(total_balance)}</code>\n"
            f"üì• <b>–û–±—â–∏–π –±–∞–ª–∞–Ω—Å –¥–µ–ø–æ–∑–∏—Ç–æ–≤:</b> <code>{format_rub(total_deposits)}</code>"
        )

    elif cb == "db_info_mutes":
        cursor.execute("SELECT COUNT(*) FROM mutes")
        total = cursor.fetchone()[0]

        text = (
            "<b>üîá –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è ‚Äî –ú—É—Ç—ã</b>\n\n"
            f"üìå <b>–í—Å–µ–≥–æ –º—É—Ç–æ–≤:</b> <code>{total}</code>"
        )

    elif cb == "db_info_bans":
        cursor.execute("SELECT COUNT(*) FROM bans")
        total = cursor.fetchone()[0]

        text = (
            "<b>üö´ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è ‚Äî –ë–∞–Ω—ã</b>\n\n"
            f"üìå <b>–í—Å–µ–≥–æ –±–∞–Ω–æ–≤:</b> <code>{total}</code>"
        )

    elif cb == "db_info_chats":
        cursor.execute("SELECT COUNT(*) FROM chats_admins")
        total = cursor.fetchone()[0]

        cursor.execute("""
            SELECT COUNT(*) FROM chats_admins
            WHERE chat_id IN (SELECT chat_id FROM chat_settings)
        """)
        connected = cursor.fetchone()[0]

        not_connected = total - connected


    elif cb == "db_info_chats":
        cursor.execute("SELECT COUNT(*) FROM chats_admins")
        total = cursor.fetchone()[0]

        cursor.execute("""
            SELECT COUNT(*) FROM chats_admins
            WHERE chat_id IN (SELECT chat_id FROM chat_settings)
        """)
        connected = cursor.fetchone()[0]

        not_connected = total - connected

        text = (
            "<b>üí¨ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è ‚Äî –ß–∞—Ç—ã</b>\n\n"
            f"üì¶ <b>–í—Å–µ–≥–æ —á–∞—Ç–æ–≤:</b> <code>{total}</code>\n"
            f"‚úÖ <b>–ü–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–µ:</b> <code>{connected}</code>\n"
            f"‚ùå <b>–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–µ:</b> <code>{not_connected}</code>"
        )

    conn.close()

    # –ì–∞—Ä–∞–Ω—Ç–∏—è: –µ—Å–ª–∏ text –æ—Å—Ç–∞–ª—Å—è –ø—É—Å—Ç—ã–º ‚Äî –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
    if not text.strip():
        text = "‚ö†Ô∏è <b>–û—à–∏–±–∫–∞:</b> –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ."

    keyboard = [[InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="db_back")]]
    await query.edit_message_text(
        text,
        parse_mode="HTML",
        reply_markup=InlineKeyboardMarkup(keyboard)
    )


async def db_back_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    date_str = context.user_data.get('report_date', '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')
    time_str = context.user_data.get('report_time', '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')

    keyboard = [
        [
            InlineKeyboardButton("üë§ –ê–∫–∫–∞—É–Ω—Ç—ã", callback_data="db_info_accounts"),
            InlineKeyboardButton("üè¢ –ë–∏–∑–Ω–µ—Å—ã", callback_data="db_info_businesses"),
        ],
        [
            InlineKeyboardButton("üè¶ –ë–∞–Ω–∫", callback_data="db_info_bank"),
            InlineKeyboardButton("üîá –ú—É—Ç—ã", callback_data="db_info_mutes"),
        ],
        [
            InlineKeyboardButton("‚õî –ë–∞–Ω—ã", callback_data="db_info_bans"),
            InlineKeyboardButton("üí¨ –ß–∞—Ç—ã", callback_data="db_info_chats"),
        ],
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)

    await query.edit_message_text(
        "üóÇÔ∏è <b>–û—Ç—á–µ—Ç –æ–± –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏</b>\n"
        "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
        f"üìù –û—Ç—á–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω:\n"
        f"üìÖ –î–∞—Ç–∞: {date_str}\n"
        f"‚è∞ –í—Ä–µ–º—è: {time_str}",
        parse_mode="HTML",
        reply_markup=reply_markup
    )


active_proposals = {}  # {to_user_id: {"from": from_id, "message_id": msg_id, "chat_id": chat_id}}


async def brak(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not update.message.reply_to_message:
        await update.message.reply_text(
            "üíå <b>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è,</b>\n"
            "<b>–∫ –∫–æ—Ç–æ—Ä–æ–º—É —Ö–æ—Ç–∏—Ç–µ —Å–¥–µ–ª–∞—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ</b> üíç",
            parse_mode="HTML"
        )
        return

    from_user = update.effective_user
    to_user = update.message.reply_to_message.from_user

    if from_user.id == to_user.id:
        await update.message.reply_text(
            "–í—ã –Ω–µ –º–æ–∂–µ—Ç–µ –≤—Å—Ç—É–ø–∏—Ç—å –≤ –±—Ä–∞–∫ —Å–∞–º–∏ —Å —Å–æ–±–æ–π üôÉ",
            parse_mode="HTML"
        )
        return

    conn = sqlite3.connect(DB_PATH)
    cur = conn.cursor()

    cur.execute("SELECT married_to FROM users WHERE user_id=?", (str(from_user.id),))
    row = cur.fetchone()
    if row and row[0]:
        await update.message.reply_text(
            "‚ù§Ô∏è <b>–í—ã —É–∂–µ —Å–≤—è–∑–∞–ª–∏ —Å–µ–±—è —É–∑–∞–º–∏ –±—Ä–∞–∫–∞!</b>\n"
            "–ù–µ–ª—å–∑—è –∑–∞–∫–ª—é—á–∏—Ç—å –Ω–æ–≤—ã–π –±—Ä–∞–∫, –ø–æ–∫–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏–π –¥–µ–π—Å—Ç–≤—É–µ—Ç.",
            parse_mode="HTML"
        )
        conn.close()
        return

    cur.execute("SELECT married_to FROM users WHERE user_id=?", (str(to_user.id),))
    row = cur.fetchone()
    if row and row[0]:
        await update.message.reply_text(
            "üíçüíî <b>–≠—Ç–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Å—á–∞—Å—Ç–ª–∏–≤ –≤ –±—Ä–∞–∫–µ!</b>\n"
            "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–±—Ä–∞—Ç—å –∫–æ–≥–æ-—Ç–æ –¥—Ä—É–≥–æ–≥–æ.",
            parse_mode="HTML"
        )
        conn.close()
        return

    if to_user.id in active_proposals:
        await update.message.reply_text(
            "üíî –£ —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É–∂–µ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ –±—Ä–∞–∫–µ.\n"
            "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.",
            parse_mode="HTML"
        )
        conn.close()
        return

    # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é get_display_name_html_new –¥–ª—è —É–ø–æ–º–∏–Ω–∞–Ω–∏—è —Å –Ω–∏–∫–æ–º –∏–ª–∏ –∏–º–µ–Ω–µ–º
    from_mention = get_display_name_html_new(from_user)
    to_mention = get_display_name_html_new(to_user)

    text = (
        "üíå <b>–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ –∑–∞–∫–ª—é—á–µ–Ω–∏–∏ –±—Ä–∞–∫–µ</b>\n\n"
        f"üë∞ <b>–û—Ç:</b> {from_mention}\n"
        f"ü§µ <b>–ö–æ–º—É:</b> {to_mention}\n\n"
        "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
        "üíç <i>–°–¥–µ–ª–∞–π—Ç–µ –≤—ã–±–æ—Ä –∏ –æ—Ç–≤–µ—Ç—å—Ç–µ</i>"
    )

    keyboard = InlineKeyboardMarkup([[
        InlineKeyboardButton("üíç –ü—Ä–∏–Ω—è—Ç—å", callback_data=f"marry_accept_{from_user.id}_{to_user.id}"),
        InlineKeyboardButton("‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å", callback_data=f"marry_decline_{from_user.id}_{to_user.id}")
    ]])

    msg = await update.message.reply_text(text, reply_markup=keyboard, parse_mode="HTML")

    active_proposals[to_user.id] = {"from": from_user.id, "message_id": msg.message_id, "chat_id": msg.chat.id}

    conn.close()

    async def expire_proposal(from_user, to_user, context):
        await asyncio.sleep(300)
        if to_user.id in active_proposals:
            data = active_proposals.pop(to_user.id)
            try:
                from_mention = get_display_name_html_new(from_user)
                to_mention = get_display_name_html_new(to_user)

                await context.bot.edit_message_text(
                    chat_id=data["chat_id"],
                    message_id=data["message_id"],
                    text=(
                        "üíå <b>–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ –∑–∞–∫–ª—é—á–µ–Ω–∏–∏ –±—Ä–∞–∫–µ</b>\n\n"
                        f"üë∞ –û—Ç: {from_mention}\n"
                        f"ü§µ –ö–æ–º—É: {to_mention}\n\n"
                        "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
                        "‚è≥ <i>–í—Ä–µ–º—è –Ω–∞ –æ—Ç–≤–µ—Ç –∏—Å—Ç–µ–∫–ª–æ</i>\n"
                        "‚ùå <b>–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ.</b>"
                    ),
                    parse_mode="HTML"
                )
            except Exception:
                pass

    asyncio.create_task(expire_proposal(from_user, to_user, context))


async def handle_marriage_buttons(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    data = query.data

    if data.startswith("marry_accept_") or data.startswith("marry_decline_"):
        _, action, from_id_str, to_id_str = data.split("_")
        from_id, to_id = int(from_id_str), int(to_id_str)

        if to_id != query.from_user.id:
            await query.answer("üíî –≠—Ç–æ –Ω–µ –≤–∞–º –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–æ.", show_alert=True)
            return

        if to_id not in active_proposals:
            await query.answer("üíî –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –±–æ–ª—å—à–µ –Ω–µ –∞–∫—Ç–∏–≤–Ω–æ.", show_alert=True)
            return

        active_proposals.pop(to_id)

        try:
            with sqlite3.connect(DB_PATH) as conn:
                cur = conn.cursor()

                def ensure_user(user_id, first_name="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"):
                    cur.execute("SELECT 1 FROM users WHERE user_id=?", (str(user_id),))
                    if not cur.fetchone():
                        cur.execute("INSERT INTO users (user_id, first_name) VALUES (?, ?)",
                                    (str(user_id), first_name))
                        conn.commit()

                # –ü–æ–ª—É—á–∞–µ–º –æ–±—ä–µ–∫—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ –±–æ—Ç–∞ (—á—Ç–æ–±—ã –ø–µ—Ä–µ–¥–∞—Ç—å –≤ get_display_name_html_new)
                from_user = await context.bot.get_chat_member(query.message.chat.id, from_id)
                to_user = await context.bot.get_chat_member(query.message.chat.id, to_id)

                # –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –ë–î
                ensure_user(from_id, from_user.user.first_name or "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å")
                ensure_user(to_id, to_user.user.first_name or "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å")

                if action == "accept":
                    try:
                        # –°–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å –æ –±—Ä–∞–∫–µ
                        cur.execute(
                            "INSERT INTO marriages (user_id1, user_id2, created_at) VALUES (?, ?, datetime('now'))",
                            (str(from_id), str(to_id))
                        )
                        cur.execute(
                            "UPDATE users SET married_to=? WHERE user_id=?",
                            (str(to_id), str(from_id))
                        )
                        cur.execute(
                            "UPDATE users SET married_to=? WHERE user_id=?",
                            (str(from_id), str(to_id))
                        )
                        conn.commit()

                        from_mention = get_display_name_html_new(from_user.user)
                        to_mention = get_display_name_html_new(to_user.user)

                        text = (
                            "üíû <b>–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º —Å –≤–∞–∂–Ω—ã–º —Å–æ–±—ã—Ç–∏–µ–º!</b> üíû\n\n"
                            f"üë∞‚Äç‚ôÄÔ∏è {from_mention}\n"
                            f"ü§µ {to_mention}\n\n"
                            "‚ú® <i>–°–µ–≥–æ–¥–Ω—è –æ–Ω–∏ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ —Å—Ç–∞–ª–∏ —Å–µ–º—å—ë–π!</i> ‚ú®\n"
                            "\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
                            "üéâ –ü—É—Å—Ç—å –ª—é–±–æ–≤—å –±—É–¥–µ—Ç –≤–µ—á–Ω–æ–π! üéâ"
                        )
                        await query.edit_message_text(text=text, parse_mode="HTML")

                    except Exception as e:
                        await query.edit_message_text(
                            f"üíî –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø–∏—Å–∏ –±—Ä–∞–∫–∞: {html.escape(str(e))}",
                            parse_mode="HTML"
                        )

                else:  # Decline
                    from_mention = get_display_name_html_new(from_user.user)
                    to_mention = get_display_name_html_new(to_user.user)

                    text = (
                        f"üíî {from_mention}, –∫ —Å–æ–∂–∞–ª–µ–Ω–∏—é,\n"
                        f"‚ùå {to_mention} –æ—Ç–∫–ª–æ–Ω–∏–ª(–∞) –≤–∞—à–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ...\n\n"
                        "<i>–ù–µ –æ—Ç—á–∞–∏–≤–∞–π—Ç–µ—Å—å, –ª—é–±–æ–≤—å –µ—â—ë –≤–ø–µ—Ä–µ–¥–∏!</i> üí´"
                    )
                    await query.edit_message_text(text=text, parse_mode="HTML")

                await query.answer()

        except Exception as e:
            logging.error(f"–û—à–∏–±–∫–∞ –≤ handle_marriage_buttons: {e}")
            await query.edit_message_text(
                "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.",
                parse_mode="HTML"
            )
            await query.answer()


async def mybrak(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    conn = sqlite3.connect(DB_PATH)
    cur = conn.cursor()

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å—É–ø—Ä—É–≥
    cur.execute("SELECT married_to FROM users WHERE user_id=?", (str(user.id),))
    row = cur.fetchone()
    if not row or not row[0]:
        await update.message.reply_text(
            "üíî –í—ã –Ω–µ —Å–æ—Å—Ç–æ–∏—Ç–µ –≤ –±—Ä–∞–∫–µ.",
            parse_mode="HTML"
        )
        conn.close()
        return

    partner_id = row[0]

    # –ü–æ–ª—É—á–∞–µ–º –æ–±—ä–µ–∫—Ç –ø–∞—Ä—Ç–Ω—ë—Ä–∞
    try:
        partner_member = await context.bot.get_chat_member(update.effective_chat.id, int(partner_id))
        partner_user = partner_member.user
    except Exception:
        partner_user = None

    if partner_user is None:
        partner_mention = "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"
    else:
        partner_mention = get_display_name_html_new(partner_user)

    user_mention = get_display_name_html_new(user)

    # –ü–æ–ª—É—á–∞–µ–º –¥–∞—Ç—É –±—Ä–∞–∫–∞
    cur.execute(
        "SELECT created_at FROM marriages WHERE (user_id1=? AND user_id2=?) OR (user_id1=? AND user_id2=?)",
        (str(user.id), str(partner_id), str(partner_id), str(user.id))
    )
    created_row = cur.fetchone()
    conn.close()

    if not created_row:
        await update.message.reply_text(
            "‚ùå –î–∞–Ω–Ω—ã–µ –æ –±—Ä–∞–∫–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.",
            parse_mode="HTML"
        )
        return

    raw_date = created_row[0]
    created_at = None

    # –ü—Ä–æ–±—É–µ–º —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –¥–∞—Ç—É
    if raw_date.isdigit():  # –µ—Å–ª–∏ timestamp
        created_at = datetime.fromtimestamp(int(raw_date))
    else:
        for fmt in ("%Y-%m-%d %H:%M:%S", "%Y-%d-%m %H:%M:%S"):
            try:
                created_at = datetime.strptime(raw_date, fmt)
                break
            except ValueError:
                continue

    if created_at is None:
        await update.message.reply_text("‚ö† –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –¥–∞—Ç—É –±—Ä–∞–∫–∞.")
        return

    # –°—á–∏—Ç–∞–µ–º –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
    duration = datetime.now() - created_at
    status = get_marriage_status(duration)

    # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
    message = (
        f"üíç <b>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±—Ä–∞–∫–µ</b>\n\n"
        f"üë∞ –ü–∞—Ä—Ç–Ω—ë—Ä—ã:\n"
        f"1. {user_mention}\n"
        f"2. {partner_mention}\n\n"
        f"üìÖ <b>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:</b> {created_at.strftime('%d.%m.%Y')}\n"
        f"‚è≥ <b>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</b> {duration.days} –¥–Ω.\n"
        f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
        f"‚ù§Ô∏è <b>–°—Ç–∞—Ç—É—Å –±—Ä–∞–∫–∞:</b>\n"
        f"<i>{html.escape(status)}</i>"
    )

    await update.message.reply_text(message, parse_mode="HTML", disable_web_page_preview=True)


async def devorce(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    conn = sqlite3.connect(DB_PATH)
    cur = conn.cursor()

    cur.execute("SELECT married_to FROM users WHERE user_id=?", (str(user.id),))
    row = cur.fetchone()

    if not row or not row[0]:
        await update.message.reply_text("üíî –í—ã –Ω–µ —Å–æ—Å—Ç–æ–∏—Ç–µ –≤ –±—Ä–∞–∫–µ.")
        conn.close()
        return

    partner_id = row[0]

    try:
        partner_member = await context.bot.get_chat_member(update.effective_chat.id, int(partner_id))
        partner_user = partner_member.user
    except Exception:
        partner_user = None

    conn.close()

    user_mention = get_display_name_html_new(user)
    partner_mention = get_display_name_html_new(partner_user) if partner_user else "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"

    keyboard = InlineKeyboardMarkup([
        [
            InlineKeyboardButton("‚ùóÔ∏è –†–∞–∑–≤–µ—Å—Ç–∏—Å—å", callback_data=f"divorce_confirm_{user.id}_{partner_id}"),
            InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∏—Ç—å", callback_data="divorce_cancel")
        ]
    ])

    await update.message.reply_text(
        f"‚ö†Ô∏è {user_mention}, –≤—ã <b>—É–≤–µ—Ä–µ–Ω—ã</b>, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Ä–∞–∑–≤–µ—Å—Ç–∏—Å—å —Å {partner_mention}? üíî",
        reply_markup=keyboard,
        parse_mode="HTML"
    )


async def handle_divorce(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    data = query.data

    if data.startswith("divorce_confirm_"):
        _, _, user_id_str, partner_id_str = data.split("_")
        user_id, partner_id = int(user_id_str), int(partner_id_str)

        if query.from_user.id != user_id:
            await query.answer("‚ùå –≠—Ç–æ –Ω–µ –≤–∞—à–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ.", show_alert=True)
            return

        conn = sqlite3.connect(DB_PATH)
        cur = conn.cursor()

        cur.execute("""
            SELECT 1 FROM marriages
            WHERE (user_id1=? AND user_id2=?) OR (user_id1=? AND user_id2=?)
        """, (str(user_id), str(partner_id), str(partner_id), str(user_id)))
        marriage_exists = cur.fetchone()

        if not marriage_exists:
            await query.edit_message_text(
                "‚ö†Ô∏è –ë—Ä–∞–∫ —É–∂–µ —Ä–∞—Å—Ç–æ—Ä–≥–Ω—É—Ç –∏–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω.",
                parse_mode="HTML"
            )
            conn.close()
            return

        cur.execute("""
            DELETE FROM marriages 
            WHERE (user_id1=? AND user_id2=?) OR (user_id1=? AND user_id2=?)
        """, (str(user_id), str(partner_id), str(partner_id), str(user_id)))

        cur.execute("""
            UPDATE users 
            SET married_to=NULL 
            WHERE user_id IN (?, ?)
        """, (str(user_id), str(partner_id)))

        conn.commit()
        conn.close()

        await query.edit_message_text(
            "üíî <b>–í—ã —É—Å–ø–µ—à–Ω–æ —Ä–∞–∑–≤–µ–ª–∏—Å—å!</b> –ü—É—Å—Ç—å –Ω–æ–≤—ã–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è –±—É–¥—É—Ç —Å—á–∞—Å—Ç–ª–∏–≤–µ–µ.\n\n"
            "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
            "–ß—Ç–æ–±—ã —Å–Ω–æ–≤–∞ –≤—Å—Ç—É–ø–∏—Ç—å –≤ –±—Ä–∞–∫, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É –ë—Ä–∞–∫ üíç",
            parse_mode="HTML"
        )

    elif data == "divorce_cancel":
        await query.edit_message_text(
            "‚úÖ <b>–†–∞–∑–≤–æ–¥ –æ—Ç–º–µ–Ω—ë–Ω!</b> –õ—é–±–æ–≤—å –ø–æ–±–µ–∂–¥–∞–µ—Ç –≤—Å—ë ‚ù§Ô∏è",
            parse_mode="HTML"
        )


def get_marriage_status(delta):
    days = delta.days
    if days <= 5:
        return "üå± –í–æ–∑–ª—é–±–ª–µ–Ω–Ω—ã–µ"
    elif days <= 10:
        return "üí´ –í–ª—é–±–ª–µ–Ω–Ω—ã–µ –¥—É—à–∏"
    elif days <= 20:
        return "üíû –°—á–∞—Å—Ç–ª–∏–≤—ã–µ —Å–µ—Ä–¥—Ü–∞"
    elif days <= 30:
        return "üîó –ù–µ—Ä–∞–∑–ª—É—á–Ω—ã–µ"
    elif days <= 60:
        return "ü´∂ –î–≤–µ –ø–æ–ª–æ–≤–∏–Ω–∫–∏"
    elif days <= 90:
        return "üíì –¢—Ä–µ–ø–µ—Ç –ª—é–±–≤–∏"
    elif days <= 120:
        return "üéµ –ì–∞—Ä–º–æ–Ω–∏—è"
    elif days <= 150:
        return "üïäÔ∏è –ò—Å–∫—Ä–µ–Ω–Ω–∏–µ —á—É–≤—Å—Ç–≤–∞"
    elif days <= 180:
        return "üéâ –ü–æ–ª–≥–æ–¥–∞ —Å—á–∞—Å—Ç—å—è"
    elif days <= 210:
        return "üíñ –ì–ª—É–±–æ–∫–∞—è —Å–≤—è–∑—å"
    elif days <= 240:
        return "üî• –ù–µ–∂–Ω–æ—Å—Ç—å –∏ —Å—Ç—Ä–∞—Å—Ç—å"
    elif days <= 270:
        return "üìÖ –ü–æ—á—Ç–∏ –≥–æ–¥ –ª—é–±–≤–∏"
    elif days <= 300:
        return "üåü –¢–µ–ø–ª–æ —Ä–æ–¥–Ω—ã—Ö –¥—É—à"
    elif days <= 330:
        return "üéÅ –û–∂–∏–¥–∞–Ω–∏–µ –≥–æ–¥–æ–≤—â–∏–Ω—ã"
    elif days <= 365:
        return "üíç –ì–æ–¥ —Å—á–∞—Å—Ç—å—è"
    else:
        return "üåà –í–µ—á–Ω–∞—è –ª—é–±–æ–≤—å"


def is_admin_ibrak(user_id: int) -> bool:
    conn = sqlite3.connect(DB_PATH)
    cur = conn.cursor()
    cur.execute("SELECT status FROM users WHERE user_id = ?", (str(user_id),))
    row = cur.fetchone()
    conn.close()
    if row:
        print(f"[is_admin] User {user_id} status: {row[0]}")
    else:
        print(f"[is_admin] User {user_id} not found in DB")
    return row and int(row[0]) >= 6


def brakadm_md(text: str) -> str:
    escape_chars = r'\_*[]()~`>#+-=|{}.!'
    return ''.join(f'\\{c}' if c in escape_chars else c for c in text)


async def ibrak(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not context.args or len(context.args) != 2:
        await update.message.reply_text("‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /ibrak {id1} {id2}")
        return

    caller_id = update.effective_user.id

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
    if not is_admin_ibrak(caller_id):
        await update.message.reply_text("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç—É –∫–æ–º–∞–Ω–¥—É.")
        return

    user_id1, user_id2 = context.args[0], context.args[1]

    if user_id1 == user_id2:
        await update.message.reply_text("‚ùå –ù–µ–ª—å–∑—è –ø–æ–∂–µ–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —Å–∞–º–∏–º —Å–æ–±–æ–π.")
        return

    conn = sqlite3.connect(DB_PATH)
    cur = conn.cursor()

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    cur.execute("SELECT user_id, first_name FROM users WHERE user_id IN (?, ?)", (user_id1, user_id2))
    users = cur.fetchall()
    if len(users) < 2:
        await update.message.reply_text("‚ùå –û–¥–∏–Ω –∏–ª–∏ –æ–±–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç –≤ –±–∞–∑–µ.")
        conn.close()
        return

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –±—Ä–∞–∫
    cur.execute(
        "SELECT 1 FROM marriages WHERE (user_id1=? AND user_id2=?) OR (user_id1=? AND user_id2=?)",
        (user_id1, user_id2, user_id2, user_id1)
    )
    if cur.fetchone():
        await update.message.reply_text("‚ö†Ô∏è –≠—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —É–∂–µ —Å–æ—Å—Ç–æ—è—Ç –≤ –±—Ä–∞–∫–µ.")
        conn.close()
        return

    # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ married_to (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
    cur.execute("UPDATE users SET married_to=? WHERE user_id=?", (user_id2, user_id1))
    cur.execute("UPDATE users SET married_to=? WHERE user_id=?", (user_id1, user_id2))

    now = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    cur.execute(
        "INSERT INTO marriages (user_id1, user_id2, created_at) VALUES (?, ?, ?)",
        (user_id1, user_id2, now)
    )

    conn.commit()
    conn.close()

    def create_mention(user_id, name):
        escaped_name = brakadm_md(name)
        return f"[{escaped_name}](tg://user?id={user_id})"

    user1_mention = create_mention(user_id1, "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å üë∞")
    user2_mention = create_mention(user_id2, "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ü§µ")
    admin_mention = create_mention(caller_id, "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ ‚öôÔ∏è")

    message_text = (
        f"üíç *–ú–µ–∂–¥—É {user1_mention} –∏ {user2_mention} –∑–∞–∫–ª—é—á—ë–Ω –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –±—Ä–∞–∫\\!* üéâ\n\n"
        f"üëÆ‚Äç‚ôÇÔ∏è –ü–æ –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–µ {admin_mention}\n\n"
        "–ü—É—Å—Ç—å –∏—Ö —Å–æ—é–∑ –±—É–¥–µ—Ç –¥–æ–ª–≥–∏–º –∏ —Å—á–∞—Å—Ç–ª–∏–≤—ã–º\\! ‚ù§Ô∏è"
    )

    await update.message.reply_text(
        message_text,
        parse_mode="MarkdownV2"
    )


VIP_STATUS_MAP = {
    0: "–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç",
    1: "Silver",
    2: "Gold",
    3: "Platinum",
    4: "Legend"
}

VIP_NAME_TO_ID = {v: k for k, v in VIP_STATUS_MAP.items() if k != 0}

VIP_PRICES = {
    "Silver": {"seeds": 100, "dc": 50},
    "Gold": {"seeds": 150, "dc": 100},
    "Platinum": {"seeds": 200, "dc": 200},
    "Legend": {"seeds": 500, "dc": 799},
}
VIP_DAYS = [1, 3, 7, 15, 30]


def get_user_data(user_id: str):
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT * FROM users WHERE user_id = ?", (user_id,))
    row = cursor.fetchone()

    if row is None:
        conn.close()
        return None

    keys = [desc[0] for desc in cursor.description]
    user_data = dict(zip(keys, row))

    conn.close()
    return user_data


def create_user_if_not_exists(user_id: str, username: str, first_name: str):
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("INSERT OR IGNORE INTO users (user_id, username, first_name) VALUES (?, ?, ?)",
                   (user_id, username, first_name))
    conn.commit()
    conn.close()


def update_vip_status(user_id: str, vip_id: int, duration_days: int):
    """–û–±–Ω–æ–≤–ª—è–µ–º vip_status –∏ vip_until (timestamp)"""
    vip_until = int(time.time()) + duration_days * 86400
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("UPDATE users SET vip_status = ?, vip_until = ? WHERE user_id = ?", (vip_id, vip_until, user_id))
    conn.commit()
    conn.close()


def reduce_seeds(user_id: str, amount: int) -> bool:
    """–í—ã—á–∏—Ç–∞—Ç—å —Å–µ–º–µ–Ω–∞, –≤–µ—Ä–Ω—É—Ç—å True –µ—Å–ª–∏ —É—Å–ø–µ—à–Ω–æ, False –µ—Å–ª–∏ —Å–µ–º—è–Ω –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç"""
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT seeds FROM users WHERE user_id = ?", (user_id,))
    row = cursor.fetchone()
    if row is None or row[0] < amount:
        conn.close()
        return False
    new_balance = row[0] - amount
    cursor.execute("UPDATE users SET seeds = ? WHERE user_id = ?", (new_balance, user_id))
    conn.commit()
    conn.close()
    return True


def escape_markdown_v2(text: str) -> str:
    escape_chars = r"\_*[]()~`>#+-=|{}.!"
    return ''.join(['\\' + c if c in escape_chars else c for c in text])


def format_mention(user):
    name = user.first_name or "User"
    escapes = r"\_*~`>#-+!=|{}."
    for ch in escapes:
        name = name.replace(ch, "\\" + ch)
    return f"[{name}](tg://user?id={user.id})"


async def vip_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    user_id = str(user.id)

    user_data = get_uservip_data(user_id)
    vip_id = user_data.get("vip_status", 0)
    vip_until = user_data.get("vip_until", 0)
    now = int(time.time())

    if vip_until < now:
        vip_id = 0

    # HTML-—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
    user_mention = user.mention_html()
    vip_status = VIP_STATUS_MAP.get(vip_id, '–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç')

    text = (
        f"<b>üíé –ü–æ–∫—É–ø–∫–∞ VIP-–°—Ç–∞—Ç—É—Å–∞</b>\n"
        f"<b>üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</b> {user_mention}\n"
        f"<b>‚≠ê –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å:</b> <i>{vip_status}</i>\n\n"
        f"üîΩ <b>–í—ã–±–µ—Ä–∏—Ç–µ VIP-—Å—Ç–∞—Ç—É—Å –Ω–∏–∂–µ:</b>"
    )

    keyboard = [[
        InlineKeyboardButton(f"{status}", callback_data=f"vip_status_{status}")
    ] for status in VIP_STATUS_MAP.values() if status != '–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç']

    sent_message = await update.message.reply_text(
        text,
        reply_markup=InlineKeyboardMarkup(keyboard),
        parse_mode="HTML"
    )

    context.user_data['vip_owner_id'] = user.id
    context.user_data['vip_message_id'] = sent_message.message_id


async def vip_status_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    owner_id = context.user_data.get('vip_owner_id')
    message_id = context.user_data.get('vip_message_id')

    if query.from_user.id != owner_id or query.message.message_id != message_id:
        await query.answer("‚ùå –í—ã –Ω–µ –º–æ–∂–µ—Ç–µ —É–ø—Ä–∞–≤–ª—è—Ç—å —ç—Ç–∏–º –º–µ–Ω—é", show_alert=True)
        return

    user = update.effective_user
    user_id = str(user.id)

    user_data = get_uservip_data(user_id)
    vip_id = user_data.get("vip_status", 0)
    vip_until = user_data.get("vip_until", 0)
    now = int(time.time())
    if vip_until < now:
        vip_id = 0
    if vip_id != 0:
        await query.edit_message_text("<b>‚ùå –£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å VIP —Å—Ç–∞—Ç—É—Å.\n–ü–æ–∫—É–ø–∫–∞ –¥—Ä—É–≥–æ–≥–æ –∑–∞–ø—Ä–µ—â–µ–Ω–∞.</b>",
                                      parse_mode="HTML")
        return

    data = query.data  # –Ω–∞–ø—Ä–∏–º–µ—Ä, "vip_status_Legend"
    _, _, chosen_status = data.split("_")

    context.user_data["vip_chosen_status"] = chosen_status

    user_mention = user.mention_html()
    current_status = VIP_STATUS_MAP.get(vip_id, '–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç')

    text = (
        f"<b>üíé VIP-–°—Ç–∞—Ç—É—Å | {user_mention}</b>\n"
        f"<b>‚≠ê –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å:</b> <i>{current_status}</i>\n"
        f"<b>üéØ –í—ã–±—Ä–∞–Ω–æ:</b> <i>{chosen_status}</i>\n"
        "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
        "<b>‚è≥ –ù–∞ —Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π —Ö–æ—Ç–∏—Ç–µ –∫—É–ø–∏—Ç—å —Å—Ç–∞—Ç—É—Å?</b>"
    )

    keyboard = [[
        InlineKeyboardButton(f"{days} –¥–Ω.", callback_data=f"vip_days_{days}")
    ] for days in VIP_DAYS]

    keyboard.append([InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="vip_back")])

    await query.edit_message_text(
        text,
        reply_markup=InlineKeyboardMarkup(keyboard),
        parse_mode="HTML"
    )


async def vip_days_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    owner_id = context.user_data.get('vip_owner_id')
    message_id = context.user_data.get('vip_message_id')

    if query.from_user.id != owner_id or query.message.message_id != message_id:
        await query.answer("‚ùå –í—ã –Ω–µ –º–æ–∂–µ—Ç–µ —É–ø—Ä–∞–≤–ª—è—Ç—å —ç—Ç–∏–º –º–µ–Ω—é", show_alert=True)
        return

    user = update.effective_user
    user_id = str(user.id)

    user_data = get_uservip_data(user_id)
    vip_id = user_data.get("vip_status", 0)
    vip_until = user_data.get("vip_until", 0)
    now = int(time.time())
    if vip_until < now:
        vip_id = 0
    if vip_id != 0:
        await query.edit_message_text("<b>‚ùå –£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å VIP —Å—Ç–∞—Ç—É—Å.\n–ü–æ–∫—É–ø–∫–∞ –¥—Ä—É–≥–æ–≥–æ –∑–∞–ø—Ä–µ—â–µ–Ω–∞.</b>",
                                      parse_mode="HTML")
        return

    data = query.data  # –Ω–∞–ø—Ä–∏–º–µ—Ä, "vip_days_7"
    _, _, chosen_days_str = data.split("_")
    chosen_days = int(chosen_days_str)

    chosen_status = context.user_data.get("vip_chosen_status")
    if not chosen_status:
        await query.edit_message_text("<b>‚ö†Ô∏è –û—à–∏–±–∫–∞:</b> —Å—Ç–∞—Ç—É—Å –Ω–µ –≤—ã–±—Ä–∞–Ω. –í–µ—Ä–Ω–∏—Ç–µ—Å—å –Ω–∞–∑–∞–¥ –∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ç—É—Å.")
        return

    price_seeds = VIP_PRICES[chosen_status]["seeds"] * chosen_days
    price_dc = VIP_PRICES[chosen_status]["dc"] * chosen_days

    user_mention = user.mention_html()
    current_status = VIP_STATUS_MAP.get(vip_id, '–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç')

    text = (
        f"<b>üíé VIP | {user_mention}</b>\n"
        f"<b>‚≠ê –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å:</b> <i>{current_status}</i>\n"
        f"<b>üéØ –í—ã–±—Ä–∞–Ω–æ:</b> <i>{chosen_status}</i>\n"
        f"<b>‚è≥ –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è:</b> <i>{chosen_days} –¥–Ω.</i>\n"
        "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
        f"<b>üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å:</b>\n"
        f"üå± <i>—Å–µ–º–µ–Ω–∞:</i> <b>{price_seeds}</b>\n"
        f"ü™ô <i>DigitalCoins:</i> <b>{price_dc}</b>"
    )

    keyboard = [
        [InlineKeyboardButton("üíé –ö—É–ø–∏—Ç—å –∑–∞ —Å–µ–º–µ–Ω–∞", callback_data="vip_buy_seeds")],
        [InlineKeyboardButton("ü™ô –ö—É–ø–∏—Ç—å –∑–∞ DigitalCoins", callback_data="vip_buy_dc")],
        [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="vip_days_back")],
    ]

    context.user_data["vip_chosen_days"] = chosen_days

    await query.edit_message_text(
        text,
        reply_markup=InlineKeyboardMarkup(keyboard),
        parse_mode="HTML"
    )


def get_uservip_data(user_id):
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT vip_status, vip_until FROM users WHERE user_id=?", (user_id,))
    row = cursor.fetchone()
    conn.close()
    if row:
        return {"vip_status": row[0], "vip_until": row[1]}
    return {"vip_status": 0, "vip_until": 0}


async def vip_buy_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    owner_id = context.user_data.get('vip_owner_id')
    message_id = context.user_data.get('vip_message_id')

    if query.from_user.id != owner_id or query.message.message_id != message_id:
        await query.answer("‚ùå –í—ã –Ω–µ –º–æ–∂–µ—Ç–µ —É–ø—Ä–∞–≤–ª—è—Ç—å —ç—Ç–∏–º –º–µ–Ω—é", show_alert=True)
        return

    user = update.effective_user
    user_id = str(user.id)

    user_data = get_uservip_data(user_id)
    vip_id = user_data.get("vip_status", 0)
    vip_until = user_data.get("vip_until", 0)
    now = int(time.time())
    if vip_until < now:
        vip_id = 0
    if vip_id != 0:
        await query.edit_message_text(
            "<b>‚ùå –£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å VIP —Å—Ç–∞—Ç—É—Å.\n–ü–æ–∫—É–ø–∫–∞ –¥—Ä—É–≥–æ–≥–æ –∑–∞–ø—Ä–µ—â–µ–Ω–∞.</b>", parse_mode="HTML"
        )
        return

    chosen_status = context.user_data.get("vip_chosen_status")
    chosen_days = context.user_data.get("vip_chosen_days")

    if not chosen_status or not chosen_days:
        await query.edit_message_text(
            "<b>‚ö†Ô∏è –û—à–∏–±–∫–∞:</b> —Å—Ç–∞—Ç—É—Å –∏–ª–∏ –¥–Ω–∏ –Ω–µ –≤—ã–±—Ä–∞–Ω—ã. –ù–∞—á–Ω–∏—Ç–µ –∑–∞–Ω–æ–≤–æ.", parse_mode="HTML"
        )
        return

    price_seeds = VIP_PRICES[chosen_status]["seeds"] * chosen_days
    price_dc = VIP_PRICES[chosen_status]["dc"] * chosen_days

    data = query.data  # vip_buy_seeds –∏–ª–∏ vip_buy_dc

    if data == "vip_buy_seeds":
        if not reduce_seeds(user_id, price_seeds):
            await query.edit_message_text("<b>‚ùå –£ –≤–∞—Å –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å–µ–º—è–Ω –¥–ª—è –ø–æ–∫—É–ø–∫–∏.</b>", parse_mode="HTML")
            return
        payment_method = "—Å–µ–º–µ–Ω–∞ üå±"

    elif data == "vip_buy_dc":
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º dc_balance, –∞ –Ω–µ balance
        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()
        cursor.execute("SELECT dc_balance FROM users WHERE user_id = ?", (user_id,))
        row = cursor.fetchone()
        if row is None or row[0] < price_dc:
            conn.close()
            await query.edit_message_text("<b>‚ùå –£ –≤–∞—Å –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ DigitalCoins –¥–ª—è –ø–æ–∫—É–ø–∫–∏.</b>", parse_mode="HTML")
            return
        new_balance = row[0] - price_dc
        cursor.execute("UPDATE users SET dc_balance = ? WHERE user_id = ?", (new_balance, user_id))
        conn.commit()
        conn.close()
        payment_method = "DigitalCoins ü™ô"

    else:
        await query.edit_message_text("<b>‚ö†Ô∏è –û—à–∏–±–∫–∞:</b> –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –º–µ—Ç–æ–¥ –æ–ø–ª–∞—Ç—ã.", parse_mode="HTML")
        return

    vip_id_new = VIP_NAME_TO_ID[chosen_status]
    update_vip_status(user_id, vip_id_new, chosen_days)

    await query.edit_message_text(
        f"üéâ <b>–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!</b>\n\n"
        f"–í—ã —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–æ–±—Ä–µ–ª–∏ VIP —Å—Ç–∞—Ç—É—Å: <i>{chosen_status}</i>\n"
        f"–°—Ä–æ–∫: <b>{chosen_days} –¥–Ω.</b>.\n"
        f"üí≥ –°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã: {payment_method}",
        parse_mode="HTML"
    )


async def vip_back_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    owner_id = context.user_data.get('vip_owner_id')
    message_id = context.user_data.get('vip_message_id')

    if query.from_user.id != owner_id or query.message.message_id != message_id:
        await query.answer("‚ùå –í—ã –Ω–µ –º–æ–∂–µ—Ç–µ —É–ø—Ä–∞–≤–ª—è—Ç—å —ç—Ç–∏–º –º–µ–Ω—é", show_alert=True)
        return

    user = update.effective_user
    user_id = str(user.id)

    user_data = get_uservip_data(user_id)
    vip_id = user_data.get("vip_status", 0)
    vip_until = user_data.get("vip_until", 0)
    now = int(time.time())
    if vip_until < now:
        vip_id = 0

    # –ò—Å–ø–æ–ª—å–∑—É–µ–º HTML, –∞ –Ω–µ MarkdownV2
    text = (
        f"üåü <b>VIP –ú–µ–Ω—é –¥–ª—è:</b> {user.first_name}\n"
        f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
        f"üîπ <b>–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å:</b> {VIP_STATUS_MAP.get(vip_id, '–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç')}\n\n"
        "‚ú® <i>–í—ã–±–µ—Ä–∏—Ç–µ –∂–µ–ª–∞–µ–º—ã–π VIP-—Å—Ç–∞—Ç—É—Å –∏–∑ —Å–ø–∏—Å–∫–∞ –Ω–∏–∂–µ:</i>"
    )

    keyboard = [
        [InlineKeyboardButton(status, callback_data=f"vip_status_{status}")]
        for status in VIP_STATUS_MAP.values() if status != '–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'
    ]

    await query.edit_message_text(
        text,
        reply_markup=InlineKeyboardMarkup(keyboard),
        parse_mode="HTML"  # ‚Üê –ø–æ–º–µ–Ω—è–ª
    )


async def offvip_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    user_id = str(user.id)
    user_mention = f'<a href="tg://user?id={user.id}">{user.first_name}</a>'

    # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π VIP —Å—Ç–∞—Ç—É—Å –∏–∑ –±–∞–∑—ã
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT vip_status FROM users WHERE user_id = ?", (user_id,))
    row = cursor.fetchone()
    conn.close()

    vip_status_id = row[0] if row else 0
    vip_status_name = VIP_STATUS_MAP.get(vip_status_id, "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ")

    text = (
        "üîª <b>–û—Ç–∫–ª—é—á–µ–Ω–∏–µ VIP –°—Ç–∞—Ç—É—Å–∞</b>\n"
        f"üë§ {user_mention}\n"
        f"–í–∞—à —Å—Ç–∞—Ç—É—Å: <b>{vip_status_name}</b>\n\n"
        "‚ùó –í—ã —Ç–æ—á–Ω–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–∫–ª—é—á–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É?\n"
        "<pre>–ü–æ—Å–ª–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è —Å—Ä–µ–¥—Å—Ç–≤–∞ –∑–∞ –ø–æ–¥–ø–∏—Å–∫—É –ù–ï –±—É–¥—É—Ç –≤–æ–∑–≤—Ä–∞—â–µ–Ω—ã.</pre>"
    )

    keyboard = InlineKeyboardMarkup([
        [InlineKeyboardButton("üî¥ –û—Ç–∫–ª—é—á–∏—Ç—å", callback_data="vip_off_confirm")],
        [InlineKeyboardButton("üîô –û—Ç–º–µ–Ω–∞", callback_data="vip_off_cancel")]
    ])

    await update.message.reply_text(
        text=text,
        reply_markup=keyboard,
        parse_mode="HTML"
    )


async def vip_off_callback_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    user_id = str(query.from_user.id)

    if query.data == "vip_off_confirm":
        # –û–±–Ω—É–ª–∏—Ç—å —Å—Ç–∞—Ç—É—Å –≤ –ë–î
        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()
        cursor.execute("UPDATE users SET vip_status = 0, vip_until = 0 WHERE user_id = ?", (user_id,))
        conn.commit()
        conn.close()

        await query.edit_message_text("‚úÖ –í–∞—à VIP —Å—Ç–∞—Ç—É—Å –±—ã–ª —É—Å–ø–µ—à–Ω–æ –æ—Ç–∫–ª—é—á—ë–Ω.")
    elif query.data == "vip_off_cancel":
        await query.edit_message_text("‚ùå –û—Ç–∫–ª—é—á–µ–Ω–∏–µ VIP –æ—Ç–º–µ–Ω–µ–Ω–æ.")

    await query.answer()


async def myvip_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    user_id = str(user.id)
    user_data = get_uservip_data(user_id)

    vip_id = user_data.get("vip_status", 0)
    vip_until_ts = user_data.get("vip_until", 0)
    now_ts = int(time.time())

    if vip_until_ts > now_ts and vip_id > 0:
        vip_status = VIP_STATUS_MAP.get(vip_id, "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ")
        vip_until_dt = datetime.fromtimestamp(vip_until_ts)
        time_left_sec = vip_until_ts - now_ts

        days_left = time_left_sec // 86400
        hours_left = (time_left_sec % 86400) // 3600
        minutes_left = (time_left_sec % 3600) // 60

        time_left_str = f"{days_left}–¥ {hours_left}—á {minutes_left}–º"
        vip_until_str = vip_until_dt.strftime("%d.%m.%Y %H:%M")

        text = (
            f"‚ú® <b>VIP –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</b> ‚ú®\n"
            f"üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: <a href=\"tg://user?id={user.id}\">{html.escape(user.first_name)}</a>\n"
            f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
            f"üíé –°—Ç–∞—Ç—É—Å: <b>{html.escape(vip_status)}</b>\n"
            f"‚è≥ –î–µ–π—Å—Ç–≤—É–µ—Ç –¥–æ: <b>{vip_until_str}</b>\n"
            f"‚åõ –û—Å—Ç–∞–ª–æ—Å—å: <b>{time_left_str}</b>\n"
        )
    else:
        text = (
            f"‚ú® <b>VIP –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</b> ‚ú®\n"
            f"üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: <a href=\"tg://user?id={user.id}\">{html.escape(user.first_name)}</a>\n"
            f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
            f"üíé –°—Ç–∞—Ç—É—Å: <b>–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç</b>\n"
        )

    keyboard = InlineKeyboardMarkup([[
        InlineKeyboardButton("üéÅ –ü–ª—é—à–∫–∏ VIP", url="https://telegra.ph/VIP-Statusy-06-16")
    ]])

    await update.message.reply_text(
        text,
        reply_markup=keyboard,
        parse_mode="HTML"
    )


def get_balance(user_id: str) -> int:
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT balance FROM users WHERE user_id = ?", (user_id,))
    result = cursor.fetchone()
    conn.close()
    if result is None:
        # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç –≤ –±–∞–∑–µ, —Å—á–∏—Ç–∞–µ–º –±–∞–ª–∞–Ω—Å 0
        return 0
    return result[0]


def update_balance(user_id: str, new_balance: int) -> None:
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç, —Å–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å —Å –Ω—É–∂–Ω—ã–º –±–∞–ª–∞–Ω—Å–æ–º
    cursor.execute("SELECT 1 FROM users WHERE user_id = ?", (user_id,))
    if cursor.fetchone() is None:
        cursor.execute(
            "INSERT INTO users (user_id, balance) VALUES (?, ?)",
            (user_id, new_balance)
        )
    else:
        cursor.execute(
            "UPDATE users SET balance = ? WHERE user_id = ?",
            (new_balance, user_id)
        )
    conn.commit()
    conn.close()


active_events = {}


async def event_cust_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    args = context.args
    if len(args) < 3:
        await update.message.reply_text(
            "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:\n/event {—Å—É–º–º–∞} {–∫–æ–ª-–≤–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –æ—Ç 2 –¥–æ 10} {–Ω–∞–∑–≤–∞–Ω–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è}")
        return

    try:
        prize = int(args[0])
        max_participants = int(args[1])
        if max_participants < 2 or max_participants > 10:
            await update.message.reply_text("–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç 2 –¥–æ 10.")
            return
    except ValueError:
        await update.message.reply_text("–°—É–º–º–∞ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —á–∏—Å–ª–∞–º–∏.")
        return

    title = " ".join(args[2:])
    creator_id = update.message.from_user.id
    chat_id = update.effective_chat.id

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É–∂–µ –∞–∫—Ç–∏–≤–Ω–æ–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ
    for event in active_events.values():
        if event["creator_id"] == creator_id:
            await update.message.reply_text(
                "‚ùå –í—ã —É–∂–µ —Å–æ–∑–¥–∞–ª–∏ –∞–∫—Ç–∏–≤–Ω–æ–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ. –ó–∞–≤–µ—Ä—à–∏—Ç–µ –µ–≥–æ, –ø—Ä–µ–∂–¥–µ —á–µ–º —Å–æ–∑–¥–∞–≤–∞—Ç—å –Ω–æ–≤–æ–µ.")
            return

    # –°–æ–∑–¥–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–æ–π "–£—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å"
    text = (
        f"üéâ <b>–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ</b> üéâ\n\n"
        f"üè¶ <b>–ù–∞–∑–≤–∞–Ω–∏–µ:</b> <i>{title}</i>\n"
        f'üë§ <b>–°–æ–∑–¥–∞—Ç–µ–ª—å:</b> <a href="tg://user?id={creator_id}">{update.message.from_user.full_name}</a>\n'
        f"üë• <b>–ú–∞–∫—Å–∏–º—É–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤:</b> {max_participants}\n"
        f"üèÜ <b>–ü—Ä–∏–∑:</b> {prize} üí∞\n"
        f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
        f"üìù <b>–£—á–∞—Å—Ç–Ω–∏–∫–∏:</b> (—Ç–µ–∫—É—â–∏—Ö 0)\n\n"
        f"<pre>‚ö†Ô∏è –°–æ–∑–¥–∞—Ç–µ–ª—å –Ω–µ –º–æ–∂–µ—Ç —É—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å!</pre>"
    )

    keyboard = InlineKeyboardMarkup([
        [InlineKeyboardButton("‚úÖ –£—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å", callback_data="event_join")]
    ])

    sent_message = await update.message.reply_text(text, reply_markup=keyboard, parse_mode="HTML")

    event_id = (chat_id, sent_message.message_id)

    # –û—Ç–º–µ–Ω—è–µ–º —Å—Ç–∞—Ä–æ–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –≤ —Ç–æ–º –∂–µ —á–∞—Ç–µ (–µ—Å–ª–∏ –µ—Å—Ç—å)
    if event_id in active_events:
        active_events[event_id]["timeout_task"].cancel()

    # –°–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è
    active_events[event_id] = {
        "chat_id": chat_id,
        "message_id": sent_message.message_id,
        "creator_id": creator_id,
        "prize": prize,
        "max_participants": max_participants,
        "title": title,
        "participants": set(),
        "start_time": int(time.time()),
        "timeout_task": None
    }

    # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä —Ä–æ–∑—ã–≥—Ä—ã—à–∞ (—á–µ—Ä–µ–∑ 10 –º–∏–Ω—É—Ç)
    async def finish_event_later():
        await asyncio.sleep(10 * 60)  # 10 –º–∏–Ω—É—Ç
        await finish_event(event_id, context)

    task = asyncio.create_task(finish_event_later())
    active_events[event_id]["timeout_task"] = task


async def finish_event(event_id, context: ContextTypes.DEFAULT_TYPE):
    event = active_events.get(event_id)
    if not event:
        return

    chat_id = event["chat_id"]
    message_id = event["message_id"]
    participants = event["participants"]
    creator_id = event["creator_id"]
    prize = event["prize"]
    title = event["title"]

    # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–∞–º–∏
    try:
        await context.bot.delete_message(chat_id, message_id)
    except Exception:
        pass

    if len(participants) == 0:
        text = f"‚ùå *–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ \"{title}\" –æ—Ç–º–µ–Ω–µ–Ω–æ* ‚Äî –Ω–∏–∫—Ç–æ –Ω–µ —É—á–∞—Å—Ç–≤–æ–≤–∞–ª."
    else:
        winner_id = random.choice(list(participants))

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–ª–∞–Ω—Å —Å–æ–∑–¥–∞—Ç–µ–ª—è
        creator_balance = get_user_balance(creator_id)  # –ò–∑–º–µ–Ω–µ–Ω–æ –Ω–∞ get_user_balance
        if creator_balance < prize:
            text = (
                f"‚ùå *–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ \"{title}\" –æ—Ç–º–µ–Ω–µ–Ω–æ* ‚Äî —É —Å–æ–∑–¥–∞—Ç–µ–ª—è –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –¥–ª—è –≤—ã–ø–ª–∞—Ç—ã –ø—Ä–∏–∑–∞."
            )
        else:
            # –°–ø–∏—Å—ã–≤–∞–µ–º —É —Å–æ–∑–¥–∞—Ç–µ–ª—è
            update_user_balance(creator_id, -prize)  # –ò–∑–º–µ–Ω–µ–Ω–æ –Ω–∞ update_user_balance

            # –ù–∞—á–∏—Å–ª—è–µ–º –ø–æ–±–µ–¥–∏—Ç–µ–ª—é
            update_user_balance(winner_id, prize)  # –ò–∑–º–µ–Ω–µ–Ω–æ –Ω–∞ update_user_balance

            # –ü–æ–ª—É—á–∞–µ–º –∏–º—è –ø–æ–±–µ–¥–∏—Ç–µ–ª—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
            winner_chat = await context.bot.get_chat(winner_id)
            winner_name = winner_chat.full_name

            text = (
                f"üèÜ *–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è*\n\n"
                f"üé´ *–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ:* {title}\n"
                f"üí∞ *–ü—Ä–∏–∑:* {prize}\n\n"
                f"ü•≥ *–ü–æ–±–µ–¥–∏—Ç–µ–ª—å:* [{winner_name}](tg://user?id={winner_id}) üéâ"
            )

    await context.bot.send_message(chat_id, text, parse_mode="Markdown")

    # –£–¥–∞–ª—è–µ–º –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –∏–∑ –∞–∫—Ç–∏–≤–Ω—ã—Ö
    del active_events[event_id]


async def event_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    chat_id = query.message.chat_id
    message_id = query.message.message_id
    user_id = query.from_user.id

    event_id = (chat_id, message_id)
    event = active_events.get(event_id)
    if not event:
        await query.edit_message_text("‚ùå *–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ —É–∂–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ –∏–ª–∏ –æ—Ç–º–µ–Ω–µ–Ω–æ.*", parse_mode="Markdown")
        return

    if user_id == event["creator_id"]:
        await query.answer("‚ùå –°–æ–∑–¥–∞—Ç–µ–ª—å –Ω–µ –º–æ–∂–µ—Ç —É—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å!", show_alert=True)
        return

    if user_id in event["participants"]:
        await query.answer("‚ùå –í—ã —É–∂–µ —É—á–∞—Å—Ç–≤—É–µ—Ç–µ!", show_alert=True)
        return

    event["participants"].add(user_id)

    if event["participants"]:
        participants_names = []
        for i, uid in enumerate(event["participants"]):
            chat = await context.bot.get_chat(uid)
            # HTML —Å—Å—ã–ª–∫–∞
            participants_names.append(f"{i + 1}. <a href='tg://user?id={uid}'>{chat.full_name}</a>")
        participants_list = "\n".join(participants_names)
    else:
        participants_list = "<i>–ø–æ–∫–∞ –Ω–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</i>"

    creator_chat = await context.bot.get_chat(event['creator_id'])

    text = (
        f"üéâ <b>–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ:</b>\n\n"
        f"üè¶ <b>–ù–∞–∑–≤–∞–Ω–∏–µ:</b> <i>{event['title']}</i>\n"
        f"üë§ <b>–°–æ–∑–¥–∞–ª:</b> <a href='tg://user?id={event['creator_id']}'>{creator_chat.full_name}</a>\n"
        f"üë• <b>–ú–∞–∫—Å–∏–º—É–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤:</b> {event['max_participants']}\n"
        f"üèÜ <b>–ü—Ä–∏–∑:</b> {event['prize']} üí∞\n"
        f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
        f"üìù <b>–£—á–∞—Å—Ç–Ω–∏–∫–∏ ({len(event['participants'])}):</b>\n{participants_list}\n"
        f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
        f"<pre>‚ö†Ô∏è –°–æ–∑–¥–∞—Ç–µ–ª—å –Ω–µ –º–æ–∂–µ—Ç —É—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å!</pre>"
    )

    if len(event["participants"]) >= event["max_participants"]:
        event["timeout_task"].cancel()
        await finish_event(event_id, context)
    else:
        await query.edit_message_text(text, reply_markup=query.message.reply_markup, parse_mode="HTML")


def get_user_balance(user_id: int) -> int:
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT balance FROM users WHERE user_id=?", (str(user_id),))
    row = cursor.fetchone()
    conn.close()
    return row[0] if row else 0


def update_user_balance(user_id: int, amount: int):
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT balance FROM users WHERE user_id=?", (str(user_id),))
    row = cursor.fetchone()
    if not row:
        start_balance = max(0, amount)
        cursor.execute("INSERT INTO users (user_id, balance) VALUES (?, ?)", (str(user_id), start_balance))
    else:
        new_balance = row[0] + amount
        if new_balance < 0:
            new_balance = 0
        cursor.execute("UPDATE users SET balance=? WHERE user_id=?", (new_balance, str(user_id)))
    conn.commit()
    conn.close()


def get_user_vip_status(user_id: int) -> int:
    """–ü–æ–ª—É—á–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π VIP —É—Ä–æ–≤–µ–Ω—å"""
    user_id = int(user_id)
    now_ts = int(time.time())

    vip_data = get_uservip_data(user_id)
    vip_status = vip_data.get("vip_status", 0)
    vip_until = vip_data.get("vip_until", 0)

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ –∏—Å—Ç—ë–∫ –ª–∏ VIP
    if vip_until > now_ts and vip_status > 0:
        return vip_status  # VIP –∞–∫—Ç–∏–≤–µ–Ω
    else:
        return 0  # VIP –∏—Å—Ç—ë–∫ –∏–ª–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω

def debug_vip_for_user(user_id: int):
    """–ü–æ–ª–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ VIP —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    user_id = str(user_id)

    print(f"\n{'='*60}")
    print(f"üîç –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê VIP –°–¢–ê–¢–£–°–ê –î–õ–Ø {user_id}")
    print(f"{'='*60}\n")

    try:
        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()

        # 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        print("1Ô∏è‚É£  –ü–†–û–í–ï–†–ö–ê –°–£–©–ï–°–¢–í–û–í–ê–ù–ò–Ø –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø:")
        cursor.execute("SELECT user_id, username, first_name FROM users WHERE user_id = ?", (user_id,))
        user_row = cursor.fetchone()

        if user_row is None:
            print(f"   ‚ùå –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨ –ù–ï –ù–ê–ô–î–ï–ù –í –ë–î!")
            conn.close()
            return False

        print(f"   ‚úÖ –ù–∞–π–¥–µ–Ω: {user_row[1] or user_row[2] or user_id}")

        # 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–ª–æ–Ω–∫—É vip_level
        print("\n2Ô∏è‚É£  –ü–†–û–í–ï–†–ö–ê –ö–û–õ–û–ù–ö–ò vip_level:")
        cursor.execute("PRAGMA table_info(users)")
        columns = cursor.fetchall()
        vip_column_exists = any(col[1] == 'vip_level' for col in columns)

        if not vip_column_exists:
            print(f"   ‚ùå –ö–û–õ–û–ù–ö–ê vip_level –ù–ï –°–£–©–ï–°–¢–í–£–ï–¢!")
            print(f"   üìã –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–æ–ª–æ–Ω–∫–∏: {[col[1] for col in columns]}")
            conn.close()
            return False

        print(f"   ‚úÖ –ö–æ–ª–æ–Ω–∫–∞ vip_level —Å—É—â–µ—Å—Ç–≤—É–µ—Ç")

        # 3. –ü–æ–ª—É—á–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ vip_level
        print("\n3Ô∏è‚É£  –ó–ù–ê–ß–ï–ù–ò–ï VIP_LEVEL:")
        cursor.execute("SELECT vip_level FROM users WHERE user_id = ?", (user_id,))
        vip_row = cursor.fetchone()

        if vip_row is None:
            print(f"   ‚ùå –û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å vip_level")
            conn.close()
            return False

        vip_value = vip_row[0]
        print(f"   –ó–Ω–∞—á–µ–Ω–∏–µ: {vip_value}")
        print(f"   –¢–∏–ø: {type(vip_value).__name__}")

        # 4. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ
        print("\n4Ô∏è‚É£  –ê–ù–ê–õ–ò–ó –ó–ù–ê–ß–ï–ù–ò–Ø:")

        if vip_value is None:
            print(f"   ‚ö†Ô∏è  vip_level = NULL (–ø—É—Å—Ç–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ)")
            print(f"   üìå –†–µ—à–µ–Ω–∏–µ: –ù—É–∂–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ –æ—Ç 0 –¥–æ 4")
            return False

        try:
            vip_int = int(vip_value)
            print(f"   ‚úÖ –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–æ –≤ int: {vip_int}")

            if vip_int < 0 or vip_int > 4:
                print(f"   ‚ö†Ô∏è  –ù–ï–ö–û–†–†–ï–ö–¢–ù–û–ï –ó–ù–ê–ß–ï–ù–ò–ï: {vip_int}")
                print(f"   üìå –î–æ–ø—É—Å—Ç–∏–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è: 0-4")
                return False

            vip_names = {
                0: "–û–±—ã—á–Ω—ã–π",
                1: "VIP Silver",
                2: "VIP Gold",
                3: "VIP Platinum",
                4: "VIP Legend"
            }
            print(f"   ‚úÖ –°—Ç–∞—Ç—É—Å: {vip_names[vip_int]}")

        except ValueError:
            print(f"   ‚ùå –û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å '{vip_value}' –≤ —á–∏—Å–ª–æ")
            return False

        # 5. –ü—Ä–æ–≤–µ—Ä—è–µ–º VIP_EXPIRY –µ—Å–ª–∏ –µ—Å—Ç—å
        print("\n5Ô∏è‚É£  –ü–†–û–í–ï–†–ö–ê VIP_EXPIRY:")
        cursor.execute("SELECT vip_expiry FROM users WHERE user_id = ?", (user_id,))
        expiry_row = cursor.fetchone()

        if expiry_row and expiry_row[0]:
            print(f"   –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è: {expiry_row[0]}")
            try:
                expiry_dt = datetime.fromisoformat(expiry_row[0])
                if datetime.now() > expiry_dt:
                    print(f"   ‚ö†Ô∏è  VIP –ò–°–¢–Å–ö! –ù—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å")
                else:
                    print(f"   ‚úÖ VIP –µ—â—ë –∞–∫—Ç–∏–≤–µ–Ω –¥–æ {expiry_dt.strftime('%d.%m.%Y %H:%M')}")
            except:
                print(f"   ‚ö†Ô∏è  –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã")
        else:
            print(f"   ‚ÑπÔ∏è  –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")

        conn.close()
        print(f"\n{'='*60}")
        print(f"‚úÖ –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê –£–°–ü–ï–®–ù–û")
        print(f"{'='*60}\n")
        return True

    except Exception as e:
        print(f"\n   ‚ùå –û–®–ò–ë–ö–ê –ë–î: {e}")
        print(f"{'='*60}\n")
        return False



def get_user_last_robbing(user_id: int) -> int:
    """
    –ü–æ–ª—É—á–∏—Ç—å –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–≥—Ä–∞–±–ª–µ–Ω–∏—è
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç timestamp (int) –∏–ª–∏ 0 –µ—Å–ª–∏ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –≥—Ä–∞–±–∏–ª
    """
    user_id = str(user_id)
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT last_robbery FROM robbery_data WHERE user_id = ?", (user_id,))
    row = cursor.fetchone()
    conn.close()

    if row is None:
        return 0  # –ó–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞

    last_robbery = row[0]

    # –ï—Å–ª–∏ —ç—Ç–æ NULL –∏–ª–∏ None, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º 0
    if last_robbery is None:
        return 0

    # –ï—Å–ª–∏ —ç—Ç–æ —Å—Ç—Ä–æ–∫–∞ —Å –¥–∞—Ç–æ–π (TIMESTAMP), –ø–∞—Ä—Å–∏–º –µ—ë
    if isinstance(last_robbery, str):
        try:
            # –ü–∞—Ä—Å–∏–º —Ñ–æ—Ä–º–∞—Ç: '2024-01-15 12:30:45'
            dt = datetime.strptime(last_robbery, "%Y-%m-%d %H:%M:%S")
            return int(dt.timestamp())
        except:
            return 0

    # –ï—Å–ª–∏ —ç—Ç–æ —É–∂–µ —á–∏—Å–ª–æ
    if isinstance(last_robbery, int):
        return last_robbery

    return 0


def update_user_last_robbing(user_id: int) -> bool:
    """
    –û–±–Ω–æ–≤–∏—Ç—å –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–≥—Ä–∞–±–ª–µ–Ω–∏—è –Ω–∞ —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è
    –í–ê–ñ–ù–û: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç UNIX timestamp (int)
    """
    user_id = str(user_id)
    now_ts = int(time.time())

    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    try:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –∑–∞–ø–∏—Å—å
        cursor.execute("SELECT 1 FROM robbery_data WHERE user_id = ?", (user_id,))
        exists = cursor.fetchone() is not None

        if exists:
            # –û–±–Ω–æ–≤–ª—è–µ–º
            cursor.execute(
                "UPDATE robbery_data SET last_robbery = ? WHERE user_id = ?",
                (now_ts, user_id)
            )
        else:
            # –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å
            cursor.execute(
                "INSERT INTO robbery_data (user_id, last_robbery) VALUES (?, ?)",
                (user_id, now_ts)
            )

        conn.commit()
        print(f"‚úÖ Updated last_robbery for {user_id} to {now_ts}")
        return True

    except Exception as e:
        print(f"‚ùå Error updating last_robbery: {e}")
        return False
    finally:
        conn.close()


def get_robbing_cooldown(vip_status: int) -> int:
    """–ü–æ–ª—É—á–∏—Ç—å cooldown –≤ —Å–µ–∫—É–Ω–¥–∞—Ö –ø–æ VIP —É—Ä–æ–≤–Ω—é"""
    vip_status = int(vip_status)

    if vip_status == 1:
        return 50 * 60  # 50–º
    elif vip_status == 2:
        return 40 * 60  # 40–º
    elif vip_status == 3:
        return 30 * 60  # 30–º
    elif vip_status == 4:
        return 10 * 60  # 10–º
    else:
        return 60 * 60  # 60–º (–æ–±—ã—á–Ω—ã–π)


def format_number(num: int) -> str:
    return f"{num:,}".replace(",", ".")


def format_time(seconds: int) -> str:
    minutes, secs = divmod(seconds, 60)
    return f"{minutes} –º–∏–Ω {secs} —Å–µ–∫"


def format_datetime(dt_str):
    if not dt_str:
        return "‚Äî"
    try:
        dt = datetime.strptime(dt_str, "%Y-%m-%d %H:%M:%S")
        return dt.strftime("%d.%m.%Y | %H:%M")
    except:
        return "‚Äî"


def get_remaining_time(end_timestamp):
    if isinstance(end_timestamp, int):
        end_time = datetime.fromtimestamp(end_timestamp)
    else:
        end_time = datetime.strptime(end_timestamp, "%Y-%m-%d %H:%M:%S")

    now = datetime.now()
    remaining = end_time - now

    if remaining.total_seconds() <= 0:
        return None  # –≤–æ–∑–≤—Ä–∞—â–∞–µ–º None, –µ—Å–ª–∏ –≤—Ä–µ–º—è –∏—Å—Ç–µ–∫–ª–æ

    days = remaining.days
    hours, remainder = divmod(remaining.seconds, 3600)
    minutes, _ = divmod(remainder, 60)

    parts = []
    if days > 0:
        parts.append(f"{days}–¥")
    if hours > 0 or days > 0:
        parts.append(f"{hours}—á")
    parts.append(f"{minutes}–º")

    return " ".join(parts)


async def main_menu_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    user = query.from_user
    user_id = str(user.id)

    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("""
        SELECT total_stolen, last_robbery, total_attempts, success_attempts, immunity_active, immunity_end
        FROM robbery_data WHERE user_id = ?
    """, (user_id,))
    result = cursor.fetchone()
    conn.close()

    total_stolen = result[0] if result else 0
    last_robbery = result[1] if result else None
    total_attempts = result[2] if result else 0
    success_attempts = result[3] if result else 0
    immunity_active = result[4] if result else 0
    immunity_end = result[5] if result else None

    failed_attempts = total_attempts - success_attempts
    immunity_status = "üü¢" if immunity_active else "üî¥"

    display_name = get_display_name_html_new(user)

    text = (
        f"üî´ <b>–û–≥—Ä–∞–±–ª–µ–Ω–∏–µ</b> | {display_name}\n\n"
        f"üí∞ <b>–û–±—â–∞—è –Ω–∞–≥—Ä–∞–±–ª–µ–Ω–Ω–∞—è —Å—É–º–º–∞:</b> <code>{total_stolen:,}</code>\n"
        f"üïí <b>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–≥—Ä–∞–±–ª–µ–Ω–∏–µ:</b> <code>{format_datetime(last_robbery)}</code>\n"
        f"üìä <b>–í—Å–µ–≥–æ –æ–≥—Ä–∞–±–ª–µ–Ω–∏–π:</b> <code>{total_attempts}</code>\n"
        f"‚úÖ <b>–£—Å–ø–µ—à–Ω—ã—Ö:</b> <code>{success_attempts}</code>\n"
        f"‚ùå <b>–ù–µ—É—Å–ø–µ—à–Ω—ã—Ö:</b> <code>{failed_attempts}</code>\n"
        f"üõ°Ô∏è <b>–ò–º—É–Ω–∏—Ç–µ—Ç:</b> {immunity_status}"
    )

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∏–º–º—É–Ω–∏—Ç–µ—Ç–∞
    if immunity_active and immunity_end:
        remaining = get_remaining_time(immunity_end)
        if remaining:
            text += f"\n‚è≥ <b>–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è:</b> <code>{remaining}</code>"
        else:
            immunity_status = "üî¥"
            text = text.replace("üü¢", "üî¥")
            text += "\n‚è≥ <b>–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è:</b> <code>–ù–µ –∞–∫—Ç–∏–≤–Ω–æ</code>"

    keyboard = [
        [InlineKeyboardButton("üõ°Ô∏è –ò–º—É–Ω–∏—Ç–µ—Ç", callback_data="robbery_immunity")],
        [InlineKeyboardButton("üìÑ –°–ø–∏—Å–æ–∫ –æ–≥—Ä–∞–±–ª–µ–Ω–∏–π", callback_data="robbery_list")],
        [InlineKeyboardButton("üìä –¢–æ–ø –≥—Ä–∞–±–∏—Ç–µ–ª–µ–π", callback_data="robbery_top_menu")],
        [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="profile_menu")],
    ]

    await query.edit_message_text(text, parse_mode="HTML", reply_markup=InlineKeyboardMarkup(keyboard))


async def get_robbery_menu_text_and_keyboard(user_id: str, user) -> tuple[str, InlineKeyboardMarkup]:
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("""
        SELECT total_stolen, last_robbery, total_attempts, success_attempts, immunity_active, immunity_end
        FROM robbery_data WHERE user_id = ?
    """, (user_id,))
    result = cursor.fetchone()
    conn.close()

    total_stolen = result[0] if result else 0
    last_robbery = result[1] if result else None
    total_attempts = result[2] if result else 0
    success_attempts = result[3] if result else 0
    immunity_active = result[4] if result else 0
    immunity_end = result[5] if result else None

    failed_attempts = total_attempts - success_attempts
    immunity_status = "üü¢" if immunity_active else "üî¥"
    display_name = get_display_name_html_new(user)

    text = (
        f"üî´ <b>–û–≥—Ä–∞–±–ª–µ–Ω–∏–µ</b> | {display_name}\n\n"
        f"üí∞ <b>–û–±—â–∞—è –Ω–∞–≥—Ä–∞–±–ª–µ–Ω–Ω–∞—è —Å—É–º–º–∞:</b> <code>{total_stolen:,}</code>\n"
        f"üïí <b>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–≥—Ä–∞–±–ª–µ–Ω–∏–µ:</b> <code>{format_datetime(last_robbery)}</code>\n"
        f"üìä <b>–í—Å–µ–≥–æ –æ–≥—Ä–∞–±–ª–µ–Ω–∏–π:</b> <code>{total_attempts}</code>\n"
        f"‚úÖ <b>–£—Å–ø–µ—à–Ω—ã—Ö:</b> <code>{success_attempts}</code>\n"
        f"‚ùå <b>–ù–µ—É—Å–ø–µ—à–Ω—ã—Ö:</b> <code>{failed_attempts}</code>\n"
        f"üõ°Ô∏è <b>–ò–º—É–Ω–∏—Ç–µ—Ç:</b> {immunity_status}"
    )

    if immunity_active and immunity_end:
        remaining = get_remaining_time(immunity_end)
        text += f"\n‚è≥ <b>–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è:</b> <code>{remaining}</code>"

    keyboard = InlineKeyboardMarkup([
        [InlineKeyboardButton("üõ°Ô∏è –ò–º—É–Ω–∏—Ç–µ—Ç", callback_data="robbery_immunity")],
        [InlineKeyboardButton("üìÑ –°–ø–∏—Å–æ–∫ –æ–≥—Ä–∞–±–ª–µ–Ω–∏–π", callback_data="robbery_list")],
        [InlineKeyboardButton("üìä –¢–æ–ø –≥—Ä–∞–±–∏—Ç–µ–ª–µ–π", callback_data="robbery_top_menu")],
        [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="profile_menu")],
    ])

    return text, keyboard


async def robbery_open_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    user = query.from_user
    user_id = str(user.id)

    text, keyboard = await get_robbery_menu_text_and_keyboard(user_id, user)
    await query.answer()  # –£–±–∏—Ä–∞–µ–º —á–∞—Å–∏–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏

    try:
        # –ü—ã—Ç–∞–µ–º—Å—è –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
        await query.edit_message_text(text, parse_mode="HTML", reply_markup=keyboard)
    except:
        # –ï—Å–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–µ–ª—å–∑—è (—Å–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ), —É–¥–∞–ª—è–µ–º (–µ—Å–ª–∏ –µ—Å—Ç—å) –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ
        try:
            await query.message.delete()
        except:
            pass
        await query.message.chat.send_message(text=text, parse_mode="HTML", reply_markup=keyboard)


async def profile_open_ferniex_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await show_profile(update, context)


async def robbery_immunity_menu(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    user = query.from_user
    user_id = str(user.id)

    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT immunity_active, immunity_end FROM robbery_data WHERE user_id = ?", (user_id,))
    result = cursor.fetchone()
    conn.close()

    immunity_active = result[0] if result else 0
    immunity_end = result[1] if result else None
    immunity_status = "üü¢" if immunity_active else "üî¥"

    display_name = get_display_name_html_new(user)

    text = (
        f"üõ°Ô∏è <b>–ò–º–º—É–Ω–∏—Ç–µ—Ç</b> | {display_name}\n"
        f"üìå <b>–°—Ç–∞—Ç—É—Å:</b> {immunity_status}"
    )

    if immunity_active and immunity_end:
        remaining = get_remaining_time(immunity_end)
        text += f"\n‚è≥ <b>–û—Å—Ç–∞–ª–æ—Å—å:</b> <code>{remaining}</code>"

    keyboard = []

    if not immunity_active:
        keyboard.append([InlineKeyboardButton("‚úÖ –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∏–º–º—É–Ω–∏—Ç–µ—Ç", callback_data="robbery_activate")])

    keyboard.append([InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="robbery_back_main")])

    await query.edit_message_text(text, parse_mode="HTML", reply_markup=InlineKeyboardMarkup(keyboard))


async def robbery_back_main_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    user = query.from_user
    user_id = str(user.id)

    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("""
        SELECT total_stolen, last_robbery, total_attempts, success_attempts, immunity_active, immunity_end
        FROM robbery_data WHERE user_id = ?
    """, (user_id,))
    result = cursor.fetchone()
    conn.close()

    total_stolen = result[0] if result else 0
    last_robbery = result[1] if result else None
    total_attempts = result[2] if result else 0
    success_attempts = result[3] if result else 0
    immunity_active = result[4] if result else 0
    immunity_end = result[5] if result else None

    failed_attempts = total_attempts - success_attempts
    immunity_status = "‚úÖ" if immunity_active else "‚ùå"

    display_name = get_display_name_html_new(user)

    def format_datetime(dt):
        if not dt:
            return "–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö"
        if isinstance(dt, int):
            dt = datetime.fromtimestamp(dt)
        elif isinstance(dt, str):
            try:
                dt = datetime.strptime(dt, "%Y-%m-%d %H:%M:%S")
            except:
                return dt
        return dt.strftime("%Y-%m-%d %H:%M:%S")

    text = (
        f"üî´ <b>–û–≥—Ä–∞–±–ª–µ–Ω–∏–µ</b> | {display_name}\n\n"
        f"üí∞ <b>–û–±—â–∞—è –Ω–∞–≥—Ä–∞–±–ª–µ–Ω–Ω–∞—è —Å—É–º–º–∞:</b> <code>{total_stolen:,}</code>\n"
        f"üïí <b>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–≥—Ä–∞–±–ª–µ–Ω–∏–µ:</b> <code>{format_datetime(last_robbery)}</code>\n"
        f"üìä <b>–í—Å–µ–≥–æ –æ–≥—Ä–∞–±–ª–µ–Ω–∏–π:</b> <code>{total_attempts}</code>\n"
        f"‚úÖ <b>–£—Å–ø–µ—à–Ω—ã—Ö:</b> <code>{success_attempts}</code>\n"
        f"‚ùå <b>–ù–µ—É—Å–ø–µ—à–Ω—ã—Ö:</b> <code>{failed_attempts}</code>\n"
        f"üõ°Ô∏è <b>–ò–º—É–Ω–∏—Ç–µ—Ç:</b> {immunity_status}"
    )

    if immunity_active and immunity_end:
        remaining = get_remaining_time(immunity_end)
        text += f"\n‚è≥ <b>–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è:</b> <code>{remaining}</code>"

    keyboard = [
        [InlineKeyboardButton("üõ°Ô∏è –ò–º—É–Ω–∏—Ç–µ—Ç", callback_data="robbery_immunity")],
        [InlineKeyboardButton("üìÑ –°–ø–∏—Å–æ–∫ –æ–≥—Ä–∞–±–ª–µ–Ω–∏–π", callback_data="robbery_list")],
        [InlineKeyboardButton("üìä –¢–æ–ø –≥—Ä–∞–±–∏—Ç–µ–ª–µ–π", callback_data="robbery_top_menu")],
        [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="profile_menu")],
    ]

    await query.edit_message_text(text, parse_mode="HTML", reply_markup=InlineKeyboardMarkup(keyboard))


async def robbery_activate_menu(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    display_name = get_display_name_html_new(query.from_user)

    text = f"üõ°Ô∏è <b>–ò–º—É–Ω–∏—Ç–µ—Ç</b> | {display_name}\n\n" \
           f"üîÑ –ê–∫—Ç–∏–≤–∞—Ü–∏—è –ò–º—É–Ω–∏—Ç–µ—Ç–∞\n–í—ã–±–µ—Ä–µ—Ç–µ —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è:"

    keyboard = [
        [InlineKeyboardButton("üïí 12 —á.", callback_data="robbery_duration_12h")],
        [InlineKeyboardButton("üìÜ 1 –¥–Ω.", callback_data="robbery_duration_1d")],
        [InlineKeyboardButton("üìÜ 3 –¥–Ω.", callback_data="robbery_duration_3d")],
        [InlineKeyboardButton("üìÜ 7 –¥–Ω.", callback_data="robbery_duration_7d")],
        [InlineKeyboardButton("üìÜ 15 –¥–Ω.", callback_data="robbery_duration_15d")],
        [InlineKeyboardButton("üìÜ 30 –¥–Ω.", callback_data="robbery_duration_30d")],
        [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="robbery_immunity")],
    ]

    await query.edit_message_text(text, parse_mode="HTML", reply_markup=InlineKeyboardMarkup(keyboard))


async def robbery_select_payment(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    duration_raw = query.data.split("_")[-1]
    context.user_data["immunity_duration"] = duration_raw

    display_name = get_display_name_html_new(query.from_user)
    text = f"üõ°Ô∏è <b>–ò–º—É–Ω–∏—Ç–µ—Ç</b> | {display_name}\n\n" \
           f"üí∏ –ê–∫—Ç–∏–≤–∞—Ü–∏—è –ò–º—É–Ω–∏—Ç–µ—Ç–∞\n–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã:"

    keyboard = [
        [InlineKeyboardButton("üí∞ DigitalCoins", callback_data="robbery_pay_dc")],
        [InlineKeyboardButton("üå± –°–µ–º–µ–Ω–∞", callback_data="robbery_pay_seeds")],
        [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="robbery_activate")],
    ]

    await query.edit_message_text(text, parse_mode="HTML", reply_markup=InlineKeyboardMarkup(keyboard))


async def robbery_confirm(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    method = query.data.split("_")[-1]  # 'seeds' –∏–ª–∏ 'dc'
    duration = context.user_data.get("immunity_duration", "12h")
    display_name = get_display_name_html_new(query.from_user)

    # –ü–∞—Ä—Å–∏–º –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤ —á–∞—Å–∞—Ö
    if duration.endswith("h"):
        hours = int(duration[:-1])
    else:
        hours = int(duration[:-1]) * 24

    # –¶–µ–Ω—ã
    price_seeds = hours * 15
    price_dc = hours * 20
    cost = price_seeds if method == "seeds" else price_dc

    # –§–æ—Ä–º–∞—Ç —Å—É–º–º—ã —Å —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º —Ä–∞–∑—Ä—è–¥–æ–≤
    def format_num(n):
        return f"{n:,}".replace(",", ".")

    cost_str = f"{format_num(price_seeds)} üå±" if method == "seeds" else f"{format_num(price_dc)} üí∞"
    method_title = "–°–µ–º–µ–Ω–∞" if method == "seeds" else "DigitalCoins"
    context.user_data["immunity_payment_method"] = method

    # –ü–æ–ª—É—á–∞–µ–º –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –ë–î
    import sqlite3
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    user_id = str(query.from_user.id)

    if method == "seeds":
        cursor.execute("SELECT seeds FROM users WHERE user_id = ?", (user_id,))
    else:
        cursor.execute("SELECT dc_balance FROM users WHERE user_id = ?", (user_id,))

    row = cursor.fetchone()
    conn.close()

    balance = row[0] if row else 0
    balance_str = f"{format_num(balance)} {'üå±' if method == 'seeds' else 'üí∞'}"

    # –†–∞–∑–±–∏–≤–∞–µ–º —á–∞—Å—ã –Ω–∞ –¥–Ω–∏ –∏ —á–∞—Å—ã
    days, hrs = divmod(hours, 24)
    duration_str = ""
    if days > 0:
        duration_str += f"{days} –¥. "
    duration_str += f"{hrs} —á."

    text = (
        f"üõ°Ô∏è <b>–ò–º–º—É–Ω–∏—Ç–µ—Ç</b> | {display_name}\n\n"
        f"üéØ <b>–ê–∫—Ç–∏–≤–∞—Ü–∏—è –∏–º–º—É–Ω–∏—Ç–µ—Ç–∞</b>\n\n"
        f"üìå <b>–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã:</b> {method_title}\n"
        f"‚è≥ <b>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</b> {duration_str}\n"
        f"üí∏ <b>–°—Ç–æ–∏–º–æ—Å—Ç—å:</b> {cost_str}\n"
        f"üíº <b>–í–∞—à –±–∞–ª–∞–Ω—Å:</b> {balance_str}"
    )

    keyboard = [
        [InlineKeyboardButton("üí≥ –û–ø–ª–∞—Ç–∏—Ç—å", callback_data=f"robbery_pay_{method}_{cost}")],
        [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="robbery_activate")],
    ]

    await query.edit_message_text(text, parse_mode="HTML", reply_markup=InlineKeyboardMarkup(keyboard))


async def robbery_list_menu(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    user = query.from_user
    user_id = str(user.id)

    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    # –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª–µ last_robberies_json –∏–∑ robbery_data –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    cursor.execute("""
        SELECT last_robberies_json FROM robbery_data WHERE user_id = ?
    """, (user_id,))
    row = cursor.fetchone()
    conn.close()

    display_name = get_display_name_html_new(user)

    text = f"üî´ <b>–û–≥—Ä–∞–±–ª–µ–Ω–∏–µ</b> | {display_name}\n\n–ü–æ—Å–ª–µ–¥–Ω–∏–µ 5 –≤–∞—à–∏—Ö –æ–≥—Ä–∞–±–ª–µ–Ω–∏–π:\n\n"

    if not row or not row[0]:
        text += "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ–± –æ–≥—Ä–∞–±–ª–µ–Ω–∏—è—Ö."
    else:
        try:
            robberies = json.loads(row[0])
        except json.JSONDecodeError:
            robberies = []

        if not robberies:
            text += "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ–± –æ–≥—Ä–∞–±–ª–µ–Ω–∏—è—Ö."
        else:
            # –í—ã–≤–æ–¥–∏–º –º–∞–∫—Å–∏–º—É–º 5 –ø–æ—Å–ª–µ–¥–Ω–∏—Ö
            for i, robbery in enumerate(robberies[:5], start=1):
                victim_name = robbery.get("victim_name", "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ")
                amount = robbery.get("amount", 0)
                date_raw = robbery.get("date")

                # –ü–∞—Ä—Å–∏–º –¥–∞—Ç—É –∏–∑ —Å—Ç—Ä–æ–∫–∏/—á–∏—Å–ª–∞ –≤ datetime
                dt = None
                if isinstance(date_raw, int):
                    dt = datetime.fromtimestamp(date_raw)
                elif isinstance(date_raw, str):
                    try:
                        dt = datetime.strptime(date_raw, "%Y-%m-%d %H:%M:%S")
                    except Exception:
                        dt = None

                date_str = dt.strftime("%d.%m.%Y / %H:%M") if dt else "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"

                text += f"{i}. {victim_name}\n–î–∞—Ç–∞: {date_str}\n–°—É–º–º–∞: {amount}\n\n"

    keyboard = [
        [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="robbery_back_main")]
    ]

    await query.edit_message_text(text, parse_mode="HTML", reply_markup=InlineKeyboardMarkup(keyboard))


async def robbery_pay_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    data = query.data  # robbery_pay_seeds_180 –∏–ª–∏ robbery_pay_dc_120 –∏ —Ç.–ø.
    parts = data.split("_")
    if len(parts) != 4:
        await query.edit_message_text("–û—à–∏–±–∫–∞: –Ω–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ–ø–ª–∞—Ç—ã.")
        return

    _, _, method, cost_str = parts
    cost = int(cost_str)

    user_id = str(query.from_user.id)
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    balance_field = "seeds" if method == "seeds" else "dc_balance"
    cursor.execute(f"SELECT {balance_field} FROM users WHERE user_id = ?", (user_id,))
    row = cursor.fetchone()

    if not row:
        await query.edit_message_text("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ.")
        conn.close()
        return

    balance = row[0] or 0

    def format_num(n):
        return f"{n:,}".replace(",", ".")

    if balance < cost:
        text = (
            f"‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤.\n\n"
            f"üíº –í–∞—à –±–∞–ª–∞–Ω—Å: {format_num(balance)} {'üå±' if method == 'seeds' else 'üí∞'}\n"
            f"üí∏ –¢—Ä–µ–±—É–µ—Ç—Å—è: {format_num(cost)} {'üå±' if method == 'seeds' else 'üí∞'}"
        )
    else:
        new_balance = balance - cost
        cursor.execute(f"UPDATE users SET {balance_field} = ? WHERE user_id = ?", (new_balance, user_id))

        # –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∏–º–º—É–Ω–∏—Ç–µ—Ç
        hours = cost // 15 if method == "seeds" else cost // 20
        immunity_end_timestamp = int(time.time()) + hours * 3600

        cursor.execute("""
            INSERT INTO robbery_data (user_id, immunity_active, immunity_end)
            VALUES (?, 1, ?)
            ON CONFLICT(user_id) DO UPDATE SET immunity_active=1, immunity_end=excluded.immunity_end
        """, (user_id, immunity_end_timestamp))

        conn.commit()

        text = (
            f"‚úÖ –û–ø–ª–∞—Ç–∞ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ!\n\n"
            f"üí∏ –°–ø–∏—Å–∞–Ω–æ: {format_num(cost)} {'üå±' if method == 'seeds' else 'üí∞'}\n"
            f"üíº –û—Å—Ç–∞—Ç–æ–∫: {format_num(new_balance)} {'üå±' if method == 'seeds' else 'üí∞'}\n"
            f"üõ°Ô∏è –ò–º–º—É–Ω–∏—Ç–µ—Ç –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –Ω–∞ {hours} —á."
        )

    conn.close()

    keyboard = [
        [InlineKeyboardButton("üè† –í –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="main_menu")]
    ]

    await query.edit_message_text(text, reply_markup=InlineKeyboardMarkup(keyboard))


async def robbery_top_menu(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    keyboard = [
        [InlineKeyboardButton("üì¶ –ö–æ–ª-–≤–æ –æ–≥—Ä–∞–±–ª–µ–Ω–∏–π", callback_data="robbery_top_total_attempts")],
        [InlineKeyboardButton("üí∞ –°—É–º–º–∞ –Ω–∞–≥—Ä–∞–±–ª–µ–Ω–Ω–æ–≥–æ", callback_data="robbery_top_total_stolen")],
        [InlineKeyboardButton("‚úÖ –£—Å–ø–µ—à–Ω—ã–µ –æ–≥—Ä–∞–±–ª–µ–Ω–∏—è", callback_data="robbery_top_success")],
        [InlineKeyboardButton("‚ùå –ù–µ —É—Å–ø–µ—à–Ω—ã–µ –æ–≥—Ä–∞–±–ª–µ–Ω–∏—è", callback_data="robbery_top_failed")],
        [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="robbery_back_main")]
    ]

    await query.edit_message_text(
        "üîù <b>–¢–æ–ø –≥—Ä–∞–±–∏—Ç–µ–ª–µ–π</b>\n"
        "üìÇ –í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é:",
        reply_markup=InlineKeyboardMarkup(keyboard),
        parse_mode="HTML"
    )


async def robbery_top_category(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    category_map = {
        "robbery_top_total_attempts": ("total_attempts", "–ö–æ–ª-–≤–æ –≥—Ä–∞–±–µ–∂–µ–π"),
        "robbery_top_total_stolen": ("total_stolen", "–£–∫—Ä–∞–¥–µ–Ω–æ"),
        "robbery_top_success": ("success_attempts", "–£—Å–ø–µ—à–Ω—ã–π—Ö"),
        "robbery_top_failed": ("failed_attempts", "–ù–µ —É—Å–ø–µ—à–Ω—ã—Ö")
    }

    data = query.data
    if data not in category_map:
        await query.edit_message_text("‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è.")
        return

    field, label = category_map[data]

    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute(f"""
        SELECT user_id, {field}
        FROM robbery_data
        ORDER BY {field} DESC
        LIMIT 5
    """)
    top_rows = cursor.fetchall()
    conn.close()

    text = (f"üîù <b>–¢–æ–ø –≥—Ä–∞–±–∏—Ç–µ–ª–µ–π</b>\n"
            f"üìã –ü–æ–∫–∞–∑–∞–Ω–æ —Ç–æ–ø 5 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π\n"
            f"üìä –ö–∞—Ç–µ–≥–æ—Ä–∏—è: <i>{label}</i>\n\n")

    if not top_rows:
        text += "‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö."
    else:
        for i, (uid, value) in enumerate(top_rows, start=1):
            try:
                user = await context.bot.get_chat(uid)
                display_name = get_display_name_html_new(user)
            except:
                display_name = f"ID: {uid}"

            medal = ["ü•á", "ü•à", "ü•â", "üèÖ", "üéñ"][i - 1] if i <= 5 else "üî∏"
            text += f"{medal} {i}. {display_name}\nüí∞ {label}: {value}\n\n"

    keyboard = [
        [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="robbery_top_menu")]
    ]
    await query.edit_message_text(text, parse_mode="HTML", reply_markup=InlineKeyboardMarkup(keyboard))


def update_user_robbery_balance(user_id: str, amount: int) -> int:
    """–û–±–Ω–æ–≤–∏—Ç—å –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–∏ –æ–≥—Ä–∞–±–ª–µ–Ω–∏–∏"""
    user_id = str(user_id)
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    cursor.execute("SELECT balance FROM users WHERE user_id = ?", (user_id,))
    row = cursor.fetchone()

    if row is None:
        cursor.execute("INSERT INTO users (user_id, balance) VALUES (?, ?)", (user_id, amount))
        conn.commit()
        conn.close()
        print(f"DEBUG: Created new user {user_id} with balance {amount}")
        return amount

    current_balance = row[0] if row[0] is not None else 0
    new_balance = current_balance + amount

    cursor.execute("UPDATE users SET balance = ? WHERE user_id = ?", (new_balance, user_id))
    conn.commit()
    conn.close()

    print(f"DEBUG: Updated user {user_id} balance from {current_balance} to {new_balance}")
    return new_balance

def get_user_balance_rob(user_id: int) -> int:
    """–ü–æ–ª—É—á–∏—Ç—å –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    user_id = str(user_id)
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT balance FROM users WHERE user_id = ?", (user_id,))
    row = cursor.fetchone()
    conn.close()
    return row[0] if row and row[0] else 0


def transfer_balance(from_user_id: int, to_user_id: int, amount: int):
    """–ü–µ—Ä–µ–¥–∞—Ç—å –¥–µ–Ω—å–≥–∏ –æ—Ç –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫ –¥—Ä—É–≥–æ–º—É"""
    if amount <= 0:
        return

    from_user_id = str(from_user_id)
    to_user_id = str(to_user_id)

    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    try:
        # –£–º–µ–Ω—å—à–∞–µ–º –±–∞–ª–∞–Ω—Å –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
        cursor.execute("SELECT balance FROM users WHERE user_id = ?", (from_user_id,))
        row = cursor.fetchone()
        current_balance = row[0] if row and row[0] else 0
        new_balance = current_balance - amount
        cursor.execute("UPDATE users SET balance = ? WHERE user_id = ?", (new_balance, from_user_id))

        # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –±–∞–ª–∞–Ω—Å –ø–æ–ª—É—á–∞—Ç–µ–ª—è
        cursor.execute("SELECT balance FROM users WHERE user_id = ?", (to_user_id,))
        row = cursor.fetchone()
        current_balance = row[0] if row and row[0] else 0
        new_balance = current_balance + amount
        cursor.execute("UPDATE users SET balance = ? WHERE user_id = ?", (new_balance, to_user_id))

        conn.commit()
    finally:
        conn.close()


async def robbing_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ö–æ–º–∞–Ω–¥–∞ –æ–≥—Ä–∞–±–ª–µ–Ω–∏—è —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–æ–π cooldown"""

    # --- –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–µ–ª—å ---
    target_user_id = None
    if context.args:
        try:
            target_user_id = int(context.args[0])
        except ValueError:
            await update.message.reply_text("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π TelegramID.")
            return
    elif update.message.reply_to_message:
        target_user_id = update.message.reply_to_message.from_user.id
    else:
        await update.message.reply_text(
            "*‚ÑπÔ∏è –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã:*\n\n"
            "üîπ /–æ–≥—Ä–∞–±–∏—Ç—å <telegramID>\n"
            "–∏–ª–∏\n"
            "üîπ /–æ–≥—Ä–∞–±–∏—Ç—å (–≤ –æ—Ç–≤–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ)",
            parse_mode="MarkdownV2"
        )
        return

    robber_id = update.message.from_user.id
    if robber_id == target_user_id:
        await update.message.reply_text("‚ùå –ù–µ–ª—å–∑—è –æ–≥—Ä–∞–±–∏—Ç—å —Å–∞–º–æ–≥–æ —Å–µ–±—è!")
        return

    now_ts = int(time.time())

    # ‚úÖ –ü–†–û–í–ï–†–ö–ê COOLDOWN
    now_ts = int(time.time())

    vip_status = get_user_vip_status(robber_id)  # ‚Üê –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø
    cooldown = get_robbing_cooldown(vip_status)
    last_used = get_user_last_robbing(robber_id)
    vip_name = get_vip_name(vip_status)

    print(f"üîç VIP: {vip_status} ({vip_name}), cooldown: {cooldown}s ({cooldown // 60}–º)")

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º cooldown
    if last_used != 0:
        time_passed = now_ts - last_used

        if time_passed < cooldown:
            remaining = cooldown - time_passed
            minutes, seconds = divmod(remaining, 60)

            await update.message.reply_text(
                f"‚è≥ <b>Cooldown –æ–≥—Ä–∞–±–ª–µ–Ω–∏—è</b>\n\n"
                f"–°—Ç–∞—Ç—É—Å: <code>{vip_name}</code>\n"
                f"–û—Å—Ç–∞–ª–æ—Å—å: <b>{minutes}–º {seconds}—Å</b>\n"
                f"–ü–æ–ª–Ω—ã–π cooldown: <b>{cooldown // 60} –º–∏–Ω—É—Ç</b>",
                parse_mode="HTML"
            )
            return

    # Cooldown –ø—Ä–æ–π–¥–µ–Ω - –æ–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è
    success_update = update_user_last_robbing(robber_id)
    if not success_update:
        await update.message.reply_text("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ cooldown.")
        return

    # --- –†–∞–±–æ—Ç–∞ —Å –±–∞–∑–æ–π ---
    try:
        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()

        # –ê–≤—Ç–æ—Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –¥–ª—è –≥—Ä–∞–±–∏—Ç–µ–ª—è –∏ –∂–µ—Ä—Ç–≤—ã
        for uid in (robber_id, target_user_id):
            cursor.execute("SELECT 1 FROM robbery_data WHERE user_id = ?", (str(uid),))
            if cursor.fetchone() is None:
                cursor.execute("INSERT INTO robbery_data (user_id) VALUES (?)", (str(uid),))

        # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–µ–∫–æ–¥–µ—Ä–æ–≤ —É –≥—Ä–∞–±–∏—Ç–µ–ª—è
        cursor.execute("SELECT quantity FROM inventory WHERE owner_id = ? AND item_name='–î–µ–∫–æ–¥–µ—Ä'", (str(robber_id),))
        result = cursor.fetchone()
        decoders = result[0] if result else 0

    finally:
        conn.commit()
        conn.close()

    # --- –ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–∏–∫–æ–≤ ---
    robber_user = update.message.from_user
    try:
        target_user = update.message.reply_to_message.from_user
    except Exception:
        target_user = await context.bot.get_chat(target_user_id)

    robber_name = get_display_name_html_new(robber_user)
    target_name = get_display_name_html_new(target_user)

    # --- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–º–º—É–Ω–∏—Ç–µ—Ç–∞ ---
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute(
        "SELECT immunity_active, immunity_end FROM robbery_data WHERE user_id = ?",
        (str(target_user_id),)
    )
    row = cursor.fetchone()
    immunity_active = 0
    immunity_end = None

    if row:
        immunity_active, immunity_end = row
        if immunity_active and immunity_end is not None and now_ts >= int(immunity_end):
            cursor.execute(
                "UPDATE robbery_data SET immunity_active=0, immunity_end=NULL WHERE user_id=?",
                (str(target_user_id),)
            )
            conn.commit()
            immunity_active = 0
    conn.close()

    if immunity_active:
        if decoders == 0:
            await update.message.reply_text(
                f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–≥—Ä–∞–±–∏—Ç—å {target_name}...\nüõ° –£ —á–µ–ª–æ–≤–µ–∫–∞ –∞–∫—Ç–∏–≤–µ–Ω –∏–º–º—É–Ω–∏—Ç–µ—Ç.\nüß© –î–µ–∫–æ–¥–µ—Ä—ã: 0",
                parse_mode="HTML"
            )
        else:
            keyboard = [[InlineKeyboardButton(f"–î–µ–∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å ({decoders})", callback_data=f"decode_{target_user_id}")]]
            markup = InlineKeyboardMarkup(keyboard)
            await update.message.reply_text(
                f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–≥—Ä–∞–±–∏—Ç—å {target_name}...\nüõ° –£ —á–µ–ª–æ–≤–µ–∫–∞ –∞–∫—Ç–∏–≤–µ–Ω –∏–º–º—É–Ω–∏—Ç–µ—Ç.\nüß© –î–µ–∫–æ–¥–µ—Ä—ã: {decoders}",
                reply_markup=markup,
                parse_mode="HTML"
            )
        return

    # --- –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞ ---
    victim_balance = get_user_balance_rob(target_user_id)
    if victim_balance <= 0:
        await update.message.reply_text(f"‚ùå –£ {target_name} –Ω–µ—Ç –¥–µ–Ω–µ–≥ –¥–ª—è –æ–≥—Ä–∞–±–ª–µ–Ω–∏—è.", parse_mode="HTML")
        return

    # --- –†–∞–Ω–¥–æ–º–Ω—ã–π –∏—Å—Ö–æ–¥ ---
    roll = random.randint(1, 100)
    success = False
    reason = ""
    stolen_amount = 0
    percent = 0

    if roll <= 20:
        reason = "–í–∞—Å –∑–∞–º–µ—Ç–∏–ª–∞ –∂–µ—Ä—Ç–≤–∞, –∏ –≤—ã —É–±–µ–∂–∞–ª–∏!"
    elif roll <= 45:
        reason = "–í–∞—Å –ø–æ–π–º–∞–ª–∞ –ø–æ–ª–∏—Ü–∏—è!"
    else:
        success = True
        percent = random.randint(1, 50)
        stolen_amount = max(1, int(victim_balance * percent / 100))
        stolen_amount = min(stolen_amount, victim_balance)
        transfer_balance(target_user_id, robber_id, stolen_amount)

    # --- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –≥—Ä–∞–±–∏—Ç–µ–ª—è ---
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("""
        UPDATE robbery_data
        SET 
            total_attempts = total_attempts + 1,
            success_attempts = success_attempts + ?,
            failed_attempts = failed_attempts + ?,
            total_stolen = total_stolen + ?
        WHERE user_id = ?
    """, (1 if success else 0, 0 if success else 1, stolen_amount if success else 0, str(robber_id)))

    # --- –õ–æ–≥ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 10 –æ–≥—Ä–∞–±–ª–µ–Ω–∏–π ---
    cursor.execute("SELECT last_robberies_json FROM robbery_data WHERE user_id = ?", (str(robber_id),))
    row = cursor.fetchone()
    last_robberies = []
    if row and row[0]:
        try:
            last_robberies = json.loads(row[0])
        except:
            last_robberies = []

    new_record = {
        "victim_name": target_name,
        "amount": stolen_amount if success else 0,
        "date": datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
        "success": success
    }
    last_robberies.insert(0, new_record)
    last_robberies = last_robberies[:10]
    cursor.execute("UPDATE robbery_data SET last_robberies_json = ? WHERE user_id = ?",
                   (json.dumps(last_robberies, ensure_ascii=False), str(robber_id)))

    conn.commit()
    conn.close()

    # --- –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ---
    try:
        if success:
            await update.message.reply_text(
                f"‚úÖ <b>–û–≥—Ä–∞–±–ª–µ–Ω–∏–µ –ø—Ä–æ—à–ª–æ —É—Å–ø–µ—à–Ω–æ!</b>\n\n"
                f"üéØ –ñ–µ—Ä—Ç–≤–∞: {target_name}\n"
                f"üí∞ –£–∫—Ä–∞–¥–µ–Ω–æ: <b>{stolen_amount}‚ÇΩ</b>\n"
                f"üìä –ü—Ä–æ—Ü–µ–Ω—Ç: <b>{percent}%</b> –æ—Ç –±–∞–ª–∞–Ω—Å–∞\n\n"
                f"üë§ –°—Ç–∞—Ç—É—Å: <code>{vip_name}</code>\n"
                f"‚è±Ô∏è –°–ª–µ–¥—É—é—â–µ–µ –æ–≥—Ä–∞–±–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑: <b>{cooldown // 60}–º</b>",
                parse_mode="HTML"
            )
        else:
            await update.message.reply_text(
                f"‚ùå <b>–û–≥—Ä–∞–±–ª–µ–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å</b>\n\n"
                f"–ü—Ä–∏—á–∏–Ω–∞: {reason}\n\n"
                f"üë§ –°—Ç–∞—Ç—É—Å: <code>{vip_name}</code>\n"
                f"‚è±Ô∏è –°–ª–µ–¥—É—é—â–µ–µ –æ–≥—Ä–∞–±–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑: <b>{cooldown // 60}–º</b>",
                parse_mode="HTML"
            )
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}")

def check_robbing_cooldown(user_id: int) -> tuple[bool, str, int, int]:
    """
    –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –º–æ–∂–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≥—Ä–∞–±–∏—Ç—å –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å

    Returns:
        (can_rob: bool, message: str, remaining_seconds: int, cooldown_seconds: int)
    """
    user_id = int(user_id)
    now_ts = int(time.time())

    # –ü–æ–ª—É—á–∞–µ–º VIP —Å—Ç–∞—Ç—É—Å
    vip_status = get_user_vip_status(user_id)

    # –ü–æ–ª—É—á–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π cooldown
    cooldown = get_robbing_cooldown(vip_status)

    # –ü–æ–ª—É—á–∞–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–≥—Ä–∞–±–ª–µ–Ω–∏—è
    last_used = get_user_last_robbing(user_id)

    print(f"üîç DEBUG check_robbing_cooldown:")
    print(f"   user_id={user_id}")
    print(f"   vip_status={vip_status}")
    print(f"   cooldown={cooldown}s ({cooldown // 60}–º)")
    print(f"   last_used={last_used}")
    print(f"   now_ts={now_ts}")

    # –ï—Å–ª–∏ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –≥—Ä–∞–±–∏–ª
    if last_used == 0:
        print(f"   ‚Üí –ü–µ—Ä–≤–æ–µ –æ–≥—Ä–∞–±–ª–µ–Ω–∏–µ (last_used=0)")
        return True, "Ok", 0, cooldown

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ—à–ª–æ –ª–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≤—Ä–µ–º–µ–Ω–∏
    time_passed = now_ts - last_used
    print(f"   time_passed={time_passed}s ({time_passed // 60}–º {time_passed % 60}—Å)")

    if time_passed < cooldown:
        # Cooldown –µ—â—ë –∞–∫—Ç–∏–≤–µ–Ω
        remaining = cooldown - time_passed
        minutes, seconds = divmod(remaining, 60)

        vip_name = {
            0: "üë§ –û–±—ã—á–Ω—ã–π",
            1: "üü¢ VIP Silver",
            2: "üîµ VIP Gold",
            3: "üü£ VIP Platinum",
            4: "‚≠ê VIP Legend"
        }.get(vip_status, "Unknown")

        message = (
            f"‚è≥ <b>Cooldown –æ–≥—Ä–∞–±–ª–µ–Ω–∏—è</b>\n\n"
            f"–°—Ç–∞—Ç—É—Å: <code>{vip_name}</code>\n"
            f"–û—Å—Ç–∞–ª–æ—Å—å: <b>{minutes}–º {seconds}—Å</b>\n"
            f"–ü–æ–ª–Ω—ã–π cooldown: <b>{cooldown // 60} –º–∏–Ω—É—Ç</b>"
        )

        print(f"   ‚Üí Cooldown –∞–∫—Ç–∏–≤–µ–Ω, remaining={remaining}s")
        return False, message, remaining, cooldown
    else:
        # Cooldown –∏—Å—Ç—ë–∫, –º–æ–∂–Ω–æ –≥—Ä–∞–±–∏—Ç—å
        print(f"   ‚Üí Cooldown –∏—Å—Ç—ë–∫, –º–æ–∂–Ω–æ –≥—Ä–∞–±–∏—Ç—å")
        return True, "Ok", 0, cooldown


async def decode_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    target_user_id = int(query.data.split("_")[1])
    robber_id = query.from_user.id

    async with aiosqlite.connect(DB_PATH) as db:
        async with db.execute(
            "SELECT quantity FROM inventory WHERE owner_id=? AND item_name='–î–µ–∫–æ–¥–µ—Ä'",
            (str(robber_id),)
        ) as cursor:
            result = await cursor.fetchone()
        decoders = result[0] if result else 0

        if decoders <= 0:
            await query.edit_message_text("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –¥–µ–∫–æ–¥–µ—Ä–æ–≤ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è.")
            return

        await query.edit_message_text(
            "üß© <b>–î–µ–∫–æ–¥–∏—Ä—É–µ–º...</b>\n<pre>‚ñ±‚ñ±‚ñ±‚ñ±‚ñ±‚ñ±‚ñ±‚ñ±‚ñ±‚ñ± 0%</pre>",
            parse_mode="HTML"
        )
        await asyncio.sleep(1.5)

        success = random.randint(1, 100) <= 35

        if not success:
            await db.execute(
                "UPDATE inventory SET quantity = quantity - 1 WHERE owner_id=? AND item_name='–î–µ–∫–æ–¥–µ—Ä'",
                (str(robber_id),)
            )
            await db.commit()

            async with db.execute(
                "SELECT quantity FROM inventory WHERE owner_id=? AND item_name='–î–µ–∫–æ–¥–µ—Ä'",
                (str(robber_id),)
            ) as cursor:
                result = await cursor.fetchone()
            decoders_left = result[0] if result else 0

            keyboard = [[InlineKeyboardButton(f"–î–µ–∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å ({decoders_left})",
                                              callback_data=f"decode_{target_user_id}")]] if decoders_left > 0 else None
            markup = InlineKeyboardMarkup(keyboard) if keyboard else None

            await query.edit_message_text(
                f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å –∏–º–º—É–Ω–∏—Ç–µ—Ç —á–µ–ª–æ–≤–µ–∫–∞...\n"
                f"üõ° –£ —á–µ–ª–æ–≤–µ–∫–∞ –∞–∫—Ç–∏–≤–µ–Ω –∏–º–º—É–Ω–∏—Ç–µ—Ç.\n\n"
                f"üß© –î–µ–∫–æ–¥–µ—Ä—ã: {decoders_left}",
                reply_markup=markup
            )
        else:
            chat_member = await query.message.chat.get_member(target_user_id)
            display_name_html = get_display_name_html_new(chat_member.user)

            await db.execute(
                "UPDATE robbery_data SET immunity_active=0, immunity_end=NULL WHERE user_id=?",
                (str(target_user_id),)
            )
            await db.commit()

            await query.edit_message_text(
                f"‚úÖ <b>–£—Å–ø–µ—à–Ω–æ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–æ!</b>\n\n"
                f"üõ° –ò–º–º—É–Ω–∏—Ç–µ—Ç —Ü–µ–ª–∏ {display_name_html} —Å–Ω—è—Ç.\n"
                f"üí° –ú–æ–∂–µ—Ç–µ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –æ–≥—Ä–∞–±–ª–µ–Ω–∏–µ —Å–Ω–æ–≤–∞!\n\n"
                f"<pre>üß© –ü—Ä–æ–≥—Ä–µ—Å—Å: ‚ñ∞‚ñ∞‚ñ∞‚ñ∞‚ñ∞‚ñ∞‚ñ∞‚ñ∞‚ñ∞‚ñ∞ 100%</pre>",
                parse_mode="HTML",
                disable_web_page_preview=True
            )

RULES_FILE = "rules.json"


def load_rules():
    if not os.path.exists(RULES_FILE):
        return {}
    with open(RULES_FILE, "r", encoding="utf-8") as f:
        return json.load(f)


def save_rules(data):
    with open(RULES_FILE, "w", encoding="utf-8") as f:
        json.dump(data, f, ensure_ascii=False, indent=4)


def get_user_admin_level(chat_id, user_id):
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —É—Ä–æ–≤–µ–Ω—å –∞–¥–º–∏–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º —á–∞—Ç–µ."""
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    # –ü–æ–ª—É—á–∞–µ–º —É—Ä–æ–≤–µ–Ω—å –∞–¥–º–∏–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —á–∞—Ç–µ
    cursor.execute("""
        SELECT admin_level 
        FROM chat_admins 
        WHERE chat_id = ? AND user_id = ?
    """, (str(chat_id), str(user_id)))
    result = cursor.fetchone()

    conn.close()
    return result[0] if result else 0  # 0 –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–¥–º–∏–Ω


def is_admin_rule(user_id, chat_id):
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ª–∏ –ø—Ä–∞–≤ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª –≤ —á–∞—Ç–µ."""
    user_level = get_user_admin_level(chat_id, user_id)

    # –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —É—Ä–æ–≤–µ–Ω—å –∏–∑ chat_settings –¥–ª—è –ø—Ä–∞–≤–∏–ª–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—É–¥–∞–ª–µ–Ω–∏—è
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT role_change FROM chat_settings WHERE chat_id = ?", (str(chat_id),))
    settings = cursor.fetchone()
    conn.close()
    required_level = settings[0] if settings else 7

    return user_level >= required_level


async def add_rule(update: Update, context: ContextTypes.DEFAULT_TYPE):
    message = update.message
    if not is_admin_rule(message.from_user.id, message.chat.id):
        return await message.reply_text("‚õî –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤.")

    rule_text = message.text.replace("+–ø—Ä–∞–≤–∏–ª–∞", "", 1).strip()

    if not rule_text:
        return await message.reply_text(
            "‚ö†Ô∏è –£–∫–∞–∂–∏—Ç–µ –ø—Ä–∞–≤–∏–ª–æ: `+–ø—Ä–∞–≤–∏–ª–∞ –ü—Ä–∞–≤–∏–ª–æ...`\n\n"
            "–ß—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É –∫ –ø—Ä–∞–≤–∏–ª–∞–º, –∏—Å–ø–æ–ª—å–∑—É–π —Ñ–æ—Ä–º–∞—Ç:\n"
            "`[!: –¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ + https://example.com]`",
            parse_mode="Markdown"
        )

    rules = load_rules()
    chat_id = str(message.chat.id)
    rules.setdefault(chat_id, []).append(rule_text)
    save_rules(rules)

    await message.reply_text("‚úÖ –ü—Ä–∞–≤–∏–ª–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ.")
    await message.reply_text(
        "üìå *–ü–∞–º—è—Ç–∫–∞ –ø–æ –∫–Ω–æ–ø–∫–∞–º:*\n"
        "–ß—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É –∫ –ø—Ä–∞–≤–∏–ª–∞–º, –∏—Å–ø–æ–ª—å–∑—É–π —Ñ–æ—Ä–º–∞—Ç:\n"
        "`[!: –¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ + https://example.com]`\n\n"
        "–ü—Ä–∏–º–µ—Ä:\n"
        "`+–ø—Ä–∞–≤–∏–ª–∞ –ß–∏—Ç–∞–π—Ç–µ —Ä–µ–≥–ª–∞–º–µ–Ω—Ç [!: –û—Ç–∫—Ä—ã—Ç—å —Å–∞–π—Ç + https://example.com]`",
        parse_mode="Markdown"
    )


async def delete_rules(update: Update, context: ContextTypes.DEFAULT_TYPE):
    message = update.message
    if not is_admin_rule(message.from_user.id, message.chat.id):
        return await message.reply_text("‚õî –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤.")

    rules = load_rules()
    chat_id = str(message.chat.id)
    if chat_id in rules:
        del rules[chat_id]
        save_rules(rules)
        await message.reply_text("üóë –í—Å–µ –ø—Ä–∞–≤–∏–ª–∞ —á–∞—Ç–∞ —É–¥–∞–ª–µ–Ω—ã.")
    else:
        await message.reply_text("‚ùå –ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –ø—Ä–∞–≤–∏–ª –¥–ª—è —ç—Ç–æ–≥–æ —á–∞—Ç–∞.")

def parse_buttons_from_text(text: str):
    """
    –ò—â–µ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω—ã [!: —Ç–µ–∫—Å—Ç https://...] –≤ —Ç–µ–∫—Å—Ç–µ.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç (–æ—á–∏—â–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç, —Å–ø–∏—Å–æ–∫ –∫–Ω–æ–ø–æ–∫).
    """
    pattern = r'\[!:\s*(.+?)\s*\+\s*(https?://\S+)\]'
    buttons = []

    matches = re.findall(pattern, text)
    for label, url in matches:
        buttons.append(InlineKeyboardButton(label, url=url))

    # –£–±–∏—Ä–∞–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω—ã –∏–∑ —Ç–µ–∫—Å—Ç–∞
    clean_text = re.sub(pattern, '', text).strip()

    return clean_text, buttons


async def show_rules(update: Update, context: ContextTypes.DEFAULT_TYPE):
    message = update.message
    rules = load_rules()
    chat_id = str(message.chat.id)

    if chat_id not in rules or not rules[chat_id]:
        return await message.reply_text("üì≠ –í —ç—Ç–æ–º —á–∞—Ç–µ –ø–æ–∫–∞ –Ω–µ—Ç –ø—Ä–∞–≤–∏–ª.")

    rules_text = "\n".join(f"{i + 1}. {r}" for i, r in enumerate(rules[chat_id]))

    MAX_LENGTH = 4000

    chunks = [rules_text[i:i + MAX_LENGTH] for i in range(0, len(rules_text), MAX_LENGTH)]

    for i, chunk in enumerate(chunks):
        # –ö–Ω–æ–ø–∫–∏ –∏–∑–≤–ª–µ–∫–∞–µ–º —Ç–æ–ª—å–∫–æ –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —á–∞–Ω–∫–∞, —á—Ç–æ–±—ã –Ω–µ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å
        if i == len(chunks) - 1:
            clean_chunk, buttons = parse_buttons_from_text(chunk)
            if buttons:
                # –ö–∞–∂–¥–∞—è –∫–Ω–æ–ø–∫–∞ –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Å—Ç—Ä–æ–∫–µ
                keyboard = InlineKeyboardMarkup([[btn] for btn in buttons])
                await message.reply_text(
                    f"üìú –ü—Ä–∞–≤–∏–ª–∞ —á–∞—Ç–∞:\n\n{clean_chunk}",
                    reply_markup=keyboard
                )
            else:
                await message.reply_text(f"üìú –ü—Ä–∞–≤–∏–ª–∞ —á–∞—Ç–∞:\n\n{clean_chunk}")
        else:
            await message.reply_text(f"üìú –ü—Ä–∞–≤–∏–ª–∞ —á–∞—Ç–∞:\n\n{chunk}")

def mention(user):
    name = escape(user.first_name)
    return f'<a href="tg://user?id={user.id}">{name}</a>'


def is_admin(chat_member):
    return isinstance(chat_member, (ChatMemberAdministrator, ChatMemberOwner))


def get_active_mute(user_id, chat_id):
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute(
        "SELECT * FROM mutes WHERE muted_user_id=? AND chat_id=? AND timestamp_end > ?",
        (str(user_id), chat_id, int(time.time()))
    )
    result = cursor.fetchone()
    conn.close()
    return result


last_kill_time = {}


def has_fernie_plus(user_id: int) -> bool:
    """–ü—Ä–æ–≤–µ—Ä–∫–∞, –µ—Å—Ç—å –ª–∏ –∞–∫—Ç–∏–≤–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞ Fernie+"""
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT end_time FROM SubFerniePlus WHERE user_id = ?", (str(user_id),))
    row = cursor.fetchone()
    conn.close()
    if row:
        end_time = row[0]
        return end_time > int(time.time())
    return False

SUICIDE_REASONS = [
    "–ü–æ—Ç–µ—Ä—è –∂–∏–∑–Ω–µ–Ω–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π –ø–æ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–π –≤–æ–ª–µ.",
    "–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∂–∏–∑–Ω–∏ –ø–æ –ª–∏—á–Ω—ã–º –º–æ—Ç–∏–≤–∞–º.",
    "–ì–∏–±–µ–ª—å –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ –ø—Å–∏—Ö–æ—ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ —Å—Ä—ã–≤–∞.",
    "–°–ø—Ä—ã–≥–Ω—É–ª —Å –∫—Ä—ã—à–∏.",
    "–ü–µ—Ä–µ–¥–æ–∑–∏—Ä–æ–≤–∫–∞ –ª–µ–∫–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã—Ö –ø—Ä–µ–ø–∞—Ä–∞—Ç–æ–≤.",
    "–ü–æ–≤–µ—Å–∏–ª—Å—è.",
    "–£—Ç–æ–Ω—É–ª –ø–æ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–π –≤–æ–ª–µ.",
    "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–ª —Ö–æ–ª–æ–¥–Ω–æ–µ –æ—Ä—É–∂–∏–µ.",
    "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–ª –æ–≥–Ω–µ—Å—Ç—Ä–µ–ª—å–Ω–æ–µ –æ—Ä—É–∂–∏–µ.",
    "–û—Ç—Ä–∞–≤–∏–ª—Å—è —Ç–æ–∫—Å–∏—á–Ω—ã–º–∏ –≤–µ—â–µ—Å—Ç–≤–∞–º–∏.",
    "–ü–æ–≥–∏–± –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ —É–º—ã—à–ª–µ–Ω–Ω–æ–≥–æ –ø–æ–¥–∂–æ–≥–∞.",
    "–ë—Ä–æ—Å–∏–ª—Å—è –ø–æ–¥ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç.",
    "–°–º–µ—Ä—Ç—å –Ω–∞—Å—Ç—É–ø–∏–ª–∞ –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ –∞—Å—Ñ–∏–∫—Å–∏–∏."
]

async def kill(update: Update, context: ContextTypes.DEFAULT_TYPE):
    message = update.message
    user = message.from_user
    target_msg = message.reply_to_message

    if not target_msg:
        return  # –º–æ–ª—á–∞ –∏–≥–Ω–æ—Ä

    target_user = target_msg.from_user
    chat_id = message.chat_id
    now = int(time.time())

    is_suicide = user.id == target_user.id

    # --- –ø—Ä–æ–≤–µ—Ä–∫–∞ –ö–î ---
    cooldown = 60 if has_fernie_plus(user.id) else 600
    last_used = last_kill_time.get(user.id, 0)
    if now - last_used < cooldown:
        wait_time = cooldown - (now - last_used)
        minutes, seconds = divmod(wait_time, 60)
        await message.reply_text(f"‚è≥ –ü–æ–¥–æ–∂–¥–∏—Ç–µ {minutes} –º–∏–Ω. {seconds} —Å–µ–∫.")
        return

    last_kill_time[user.id] = now

    # --- –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –±–æ—Ç–∞ ---
    bot_member = await context.bot.get_chat_member(chat_id, (await context.bot.get_me()).id)
    if bot_member.status not in ("administrator", "creator") or not bot_member.can_restrict_members:
        return

    # --- –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∞–¥–º–∏–Ω–∞ ---
    member = await context.bot.get_chat_member(chat_id, target_user.id)
    if is_admin(member):
        return

    # --- –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –º—É—Ç–∞ ---
    mute_data = get_active_mute(target_user.id, chat_id)
    if mute_data and mute_data[2] == "RP Command" and mute_data[3] == "–£–±–∏—Ç":
        await message.reply_text("‚ò† –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —É–±–∏—Ç.")
        return

    if mute_data:
        await rp_action(update, context, "—É–±–∏–ª(–∞)", "üî™")
        return

    # --- –º—É—Ç ---
    duration = 5 * 60
    until_timestamp = now + duration

    await context.bot.restrict_chat_member(
        chat_id=chat_id,
        user_id=target_user.id,
        permissions=ChatPermissions(can_send_messages=False),
        until_date=until_timestamp
    )

    # --- –ë–î ---
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute(
        """
        INSERT INTO mutes
        (muted_user_id, muted_by_user_id, reason, duration, timestamp_start, timestamp_end, chat_id)
        VALUES (?, ?, ?, ?, ?, ?, ?)
        """,
        (
            str(target_user.id),
            "RP Command",
            "–£–±–∏—Ç",
            duration,
            now,
            until_timestamp,
            chat_id
        )
    )
    conn.commit()
    conn.close()

    # --- –≤—ã–≤–æ–¥ ---
    if is_suicide:
        reason = random.choice(SUICIDE_REASONS)
        user_mention = get_display_name_html_new(user)

        await message.reply_text(
            f"‚ò† | {user_mention} –ø–æ–∫–æ–Ω—á–∏–ª —Å —Å–æ–±–æ–π.\n"
            f"–ü—Ä–∏—á–∏–Ω–∞: {escape(reason)}",
            parse_mode="HTML"
        )
    else:
        await rp_action(update, context, "—É–±–∏–ª(–∞)", "üî™")

async def resurrect(update: Update, context: ContextTypes.DEFAULT_TYPE):
    message = update.message
    from_user = message.from_user
    target_msg = message.reply_to_message

    if not target_msg:
        return

    target_user = target_msg.from_user
    chat_id = message.chat_id

    mute_data = get_active_mute(target_user.id, chat_id)

    if not mute_data or mute_data[2] != "RP Command" or mute_data[3] != "–£–±–∏—Ç":
        await message.reply_text("‚ö∞ –≠—Ç–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –º–µ—Ä—Ç–≤ –∏–ª–∏ –µ–≥–æ –Ω–µ–ª—å–∑—è –≤–æ—Å–∫—Ä–µ—Å–∏—Ç—å RP-–∫–æ–º–∞–Ω–¥–æ–π.")
        return

    # –°–Ω–∏–º–∞–µ–º –º—É—Ç
    await context.bot.restrict_chat_member(
        chat_id=chat_id,
        user_id=target_user.id,
        permissions=ChatPermissions(
            can_send_messages=True,
            can_send_polls=True,
            can_send_other_messages=True,
            can_add_web_page_previews=True,
            can_change_info=False,
            can_invite_users=True,
            can_pin_messages=True
        )
    )

    # –£–¥–∞–ª—è–µ–º –∏–∑ –±–∞–∑—ã
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute(
        "DELETE FROM mutes WHERE muted_user_id=? AND chat_id=? AND reason=? AND muted_by_user_id=?",
        (str(target_user.id), chat_id, "–£–±–∏—Ç", "RP Command")
    )
    conn.commit()
    conn.close()

    await rp_action(update, context, "–≤–æ—Å–∫—Ä–µ—Å–∏–ª(–∞)", "üïä")

async def rp_action(update: Update, context: ContextTypes.DEFAULT_TYPE, action_text: str, emoji: str):
    message = update.message
    user = message.from_user
    target_msg = message.reply_to_message

    if not target_msg:
        return  # –º–æ–ª—á–∞ –∏–≥–Ω–æ—Ä

    target_user = target_msg.from_user

    user_mention = get_display_name_html_new(user)
    target_mention = get_display_name_html_new(target_user)

    extra_text = message.text.split(maxsplit=1)
    comment = escape(extra_text[1]) if len(extra_text) > 1 else ""

    text = f"{emoji} | {user_mention} {escape(action_text)} {target_mention}"
    if comment:
        text += f"\nüí¨ –° —Ä–µ–ø–ª–∏–∫–æ–π: ¬´{comment}¬ª"

    await message.reply_text(text, parse_mode="HTML")


async def cud(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await rp_action(update, context, "–æ–±–Ω—è–ª(-–∞)", "ü§ó")


async def hit(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await rp_action(update, context, "—É–¥–∞—Ä–∏–ª(-–∞)", "üòµ")


async def stroke(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await rp_action(update, context, "–ø–æ–≥–ª–∞–¥–∏–ª(-–∞)", "ü•∞")


async def kus(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await rp_action(update, context, "–∫—É—Å—å–Ω—É–ª(-–∞)", "ü•∞")


async def chmok(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await rp_action(update, context, "—á–º–æ–∫–Ω—É–ª(-–∞)", "ü•∞")


async def otliz(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await rp_action(update, context, "–æ—Ç–ª–∏–∑–∞–ª(-–∞)", "ü•µ")


async def kiss(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await rp_action(update, context, "–ø–æ—Ü–µ–ª–æ–≤–∞–ª(-–∞)", "üòò")


# --- –≥–ª–æ–±–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –±–ª–æ–∫–æ–≤ RP ---
rp_blocked = {}  # {user_id: end_timestamp}


# –ü—Ä–æ–≤–µ—Ä–∫–∞ RP-–±–ª–æ–∫–∞
def is_rp_blocked(user_id: int) -> bool:
    now = int(time.time())
    end_time = rp_blocked.get(user_id, 0)
    if now < end_time:
        return True
    elif end_time != 0:
        rp_blocked.pop(user_id, None)
    return False


# –ö–æ–º–∞–Ω–¥–∞ –∫–∞—Å—Ç—Ä–∞—Ü–∏–∏
async def kastrirovat(update: Update, context: ContextTypes.DEFAULT_TYPE):
    message = update.message
    target_msg = message.reply_to_message
    if not target_msg:
        await message.reply_text("‚ö† –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É –≤ –æ—Ç–≤–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –∂–µ—Ä—Ç–≤—ã.")
        return

    target_user = target_msg.from_user
    robber_id = message.from_user.id

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –Ω–æ–∂–Ω–∏—Ü –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    cursor.execute(
        "SELECT quantity FROM inventory WHERE owner_id=? AND item_name='–ù–æ–∂–Ω–∏—Ü—ã'",
        (str(robber_id),)
    )
    result = cursor.fetchone()
    scissors = result[0] if result else 0

    if scissors <= 0:
        await message.reply_text("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –Ω–æ–∂–Ω–∏—Ü –¥–ª—è –∫–∞—Å—Ç—Ä–∞—Ü–∏–∏.")
        conn.close()
        return

    if is_rp_blocked(target_user.id):
        await message.reply_text(f"üö´ {get_display_name_html_new(target_user)} —É–∂–µ –∫–∞—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω(–∞)!",
                                 parse_mode="HTML")
        conn.close()
        return

    # –°–Ω–∏–º–∞–µ–º 1 –Ω–æ–∂–Ω–∏—Ü—ã –∏–∑ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è
    cursor.execute(
        "UPDATE inventory SET quantity = quantity - 1 WHERE owner_id=? AND item_name='–ù–æ–∂–Ω–∏—Ü—ã'",
        (str(robber_id),)
    )
    conn.commit()
    conn.close()

    rp_blocked[target_user.id] = int(time.time()) + 600  # 10 –º–∏–Ω—É—Ç
    await rp_action(update, context, "–∫–∞—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª(-–∞)", "‚úÇÔ∏è")


# –ü—Ä–∏–º–µ—Ä RP-–∫–æ–º–∞–Ω–¥—ã, –ø—Ä–æ–≤–µ—Ä–∫–∞ –±–ª–æ–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
async def fuck(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.message.from_user
    if is_rp_blocked(user.id):
        await update.message.reply_text("üö´ –¢—ã –∫–∞—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω!")
        return
    await rp_action(update, context, "—Ç—Ä–∞—Ö–Ω—É–ª(-–∞)", "ü•µ")


# –û–¢–°–û–°–ê–õ ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ–º –±–ª–æ–∫ —Ü–µ–ª–∏
async def otsos(update: Update, context: ContextTypes.DEFAULT_TYPE):
    message = update.message
    target_msg = message.reply_to_message
    if not target_msg:
        await message.reply_text("‚ö† –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É –≤ –æ—Ç–≤–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –∂–µ—Ä—Ç–≤—ã.")
        return
    target_user = target_msg.from_user

    if is_rp_blocked(target_user.id):
        await update.message.reply_text(
            f"üö´ –ù–µ–ª—å–∑—è –æ—Ç—Å–æ—Å–∞—Ç—å {get_display_name_html_new(target_user)}, –æ–Ω –∫–∞—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω!",
            parse_mode="HTML"
        )
        return

    await rp_action(update, context, "–æ—Ç—Å–æ—Å–∞–ª(-–∞)", "ü•µ")


async def viebal(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.message.from_user
    if is_rp_blocked(user.id):
        await update.message.reply_text("üö´ –¢—ã –∫–∞—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω!")
        return
    await rp_action(update, context, "–≤—ã–µ–±–∞–ª(-–∞)", "ü•µ")


async def cum(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.message.from_user
    if is_rp_blocked(user.id):
        await update.message.reply_text("üö´ –¢—ã –∫–∞—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω!")
        return
    await rp_action(update, context, "–∫–æ–Ω—á–∏–ª(-–∞)", "üí¶")

MIN_ADMIN_LEVEL = 3


def get_chat_admin_level(chat_id: str, user_id: str):
    """
    –ü–æ–ª—É—á–∏—Ç—å —É—Ä–æ–≤–µ–Ω—å –∞–¥–º–∏–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —á–∞—Ç–µ
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç int: —É—Ä–æ–≤–µ–Ω—å –∞–¥–º–∏–Ω–∞ –∏–ª–∏ -1 –µ—Å–ª–∏ –Ω–µ –∞–¥–º–∏–Ω
    """
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute(
        "SELECT admin_level FROM chat_admins WHERE chat_id = ? AND user_id = ?",
        (str(chat_id), str(user_id))
    )
    row = cursor.fetchone()
    conn.close()

    if row:
        return int(row[0]) if row[0] is not None else -1
    return -1


def get_admin_role_name(level: int) -> str:
    """–ü–æ–ª—É—á–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ —Ä–æ–ª–∏ –ø–æ —É—Ä–æ–≤–Ω—é"""
    if 0 <= level < len(CHAT_ADMINS_ROLE_LIST ):
        return CHAT_ADMINS_ROLE_LIST [level]
    return "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è —Ä–æ–ª—å"

async def delsms_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = str(update.effective_user.id)
    chat_id = str(update.effective_chat.id)
    username = update.effective_user.username or update.effective_user.first_name or "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"

    # –ü–æ–ª—É—á–∞–µ–º —É—Ä–æ–≤–µ–Ω—å –∞–¥–º–∏–Ω–∞ –≤ —á–∞—Ç–µ
    admin_level = get_chat_admin_level(chat_id, user_id)

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ (—É—Ä–æ–≤–µ–Ω—å 3 –∏ –≤—ã—à–µ = –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä –∏ –≤—ã—à–µ)
    if admin_level < MIN_ADMIN_LEVEL:
        role_name = get_admin_role_name(admin_level) if admin_level >= 0 else "–ù–µ –∞–¥–º–∏–Ω"

        await update.message.reply_text(
            f"‚ùå <b>–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞</b>\n\n"
            f"üë§ –í–∞—à–∞ —Ä–æ–ª—å: <code>{role_name}</code>\n"
            f"üìã –¢—Ä–µ–±—É–µ–º–∞—è —Ä–æ–ª—å: <code>–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä (—Ä–∞–Ω–≥ 3+)</code>\n\n"
            f"<i>–£ –≤–∞—Å –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π.</i>",
            parse_mode='HTML'
        )
        return

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —ç—Ç–æ –æ—Ç–≤–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ
    if not update.message.reply_to_message:
        await update.message.reply_text(
            "‚ö†Ô∏è <b>–û—à–∏–±–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è</b>\n\n"
            "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–≤–µ—Ç—å—Ç–µ —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥–æ–π –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å.",
            parse_mode='HTML'
        )
        return

    try:
        # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —É–¥–∞–ª—è–µ–º–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏
        deleted_msg = update.message.reply_to_message
        deleted_user = deleted_msg.from_user.first_name or "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"

        # –£–¥–∞–ª—è–µ–º –æ–±–∞ —Å–æ–æ–±—â–µ–Ω–∏—è (–∫–æ–º–∞–Ω–¥–∞ –∏ —Ü–µ–ª–µ–≤–æ–µ)
        await deleted_msg.delete()
        await update.message.delete()

        # –õ–æ–≥–∏—Ä—É–µ–º –≤ –∫–æ–Ω—Å–æ–ª—å
        import logging
        logging.info(
            f"[DEL] –ê–¥–º–∏–Ω {username} (ID: {user_id}, —É—Ä–æ–≤–µ–Ω—å: {admin_level}) "
            f"—É–¥–∞–ª–∏–ª —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç {deleted_user} –≤ —á–∞—Ç–µ {chat_id}"
        )

    except Exception as e:
        await update.message.reply_text(
            f"‚ùå <b>–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è</b>\n\n"
            f"<code>{str(e)}</code>",
            parse_mode='HTML'
        )


# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

async def checkadmin_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """
    –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–≤–æ–µ–≥–æ —É—Ä–æ–≤–Ω—è –∞–¥–º–∏–Ω–∞ –≤ —á–∞—Ç–µ
    –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /–∞–¥–º–∏–Ω –∏–ª–∏ /checkadmin
    """
    user_id = str(update.effective_user.id)
    chat_id = str(update.effective_chat.id)
    username = update.effective_user.username or update.effective_user.first_name or "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"

    admin_level = get_chat_admin_level(chat_id, user_id)

    if admin_level < 0:
        await update.message.reply_text(
            f"‚ùå –í—ã –Ω–µ —è–≤–ª—è–µ—Ç–µ—Å—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º —ç—Ç–æ–≥–æ —á–∞—Ç–∞.",
            parse_mode='HTML'
        )
        return

    role_name = get_admin_role_name(admin_level)

    text = (
        f"üë§ <b>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–µ</b>\n\n"
        f"üîπ <b>–ù–∏–∫:</b> @{username}\n"
        f"üîπ <b>ID:</b> <code>{user_id}</code>\n"
        f"üîπ <b>–†–æ–ª—å:</b> <code>{role_name}</code>\n"
        f"üîπ <b>–£—Ä–æ–≤–µ–Ω—å:</b> <code>{admin_level}</code>"
    )

    if admin_level >= MIN_ADMIN_LEVEL:
        text += f"\n\n‚úÖ <b>–í—ã –º–æ–∂–µ—Ç–µ —É–¥–∞–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è (-—Å–º—Å)</b>"
    else:
        text += f"\n\n‚ùå <b>–í—ã –Ω–µ –º–æ–∂–µ—Ç–µ —É–¥–∞–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è</b>\n<i>–¢—Ä–µ–±—É–µ—Ç—Å—è —Ä–∞–Ω–≥ 3+</i>"

    await update.message.reply_text(text, parse_mode='HTML')


def set_u_status(user_id: str, status: int):
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("UPDATE users SET status = ? WHERE user_id = ?", (status, user_id))
    conn.commit()
    conn.close()


async def dev_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = str(update.effective_user.id)

    if user_id not in DEV_IDS:
        await update.message.reply_text("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞.")
        return

    set_u_status(user_id, 13)  # 13 - "–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫"

    await update.message.reply_text(
        f"‚úÖ –í–∞—à —Å—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω–µ–Ω.\n–°—Ç–∞—Ç—É—Å: *{STATUS_LIST[13]}*.",
        parse_mode="Markdown"
    )


async def global_vip_commands_hendler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    args = context.args  # –∞—Ä–≥—É–º–µ–Ω—Ç—ã –∫–æ–º–∞–Ω–¥—ã –ø–æ—Å–ª–µ /vip

    if not args:
        await myvip_command(update, context)
        return

    subcmd = args[0].lower()
    if subcmd == "–∫—É–ø–∏—Ç—å":
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é –ø–æ–∫—É–ø–∫–∏ –≤–∏–ø–∞
        await vip_command(update, context)
    elif subcmd == "–æ—Ñ—Ñ":
        # –û—Ç–∫–ª—é—á–∞–µ–º –≤–∏–ø
        await offvip_command(update, context)
    else:
        await update.message.reply_text(
            "‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –ø–æ–¥–∫–æ–º–∞–Ω–¥–∞.\n–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ:\n"
            "–≤–∏–ø ‚Äî –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å—Ç–∞—Ç—É—Å –í–ò–ü\n"
            "–≤–∏–ø –∫—É–ø–∏—Ç—å ‚Äî –∫—É–ø–∏—Ç—å –í–ò–ü\n"
            "–≤–∏–ø –æ—Ñ—Ñ ‚Äî –æ—Ç–∫–ª—é—á–∏—Ç—å –í–ò–ü"
        )


DEVELOPER_STATUS = 12
# –°–ª–æ–≤–∞—Ä—å –∫–∞—Ç–µ–≥–æ—Ä–∏–π —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º –∏ —Ñ—É–Ω–∫—Ü–∏–µ–π –æ–±–Ω—É–ª–µ–Ω–∏—è
CATEGORIES = {
    "balance": {
        "label": "üí∞ –ë–∞–ª–∞–Ω—Å",
        "description": "–û–±–Ω—É–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π",
    },
    "seeds": {
        "label": "üå± –°–µ–º–µ–Ω–∞",
        "description": "–û–±–Ω—É–ª–µ–Ω–∏–µ —Å–µ–º—è–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π",
    },
    "bank": {
        "label": "üè¶ –ë–∞–Ω–∫",
        "description": "–£–º–µ–Ω—å—à–µ–Ω–∏–µ –±–∞–Ω–∫–æ–≤—Å–∫–æ–≥–æ –±–∞–ª–∞–Ω—Å–∞ –Ω–∞ 80%",
    },
    "deposit": {
        "label": "üì• –î–µ–ø–æ–∑–∏—Ç",
        "description": "–û–±–Ω—É–ª–µ–Ω–∏–µ –¥–µ–ø–æ–∑–∏—Ç–∞",
    },
    "crypto": {
        "label": "ü™ô –ö—Ä–∏–ø—Ç–∞",
        "description": "–û–±–Ω—É–ª–µ–Ω–∏–µ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–Ω—ã—Ö –±–∞–ª–∞–Ω—Å–æ–≤",
    },
    "business": {
        "label": "üè¢ –ë–∏–∑–Ω–µ—Å",
        "description": "–û–±–Ω—É–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –±–∏–∑–Ω–µ—Å–∞",
    },
}


async def zeroing_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = str(update.effective_user.id)

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT status FROM users WHERE user_id=?", (user_id,))
    row = cursor.fetchone()
    conn.close()

    if not row or row[0] != DEVELOPER_STATUS:
        await update.message.reply_text("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥–µ.")
        return

    keyboard = InlineKeyboardMarkup([
        [
            InlineKeyboardButton(CATEGORIES["balance"]["label"], callback_data=f"zero_select:balance:{user_id}"),
            InlineKeyboardButton(CATEGORIES["seeds"]["label"], callback_data=f"zero_select:seeds:{user_id}"),
            InlineKeyboardButton(CATEGORIES["bank"]["label"], callback_data=f"zero_select:bank:{user_id}"),
        ],
        [
            InlineKeyboardButton(CATEGORIES["deposit"]["label"], callback_data=f"zero_select:deposit:{user_id}"),
            InlineKeyboardButton(CATEGORIES["crypto"]["label"], callback_data=f"zero_select:crypto:{user_id}"),
            InlineKeyboardButton(CATEGORIES["business"]["label"], callback_data=f"zero_select:business:{user_id}"),
        ]
    ])

    await update.message.reply_text(
        "üîÑ <b>–û–±–Ω—É–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤—Å–µ—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤</b>\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –¥–ª—è –æ–±–Ω—É–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö:",
        reply_markup=keyboard,
        parse_mode="HTML"
    )


async def zeroing_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    data = query.data
    user_id = str(query.from_user.id)

    # –†–∞–∑–±–æ—Ä callback_data —Å –∑–∞—â–∏—Ç–æ–π –ø–æ user_id
    parts = data.split(":")
    action = parts[0]  # zero_select, zero_confirm, zero_cancel, zero_back
    category = parts[1] if len(parts) > 2 else None
    callback_user_id = parts[-1]

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –ø–æ user_id (—á—Ç–æ–±—ã –Ω–µ –º–æ–≥ –Ω–∞–∂–∞—Ç—å —á—É–∂–æ–π)
    if callback_user_id != user_id:
        await query.answer("‚õî –¢–æ–ª—å–∫–æ –æ—Ç–ø—Ä–∞–≤–∏–≤—à–∏–π –∫–æ–º–∞–Ω–¥—É –º–æ–∂–µ—Ç –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å.", show_alert=True)
        return

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–∞–∑–µ (–∑–∞—â–∏—Ç–∞ –æ—Ç –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö)
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT status FROM users WHERE user_id=?", (user_id,))
    row = cursor.fetchone()
    conn.close()

    if not row or row[0] != DEVELOPER_STATUS:
        await query.answer("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥–µ.", show_alert=True)
        return

    if action == "zero_select":
        if category not in CATEGORIES:
            await query.edit_message_text("‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è.")
            return
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
        keyboard = InlineKeyboardMarkup([
            [
                InlineKeyboardButton("‚úÖ –û–±–Ω—É–ª–∏—Ç—å", callback_data=f"zero_confirm:{category}:{user_id}"),
                InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data=f"zero_back:{user_id}")
            ]
        ])

        await query.edit_message_text(
            f"‚ö†Ô∏è –û–±–Ω—É–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤.\n\n"
            f"üìÇ –ö–∞—Ç–µ–≥–æ—Ä–∏—è: <b>{CATEGORIES[category]['label']}</b>\n\n"
            f"ü§î –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å?",
            reply_markup=keyboard,
            parse_mode="HTML"
        )
        return

    if action == "zero_back":
        # –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –º–µ–Ω—é –≤—ã–±–æ—Ä–∞
        keyboard = InlineKeyboardMarkup([
            [
                InlineKeyboardButton(CATEGORIES["balance"]["label"], callback_data=f"zero_select:balance:{user_id}"),
                InlineKeyboardButton(CATEGORIES["seeds"]["label"], callback_data=f"zero_select:seeds:{user_id}"),
                InlineKeyboardButton(CATEGORIES["bank"]["label"], callback_data=f"zero_select:bank:{user_id}"),
            ],
            [
                InlineKeyboardButton(CATEGORIES["deposit"]["label"], callback_data=f"zero_select:deposit:{user_id}"),
                InlineKeyboardButton(CATEGORIES["crypto"]["label"], callback_data=f"zero_select:crypto:{user_id}"),
                InlineKeyboardButton(CATEGORIES["business"]["label"], callback_data=f"zero_select:business:{user_id}"),
            ]
        ])
        await query.edit_message_text(
            "üßπ –û–±–Ω—É–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –í–°–ï–• –∞–∫–∫–∞—É–Ω—Ç–æ–≤.\n\n"
            "‚ùì –ß—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ–±–Ω—É–ª–∏—Ç—å? üîÑ",
            reply_markup=keyboard
        )
        return

    if action == "zero_cancel":
        await query.edit_message_text("‚ùå –û—Ç–º–µ–Ω–µ–Ω–æ.")
        return

    if action == "zero_confirm":
        if category not in CATEGORIES:
            await query.edit_message_text("‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è.")
            return

        # –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å –æ–±–Ω—É–ª–µ–Ω–∏—è —Å –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º
        await perform_zeroing(query, category)


import asyncio


async def perform_zeroing(query, category):
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    cursor.execute("SELECT COUNT(*) FROM users")
    total_accounts = cursor.fetchone()[0]

    cursor.execute("SELECT user_id FROM users")
    users = [row[0] for row in cursor.fetchall()]

    zeroed_count = 0
    total_sum = 0
    batch_commit_size = 200

    # –ü–µ—Ä–≤–∏—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    await query.edit_message_text(
        f"‚è≥ –û–±–Ω—É–ª–µ–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–æ–≤...",
        parse_mode="HTML"
    )

    # –ó–∞–¥–µ—Ä–∂–∫–∞ 2 —Å–µ–∫—É–Ω–¥—ã
    await asyncio.sleep(2)

    for i, uid in enumerate(users, start=1):
        if category == "balance":
            cursor.execute("SELECT balance FROM users WHERE user_id=?", (uid,))
            old_balance = cursor.fetchone()[0] or 0
            cursor.execute("UPDATE users SET balance=0 WHERE user_id=?", (uid,))
            total_sum += old_balance

        elif category == "seeds":
            cursor.execute("SELECT seeds FROM users WHERE user_id=?", (uid,))
            old_seeds = cursor.fetchone()[0] or 0
            cursor.execute("UPDATE users SET seeds=0 WHERE user_id=?", (uid,))
            total_sum += old_seeds

        elif category == "bank":
            cursor.execute("SELECT balance FROM Bank_New WHERE user_id=?", (uid,))
            row = cursor.fetchone()
            if row:
                try:
                    old_bank_balance = int(row[0])
                except (ValueError, TypeError):
                    old_bank_balance = 0
                new_balance = int(old_bank_balance * 0.2)
                diff = old_bank_balance - new_balance
                cursor.execute("UPDATE Bank_New SET balance=? WHERE user_id=?", (str(new_balance), uid))
                total_sum += diff

        elif category == "deposit":
            cursor.execute("SELECT deposit_balance FROM Bank_Deposit WHERE user_id=?", (uid,))
            row = cursor.fetchone()
            if row:
                old_deposit = row[0] or 0
                cursor.execute("UPDATE Bank_Deposit SET deposit_balance=0 WHERE user_id=?", (uid,))
                total_sum += old_deposit

        elif category == "crypto":
            cursor.execute("SELECT balance FROM crypto_balances WHERE user_id=?", (uid,))
            rows = cursor.fetchall()
            for r in rows:
                old_crypto = r[0] or 0
                total_sum += old_crypto
            cursor.execute("DELETE FROM crypto_balances WHERE user_id=?", (uid,))

        elif category == "business":
            cursor.execute("SELECT business_balance FROM businesses_XUI WHERE user_id=?", (uid,))
            row = cursor.fetchone()
            if row:
                old_business_balance = row[0] or 0
                cursor.execute("UPDATE businesses_XUI SET business_balance=0 WHERE user_id=?", (uid,))
                total_sum += old_business_balance

        zeroed_count += 1

        if i % batch_commit_size == 0 or i == total_accounts:
            conn.commit()

    conn.close()

    formatted_sum = f"{total_sum:,}".replace(",", ".")
    await query.edit_message_text(
        f"‚úÖ –ê–∫–∫–∞—É–Ω—Ç—ã –æ–±–Ω—É–ª–µ–Ω—ã.\n\n"
        f"üìÇ –ö–∞—Ç–µ–≥–æ—Ä–∏—è: <b>{CATEGORIES[category]['label']}</b>\n"
        f"üë• –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ –∞–∫–∫–∞—É–Ω—Ç–æ–≤: <b>{zeroed_count}</b>\n"
        f"üí∞ –û–±—â–∞—è —Å—É–º–º–∞ –æ–±–Ω—É–ª–µ–Ω–∏—è: <b>{formatted_sum}</b>",
        parse_mode="HTML"
    )


def set_tehwork(value: int):
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("REPLACE INTO settings (key, value) VALUES (?, ?)", ("tehwork", str(value)))
    conn.commit()
    conn.close()


def get_tehwork() -> int:
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT value FROM settings WHERE key = ?", ("tehwork",))
    result = cursor.fetchone()
    conn.close()
    return int(result[0]) if result else 0


last_tehwork_usage = {}
COOLDOWN_TEHWORK_SECONDS = 300


async def tehwork_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = str(update.effective_user.id)
    now = datetime.now()

    last_used = last_tehwork_usage.get(user_id)

    if last_used and (now - last_used).total_seconds() < COOLDOWN_TEHWORK_SECONDS:
        remaining = int(COOLDOWN_TEHWORK_SECONDS - (now - last_used).total_seconds())
        minutes, seconds = divmod(remaining, 60)
        await update.message.reply_text(
            "‚è≥ *–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ...*\n"
            "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
            f"‚è∞ –û—Å—Ç–∞–ª–æ—Å—å: *{minutes} –º–∏–Ω. {seconds} —Å–µ–∫.*\n"
            "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
            "‚è≥ –ù–µ —Ç–æ—Ä–æ–ø–∏—Ç–µ—Å—å, —Å–∫–æ—Ä–æ —Å–º–æ–∂–µ—Ç–µ —Å–Ω–æ–≤–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–æ–º–∞–Ω–¥—É!",
            parse_mode="Markdown"
        )
        return

    status = get_tehwork()
    last_tehwork_usage[user_id] = now

    if status == 1:
        await update.message.reply_text("‚öôÔ∏è *–ü—Ä–æ—Ö–æ–¥—è—Ç —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ä–∞–±–æ—Ç—ã...*", parse_mode="Markdown")
    else:
        await update.message.reply_text("‚úÖ *–ù–µ—Ç —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö —Ä–∞–±–æ—Ç.*", parse_mode="Markdown")


def get_user_data_tehwork(user_id: str):
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT * FROM users WHERE user_id = ?", (user_id,))
    row = cursor.fetchone()

    if row is None:
        conn.close()
        return None

    keys = [desc[0] for desc in cursor.description]
    user_data = dict(zip(keys, row))

    conn.close()
    return user_data


async def settehwork_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = str(update.effective_user.id)
    user_data = get_user_data_tehwork(user_id)

    if not user_data:
        await update.message.reply_text("‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.")
        return

    user_status = user_data.get("status", 0)

    if user_status < 8:
        await update.message.reply_text("‚ùå –£ —Ç–µ–±—è –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞.")
        return

    if len(context.args) != 1 or context.args[0] not in ["0", "1"]:
        await update.message.reply_text(
            "‚öôÔ∏è *–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã:*\n\n"
            "0Ô∏è‚É£ ‚Äî –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ä–∞–±–æ—Ç—ã\n"
            "1Ô∏è‚É£ ‚Äî –Ω–∞—á–∞—Ç—å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ä–∞–±–æ—Ç—ã\n\n"
            "–ü—Ä–∏–º–µ—Ä:\n"
            "/settehwork 0\n"
            "/settehwork 1",
            parse_mode="Markdown"
        )
        return

    new_status = int(context.args[0])
    set_tehwork(new_status)

    msg = "‚úÖ –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ä–∞–±–æ—Ç—ã –≤–∫–ª—é—á–µ–Ω—ã." if new_status == 1 else "‚úÖ –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ä–∞–±–æ—Ç—ã –≤—ã–∫–ª—é—á–µ–Ω—ã."
    await update.message.reply_text(msg)


def init_settings():
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    cursor.execute("""
    CREATE TABLE IF NOT EXISTS settings (
        key TEXT PRIMARY KEY,
        value TEXT
    )
    """)

    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –µ—Å–ª–∏ –µ—â—ë –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ
    cursor.execute("INSERT OR IGNORE INTO settings (key, value) VALUES (?, ?)", ("tehwork", "0"))

    conn.commit()
    conn.close()


def get_us_data(user_id: str):
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT * FROM users WHERE user_id = ?", (user_id,))
    row = cursor.fetchone()
    conn.close()
    return row


def get_username(user_id: str):
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT username, first_name FROM users WHERE user_id = ?", (user_id,))
    row = cursor.fetchone()
    conn.close()
    if row:
        username, first_name = row
        return username if username else first_name if first_name else "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"
    return "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"

def transfer_currency(sender_id: str, target_id: str, amount: int, currency: str) -> tuple[bool, dict]:
    """
    currency: 'seeds' –∏–ª–∏ 'dc_balance'

    –î–ª—è DC: –∫–æ–º–∏—Å—Å–∏—è –≤—ã—á–∏—Ç–∞–µ—Ç—Å—è –ò–ó —Å—É–º–º—ã –ø–µ—Ä–µ–≤–æ–¥–∞.
    –û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å –ø–ª–∞—Ç–∏—Ç —Ä–æ–≤–Ω–æ amount, –ø–æ–ª—É—á–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç amount - commission.
    """
    conn = sqlite3.connect(DB_PATH, timeout=30.0, check_same_thread=False)
    conn.execute("PRAGMA journal_mode=WAL")
    conn.execute("PRAGMA busy_timeout=10000")
    cursor = conn.cursor()

    info = {}

    try:
        cursor.execute("BEGIN TRANSACTION;")

        cursor.execute(f"SELECT {currency} FROM users WHERE user_id = ?", (sender_id,))
        row = cursor.fetchone()
        if not row:
            conn.rollback()
            return False, info

        sender_balance = row[0] or 0

        if currency == "dc_balance":
            commission = int(amount * DC_BURN_RATE)   # –∫–æ–º–∏—Å—Å–∏—è –∏–∑ —Å—É–º–º—ã
            receiver_amount = amount - commission      # –ø–æ–ª—É—á–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç –º–µ–Ω—å—à–µ
            info["commission"] = commission
            info["receiver_amount"] = receiver_amount

            if sender_balance < amount:
                conn.rollback()
                info["balance"] = sender_balance
                return False, info

            # –°–ø–∏—Å—ã–≤–∞–µ–º —É –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è —Ä–æ–≤–Ω–æ amount
            cursor.execute(
                "UPDATE users SET dc_balance = dc_balance - ? WHERE user_id = ?",
                (amount, sender_id)
            )
            # –ü–æ–ª—É—á–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç amount - commission
            cursor.execute(
                "UPDATE users SET dc_balance = COALESCE(dc_balance, 0) + ? WHERE user_id = ?",
                (receiver_amount, target_id)
            )
            # commission DC —Å–≥–æ—Ä–∞–µ—Ç (–Ω–µ –Ω–∞—á–∏—Å–ª—è–µ—Ç—Å—è –Ω–∏–∫–æ–º—É)

        else:
            if sender_balance < amount:
                conn.rollback()
                info["balance"] = sender_balance
                return False, info

            cursor.execute(
                "UPDATE users SET seeds = seeds - ? WHERE user_id = ?",
                (amount, sender_id)
            )
            cursor.execute(
                "UPDATE users SET seeds = COALESCE(seeds, 0) + ? WHERE user_id = ?",
                (amount, target_id)
            )

        conn.commit()
        info["balance"] = sender_balance
        return True, info

    except Exception as e:
        conn.rollback()
        raise e
    finally:
        conn.close()

async def give_currency(update: Update, context: ContextTypes.DEFAULT_TYPE):
    message_text = update.message.text or ""
    parts = message_text.split()
    args = parts[1:]  # –≤—Å—ë –ø–æ—Å–ª–µ "–ø–µ—Ä–µ–¥–∞—Ç—å"

    CURRENCY_MAP = {
        "—Å–µ–º–µ–Ω–∞": "seeds",
        "seeds": "seeds",
        "–¥—Ü": "dc_balance",
        "dc": "dc_balance",
    }

    CURRENCY_LABELS = {
        "seeds": ("üå±", "—Å–µ–º—è–Ω", "—Å–µ–º–µ–Ω–∞"),
        "dc_balance": ("üíé", "DC", "DC"),
    }

    currency_raw = None
    amount = None
    target_id = None

    if len(args) >= 3:
        if args[0].lower() in CURRENCY_MAP:
            currency_raw = args[0].lower()
            target_id = args[1]
            try:
                amount = int(args[2])
            except ValueError:
                pass
        elif args[1].lower() in CURRENCY_MAP:
            target_id = args[0]
            currency_raw = args[1].lower()
            try:
                amount = int(args[2])
            except ValueError:
                pass

    elif len(args) == 2:
        if args[0].lower() in CURRENCY_MAP and update.message.reply_to_message:
            currency_raw = args[0].lower()
            target_id = str(update.message.reply_to_message.from_user.id)
            try:
                amount = int(args[1])
            except ValueError:
                pass
        else:
            target_id = args[0]
            currency_raw = "seeds"
            try:
                amount = int(args[1])
            except ValueError:
                pass

    elif len(args) == 1 and update.message.reply_to_message:
        target_id = str(update.message.reply_to_message.from_user.id)
        currency_raw = "seeds"
        try:
            amount = int(args[0])
        except ValueError:
            pass

    if not currency_raw or not target_id or amount is None:
        await update.message.reply_text(
            "‚ùóÔ∏è <b>–§–æ—Ä–º–∞—Ç:</b>\n"
            "<code>–ø–µ—Ä–µ–¥–∞—Ç—å —Å–µ–º–µ–Ω–∞|dc &lt;ID&gt; &lt;–∫–æ–ª-–≤–æ&gt;</code>\n"
            "–∏–ª–∏ –æ—Ç–≤–µ—Ç–æ–º: <code>–ø–µ—Ä–µ–¥–∞—Ç—å —Å–µ–º–µ–Ω–∞|dc &lt;–∫–æ–ª-–≤–æ&gt;</code>",
            parse_mode="HTML"
        )
        return

    if amount <= 0:
        await update.message.reply_text("‚ùå –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º.")
        return

    currency = CURRENCY_MAP[currency_raw]
    emoji, label_gen, label_nom = CURRENCY_LABELS[currency]

    sender_id = str(update.message.from_user.id)

    if target_id == sender_id:
        await update.message.reply_text("‚ùå –ù–µ–ª—å–∑—è –ø–µ—Ä–µ–¥–∞—Ç—å –≤–∞–ª—é—Ç—É —Å–∞–º–æ–º—É —Å–µ–±–µ.")
        return

    sender_data = get_us_data(sender_id)
    target_data = get_us_data(target_id)

    if not sender_data:
        await update.message.reply_text("‚ùå –í–∞—à –ø—Ä–æ—Ñ–∏–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ.")
        return
    if not target_data:
        await update.message.reply_text("‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å-–ø–æ–ª—É—á–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ.")
        return

    FIELD_INDEX = {"seeds": 6, "dc_balance": 20}
    try:
        sender_balance = int(sender_data[FIELD_INDEX[currency]] or 0)
    except (ValueError, TypeError):
        await update.message.reply_text("‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –±–∞–∑—ã.\n–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.")
        return

    # –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞
    if currency == "dc_balance":
        if sender_balance < amount:
            await update.message.reply_text(
                f"‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ DC.\n"
                f"üíé –ù—É–∂–Ω–æ: <b>{amount} DC</b>\n"
                f"üíé –£ –≤–∞—Å: <b>{sender_balance} DC</b>",
                parse_mode="HTML"
            )
            return
    else:
        if sender_balance < amount:
            await update.message.reply_text(
                f"‚ùå –£ –≤–∞—Å –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ {label_gen}.\n"
                f"{emoji} –£ –≤–∞—Å: <b>{sender_balance}</b>.",
                parse_mode="HTML"
            )
            return

    success, info = transfer_currency(sender_id, target_id, amount, currency)

    if not success:
        await update.message.reply_text("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –ø–µ—Ä–µ–≤–æ–¥. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.")
        return

    if currency == "dc_balance":
        commission = info.get("commission", 0)
        try:
            distribute_commission_to_central_banks(commission)
        except Exception:
            pass

    sender_link = get_display_name_html_new(update.message.from_user)
    target_link = get_display_name_html_by_id(target_id)

    if currency == "dc_balance":
        commission = info.get("commission", 0)
        receiver_amount = info.get("receiver_amount", amount)
        cb_rubles = int(commission * CB_SHARE_RATE) * DC_TO_RUBLES_RATE

        await update.message.reply_text(
            f"üéâ <b>–ü–µ—Ä–µ–¥–∞—á–∞ DC!</b>\n\n"
            f"üíé –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: <b>{amount} DC</b>\n"
            f"üî• –ö–æ–º–∏—Å—Å–∏—è (18%): <b>{commission} DC</b>\n"
            f"üì© –ü–æ–ª—É—á–µ–Ω–æ: <b>{receiver_amount} DC</b>\n"
            f"üè¶ –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –ë–∞–Ω–∫ –ø–æ–ª—É—á–∏–ª: <b>{cb_rubles:,}‚ÇΩ</b>\n\n"
            f"üë§ –û—Ç: {sender_link}\n"
            f"‚ú® –ö–æ–º—É: {target_link}",
            parse_mode="HTML"
        )
    else:
        await update.message.reply_text(
            f"üéâ <b>–ü–µ—Ä–µ–¥–∞—á–∞ {label_gen}!</b>\n\n"
            f"{emoji} –ö–æ–ª-–≤–æ: <b>{amount} {label_nom}</b>\n"
            f"üë§ –û—Ç: {sender_link}\n"
            f"‚ú® –ö–æ–º—É: {target_link}",
            parse_mode="HTML"
        )

BATTLE_FILE = Path("battlename.json")
battle_active = False

DEVELOPER_LEVEL = 12


# –§—É–Ω–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç—ã —Å JSON
def load_battle():
    if not BATTLE_FILE.exists():
        # –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª —Å –ø—É—Å—Ç–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π
        data = {"participants": []}
        with open(BATTLE_FILE, "w", encoding="utf-8") as f:
            json.dump(data, f, ensure_ascii=False, indent=2)
        return data
    with open(BATTLE_FILE, "r", encoding="utf-8") as f:
        return json.load(f)


def save_battle(data):
    with open(BATTLE_FILE, "w", encoding="utf-8") as f:
        json.dump(data, f, ensure_ascii=False, indent=2)


# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
def get_use_status(user_id: str):
    user_data = get_us_data(user_id)
    if user_data:
        return int(user_data[4])
    return 0


def is_developer_or_higher(user_id: str) -> bool:
    return get_use_status(user_id) >= DEVELOPER_LEVEL


# –ö–æ–º–∞–Ω–¥—ã

async def startbattle(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = str(update.effective_user.id)
    if not is_developer_or_higher(user_id):
        await update.message.reply_text("‚ùå –¢–æ–ª—å–∫–æ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ –∏ –≤—ã—à–µ –º–æ–∂–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –±–∏—Ç–≤—ã.")
        return

    global battle_active
    if battle_active:
        await update.message.reply_text("‚ö† –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É–∂–µ –∑–∞–ø—É—â–µ–Ω–∞.")
        return

    battle_active = True
    await update.message.reply_text("‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ –±–∏—Ç–≤—É –æ—Ç–∫—Ä—ã—Ç–∞! –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /regname {–Ω–∏–∫} –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.")


async def stopbattle(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = str(update.effective_user.id)
    if not is_developer_or_higher(user_id):
        await update.message.reply_text("‚ùå –¢–æ–ª—å–∫–æ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ –∏ –≤—ã—à–µ –º–æ–∂–µ—Ç –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –±–∏—Ç–≤—ã.")
        return

    global battle_active
    if not battle_active:
        await update.message.reply_text("‚ö† –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É–∂–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞.")
        return

    battle_active = False
    await update.message.reply_text("‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ –±–∏—Ç–≤—É –∑–∞–∫—Ä—ã—Ç–∞.")


async def clearbattle(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = str(update.effective_user.id)
    if not is_developer_or_higher(user_id):
        await update.message.reply_text("‚ùå –¢–æ–ª—å–∫–æ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ –∏ –≤—ã—à–µ –º–æ–∂–µ—Ç –æ—á–∏—â–∞—Ç—å —Å–ø–∏—Å–æ–∫ –±–∏—Ç–≤—ã.")
        return

    data = {"participants": []}
    save_battle(data)
    await update.message.reply_text("‚úÖ –°–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –±–∏—Ç–≤—ã –æ—á–∏—â–µ–Ω.")


async def regname(update: Update, context: ContextTypes.DEFAULT_TYPE):
    global battle_active
    if not battle_active:
        await update.message.reply_text("‚ùå –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Å–µ–π—á–∞—Å –∑–∞–∫—Ä—ã—Ç–∞.")
        return

    args = context.args
    if len(args) < 1:
        await update.message.reply_text("‚ùó –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: /regname {–Ω–∏–∫}")
        return

    nick = " ".join(args).strip()
    if len(nick) > 50:
        await update.message.reply_text("‚ùó –ù–∏–∫ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π, –º–∞–∫—Å–∏–º—É–º 50 —Å–∏–º–≤–æ–ª–æ–≤.")
        return

    user_id = str(update.effective_user.id)

    data = load_battle()
    participants = data.get("participants", [])

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ
    for p in participants:
        if p["user_id"] == user_id:
            await update.message.reply_text("‚ùå –í—ã —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –≤ –±–∏—Ç–≤–µ.")
            return

    # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    participants.append({"user_id": user_id, "nick": nick})
    data["participants"] = participants
    save_battle(data)

    await update.message.reply_text(f"‚úÖ –í—ã —É—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –≤ –±–∏—Ç–≤–µ –ø–æ–¥ –Ω–∏–∫–æ–º: *{nick}*", parse_mode="Markdown")


async def nbattle(update: Update, context: ContextTypes.DEFAULT_TYPE):
    data = load_battle()
    participants = data.get("participants", [])

    if not participants:
        await update.message.reply_text("–°–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –ø—É—Å—Ç.")
        return

    count = len(participants)
    text = f"üìú *–°–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –±–∏—Ç–≤—ã:*\n*–ö–æ–ª-–≤–æ:* `{count}`\n\n"

    for p in participants:
        text += f"‚Ä¢ [{p['nick']}](tg://user?id={p['user_id']})\n"

    await update.message.reply_text(text, parse_mode="Markdown")


async def unreg(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if update.effective_user.id != 7406372338:
        await update.message.reply_text("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥–µ.")
        return

    args = context.args
    if len(args) < 1:
        await update.message.reply_text("‚ùó –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: /unreg {–Ω–∏–∫}")
        return

    nick_to_remove = " ".join(args).strip()

    data = load_battle()
    participants = data.get("participants", [])

    new_participants = [p for p in participants if p["nick"] != nick_to_remove]

    if len(new_participants) == len(participants):
        await update.message.reply_text(
            f"‚ö†Ô∏è *–£—á–∞—Å—Ç–Ω–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω!*\n\n"
            f"‚ùì –ù–∏–∫–Ω–µ–π–º: *{nick_to_remove}*",
            parse_mode="Markdown"
        )
        return

    data["participants"] = new_participants
    save_battle(data)

    await update.message.reply_text(
        f"üö´ *–£—á–∞—Å—Ç–Ω–∏–∫ –∏—Å–∫–ª—é—á—ë–Ω –∏–∑ –±–∏—Ç–≤—ã!*\n\n"
        f"üë§ –ù–∏–∫–Ω–µ–π–º: *{nick_to_remove}*",
        parse_mode="Markdown"
    )


async def error_handler(update, context):
    err = context.error
    if isinstance(err, OverflowError) and "too large to convert to SQLite INTEGER" in str(err):
        return  # –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º —ç—Ç—É –æ—à–∏–±–∫—É
    import traceback
    traceback.print_exception(type(err), err, err.__traceback__)


# –°–æ—Å—Ç–æ—è–Ω–∏—è
WAITING_FOR_PHOTO = 1


# –ö–æ–º–∞–Ω–¥–∞ /exchange
async def exchange_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    keyboard = InlineKeyboardMarkup([
        [InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data="cancel_exchange")]
    ])
    await update.message.reply_text(
        "üì∑ –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é –¥–ª—è –æ–±–º–µ–Ω–∞.",
        reply_markup=keyboard
    )
    return WAITING_FOR_PHOTO


# –û—Ç–º–µ–Ω–∞ –ø–æ –∫–Ω–æ–ø–∫–µ
async def cancel_exchange_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    await query.edit_message_text("‚ùå –û–±–º–µ–Ω –æ—Ç–º–µ–Ω—ë–Ω.")
    return ConversationHandler.END


# –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ç–æ
async def receive_photo(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    photo = update.message.photo[-1]
    file_id = photo.file_id

    now = datetime.now()
    date_str = now.strftime("%d.%m.%Y")
    time_str = now.strftime("%H:%M")
    user_name = user.first_name or "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"
    user_id = user.id
    mention = f"[{user_name}](tg://user?id={user_id})"

    caption = (
        f"{mention}\n"
        f"TelegramID: `{user_id}`\n"
        f"üìÖ –î–∞—Ç–∞: {date_str}\n"
        f"‚è∞ –í—Ä–µ–º—è: {time_str}"
    )

    # –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    await update.message.reply_text("‚úÖ –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏. –û–∂–∏–¥–∞–π—Ç–µ –æ—Ç–≤–µ—Ç–∞.")

    # –ü–µ—Ä–µ—Å—ã–ª–∫–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É
    admin_id = 7406372338
    await context.bot.send_photo(
        chat_id=admin_id,
        photo=file_id,
        caption=caption,
        parse_mode="Markdown",
        reply_markup=None  # –±–µ–∑ –∫–Ω–æ–ø–æ–∫
    )

    return ConversationHandler.END


# –û–±—Ä–∞–±–æ—Ç—á–∏–∫
exchange_conv_handler = ConversationHandler(
    entry_points=[CommandHandler("exchange", exchange_command)],
    states={
        WAITING_FOR_PHOTO: [
            MessageHandler(filters.PHOTO, receive_photo),
            CallbackQueryHandler(cancel_exchange_callback, pattern="^cancel_exchange$")
        ],
    },
    fallbacks=[],
)

REPORT_CHAT_ID = -1002717991572
admin_actions = {}  # temp storage: message_id -> list of actions


async def report_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    msg = update.message
    if not msg or not msg.reply_to_message:
        await msg.reply_text("‚ö†Ô∏è –ñ–∞–ª–æ–±–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ç–≤–µ—Ç–æ–º –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ.")
        return

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ —á–∞—Ç, –≥–¥–µ –≤—ã–∑–≤–∞–Ω–∞ –∫–æ–º–∞–Ω–¥–∞
    await msg.reply_text("‚ö†Ô∏è –ñ–∞–ª–æ–±–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏.")

    from_user = msg.from_user
    target_user = msg.reply_to_message.from_user
    reply_text = msg.reply_to_message.text or msg.reply_to_message.caption or "<i>[–Ω–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ]</i>"
    dt_now = datetime.now().strftime("%d.%m.%Y / %H:%M")

    chat_id = str(msg.chat_id).replace("-100", "")
    message_id = msg.reply_to_message.message_id
    msg_link = f"https://t.me/c/{chat_id}/{message_id}"

    text = (
        "üö® <b>–ü–æ—Å—Ç—É–ø–∏–ª–∞ –∂–∞–ª–æ–±–∞.</b>\n"
        f"üë§ <b>–û—Ç–ø—Ä–∞–≤–∏–ª:</b> {from_user.full_name}\n"
        f"üÜî <b>ID:</b> <code>{from_user.id}</code>\n"
        f"‚ö†Ô∏è <b>–ù–∞ –∫–æ–≥–æ –∂–∞–ª–æ–±–∞:</b> {target_user.full_name}\n"
        f"üÜî <b>ID:</b> <code>{target_user.id}</code>\n\n"
        f"üí¨ <b>–°–æ–æ–±—â–µ–Ω–∏–µ:</b>\n{reply_text}\n\n"
        f"üìÖ <b>–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è:</b> {dt_now}\n\n"
        f"üîó <b>–°—Å—ã–ª–∫–∏:</b>\n"
        f"‚Ä¢ <a href='{msg_link}'>–°–æ–æ–±—â–µ–Ω–∏–µ</a>\n"
        f"‚Ä¢ <a href='{msg_link}'>–ß–∞—Ç</a>"
    )

    keyboard = [
        [
            InlineKeyboardButton("üîá –ú—É—Ç", callback_data=f"mute:{target_user.id}:{msg.chat.id}:{message_id}"),
            InlineKeyboardButton("‚ùå -—Å–º—Å", callback_data=f"delete:{msg.chat.id}:{message_id}"),
        ],
        [
            InlineKeyboardButton(
                "‚úÖ –ó–∞–∫—Ä—ã—Ç—å —Ä–µ–ø–æ—Ä—Ç",
                callback_data=f"close:{from_user.id}:{target_user.id}:{msg.chat.id}:{message_id}"
            )
        ]
    ]

    sent = await context.bot.send_message(
        chat_id=REPORT_CHAT_ID,
        text=text,
        parse_mode=ParseMode.HTML,
        disable_web_page_preview=True,
        reply_markup=InlineKeyboardMarkup(keyboard)
    )

    admin_actions[sent.message_id] = []


async def handle_report_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    data = query.data
    await query.answer()

    msg_id = query.message.message_id
    action_log = admin_actions.setdefault(msg_id, [])

    if data.startswith("mute:"):
        _, target_id, chat_id, source_msg_id = data.split(":")
        try:
            member = await context.bot.get_chat_member(int(chat_id), int(target_id))

            # –ü—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –≤ –º—É—Ç–µ (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω)
            if isinstance(member, ChatMemberRestricted) and member.can_send_messages is False:
                return await query.answer("‚ö†Ô∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –≤ –º—É—Ç–µ.", show_alert=True)

            until_date = datetime.utcnow() + timedelta(hours=1)

            await context.bot.restrict_chat_member(
                chat_id=int(chat_id),
                user_id=int(target_id),
                permissions=ChatPermissions(can_send_messages=False),
                until_date=until_date
            )

            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –±–∞–∑—É
            timestamp_start = int(time.time())
            timestamp_end = timestamp_start + 3600
            reason = "–∂–∞–ª–æ–±–∞"
            muted_by_user_id = query.from_user.id

            conn = sqlite3.connect(DB_PATH)
            cursor = conn.cursor()
            cursor.execute("""
                CREATE TABLE IF NOT EXISTS mutes (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    muted_user_id TEXT NOT NULL,
                    muted_by_user_id TEXT NOT NULL,
                    reason TEXT,
                    duration INTEGER NOT NULL,
                    timestamp_start INTEGER NOT NULL,
                    timestamp_end INTEGER NOT NULL,
                    chat_id INTEGER NOT NULL DEFAULT 0
                )
            """)
            cursor.execute("""
                INSERT INTO mutes (muted_user_id, muted_by_user_id, reason, duration, timestamp_start, timestamp_end, chat_id)
                VALUES (?, ?, ?, ?, ?, ?, ?)
            """, (target_id, muted_by_user_id, reason, 3600, timestamp_start, timestamp_end, chat_id))
            conn.commit()
            conn.close()

            await context.bot.send_message(
                chat_id=int(chat_id),
                text=(
                    f"üîá <b>–ú—É—Ç –≤—ã–¥–∞–Ω</b>\n"
                    f"<a href='tg://user?id={target_id}'>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</a> –ø–æ–ª—É—á–∏–ª –º—É—Ç –Ω–∞ 1 —á–∞—Å.\n"
                    f"–ü—Ä–∏—á–∏–Ω–∞: <i>{reason}</i>"
                ),
                parse_mode=ParseMode.HTML
            )
            action_log.append("–º—É—Ç")
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –º—É—Ç–µ: {e}")
            await query.answer("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –∑–∞–º—É—Ç–∏—Ç—å", show_alert=True)

    elif data.startswith("delete:"):
        _, chat_id, source_msg_id = data.split(":")
        try:
            await context.bot.delete_message(chat_id=int(chat_id), message_id=int(source_msg_id))
            action_log.append("–£–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è")
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏: {e}")
            await query.answer("‚ö†Ô∏è –°–æ–æ–±—â–µ–Ω–∏–µ —É–∂–µ —É–¥–∞–ª–µ–Ω–æ –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ.", show_alert=True)

    elif data.startswith("close:"):
        _, reporter_id, target_id, source_chat_id_raw, source_msg_id = data.split(":")
        msg = query.message
        action_by = query.from_user  # –∫—Ç–æ –∑–∞–∫—Ä—ã–ª

        # –¢–µ–∫—Å—Ç –∂–∞–ª–æ–±—ã
        text_lines = msg.text.splitlines()
        message_text = ""
        try:
            start_idx = next(i for i, line in enumerate(text_lines) if "–°–æ–æ–±—â–µ–Ω–∏–µ" in line) + 1
            end_idx = next(i for i, line in enumerate(text_lines) if "–°—Å—ã–ª–∫–∏" in line)
            message_text = "\n".join(text_lines[start_idx:end_idx])
        except Exception:
            message_text = ""

        # –ü–æ–ª—É—á–∞–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
        try:
            reporter = await context.bot.get_chat_member(REPORT_CHAT_ID, int(reporter_id))
            target = await context.bot.get_chat_member(REPORT_CHAT_ID, int(target_id))
        except Exception:
            reporter = target = None

        final_text = (
                "‚úÖ <b>–†–µ–ø–æ—Ä—Ç –∑–∞–∫—Ä—ã—Ç.</b>\n"
                "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n"
                f"üë§ <b>–û—Ç–ø—Ä–∞–≤–∏–ª –∂–∞–ª–æ–±—É:</b>\n"
                f"<a href='tg://user?id={reporter_id}'>{reporter.user.full_name if reporter else '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</a>\n"
                f"ID: <code>{reporter_id}</code>\n\n"
                f"‚ö†Ô∏è <b>–ù–∞—Ä—É—à–∏—Ç–µ–ª—å:</b>\n"
                f"<a href='tg://user?id={target_id}'>{target.user.full_name if target else '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</a>\n"
                f"ID: <code>{target_id}</code>\n\n"
                f"üìÑ <b>–°—É—Ç—å –∂–∞–ª–æ–±—ã:</b>\n{message_text.strip()}\n\n"
                f"üõ† <b>–î–µ–π—Å—Ç–≤–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞:</b>\n" +
                "\n".join(f"‚Ä¢ {action}" for action in action_log + ["–∑–∞–∫—Ä—ã—Ç—å —Ä–µ–ø–æ—Ä—Ç"]) +
                f"\nüëÆ <b>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä:</b> <a href='tg://user?id={action_by.id}'>{action_by.full_name}</a>\n"
                "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
        )

        # –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∞–¥–º–∏–Ω-—á–∞—Ç–µ
        await msg.edit_text(final_text, parse_mode=ParseMode.HTML)
        admin_actions.pop(msg.message_id, None)

        # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ –∏—Å—Ö–æ–¥–Ω—ã–π —á–∞—Ç
        try:
            await context.bot.send_message(
                chat_id=int(source_chat_id_raw),
                text=(
                        f"‚úÖ <a href='tg://user?id={reporter_id}'>{reporter.user.full_name if reporter else '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}</a>, "
                        f"–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –∑–∞–∫—Ä—ã–ª –≤–∞—à—É –∂–∞–ª–æ–±—É.\n"
                        f"üëÆ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä: <a href='tg://user?id={action_by.id}'>{action_by.full_name}</a>\n"
                        f"üõ† –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è:\n" +
                        "\n".join(f"‚Ä¢ {action}" for action in action_log + ["–∑–∞–∫—Ä—ã—Ç—å —Ä–µ–ø–æ—Ä—Ç"])
                ),
                parse_mode=ParseMode.HTML
            )
        except Exception as e:
            print(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ –∏—Å—Ö–æ–¥–Ω—ã–π —á–∞—Ç: {e}")

        # –ù–∞—á–∏—Å–ª—è–µ–º –æ—á–∫–∏ –∞–¥–º–∏–Ω—É –≤ –±–∞–∑–µ admins
        try:
            conn = sqlite3.connect(DB_PATH)
            cursor = conn.cursor()

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∑–∞–ø–∏—Å—å –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
            cursor.execute("SELECT points FROM admins WHERE user_id = ?", (str(action_by.id),))
            row = cursor.fetchone()

            points_to_add = 10  # –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—á–∫–æ–≤ –∑–∞ –∑–∞–∫—Ä—ã—Ç–∏–µ —Ä–µ–ø–æ—Ä—Ç–∞

            if row:
                new_points = row[0] + points_to_add
                cursor.execute("UPDATE admins SET points = ? WHERE user_id = ?", (new_points, str(action_by.id)))
            else:
                cursor.execute("INSERT INTO admins (user_id, points, warnings) VALUES (?, ?, ?)",
                               (str(action_by.id), points_to_add, 0))

            conn.commit()
            conn.close()
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–∏ –æ—á–∫–æ–≤ –∞–¥–º–∏–Ω—É: {e}")

    else:
        # –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π callback
        await query.answer("‚ö†Ô∏è –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ", show_alert=True)


DATA_FILE = Path("chat_users.json")

# –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–ª–∏ —Å–æ–∑–¥–∞—ë–º –ø—É—Å—Ç–æ–π —Å–ª–æ–≤–∞—Ä—å
if DATA_FILE.exists():
    with open(DATA_FILE, "r", encoding="utf-8") as f:
        chat_users = json.load(f)
else:
    chat_users = {}


async def save_data():
    with open(DATA_FILE, "w", encoding="utf-8") as f:
        json.dump(chat_users, f, ensure_ascii=False, indent=2)


async def collect_users(update: Update, context: ContextTypes.DEFAULT_TYPE):
    chat_id = str(update.effective_chat.id)
    user = update.effective_user
    if user is None:
        return  # –≤ –∫–∞–Ω–∞–ª–µ –∏–ª–∏ –≥–¥–µ –Ω–µ—Ç —é–∑–µ—Ä–∞

    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —á–∞—Ç, –µ—Å–ª–∏ –µ—â—ë –Ω–µ—Ç
    if chat_id not in chat_users:
        chat_users[chat_id] = {}

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (id –∏ –∏–º—è)
    chat_users[chat_id][str(user.id)] = user.full_name

    await save_data()


async def all_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    chat_id = str(update.effective_chat.id)
    message_text = update.message.text.strip()

    # –ü—Ä–æ–≤–µ—Ä–∫–∞: @all –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–º —Å–ª–æ–≤–æ–º
    match = re.match(r"^@all(?:\s+(.*))?$", message_text)
    if not match:
        return  # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º, –µ—Å–ª–∏ @all —Å–ª–∏–ø–ª–æ—Å—å —Å —Ç–µ–∫—Å—Ç–æ–º (–Ω–∞–ø—Ä–∏–º–µ—Ä: @all–ë–∞–Ω–∞–Ω)

    # –ü—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å—Ç—å –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
    if chat_id not in chat_users or len(chat_users[chat_id]) == 0:
        await update.message.reply_text("‚ùó –ü–æ–∫–∞ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è —Ç–µ–≥–∞.")
        return

    # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —Ç–µ–∫—Å—Ç –ø–æ—Å–ª–µ @all (–µ—Å–ª–∏ –µ—Å—Ç—å)
    custom_text = match.group(1)

    # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ (user_id, name) –∏–∑ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö
    users = chat_users[chat_id]
    mentions = []

    for user_id in users:
        # –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç telegram.User-–∑–∞–≥–ª—É—à–∫—É
        fake_user = type("User", (), {"id": int(user_id), "first_name": users[user_id]})
        # –ü–æ–ª—É—á–∞–µ–º HTML-—Å—Å—ã–ª–∫—É
        mention_html = get_display_name_html_new(fake_user)
        mentions.append(mention_html)

    chunk_size = 50
    chunks = [mentions[i:i + chunk_size] for i in range(0, len(mentions), chunk_size)]

    for i, chunk in enumerate(chunks):
        mention_block = ", ".join(chunk)

        if i == 0:
            if custom_text:
                header = f"<b>üì¢ {html.escape(custom_text)}</b>\n\n"
            else:
                header = "<b>üì¢ –£–ø–æ–º–∏–Ω–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</b>\n\n"
        else:
            header = ""

        await update.message.reply_text(header + mention_block, parse_mode=ParseMode.HTML)


DEST_CHAT_ID = -1003319582175

QUESTIONS = {}
NEXT_QUESTION_ID = 0

ASK_JSON_PATH = "ask_reports.json"

# =========================
# –ó–∞–≥—Ä—É–∑–∫–∞ JSON
# =========================
def load_ask_data():
    global QUESTIONS, NEXT_QUESTION_ID
    if not os.path.exists(ASK_JSON_PATH):
        QUESTIONS = {}
        NEXT_QUESTION_ID = 1
        return
    with open(ASK_JSON_PATH, "r", encoding="utf-8") as f:
        QUESTIONS = json.load(f)
    if QUESTIONS:
        NEXT_QUESTION_ID = max(int(k) for k in QUESTIONS.keys()) + 1
    else:
        NEXT_QUESTION_ID = 1

# =========================
# –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ JSON
# =========================
def save_ask_data():
    with open(ASK_JSON_PATH, "w", encoding="utf-8") as f:
        json.dump(QUESTIONS, f, ensure_ascii=False, indent=2)

ASK_LIMIT = 5          # –∑–∞–ø—Ä–æ—Å–æ–≤
ASK_WINDOW = 60        # —Å–µ–∫—É–Ω–¥
ASK_BLOCK_TIME = 3600  # 1 —á–∞—Å

# =========================
# –ê–Ω—Ç–∏—Å–ø–∞–º + RMUTE –ø—Ä–æ–≤–µ—Ä–∫–∞
# =========================
def ask_spam_analyze(user_id: int):
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
    (True, None) -> –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å /ask
    (False, blocked_until) -> –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω
    """
    now = int(time.time())
    user_id = str(user_id)

    import sqlite3
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    cursor.execute("""
        CREATE TABLE IF NOT EXISTS ask_spam (
            user_id TEXT PRIMARY KEY,
            first_request_ts INTEGER DEFAULT 0,
            request_count INTEGER DEFAULT 0,
            blocked_until INTEGER DEFAULT 0,
            last_reason TEXT DEFAULT '',
            admin_id TEXT DEFAULT ''
        )
    """)

    cursor.execute(
        "SELECT first_request_ts, request_count, blocked_until FROM ask_spam WHERE user_id = ?",
        (user_id,)
    )
    row = cursor.fetchone()

    if not row:
        cursor.execute(
            "INSERT INTO ask_spam (user_id, first_request_ts, request_count, blocked_until) VALUES (?, ?, ?, ?)",
            (user_id, now, 1, 0)
        )
        conn.commit()
        conn.close()
        return True, None

    first_ts, count, blocked_until = row

    # –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–π –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ (rmute –∏–ª–∏ –∞–Ω—Ç–∏—Å–ø–∞–º)
    if blocked_until and blocked_until > now:
        conn.close()
        return False, blocked_until

    # –æ–∫–Ω–æ –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–æ—à–ª–æ ‚Äî —Å–±—Ä–æ—Å —Å—á—ë—Ç—á–∏–∫–∞
    if now - first_ts > ASK_WINDOW:
        first_ts = now
        count = 1
        cursor.execute(
            "UPDATE ask_spam SET first_request_ts = ?, request_count = ? WHERE user_id = ?",
            (first_ts, count, user_id)
        )
        conn.commit()
        conn.close()
        return True, None

    # –∏–Ω–∞—á–µ —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á—ë—Ç—á–∏–∫
    count += 1
    if count > ASK_LIMIT:
        blocked_until = now + ASK_BLOCK_TIME
        cursor.execute(
            "UPDATE ask_spam SET blocked_until = ?, first_request_ts = ?, request_count = ? WHERE user_id = ?",
            (blocked_until, first_ts, count, user_id)
        )
        conn.commit()
        conn.close()
        return False, blocked_until

    cursor.execute(
        "UPDATE ask_spam SET request_count = ? WHERE user_id = ?",
        (count, user_id)
    )
    conn.commit()
    conn.close()
    return True, None

ASK_BLOCKED_USERS = [1087968824]  # –¥–æ–±–∞–≤–ª—è–π —Å—é–¥–∞ –Ω—É–∂–Ω—ã–µ ID

async def ask_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    global NEXT_QUESTION_ID, QUESTIONS
    user = update.effective_user
    chat = update.effective_chat

    # –ó–∞–ø—Ä–µ—Ç –¥–ª—è –∫–∞–Ω–∞–ª–æ–≤
    if chat.type == "channel":
        return

    # –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
    if user.id in ASK_BLOCKED_USERS:
        await update.message.reply_text(
            "üö´ –í–∞–º –∑–∞–ø—Ä–µ—â–µ–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–æ–º–∞–Ω–¥—É /ask",
            parse_mode=ParseMode.HTML
        )
        return

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–Ω—Ç–∏—Å–ø–∞–º / rmute
    allowed, blocked_until = ask_spam_analyze(user.id)
    if not allowed:
        return

    question = ' '.join(context.args).strip()
    if not question:
        await update.message.reply_text(
            "‚ùó –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –≤–æ–ø—Ä–æ—Å –ø–æ—Å–ª–µ –∫–æ–º–∞–Ω–¥—ã\n<code>/ask –≤–∞—à –≤–æ–ø—Ä–æ—Å</code>",
            parse_mode=ParseMode.HTML
        )
        return

    load_ask_data()
    tz_msk = pytz.timezone("Europe/Moscow")
    now = datetime.now(tz_msk)
    question_safe = html.escape(question)
    try:
        chat_url = chat.get_url() or "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"
    except Exception:
        chat_url = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"
    chat_url_safe = html.escape(str(chat_url))
    qid = NEXT_QUESTION_ID
    NEXT_QUESTION_ID += 1

    formatted_message = (
        f"üì® <b>ASK –∑–∞–ø—Ä–æ—Å ‚Ññ{qid}</b>\n"
        f"üë§ <b>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</b> {get_display_name_html_new(user)}\n"
        f"üÜî <b>Telegram ID:</b> <code>{user.id}</code>\n\n"
        f"üí¨ <b>–í–æ–ø—Ä–æ—Å:</b>\n"
        f"<i>{question_safe}</i>\n\n"
        f"üìÖ <b>–î–∞—Ç–∞:</b> {now.strftime('%d.%m.%Y')}\n"
        f"‚è∞ <b>–í—Ä–µ–º—è:</b> {now.strftime('%H:%M')} (–ú–°–ö)\n"
        f"üåê <b>–ß–∞—Ç:</b>\n{chat_url_safe}\n\n"
        f"‚ö°Ô∏è <b>–û—Ç–≤–µ—Ç:</b>\n/answer {qid} –≤–∞—à_–æ—Ç–≤–µ—Ç"
    )

    sent = await context.bot.send_message(
        chat_id=DEST_CHAT_ID,
        text=formatted_message,
        parse_mode=ParseMode.HTML,
        disable_web_page_preview=True
    )

    QUESTIONS[str(qid)] = {
        "user_id": user.id,
        "chat_id": chat.id,
        "question": question,
        "created_at": now.isoformat(),
        "closed": False,
        "admin_msg_id": sent.message_id
    }
    save_ask_data()

    await update.message.reply_text(
        f"‚úÖ –í–∞—à –≤–æ–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω.\nüìå –ù–æ–º–µ—Ä –æ–±—Ä–∞—â–µ–Ω–∏—è: <b>{qid}</b>",
        parse_mode=ParseMode.HTML
    )
# =====================================
# –ö–æ–º–∞–Ω–¥–∞ /rmute
# =====================================
async def rmute_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    admin = update.effective_user
    args = context.args

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞: –º–ª. –º–æ–¥–µ—Ä–∞—Ç–æ—Ä –∏ –≤—ã—à–µ (status >= 3)
    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()
        cursor.execute("SELECT status FROM users WHERE user_id = ?", (str(admin.id),))
        row = cursor.fetchone()
    admin_status = row[0] if row else 0
    if admin_status < 3:
        await update.message.reply_text("‚ùå –î–æ—Å—Ç—É–ø –∫ –∫–æ–º–∞–Ω–¥–µ /rmute —Ç–æ–ª—å–∫–æ –¥–ª—è –ú–ª. –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–≤ –∏ –≤—ã—à–µ.")
        return

    if len(args) < 3:
        await update.message.reply_text("‚ùó –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /rmute {telegramID/@username} {–≤—Ä–µ–º—è –≤ –º–∏–Ω—É—Ç–∞—Ö} {–ø—Ä–∏—á–∏–Ω–∞}")
        return

    target_input = args[0]
    time_minutes = args[1]
    reason = ' '.join(args[2:]).strip()

    try:
        time_minutes = int(time_minutes)
        if time_minutes <= 0:
            raise ValueError()
    except ValueError:
        await update.message.reply_text("‚ùå –í—Ä–µ–º—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º –º–∏–Ω—É—Ç.")
        return

    # –ü–æ–ª—É—á–∞–µ–º user_id —á–µ—Ä–µ–∑ @username –∏–ª–∏ ID
    if target_input.startswith("@"):
        username = target_input[1:]
        with sqlite3.connect(DB_PATH) as conn:
            cursor = conn.cursor()
            cursor.execute("SELECT user_id FROM users WHERE username = ?", (username,))
            row = cursor.fetchone()
            if not row:
                await update.message.reply_text(f"‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å username @{username} –Ω–µ –Ω–∞–π–¥–µ–Ω.")
                return
            user_id = row[0]
    else:
        user_id = target_input

    blocked_until_ts = int((datetime.utcnow() + timedelta(minutes=time_minutes)).timestamp())

    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()
        cursor.execute("""
            CREATE TABLE IF NOT EXISTS ask_spam (
                user_id TEXT PRIMARY KEY,
                first_request_ts INTEGER DEFAULT 0,
                request_count INTEGER DEFAULT 0,
                blocked_until INTEGER DEFAULT 0,
                last_reason TEXT DEFAULT '',
                admin_id TEXT DEFAULT ''
            )
        """)
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –º—É—Ç–∞
        cursor.execute("SELECT blocked_until FROM ask_spam WHERE user_id = ?", (str(user_id),))
        row = cursor.fetchone()
        now_ts = int(datetime.utcnow().timestamp())
        if row and row[0] and row[0] > now_ts:
            await update.message.reply_text("‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –º—É—Ç–µ.")
            return

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –º—É—Ç
        cursor.execute("""
            INSERT OR REPLACE INTO ask_spam
            (user_id, first_request_ts, request_count, blocked_until, last_reason, admin_id)
            VALUES (?, COALESCE((SELECT first_request_ts FROM ask_spam WHERE user_id = ?), 0),
                    COALESCE((SELECT request_count FROM ask_spam WHERE user_id = ?), 0),
                    ?, ?, ?)
        """, (str(user_id), str(user_id), str(user_id), blocked_until_ts, reason, str(admin.id)))
        conn.commit()

    # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    try:
        admin_display = get_display_name_html_new(admin)
        await context.bot.send_message(
            chat_id=int(user_id),
            text=(f"‚ùó –í–∞–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω –¥–æ—Å—Ç—É–ø –∫ /ask –≤–æ–ø—Ä–æ—Å–∞–º.\n"
                  f"‚è≥ –í—Ä–µ–º—è: {time_minutes} –º–∏–Ω—É—Ç\n"
                  f"üìù –ü—Ä–∏—á–∏–Ω–∞: {html.escape(reason)}\n"
                  f"üëÆ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä: {admin_display} | ID: {admin.id}"),
            parse_mode="HTML"
        )
    except Exception:
        await update.message.reply_text("‚ö† –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é (–∑–∞–∫—Ä—ã—Ç —á–∞—Ç).")

    await update.message.reply_text(f"‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} —É—Å–ø–µ—à–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω –≤ /ask –Ω–∞ {time_minutes} –º–∏–Ω—É—Ç.\n–ü—Ä–∏—á–∏–Ω–∞: {html.escape(reason)}")

# =====================================
# –ö–æ–º–∞–Ω–¥–∞ /runmute
# =====================================
async def runmute_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    admin = update.effective_user
    args = context.args

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞: –º–æ–¥–µ—Ä–∞—Ç–æ—Ä –∏ –≤—ã—à–µ (status >= 4)
    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()
        cursor.execute("SELECT status FROM users WHERE user_id = ?", (str(admin.id),))
        row = cursor.fetchone()
    admin_status = row[0] if row else 0
    if admin_status < 4:
        await update.message.reply_text("‚ùå –î–æ—Å—Ç—É–ø –∫ –∫–æ–º–∞–Ω–¥–µ /runmute —Ç–æ–ª—å–∫–æ –¥–ª—è –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–≤ –∏ –≤—ã—à–µ.")
        return

    if len(args) < 1:
        await update.message.reply_text("‚ùó –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /runmute {telegramID/@username}")
        return

    if args[0].startswith("@"):
        username = args[0][1:]
        with sqlite3.connect(DB_PATH) as conn:
            cursor = conn.cursor()
            cursor.execute("SELECT user_id FROM users WHERE username = ?", (username,))
            row = cursor.fetchone()
            if not row:
                await update.message.reply_text(f"‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å username @{username} –Ω–µ –Ω–∞–π–¥–µ–Ω.")
                return
            user_id = row[0]
    else:
        user_id = args[0]

    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()
        cursor.execute("""
            CREATE TABLE IF NOT EXISTS ask_spam (
                user_id TEXT PRIMARY KEY,
                first_request_ts INTEGER DEFAULT 0,
                request_count INTEGER DEFAULT 0,
                blocked_until INTEGER DEFAULT 0,
                last_reason TEXT DEFAULT '',
                admin_id TEXT DEFAULT ''
            )
        """)
        cursor.execute("SELECT blocked_until FROM ask_spam WHERE user_id = ?", (str(user_id),))
        row = cursor.fetchone()
        now_ts = int(datetime.utcnow().timestamp())
        if not row or not row[0] or row[0] <= now_ts:
            await update.message.reply_text("‚ùå –£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –º—É—Ç–∞.")
            return

        # –°–Ω–∏–º–∞–µ–º –º—É—Ç
        cursor.execute("UPDATE ask_spam SET blocked_until = 0 WHERE user_id = ?", (str(user_id),))
        conn.commit()

    try:
        await context.bot.send_message(
            chat_id=int(user_id),
            text="‚úÖ –î–æ—Å—Ç—É–ø –∫ /ask –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ —Å–Ω–æ–≤–∞ –ø–∏—Å–∞—Ç—å –≤–æ–ø—Ä–æ—Å—ã."
        )
    except Exception:
        await update.message.reply_text("‚ö† –ù–µ —É–¥–∞–ª–æ—Å—å —É–≤–µ–¥–æ–º–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∑–∞–∫—Ä—ã—Ç —á–∞—Ç).")

    await update.message.reply_text(f"‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} —Ç–µ–ø–µ—Ä—å –º–æ–∂–µ—Ç –ø–∏—Å–∞—Ç—å /ask.")


conn = sqlite3.connect(DB_PATH, check_same_thread=False)
cursor = conn.cursor()

PREDEFINED_ANSWERS = {
    "not_relevant": "üö´ –ù–µ –ø–æ —Ç–µ–º–µ // –ø—Ä–∏—è—Ç–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è!",
    "no_info": "‚ÑπÔ∏è –ù–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ // –ø—Ä–∏—è—Ç–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è!",
    "already_answered": "‚úÖ –£–∂–µ –æ—Ç–≤–µ—á–µ–Ω–æ —Ä–∞–Ω–µ–µ // –ø—Ä–∏—è—Ç–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è!",
    "try_later": "üïí –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ // –ø—Ä–∏—è—Ç–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è!",
    "duplicate_question": "üîÑ –í–æ–ø—Ä–æ—Å –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è. –ü—Ä–µ–∫—Ä–∞—Ç–∏—Ç–µ OffTop-–∏—Ç—å // –ø—Ä–∏—è—Ç–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è!",
    "no_solution": "‚ùå –†–µ—à–µ–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç // –ø—Ä–∏—è—Ç–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è!",
    "for_admins": "üì§ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤—ã—à–µ—Å—Ç–æ—è—â–µ–º—É —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤—É // –ø—Ä–∏—è—Ç–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è!",
}

# =====================================
# –ö–æ–º–∞–Ω–¥–∞ /rminfo ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ /ask
# =====================================
async def rminfo_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    args = context.args

    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º target user
    if args:
        target_input = args[0]
    elif update.message.reply_to_message:
        target_input = str(update.message.reply_to_message.from_user.id)
    else:
        await update.message.reply_text(
            "‚ùó –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:\n/rminfo {TelegramID/@username} –∏–ª–∏ –æ—Ç–≤–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ",
            parse_mode="HTML"
        )
        return

    # –ü–æ–ª—É—á–∞–µ–º user_id —á–µ—Ä–µ–∑ @username –∏–ª–∏ ID
    user_id = None
    if target_input.startswith("@"):
        username = target_input[1:]
        with sqlite3.connect(DB_PATH) as conn:
            cursor = conn.cursor()
            cursor.execute("SELECT user_id FROM users WHERE username = ?", (username,))
            row = cursor.fetchone()
            if not row:
                await update.message.reply_text(f"‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å username @{username} –Ω–µ –Ω–∞–π–¥–µ–Ω.")
                return
            user_id = row[0]
    else:
        user_id = target_input

    now_ts = int(time.time())

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –≤ ask_spam
    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()
        cursor.execute("""
            SELECT blocked_until, last_reason, admin_id 
            FROM ask_spam 
            WHERE user_id = ? AND blocked_until > ?
        """, (str(user_id), now_ts))
        row = cursor.fetchone()

    if not row:
        await update.message.reply_text("‚úÖ –£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –Ω–∞ /ask.")
        return

    blocked_until, reason, admin_id = row

    # –ü–æ–ª—É—á–∞–µ–º —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
    try:
        admin_member = await context.bot.get_chat(int(admin_id))
        admin_mention = get_display_name_html_new(admin_member)
    except Exception:
        admin_mention = f'<a href="tg://user?id={admin_id}">{admin_id}</a>'

    # –ü–æ–ª—É—á–∞–µ–º —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    try:
        target_member = await context.bot.get_chat(int(user_id))
        user_mention = get_display_name_html_new(target_member)
    except Exception:
        user_mention = f'<a href="tg://user?id={user_id}">{user_id}</a>'

    # –í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è
    try:
        dt_utc = datetime.fromtimestamp(blocked_until, timezone.utc)
        moscow_tz = timezone(timedelta(hours=3))
        dt_msk = dt_utc.astimezone(moscow_tz)
        mute_end_str = dt_msk.strftime("%Y-%m-%d %H:%M:%S")
        seconds_left = max(blocked_until - now_ts, 0)
        minutes_left = seconds_left // 60
        seconds_remainder = seconds_left % 60
        time_left_str = f"{minutes_left} –º–∏–Ω {seconds_remainder} —Å–µ–∫"
    except Exception:
        mute_end_str = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"
        time_left_str = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"

    text = (
        f"üö´ <b>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ /ask</b>\n\n"
        f"üë§ <b>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</b> {user_mention}\n"
        f"üõ° <b>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä:</b> {admin_mention}\n"
        f"üìù <b>–ü—Ä–∏—á–∏–Ω–∞:</b> {html.escape(reason)}\n\n"
        f"‚ùó <b>–°—Ç–∞—Ç—É—Å:</b> –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ\n"
        f"üïí <b>–û—Å—Ç–∞–ª–æ—Å—å –¥–æ —Å–Ω—è—Ç–∏—è:</b> {time_left_str}\n"
        f"üìÖ <b>–í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è (–ú–°–ö):</b> {mute_end_str}"
    )

    await update.message.reply_text(text, parse_mode="HTML")

MIN_MOD_STATUS = 3  # –ú–ª. –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä –∏ –≤—ã—à–µ


async def answer_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    global QUESTIONS

    # ‚úÖ –ó–ê–ì–†–£–ñ–ê–ï–ú –ê–ö–¢–£–ê–õ–¨–ù–´–ï –î–ê–ù–ù–´–ï –ò–ó JSON
    load_ask_data()

    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏—è
    if update.callback_query:
        query = update.callback_query
        await query.answer()
        admin = query.from_user
        message = query.message
        is_callback = True
    else:
        admin = update.effective_user
        message = update.message
        is_callback = False

    # === –ü–†–û–í–ï–†–ö–ê –ü–†–ê–í ===
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT status FROM users WHERE user_id = ?", (str(admin.id),))
    row = cursor.fetchone()
    conn.close()

    user_status = int(row[0]) if row else 0
    if user_status < MIN_MOD_STATUS:
        await message.reply_text(
            "‚ùå –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–æ–º–∞–Ω–¥—É /answer –º–æ–≥—É—Ç —Ç–æ–ª—å–∫–æ –ú–ª. –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä—ã –∏ –≤—ã—à–µ."
        )
        return

    # === –†–∞–∑–±–∏—Ä–∞–µ–º –∫–æ–º–∞–Ω–¥—É –∏–ª–∏ callback ===
    text = message.text if not is_callback else query.data
    parts = text.split(maxsplit=2)

    # Callback: –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø—Ä–µ–¥–æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
    if is_callback and text.startswith("confirm_answer:"):
        _, qid, answer_type = text.split(":")
        answer_text = PREDEFINED_ANSWERS.get(answer_type, "")
        await process_answer(update, context, int(qid), answer_text, admin.id, query)
        return

    # Callback: –æ—Ç–º–µ–Ω–∞
    if is_callback and text.startswith("cancel_answer:"):
        await query.edit_message_text("‚ùå –û—Ç–º–µ–Ω–µ–Ω–æ. –í—ã –º–æ–∂–µ—Ç–µ –≤–≤–µ—Å—Ç–∏ –æ—Ç–≤–µ—Ç –≤—Ä—É—á–Ω—É—é.")
        return

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –Ω–æ–º–µ—Ä–∞ –≤–æ–ø—Ä–æ—Å–∞
    if len(parts) < 2:
        await message.reply_text("‚ùó –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /answer {–Ω–æ–º–µ—Ä_–≤–æ–ø—Ä–æ—Å–∞} {–æ—Ç–≤–µ—Ç}")
        return

    try:
        qid = int(parts[1])
    except ValueError:
        await message.reply_text("‚ùó –ù–µ–≤–µ—Ä–Ω—ã–π –Ω–æ–º–µ—Ä –≤–æ–ø—Ä–æ—Å–∞.")
        return

    qid_str = str(qid)  # –ü—Ä–∏–≤–æ–¥–∏–º –∫ —Å—Ç—Ä–æ–∫–µ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å JSON

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –≤–æ–ø—Ä–æ—Å–∞
    if qid_str not in QUESTIONS or QUESTIONS[qid_str]["closed"]:
        await message.reply_text("‚ùó –í–æ–ø—Ä–æ—Å —Å —Ç–∞–∫–∏–º –Ω–æ–º–µ—Ä–æ–º –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ —É–∂–µ –∑–∞–∫—Ä—ã—Ç.")
        return

    # –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞ –Ω–µ —É–∫–∞–∑–∞–Ω ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é –ø—Ä–µ–¥–æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤
    if len(parts) == 2:
        keyboard = [
            [InlineKeyboardButton("üö´ –ù–µ –ø–æ —Ç–µ–º–µ", callback_data=f"pre_answer:{qid}:not_relevant"),
             InlineKeyboardButton("‚ÑπÔ∏è –ù–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏", callback_data=f"pre_answer:{qid}:no_info")],
            [InlineKeyboardButton("‚úÖ –û—Ç–≤–µ—á–µ–Ω–æ —Ä–∞–Ω–µ–µ", callback_data=f"pre_answer:{qid}:already_answered"),
             InlineKeyboardButton("üïí –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ", callback_data=f"pre_answer:{qid}:try_later")],
            [InlineKeyboardButton("üîÑ –í–æ–ø—Ä–æ—Å –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è", callback_data=f"pre_answer:{qid}:duplicate_question"),
             InlineKeyboardButton("‚ùå –†–µ—à–µ–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç", callback_data=f"pre_answer:{qid}:no_solution")],
            [InlineKeyboardButton("üì§ –ü–µ—Ä–µ–¥–∞—Ç—å —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤—É", callback_data=f"pre_answer:{qid}:for_admins")],
            [InlineKeyboardButton("–û—Ç–º–µ–Ω–∞", callback_data=f"pre_answer:{qid}:cancel")]
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)

        await message.reply_text(
            f"üì© <b>–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç –æ—Ç–≤–µ—Ç–∞ –¥–ª—è –≤–æ–ø—Ä–æ—Å–∞ ‚Ññ{qid}:</b>\n\n"
            f"‚ùì <i>–í–æ–ø—Ä–æ—Å:</i>\n<b>{html.escape(QUESTIONS[qid_str]['question'])}</b> üîé",
            reply_markup=reply_markup,
            parse_mode=ParseMode.HTML
        )
        return

    # –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞ —É–∫–∞–∑–∞–Ω ‚Äî –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –Ω–∞–ø—Ä—è–º—É—é
    answer_text = parts[2].strip()
    await process_answer(update, context, qid, answer_text, admin.id, message if not is_callback else query)


async def pre_answer_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    global QUESTIONS

    # ‚úÖ –ó–ê–ì–†–£–ñ–ê–ï–ú –ê–ö–¢–£–ê–õ–¨–ù–´–ï –î–ê–ù–ù–´–ï –ò–ó JSON
    load_ask_data()

    query = update.callback_query
    await query.answer()

    data = query.data.split(':')
    qid = int(data[1])
    qid_str = str(qid)  # ‚úÖ –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ —Å—Ç—Ä–æ–∫—É –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å JSON
    action = data[2]

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–∫—Ä—ã—Ç –ª–∏ —É–∂–µ –≤–æ–ø—Ä–æ—Å
    if qid_str not in QUESTIONS:  # ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç—Ä–æ–∫—É
        await query.edit_message_text("‚ö†Ô∏è –í–æ–ø—Ä–æ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω.")
        return

    if QUESTIONS[qid_str].get('closed', False):  # ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç—Ä–æ–∫—É
        await query.edit_message_text("‚ö†Ô∏è –≠—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å —É–∂–µ –∑–∞–∫—Ä—ã—Ç –∏ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –æ—Ç–≤–µ—Ç–∞.")
        return

    if action == "cancel":
        await query.edit_message_text("‚ùå –û—Ç–º–µ–Ω–µ–Ω–æ. –í—ã –º–æ–∂–µ—Ç–µ –≤–≤–µ—Å—Ç–∏ –æ—Ç–≤–µ—Ç –≤—Ä—É—á–Ω—É—é.")
        return

    # –ï—Å–ª–∏ —ç—Ç–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç (–Ω–µ –ø–µ—Ä–µ–¥–∞—á–∞ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤—É)
    answer_text = PREDEFINED_ANSWERS.get(action, "")
    if answer_text and action != "for_admins":
        keyboard = [
            [InlineKeyboardButton("‚úÖ –î–∞", callback_data=f"confirm_answer:{qid}:{action}")],
            [InlineKeyboardButton("‚ùå –ù–µ—Ç", callback_data=f"cancel_answer:{qid}")]
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)

        await query.edit_message_text(
            text=(
                "‚ùóÔ∏è <b>–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –æ—Ç–ø—Ä–∞–≤–∫—É –æ—Ç–≤–µ—Ç–∞:</b> ‚ùóÔ∏è\n\n"
                f"‚ùì <b>–í–æ–ø—Ä–æ—Å:</b>\n<pre>{html.escape(QUESTIONS[qid_str]['question'])}</pre>\n\n"  # ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç—Ä–æ–∫—É
                f"üí¨ <b>–û—Ç–≤–µ—Ç:</b>\n<pre>{html.escape(answer_text)}</pre>\n\n"
                "‚úÖ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç? ‚ùå"
            ),
            reply_markup=reply_markup,
            parse_mode=ParseMode.HTML
        )
        return

    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–µ—Ä–µ–¥–∞—á–∏ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤—É (for_admins)
    question_data = QUESTIONS[qid_str]  # ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç—Ä–æ–∫—É
    user_id = question_data['user_id']
    user_name = question_data.get('user_name', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')
    admin_id = query.from_user.id
    admin_name = query.from_user.full_name
    current_time = datetime.now().strftime("%Y-%m-%d %H:%M:%S")

    # –ü–æ–º–µ—á–∞–µ–º –≤–æ–ø—Ä–æ—Å –∫–∞–∫ –∑–∞–∫—Ä—ã—Ç—ã–π
    QUESTIONS[qid_str]['closed'] = True  # ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç—Ä–æ–∫—É

    # 1. –£–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ª–∏—á–∫—É
    try:
        await context.bot.send_message(
            chat_id=user_id,
            text=PREDEFINED_ANSWERS["for_admins"]
        )
    except Exception as e:
        print(f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —É–≤–µ–¥–æ–º–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}: {e}")

    # 2. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∏—Å—Ö–æ–¥–Ω—ã–π —á–∞—Ç (–µ—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –Ω–µ –∏–∑ –ª–∏—á–∫–∏)
    if question_data["chat_id"] != user_id:
        try:
            user_mention = f'<a href="tg://user?id={user_id}">{html.escape(user_name)}</a>'
            admin_mention = f'<a href="tg://user?id={admin_id}">{html.escape(admin_name)}</a>'

            await context.bot.send_message(
                chat_id=question_data["chat_id"],
                text=(
                    f"üí¨ <b>–û—Ç–≤–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å –æ—Ç {user_mention}:</b>\n"
                    f"üë§ <b>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä:</b> {admin_mention}\n\n"
                    "üìù <b>–û—Ç–≤–µ—Ç:</b>\n"
                    "‚û§ üì§ –í–æ–ø—Ä–æ—Å –ø–µ—Ä–µ–¥–∞–Ω —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤—É!\n\n"
                    "üîí <i>–í–æ–ø—Ä–æ—Å –∑–∞–∫—Ä—ã—Ç.</i>"
                ),
                parse_mode=ParseMode.HTML,
                reply_to_message_id=question_data.get("message_id")
            )
        except Exception as e:
            print(f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç {question_data['chat_id']}: {e}")

    # 3. –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ–º –∞–¥–º–∏–Ω—É
    await query.edit_message_text("üì§ –í–æ–ø—Ä–æ—Å –ø–µ—Ä–µ–¥–∞–Ω —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤—É!")

    # 4. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤—É
    admin_chat_id = 7406372338
    try:
        if 'message_id' in question_data:
            try:
                await context.bot.forward_message(
                    chat_id=admin_chat_id,
                    from_chat_id=user_id,
                    message_id=question_data['message_id']
                )
            except Exception as e:
                print(f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ—Å–ª–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –≤—Ä—É—á–Ω—É—é. –û—à–∏–±–∫–∞: {e}")
                await context.bot.send_message(
                    chat_id=admin_chat_id,
                    text=f"‚úâÔ∏è *–û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ –¥–ª—è –ø–µ—Ä–µ—Å—ã–ª–∫–∏.*\n–í–æ—Ç —Ç–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞:\n\n`{question_data['question']}`",
                    parse_mode=ParseMode.MARKDOWN
                )

        await context.bot.send_message(
            chat_id=admin_chat_id,
            text=(
                "‚ùóÔ∏è *–ù–æ–≤–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ –ø–µ—Ä–µ–¥–∞–Ω–æ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤—É*\n\n"
                f"üë§ *–û—Ç:* [{html.escape(user_name)}](tg://user?id={user_id})\n"
                f"üÜî *ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:* `{user_id}`\n\n"
                f"‚ùì *–í–æ–ø—Ä–æ—Å:*\n`{html.escape(question_data['question'])}`\n\n"
                f"üîπ *–ü–µ—Ä–µ–¥–∞–ª –∞–¥–º–∏–Ω:* [{html.escape(admin_name)}](tg://user?id={admin_id})\n"
                f"üÜî *ID –∞–¥–º–∏–Ω–∞:* `{admin_id}`\n"
                f"üìÖ *–í—Ä–µ–º—è –ø–µ—Ä–µ–¥–∞—á–∏:* `{current_time}`"
            ),
            parse_mode=ParseMode.MARKDOWN
        )

    except Exception as e:
        print(f"‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤—É: {e}")
        await query.edit_message_text("‚ö†Ô∏è –í–æ–ø—Ä–æ—Å –ø–µ—Ä–µ–¥–∞–Ω, –Ω–æ –≤–æ–∑–Ω–∏–∫–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã —Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ–º —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞.")

    # ‚úÖ –°–û–•–†–ê–ù–Ø–ï–ú –ò–ó–ú–ï–ù–ï–ù–ò–Ø
    save_ask_data()


async def process_answer(update, context, qid, answer_text, admin_id, source):
    global cursor, conn, QUESTIONS

    # ‚úÖ –ó–ê–ì–†–£–ñ–ê–ï–ú –ê–ö–¢–£–ê–õ–¨–ù–´–ï –î–ê–ù–ù–´–ï –ò–ó JSON
    load_ask_data()

    qid_str = str(qid)  # ‚úÖ –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ —Å—Ç—Ä–æ–∫—É

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–∞
    if qid_str not in QUESTIONS:  # ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç—Ä–æ–∫—É
        if hasattr(source, 'answer'):
            await source.answer("‚ùó –í–æ–ø—Ä–æ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω.", show_alert=True)
        elif hasattr(source, 'reply_text'):
            await source.reply_text("‚ùó –í–æ–ø—Ä–æ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω.")
        return

    question_data = QUESTIONS[qid_str]  # ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç—Ä–æ–∫—É

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ—Ç–≤–µ—á–∞–µ—Ç —Ç–æ—Ç –∂–µ –∞–¥–º–∏–Ω, —á—Ç–æ –∏ –∑–∞–ø—Ä–∞—à–∏–≤–∞–ª
    if hasattr(source, 'from_user') and source.from_user.id != admin_id:
        await source.answer("‚ùó –¢–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä –∑–∞–ø—Ä–æ—Å–∞ –º–æ–∂–µ—Ç –æ—Ç–≤–µ—á–∞—Ç—å.", show_alert=True)
        return

    # –ü–æ–º–µ—á–∞–µ–º –≤–æ–ø—Ä–æ—Å –∫–∞–∫ –∑–∞–∫—Ä—ã—Ç—ã–π
    QUESTIONS[qid_str]["closed"] = True  # ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç—Ä–æ–∫—É

    # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç
    admin = source.from_user if hasattr(source, 'from_user') else source.effective_user
    answer_text_safe = html.escape(answer_text)
    quoted_answer = '\n'.join(f"‚û§ {line}" for line in answer_text_safe.splitlines())

    # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é get_display_name_html_new –¥–ª—è —É–ø–æ–º–∏–Ω–∞–Ω–∏–π
    user_mention = get_display_name_html_new(
        telegram.User(id=question_data['user_id'], first_name=question_data.get('user_name', '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'),
                      is_bot=False))
    admin_mention = get_display_name_html_new(admin)

    # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    answer_message = (
        f"{user_mention},\n"
        f"üí¨ <b>–ù–∞ –≤–∞—à –≤–æ–ø—Ä–æ—Å –ø–æ—Å—Ç—É–ø–∏–ª –æ—Ç–≤–µ—Ç:</b>\n"
        f"üë§ <b>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä:</b> {admin_mention}\n\n"
        f"üìù <b>–û—Ç–≤–µ—Ç:</b>\n{quoted_answer}\n\n"
        f"üîí <i>–í–æ–ø—Ä–æ—Å –∑–∞–∫—Ä—ã—Ç.</i>"
    )

    # –§–ª–∞–≥ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —É–¥–∞—á–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ –õ–°
    pm_sent = False

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –≤ –ª–∏—á–∫—É
    try:
        await context.bot.send_message(
            chat_id=question_data["user_id"],
            text=answer_message,
            parse_mode=ParseMode.HTML,
            disable_web_page_preview=True
        )
        pm_sent = True  # ‚úÖ –û—Ç–º–µ—Ç–∏–º, —á—Ç–æ –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ –õ–° —É—Å–ø–µ—à–Ω–∞
    except Exception as e:
        error_msg = f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –≤ –ª–∏—á–∫—É: {e}\nüí¨ –ü–æ–ø—ã—Ç–∞–µ–º—Å—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ –∏—Å—Ö–æ–¥–Ω—ã–π —á–∞—Ç..."
        print(f"‚ùå {error_msg}")
        if hasattr(source, 'edit_message_text'):
            await source.edit_message_text(error_msg)
        # ‚úÖ –ù–ï –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –ø–æ–ø—ã—Ç–∫—É –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ —á–∞—Ç

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –≤ –∏—Å—Ö–æ–¥–Ω—ã–π —á–∞—Ç (–µ—Å–ª–∏ —ç—Ç–æ –Ω–µ –ª–∏—á–Ω—ã–π —á–∞—Ç –∏–ª–∏ –µ—Å–ª–∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ –õ–° –Ω–µ —É–¥–∞–ª–∞—Å—å)
    if question_data["chat_id"] != question_data["user_id"]:
        try:
            chat_message = (
                f"üí¨ <b>–û—Ç–≤–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å –æ—Ç {user_mention}:</b>\n"
                f"üë§ <b>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä:</b> {admin_mention}\n\n"
                f"üìù <b>–û—Ç–≤–µ—Ç:</b>\n{quoted_answer}\n\n"
                f"üîí <i>–í–æ–ø—Ä–æ—Å –∑–∞–∫—Ä—ã—Ç.</i>"
            )
            await context.bot.send_message(
                chat_id=question_data["chat_id"],
                text=chat_message,
                parse_mode=ParseMode.HTML,
                disable_web_page_preview=True,
                reply_to_message_id=question_data.get("message_id")
            )
            print(f"‚úÖ –û—Ç–≤–µ—Ç —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ —á–∞—Ç")
        except Exception as e:
            print(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç –≤ —á–∞—Ç: {e}")

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ —Å–æ–∑–¥–∞—ë–º —Ç–∞–±–ª–∏—Ü—É admins –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
    try:
        cursor.execute("""
        CREATE TABLE IF NOT EXISTS admins (
            user_id TEXT PRIMARY KEY,
            points INTEGER DEFAULT 0
        )
        """)
        conn.commit()
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ç–∞–±–ª–∏—Ü—ã admins: {e}")

    # –û–±–Ω–æ–≤–ª—è–µ–º –æ—á–∫–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
    try:
        cursor.execute("UPDATE admins SET points = points + 5 WHERE user_id = ?", (str(admin.id),))
        if cursor.rowcount == 0:
            cursor.execute("INSERT INTO admins (user_id, points) VALUES (?, ?)", (str(admin.id), 5))
        conn.commit()
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –±–∞–ª–ª–æ–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞: {e}")

    # –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∞–¥–º–∏–Ω-—á–∞—Ç–µ
    if "admin_msg_id" in question_data:
        try:
            await context.bot.edit_message_text(
                chat_id=DEST_CHAT_ID,
                message_id=question_data["admin_msg_id"],
                text=question_data["admin_msg_text"] + "\n\n‚úÖ –û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω",
                parse_mode=ParseMode.HTML
            )
        except Exception as e:
            print(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∞–¥–º–∏–Ω-—á–∞—Ç–µ: {e}")

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∞–¥–º–∏–Ω—É
    if pm_sent:
        success_msg = (
            f"<b>‚úÖ –í—ã —É—Å–ø–µ—à–Ω–æ –æ—Ç–≤–µ—Ç–∏–ª–∏ –Ω–∞ –≤–æ–ø—Ä–æ—Å ‚Ññ{qid}</b> üéâ\n"
            "üì§ –û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω:\n"
            f"- –í –ª–∏—á–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ‚úÖ\n"
            f"- –í –∏—Å—Ö–æ–¥–Ω—ã–π —á–∞—Ç ‚úÖ\n\n"
            "<pre>üîí –í–æ–ø—Ä–æ—Å –∑–∞–∫—Ä—ã—Ç –∏ –±–æ–ª—å—à–µ –Ω–µ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –æ—Ç–≤–µ—Ç–æ–≤.</pre>"
        )
    else:
        success_msg = (
            f"<b>‚ö†Ô∏è –û—Ç–≤–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å ‚Ññ{qid} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω —Å –æ—à–∏–±–∫–∞–º–∏</b>\n"
            "üì§ –°—Ç–∞—Ç—É—Å –æ—Ç–ø—Ä–∞–≤–∫–∏:\n"
            f"- –í –ª–∏—á–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ‚ùå (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –±–æ—Ç–∞ –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)\n"
            f"- –í –∏—Å—Ö–æ–¥–Ω—ã–π —á–∞—Ç ‚úÖ (–æ—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω —Ç—É–¥–∞)\n\n"
            "<pre>üîí –í–æ–ø—Ä–æ—Å –∑–∞–∫—Ä—ã—Ç –∏ –±–æ–ª—å—à–µ –Ω–µ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –æ—Ç–≤–µ—Ç–æ–≤.</pre>"
        )

    if hasattr(source, 'edit_message_text'):
        await source.edit_message_text(success_msg, parse_mode=ParseMode.HTML)
    else:
        await source.reply_text(success_msg, parse_mode=ParseMode.HTML)

    # ‚úÖ –°–û–•–†–ê–ù–Ø–ï–ú –ò–ó–ú–ï–ù–ï–ù–ò–Ø –í JSON
    save_ask_data()


MODERATOR_COST = 25000
MODERATOR_STATUS = 6


async def buyadm_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = str(update.effective_user.id)
    await update.message.reply_text(
        f"<b>üíº –ü–æ–∫—É–ø–∫–∞ –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –±–æ–ª—å—à–µ –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–∞</b>\n",
        parse_mode=ParseMode.HTML
    )


# –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–æ–∫
async def handle_buyadm_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    data = query.data

    try:
        full_action, target_user_id = data.split('|')  # –ü—Ä–∏–º–µ—Ä: buy_moderator|123456
        action, role = full_action.split('_')  # action = buy, role = moderator
    except Exception:
        await query.answer("‚ö†Ô∏è –ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∫–Ω–æ–ø–∫–∏.", show_alert=True)
        return

    user_id = str(query.from_user.id)
    if user_id != target_user_id:
        await query.answer("‚õî –≠—Ç–æ –Ω–µ –≤–∞—à–∞ –ø–∞–Ω–µ–ª—å!", show_alert=True)
        return

    if action == "cancel" and role == "moderator":
        await query.edit_message_text("‚ùå –ü–æ–∫—É–ø–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞.")
        return

    if action == "buy" and role == "moderator":
        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()

        cursor.execute("SELECT dc_balance, status FROM users WHERE user_id = ?", (user_id,))
        result = cursor.fetchone()

        if not result:
            await query.edit_message_text("‚ö†Ô∏è –í—ã –µ—â—ë –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –≤ —Å–∏—Å—Ç–µ–º–µ.")
            conn.close()
            return

        dc_balance, current_status = result

        if dc_balance < MODERATOR_COST:
            await query.edit_message_text("‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ DC –Ω–∞ –±–∞–ª–∞–Ω—Å–µ.")
            conn.close()
            return

        if current_status >= MODERATOR_STATUS:
            await query.edit_message_text("‚ö†Ô∏è –£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å —ç—Ç–æ—Ç —Å—Ç–∞—Ç—É—Å –∏–ª–∏ –≤—ã—à–µ.")
            conn.close()
            return

        new_balance = dc_balance - MODERATOR_COST
        cursor.execute("UPDATE users SET dc_balance = ?, status = ? WHERE user_id = ?",
                       (new_balance, MODERATOR_STATUS, user_id))
        conn.commit()
        conn.close()

        await query.edit_message_text(
            f"‚úÖ –í—ã —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–æ–±—Ä–µ–ª–∏ —Å—Ç–∞—Ç—É—Å: {STATUS_LIST[MODERATOR_STATUS]} ({MODERATOR_STATUS})!\n"
            f"üí∞ –û—Å—Ç–∞—Ç–æ–∫: {new_balance:,} DC"
        )


SMS_FILE_GLOBAL = "SMSChat.json"
SMS_FILE_CHATS = "SMSChatChats.json"


# --- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ ---

def load_sms_data_global():
    if os.path.exists(SMS_FILE_GLOBAL):
        try:
            with open(SMS_FILE_GLOBAL, "r") as f:
                return json.load(f)
        except Exception as e:
            print(f"‚ùó –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ {SMS_FILE_GLOBAL}: {e}")
            return {}
    return {}


def save_sms_data_global(data):
    tmp_file = SMS_FILE_GLOBAL + ".tmp"
    with open(tmp_file, "w") as f:
        json.dump(data, f, indent=4)
    os.replace(tmp_file, SMS_FILE_GLOBAL)


# --- –õ–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ —á–∞—Ç–∞–º ---

def load_sms_data_chats():
    if os.path.exists(SMS_FILE_CHATS):
        try:
            with open(SMS_FILE_CHATS, "r") as f:
                return json.load(f)
        except Exception as e:
            print(f"‚ùó –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ {SMS_FILE_CHATS}: {e}")
            return {}
    return {}


def save_sms_data_chats(data):
    tmp_file = SMS_FILE_CHATS + ".tmp"
    with open(tmp_file, "w") as f:
        json.dump(data, f, indent=4)
    os.replace(tmp_file, SMS_FILE_CHATS)


# --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π ---

async def message_counter(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    chat = update.effective_chat
    msg = update.message

    if not user or not chat or not msg:
        print("‚ö†Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ: user/chat/msg is None")
        return

    if not user.id:
        print("‚ö†Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ: —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç ID (–∞–Ω–æ–Ω–∏–º–Ω—ã–π –∞–¥–º–∏–Ω?)")
        return

    # –¢–∏–ø—ã —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
    content_types = []
    if msg.text: content_types.append("text")
    if msg.sticker: content_types.append("sticker")
    if msg.photo: content_types.append("photo")
    if msg.video: content_types.append("video")
    if msg.animation: content_types.append("gif")
    if msg.voice: content_types.append("voice")
    if msg.audio: content_types.append("audio")
    if msg.video_note: content_types.append("video_note")
    if msg.document: content_types.append("document")
    if not content_types: content_types.append("unknown")

    user_id = str(user.id)
    user_name = user.first_name or "–ë–µ–∑ –∏–º–µ–Ω–∏"
    chat_id = str(chat.id)

    # --- –ì–ª–æ–±–∞–ª—å–Ω—ã–π —É—á—ë—Ç ---
    global_data = load_sms_data_global()
    if user_id not in global_data:
        global_data[user_id] = {"name": user_name, "messages": 0}
    global_data[user_id]["name"] = user_name
    global_data[user_id]["messages"] += 1
    save_sms_data_global(global_data)

    # --- –õ–æ–∫–∞–ª—å–Ω—ã–π —É—á—ë—Ç ---
    chat_data = load_sms_data_chats()
    if chat_id not in chat_data:
        chat_data[chat_id] = {}
    if user_id not in chat_data[chat_id]:
        chat_data[chat_id][user_id] = {"name": user_name, "messages": 0}
    chat_data[chat_id][user_id]["name"] = user_name
    chat_data[chat_id][user_id]["messages"] += 1
    save_sms_data_chats(chat_data)


# --- –ö–æ–º–∞–Ω–¥–∞: –ì–ª–æ–±–∞–ª—å–Ω—ã–π –¢–æ–ø ---

async def sms_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    data = load_sms_data_global()
    if not data:
        await update.message.reply_text("–ü–æ–∫–∞ —á—Ç–æ –Ω–∏–∫—Ç–æ –Ω–µ –ø–∏—Å–∞–ª —Å–æ–æ–±—â–µ–Ω–∏–π.")
        return

    top_users = sorted(data.items(), key=lambda x: x[1]["messages"], reverse=True)[:5]
    msg = "üåê <b>–ì–ª–æ–±–∞–ª—å–Ω—ã–π –¢–æ–ø 5 –ø–æ —Å–æ–æ–±—â–µ–Ω–∏—è–º:</b>\n\n"
    for idx, (user_id, info) in enumerate(top_users, 1):
        msg += f"{idx}. <a href='tg://user?id={user_id}'>{info['name']}</a> ‚Äî <b>{info['messages']}</b> —Å–æ–æ–±—â–µ–Ω–∏–π\n"

    await update.message.reply_html(msg)


# --- –ö–æ–º–∞–Ω–¥–∞: –¢–æ–ø –ø–æ —á–∞—Ç—É ---

async def smsc_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    chat_id = str(update.effective_chat.id)
    data = load_sms_data_chats()

    if chat_id not in data or not data[chat_id]:
        await update.message.reply_text("–í —ç—Ç–æ–º —á–∞—Ç–µ –ø–æ–∫–∞ –Ω–∏–∫—Ç–æ –Ω–µ –ø–∏—Å–∞–ª —Å–æ–æ–±—â–µ–Ω–∏–π.")
        return

    top_users = sorted(data[chat_id].items(), key=lambda x: x[1]["messages"], reverse=True)[:5]
    msg = "üè† <b>–¢–æ–ø 5 —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —ç—Ç–æ–º —á–∞—Ç–µ:</b>\n\n"
    for idx, (user_id, info) in enumerate(top_users, 1):
        msg += f"{idx}. <a href='tg://user?id={user_id}'>{info['name']}</a> ‚Äî <b>{info['messages']}</b> —Å–æ–æ–±—â–µ–Ω–∏–π\n"

    await update.message.reply_html(msg)


ASK_CHOICE = 0
ASK_AMOUNT = 1

# –ö—É—Ä—Å –æ–±–º–µ–Ω–∞
RATE_RUB = 500
RATE_SEEDS = 1000


# –•–µ–ª–ø–µ—Ä –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –ë–î
def get_user(user_id):
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT user_id, username, first_name, dc_balance, balance, seeds FROM users WHERE user_id = ?",
                   (str(user_id),))
    row = cursor.fetchone()
    conn.close()
    return row


# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–æ–≤ –≤ –ë–î
def update_balances(user_id, new_dc_balance, new_rub_balance=None, new_seeds_balance=None):
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    if new_rub_balance is not None:
        cursor.execute("UPDATE users SET dc_balance = ?, balance = ? WHERE user_id = ?",
                       (new_dc_balance, new_rub_balance, str(user_id)))
    elif new_seeds_balance is not None:
        cursor.execute("UPDATE users SET dc_balance = ?, seeds = ? WHERE user_id = ?",
                       (new_dc_balance, new_seeds_balance, str(user_id)))
    else:
        cursor.execute("UPDATE users SET dc_balance = ? WHERE user_id = ?", (new_dc_balance, str(user_id)))
    conn.commit()
    conn.close()


# –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –∫—É–¥–∞ –æ–±–º–µ–Ω—è—Ç—å

EXCHANGE_TO = {}


async def dcchange_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    user_data = get_user(user.id)
    if not user_data:
        await update.message.reply_text("‚ùå –í—ã –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã.")
        return ConversationHandler.END

    _, username, first_name, dc_balance, _, _ = user_data
    display_name = first_name or username or "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"

    keyboard = [
        [InlineKeyboardButton("üíµ –û–±–º–µ–Ω—è—Ç—å –Ω–∞ ‚ÇΩ", callback_data="exchange_rub")],
        [InlineKeyboardButton("üå± –û–±–º–µ–Ω—è—Ç—å –Ω–∞ —Å–µ–º–µ–Ω–∞", callback_data="exchange_seeds")],
        [InlineKeyboardButton("üõí –û—Ç–∫—Ä—ã—Ç—å –º–∞–≥–∞–∑–∏–Ω", callback_data=f"dchop_open:{user.id}:1")],
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)

    text = (
        f"üí∞ <b>DigitalCoins</b> | <a href='tg://user?id={user.id}'>{display_name}</a>\n"
        f"üìä –ë–∞–ª–∞–Ω—Å: <b>{dc_balance} DC</b>\n\n"
        f"üîÑ <b>–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:</b>"
    )
    await update.message.reply_html(text, reply_markup=reply_markup)

    return "CHOOSING"  # ‚úÖ –ú–µ–Ω—è–µ–º ConversationHandler.END –Ω–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤—ã–±–æ—Ä–∞


async def exchange_choice(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    user_id = query.from_user.id
    user_data = get_user(user_id)
    if not user_data:
        await query.edit_message_text("‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω.")
        return ConversationHandler.END

    _, username, first_name, dc_balance, _, _ = user_data

    if query.data == "exchange_rub":
        EXCHANGE_TO[user_id] = "rub"
        prompt_text = f"üíµ –í–≤–µ–¥–∏—Ç–µ, —Å–∫–æ–ª—å–∫–æ DC –≤—ã —Ö–æ—Ç–∏—Ç–µ –æ–±–º–µ–Ω—è—Ç—å –Ω–∞ ‚ÇΩ:\nüí∞ –ë–∞–ª–∞–Ω—Å: {dc_balance} DC"
    elif query.data == "exchange_seeds":
        EXCHANGE_TO[user_id] = "seeds"
        prompt_text = f"üå± –í–≤–µ–¥–∏—Ç–µ, —Å–∫–æ–ª—å–∫–æ DC –≤—ã —Ö–æ—Ç–∏—Ç–µ –æ–±–º–µ–Ω—è—Ç—å –Ω–∞ —Å–µ–º–µ–Ω–∞:\nüí∞ –ë–∞–ª–∞–Ω—Å: {dc_balance} DC"
    else:
        return ConversationHandler.END

    # –¢–∞–π–º–∞—É—Ç
    context.job_queue.run_once(timeout_job, 60, data=user_id, name=str(user_id))

    await query.edit_message_text(prompt_text)
    return ASK_AMOUNT


async def process_amount(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    user_id = user.id
    text = update.message.text.strip()

    if user_id not in EXCHANGE_TO:
        await update.message.reply_text("‚è∞ –í—Ä–µ–º—è –Ω–∞ –≤–≤–æ–¥ —Å—É–º–º—ã –∏—Å—Ç–µ–∫–ª–æ.\n–û–±–º–µ–Ω –æ—Ç–º–µ–Ω—ë–Ω.")
        return ConversationHandler.END

    # –£–¥–∞–ª—è–µ–º —Ç–∞–π–º–∞—É—Ç
    for job in context.job_queue.get_jobs_by_name(str(user_id)):
        job.schedule_removal()

    if not text.isdigit() or int(text) <= 0:
        await update.message.reply_text("‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —á–∏—Å–ª–æ –±–æ–ª—å—à–µ –Ω—É–ª—è:")
        return ASK_AMOUNT

    amount = int(text)
    user_data = get_user(user_id)
    _, username, first_name, dc_balance, rub_balance, seeds_balance = user_data

    if amount > dc_balance:
        await update.message.reply_text(f"‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ DC. –ë–∞–ª–∞–Ω—Å: {dc_balance}\n–í–≤–µ–¥–∏—Ç–µ –¥—Ä—É–≥–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ:")
        return ASK_AMOUNT

    exchange_type = EXCHANGE_TO.get(user_id)
    if exchange_type == "rub":
        new_dc_balance = dc_balance - amount
        rub_received = int(amount * RATE_RUB)
        new_rub_balance = rub_balance + rub_received
        update_balances(user_id, new_dc_balance, new_rub_balance=new_rub_balance)
        await update.message.reply_text(f"‚úÖ –û–±–º–µ–Ω –≤—ã–ø–æ–ª–Ω–µ–Ω: {amount} DC ‚û°Ô∏è {rub_received} ‚ÇΩ")
    elif exchange_type == "seeds":
        new_dc_balance = dc_balance - amount
        seeds_received = int(amount * RATE_SEEDS)
        new_seeds_balance = seeds_balance + seeds_received
        update_balances(user_id, new_dc_balance, new_seeds_balance=new_seeds_balance)
        await update.message.reply_text(f"‚úÖ –û–±–º–µ–Ω –≤—ã–ø–æ–ª–Ω–µ–Ω: {amount} DC ‚û°Ô∏è {seeds_received} —Å–µ–º—è–Ω")

    EXCHANGE_TO.pop(user_id, None)
    return ConversationHandler.END


async def cancel(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    EXCHANGE_TO.pop(user_id, None)
    await update.message.reply_text("‚ùå –û–±–º–µ–Ω –æ—Ç–º–µ–Ω–µ–Ω.")
    return ConversationHandler.END


# --- –¢–∞–π–º–∞—É—Ç ---
async def timeout_job(context: ContextTypes.DEFAULT_TYPE):
    job = context.job
    user_id = job.data
    EXCHANGE_TO.pop(user_id, None)
    try:
        await context.bot.send_message(chat_id=user_id, text="‚è∞ –í—Ä–µ–º—è –Ω–∞ –≤–≤–æ–¥ —Å—É–º–º—ã –∏—Å—Ç–µ–∫–ª–æ.\n–û–±–º–µ–Ω –æ—Ç–º–µ–Ω—ë–Ω.")
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}: {e}")


RATING_FILE = "RatingUsers.json"

vip_names = {
    0: "–ù–µ—Ç",
    1: "Silver ü•à",
    2: "Gold ü•á",
    3: "Platinum üíé",
    4: "Legend üî•"
}


def load_ratings():
    try:
        with open(RATING_FILE, "r", encoding="utf-8") as f:
            return json.load(f)
    except FileNotFoundError:
        return {"users": {}}


def save_ratings(data):
    with open(RATING_FILE, "w", encoding="utf-8") as f:
        json.dump(data, f, ensure_ascii=False, indent=4)


def reset_daily_limits_if_needed(user_data):
    now = datetime.utcnow()
    last_reset_str = user_data.get("last_reset")
    if last_reset_str:
        try:
            last_reset = datetime.fromisoformat(last_reset_str)
        except ValueError:
            last_reset = now
        if (now - last_reset).total_seconds() > 86400:  # 24 —á–∞—Å–∞
            user_data["daily_given"] = 0
            user_data["daily_taken"] = 0
            user_data["last_reset"] = now.isoformat()
    else:
        user_data["daily_given"] = 0
        user_data["daily_taken"] = 0
        user_data["last_reset"] = now.isoformat()


def get_user_data(data, user_id, first_name=None):
    users = data["users"]
    uid = str(user_id)
    if uid not in users:
        users[uid] = {
            "first_name": first_name or "User",
            "rating": 0,
            # vip_status –æ—Å—Ç–∞–≤–ª—è–µ–º –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏,
            # –Ω–æ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –±—É–¥–µ–º –±—Ä–∞—Ç—å –∏–∑ SQLite
            "vip_status": 0,
            "daily_given": 0,
            "daily_taken": 0,
            "last_reset": datetime.utcnow().isoformat()
        }
    user_data = users[uid]
    reset_daily_limits_if_needed(user_data)
    return user_data


def get_vip_status(user_id: int) -> int:
    """–ü–æ–ª—É—á–∏—Ç—å vip_status –∏–∑ SQLite, –µ—Å–ª–∏ VIP –µ—â—ë –∞–∫—Ç–∏–≤–µ–Ω, –∏–Ω–∞—á–µ 0."""
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT vip_status, vip_until FROM users WHERE user_id = ?", (str(user_id),))
    row = cursor.fetchone()
    conn.close()
    if row:
        vip_status, vip_until = row
        now = int(time.time())
        if vip_until and vip_until > now:
            return vip_status
    return 0

async def greet_new_member_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    for member in update.message.new_chat_members:
        user_id = str(member.id)
        display_name = get_display_name_html_new(member)

        create_user_in_db(user_id, member.username or "")

        data = load_ratings()
        user_data = get_user_data(data, user_id, member.first_name or "–ë–µ–∑ –∏–º–µ–Ω–∏")
        rating = user_data.get("rating", 0)

        # –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —á–∞—Ç–∞
        try:
            with open(JSON_CHATSET_PATH, "r", encoding="utf-8") as f:
                chat_settings = json.load(f)
            chat_id = str(update.effective_chat.id)
            chat_config = chat_settings.get(chat_id, {})
            custom_hi = chat_config.get("HiText", "").strip()
        except FileNotFoundError:
            custom_hi = ""

        # –í–ª–∞–¥–µ–ª–µ—Ü-—Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫
        if user_id == "7406372338":
            text = (
                "üëë‚ö†Ô∏è <b>–í–ù–ò–ú–ê–ù–ò–ï!</b> ‚ö†Ô∏èüëë\n"
                f"üéâ –í —á–∞—Ç –∑–∞—à–µ–ª <a href='tg://user?id={user_id}'>–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –í–ª–∞–¥–µ–ª–µ—Ü-–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ –±–æ—Ç–∞</a>! üéâ\n"
                "‚ù§Ô∏è –ü—Ä–æ—Å–∏–º –ª—é–±–∏—Ç—å –∏ –∂–∞–ª–æ–≤–∞—Ç—å ü§ù\n\n"
                f"‚ú® <b>–†–µ–π—Ç–∏–Ω–≥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</b> {rating} üåü"
            )
        else:
            if not custom_hi or custom_hi in ["-", "DelateParameter", "–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ"]:
                text = (
                    f"üëã –ü—Ä–∏–≤–µ—Ç, {display_name}!\n\n"
                    f"‚ú® <b>–†–µ–π—Ç–∏–Ω–≥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</b> {rating}\n\n"
                    "üìà –ü—Ä–æ–¥–æ–ª–∂–∞–π –≤ —Ç–æ–º –∂–µ –¥—É—Ö–µ, –∏ —É—Å–ø–µ—Ö –Ω–µ –∑–∞—Å—Ç–∞–≤–∏—Ç —Å–µ–±—è –∂–¥–∞—Ç—å!\n\n"
                    "ü§ó –ñ–µ–ª–∞–µ–º —Ç–µ–±–µ –æ—Ç–ª–∏—á–Ω–æ–≥–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è –∏ –ø—Ä–∏—è—Ç–Ω–æ–≥–æ –æ–±—â–µ–Ω–∏—è!"
                )
            else:
                hi_text = custom_hi.replace("{@user}", display_name)
                hi_text = hi_text.replace("{rating}", str(rating))
                hi_text = hi_text.replace("{name}", html.escape(member.first_name or "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"))
                text = f"{hi_text}\n\n‚ú® <b>–†–µ–π—Ç–∏–Ω–≥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</b> {rating}"

        await context.bot.send_message(
            chat_id=update.effective_chat.id,
            text=text,
            parse_mode="HTML"
        )

        # ======= WARNING: –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–π—Ç–∏–Ω–≥–∞ =======
        if member.is_bot:
            continue

        if rating <= -51:
            chat = update.effective_chat

            try:
                admins = await context.bot.get_chat_administrators(chat.id)
                owner = next((a.user for a in admins if a.status == "creator"), None)
                owner_mention = get_display_name_html_new(owner) if owner else "–í–ª–∞–¥–µ–ª–µ—Ü"
            except Exception:
                owner_mention = "–í–ª–∞–¥–µ–ª–µ—Ü"

            member_mention = get_display_name_html_new(member)

            warning_text = (
                f"‚ö†Ô∏è<b>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Warning ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</b>‚ö†Ô∏è\n\n"
                f"üëë {owner_mention}\n"
                f"üë§ {member_mention}\n\n"
                f"–£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π —Ä–µ–π—Ç–∏–Ω–≥ (<b>{rating}</b>), –ø—Ä–∏–º–∏—Ç–µ –º–µ—Ä—ã."
            )

            keyboard = InlineKeyboardMarkup([
                [InlineKeyboardButton(
                    "üë¢ –í—ã–≥–Ω–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è",
                    callback_data=f"warn_kick:{member.id}:{chat.id}"
                )],
                [InlineKeyboardButton(
                    "‚õî –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–≤—Å–µ–≥–¥–∞",
                    callback_data=f"warn_permban:{member.id}:{chat.id}"
                )],
                [InlineKeyboardButton(
                    "‚úÖ –ù–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞—Ç—å",
                    callback_data=f"warn_ignore:{member.id}:{chat.id}"
                )],
            ])

            await context.bot.send_message(
                chat_id=chat.id,
                text=warning_text,
                parse_mode=ParseMode.HTML,
                reply_markup=keyboard
            )


async def farewell_member_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """
    –û—Ç–ø—Ä–∞–≤–∫–∞ –ø—Ä–æ—â–∞–ª—å–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è, –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–∫–∏–¥–∞–µ—Ç —á–∞—Ç
    """
    user = update.message.left_chat_member
    if not user:
        return

    user_id = str(user.id)
    display_name = get_display_name_html_new(user)

    # –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–µ–π—Ç–∏–Ω–≥
    data = load_ratings()
    user_data = get_user_data(data, user_id, user.first_name or "–ë–µ–∑ –∏–º–µ–Ω–∏")
    rating = user_data.get("rating", 0)

    # –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —á–∞—Ç–∞
    try:
        with open(JSON_CHATSET_PATH, "r", encoding="utf-8") as f:
            chat_settings = json.load(f)
        chat_id = str(update.effective_chat.id)
        chat_config = chat_settings.get(chat_id, {})
        custom_bye = chat_config.get("GoodByeText", "").strip()
    except FileNotFoundError:
        custom_bye = ""

    # –ï—Å–ª–∏ —Å—Ç–æ–∏—Ç DelateParameter –∏–ª–∏ –ø—É—Å—Ç–æ–µ/–º–∏–Ω—É—Å/—Å—Ç–∞–Ω–¥–∞—Ä—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω–æ–µ
    if not custom_bye or custom_bye in ["-", "DelateParameter", "–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –ø—Ä–æ—â–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ"]:
        text = (
            f"üëã {display_name} –ø–æ–∫–∏–Ω—É–ª —á–∞—Ç.\n\n"
            f"‚ú® <b>–†–µ–π—Ç–∏–Ω–≥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</b> {rating}\n\n"
            "üìå –ù–∞–¥–µ–µ–º—Å—è —É–≤–∏–¥–µ—Ç—å —Ç–µ–±—è —Å–Ω–æ–≤–∞! –£–¥–∞—á–∏ –∏ —Ö–æ—Ä–æ—à–µ–≥–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è!"
        )
    else:
        bye_text = custom_bye.replace("{@user}", display_name)
        bye_text = bye_text.replace("{rating}", str(rating))
        bye_text = bye_text.replace("{name}", html.escape(user.first_name or "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"))
        text = f"{bye_text}\n\n‚ú® <b>–†–µ–π—Ç–∏–Ω–≥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</b> {rating}"

    await context.bot.send_message(
        chat_id=update.effective_chat.id,
        text=text,
        parse_mode="HTML"
    )


async def upraiting(update: Update, context: ContextTypes.DEFAULT_TYPE):
    data = load_ratings()
    giver = update.effective_user
    giver_data = get_user_data(data, giver.id, giver.first_name)

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–º–∏—Ç –¥–∞—á–∏ —Ä–µ–π—Ç–∏–Ω–≥–∞ (5 –≤ –¥–µ–Ω—å)
    if giver_data["daily_given"] >= 5:
        await update.message.reply_text("‚ùå –í—ã —É–∂–µ –∏–∑—Ä–∞—Å—Ö–æ–¥–æ–≤–∞–ª–∏ –≤—Å–µ 5 —Ä–µ–π—Ç–∏–Ω–≥–æ–≤ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è.")
        return

    count = 1  # –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 1

    if update.message.reply_to_message:
        target_user = update.message.reply_to_message.from_user
        if context.args:
            try:
                count = int(context.args[0])
                if count < 1:
                    raise ValueError
            except:
                await update.message.reply_text("‚ùå –ù–µ–≤–µ—Ä–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–π—Ç–∏–Ω–≥–∞.")
                return
    elif context.args:
        try:
            user_id = int(context.args[0])
            target_user = await context.bot.get_chat(user_id)
            if len(context.args) > 1:
                count = int(context.args[1])
                if count < 1:
                    raise ValueError
        except Exception:
            return
    else:
        return

    if target_user.id == giver.id:
        return

    target_data = get_user_data(data, target_user.id, target_user.first_name)

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–º–∏—Ç
    if giver_data["daily_given"] + count > 5:
        count = 5 - giver_data["daily_given"]

    # –î–∞–µ–º —Ä–µ–π—Ç–∏–Ω–≥
    target_data["rating"] += count
    giver_data["daily_given"] += count

    save_ratings(data)

    await update.message.reply_text(
        f"üíù –£–≤–∞–∂–µ–Ω–∏–µ [{target_data['first_name']}](tg://user?id={target_user.id}) –æ–∫–∞–∑–∞–Ω–æ. +{count}\n",
        parse_mode="Markdown")


async def downraiting(update: Update, context: ContextTypes.DEFAULT_TYPE):
    data = load_ratings()
    taker = update.effective_user
    taker_data = get_user_data(data, taker.id, taker.first_name)

    # –ü–æ–ª—É—á–∞–µ–º vip_status –∏–∑ SQLite (–∞–∫—Ç—É–∞–ª—å–Ω—ã–π)
    vip_status = get_vip_status(taker.id)

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º vip —Å—Ç–∞—Ç—É—Å (2 –∏ –≤—ã—à–µ)
    if vip_status < 2:
        await update.message.reply_text(
            "‚ùå <b>–ú–∏–Ω—É—Å–∏—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω...</b>\n"
            "<pre>–ö–æ–º–∞–Ω–¥—É –º–æ–≥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å <b>VIP —Å—Ç–∞—Ç—É—Å–∞–º–∏:</b></pre>\n"
            "‚Ä¢ ü•á <b>Gold</b>\n"
            "‚Ä¢ üíé <b>Platinum</b>\n"
            "‚Ä¢ üëë <b>Legend</b>",
            parse_mode="HTML"
        )

        return

    # –õ–∏–º–∏—Ç —Å–Ω—è—Ç–∏—è —Ä–µ–π—Ç–∏–Ω–≥–∞ 5 –≤ –¥–µ–Ω—å
    if taker_data["daily_taken"] >= 5:
        await update.message.reply_text("‚ùå –í—ã —É–∂–µ –∏–∑—Ä–∞—Å—Ö–æ–¥–æ–≤–∞–ª–∏ –≤—Å–µ 5 —Ä–µ–π—Ç–∏–Ω–≥–æ–≤ –Ω–∞ —Å–Ω—è—Ç–∏–µ —Å–µ–≥–æ–¥–Ω—è.")
        return

    count = 1  # –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–π—Ç–∏–Ω–≥–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —É –∫–æ–≥–æ —Å–Ω–∏–º–∞–µ–º —Ä–µ–π—Ç–∏–Ω–≥, –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–π—Ç–∏–Ω–≥–∞
    if update.message.reply_to_message:
        target_user = update.message.reply_to_message.from_user
        if context.args:
            try:
                count = int(context.args[0])
                if count < 1:
                    raise ValueError
            except:
                await update.message.reply_text("‚ùå –ù–µ–≤–µ—Ä–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–π—Ç–∏–Ω–≥–∞.")
                return
    elif context.args:
        try:
            user_id = int(context.args[0])
            target_user = await context.bot.get_chat(user_id)
            if len(context.args) > 1:
                count = int(context.args[1])
                if count < 1:
                    raise ValueError
        except Exception:
            await update.message.reply_text("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –∞—Ä–≥—É–º–µ–Ω—Ç –∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω.")
            return
    else:
        await update.message.reply_text("‚ùå –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É –≤ –æ—Ç–≤–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ —É–∫–∞–∂–∏—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.")
        return

    # –ó–∞–ø—Ä–µ—Ç —Å–Ω–∏–º–∞—Ç—å —Ä–µ–π—Ç–∏–Ω–≥ —É —Å–∞–º–æ–≥–æ —Å–µ–±—è
    if target_user.id == taker.id:
        await update.message.reply_text("‚ùå –ù–µ–ª—å–∑—è —É–º–µ–Ω—å—à–∞—Ç—å —Ä–µ–π—Ç–∏–Ω–≥ —Å–∞–º–æ–º—É —Å–µ–±–µ.")
        return

    target_data = get_user_data(data, target_user.id, target_user.first_name)

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–º–∏—Ç —Å–Ω—è—Ç–∏—è
    if taker_data["daily_taken"] + count > 5:
        count = 5 - taker_data["daily_taken"]

    # –£–º–µ–Ω—å—à–∞–µ–º —Ä–µ–π—Ç–∏–Ω–≥
    target_data["rating"] -= count
    taker_data["daily_taken"] += count

    save_ratings(data)

    await update.message.reply_text(
        f"üëé –ù–µ–≥–∞—Ç–∏–≤ –∫ [{target_data['first_name']}](tg://user?id={target_user.id}) –æ–∫–∞–∑–∞–Ω. -{count}\n",
        parse_mode="Markdown"
    )


async def reting(update: Update, context: ContextTypes.DEFAULT_TYPE):
    data = load_ratings()

    if update.message.reply_to_message:
        target_user = update.message.reply_to_message.from_user
    else:
        target_user = update.effective_user

    target_data = get_user_data(data, target_user.id, target_user.first_name)

    # –ü–æ–ª—É—á–∞–µ–º VIP —Å—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user_vip_data = get_uservip_data(str(target_user.id))
    vip_status_id = user_vip_data.get("vip_status", 0)
    vip_str = vip_names.get(vip_status_id, "–ù–µ—Ç")  # vip_names –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å–ª–æ–≤–∞—Ä—ë–º: id -> –Ω–∞–∑–≤–∞–Ω–∏–µ

    await update.message.reply_text(
        f"üìä –†–µ–π—Ç–∏–Ω–≥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è [{target_data['first_name']}](tg://user?id={target_user.id}): {target_data['rating']}\n"
        f"üíé VIP —Å—Ç–∞—Ç—É—Å: {vip_str}",
        parse_mode="Markdown"
    )


async def rating_limite(update: Update, context: ContextTypes.DEFAULT_TYPE):
    data = load_ratings()
    user = update.effective_user
    user_data = get_user_data(data, user.id, user.first_name)

    used = user_data.get("daily_given", 0)
    max_limit = 5

    await update.message.reply_text(
        f"üìÖ <b>–í–∞—à –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π –ª–∏–º–∏—Ç —Ä–µ–π—Ç–∏–Ω–≥–∞:</b>\n"
        f"<pre>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ: <b>{used}</b> –∏–∑ <b>{max_limit}</b></pre>"
        , parse_mode="HTML"
    )


async def rating_general_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    message_text_lower = update.message.text.lower().strip()

    if message_text_lower == "—Ä–µ–π—Ç–∏–Ω–≥":
        await reting(update, context)
    elif message_text_lower == "—Ä–µ–π—Ç–∏–Ω–≥ –ª–∏–º–∏—Ç":
        await rating_limite(update, context)
    else:
        await update.message.reply_text(
            "‚ùå <b>–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞.</b>\n\n"
            "–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:\n"
            "‚Ä¢ <code>–†–µ–π—Ç–∏–Ω–≥</code>\n"
            "‚Ä¢ <code>–†–µ–π—Ç–∏–Ω–≥ –ª–∏–º–∏—Ç</code>",
            parse_mode="HTML"
        )


def get_user_ahelp_status(user_id: int) -> int:
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT status FROM users WHERE user_id = ?", (str(user_id),))
    result = cursor.fetchone()
    conn.close()
    if result:
        return result[0]
    return 0  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å—Ç–∞—Ç—É—Å 0 (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)


HELP_TEXTS = {
    2: """
üë∂ **–ú–ª. –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä (2)**

üìú –ö–æ–º–∞–Ω–¥—ã:
- `/ahelp` ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–º–æ—â–∏
- üîá –ú—É—Ç ‚Äî –≤—ã–¥–∞—Ç—å –º—É—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
""",
    3: """
üëÆ **–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä (3)**

üìú –ö–æ–º–∞–Ω–¥—ã:
- ü¶µ –ö–∏–∫ ‚Äî –≤—ã–≥–Ω–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —á–∞—Ç–∞
- `/ahelp` ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–º–æ—â–∏
- üîá –ú—É—Ç ‚Äî –≤—ã–¥–∞—Ç—å –º—É—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
- üîä –†–∞–∑–º—É—Ç ‚Äî —Å–Ω—è—Ç—å –º—É—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
""",
    4: """
üõ°Ô∏è **–°—Ç. –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä (4)**

üìú –ö–æ–º–∞–Ω–¥—ã:
- ü¶µ –ö–∏–∫ ‚Äî –≤—ã–≥–Ω–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —á–∞—Ç–∞
- `/ahelp` ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–º–æ—â–∏
- üîá –ú—É—Ç ‚Äî –≤—ã–¥–∞—Ç—å –º—É—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
- üîä –†–∞–∑–º—É—Ç ‚Äî —Å–Ω—è—Ç—å –º—É—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
""",
    5: """
üëÆ‚Äç‚ôÇÔ∏è **–ú–ª. –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä (5)**

üìú –ö–æ–º–∞–Ω–¥—ã:
- ü¶µ –ö–∏–∫ ‚Äî –≤—ã–≥–Ω–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —á–∞—Ç–∞
- `/ahelp` ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–º–æ—â–∏
- üîá –ú—É—Ç ‚Äî –≤—ã–¥–∞—Ç—å –º—É—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
- üîä –†–∞–∑–º—É—Ç ‚Äî —Å–Ω—è—Ç—å –º—É—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
- ‚õî –ë–∞–Ω ‚Äî –≤—ã–¥–∞—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
""",
    6: """
üë®‚Äç‚öñÔ∏è **–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä (6)**

üìú –ö–æ–º–∞–Ω–¥—ã:
- ü¶µ –ö–∏–∫ ‚Äî –≤—ã–≥–Ω–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —á–∞—Ç–∞
- `/ahelp` ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–º–æ—â–∏
- üîá –ú—É—Ç ‚Äî –≤—ã–¥–∞—Ç—å –º—É—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
- üîä –†–∞–∑–º—É—Ç ‚Äî —Å–Ω—è—Ç—å –º—É—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
- ‚õî –ë–∞–Ω ‚Äî –≤—ã–¥–∞—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
- üîì —Ä–∞–∑–±–∞–Ω ‚Äî —Å–Ω—è—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
- ‚ÑπÔ∏è –±–∏–Ω—Ñ–æ ‚Äî –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ
""",
    7: """
üõ°Ô∏è **–°—Ç. –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä (7)**

üìú –ö–æ–º–∞–Ω–¥—ã:
- ü¶µ –ö–∏–∫ ‚Äî –≤—ã–≥–Ω–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —á–∞—Ç–∞
- `/ahelp` ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–º–æ—â–∏
- üîá –ú—É—Ç ‚Äî –≤—ã–¥–∞—Ç—å –º—É—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
- üîä –†–∞–∑–º—É—Ç ‚Äî —Å–Ω—è—Ç—å –º—É—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
- ‚õî –ë–∞–Ω ‚Äî –≤—ã–¥–∞—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
- üö´ /permban ‚Äî –≤—ã–¥–∞—Ç—å –≤–µ—á–Ω—É—é –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
- üîì —Ä–∞–∑–±–∞–Ω ‚Äî —Å–Ω—è—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
- ‚ÑπÔ∏è –±–∏–Ω—Ñ–æ ‚Äî –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ
""",
    8: """
üíª **–¢–µ—Ö. –°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç (8)**

üìú –ö–æ–º–∞–Ω–¥—ã:
- ü¶µ –ö–∏–∫ ‚Äî –≤—ã–≥–Ω–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —á–∞—Ç–∞
- `/ahelp` ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–º–æ—â–∏
- üîá –ú—É—Ç ‚Äî –≤—ã–¥–∞—Ç—å –º—É—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
- üîä –†–∞–∑–º—É—Ç ‚Äî —Å–Ω—è—Ç—å –º—É—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
- ‚õî –ë–∞–Ω ‚Äî –≤—ã–¥–∞—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
- üö´ /permban ‚Äî –≤—ã–¥–∞—Ç—å –≤–µ—á–Ω—É—é –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
- üîì —Ä–∞–∑–±–∞–Ω ‚Äî —Å–Ω—è—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
- ‚ÑπÔ∏è –±–∏–Ω—Ñ–æ ‚Äî –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ
- ‚öôÔ∏è —Ç–µ—Ö ‚Äî –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –±–æ—Ç–∞
""",
    9: """
üéì **–ö—É—Ä–∞—Ç–æ—Ä (9)**

üìú –ö–æ–º–∞–Ω–¥—ã:
- ü¶µ –ö–∏–∫ ‚Äî –≤—ã–≥–Ω–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —á–∞—Ç–∞
- `/ahelp` ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–º–æ—â–∏
- üîá –ú—É—Ç ‚Äî –≤—ã–¥–∞—Ç—å –º—É—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
- üîä –†–∞–∑–º—É—Ç ‚Äî —Å–Ω—è—Ç—å –º—É—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
- ‚õî –ë–∞–Ω ‚Äî –≤—ã–¥–∞—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
- üö´ /permban ‚Äî –≤—ã–¥–∞—Ç—å –≤–µ—á–Ω—É—é –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
- üîì —Ä–∞–∑–±–∞–Ω ‚Äî —Å–Ω—è—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
- ‚ÑπÔ∏è –±–∏–Ω—Ñ–æ ‚Äî –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ
- ‚öôÔ∏è —Ç–µ—Ö ‚Äî –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –±–æ—Ç–∞
- üîÑ —Ä–æ–ª—å ‚Äî –∏–∑–º–µ–Ω–∏—Ç—å —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
"""
}


async def ahelp_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    status = get_user_ahelp_status(user_id)

    if status in HELP_TEXTS:
        help_text = HELP_TEXTS[status]
    elif status > max(HELP_TEXTS.keys()):
        help_text = "‚ùå –ù–∞ –≤–∞—à —Å—Ç–∞—Ç—É—Å –Ω–µ —É–∫–∞–∑–∞–Ω—ã –∫–æ–º–∞–Ω–¥—ã."
    else:
        help_text = "‚ùå –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–º –∫–æ–º–∞–Ω–¥–∞–º."
    await update.message.reply_text(help_text, parse_mode='Markdown')


ADMIN_setrole_ID = 7406372338


def set_user_setrole_status(user_id: int, new_status: int):
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("UPDATE users SET status = ? WHERE user_id = ?", (new_status, str(user_id)))
    conn.commit()
    conn.close()


async def setrole_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞
    if update.effective_user.id != ADMIN_setrole_ID:
        await update.message.reply_text("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç—É –∫–æ–º–∞–Ω–¥—É.")
        return

    args = context.args

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –∞—Ä–≥—É–º–µ–Ω—Ç–∞ —Ä–æ–ª–∏
    if len(args) < 1:
        await update.message.reply_text("‚ùå –£–∫–∞–∂–∏—Ç–µ —Ä–æ–ª—å (—á–∏—Å–ª–æ –æ—Ç 0 –¥–æ 13).")
        return

    try:
        role = int(args[0])
    except ValueError:
        await update.message.reply_text("‚ùå –†–æ–ª—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —á–∏—Å–ª–æ–º –æ—Ç 0 –¥–æ 13.")
        return

    if role < 0 or role > 13:
        await update.message.reply_text("‚ùå –†–æ–ª—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —á–∏—Å–ª–æ–º –æ—Ç 0 –¥–æ 13.")
        return

    # –ü–æ–ª—É—á–∞–µ–º ID –∏ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ reply –∏–ª–∏ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤
    if update.message.reply_to_message:
        target_user = update.message.reply_to_message.from_user
        target_id = target_user.id
        target_name = target_user.first_name or "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"
    elif len(args) >= 2:
        try:
            target_id = int(args[1])
            try:
                target_user = await context.bot.get_chat(target_id)
                target_name = target_user.first_name or "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"
            except Exception:
                target_user = None
                target_name = "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"
        except ValueError:
            await update.message.reply_text("‚ùå –í—Ç–æ—Ä–æ–π –∞—Ä–≥—É–º–µ–Ω—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å Telegram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.")
            return
    else:
        await update.message.reply_text("‚ùå –£–∫–∞–∂–∏—Ç–µ Telegram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ –æ—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ –µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–µ.")
        return

    # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤ –±–∞–∑–µ (—Ñ—É–Ω–∫—Ü–∏—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞)
    set_user_setrole_status(target_id, role)

    # –§–æ—Ä–º–∏—Ä—É–µ–º —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ
    if target_user:
        target_mention = mention_html(target_id, target_name)
    else:
        target_mention = f"<code>{target_id}</code>"

    # –û—Ç–≤–µ—Ç —Å –∫—Ä–∞—Å–∏–≤—ã–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º
    await update.message.reply_html(
        f"‚úÖ <b>–†–æ–ª—å —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞!</b>\n\n"
        f"üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {target_mention}\n"
        f"üéØ –†–æ–ª—å: <b>{role} ‚Äî {STATUS_LIST[role]}</b>\n\n"
    )


RP_COMMANDS_LINK = "https://telegra.ph/Spisok-RP-komand-07-14"
PLAY_COMMANDS_LINK = "https://telegra.ph/Igrovye-komandy-07-14"
FIN_COMMANS_LINK = "https://telegra.ph/Finansovye-komandy-07-14"


async def bank_destroid(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = (
        "‚ö†Ô∏è <b><u>–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞</u></b>\n\n"
        "üíº <i>–ë–∞–Ω–∫–æ–≤—Å–∫–∞—è —Å–∏—Å—Ç–µ–º–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞.</i>\n"
        "üîß –í–µ–¥—É—Ç—Å—è <b>—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ä–∞–±–æ—Ç—ã</b>, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.\n\n"
        "üôè –ë–ª–∞–≥–æ–¥–∞—Ä–∏–º –∑–∞ –ø–æ–Ω–∏–º–∞–Ω–∏–µ!"
    )

    await update.message.reply_html(text)


async def command_list(update: Update, context: ContextTypes.DEFAULT_TYPE):
    keyboard = [
        [InlineKeyboardButton("üìú RP-–∫–æ–º–∞–Ω–¥—ã", url=RP_COMMANDS_LINK)],
        [InlineKeyboardButton("üéÆ –ò–≥—Ä–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã", url=PLAY_COMMANDS_LINK)],
        [InlineKeyboardButton("üí∞ –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã", url=FIN_COMMANS_LINK)]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)

    text = (
        "üìã <b>–°–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥ –±–æ—Ç–∞</b>\n\n"
        "–ù–∏–∂–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω —Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º"
    )

    await update.message.reply_html(text, reply_markup=reply_markup)


ROLE_NAMES = {
    5: "–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å",
    4: "–ó–∞–º–µ—Å—Ç–∏—Ç–µ–ª—å —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—è",
    3: "–°—Ç–∞—Ä—à–∏–π —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç",
    2: "–°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç",
    1: "–ú–ª–∞–¥—à–∏–π —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç"
}

# –û–±—è–∑–∞–Ω–Ω–æ—Å—Ç–∏ –æ—Ç–¥–µ–ª–æ–≤ ‚Äî –º–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å
DEPARTMENT_DUTIES = {
    "Admins - Helpers": "–°–ª–µ–∂–µ–Ω–∏–µ –∑–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º —Å–∏—Å—Ç–µ–º: ASK / Report / Appelation",
    "AdminsTestors": "–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –ø–µ—Ä–µ–¥ —Ä–µ–ª–∏–∑–æ–º",
}

def get_db_connection():
    conn = sqlite3.connect(DB_PATH)
    conn.row_factory = sqlite3.Row
    return conn


async def depus(update: Update, context: ContextTypes.DEFAULT_TYPE):
    # –ü–æ–ª—É—á–∞–µ–º user_id –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
    args = context.args
    user_id = None

    if args:
        try:
            user_id = int(args[0])
        except ValueError:
            await update.message.reply_text("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç TelegramID.")
            return
    elif update.message.reply_to_message:
        user_id = update.message.reply_to_message.from_user.id
    else:
        user_id = update.message.from_user.id

    conn = get_db_connection()
    cursor = conn.cursor()
    cursor.execute("SELECT * FROM departament WHERE user_id = ?", (str(user_id),))
    user_dep = cursor.fetchone()

    if not user_dep:
        await update.message.reply_text("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —Å–æ—Å—Ç–æ–∏—Ç –≤ –æ—Ç–¥–µ–ª–µ.")
        conn.close()
        return

    # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –∏–º–µ–Ω–∏
    cursor.execute("SELECT first_name FROM users WHERE user_id = ?", (str(user_id),))
    user_info = cursor.fetchone()
    first_name = user_info["first_name"] if user_info else "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"

    dep_name = user_dep["department_name"]
    role = user_dep["role"]
    warnings = user_dep["warnings"]
    join_date_str = user_dep["join_date"]

    join_date = datetime.strptime(join_date_str, "%Y-%m-%d %H:%M:%S")
    now = datetime.now()
    days_in_dep = (now - join_date).days

    text = (
        f"üè¢ *–û—Ç–¥–µ–ª:* {dep_name}\n"
        f"üë§ [{first_name}](tg://user?id={user_id})\n"
        f"üÜî *Telegram ID:* `{user_id}`\n"
        f"üéØ *–†–æ–ª—å:* {ROLE_NAMES.get(role, '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è')}\n"
        f"‚ö†Ô∏è *–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è:* {warnings}/3\n"
        f"üìÖ *–î–∞—Ç–∞ –≤—Å—Ç—É–ø–ª–µ–Ω–∏—è:* {join_date.strftime('%d.%m.%Y / %H:%M:%S')}\n"
        f"‚è≥ *–î–Ω–µ–π –≤ –æ—Ç–¥–µ–ª–µ:* {days_in_dep}"
    )

    await update.message.reply_markdown(text)
    conn.close()

DEPARTMENTS = {i + 1: dep_name for i, dep_name in enumerate(DEPARTMENT_DUTIES.keys())}

async def tempdep(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id_str = str(update.effective_user.id)
    user = update.effective_user

    if user_id_str not in DEV_IDS:
        await update.message.reply_text("üö´ –≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–º —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞–º.")
        return

    if not context.args:
        departments_list = "\n".join(f"‚Ä¢ <b>{num}</b> ‚Äî {name}" for num, name in DEPARTMENTS.items())
        text = (
            "‚ùó <b>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:</b> /tempdep {–Ω–æ–º–µ—Ä –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–∞}\n\n"
            "0 ‚Äî –ø–æ–∫–∏–Ω—É—Ç—å –æ—Ç–¥–µ–ª\n\n"
            f"{departments_list}"
        )
        await update.message.reply_text(text, parse_mode=ParseMode.HTML)
        return

    try:
        dep_num = int(context.args[0])
    except ValueError:
        await update.message.reply_text("‚ùó –ù–æ–º–µ—Ä –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–∞ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º.")
        return

    if dep_num < 0 or dep_num > len(DEPARTMENTS):
        await update.message.reply_text("‚ùó –ù–µ–≤–µ—Ä–Ω—ã–π –Ω–æ–º–µ—Ä –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–∞.")
        return

    display_name = get_display_name_html_new(user)

    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    cursor.execute("SELECT department_name FROM departament WHERE user_id = ?", (user_id_str,))
    row = cursor.fetchone()
    current_dep = row[0] if row else None

    new_dep = None if dep_num == 0 else DEPARTMENTS[dep_num]

    if dep_num == 0:
        if current_dep:
            cursor.execute("DELETE FROM departament WHERE user_id = ?", (user_id_str,))
            conn.commit()
            conn.close()
            await update.message.reply_text(
                f"üì§ <b>–ü–æ–∫–∏–¥–∞–Ω–∏–µ –æ—Ç–¥–µ–ª–∞</b>\n"
                f"üë§ {display_name}\n"
                f"üè¢ –û—Ç–¥–µ–ª: <b>{html.escape(current_dep)}</b>",
                parse_mode=ParseMode.HTML
            )
        else:
            conn.close()
            await update.message.reply_text(
                "‚ùó –í—ã –Ω–µ —Å–æ—Å—Ç–æ–∏—Ç–µ –Ω–∏ –≤ –æ–¥–Ω–æ–º –æ—Ç–¥–µ–ª–µ.",
                parse_mode=ParseMode.HTML
            )
        return

    if current_dep == new_dep:
        conn.close()
        await update.message.reply_text(
            "üîù –í—ã —É–∂–µ —è–≤–ª—è–µ—Ç–µ—Å—å <b>–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª–µ–º</b> —ç—Ç–æ–≥–æ –æ—Ç–¥–µ–ª–∞.",
            parse_mode=ParseMode.HTML
        )
        return

    messages = []

    if current_dep:
        messages.append(
            f"üì§ <b>–ü–æ–∫–∏–¥–∞–Ω–∏–µ –æ—Ç–¥–µ–ª–∞</b>\n"
            f"üë§ {display_name}\n"
            f"üè¢ –û—Ç–¥–µ–ª: <b>{html.escape(current_dep)}</b>"
        )
        cursor.execute("""
            UPDATE departament SET department_name = ?, role = 5, join_date = ?
            WHERE user_id = ?
        """, (new_dep, datetime.now().strftime("%Y-%m-%d %H:%M:%S"), user_id_str))
    else:
        cursor.execute("""
            INSERT INTO departament(user_id, department_name, role, warnings, join_date)
            VALUES (?, ?, ?, 0, ?)
        """, (user_id_str, new_dep, 5, datetime.now().strftime("%Y-%m-%d %H:%M:%S")))

    messages.append(
        f"‚úÖ {display_name} —Å—Ç–∞–ª <b>–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª–µ–º</b> –æ—Ç–¥–µ–ª–∞ <b>{html.escape(new_dep)}</b>."
    )

    conn.commit()
    conn.close()

    for msg in messages:
        await update.message.reply_text(msg, parse_mode=ParseMode.HTML)

async def departament(update: Update, context: ContextTypes.DEFAULT_TYPE):
    args = context.args
    if not args:
        departments_list = "\n".join(f"‚Ä¢ *{num}* ‚Äî {name}" for num, name in DEPARTMENTS.items())
        text = (
            "‚ùó *–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:* /dep {–Ω–æ–º–µ—Ä –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–∞}\n\n"
            f"{departments_list}"
        )
        await update.message.reply_markdown(text)
        return

    try:
        dep_num = int(args[0])
    except ValueError:
        await update.message.reply_text("‚ö†Ô∏è –ù–æ–º–µ—Ä –æ—Ç–¥–µ–ª–∞ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º.")
        return

    dep_name = DEPARTMENTS.get(dep_num)
    if not dep_name:
        await update.message.reply_text("‚ö†Ô∏è –û—Ç–¥–µ–ª —Å —Ç–∞–∫–∏–º –Ω–æ–º–µ—Ä–æ–º –Ω–µ –Ω–∞–π–¥–µ–Ω.")
        return

    conn = get_db_connection()
    cursor = conn.cursor()

    # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –æ—Ç–¥–µ–ª–∞
    cursor.execute("SELECT * FROM departament WHERE department_name = ?", (dep_name,))
    members = cursor.fetchall()
    count = len(members)

    # –ü–æ–ª—É—á–∞–µ–º –æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç–∏
    duties = DEPARTMENT_DUTIES.get(dep_name, "–û–±—è–∑–∞–Ω–Ω–æ—Å—Ç–∏ –Ω–µ —É–∫–∞–∑–∞–Ω—ã.")

    # –ü–æ–ª—É—á–∞–µ–º —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ (—Ä–æ–ª—å 4 –∏–ª–∏ 5)
    cursor.execute(
        "SELECT user_id, role FROM departament WHERE department_name = ? AND role IN (4,5)",
        (dep_name,)
    )
    leaders = cursor.fetchall()

    leadership_lines = []
    for leader in leaders:
        user_id = leader["user_id"]
        role = leader["role"]
        role_name = ROLE_NAMES.get(role, "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è —Ä–æ–ª—å")

        # –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å username –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã users
        cursor.execute("SELECT username FROM users WHERE user_id = ?", (user_id,))
        user = cursor.fetchone()
        username = user["username"] if user and user["username"] else None

        if username:
            link = f"[{role_name}](https://t.me/{username})"
        else:
            link = f"[{role_name}](tg://user?id={user_id})"

        leadership_lines.append(f"> {link}")

    leadership_text = "\n".join(leadership_lines) if leadership_lines else "> –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–æ."

    text = (
        f"üè¢ *–û—Ç–¥–µ–ª:* {dep_name}\n"
        f"üë• *–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤:* {count}\n"
        f"üìã *–û–±—è–∑–∞–Ω–Ω–æ—Å—Ç–∏ –æ—Ç–¥–µ–ª–∞:*\n{duties}\n\n"
        f"üëî *–†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –æ—Ç–¥–µ–ª–∞:*\n{leadership_text}"
    )

    await update.message.reply_markdown(text, disable_web_page_preview=True)
    conn.close()

async def depinv(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_inviter_id = str(update.effective_user.id)
    inviter = update.effective_user

    conn = get_db_connection()
    cursor = conn.cursor()

    cursor.execute("SELECT department_name, role FROM departament WHERE user_id = ?", (user_inviter_id,))
    inviter_row = cursor.fetchone()
    if not inviter_row:
        conn.close()
        await update.message.reply_text("üö´ –í—ã –Ω–µ —Å–æ—Å—Ç–æ–∏—Ç–µ –Ω–∏ –≤ –æ–¥–Ω–æ–º –æ—Ç–¥–µ–ª–µ –∏ –Ω–µ –º–æ–∂–µ—Ç–µ –ø—Ä–∏–≥–ª–∞—à–∞—Ç—å.")
        return

    inviter_dep, inviter_role = inviter_row
    if inviter_role not in (4, 5):
        conn.close()
        await update.message.reply_text("üö´ –¢–æ–ª—å–∫–æ —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å –æ—Ç–¥–µ–ª–∞ –∏–ª–∏ –∑–∞–º–µ—Å—Ç–∏—Ç–µ–ª—å –º–æ–∂–µ—Ç –ø—Ä–∏–≥–ª–∞—à–∞—Ç—å –≤ –æ—Ç–¥–µ–ª.")
        return

    # –ü–æ–ª—É—á–∞–µ–º user_id –∏ –æ–±—ä–µ–∫—Ç User –ø—Ä–∏–≥–ª–∞—à–∞–µ–º–æ–≥–æ
    invited_user_obj = None
    if update.message.reply_to_message:
        invited_user_obj = update.message.reply_to_message.from_user
        invited_user_id = invited_user_obj.id
    elif context.args:
        try:
            invited_user_id = int(context.args[0])
        except ValueError:
            conn.close()
            await update.message.reply_text(
                "‚ùó –£–∫–∞–∂–∏—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π Telegram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ –æ—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ –µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–µ.")
            return
    else:
        conn.close()
        await update.message.reply_text("‚ùó –£–∫–∞–∂–∏—Ç–µ Telegram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ –æ—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ –µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–µ.")
        return

    invited_user_id_str = str(invited_user_id)

    cursor.execute("SELECT * FROM departament WHERE user_id = ?", (invited_user_id_str,))
    if cursor.fetchone():
        conn.close()
        await update.message.reply_text(
            "‚ö†Ô∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Å–æ—Å—Ç–æ–∏—Ç –≤ –æ—Ç–¥–µ–ª–µ.",
            parse_mode=ParseMode.HTML
        )
        return

    join_date = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    cursor.execute(
        "INSERT INTO departament (user_id, department_name, role, warnings, join_date) VALUES (?, ?, ?, 0, ?)",
        (invited_user_id_str, inviter_dep, 1, join_date)
    )
    conn.commit()
    conn.close()

    # –§–æ—Ä–º–∏—Ä—É–µ–º —É–ø–æ–º–∏–Ω–∞–Ω–∏—è
    if invited_user_obj:
        invited_mention = get_display_name_html_new(invited_user_obj)
    else:
        invited_mention = get_display_name_html_by_id(invited_user_id)

    inviter_mention = get_display_name_html_new(inviter)

    await update.message.reply_text(
        f"‚úÖ {invited_mention} —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–≥–ª–∞—à—ë–Ω –≤ –æ—Ç–¥–µ–ª!\n\n"
        f"üè¢ –û—Ç–¥–µ–ª: <b>{html.escape(inviter_dep)}</b>\n"
        f"üíº –†–æ–ª—å: <b>{html.escape(ROLE_NAMES[1])}</b>\n"
        f"üôã‚Äç‚ôÇÔ∏è –ü—Ä–∏–≥–ª–∞—Å–∏–ª: {inviter_mention}",
        parse_mode=ParseMode.HTML
    )

async def depuninv(update: Update, context: ContextTypes.DEFAULT_TYPE):
    args = context.args
    inviter = update.effective_user

    if not args and not update.message.reply_to_message:
        await update.message.reply_text(
            "‚ùó –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /depuninv {telegramID –∏–ª–∏ –æ—Ç–≤–µ—Ç–æ–º} {–ø—Ä–∏—á–∏–Ω–∞}",
            parse_mode=ParseMode.HTML
        )
        return

    # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏—Å–∫–ª—é—á–∞–µ–º–æ–≥–æ
    invited_user_obj = None
    if update.message.reply_to_message:
        invited_user_obj = update.message.reply_to_message.from_user
        user_id = invited_user_obj.id
        reason = " ".join(args) if args else "–ü—Ä–∏—á–∏–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞"
    else:
        try:
            user_id = int(args[0])
            reason = " ".join(args[1:]) if len(args) > 1 else "–ü—Ä–∏—á–∏–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞"
        except ValueError:
            await update.message.reply_text("‚ùó –ù–µ–≤–µ—Ä–Ω—ã–π Telegram ID.")
            return

    user_id_str = str(user_id)

    conn = get_db_connection()
    cursor = conn.cursor()

    cursor.execute("SELECT * FROM departament WHERE user_id = ?", (user_id_str,))
    if not cursor.fetchone():
        conn.close()
        await update.message.reply_text("‚ö†Ô∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —Å–æ—Å—Ç–æ–∏—Ç –≤ –æ—Ç–¥–µ–ª–µ.")
        return

    cursor.execute("DELETE FROM departament WHERE user_id = ?", (user_id_str,))
    cursor.execute("DELETE FROM department_warns WHERE user_id = ?", (user_id_str,))
    conn.commit()
    conn.close()

    # –§–æ—Ä–º–∏—Ä—É–µ–º —É–ø–æ–º–∏–Ω–∞–Ω–∏—è
    if invited_user_obj:
        user_mention = get_display_name_html_new(invited_user_obj)
    else:
        user_mention = get_display_name_html_by_id(user_id)

    inviter_mention = get_display_name_html_new(inviter)

    await update.message.reply_text(
        f"‚úÖ {user_mention} –∏—Å–∫–ª—é—á—ë–Ω –∏–∑ –æ—Ç–¥–µ–ª–∞.\n\n"
        f"üë§ –ò—Å–∫–ª—é—á–∏–ª: {inviter_mention}\n"
        f"üìù –ü—Ä–∏—á–∏–Ω–∞: {html.escape(reason)}",
        parse_mode=ParseMode.HTML
    )

async def depwarn(update: Update, context: ContextTypes.DEFAULT_TYPE):
    args = context.args
    issuer = update.effective_user
    issuer_id_str = str(issuer.id)

    if not args and not update.message.reply_to_message:
        await update.message.reply_text(
            "‚ùó –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /depwarn {telegramID –∏–ª–∏ –æ—Ç–≤–µ—Ç–æ–º} {–ø—Ä–∏—á–∏–Ω–∞}",
            parse_mode=ParseMode.HTML
        )
        return

    conn = get_db_connection()
    cursor = conn.cursor()

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–æ–ª—å –≤—ã–¥–∞—é—â–µ–≥–æ
    cursor.execute("SELECT department_name, role FROM departament WHERE user_id = ?", (issuer_id_str,))
    issuer_row = cursor.fetchone()
    if not issuer_row:
        conn.close()
        await update.message.reply_text("üö´ –í—ã –Ω–µ —Å–æ—Å—Ç–æ–∏—Ç–µ –Ω–∏ –≤ –æ–¥–Ω–æ–º –æ—Ç–¥–µ–ª–µ.")
        return

    issuer_dep, issuer_role = issuer_row["department_name"], issuer_row["role"]

    if issuer_role not in (4, 5):
        conn.close()
        await update.message.reply_text("üö´ –¢–æ–ª—å–∫–æ —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å –æ—Ç–¥–µ–ª–∞ –∏–ª–∏ –∑–∞–º–µ—Å—Ç–∏—Ç–µ–ª—å –º–æ–∂–µ—Ç –≤—ã–¥–∞–≤–∞—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è.")
        return

    # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞—Ä—É—à–∏—Ç–µ–ª—è
    target_user_obj = None
    if update.message.reply_to_message:
        target_user_obj = update.message.reply_to_message.from_user
        user_id = target_user_obj.id
        reason = " ".join(args) if args else "–ü—Ä–∏—á–∏–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞"
    else:
        try:
            user_id = int(args[0])
            reason = " ".join(args[1:]) if len(args) > 1 else "–ü—Ä–∏—á–∏–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞"
        except ValueError:
            conn.close()
            await update.message.reply_text("‚ùó –ù–µ–≤–µ—Ä–Ω—ã–π Telegram ID.")
            return

    user_id_str = str(user_id)

    # –ù–µ–ª—å–∑—è –≤–∞—Ä–Ω–∏—Ç—å —Å–∞–º–æ–≥–æ —Å–µ–±—è
    if user_id_str == issuer_id_str:
        conn.close()
        await update.message.reply_text("üö´ –í—ã –Ω–µ –º–æ–∂–µ—Ç–µ –≤—ã–¥–∞—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ —Å–∞–º–æ–º—É —Å–µ–±–µ.")
        return

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞—Ä—É—à–∏—Ç–µ–ª—è
    cursor.execute("SELECT department_name, role, warnings FROM departament WHERE user_id = ?", (user_id_str,))
    target_row = cursor.fetchone()
    if not target_row:
        conn.close()
        await update.message.reply_text("‚ö†Ô∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —Å–æ—Å—Ç–æ–∏—Ç –≤ –æ—Ç–¥–µ–ª–µ.")
        return

    target_dep, target_role = target_row["department_name"], target_row["role"]

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ–±–∞ –≤ –æ–¥–Ω–æ–º –æ—Ç–¥–µ–ª–µ
    if target_dep != issuer_dep:
        conn.close()
        await update.message.reply_text("üö´ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —Å–æ—Å—Ç–æ–∏—Ç –≤ –≤–∞—à–µ–º –æ—Ç–¥–µ–ª–µ.")
        return

    # –ó–∞–º –Ω–µ –º–æ–∂–µ—Ç –≤–∞—Ä–Ω–∏—Ç—å —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—è
    if issuer_role == 4 and target_role >= issuer_role:
        conn.close()
        await update.message.reply_text("üö´ –í—ã –Ω–µ –º–æ–∂–µ—Ç–µ –≤—ã–¥–∞—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å —Ä–∞–≤–Ω–æ–π –∏–ª–∏ –≤—ã—Å—à–µ–π —Ä–æ–ª—å—é.")
        return

    current_warnings = target_row["warnings"] + 1
    now = datetime.now().strftime("%d.%m.%Y / %H:%M")

    cursor.execute("""
        INSERT INTO department_warns (user_id, issuer_id, issuer_role, reason, timestamp)
        VALUES (?, ?, ?, ?, ?)
    """, (user_id_str, issuer_id_str, str(issuer_role), reason, now))

    # –§–æ—Ä–º–∏—Ä—É–µ–º —É–ø–æ–º–∏–Ω–∞–Ω–∏—è
    if target_user_obj:
        target_mention = get_display_name_html_new(target_user_obj)
    else:
        target_mention = get_display_name_html_by_id(user_id)

    issuer_mention = get_display_name_html_new(issuer)

    if current_warnings >= 3:
        cursor.execute("DELETE FROM departament WHERE user_id = ?", (user_id_str,))
        cursor.execute("DELETE FROM department_warns WHERE user_id = ?", (user_id_str,))
        conn.commit()
        conn.close()

        await update.message.reply_text(
            f"‚ùå <b>–ò—Å–∫–ª—é—á–µ–Ω–∏–µ –∏–∑ –æ—Ç–¥–µ–ª–∞</b>\n"
            f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
            f"üë§ –°–æ—Ç—Ä—É–¥–Ω–∏–∫: {target_mention}\n"
            f"üè¢ –û—Ç–¥–µ–ª: <b>{html.escape(target_dep)}</b>\n"
            f"‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π: <b>3/3</b>\n"
            f"üì§ –°—Ç–∞—Ç—É—Å: <b>–ò—Å–∫–ª—é—á—ë–Ω –∏–∑ –æ—Ç–¥–µ–ª–∞</b>\n"
            f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
            f"üìù –ü—Ä–∏—á–∏–Ω–∞: <i>{html.escape(reason)}</i>\n"
            f"üëÆ –í—ã–¥–∞–ª: {issuer_mention}",
            parse_mode=ParseMode.HTML
        )
    else:
        cursor.execute("UPDATE departament SET warnings = ? WHERE user_id = ?", (current_warnings, user_id_str))
        conn.commit()
        conn.close()

        warn_bar = "üî¥" * current_warnings + "‚ö™Ô∏è" * (3 - current_warnings)

        await update.message.reply_text(
            f"‚ö†Ô∏è <b>–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –≤—ã–¥–∞–Ω–æ</b>\n"
            f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
            f"üë§ –°–æ—Ç—Ä—É–¥–Ω–∏–∫: {target_mention}\n"
            f"üè¢ –û—Ç–¥–µ–ª: <b>{html.escape(target_dep)}</b>\n"
            f"üî¢ –í–∞—Ä–Ω—ã: {warn_bar} <b>{current_warnings}/3</b>\n"
            f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
            f"üìù –ü—Ä–∏—á–∏–Ω–∞: <i>{html.escape(reason)}</i>\n"
            f"üëÆ –í—ã–¥–∞–ª: {issuer_mention}",
            parse_mode=ParseMode.HTML
        )
async def depunwarn(update: Update, context: ContextTypes.DEFAULT_TYPE):
    args = context.args
    issuer = update.effective_user
    issuer_id_str = str(issuer.id)

    if not args and not update.message.reply_to_message:
        await update.message.reply_text(
            "‚ùó –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /depunwarn {telegramID –∏–ª–∏ –æ—Ç–≤–µ—Ç–æ–º} {–ø—Ä–∏—á–∏–Ω–∞}",
            parse_mode=ParseMode.HTML
        )
        return

    conn = get_db_connection()
    cursor = conn.cursor()

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–æ–ª—å –≤—ã–¥–∞—é—â–µ–≥–æ
    cursor.execute("SELECT department_name, role FROM departament WHERE user_id = ?", (issuer_id_str,))
    issuer_row = cursor.fetchone()
    if not issuer_row:
        conn.close()
        await update.message.reply_text("üö´ –í—ã –Ω–µ —Å–æ—Å—Ç–æ–∏—Ç–µ –Ω–∏ –≤ –æ–¥–Ω–æ–º –æ—Ç–¥–µ–ª–µ.")
        return

    issuer_dep, issuer_role = issuer_row["department_name"], issuer_row["role"]

    if issuer_role not in (4, 5):
        conn.close()
        await update.message.reply_text("üö´ –¢–æ–ª—å–∫–æ —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å –æ—Ç–¥–µ–ª–∞ –∏–ª–∏ –∑–∞–º–µ—Å—Ç–∏—Ç–µ–ª—å –º–æ–∂–µ—Ç —Å–Ω–∏–º–∞—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è.")
        return

    # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ü–µ–ª–µ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    target_user_obj = None
    if update.message.reply_to_message:
        target_user_obj = update.message.reply_to_message.from_user
        user_id = target_user_obj.id
        reason = " ".join(args) if args else "–ü—Ä–∏—á–∏–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞"
    else:
        try:
            user_id = int(args[0])
            reason = " ".join(args[1:]) if len(args) > 1 else "–ü—Ä–∏—á–∏–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞"
        except ValueError:
            conn.close()
            await update.message.reply_text("‚ùó –ù–µ–≤–µ—Ä–Ω—ã–π Telegram ID.")
            return

    user_id_str = str(user_id)

    cursor.execute("SELECT department_name, warnings FROM departament WHERE user_id = ?", (user_id_str,))
    target_row = cursor.fetchone()
    if not target_row:
        conn.close()
        await update.message.reply_text("‚ö†Ô∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —Å–æ—Å—Ç–æ–∏—Ç –≤ –æ—Ç–¥–µ–ª–µ.")
        return

    target_dep = target_row["department_name"]

    if target_dep != issuer_dep:
        conn.close()
        await update.message.reply_text("üö´ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —Å–æ—Å—Ç–æ–∏—Ç –≤ –≤–∞—à–µ–º –æ—Ç–¥–µ–ª–µ.")
        return

    warnings = int(target_row["warnings"]) if target_row["warnings"] else 0

    if warnings == 0:
        conn.close()
        await update.message.reply_text("‚ÑπÔ∏è –£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π –¥–ª—è —Å–Ω—è—Ç–∏—è.")
        return

    warnings -= 1
    cursor.execute("UPDATE departament SET warnings = ? WHERE user_id = ?", (warnings, user_id_str))

    cursor.execute("""
        DELETE FROM department_warns
        WHERE id = (
            SELECT id FROM department_warns
            WHERE user_id = ?
            ORDER BY id DESC
            LIMIT 1
        )
    """, (user_id_str,))

    conn.commit()
    conn.close()

    # –§–æ—Ä–º–∏—Ä—É–µ–º —É–ø–æ–º–∏–Ω–∞–Ω–∏—è
    if target_user_obj:
        target_mention = get_display_name_html_new(target_user_obj)
    else:
        target_mention = get_display_name_html_by_id(user_id)

    issuer_mention = get_display_name_html_new(issuer)
    warn_bar = "üî¥" * warnings + "‚ö™Ô∏è" * (3 - warnings)

    await update.message.reply_text(
        f"‚úÖ <b>–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ —Å–Ω—è—Ç–æ</b>\n"
        f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
        f"üë§ –°–æ—Ç—Ä—É–¥–Ω–∏–∫: {target_mention}\n"
        f"üè¢ –û—Ç–¥–µ–ª: <b>{html.escape(target_dep)}</b>\n"
        f"üî¢ –í–∞—Ä–Ω—ã: {warn_bar} <b>{warnings}/3</b>\n"
        f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
        f"üìù –ü—Ä–∏—á–∏–Ω–∞: <i>{html.escape(reason)}</i>\n"
        f"üëÆ –°–Ω—è–ª: {issuer_mention}",
        parse_mode=ParseMode.HTML
    )

async def depwarns(update: Update, context: ContextTypes.DEFAULT_TYPE):
    args = context.args
    issuer = update.effective_user

    if not args and not update.message.reply_to_message:
        await update.message.reply_text(
            "‚ùó –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /depwarns {TelegramID –∏–ª–∏ –æ—Ç–≤–µ—Ç–æ–º}",
            parse_mode=ParseMode.HTML
        )
        return

    conn = get_db_connection()
    cursor = conn.cursor()

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–æ–ª—å –∑–∞–ø—Ä–∞—à–∏–≤–∞—é—â–µ–≥–æ
    cursor.execute("SELECT department_name, role FROM departament WHERE user_id = ?", (str(issuer.id),))
    issuer_row = cursor.fetchone()
    if not issuer_row:
        conn.close()
        await update.message.reply_text("üö´ –í—ã –Ω–µ —Å–æ—Å—Ç–æ–∏—Ç–µ –Ω–∏ –≤ –æ–¥–Ω–æ–º –æ—Ç–¥–µ–ª–µ.")
        return

    issuer_dep, issuer_role = issuer_row["department_name"], issuer_row["role"]

    # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ü–µ–ª–µ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    target_user_obj = None
    if update.message.reply_to_message:
        target_user_obj = update.message.reply_to_message.from_user
        user_id = target_user_obj.id
    else:
        try:
            user_id = int(args[0])
        except ValueError:
            conn.close()
            await update.message.reply_text("‚ùó –ù–µ–≤–µ—Ä–Ω—ã–π Telegram ID.")
            return

    user_id_str = str(user_id)

    cursor.execute("SELECT * FROM departament WHERE user_id = ?", (user_id_str,))
    target_row = cursor.fetchone()
    if not target_row:
        conn.close()
        await update.message.reply_text("‚ö†Ô∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —Å–æ—Å—Ç–æ–∏—Ç –≤ –æ—Ç–¥–µ–ª–µ.")
        return

    target_dep = target_row["department_name"]
    role_id = target_row["role"]
    role_name = html.escape(ROLE_NAMES.get(role_id, "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è —Ä–æ–ª—å"))
    warnings = int(target_row["warnings"]) if target_row["warnings"] else 0

    if target_dep != issuer_dep:
        conn.close()
        await update.message.reply_text("üö´ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —Å–æ—Å—Ç–æ–∏—Ç –≤ –≤–∞—à–µ–º –æ—Ç–¥–µ–ª–µ.")
        return

    cursor.execute("""
        SELECT * FROM department_warns WHERE user_id = ? ORDER BY id DESC
    """, (user_id_str,))
    warn_logs = cursor.fetchall()
    conn.close()

    # –§–æ—Ä–º–∏—Ä—É–µ–º —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ
    if target_user_obj:
        target_mention = get_display_name_html_new(target_user_obj)
    else:
        target_mention = get_display_name_html_by_id(user_id)

    warn_bar = "üî¥" * warnings + "‚ö™Ô∏è" * (3 - warnings)

    lines = [
        f"üìã <b>–û—Ç–¥–µ–ª | –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è</b>",
        f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ",
        f"üë§ –°–æ—Ç—Ä—É–¥–Ω–∏–∫: {target_mention}",
        f"üè¢ –û—Ç–¥–µ–ª: <b>{html.escape(target_dep)}</b>",
        f"üíº –†–æ–ª—å: <b>{role_name}</b>",
        f"üî¢ –í–∞—Ä–Ω—ã: {warn_bar} <b>{warnings}/3</b>",
        f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ",
    ]

    if not warn_logs:
        lines.append("‚úÖ –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π –Ω–µ—Ç.")
    else:
        lines.append(f"‚ö†Ô∏è <b>–ò—Å—Ç–æ—Ä–∏—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π:</b>")
        for idx, warn in enumerate(warn_logs, 1):
            issuer_role_name = html.escape(ROLE_NAMES.get(int(warn["issuer_role"]), warn["issuer_role"]))
            issuer_link = get_display_name_html_by_id(warn["issuer_id"])
            lines.append(
                f"\n<b>{idx}.</b> {html.escape(warn['timestamp'])}\n"
                f"   üëÆ –í—ã–¥–∞–ª: {issuer_link} (<i>{issuer_role_name}</i>)\n"
                f"   üìù –ü—Ä–∏—á–∏–Ω–∞: <i>{html.escape(warn['reason'])}</i>"
            )

    await update.message.reply_text("\n".join(lines), parse_mode=ParseMode.HTML)


async def apan(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = str(update.effective_user.id)

    conn = sqlite3.connect(DB_PATH)
    conn.row_factory = sqlite3.Row
    cursor = conn.cursor()

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    cursor.execute("SELECT * FROM users WHERE user_id = ?", (user_id,))
    user_row = cursor.fetchone()

    if not user_row:
        await update.message.reply_text("‚ùó –í—ã –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.")
        conn.close()
        return

    status_index = user_row["status"]

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø
    if status_index < 2:
        await update.message.reply_text("üö´ –î–æ—Å—Ç—É–ø —Ä–∞–∑—Ä–µ—à—ë–Ω —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏.")
        conn.close()
        return

    # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–µ
    cursor.execute("SELECT points, warnings FROM admins WHERE user_id = ?", (user_id,))
    admin_row = cursor.fetchone()

    points = admin_row["points"] if admin_row else 0
    warnings = admin_row["warnings"] if admin_row else 0

    display_name = get_display_name_html_new(update.effective_user)
    telegram_id = user_id
    role_name = STATUS_LIST[status_index] if 0 <= status_index < len(STATUS_LIST) else f"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ ({status_index})"

    message = (
        "üõ† <b>Admins Inform</b>\n\n"
        f"üí† {display_name}\n"
        f"üÜî Telegram ID: <code>{telegram_id}</code>\n"
        f"üéñ –†–æ–ª—å: <b>{role_name}</b>\n"
        f"‚ö†Ô∏è Warns: <b>{warnings}/3</b>\n"
        f"‚≠ê AC: <b>{points}</b>\n"
    )

    # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏
    buttons = [
        [InlineKeyboardButton("üõí –ú–∞–≥–∞–∑–∏–Ω", callback_data=f"admin_store|{user_id}")],
        [InlineKeyboardButton("‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª", callback_data=f"admin_functions|{user_id}")]
    ]

    await update.message.reply_text(
        message,
        parse_mode="HTML",
        reply_markup=InlineKeyboardMarkup(buttons)
    )

    conn.close()


async def admin_store_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    user_id = str(query.from_user.id)

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ callback_data —Å–æ–¥–µ—Ä–∂–∏—Ç user_id
    # –§–æ—Ä–º–∞—Ç –æ–∂–∏–¥–∞–µ—Ç—Å—è, –Ω–∞–ø—Ä–∏–º–µ—Ä: "admin_store|123456"
    data_parts = query.data.split("|")
    if len(data_parts) != 2 or data_parts[1] != user_id:
        await query.answer("üö´ –≠—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –¥–ª—è –≤–∞—Å.", show_alert=True)
        return

    conn = sqlite3.connect(DB_PATH)
    conn.row_factory = sqlite3.Row
    cursor = conn.cursor()

    cursor.execute("SELECT * FROM users WHERE user_id = ?", (user_id,))
    user_row = cursor.fetchone()

    if not user_row:
        await query.answer("‚ùó –í—ã –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã.")
        conn.close()
        return

    status_index = user_row["status"]
    if status_index < 1:
        await query.answer("üö´ –¢–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏.")
        conn.close()
        return

    cursor.execute("SELECT points, warnings FROM admins WHERE user_id = ?", (user_id,))
    admin_row = cursor.fetchone()
    conn.close()

    points = admin_row["points"] if admin_row else 0
    warnings = admin_row["warnings"] if admin_row else 0
    role_name = STATUS_LIST[status_index] if 0 <= status_index < len(STATUS_LIST) else f"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ ({status_index})"

    promotion_prices = {
        1: 100,
        2: 150,
        3: 200,
        4: 250,
        5: 500,
        6: 700,
        7: 850
    }

    next_level_price = promotion_prices.get(status_index)

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –≤–∞—Ä–Ω–æ–≤ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –ø–æ–≤—ã—à–µ–Ω–∏—è
    if next_level_price and warnings == 0:
        promotion_button = InlineKeyboardButton(
            f"‚è´ –ü–æ–≤—ã—à–µ–Ω–∏–µ +1 ({next_level_price} AC)",
            callback_data=f"admin_promotion|{user_id}"
        )
    elif next_level_price and warnings > 0:
        promotion_button = InlineKeyboardButton(
            "‚ùå –°–Ω–∏–º–∏—Ç–µ –≤–∞—Ä–Ω—ã –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è",
            callback_data="noop"
        )
    else:
        promotion_button = InlineKeyboardButton(
            "‚ùå –ü–æ–≤—ã—à–µ–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ",
            callback_data="noop"
        )

    buttons = [
        [InlineKeyboardButton("‚ö† –°–Ω—è—Ç—å Warn (-100 AC)", callback_data=f"remove_warn|{user_id}")],
        [promotion_button],
        [InlineKeyboardButton("üí∞ –ù–∞ –ë–æ—Ç-–≤–∞–ª—é—Ç—É", callback_data=f"to_bot_currency|{user_id}")],
        [InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data=f"admin_back|{user_id}")]
    ]

    message = (
        f"<b>üõí –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–π –º–∞–≥–∞–∑–∏–Ω</b>\n\n"
        f"üéñ –°—Ç–∞—Ç—É—Å: <b>{role_name}</b>\n"
        f"‚≠ê AC: <b>{points}</b>\n"
        f"‚ö†Ô∏è Warns: <b>{warnings}</b>/3\n"
    )

    await query.edit_message_text(
        message,
        reply_markup=InlineKeyboardMarkup(buttons),
        parse_mode="HTML"
    )

async def admin_promotion_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    user_id = str(query.from_user.id)

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º user_id –≤ callback_data
    data_parts = query.data.split("|")
    if len(data_parts) != 2 or data_parts[1] != user_id:
        await query.answer("üö´ –≠—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –¥–ª—è –≤–∞—Å.", show_alert=True)
        return

    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    cursor.execute("SELECT status FROM users WHERE user_id = ?", (user_id,))
    user_row = cursor.fetchone()
    if not user_row:
        await query.answer("‚ùó –í—ã –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã.")
        conn.close()
        return

    current_status = user_row[0]

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–≥–æ –≤–∞—Ä–Ω–∞
    cursor.execute("SELECT warns FROM users WHERE user_id = ?", (user_id,))
    warns_row = cursor.fetchone()
    warns = warns_row[0] if warns_row else 0

    if warns >= 1:
        await query.answer("‚ö†Ô∏è –ü–æ–≤—ã—à–µ–Ω–∏–µ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ: —É –≤–∞—Å –µ—Å—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è.", show_alert=True)
        conn.close()
        return

    # –¶–µ–Ω—ã –Ω–∞ –ø–æ–≤—ã—à–µ–Ω–∏–µ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º
    promotion_prices = {
        1: 100,
        2: 150,
        3: 200,
        4: 250,
        5: 500,
        6: 700,
        7: 850
    }

    price = promotion_prices.get(current_status)
    if price is None:
        await query.answer("‚ùå –ü–æ–≤—ã—à–µ–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ.")
        conn.close()
        return

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–∞–ª–ª–æ–≤ –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è
    cursor.execute("SELECT points FROM admins WHERE user_id = ?", (user_id,))
    admin_row = cursor.fetchone()
    if not admin_row or admin_row[0] < price:
        await query.answer("‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ AC –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è.")
        conn.close()
        return

    # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∏ —Å–ø–∏—Å—ã–≤–∞–µ–º –æ—á–∫–∏
    new_status = current_status + 1
    cursor.execute("UPDATE users SET status = ? WHERE user_id = ?", (new_status, user_id))
    cursor.execute("UPDATE admins SET points = points - ? WHERE user_id = ?", (price, user_id))
    conn.commit()
    conn.close()

    await query.answer("‚úÖ –ü–æ–≤—ã—à–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ!", show_alert=True)

    # –û–±–Ω–æ–≤–ª—è–µ–º –º–µ–Ω—é
    await admin_store_callback(update, context)


EXCHANGE_RATES = {
    "convert_game_currency": {
        "label": "ü™ô –ò–≥—Ä–æ–≤–∞—è –≤–∞–ª—é—Ç–∞",
        "field": "balance",
        "name": "–ò–≥—Ä–æ–≤–∞—è –≤–∞–ª—é—Ç–∞"
    },
    "convert_seeds": {
        "label": "üå± –°–µ–º–µ–Ω–∞",
        "field": "seeds",
        "name": "–°–µ–º–µ–Ω–∞"
    },
    "convert_digital": {
        "label": "üíª Digital Coins",
        "field": "dc_balance",
        "name": "Digital Coins"
    }
}

WAITING_AMOUNT = {}


async def to_bot_currency_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    data = query.data  # –Ω–∞–ø—Ä–∏–º–µ—Ä: "to_bot_currency|123456789"
    parts = data.split("|")
    if len(parts) != 2:
        await query.answer("‚ùó –ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.")
        return

    action, user_id_in_data = parts
    user_id = str(query.from_user.id)

    if user_id != user_id_in_data:
        await query.answer("üö´ –≠—Ç–∞ –∫–Ω–æ–ø–∫–∞ –Ω–µ –¥–ª—è –≤–∞—Å.", show_alert=True)
        return

    conn = sqlite3.connect(DB_PATH)
    conn.row_factory = sqlite3.Row
    cursor = conn.cursor()

    cursor.execute("SELECT * FROM users WHERE user_id = ?", (user_id,))
    user_row = cursor.fetchone()

    cursor.execute("SELECT points, warnings FROM admins WHERE user_id = ?", (user_id,))
    admin_row = cursor.fetchone()
    conn.close()

    if not user_row or not admin_row:
        await query.answer("‚ùó –í—ã –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã.")
        return

    status_index = user_row["status"]
    if status_index < 1:
        await query.answer("üö´ –¢–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏.")
        return

    points = admin_row["points"]
    warnings = admin_row["warnings"]
    role_name = STATUS_LIST[status_index] if 0 <= status_index < len(STATUS_LIST) else f"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ ({status_index})"

    message = (
        f"<b>üõí –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–π –º–∞–≥–∞–∑–∏–Ω</b>\n\n"
        f"üéñ –°—Ç–∞—Ç—É—Å: <b>{role_name}</b>\n"
        f"‚≠ê AC: <b>{points}</b>\n"
        f"‚ö†Ô∏è Warns: <b>{warnings}</b>/3\n"
    )

    buttons = [
        [InlineKeyboardButton(data["label"], callback_data=f"{key}|{user_id}")] for key, data in EXCHANGE_RATES.items()
    ]
    buttons.append([InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data=f"admin_store|{user_id}")])

    await query.edit_message_text(
        message,
        reply_markup=InlineKeyboardMarkup(buttons),
        parse_mode="HTML"
    )


async def conversion_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    data = query.data  # –ù–∞–ø—Ä–∏–º–µ—Ä: "convert_game_currency|123456789"
    parts = data.split("|")
    if len(parts) != 2:
        await query.answer("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä.")
        return

    conversion_type, user_id_in_data = parts
    user_id = str(query.from_user.id)

    if user_id != user_id_in_data:
        await query.answer("üö´ –≠—Ç–∞ –∫–Ω–æ–ø–∫–∞ –Ω–µ –¥–ª—è –≤–∞—Å.", show_alert=True)
        return

    if conversion_type not in EXCHANGE_RATES:
        await query.answer("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä.")
        return

    WAITING_AMOUNT[user_id] = {
        "type": conversion_type,
        "task": asyncio.create_task(cancel_after_timeout(user_id, context))
    }

    await query.answer()
    await query.message.edit_text(
        f"üí± <b>–û–±–º–µ–Ω AC –Ω–∞ {EXCHANGE_RATES[conversion_type]['name']}</b>\n\n"
        f"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ AC –¥–ª—è –æ–±–º–µ–Ω–∞.\n"
        f"üí° –ö—É—Ä—Å: 1 AC = 2 {EXCHANGE_RATES[conversion_type]['name']}\n\n"
        "‚úèÔ∏è –í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ.",
        parse_mode="HTML"
    )


async def handle_amount(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user or (update.callback_query.from_user if update.callback_query else None)
    if not user:
        # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç ‚Äî –Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–∏—à–ª–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –∫–∞–Ω–∞–ª–∞ –∏–ª–∏ –±–æ—Ç–∞
        if update.message:
            await update.message.reply_text("‚ùó –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.")
        return

    user_id = str(user.id)

    if user_id not in WAITING_AMOUNT:
        # –ú–æ–∂–Ω–æ –ø—Ä–µ–¥—É–ø—Ä–µ–¥–∏—Ç—å, –µ—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –æ–±–º–µ–Ω–∞
        return

    text = update.message.text.strip()
    if not text.isdigit():
        await update.message.reply_text("‚ùó –í–≤–µ–¥–∏—Ç–µ —Ç–æ–ª—å–∫–æ —á–∏—Å–ª–æ.")
        return

    amount = int(text)
    if amount <= 0:
        await update.message.reply_text("‚ùó –ß–∏—Å–ª–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º.")
        return

    exchange_info = WAITING_AMOUNT[user_id]["type"]
    field = EXCHANGE_RATES[exchange_info]["field"]
    name = EXCHANGE_RATES[exchange_info]["name"]

    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    cursor.execute("SELECT points FROM admins WHERE user_id = ?", (user_id,))
    row = cursor.fetchone()

    if not row or row[0] < amount:
        await update.message.reply_text("‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ AC –¥–ª—è –æ–±–º–µ–Ω–∞.")
        conn.close()
        del WAITING_AMOUNT[user_id]
        return

    cursor.execute("UPDATE admins SET points = points - ? WHERE user_id = ?", (amount, user_id))
    cursor.execute(f"UPDATE users SET {field} = {field} + ? WHERE user_id = ?", (amount * 2, user_id))
    conn.commit()
    conn.close()

    await update.message.reply_text(
        f"<b>‚úÖ –û–±–º–µ–Ω –∑–∞–≤–µ—Ä—à—ë–Ω</b>\n\n"
        f"üí≥ –°–ø–∏—Å–∞–Ω–æ: <b>{amount} AC</b>\n"
        f"üí± –ü–æ–ª—É—á–µ–Ω–æ: <b>{amount * 100} {name}</b>\n",
        parse_mode="HTML"
    )

    WAITING_AMOUNT[user_id]["task"].cancel()
    del WAITING_AMOUNT[user_id]


# ‚è± –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è —á–µ—Ä–µ–∑ 5 –º–∏–Ω—É—Ç
async def cancel_after_timeout(user_id, context):
    await asyncio.sleep(300)
    if user_id in WAITING_AMOUNT:
        await context.bot.send_message(
            chat_id=int(user_id),
            text=(
                "<b>‚è≥ –í—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –∏—Å—Ç–µ–∫–ª–æ</b>\n\n"
                "üö´ –û–±–º–µ–Ω –±—ã–ª –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ <b>–æ—Ç–º–µ–Ω—ë–Ω</b>"
            ),
            parse_mode="HTML"
        )

        del WAITING_AMOUNT[user_id]


async def admin_back_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    user_id = str(query.from_user.id)

    conn = sqlite3.connect(DB_PATH)
    conn.row_factory = sqlite3.Row
    cursor = conn.cursor()

    cursor.execute("SELECT * FROM users WHERE user_id = ?", (user_id,))
    user_row = cursor.fetchone()

    if not user_row:
        await query.answer("‚ùó –í—ã –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.", show_alert=True)
        conn.close()
        return

    status_index = user_row["status"]
    if status_index < 1:
        await query.answer("üö´ –î–æ—Å—Ç—É–ø —Ä–∞–∑—Ä–µ—à—ë–Ω —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏.", show_alert=True)
        conn.close()
        return

    cursor.execute("SELECT points, warnings FROM admins WHERE user_id = ?", (user_id,))
    admin_row = cursor.fetchone()

    points = admin_row["points"] if admin_row else 0
    warnings = admin_row["warnings"] if admin_row else 0

    first_name = user_row["first_name"] or query.from_user.first_name
    telegram_id = user_id
    role_name = STATUS_LIST[status_index] if 0 <= status_index < len(STATUS_LIST) else f"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ ({status_index})"

    message = (
        "*üõ† Admins Inform*\n\n"
        f"[üë§ {first_name}](tg://user?id={telegram_id})\n"
        f"üÜî Telegram ID: `{telegram_id}`\n"
        f"üéñ –†–æ–ª—å: *{role_name}*\n"
        f"‚ö†Ô∏è Warns: *{warnings}/3*\n"
        f"‚≠ê AC: *{points}*\n"
    )

    buttons = [
        [InlineKeyboardButton("üõí –ú–∞–≥–∞–∑–∏–Ω", callback_data=f"admin_store|{user_id}")],
        [InlineKeyboardButton("‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª", callback_data=f"admin_functions|{user_id}")]
    ]

    await query.answer()
    await query.edit_message_text(
        message,
        parse_mode="Markdown",
        reply_markup=InlineKeyboardMarkup(buttons)
    )
    conn.close()


async def remove_warn_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    data = query.data  # –±—É–¥–µ—Ç "remove_warn|123456789"
    action, user_id_in_data = data.split("|", 1)
    user_id = str(query.from_user.id)

    if user_id != user_id_in_data:
        await query.answer("üö´ –≠—Ç–∞ –∫–Ω–æ–ø–∫–∞ –Ω–µ –¥–ª—è –≤–∞—Å.", show_alert=True)
        return

    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    cursor.execute("SELECT warnings, points FROM admins WHERE user_id = ?", (user_id,))
    row = cursor.fetchone()

    if not row:
        await query.answer("‚ùó –í—ã –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã.", show_alert=True)
        return

    warnings, points = row
    if warnings <= 0:
        await query.answer("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π.", show_alert=True)
        return
    if points < 100:
        await query.answer("‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ AC.", show_alert=True)
        return

    cursor.execute("""
        UPDATE admins SET warnings = warnings - 1, points = points - 100
        WHERE user_id = ?
    """, (user_id,))
    conn.commit()
    conn.close()

    await query.answer("‚úÖ –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ —Å–Ω—è—Ç–æ!", show_alert=True)
    await query.message.delete()


def get_awarn_status_user(user_id):
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT status FROM users WHERE user_id = ?", (str(user_id),))
    res = cursor.fetchone()
    conn.close()
    if res:
        return res[0]
    return 0  # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç, —Å—Ç–∞—Ç—É—Å 0 (–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)


LOG_FILE = "FernieX_Logging.json"


async def admin_functions_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    user_id = str(query.from_user.id)
    data_parts = query.data.split("|")

    target_user_id = data_parts[-1]  # –ø–æ—Å–ª–µ–¥–Ω–∏–π —ç–ª–µ–º–µ–Ω—Ç callback_data
    if target_user_id != user_id:
        await query.answer("üö´ –≠—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –¥–ª—è –≤–∞—Å.", show_alert=True)
        return

    action = data_parts[0]

    # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()
        cursor.execute("SELECT status FROM users WHERE user_id = ?", (user_id,))
        row = cursor.fetchone()
        status = row[0] if row else 0

    # --- –ë–ª–æ–∫ –∞–¥–º–∏–Ω —Ñ—É–Ω–∫—Ü–∏–π ---
    if action == "admin_functions":
        await query.answer("‚öôÔ∏è –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–π –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª.\n–ó–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–æ–º - –Ω–∞–∫–∞–∑—É–µ–º–æ!",
                           show_alert=True)
        buttons = [
            [InlineKeyboardButton("üìù –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ", callback_data=f"log_menu|{user_id}")] if status >= 4 else [],
            [InlineKeyboardButton("‚è±Ô∏è CoolDown", callback_data=f"cooldown_menu|{user_id}")] if status >= 8 else [],
            [InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data=f"admin_back|{user_id}")]
        ]
        buttons = [btn for btn in buttons if btn]
        await query.edit_message_text(
            text="*‚ö° Admin Functions*\n–í—ã–±–µ—Ä–∏—Ç–µ –Ω—É–∂–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:",
            parse_mode="Markdown",
            reply_markup=InlineKeyboardMarkup(buttons)
        )

    elif action == "cooldown_menu":
        if status < 8:
            await query.answer("üö´ –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω. –¢–æ–ª—å–∫–æ –ö—É—Ä–∞—Ç–æ—Ä –∏ –≤—ã—à–µ.", show_alert=True)
            return
        buttons = [
            [InlineKeyboardButton("üí∞ –û–≥—Ä–∞–±–ª–µ–Ω–∏–µ", callback_data=f"cd_input|robbery|{user_id}")],
            [InlineKeyboardButton("üíª –•–∞–∫ –≤–∑–ª–æ–º", callback_data=f"cd_input|hack|{user_id}")],
            [InlineKeyboardButton("üéÅ –ü–æ–ª—É—á–µ–Ω–∏–µ –ë–æ–Ω—É—Å–∞", callback_data=f"cd_input|bonus|{user_id}")],
            [InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data=f"admin_functions|{user_id}")]
        ]
        await query.edit_message_text(
            text="*‚è±Ô∏è Admin CoolDown*\n–í—ã–±–µ—Ä–∏—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è —Å–±—Ä–æ—Å–∞ –ö–î:",
            parse_mode="Markdown",
            reply_markup=InlineKeyboardMarkup(buttons)
        )

    # --- –ù–æ–≤—ã–π –±–ª–æ–∫: –≤–≤–æ–¥ TelegramID –¥–ª—è —Å–±—Ä–æ—Å–∞ ---
    elif action.startswith("cd_input"):
        parts_action = action.split("|")
        cd_type = parts_action[1]

        context.user_data['cd_type'] = cd_type
        context.user_data['cd_waiting_since'] = time.time()
        context.user_data['cd_admin_id'] = user_id

        buttons = [[InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data=f"cancel_cd|{user_id}")]]
        await query.edit_message_text(
            text=(
                f"‚è±Ô∏è <b>–°–±—Ä–æ—Å –ö–î</b>\n\n"
                f"–§—É–Ω–∫—Ü–∏—è: <code>{cd_type}</code>\n"
                f"–í–≤–µ–¥–∏—Ç–µ TelegramID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:\n\n"
                f"<i>‚è∞ –û–∂–∏–¥–∞–Ω–∏–µ –≤–≤–æ–¥–∞: 60 —Å–µ–∫—É–Ω–¥</i>"
            ),
            parse_mode="HTML",
            reply_markup=InlineKeyboardMarkup(buttons)
        )

    elif action.startswith("cancel_cd"):
        context.user_data.pop('cd_type', None)
        await query.edit_message_text(
            text="‚ùå –í–≤–æ–¥ –æ—Ç–º–µ–Ω–µ–Ω. –í–æ–∑–≤—Ä–∞—Ç –≤ –º–µ–Ω—é —Ñ—É–Ω–∫—Ü–∏–π —Å–±—Ä–æ—Å–∞ –ö–î.",
        )
        await admin_functions_callback(update, context)

    elif action == "log_type":
        log_type = data_parts[1]
        await admin_logs_pagination_manual(update, context)

    elif action == "log_menu":
        if status < 4:
            await query.answer("üö´ –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω. –¢–æ–ª—å–∫–æ –°—Ç. –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä –∏ –≤—ã—à–µ.", show_alert=True)
            return
        buttons = [
            [InlineKeyboardButton("üîá –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º—É—Ç–∞–º–∏", callback_data=f"log_page|mutes|1|{user_id}")],
            [InlineKeyboardButton("‚õî –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–Ω–∞–º–∏", callback_data=f"log_page|bans|1|{user_id}")],
            [InlineKeyboardButton("üíµ –í—ã–¥–∞—á–∞ –¥–µ–Ω–µ–≥", callback_data=f"log_page|give_money|1|{user_id}")],
            [InlineKeyboardButton("üí∏ –ò–∑—ä—è—Ç–∏–µ –¥–µ–Ω–µ–≥", callback_data=f"log_page|take_money|1|{user_id}")],
            [InlineKeyboardButton("üè¶ –ü–µ—Ä–µ–≤–æ–¥—ã –≤ –±–∞–Ω–∫–µ", callback_data=f"log_page|bank_transfers|1|{user_id}")],
            [InlineKeyboardButton("üõ†Ô∏è –ò–∑–º–µ–Ω–µ–Ω–∏–µ —á–∞—Ç —Ä–æ–ª–∏", callback_data=f"log_page|chat_roles|1|{user_id}")],
            [InlineKeyboardButton("ü§ñ –ò–∑–º–µ–Ω–µ–Ω–∏–µ –±–æ—Ç —Ä–æ–ª–∏", callback_data=f"log_page|bot_roles|1|{user_id}")],
            [InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data=f"admin_functions|{user_id}")]
        ]
        await query.edit_message_text(
            text="*üìå Admin –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ*\n–í—ã–±–µ—Ä–∏—Ç–µ –ª–æ–≥–∏—Ä—É–µ–º—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:",
            parse_mode="Markdown",
            reply_markup=InlineKeyboardMarkup(buttons)
        )

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# –§–£–ù–ö–¶–ò–ò –î–õ–Ø –°–ë–†–û–°–ê COOLDOWN
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

async def reset_cooldown(user_id: str, cd_type: str) -> bool:
    """–°–±—Ä–æ—Å cooldown –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞"""
    user_id = str(user_id)

    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()

        try:
            if cd_type == "robbery":
                # –°–±—Ä–∞—Å—ã–≤–∞–µ–º –æ–≥—Ä–∞–±–ª–µ–Ω–∏–µ
                # –°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞—ë–º –∑–∞–ø–∏—Å—å –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
                cursor.execute(
                    "SELECT 1 FROM robbery_data WHERE user_id = ?",
                    (user_id,)
                )
                if cursor.fetchone() is None:
                    cursor.execute(
                        "INSERT INTO robbery_data (user_id, total_stolen, last_robbery) VALUES (?, 0, NULL)",
                        (user_id,)
                    )

                # –û–±–Ω—É–ª—è–µ–º last_robbery
                cursor.execute(
                    "UPDATE robbery_data SET last_robbery = NULL WHERE user_id = ?",
                    (user_id,)
                )

            elif cd_type == "hack":
                # –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ö–∞–∫ –≤–∑–ª–æ–º –≤ bonus_timers
                # –°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞—ë–º –µ—Å–ª–∏ –Ω–µ—Ç
                cursor.execute(
                    "SELECT 1 FROM bonus_timers WHERE user_id = ? AND bonus_type = 2",
                    (user_id,)
                )
                if cursor.fetchone() is None:
                    cursor.execute(
                        "INSERT INTO bonus_timers (user_id, bonus_type, last_claim) VALUES (?, 2, 0)",
                        (user_id, 2)
                    )

                # –û–±–Ω—É–ª—è–µ–º last_claim
                cursor.execute(
                    "UPDATE bonus_timers SET last_claim = 0 WHERE user_id = ? AND bonus_type = 2",
                    (user_id,)
                )

            elif cd_type == "bonus":
                # –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ –±–æ–Ω—É—Å—ã (—É–¥–∞–ª—è–µ–º –∏–ª–∏ –æ–±–Ω—É–ª—è–µ–º)
                cursor.execute(
                    "DELETE FROM bonus_timers WHERE user_id = ?",
                    (user_id,)
                )

            conn.commit()
            print(f"‚úÖ Reset {cd_type} cooldown for user {user_id}")
            return True

        except Exception as e:
            print(f"‚ùå Error resetting {cd_type} cooldown: {e}")
            return False


def reset_robbing_cooldown(user_id: str) -> bool:
    """–ü–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å cooldown –æ–≥—Ä–∞–±–ª–µ–Ω–∏—è (—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)"""
    user_id = str(user_id)

    try:
        with sqlite3.connect(DB_PATH) as conn:
            cursor = conn.cursor()

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏
            cursor.execute("SELECT 1 FROM robbery_data WHERE user_id = ?", (user_id,))
            if cursor.fetchone() is None:
                # –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å
                cursor.execute(
                    "INSERT INTO robbery_data (user_id, total_stolen, last_robbery) VALUES (?, 0, NULL)",
                    (user_id,)
                )
            else:
                # –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é
                cursor.execute(
                    "UPDATE robbery_data SET last_robbery = NULL WHERE user_id = ?",
                    (user_id,)
                )

            conn.commit()
            print(f"‚úÖ Reset robbery cooldown for user {user_id}")
            return True

    except Exception as e:
        print(f"‚ùå Error resetting cooldown: {e}")
        return False


# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# –û–ë–†–ê–ë–û–¢–ß–ò–ö –°–û–û–ë–©–ï–ù–ò–ô (–¥–ª—è –≤–≤–æ–¥–∞ ID)
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

async def cooldown_reset_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –≤–≤–æ–¥–∞ TelegramID –ø—Ä–∏ —Å–±—Ä–æ—Å–µ CD"""
    user_id = str(update.message.from_user.id)

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —ç—Ç–æ—Ç —é–∑–µ—Ä –æ–∂–∏–¥–∞–µ—Ç –≤–≤–æ–¥–∞
    if context.user_data.get('cd_admin_id') != user_id:
        return
    if 'cd_type' not in context.user_data:
        return

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∞–π–º–∞—É—Ç–∞ 60 —Å–µ–∫
    waiting_since = context.user_data.get('cd_waiting_since', 0)
    if time.time() - waiting_since > 60:
        context.user_data.pop('cd_type', None)
        context.user_data.pop('cd_waiting_since', None)
        context.user_data.pop('cd_admin_id', None)
        await update.message.reply_text("‚åõ –í—Ä–µ–º—è –≤–≤–æ–¥–∞ –∏—Å—Ç–µ–∫–ª–æ (60 —Å–µ–∫). –ù–∞—á–Ω–∏—Ç–µ –∑–∞–Ω–æ–≤–æ.")
        return

    target_id = update.message.text.strip()
    cd_type = context.user_data.pop("cd_type", None)
    context.user_data.pop('cd_waiting_since', None)
    context.user_data.pop('cd_admin_id', None)

    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–º–µ–Ω—ã
    if target_id.lower() == "–æ—Ç–º–µ–Ω–∞":
        await update.message.reply_text("‚ùå –í–≤–æ–¥ –æ—Ç–º–µ–Ω–µ–Ω.")
        return

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ —ç—Ç–æ —á–∏—Å–ª–æ
    if not target_id.isdigit():
        await update.message.reply_text(
            "‚ùó –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π TelegramID (—Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã) –∏–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ '–æ—Ç–º–µ–Ω–∞'."
        )
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–±—Ä–∞—Ç–Ω–æ
        context.user_data['cd_type'] = cd_type
        context.user_data['cd_waiting_since'] = waiting_since  # —Å–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è
        context.user_data['cd_admin_id'] = user_id
        return

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–∞–∑–µ
    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()
        cursor.execute("SELECT username, first_name FROM users WHERE user_id = ?", (target_id,))
        user_row = cursor.fetchone()

    if not user_row:
        await update.message.reply_text(
            f"‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å ID `{target_id}` –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.",
            parse_mode=ParseMode.MARKDOWN
        )
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–±—Ä–∞—Ç–Ω–æ
        context.user_data['cd_type'] = cd_type
        context.user_data['cd_waiting_since'] = waiting_since
        context.user_data['cd_admin_id'] = user_id
        return

    username = user_row[0] or user_row[1] or "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"

    # –ê–Ω–∏–º–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏
    msg = await update.message.reply_text(
        f"üîé –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.\nID: `{target_id}`\n–ò–º—è: `{username}`",
        parse_mode=ParseMode.MARKDOWN
    )

    for i in range(3):
        new_text = f"üîé –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è{'.' * (i + 1)}\nID: `{target_id}`\n–ò–º—è: `{username}`"
        try:
            await msg.edit_text(new_text, parse_mode=ParseMode.MARKDOWN)
        except:
            pass
        await asyncio.sleep(0.5)

    cd_type_name = {
        "robbery": "üí∞ –û–≥—Ä–∞–±–ª–µ–Ω–∏–µ",
        "hack": "üíª –•–∞–∫ –≤–∑–ª–æ–º",
        "bonus": "üéÅ –ë–æ–Ω—É—Å"
    }.get(cd_type, cd_type)

    await msg.edit_text(
        f"‚è±Ô∏è –°–±—Ä–æ—Å CoolDown...\n–¢–∏–ø: `{cd_type_name}`\nID: `{target_id}`",
        parse_mode=ParseMode.MARKDOWN
    )
    await asyncio.sleep(0.5)

    success = await reset_cooldown(target_id, cd_type)

    if success:
        await msg.edit_text(
            f"‚úÖ <b>CoolDown —É—Å–ø–µ—à–Ω–æ —Å–±—Ä–æ—à–µ–Ω</b>\n\n"
            f"üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: <a href='tg://user?id={target_id}'>{username}</a>\n"
            f"üÜî ID: <code>{target_id}</code>\n"
            f"‚è±Ô∏è –¢–∏–ø: <b>{cd_type_name}</b>",
            parse_mode=ParseMode.HTML
        )
    else:
        await msg.edit_text(
            f"‚ùå <b>–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ CoolDown</b>\n\n"
            f"üë§ ID: <code>{target_id}</code>\n"
            f"‚è±Ô∏è –¢–∏–ø: <code>{cd_type}</code>\n\n"
            f"<i>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞ –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.</i>",
            parse_mode=ParseMode.HTML
        )

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# CALLBACK –û–ë–†–ê–ë–û–¢–ß–ò–ö
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

async def cooldown_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ callback –∫–Ω–æ–ø–æ–∫ –¥–ª—è —Å–±—Ä–æ—Å–∞ CD"""
    query = update.callback_query
    data = query.data
    user_id = str(query.from_user.id)

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ (—Å—Ç–∞—Ç—É—Å 9+)
    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()
        cursor.execute("SELECT status FROM users WHERE user_id = ?", (user_id,))
        row = cursor.fetchone()
        status = row[0] if row else 0

    if status < 9:
        await query.answer("üö´ –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω. –¢–æ–ª—å–∫–æ –ö—É—Ä–∞—Ç–æ—Ä –∏ –≤—ã—à–µ.", show_alert=True)
        return

    # –í–≤–æ–¥ ID
    if data.startswith("cd_input"):
        parts = data.split("|")
        cd_type = parts[1] if len(parts) > 1 else "unknown"

        context.user_data['cd_type'] = cd_type
        context.user_data['cd_waiting_since'] = time.time()  # –∑–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä
        context.user_data['cd_admin_id'] = user_id

        cd_type_names = {
            "robbery": "üí∞ –û–≥—Ä–∞–±–ª–µ–Ω–∏–µ",
            "hack": "üíª –•–∞–∫ –≤–∑–ª–æ–º",
            "bonus": "üéÅ –ü–æ–ª—É—á–µ–Ω–∏–µ –ë–æ–Ω—É—Å–∞"
        }

        buttons = [[InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data=f"cancel_cd|{user_id}")]]

        await query.edit_message_text(
            text=(
                f"‚è±Ô∏è <b>–°–±—Ä–æ—Å –ö–î</b>\n\n"
                f"–§—É–Ω–∫—Ü–∏—è: <code>{cd_type_names.get(cd_type, cd_type)}</code>\n"
                f"–í–≤–µ–¥–∏—Ç–µ TelegramID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:\n\n"
                f"<i>‚è∞ –û–∂–∏–¥–∞–Ω–∏–µ –≤–≤–æ–¥–∞: 60 —Å–µ–∫—É–Ω–¥</i>"
            ),
            parse_mode=ParseMode.HTML,
            reply_markup=InlineKeyboardMarkup(buttons)
        )
        await query.answer()

    # –û—Ç–º–µ–Ω–∞
    elif data.startswith("cancel_cd"):
        context.user_data.pop('cd_type', None)

        buttons = [
            [InlineKeyboardButton("üí∞ –û–≥—Ä–∞–±–ª–µ–Ω–∏–µ", callback_data=f"cd_input|robbery|{user_id}")],
            [InlineKeyboardButton("üíª –•–∞–∫ –≤–∑–ª–æ–º", callback_data=f"cd_input|hack|{user_id}")],
            [InlineKeyboardButton("üéÅ –ü–æ–ª—É—á–µ–Ω–∏–µ –ë–æ–Ω—É—Å–∞", callback_data=f"cd_input|bonus|{user_id}")],
            [InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data=f"admin_functions|{user_id}")]
        ]

        await query.edit_message_text(
            text="<b>‚è±Ô∏è Admin CoolDown</b>\n\n–í—ã–±–µ—Ä–∏—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è —Å–±—Ä–æ—Å–∞ –ö–î:",
            parse_mode=ParseMode.HTML,
            reply_markup=InlineKeyboardMarkup(buttons)
        )
        await query.answer()

async def admin_logs_pagination_manual(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    data = query.data.split("|")  # ['log_page', log_type, page, user_id']

    if len(data) < 4:
        await query.answer("‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.", show_alert=True)
        return

    log_type = data[1].strip().lower()
    page = int(data[2])
    user_id = data[3]

    logs = load_logs()
    logs_list = logs.get(log_type, [])

    if not logs_list:
        await query.answer("‚ö†Ô∏è –ù–µ—Ç –ª–æ–≥–æ–≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è.", show_alert=True)
        return

    # —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —É–±—ã–≤–∞–Ω–∏—é
    logs_list = sorted(logs_list, key=lambda x: x["id"], reverse=True)

    per_page = 5
    total_pages = (len(logs_list) + per_page - 1) // per_page
    start = (page - 1) * per_page
    end = start + per_page
    page_logs = logs_list[start:end]

    # –ö–Ω–æ–ø–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ª–æ–≥–∞
    buttons = [
        [InlineKeyboardButton(
            f"üìù Log #{log['id']}",
            callback_data=f"log_detail|{log_type}|{log['id']}|{user_id}"
        )] for log in page_logs
    ]

    # –ù–∞–≤–∏–≥–∞—Ü–∏—è
    nav_buttons = []
    if page > 1:
        nav_buttons.append(InlineKeyboardButton("‚¨ÖÔ∏è", callback_data=f"log_page|{log_type}|{page - 1}|{user_id}"))
    if page < total_pages:
        nav_buttons.append(InlineKeyboardButton("‚û°Ô∏è", callback_data=f"log_page|{log_type}|{page + 1}|{user_id}"))
    if nav_buttons:
        buttons.append(nav_buttons)

    # –ö–Ω–æ–ø–∫–∞ –Ω–∞–∑–∞–¥
    buttons.append([InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data=f"log_menu|{user_id}")])

    # –ö—Ä–∞—Å–∏–≤—ã–π HTML-—Ç–µ–∫—Å—Ç
    text = (
        f"üìä <b>Admin –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ</b>\n"
        f"üóÇ –¢–∏–ø –ª–æ–≥–∞: <code>{log_type.capitalize()}</code>\n"
        f"üìÑ –°—Ç—Ä–∞–Ω–∏—Ü–∞: <b>{page}/{total_pages}</b>\n"
        f"----------------------------------"
    )

    await query.edit_message_text(
        text=text,
        parse_mode="HTML",
        reply_markup=InlineKeyboardMarkup(buttons)
    )


def load_logs():
    if not os.path.exists(LOG_FILE):
        return {}  # –µ—Å–ª–∏ —Ñ–∞–π–ª–∞ –Ω–µ—Ç ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π —Å–ª–æ–≤–∞—Ä—å

    # –ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ–∞–π–ª –Ω–µ –ø—É—Å—Ç–æ–π
    if os.path.getsize(LOG_FILE) == 0:
        return {}

    with open(LOG_FILE, "r", encoding="utf-8") as file:
        try:
            return json.load(file)
        except json.JSONDecodeError:
            return {}  # –µ—Å–ª–∏ —Ñ–∞–π–ª –±–∏—Ç—ã–π ‚Äî —Ç–æ–∂–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π —Å–ª–æ–≤–∞—Ä—å


def save_logs(data):
    with open(LOG_FILE, "w", encoding="utf-8") as file:
        json.dump(data, file, ensure_ascii=False, indent=4)


def add_log(log_type, log_data):
    logs = load_logs()
    if log_type not in logs:
        logs[log_type] = []
    logs[log_type].append(log_data)
    save_logs(logs)


async def get_chat_info(bot: "telegram.Bot", chat_id: str) -> str:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏–µ —á–∞—Ç–∞ –∏ ID –≤ —Ñ–æ—Ä–º–∞—Ç–µ 'Chat. Title: {title}\nChat. ID: {id}'"""
    try:
        chat = await bot.get_chat(chat_id)
        title = chat.title or str(chat_id)
        return f"Chat. Title: {html.escape(title)}\nChat. ID: {chat_id}"
    except Exception:
        return f"Chat. Title: Unknown\nChat. ID: {chat_id}"


async def format_log(log: dict, bot: "telegram.Bot") -> str:
    """–ö—Ä–∞—Å–∏–≤—ã–π –≤—ã–≤–æ–¥ —Å–ª–æ–≤–∞—Ä—è –ª–æ–≥–∞ —Å HTML –∏ —ç–º–æ–¥–∑–∏, –≤–∫–ª—é—á–∞—è –±–∞–Ω–∫–æ–≤—Å–∫–∏–µ –ø–µ—Ä–µ–≤–æ–¥—ã"""
    lines = []
    for key, value in log.items():
        k = key.replace("_", " ").capitalize()
        emoji = ""
        if k.lower() in ["id"]:
            emoji = "üÜî "
        elif k.lower() in ["admin id"]:
            emoji = "üëÆ "
        elif k.lower() in ["target id", "user id"]:
            emoji = "üë§ "
        elif k.lower() in ["amount", "—Å—É–º–º–∞"]:
            emoji = "üí∞ "
        elif k.lower() in ["duration", "–¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å"]:
            emoji = "‚è±Ô∏è "
        elif k.lower() in ["reason", "–ø—Ä–∏—á–∏–Ω–∞"]:
            emoji = "üìù "
        elif k.lower() in ["date"]:
            emoji = "üìÖ "
        elif k.lower() in ["time"]:
            emoji = "‚è∞ "

        # –î–ª—è chat_id –≤—ã–≤–æ–¥–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ ID —á–∞—Ç–∞
        if k.lower() == "chat id":
            value = await get_chat_info(bot, str(value))
            lines.append(f"{emoji}{value}")
        # –î–ª—è –±–∞–Ω–∫–æ–≤—Å–∫–∏—Ö –ª–æ–≥–æ–≤ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞—Ä—Ç—ã –∫—Ä–∞—Å–∏–≤–æ
        elif k.lower() in ["sender_card", "recipient_card"]:
            formatted_card = ' '.join([str(value)[i:i + 4] for i in range(0, len(str(value)), 4)])
            lines.append(f"{emoji}{k}: <code>{formatted_card}</code>")
        else:
            lines.append(f"{emoji}{k}: <code>{html.escape(str(value))}</code>")

    return "\n".join(lines)


async def admin_log_details(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    data = query.data.split("|")
    log_type = data[1].strip().lower()
    log_id = int(data[2])
    user_id = data[3]

    logs = load_logs()
    log_list = logs.get(log_type, [])
    log = next((l for l in log_list if l["id"] == log_id), None)

    if not log:
        await query.answer("‚ùå –õ–æ–≥ –Ω–µ –Ω–∞–π–¥–µ–Ω.", show_alert=True)
        return

    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–µ–π—Å—Ç–≤–∏–µ
    if log_type == "mutes":
        action_text = "–ú—É—Ç üîá"
    elif log_type == "unmute":
        action_text = "–°–Ω—è—Ç–∏–µ –º—É—Ç–∞ üîä"
    elif log_type == "give_money":
        action_text = "–í—ã–¥–∞—á–∞ –¥–µ–Ω–µ–≥ üíµ"
    elif log_type == "bans":
        action_text = log.get("action", "-")
    elif log_type == "bank_transfers":
        action_text = "–ë–∞–Ω–∫–æ–≤—Å–∫–∏–π –ø–µ—Ä–µ–≤–æ–¥ üí≥"
    else:
        action_text = "-"

    action_line = f"‚ö° –î–µ–π—Å—Ç–≤–∏–µ: <b>{action_text}</b>\n"

    # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –ª–æ–≥–∞
    details = (
        f"<b>üìå Admin –õ–æ–≥</b>\n"
        f"{action_line}"
        f"{await format_log(log, context.bot)}"
    )

    buttons = [
        [InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data=f"log_page|{log_type}|1|{user_id}")]
    ]

    await query.edit_message_text(
        text=details,
        parse_mode="HTML",
        reply_markup=InlineKeyboardMarkup(buttons)
    )


ADMIN_CHAT_ID = -1002871356749


async def awarn(update: Update, context: ContextTypes.DEFAULT_TYPE):
    admin = update.effective_user
    admin_status = get_awarn_status_user(admin.id)

    if admin_status < 11:
        await update.message.reply_text("‚ùå –î–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –¥–ª—è –°–ø–µ—Ü–∏–∞–ª—å–Ω–æ–≥–æ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –∏ –≤—ã—à–µ.")
        return

    args = context.args
    user_id = None
    reason = None

    if update.message.reply_to_message:
        user_id = update.message.reply_to_message.from_user.id
        target_user = update.message.reply_to_message.from_user
        reason = ' '.join(args)
    else:
        if len(args) < 2:
            await update.message.reply_text("‚ùó –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /awarn {TelegramID / –æ—Ç–≤–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ} {–ø—Ä–∏—á–∏–Ω–∞}")
            return
        try:
            user_id = int(args[0])
            # –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–ª—É—á–∏—Ç—å User –æ–±—ä–µ–∫—Ç –ø–æ user_id –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
            target_user = await context.bot.get_chat_member(update.effective_chat.id, user_id)
            target_user = target_user.user
        except Exception:
            # –ï—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å User –æ–±—ä–µ–∫—Ç, —Å–æ–∑–¥–∞–¥–∏–º "–∑–∞–≥–ª—É—à–∫—É"
            target_user = telegram.User(id=user_id, is_bot=False, first_name="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å")
        reason = ' '.join(args[1:])

    if not reason:
        await update.message.reply_text("‚ùó –£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –≤–∞—Ä–Ω–∞.")
        return

    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    cursor.execute("SELECT warnings FROM admins WHERE user_id = ?", (str(user_id),))
    res = cursor.fetchone()

    new_warnings = 1
    if res is None:
        cursor.execute("INSERT INTO admins (user_id, points, warnings) VALUES (?, 0, 1)", (str(user_id),))
    else:
        new_warnings = res[0] + 1
        cursor.execute("UPDATE admins SET warnings = ? WHERE user_id = ?", (new_warnings, str(user_id)))

    removed_from_admin = False
    kicked_from_chat = False
    kick_message = ""

    if new_warnings >= 3:
        cursor.execute("UPDATE users SET status = 0 WHERE user_id = ?", (str(user_id),))
        cursor.execute("DELETE FROM admins WHERE user_id = ?", (str(user_id),))
        removed_from_admin = True

        try:
            await context.bot.ban_chat_member(chat_id=ADMIN_CHAT_ID, user_id=user_id, until_date=0)
            await context.bot.unban_chat_member(chat_id=ADMIN_CHAT_ID, user_id=user_id)
            kicked_from_chat = True
            kick_message = "‚úÖ –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –∏–∑ —á–∞—Ç–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ."
        except Exception as e:
            kick_message = f"‚ùå –û—à–∏–±–∫–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏—è –∏–∑ —á–∞—Ç–∞: {e}"
            print(f"[WARN] –ù–µ —É–¥–∞–ª–æ—Å—å –∫–∏–∫–Ω—É—Ç—å {user_id} –∏–∑ —á–∞—Ç–∞: {e}")

    conn.commit()
    conn.close()

    display_name = get_display_name_html_new(target_user)

    message = (
        "‚úÖ <b>–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –≤—ã–¥–∞–Ω–æ.</b>\n"
        f"üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {display_name}\n"
        f"üìå <b>–ü—Ä–∏—á–∏–Ω–∞:</b> {reason}\n"
        f"‚ö†Ô∏è Warns: <b>{new_warnings}/3</b>"
    )

    if removed_from_admin:
        message += (
            "\n\nüö´ <b>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Å–Ω—è—Ç —Å –¥–æ–ª–∂–Ω–æ—Å—Ç–∏.</b>\n"
            "üìç –ü—Ä–∏—á–∏–Ω–∞: 3/3 warns\n"
            "üîí –í—Å–µ –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –æ—Ç–æ–±—Ä–∞–Ω—ã."
        )
    if kicked_from_chat:
        message += "\nüë¢ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ç–∞–∫–∂–µ –∫–∏–∫–Ω—É—Ç –∏–∑ –∞–¥–º–∏–Ω-—á–∞—Ç–∞."

    await update.message.reply_text(message, parse_mode="HTML")

    if removed_from_admin:
        try:
            await context.bot.send_message(
                chat_id=ADMIN_CHAT_ID,
                text=(
                    f"‚ö†Ô∏è <b>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–Ω—è—Ç–∏–µ —Å –ø–æ—Å—Ç–∞:</b>\n"
                    f"üë§ {display_name}\n"
                    f"üìç –ü—Ä–∏—á–∏–Ω–∞: 3/3 warns\n"
                    f"üõë –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Å–Ω—è—Ç\n"
                    f"{kick_message}"
                ),
                parse_mode="HTML"
            )
        except Exception as e:
            print(f"[WARN] –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∞–¥–º–∏–Ω-—á–∞—Ç: {e}")


async def aunwarn(update: Update, context: ContextTypes.DEFAULT_TYPE):
    admin = update.effective_user
    admin_status = get_awarn_status_user(admin.id)

    if admin_status < 11:
        await update.message.reply_text("‚ùå –î–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –¥–ª—è –°–ø–µ—Ü–∏–∞–ª—å–Ω–æ–≥–æ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –∏ –≤—ã—à–µ.")
        return

    args = context.args
    user_id = None

    if update.message.reply_to_message:
        user_id = update.message.reply_to_message.from_user.id
        target_user = update.message.reply_to_message.from_user
        reason = ' '.join(args)
    else:
        if len(args) < 2:
            await update.message.reply_text("‚ùó –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /aunwarn {TelegramID / –æ—Ç–≤–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ} {–ø—Ä–∏—á–∏–Ω–∞}")
            return
        try:
            user_id = int(args[0])
            # –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–ª—É—á–∏—Ç—å User –æ–±—ä–µ–∫—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
            try:
                member = await context.bot.get_chat_member(update.effective_chat.id, user_id)
                target_user = member.user
            except Exception:
                # –ó–∞–≥–ª—É—à–∫–∞, –µ—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å User
                target_user = telegram.User(id=user_id, is_bot=False, first_name="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å")
        except ValueError:
            await update.message.reply_text("‚ùó –ù–µ–≤–µ—Ä–Ω—ã–π TelegramID.")
            return
        reason = ' '.join(args[1:])

    if not reason:
        await update.message.reply_text("‚ùó –£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É —Å–Ω—è—Ç–∏—è –≤–∞—Ä–Ω–∞.")
        return

    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    cursor.execute("SELECT warnings FROM admins WHERE user_id = ?", (str(user_id),))
    res = cursor.fetchone()

    if res is None or res[0] == 0:
        await update.message.reply_text("‚ùó –£ —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç –≤–∞—Ä–Ω–æ–≤.")
        conn.close()
        return

    new_warnings = max(0, res[0] - 1)
    cursor.execute("UPDATE admins SET warnings = ? WHERE user_id = ?", (new_warnings, str(user_id)))

    conn.commit()
    conn.close()

    display_name = get_display_name_html_new(target_user)

    await update.message.reply_text(
        f"‚úîÔ∏è <b>–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ —Å–Ω—è—Ç–æ</b>\n"
        f"üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {display_name}.\n"
        f"üìù –ü—Ä–∏—á–∏–Ω–∞: {reason}",
        parse_mode="HTML"
    )


def get_user_role_department(user_id: str) -> int:
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT role FROM departament WHERE user_id = ?", (user_id,))
    result = cursor.fetchone()
    conn.close()
    return result[0] if result else 0  # –µ—Å–ª–∏ –Ω–µ—Ç –≤ –±–∞–∑–µ, —Ä–æ–ª—å 0 (–Ω–µ—Ç –æ—Ç–¥–µ–ª–∞)


def set_user_role_department(user_id: str, new_role: int):
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("UPDATE departament SET role = ? WHERE user_id = ?", (new_role, user_id))
    conn.commit()
    conn.close()

async def depset(update: Update, context: ContextTypes.DEFAULT_TYPE):
    args = context.args
    issuer = update.effective_user
    issuer_id_str = str(issuer.id)

    target_user_obj = None
    if update.message.reply_to_message:
        target_user_obj = update.message.reply_to_message.from_user
        target_user_id = str(target_user_obj.id)
        if not args:
            await update.message.reply_text(
                "‚ùó –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /depset {–Ω–æ–≤–∞—è_—Ä–æ–ª—å} (–æ—Ç–≤–µ—Ç–æ–º)\n"
                "–∏–ª–∏: /depset {telegramID} {–Ω–æ–≤–∞—è_—Ä–æ–ª—å}",
                parse_mode=ParseMode.HTML
            )
            return
        new_role_str = args[0]
    else:
        if len(args) < 2:
            await update.message.reply_text(
                "‚ùó –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /depset {telegramID} {–Ω–æ–≤–∞—è_—Ä–æ–ª—å}\n"
                "–∏–ª–∏ –æ—Ç–≤–µ—Ç–æ–º: /depset {–Ω–æ–≤–∞—è_—Ä–æ–ª—å}",
                parse_mode=ParseMode.HTML
            )
            return
        target_user_id = args[0]
        new_role_str = args[1]

    try:
        new_role = int(new_role_str)
        if new_role < 1 or new_role > 5:
            await update.message.reply_text("‚ùó –†–æ–ª—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —á–∏—Å–ª–æ–º –æ—Ç 1 –¥–æ 5.")
            return
    except ValueError:
        await update.message.reply_text("‚ùó –†–æ–ª—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —á–∏—Å–ª–æ–º –æ—Ç 1 –¥–æ 5.")
        return

    conn = get_db_connection()
    cursor = conn.cursor()

    cursor.execute("SELECT department_name, role FROM departament WHERE user_id = ?", (issuer_id_str,))
    issuer_row = cursor.fetchone()
    if not issuer_row:
        conn.close()
        await update.message.reply_text("üö´ –í—ã –Ω–µ —Å–æ—Å—Ç–æ–∏—Ç–µ –Ω–∏ –≤ –æ–¥–Ω–æ–º –æ—Ç–¥–µ–ª–µ.")
        return

    issuer_dep, issuer_role = issuer_row["department_name"], issuer_row["role"]

    if issuer_role < 4:
        conn.close()
        await update.message.reply_text("üö´ –¢–æ–ª—å–∫–æ —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å –æ—Ç–¥–µ–ª–∞ –∏–ª–∏ –∑–∞–º–µ—Å—Ç–∏—Ç–µ–ª—å –º–æ–∂–µ—Ç –∏–∑–º–µ–Ω—è—Ç—å —Ä–æ–ª–∏.")
        return

    cursor.execute("SELECT department_name, role FROM departament WHERE user_id = ?", (target_user_id,))
    target_row = cursor.fetchone()
    if not target_row:
        conn.close()
        await update.message.reply_text("‚ùó –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –æ—Ç–¥–µ–ª–µ.")
        return

    target_dep, target_role = target_row["department_name"], target_row["role"]

    if target_dep != issuer_dep:
        conn.close()
        await update.message.reply_text("üö´ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —Å–æ—Å—Ç–æ–∏—Ç –≤ –≤–∞—à–µ–º –æ—Ç–¥–µ–ª–µ.")
        return

    if target_user_id == issuer_id_str:
        conn.close()
        await update.message.reply_text("üö´ –í—ã –Ω–µ –º–æ–∂–µ—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å —Ä–æ–ª—å —Å–∞–º–æ–º—É —Å–µ–±–µ.")
        return

    if new_role == target_role:
        conn.close()
        await update.message.reply_text(
            f"‚ÑπÔ∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∏–º–µ–µ—Ç —Ä–æ–ª—å <b>{html.escape(ROLE_NAMES.get(target_role, str(target_role)))}</b>.",
            parse_mode=ParseMode.HTML
        )
        return

    if target_role >= issuer_role:
        conn.close()
        await update.message.reply_text("üö´ –í—ã –Ω–µ –º–æ–∂–µ—Ç–µ –∏–∑–º–µ–Ω—è—Ç—å —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —Ä–∞–≤–Ω–æ–π –∏–ª–∏ –±–æ–ª–µ–µ –≤—ã—Å–æ–∫–æ–π —Ä–æ–ª—å—é.")
        return

    if new_role > issuer_role:
        conn.close()
        await update.message.reply_text("üö´ –í—ã –Ω–µ –º–æ–∂–µ—Ç–µ –Ω–∞–∑–Ω–∞—á–∏—Ç—å —Ä–æ–ª—å –≤—ã—à–µ —Å–≤–æ–µ–π.")
        return

    cursor.execute("UPDATE departament SET role = ? WHERE user_id = ?", (new_role, target_user_id))
    conn.commit()
    conn.close()

    old_role_name = html.escape(ROLE_NAMES.get(target_role, f"–†–æ–ª—å {target_role}"))
    new_role_name = html.escape(ROLE_NAMES.get(new_role, f"–†–æ–ª—å {new_role}"))

    if target_user_obj:
        target_mention = get_display_name_html_new(target_user_obj)
    else:
        target_mention = get_display_name_html_by_id(target_user_id)

    issuer_mention = get_display_name_html_new(issuer)

    is_promotion = new_role > target_role
    action_icon = "‚¨ÜÔ∏è" if is_promotion else "‚¨áÔ∏è"
    action_word = "–ü–æ–≤—ã—à–µ–Ω–∏–µ" if is_promotion else "–ü–æ–Ω–∏–∂–µ–Ω–∏–µ"

    await update.message.reply_text(
        f"{action_icon} <b>{action_word}</b>\n"
        f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
        f"ü´ß {target_mention}\n"
        f"üî∑ <i>{html.escape(issuer_dep)}</i>\n"
        f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
        f"üîπ <s>{old_role_name}</s>\n"
        f"üí† <b>{new_role_name}</b>\n"
        f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
        f"üåÄ {issuer_mention}",
        parse_mode=ParseMode.HTML
    )

async def dephelp(update, context):
    keyboard = [
        [InlineKeyboardButton("üìã –°–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥", url="https://telegra.ph/Komandy-Otdelov-Administracii-07-15")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)

    await update.message.reply_text(
        "üìö –û—Ç–¥–µ–ª—ã –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏ Ô∏èüìö",
        reply_markup=reply_markup
    )

last_hod_usage = {}

ADMIN_ID = 7406372338
DEPARTMENT_NAME = "Admins - Helpers"

def get_user_info_hod(user_id):
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT status, level FROM users WHERE user_id = ?", (str(user_id),))
    row = cursor.fetchone()
    conn.close()
    if row:
        return row[0], row[1]
    return 0, 1  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é


def get_admin_warnings(user_id):
    """–ü–æ–ª—É—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π –∞–¥–º–∏–Ω–∞"""
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT warnings FROM admins WHERE user_id = ?", (str(user_id),))
    row = cursor.fetchone()
    conn.close()
    return row[0] if row else 0


def get_department_warnings(user_id):
    """–ü–æ–ª—É—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π –≤ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–µ"""
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT COUNT(*) FROM department_warns WHERE user_id = ?", (str(user_id),))
    row = cursor.fetchone()
    conn.close()
    return row[0] if row else 0


def get_department_info(user_id):
    """–ü–æ–ª—É—á–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–∞ –∏ —Ä–æ–ª—å –≤ –Ω—ë–º"""
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT department_name, role FROM departament WHERE user_id = ?", (str(user_id),))
    row = cursor.fetchone()
    conn.close()
    if row:
        department_name, role_num = row
        role_name = ROLE_NAMES.get(role_num, "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ")
        return department_name, role_name
    return None, None


async def hod(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    user_id = user.id
    now = datetime.now()

    last_time = last_hod_usage.get(user_id)
    if last_time and (now - last_time).total_seconds() < 3600:
        wait_time = 3600 - int((now - last_time).total_seconds())
        minutes = wait_time // 60
        seconds = wait_time % 60
        await update.message.reply_text(
            f"‚è≥ –ö–æ–º–∞–Ω–¥—É –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ä–∞–∑ –≤ —á–∞—Å.\n"
            f"–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —á–µ—Ä–µ–∑ {minutes} –º–∏–Ω {seconds} —Å–µ–∫."
        )
        return

    last_hod_usage[user_id] = now

    await update.message.reply_text(
        f"–ó–∞—è–≤–∫–∞ –Ω–∞ –ø–æ—Å—Ç –†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—è {DEPARTMENT_NAME} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!"
    )

    status_id, user_level = get_user_info_hod(user_id)
    if 0 <= status_id < len(STATUS_LIST):
        user_role = STATUS_LIST[status_id]
    else:
        user_role = "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"

    admin_warns = get_admin_warnings(user_id)
    dep_warns = get_department_warnings(user_id)
    dep_name, dep_role = get_department_info(user_id)

    dep_name = dep_name if dep_name else "–Ω–µ—Ç"
    dep_role = dep_role if dep_role else "–Ω–µ—Ç"

    date_time_str = now.strftime("%Y-%m-%d %H:%M:%S")
    user_mention = f"[{user.first_name}](tg://user?id={user_id})"

    admin_msg = (
        f"üì¢ <b>–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ –Ω–∞ –ø–æ—Å—Ç –†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—è</b>\n"
        f"üõ°Ô∏è –û—Ç–¥–µ–ª: <b>{DEPARTMENT_NAME}</b>\n\n"
        f"üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {user_mention}\n"
        f"üÜî Telegram ID: <code>{user_id}</code>\n"
        f"üìÖ –î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è: <b>{date_time_str}</b>\n"
        f"üéñ –†–æ–ª—å: <i>{user_role}</i>\n\n"
        f"‚ö†Ô∏è –ê–¥–º–∏–Ω—Å–∫–∏–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è: <b>{admin_warns}</b>\n"
        f"‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ—Ç–¥–µ–ª–∞: <b>{dep_warns}</b>\n"
        f"üè¢ –î–µ–ø–æ—Ä—Ç–∞–º–µ–Ω—Ç: <b>{dep_name}</b>\n"
        f"üõ° –†–æ–ª—å –≤ –¥–µ–ø–æ—Ä—Ç–∞–º–µ–Ω—Ç–µ: <b>{dep_role}</b>"
    )

    try:
        await context.bot.send_message(
            chat_id=ADMIN_ID,
            text=admin_msg,
            parse_mode=ParseMode.HTML,
            disable_web_page_preview=True
        )
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –∞–¥–º–∏–Ω—É: {e}")


async def bank_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    args = context.args  # —Å–ø–∏—Å–æ–∫ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ –ø–æ—Å–ª–µ /bank

    if not args:
        # –ü—Ä–æ—Å—Ç–æ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º /bank –±–µ–∑ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤
        await update.message.reply_text(
            "‚ùó –£–∫–∞–∂–∏—Ç–µ –ø–æ–¥–∫–æ–º–∞–Ω–¥—É.\n\n"
            "<b>–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:</b>\n"
            "üÜï <b>–ë–∞–Ω–∫ —Å–æ–∑–¥–∞—Ç—å</b> <i>(–Ω–∞–∑–≤–∞–Ω–∏–µ)</i> ‚Äî —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –±–∞–Ω–∫\n"
            "üí∏ <b>–ë–∞–Ω–∫ –ø–µ—Ä–µ–≤–æ–¥</b> <i>{—Å—É–º–º–∞} {–Ω–æ–º–µ—Ä –∫–∞—Ä—Ç—ã}</i> ‚Äî –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ –¥–µ–Ω—å–≥–∏\n"
            "‚ûï <b>–ë–∞–Ω–∫ –ø–æ–ø–æ–ª–Ω–∏—Ç—å</b> <i>(—Å—É–º–º–∞)</i> ‚Äî –ø–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–Ω–∫\n"
            "‚ûñ <b>–ë–∞–Ω–∫ —Å–Ω—è—Ç—å</b> <i>(—Å—É–º–º–∞)</i> ‚Äî —Å–Ω—è—Ç—å –¥–µ–Ω—å–≥–∏\n"
            "üóë <b>–ë–∞–Ω–∫ —É–¥–∞–ª–∏—Ç—å</b> ‚Äî —É–¥–∞–ª–∏—Ç—å –±–∞–Ω–∫",
            parse_mode="HTML"
        )
        return

    subcommand = args[0].lower()

    if subcommand in ["—Å–æ–∑–¥–∞—Ç—å", "create"]:
        if len(args) < 2:
            await update.message.reply_text("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –±–∞–Ω–∫–∞.")
            return
        bank_name = ' '.join(args[1:])
        context.args = [bank_name]  # —á—Ç–æ–±—ã –ø–µ—Ä–µ–¥–∞—Ç—å –≤ createbank
        return await createbank(update, context)

    elif subcommand == "–ø–µ—Ä–µ–≤–æ–¥":
        if len(args) < 3:
            await update.message.reply_text("–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: –ë–∞–Ω–∫ –ø–µ—Ä–µ–≤–æ–¥ <—Å—É–º–º–∞> <–Ω–æ–º–µ—Ä –∫–∞—Ä—Ç—ã>")
            return
        context.args = [args[1], " ".join(args[2:])]
        return await bpay(update, context)

    elif subcommand == "–ø–æ–ø–æ–ª–Ω–∏—Ç—å":
        if len(args) < 2:
            await update.message.reply_text("–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: –ë–∞–Ω–∫ –ø–æ–ø–æ–ª–Ω–∏—Ç—å <—Å—É–º–º–∞>")
            return
        context.args = [args[1]]
        return await bankreplenish(update, context)

    elif subcommand == "—Å–Ω—è—Ç—å":
        if len(args) < 2:
            await update.message.reply_text("–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: –ë–∞–Ω–∫ —Å–Ω—è—Ç—å <—Å—É–º–º–∞>")
            return
        context.args = [args[1]]
        return await bankremoved(update, context)

    elif subcommand == "—É–¥–∞–ª–∏—Ç—å":
        return await delbank(update, context)

    else:
        await update.message.reply_text(
            "‚ùå <b>–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞</b>\n\n"
            "<b>–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:</b>\n"
            "üÜï <b>–ë–∞–Ω–∫ —Å–æ–∑–¥–∞—Ç—å</b> <i>(–Ω–∞–∑–≤–∞–Ω–∏–µ)</i>\n"
            "üí∏ <b>–ë–∞–Ω–∫ –ø–µ—Ä–µ–≤–æ–¥</b> <i>{—Å—É–º–º–∞} {–Ω–æ–º–µ—Ä –∫–∞—Ä—Ç—ã}</i>\n"
            "‚ûï <b>–ë–∞–Ω–∫ –ø–æ–ø–æ–ª–Ω–∏—Ç—å</b> <i>(—Å—É–º–º–∞)</i>\n"
            "‚ûñ <b>–ë–∞–Ω–∫ —Å–Ω—è—Ç—å</b> <i>(—Å—É–º–º–∞)</i>\n"
            "üóë <b>–ë–∞–Ω–∫ —É–¥–∞–ª–∏—Ç—å</b>",
            parse_mode="HTML"
        )


def get_new_bank_balance(user_id: int) -> int | None:
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT balance FROM Bank_New WHERE user_id = ?", (user_id,))
    row = cursor.fetchone()
    conn.close()
    if row:
        try:
            return int(row[0])
        except:
            return 0
    return None


def update_new_bank_balance(user_id: int, new_balance: int):
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("UPDATE Bank_New SET balance = ? WHERE user_id = ?", (str(new_balance), user_id))
    conn.commit()
    conn.close()


sex_requests = {}
baby_name_requests = {}


async def sex_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if update.effective_chat.type == "private":
        await update.message.reply_text("‚ùó –ö–æ–º–∞–Ω–¥—É –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –≤ –≥—Ä—É–ø–ø–æ–≤–æ–º —á–∞—Ç–µ.")
        return

    user_id = str(update.effective_user.id)

    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("""
        SELECT user_id1, user_id2, condom FROM marriages
        WHERE user_id1 = ? OR user_id2 = ?
    """, (user_id, user_id))
    marriage = cursor.fetchone()
    conn.close()

    if not marriage:
        await update.message.reply_text("‚ùó –í—ã –Ω–µ —Å–æ—Å—Ç–æ–∏—Ç–µ –≤ –±—Ä–∞–∫–µ.")
        return

    user1, user2, condom = marriage
    partner_id = user2 if user_id == user1 else user1

    # –ü–æ–ª—É—á–∞–µ–º –æ–±—ä–µ–∫—Ç ChatMember –ø–∞—Ä—Ç–Ω—ë—Ä–∞, —á—Ç–æ–±—ã —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –Ω–∏–∫ —Å —Å—Å—ã–ª–∫–æ–π
    try:
        chat_member = await context.bot.get_chat_member(chat_id=update.effective_chat.id, user_id=int(partner_id))
        partner_mention = get_display_name_html_new(chat_member.user)
    except Exception:
        # –ù–∞ —Å–ª—É—á–∞–π –æ—à–∏–±–∫–∏ - fallback
        partner_mention = "–ü–æ–ª–æ–≤–∏–Ω–∫–∞"

    keyboard = InlineKeyboardMarkup([
        [
            InlineKeyboardButton("üíû –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å", callback_data=f"confirm_sex:{user_id}:{partner_id}:{condom}"),
            InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data=f"decline_sex:{user_id}:{partner_id}")
        ]
    ])

    message_text = (
        "üíó <b>–ó–∞–ø—Ä–æ—Å –Ω–∞ –±–ª–∏–∑–æ—Å—Ç—å</b>\n\n"
        f"üë´ <b>–í–∞—à–∞ –ø–æ–ª–æ–≤–∏–Ω–∫–∞:</b> {partner_mention}\n\n"
        "‚è≥ –û–∂–∏–¥–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤—Ç–æ—Ä–æ–π –ø–æ–ª–æ–≤–∏–Ω–∫–∏\n"
        "<pre> –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –≤ —Ç–µ—á–µ–Ω–∏–µ 5 –º–∏–Ω.</pre>"
    )

    message = await update.message.reply_text(
        message_text,
        reply_markup=keyboard,
        parse_mode="HTML"
    )

    sex_requests[user_id] = {
        "partner_id": partner_id,
        "message_id": message.message_id,
        "chat_id": update.effective_chat.id,
        "condom": condom,
        "timestamp": int(time.time())
    }

    # –¢–∞–π–º–µ—Ä 5 –º–∏–Ω—É—Ç
    async def timeout_check():
        await asyncio.sleep(300)
        req = sex_requests.get(user_id)
        if req and int(time.time()) - req["timestamp"] >= 300:
            try:
                await context.bot.edit_message_text(
                    chat_id=req["chat_id"],
                    message_id=req["message_id"],
                    text="‚åõ –í—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –∏—Å—Ç–µ–∫–ª–æ. –ó–∞–ø—Ä–æ—Å –æ—Ç–º–µ–Ω—ë–Ω."
                )
            except:
                pass
            del sex_requests[user_id]

    asyncio.create_task(timeout_check())


async def sex_button_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    data = query.data
    if data.startswith("confirm_sex"):
        _, user_id, partner_id, condom = data.split(":")
        if str(query.from_user.id) != partner_id:
            await query.answer("–≠—Ç–æ –Ω–µ –≤–∞—à –∑–∞–ø—Ä–æ—Å.")
            return

        user_id = str(user_id)
        req = sex_requests.pop(user_id, None)
        if not req:
            await query.edit_message_text("‚åõ –ó–∞–ø—Ä–æ—Å —É–∂–µ –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω.")
            return

        condom = int(condom)
        text = ""

        if condom == 1:
            text = "ü©≤ –£ –≤–∞—Å –±—ã–ª –Ω–∞–¥–µ—Ç –ø—Ä–µ–∑–µ—Ä–≤–∞—Ç–∏–≤.\n\n‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞—á–∞—Ç—å —Ä–µ–±—ë–Ω–∫–∞."
        else:
            if random.randint(1, 2) == 1:
                text = "üíû –í—ã –∑–∞–Ω—è–ª–∏—Å—å –ª—é–±–æ–≤—å—é, –Ω–æ –∑–∞—á–∞—Ç–∏—è –Ω–µ –ø—Ä–æ–∏–∑–æ—à–ª–æ."
            else:
                gender = random.choice(["–º", "–∂"])
                chosen_parent = random.choice([user_id, partner_id])
                baby_name_requests[req["chat_id"]] = {
                    "allowed_user": chosen_parent,
                    "gender": gender,
                    "partner": partner_id if chosen_parent == user_id else user_id,
                    "expire_time": time.time() + 900  # 15 –º–∏–Ω—É—Ç
                }

                # –ü–æ–ª—É—á–∞–µ–º –æ–±—ä–µ–∫—Ç User –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ä–æ–¥–∏—Ç–µ–ª—è (–≤—ã—Ç–∞—â–∏–º —á–µ—Ä–µ–∑ context.bot.get_chat –∏–ª–∏ update.effective_chat.get_member)
                user_obj = await context.bot.get_chat_member(chat_id=req["chat_id"], user_id=int(chosen_parent))
                mention_link = get_display_name_html_new(user_obj.user)

                text = (
                    "üë∂ <b>–í—ã –∑–∞—á–∞–ª–∏ —Ä–µ–±—ë–Ω–∫–∞!</b>\n\n"
                    f"–ü–æ–ª —Ä–µ–±—ë–Ω–∫–∞: {'–ú—É–∂—Å–∫–æ–π' if gender == '–º' else '–ñ–µ–Ω—Å–∫–∏–π'}\n"
                    f"–ü—Ä–∞–≤–æ –Ω–∞–∑–≤–∞—Ç—å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ: {mention_link}\n\n"
                    "–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∫–æ–º–∞–Ω–¥–æ–π: /kname {–∏–º—è}"
                )

        await query.edit_message_text(text, parse_mode="HTML")

    elif data.startswith("decline_sex"):
        _, user_id, partner_id = data.split(":")
        if str(query.from_user.id) != partner_id:
            await query.answer("–≠—Ç–æ –Ω–µ –≤–∞—à –∑–∞–ø—Ä–æ—Å.")
            return

        req = sex_requests.pop(user_id, None)
        if req:
            await query.edit_message_text("‚ùå –ó–∞–ø—Ä–æ—Å –Ω–∞ –∑–∞–Ω—è—Ç–∏–µ –ª—é–±–æ–≤—å—é –±—ã–ª –æ—Ç–∫–ª–æ–Ω—ë–Ω.")


async def kname(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = str(update.effective_user.id)
    chat_id = update.effective_chat.id
    args = context.args

    if chat_id not in baby_name_requests:
        await update.message.reply_text("‚ùå –°–µ–π—á–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –≤—ã–±–æ—Ä –∏–º–µ–Ω–∏.")
        return

    req = baby_name_requests[chat_id]
    if time.time() > req["expire_time"]:
        del baby_name_requests[chat_id]
        await update.message.reply_text("‚åõ –í—Ä–µ–º—è –Ω–∞ –≤–≤–æ–¥ –∏–º–µ–Ω–∏ –∏—Å—Ç–µ–∫–ª–æ.")
        return

    if user_id != req["allowed_user"]:
        await update.message.reply_text("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –≤–≤–æ–¥–∏—Ç—å –∏–º—è.")
        return

    if not args:
        await update.message.reply_text("–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /kname {–∏–º—è}")
        return

    name = " ".join(args)
    gender = req["gender"]
    partner_id = req["partner"]
    birthday = int(time.time())  # —Ç–µ–∫—É—â–∞—è –¥–∞—Ç–∞

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–±–µ–Ω–∫–∞
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("""
        INSERT INTO kids (parent1_id, parent2_id, name, gender, birthday, hunger, happiness, last_updated)
        VALUES (?, ?, ?, ?, ?, 100, 100, ?)
    """, (user_id, partner_id, name, gender, birthday, int(time.time())))
    conn.commit()
    conn.close()

    del baby_name_requests[chat_id]

    await update.message.reply_text(f"üéâ –†–µ–±—ë–Ω–æ–∫ <b>{name}</b> —É—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω!", parse_mode="HTML")


def get_user_condom(user_id):
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT first_name FROM users WHERE user_id = ?", (user_id,))
    result = cursor.fetchone()
    conn.close()
    return result[0] if result else "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"


async def get_marriage_condom(user_id: str):
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("""
        SELECT user_id1, user_id2, condom, condom FROM marriages
        WHERE user_id1 = ? OR user_id2 = ?
    """, (user_id, user_id))
    row = cursor.fetchone()
    conn.close()
    return row


async def condom_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = str(update.effective_user.id)
    marriage = await get_marriage_condom(user_id)

    if not marriage:
        if update.callback_query:
            await update.callback_query.edit_message_text("–í—ã –Ω–µ —Å–æ—Å—Ç–æ–∏—Ç–µ –≤ –±—Ä–∞–∫–µ.")
        else:
            await update.message.reply_text("–í—ã –Ω–µ —Å–æ—Å—Ç–æ–∏—Ç–µ –≤ –±—Ä–∞–∫–µ.")
        return

    uid1, uid2, condom_state, condoms_count = marriage
    partner_id = uid2 if uid1 == user_id else uid1

    # –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è —Å—Å—ã–ª–æ–∫ (–º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –∏–∑ –ë–î –∏–ª–∏ —á–µ—Ä–µ–∑ API)
    # –ó–¥–µ—Å—å –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞—é ID
    link1 = f"<a href='tg://user?id={uid1}'>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</a>"
    link2 = f"<a href='tg://user?id={uid2}'>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</a>"

    state_text = "üü¢ –ù–∞–¥–µ—Ç" if condom_state else "üî¥ –°–Ω—è—Ç"

    keyboard = [
        [InlineKeyboardButton("–ö—É–ø–∏—Ç—å (10.000)", callback_data=f"condom_buy_{user_id}")],
        [InlineKeyboardButton("–°–Ω—è—Ç—å" if condom_state else "–ù–∞–¥–µ—Ç—å", callback_data=f"condom_toggle_{user_id}")],
    ]

    text = (
        "üíû <b>–°–æ—Å—Ç–æ—è–Ω–∏–µ –ø–∞—Ä—ã</b>\n"
        f"üë§ {link1}\n"
        f"üë§ {link2}\n\n"
        "üß∑ <b>–ü—Ä–µ–∑–µ—Ä–≤–∞—Ç–∏–≤—ã</b>\n"
        f"–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: <b>{condoms_count}</b>\n"
        f"–°–æ—Å—Ç–æ—è–Ω–∏–µ: <b>{state_text}</b>"
    )

    if update.callback_query:
        try:
            await update.callback_query.edit_message_text(text, reply_markup=InlineKeyboardMarkup(keyboard),
                                                          parse_mode="HTML")
        except Exception:
            # –ï—Å–ª–∏ –Ω–µ –º–æ–∂–µ–º –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            await update.callback_query.message.reply_html(text, reply_markup=InlineKeyboardMarkup(keyboard))
    else:
        await update.message.reply_html(text, reply_markup=InlineKeyboardMarkup(keyboard))


async def condom_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    user_id = str(query.from_user.id)

    parts = query.data.split("_", 2)
    if len(parts) < 3:
        await query.answer("–ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ callback.", show_alert=True)
        return
    _, action, target_id = parts

    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    cursor.execute("SELECT balance FROM users WHERE user_id = ?", (user_id,))
    user = cursor.fetchone()
    if not user:
        await query.answer("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω.", show_alert=True)
        conn.close()
        return

    balance = user[0]

    if action == "buy":
        if balance < 10000:
            await query.answer("‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤.", show_alert=True)
            conn.close()
            return

        # –°–ø–∏—Å—ã–≤–∞–µ–º –¥–µ–Ω—å–≥–∏
        cursor.execute("UPDATE users SET balance = balance - 10000 WHERE user_id = ?", (user_id,))

        # –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–µ–∑–µ—Ä–≤–∞—Ç–∏–≤—ã –≤ –±—Ä–∞–∫
        cursor.execute("""
            UPDATE marriages
            SET condom = condom + 1
            WHERE user_id1 = ? OR user_id2 = ?
        """, (user_id, user_id))

        conn.commit()

        await query.answer("üß∑ –í—ã —É—Å–ø–µ—à–Ω–æ –∫—É–ø–∏–ª–∏ –ø—Ä–µ–∑–µ—Ä–≤–∞—Ç–∏–≤ –∑–∞ 10,000!", show_alert=True)
        conn.close()

        await condom_command(update, context)  # –æ–±–Ω–æ–≤–ª—è–µ–º –º–µ–Ω—é

    elif action == "toggle":
        cursor.execute("""
            SELECT condom FROM marriages
            WHERE user_id1 = ? OR user_id2 = ?
        """, (user_id, user_id))
        current = cursor.fetchone()
        if not current:
            await query.answer("–í—ã –Ω–µ —Å–æ—Å—Ç–æ–∏—Ç–µ –≤ –±—Ä–∞–∫–µ.", show_alert=True)
            conn.close()
            return

        new_state = 0 if current[0] else 1
        cursor.execute("""
            UPDATE marriages
            SET condom = ?
            WHERE user_id1 = ? OR user_id2 = ?
        """, (new_state, user_id, user_id))
        conn.commit()
        conn.close()

        await query.answer("–°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–µ–∑–µ—Ä–≤–∞—Ç–∏–≤–∞ –∏–∑–º–µ–Ω–µ–Ω–æ.", show_alert=True)
        await condom_command(update, context)

    else:
        await query.answer("–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ.", show_alert=True)
        conn.close()


async def condom_entry(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await condom_command(update, context)


def format_kid_info(kid_id, cursor):
    cursor.execute("""
        SELECT name, gender, birthday, parent1_id, parent2_id, hunger, happiness, food FROM kids
        WHERE kid_id = ?
    """, (kid_id,))
    kid = cursor.fetchone()
    if not kid:
        return None, None

    name, gender, birthday, p1, p2, hunger, happiness, food = kid

    # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –≤–æ–∑—Ä–∞—Å—Ç –ø–æ –¥–∞—Ç–µ —Ä–æ–∂–¥–µ–Ω–∏—è
    age_hours = (time.time() - birthday) / 3600
    days = int(age_hours // 24)
    hours = int(age_hours % 24)

    birth_str = time.strftime("%d.%m.%Y", time.localtime(birthday))

    cursor.execute("SELECT first_name FROM users WHERE user_id = ?", (p1,))
    p1_row = cursor.fetchone()
    p1_name = p1_row[0] if p1_row and p1_row[0] else "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"

    cursor.execute("SELECT first_name FROM users WHERE user_id = ?", (p2,))
    p2_row = cursor.fetchone()
    p2_name = p2_row[0] if p2_row and p2_row[0] else "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"

    text = (
        f"üë∂ <b><u>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–µ–±–µ–Ω–∫–µ</u></b>\n\n"
        f"üß∏ <b>–ò–º—è:</b> <i>{name}</i>\n"
        f"üìÖ <b>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è:</b> <i>{birth_str}</i>\n"
        f"üéÇ <b>–í–æ–∑—Ä–∞—Å—Ç:</b> <i>{days} –¥–Ω. {hours} —á.</i>\n"
        f"üöª <b>–ü–æ–ª:</b> <i>{'–ú—É–∂—Å–∫–æ–π ‚ôÇÔ∏è' if gender == '–º' else '–ñ–µ–Ω—Å–∫–∏–π ‚ôÄÔ∏è'}</i>\n"
        f"üçΩ <b>–ì–æ–ª–æ–¥:</b> <i>{hunger}/100</i>\n"
        f"üòä <b>–°—á–∞—Å—Ç—å–µ:</b> <i>{happiness}/100</i>\n"
        f"ü•´ <b>–ï–¥–∞:</b> <i>{food} —à—Ç.</i>\n\n"
        f"üë®‚Äçüë©‚Äçüëß <b>–†–æ–¥–∏—Ç–µ–ª–∏:</b>\n"
        f"1. <a href='tg://user?id={p1}'>{p1_name}</a>\n"
        f"2. <a href='tg://user?id={p2}'>{p2_name}</a>"
    )

    # –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ ‚Äî –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
    keyboard = InlineKeyboardMarkup([
        [
            InlineKeyboardButton("üçΩ –ü–æ–∫–æ—Ä–º–∏—Ç—å", callback_data=f"feed_kid:{kid_id}"),
            InlineKeyboardButton("üè† –°–¥–∞—Ç—å –≤ –¥–µ—Ç–¥–æ–º", callback_data=f"remove_kid:{kid_id}")
        ],
        [
            InlineKeyboardButton("üé≤ –ü–æ–∏–≥—Ä–∞—Ç—å", callback_data=f"play_kid:{kid_id}"),
            InlineKeyboardButton("üõí –ö—É–ø–∏—Ç—å –µ–¥—É", callback_data=f"buy_food:{kid_id}")
        ],
        [
            InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="back_to_list")
        ]
    ])

    return text, keyboard


async def send_kids_list(update, context, source, user_id, user, page=1, edit=False):
    print(f"–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–ø–∏—Å–∫–∞ –¥–µ—Ç–µ–π, —Å—Ç—Ä–∞–Ω–∏—Ü–∞ {page}")  # –û—Ç–ª–∞–¥–æ—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∫–æ–Ω—Å–æ–ª—å

    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    cursor.execute("""
        SELECT kid_id, name FROM kids
        WHERE parent1_id = ? OR parent2_id = ?
    """, (user_id, user_id))
    kids = cursor.fetchall()
    conn.close()

    total_kids = len(kids)
    ITEMS_PER_PAGE = 6
    total_pages = max(1, (total_kids + ITEMS_PER_PAGE - 1) // ITEMS_PER_PAGE)

    page = max(1, min(page, total_pages))

    start = (page - 1) * ITEMS_PER_PAGE
    end = start + ITEMS_PER_PAGE
    page_kids = kids[start:end]

    keyboard = []

    if total_kids == 0:
        text = "üë∂ –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –¥–µ—Ç–µ–π."
        keyboard.append([InlineKeyboardButton("–ù–µ—Ç –¥–µ—Ç–µ–π", callback_data="no_action")])
    else:
        for kid_id, name in page_kids:
            keyboard.append([InlineKeyboardButton(name, callback_data=f"view_kid:{kid_id}")])

        nav_buttons = []
        if page > 1:
            nav_buttons.append(InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data=f"kids_page:{page - 1}"))
        if page < total_pages:
            nav_buttons.append(InlineKeyboardButton("–í–ø–µ—Ä—ë–¥ ‚û°Ô∏è", callback_data=f"kids_page:{page + 1}"))

        if nav_buttons:
            keyboard.append(nav_buttons)

        text = (
            "üë∂ <b>–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–±–µ–Ω–∫–∞</b>\n"
            f"üìÑ –°—Ç—Ä–∞–Ω–∏—Ü–∞ <b>{page}</b> –∏–∑ <b>{total_pages}</b>\n"
            "\n"
            "üîß <b>–û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</b>\n"
            f"‚Ä¢ üë∂ –ö–æ–ª-–≤–æ –¥–µ—Ç–µ–π: <b>{total_kids}</b>\n"
            f"‚Ä¢ üìÑ –í—Å–µ–≥–æ —Å—Ç—Ä–∞–Ω–∏—Ü: <b>{total_pages}</b>\n"
            f"‚Ä¢ üìç –¢–µ–∫—É—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞: <b>{page}</b>\n"
            f"‚Ä¢ üß≠ –°—Ç—Ä–µ–ª–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏: <b>{'‚úÖ' if nav_buttons else '‚ùå'}</b>"
        )

    reply_markup = InlineKeyboardMarkup(keyboard)

    try:
        if edit:
            await source.edit_message_text(
                text=text,
                reply_markup=reply_markup,
                parse_mode="HTML"
            )
        else:
            await source.reply_text(
                text=text,
                reply_markup=reply_markup,
                parse_mode="HTML"
            )
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}")
        try:
            await source.answer("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ")
        except:
            pass


async def kids_callback_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    print(f"–ü–æ–ª—É—á–µ–Ω –∫–æ–ª–ª–±—ç–∫: {query.data}")

    try:
        await query.answer()

        data = query.data
        user = query.from_user

        if data.startswith("kids_page:"):
            page = int(data.split(":")[1])
            print(f"–ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É: {page}")
            await send_kids_list(update, context, query, str(user.id), user, page=page, edit=True)

        elif data.startswith("view_kid:"):
            kid_id = data.split(":")[1]
            print(f"–í—ã–±—Ä–∞–Ω —Ä–µ–±–µ–Ω–æ–∫ —Å ID: {kid_id}")
            await query.edit_message_text(
                f"‚úÖ –í—ã –≤—ã–±—Ä–∞–ª–∏ —Ä–µ–±–µ–Ω–∫–∞ —Å ID: <code>{kid_id}</code>",
                parse_mode="HTML"
            )

    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ –∫–æ–ª–ª–±—ç–∫–∞: {e}")
        await query.answer("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞")


async def baby(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    user_id = str(user.id)

    await send_kids_list(update, context, update.message, user_id, user)


async def baby_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    data = query.data

    user_id = str(query.from_user.id)

    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    # üîí –ó–∞—â–∏—Ç–∞ –æ—Ç —á—É–∂–∏—Ö –Ω–∞–∂–∞—Ç–∏–π
    if any(data.startswith(prefix) for prefix in
           ["feed_kid:", "play_kid:", "remove_kid:", "confirm_remove_kid:", "cancel_remove_kid:", "buy_food:",
            "view_kid:"]):
        kid_id = data.split(":")[1]
        cursor.execute("SELECT parent1_id, parent2_id FROM kids WHERE kid_id = ?", (kid_id,))
        parents = cursor.fetchone()
        if not parents:
            await query.answer("‚ùó –†–µ–±–µ–Ω–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω.", show_alert=True)
            conn.close()
            return

        p1, p2 = map(str, parents)
        if user_id != p1 and user_id != p2:
            await query.answer("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –Ω–∞ –¥–µ–π—Å—Ç–≤–∏—è —Å —ç—Ç–∏–º —Ä–µ–±–µ–Ω–∫–æ–º.", show_alert=True)
            conn.close()
            return

    elif data.startswith("confirm_baby") or data.startswith("decline_baby"):
        parts = data.split(":")
        if len(parts) >= 3:
            u1, u2 = parts[1], parts[2]
            if user_id != u1 and user_id != u2:
                await query.answer("‚ùå –¢–æ–ª—å–∫–æ –æ–¥–∏–Ω –∏–∑ –±—É–¥—É—â–∏—Ö —Ä–æ–¥–∏—Ç–µ–ª–µ–π –º–æ–∂–µ—Ç —ç—Ç–æ —Å–¥–µ–ª–∞—Ç—å.", show_alert=True)
                conn.close()
                return

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Ä–æ–∂–¥–µ–Ω–∏—è
    elif data.startswith("confirm_baby") or data.startswith("decline_baby"):
        parts = data.split(":")
        if len(parts) >= 3:
            u1, u2 = parts[1], parts[2]
            if user_id != u1 and user_id != u2:
                await query.answer("‚ùå –¢–æ–ª—å–∫–æ –æ–¥–∏–Ω –∏–∑ –±—É–¥—É—â–∏—Ö —Ä–æ–¥–∏—Ç–µ–ª–µ–π –º–æ–∂–µ—Ç —ç—Ç–æ —Å–¥–µ–ª–∞—Ç—å.", show_alert=True)
                return

    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    if data.startswith("confirm_baby"):
        _, u1, u2, name, gender = data.split(":")
        birthday = int(time.time())
        hunger = 100
        happiness = 100
        food = 0  # –ù–∞—á–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥—ã
        cursor.execute("""
            INSERT INTO kids (name, gender, birthday, parent1_id, parent2_id, hunger, happiness, food)
            VALUES (?, ?, ?, ?, ?, ?, ?, ?)
        """, (name, gender, birthday, u1, u2, hunger, happiness, food))
        conn.commit()
        await query.edit_message_text(
            f"üë∂ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –£ –≤–∞—Å —Ä–æ–¥–∏–ª—Å—è —Ä–µ–±–µ–Ω–æ–∫: {name} ({'–ú—É–∂—Å–∫–æ–π' if gender == '–º' else '–ñ–µ–Ω—Å–∫–∏–π'})"
        )

    elif data.startswith("decline_baby"):
        await query.edit_message_text("‚ùå –í–∞—à–∞ –≤—Ç–æ—Ä–∞—è –ø–æ–ª–æ–≤–∏–Ω–∫–∞ –æ—Ç–∫–∞–∑–∞–ª–∞—Å—å –∑–∞–≤–æ–¥–∏—Ç—å —Ä–µ–±–µ–Ω–∫–∞.")

    elif data.startswith("view_kid"):
        _, kid_id = data.split(":")
        text, keyboard = format_kid_info(kid_id, cursor)
        if text is None:
            await query.answer("‚ùó –†–µ–±–µ–Ω–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω.", show_alert=True)
            return
        await query.edit_message_text(text, reply_markup=keyboard, parse_mode="HTML")

    if data.startswith("remove_kid:"):
        _, kid_id = data.split(":")
        cursor.execute("SELECT name, birthday FROM kids WHERE kid_id = ?", (kid_id,))
        kid = cursor.fetchone()
        if not kid:
            await query.answer("‚ùó –†–µ–±–µ–Ω–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω.", show_alert=True)
            return
        name, birthday = kid
        age = int((time.time() - birthday) / 86400 // 365)
        birth_str = time.strftime("%d.%m.%Y", time.localtime(birthday))

        text = (
            f"‚ùó <b>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è</b> ‚ùó\n\n"
            f"–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–µ–±–µ–Ω–∫–∞ –≤ –¥–µ—Ç—Å–∫–∏–π –¥–æ–º?\n\n"
            f"üë∂ <b>–ò–º—è:</b> {name}\n"
            f"üìÖ <b>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è:</b> {birth_str}\n"
            f"üéÇ <b>–í–æ–∑—Ä–∞—Å—Ç:</b> {age} {('–≥–æ–¥' if age == 1 else '–≥–æ–¥–∞' if 1 < age < 5 else '–ª–µ—Ç')}\n\n"
            f"‚ö†Ô∏è <i>–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –±—É–¥–µ—Ç –æ—Ç–º–µ–Ω–∏—Ç—å!</i>"
        )

        keyboard = InlineKeyboardMarkup([
            [
                InlineKeyboardButton("‚úÖ –î–∞", callback_data=f"confirm_remove_kid:{kid_id}"),
                InlineKeyboardButton("‚ùå –ù–µ—Ç", callback_data=f"cancel_remove_kid:{kid_id}")
            ]
        ])

        await query.edit_message_text(text, reply_markup=keyboard, parse_mode="HTML")

    elif data.startswith("confirm_remove_kid:"):
        _, kid_id = data.split(":")
        cursor.execute("SELECT name FROM kids WHERE kid_id = ?", (kid_id,))
        kid = cursor.fetchone()
        if not kid:
            await query.answer("‚ùó –†–µ–±–µ–Ω–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω.", show_alert=True)
            return

        name = kid[0]

        # –£–¥–∞–ª—è–µ–º —Ä–µ–±–µ–Ω–∫–∞
        cursor.execute("DELETE FROM kids WHERE kid_id = ?", (kid_id,))
        conn.commit()

        await query.edit_message_text(
            f"üë∂ –†–µ–±–µ–Ω–æ–∫ <b>{name}</b> –±—ã–ª —Å–¥–∞–Ω –≤ –¥–µ—Ç–¥–æ–º.", parse_mode="HTML"
        )

    elif data.startswith("cancel_remove_kid:"):
        await query.answer("üö´ –î–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.")
        await query.edit_message_text("‚ùå –û—Ç–º–µ–Ω–∞. –†–µ–±–µ–Ω–æ–∫ –Ω–µ –±—ã–ª —Å–¥–∞–Ω –≤ –¥–µ—Ç–¥–æ–º.")

    elif data.startswith("feed_kid"):
        _, kid_id = data.split(":")
        cursor.execute(
            "SELECT hunger, food, age, name, gender, birthday, parent1_id, parent2_id, happiness FROM kids WHERE kid_id = ?",
            (kid_id,))
        result = cursor.fetchone()
        if not result:
            await query.answer("‚ùó –†–µ–±–µ–Ω–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω.", show_alert=True)
            return
        hunger, food, age, name, gender, birthday, p1, p2, happiness = result

        if food <= 0:
            await query.answer("‚ùó –£ —Ä–µ–±–µ–Ω–∫–∞ –Ω–µ—Ç –µ–¥—ã –¥–ª—è –∫–æ—Ä–º–ª–µ–Ω–∏—è.", show_alert=True)
            return

        if hunger >= 100:
            await query.answer("‚ùó –†–µ–±–µ–Ω–æ–∫ —É–∂–µ —Å—ã—Ç.", show_alert=True)
            return

        # –£–º–µ–Ω—å—à–∞–µ–º –∑–∞–ø–∞—Å –µ–¥—ã –∏ —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –≥–æ–ª–æ–¥
        new_hunger = min(100, hunger + 20)
        new_food = food - 1

        cursor.execute("UPDATE kids SET hunger = ?, food = ? WHERE kid_id = ?", (new_hunger, new_food, kid_id))
        conn.commit()

        await query.answer("üçΩ –í—ã –ø–æ–∫–æ—Ä–º–∏–ª–∏ —Ä–µ–±–µ–Ω–∫–∞. –ï–≥–æ –≥–æ–ª–æ–¥ —É–º–µ–Ω—å—à–∏–ª—Å—è.", show_alert=False)

        # –ü–µ—Ä–µ–≤–æ–¥–∏–º –≤–æ–∑—Ä–∞—Å—Ç –∏–∑ –¥–µ—Ç—Å–∫–∏—Ö —á–∞—Å–æ–≤ –≤ –¥–Ω–∏ –∏ —á–∞—Å—ã
        days = int(age // 24)
        hours = int(age % 24)
        birth_str = time.strftime("%d.%m.%Y", time.localtime(birthday))

        cursor.execute("SELECT first_name FROM users WHERE user_id = ?", (p1,))
        p1_row = cursor.fetchone()
        p1_name = p1_row[0] if p1_row and p1_row[0] else "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"

        cursor.execute("SELECT first_name FROM users WHERE user_id = ?", (p2,))
        p2_row = cursor.fetchone()
        p2_name = p2_row[0] if p2_row and p2_row[0] else "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"

        text = (
            f"üë∂ <b><u>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–µ–±–µ–Ω–∫–µ</u></b>\n\n"
            f"üß∏ <b>–ò–º—è:</b> <i>{name}</i>\n"
            f"üìÖ <b>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è:</b> <i>{birth_str}</i>\n"
            f"üéÇ <b>–í–æ–∑—Ä–∞—Å—Ç:</b> <i>{days} –¥–Ω. {hours} —á.</i>\n"
            f"üöª <b>–ü–æ–ª:</b> <i>{'–ú—É–∂—Å–∫–æ–π ‚ôÇÔ∏è' if gender == '–º' else '–ñ–µ–Ω—Å–∫–∏–π ‚ôÄÔ∏è'}</i>\n"
            f"üçΩ <b>–ì–æ–ª–æ–¥:</b> <i>{new_hunger}/100</i>\n"
            f"üòä <b>–°—á–∞—Å—Ç—å–µ:</b> <i>{happiness}/100</i>\n"
            f"ü•´ <b>–ï–¥–∞:</b> <i>{new_food} —à—Ç.</i>\n\n"
            f"üë®‚Äçüë©‚Äçüëß <b>–†–æ–¥–∏—Ç–µ–ª–∏:</b>\n"
            f"1. <a href='tg://user?id={p1}'>{p1_name}</a>\n"
            f"2. <a href='tg://user?id={p2}'>{p2_name}</a>"
        )

        keyboard = InlineKeyboardMarkup([
            [
                InlineKeyboardButton("üçΩ –ü–æ–∫–æ—Ä–º–∏—Ç—å", callback_data=f"feed_kid:{kid_id}"),
                InlineKeyboardButton("üè† –°–¥–∞—Ç—å –≤ –¥–µ—Ç–¥–æ–º", callback_data=f"remove_kid:{kid_id}")
            ],
            [
                InlineKeyboardButton("üé≤ –ü–æ–∏–≥—Ä–∞—Ç—å", callback_data=f"play_kid:{kid_id}"),
                InlineKeyboardButton("üõí –ö—É–ø–∏—Ç—å –µ–¥—É", callback_data=f"buy_food:{kid_id}")
            ],
            [
                InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="back_to_list")
            ]
        ])

        await query.edit_message_text(text, reply_markup=keyboard, parse_mode="HTML")


    elif data.startswith("play_kid"):
        _, kid_id = data.split(":")
        cursor.execute("SELECT happiness, hunger FROM kids WHERE kid_id = ?", (kid_id,))
        result = cursor.fetchone()
        if not result:
            await query.answer("‚ùó –†–µ–±–µ–Ω–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω.", show_alert=True)
            return
        happiness, hunger = result

        if happiness >= 100:
            await query.answer("‚ùó –†–µ–±–µ–Ω–æ–∫ —É–∂–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —Å—á–∞—Å—Ç–ª–∏–≤.", show_alert=True)
            return

        if hunger <= 60:
            await query.answer("‚ùó –†–µ–±–µ–Ω–æ–∫ —Å–ª–∏—à–∫–æ–º –≥–æ–ª–æ–¥–µ–Ω, —á—Ç–æ–±—ã –∏–≥—Ä–∞—Ç—å.", show_alert=True)
            return

        if hunger < 3:
            await query.answer("‚ùó –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –µ–¥—ã, —á—Ç–æ–±—ã –∏–≥—Ä–∞—Ç—å.", show_alert=True)
            return

        new_happiness = min(100, happiness + 10)
        new_hunger = hunger - 3

        cursor.execute("UPDATE kids SET happiness = ?, hunger = ? WHERE kid_id = ?",
                       (new_happiness, new_hunger, kid_id))
        conn.commit()

        await query.answer("üé≤ –í—ã –ø–æ–∏–≥—Ä–∞–ª–∏ —Å —Ä–µ–±–µ–Ω–∫–æ–º. –û–Ω —Å—Ç–∞–ª —Å—á–∞—Å—Ç–ª–∏–≤–µ–µ –∏ –Ω–µ–º–Ω–æ–≥–æ –ø—Ä–æ–≥–æ–ª–æ–¥–∞–ª—Å—è.", show_alert=True)

        # –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –≤–∞—à—É —Ñ—É–Ω–∫—Ü–∏—é
        text, keyboard = format_kid_info(kid_id, cursor)
        await query.edit_message_text(text, reply_markup=keyboard, parse_mode="HTML")

    elif data.startswith("buy_food"):
        _, kid_id = data.split(":")
        user_id = query.from_user.id

        # –ü–æ–ª—É—á–∞–µ–º –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        cursor.execute("SELECT balance FROM users WHERE user_id = ?", (user_id,))
        result = cursor.fetchone()
        if not result:
            await query.answer("‚ùó –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω.", show_alert=True)
            return
        balance = result[0]

        food_price = 5000
        if balance < food_price:
            await query.answer("‚ùó –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –¥–ª—è –ø–æ–∫—É–ø–∫–∏ –µ–¥—ã.", show_alert=True)
            return

        # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥—ã —É —Ä–µ–±–µ–Ω–∫–∞
        cursor.execute("SELECT food FROM kids WHERE kid_id = ?", (kid_id,))
        kid_food = cursor.fetchone()
        if not kid_food:
            await query.answer("‚ùó –†–µ–±–µ–Ω–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω.", show_alert=True)
            return

        current_food = kid_food[0]

        if current_food >= 100:
            await query.answer(f"üçΩ –£ –≤–∞—Å —É–∂–µ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –µ–¥—ã: {current_food}", show_alert=True)
            return

        new_food = current_food + 10
        if new_food > 100:
            new_food = 100

        new_balance = balance - food_price

        # –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–∑—É
        cursor.execute("UPDATE kids SET food = ? WHERE kid_id = ?", (new_food, kid_id))
        cursor.execute("UPDATE users SET balance = ? WHERE user_id = ?", (new_balance, user_id))
        conn.commit()

        await query.answer("üõí –í—ã –∫—É–ø–∏–ª–∏ 10 –µ–¥–∏–Ω–∏—Ü –µ–¥—ã –¥–ª—è —Ä–µ–±–µ–Ω–∫–∞.", show_alert=True)

        # –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –Ω–æ–≤–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
        text, keyboard = format_kid_info(kid_id, cursor)
        await query.edit_message_text(text, reply_markup=keyboard, parse_mode="HTML")


    elif data == "back_to_list":
        user_id = str(query.from_user.id)
        user = query.from_user
        await send_kids_list(update, context, query, user_id, user, edit=True)
    conn.close()


async def scheduled_kid_status_update(context):
    conn = sqlite3.connect("FernieUI.db")
    cursor = conn.cursor()

    now = int(time.time())
    cursor.execute("SELECT kid_id, hunger, happiness, last_updated FROM kids")
    kids = cursor.fetchall()

    for kid_id, hunger, happiness, last_updated in kids:
        if not last_updated:
            last_updated = now

        intervals = (now - last_updated) // (30 * 60)  # –∫–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç
        if intervals > 0:
            decrement = intervals * 2
            new_hunger = max(0, hunger - decrement)
            new_happiness = max(0, happiness - decrement)

            cursor.execute("""
                UPDATE kids
                SET hunger = ?, happiness = ?, last_updated = ?
                WHERE kid_id = ?
            """, (new_hunger, new_happiness, now, kid_id))

    conn.commit()
    conn.close()


TASK_COLLAB = "taskcollaboration.json"

# --- –ó–∞–¥–∞–Ω–∏—è –∏ –Ω–∞–≥—Ä–∞–¥—ã ---
TASKS = {
    "subscribe_fzgamenews": {
        "title": "–ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ Telegram",
        "description": "–ü–æ–¥–ø–∏—à–∏—Ç–µ—Å—å –Ω–∞ Telegram –∫–∞–Ω–∞–ª –ø–∞—Ä—Ç–Ω—ë—Ä–∞.",
        "reward": {
            "balance": 50000,
            "dc_balance": 250,
            "seeds": 500
        },
        "channel_id": -1002526234935,
        "channel_link": "https://t.me/fzgamenews"
    },
    "subscribe_fernieUI": {
        "title": "–ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ Telegram",
        "description": "–ü–æ–¥–ø–∏—à–∏—Ç–µ—Å—å –Ω–∞ –Ω–∞—à –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π Telegram –∫–∞–Ω–∞–ª.",
        "reward": {
            "balance": 50000,
            "dc_balance": 250,
            "seeds": 500
        },
        "channel_id": -1002034551684,
        "channel_link": "https://t.me/FernieX"
    }
}


# --- –†–∞–±–æ—Ç–∞ —Å –±–∞–∑–æ–π –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π ---
def load_completed_tasks():
    if not os.path.exists(TASK_COLLAB):
        return {}
    with open(TASK_COLLAB, "r", encoding="utf-8") as f:
        return json.load(f)


def save_completed_tasks(db):
    with open(TASK_COLLAB, "w", encoding="utf-8") as f:
        json.dump(db, f, ensure_ascii=False, indent=2)


def has_completed_task(user_id: int, task_id: str) -> bool:
    db = load_completed_tasks()
    return str(user_id) in db and task_id in db[str(user_id)]


def mark_task_completed(user_id: int, task_id: str):
    db = load_completed_tasks()
    uid = str(user_id)
    if uid not in db:
        db[uid] = []
    if task_id not in db[uid]:
        db[uid].append(task_id)
    save_completed_tasks(db)


# --- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–∞–≥—Ä–∞–¥—ã –≤ –±–∞–∑—É ---
def add_rewards_to_user(user_id: int, balance=0, dc=0, seeds=0):
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("""
        UPDATE users SET
            balance = balance + ?,
            dc_balance = dc_balance + ?,
            seeds = seeds + ?
        WHERE user_id = ?
    """, (balance, dc, seeds, str(user_id)))
    conn.commit()
    conn.close()


async def back_to_profile_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    print("BACK TO PROFILE HANDLER TRIGGERED")
    await show_profile(update, context)


async def collab(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    keyboard = [
        [InlineKeyboardButton(text="‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è", callback_data="collab_info")],
        [InlineKeyboardButton(text="üìù –ó–∞–¥–∞–Ω–∏—è", callback_data="collab_tasks")],
        [InlineKeyboardButton(text="üîô –ù–∞–∑–∞–¥", callback_data="back_to_profile_is_collab")],
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)

    welcome_text = (
        "ü§ù <b>–ö–æ–ª–ª–∞–±–æ—Ä–∞—Ü–∏—è FanzyGames √ó FernieUI</b>\n\n"
        "‚ú® –ì–æ—Ç–æ–≤ –ø—Ä–∏–Ω—è—Ç—å —É—á–∞—Å—Ç–∏–µ –≤ —Å–æ–≤–º–µ—Å—Ç–Ω–æ–º —Å–æ–±—ã—Ç–∏–∏?\n"
        "<pre>üìÇ | –í—ã–±–µ—Ä–∏ —Ä–∞–∑–¥–µ–ª –Ω–∏–∂–µ, —á—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏:</pre>"
    )
    await query.edit_message_text(
        text=welcome_text,
        reply_markup=reply_markup,
        parse_mode="HTML"
    )


# --- –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–æ–∫ ---
async def button_handler_colabsystem(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    user_id = query.from_user.id
    data = query.data

    if data == "collab_info":
        keyboard = [[InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="collab_back")]]
        info_text = (
            "‚ÑπÔ∏è <b>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–ª–ª–∞–±–æ—Ä–∞—Ü–∏–∏</b> ü§ù‚ú®\n\n"
            "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —Å–æ–≤–º–µ—Å—Ç–Ω—ã–π –ø—Ä–æ–µ–∫—Ç –¥–≤—É—Ö –∏–≥—Ä–æ–≤—ã—Ö —Ç–µ–ª–µ–≥—Ä–∞–º-–±–æ—Ç–æ–≤ ‚Äî "
            "<b>FernieUI</b> üé® –∏ <b>FanzyGame</b> üéÆ! üöÄüî•\n\n"
            "–ó–∞–¥–∞–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ —Ä–∞–±–æ—Ç–∞—é—Ç –≤ –æ–±–æ–∏—Ö –±–æ—Ç–∞—Ö! üéâüéä\n\n"
            "–í—ã–ø–æ–ª–Ω—è–π—Ç–µ –∑–∞–¥–∞–Ω–∏—è üèÜ, –ø–æ–ª—É—á–∞–π—Ç–µ —ç–∫—Å–∫–ª—é–∑–∏–≤–Ω—ã–µ –±–æ–Ω—É—Å—ã üíé –∏ –ø—Ä–æ–∫–∞—á–∏–≤–∞–π—Ç–µ —Å–≤–æ–π –∏–≥—Ä–æ–≤–æ–π –æ–ø—ã—Ç –Ω–∞ –º–∞–∫—Å–∏–º—É–º! üöÄüí•\n\n"
        )
        await query.edit_message_text(
            text=info_text,
            reply_markup=InlineKeyboardMarkup(keyboard),
            parse_mode="HTML"
        )

    elif data == "collab_tasks":
        keyboard = [
            [InlineKeyboardButton(f"üìå {task['title']}", callback_data=f"collab_task_{task_id}")]
            for task_id, task in TASKS.items()
        ]
        keyboard.append([InlineKeyboardButton("–ù–∞–∑–∞–¥", callback_data="collab_back")])
        await query.edit_message_text("üìã <b>–ó–∞–¥–∞–Ω–∏—è –∫–æ–ª–ª–∞–±–æ—Ä–∞—Ü–∏–∏</b>",
                                      reply_markup=InlineKeyboardMarkup(keyboard),
                                      parse_mode="HTML")

    elif data.startswith("collab_task_"):
        task_id = data[len("collab_task_"):]
        if task_id not in TASKS:
            await query.answer("–ó–∞–¥–∞–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ", show_alert=True)
            return

        if has_completed_task(user_id, task_id):
            # –í–º–µ—Å—Ç–æ –∑–∞–º–µ–Ω—ã —Ç–µ–∫—Å—Ç–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–ø–ª—ã–≤–∞—é—â–µ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            await query.answer("–í—ã —É–∂–µ –≤—ã–ø–æ–ª–Ω–∏–ª–∏ —ç—Ç–æ –∑–∞–¥–∞–Ω–∏–µ.", show_alert=True)
            return

        task = TASKS[task_id]
        keyboard = []
        if "channel_link" in task:
            keyboard.append([InlineKeyboardButton("üîó –°—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞–Ω–∞–ª", url=task["channel_link"])])
        keyboard.append([InlineKeyboardButton("‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å", callback_data=f"collab_check_{task_id}")])
        keyboard.append([InlineKeyboardButton("–ù–∞–∑–∞–¥", callback_data="collab_tasks")])

        text = (
            f"üìã –ó–∞–¥–∞–Ω–∏—è –∫–æ–ª–ª–∞–±–æ—Ä–∞—Ü–∏–∏.\n\n"
            f"# | {task['title']}\n\n"
            f"üí° <b>–°—É—Ç—å –∑–∞–¥–∞–Ω–∏—è:</b>\n{task['description']}\n\n"
            f"üéÅ <b>–ù–∞–≥—Ä–∞–¥–∞ –∑–∞ –∑–∞–¥–∞–Ω–∏–µ:</b>\n"
            f"‚Ä¢ {task['reward'].get('balance', 0):,} ‚ÇΩ\n"
            f"‚Ä¢ {task['reward'].get('dc_balance', 0)} DC\n"
            f"‚Ä¢ {task['reward'].get('seeds', 0)} –°–µ–º—è–Ω"
        )
        await query.edit_message_text(text, reply_markup=InlineKeyboardMarkup(keyboard), parse_mode="HTML")


    elif data.startswith("collab_check_"):
        task_id = data[len("collab_check_"):]
        if task_id not in TASKS:
            await query.answer("–ó–∞–¥–∞–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ", show_alert=True)
            return
        if has_completed_task(user_id, task_id):
            await query.answer("–≠—Ç–æ –∑–∞–¥–∞–Ω–∏–µ —É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ ‚úÖ", show_alert=True)
            return

        task = TASKS[task_id]

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å–ª–∏ –∑–∞–¥–∞–Ω–∏–µ —Å–≤—è–∑–∞–Ω–æ —Å –∫–∞–Ω–∞–ª–æ–º, –ø–æ–¥–ø–∏—Å–∞–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        if "channel_id" in task:
            try:
                member = await context.bot.get_chat_member(chat_id=task["channel_id"], user_id=user_id)
                if member.status in ['member', 'administrator', 'creator']:
                    # –ó–∞—á–∏—Å–ª—è–µ–º –Ω–∞–≥—Ä–∞–¥—ã –∏ –æ—Ç–º–µ—á–∞–µ–º –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–µ
                    mark_task_completed(user_id, task_id)
                    add_rewards_to_user(
                        user_id,
                        balance=task["reward"].get("balance", 0),
                        dc=task["reward"].get("dc_balance", 0),
                        seeds=task["reward"].get("seeds", 0)
                    )
                    keyboard = [[InlineKeyboardButton("üìã –ö –∑–∞–¥–∞–Ω–∏—è–º", callback_data="collab_tasks")]]
                    await query.edit_message_text(
                        text=(
                            "‚úÖ <b>–ó–∞–¥–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ!</b>\n\n"
                            "üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –≤—ã–ø–æ–ª–Ω–∏–ª–∏ –æ–¥–Ω–æ –∏–∑ –∑–∞–¥–∞–Ω–∏–π –∫–æ–ª–ª–∞–±–æ—Ä–∞—Ü–∏–∏.\n"
                            "üéÅ –ù–∞–≥—Ä–∞–¥—ã –±—ã–ª–∏ –Ω–∞—á–∏—Å–ª–µ–Ω—ã –Ω–∞ –≤–∞—à –∞–∫–∫–∞—É–Ω—Ç.\n\n"
                            "–ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –≤—ã–ø–æ–ª–Ω—è—Ç—å –∑–∞–¥–∞–Ω–∏—è –∏ —Å–æ–±–∏—Ä–∞–π—Ç–µ –±–æ–Ω—É—Å—ã! üöÄ"
                        ),
                        reply_markup=InlineKeyboardMarkup(keyboard),
                        parse_mode="HTML"
                    )

                else:
                    raise Exception("not a member")
            except Exception:
                keyboard = []
                if "channel_link" in task:
                    keyboard.append([InlineKeyboardButton("üîó –°—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞–Ω–∞–ª", url=task["channel_link"])])
                keyboard.append([InlineKeyboardButton("‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å", callback_data=f"collab_check_{task_id}")])
                keyboard.append([InlineKeyboardButton("–ù–∞–∑–∞–¥", callback_data="collab_tasks")])

                text = (
                    f"üìã –ó–∞–¥–∞–Ω–∏—è –∫–æ–ª–ª–∞–±–æ—Ä–∞—Ü–∏–∏.\n\n"
                    f"# | {task['title']}\n\n"
                    f"üí° <b>–°—É—Ç—å –∑–∞–¥–∞–Ω–∏—è:</b>\n{task['description']}\n\n"
                    f"‚ùå <b>–í–´ –ù–ï –í–´–ü–û–õ–ù–ò–õ–ò –ó–ê–î–ê–ù–ò–ï</b>"
                )
                await query.edit_message_text(text, reply_markup=InlineKeyboardMarkup(keyboard), parse_mode="HTML")
        else:
            await query.answer("–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è —ç—Ç–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞", show_alert=True)

    elif data == "collab_back":
        keyboard = [
            [InlineKeyboardButton("‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è", callback_data="collab_info")],
            [InlineKeyboardButton("üìù –ó–∞–¥–∞–Ω–∏—è", callback_data="collab_tasks")],
            [InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="back_to_profile_is_collab")],
        ]
        welcome_text = (
            "ü§ù <b>–ö–æ–ª–ª–∞–±–æ—Ä–∞—Ü–∏—è FanzyGames √ó FernieUI</b>\n\n"
            "‚ú® –ì–æ—Ç–æ–≤ –ø—Ä–∏–Ω—è—Ç—å —É—á–∞—Å—Ç–∏–µ –≤ —Å–æ–≤–º–µ—Å—Ç–Ω–æ–º —Å–æ–±—ã—Ç–∏–∏?\n"
            "<pre>üìÇ | –í—ã–±–µ—Ä–∏ —Ä–∞–∑–¥–µ–ª –Ω–∏–∂–µ, —á—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏:</pre>"
        )
        await query.edit_message_text(
            text=welcome_text,
            reply_markup=InlineKeyboardMarkup(keyboard),
            parse_mode="HTML"
        )


def is_user_in_db(user_id: int) -> bool:
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT 1 FROM referals WHERE user_id = ?", (user_id,))
    result = cursor.fetchone()
    conn.close()
    return result is not None


def add_user_if_not_exists(user_id: int, bot_username: str):
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    ref_link = f"https://t.me/{bot_username}?start={user_id}"
    cursor.execute("""
        INSERT OR IGNORE INTO referals (user_id, ref_link, quantity)
        VALUES (?, ?, 0);
    """, (user_id, ref_link))
    conn.commit()
    conn.close()


def migrate_referals_table():
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    # –ü—Ä–æ–≤–µ—Ä–∏, –µ—Å—Ç—å –ª–∏ –∫–æ–ª–æ–Ω–∫–∞
    cursor.execute("PRAGMA table_info(referals)")
    columns = [column[1] for column in cursor.fetchall()]

    if "ref_link" not in columns:
        cursor.execute("ALTER TABLE referals ADD COLUMN ref_link TEXT")
        print("‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ ref_link")

    if "quantity" not in columns:
        cursor.execute("ALTER TABLE referals ADD COLUMN quantity INTEGER DEFAULT 0")
        print("‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ quantity")

    conn.commit()
    conn.close()



def increment_referral(user_id: int):
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("""
        UPDATE referals
        SET quantity = quantity + 1
        WHERE user_id = ?;
    """, (user_id,))
    conn.commit()
    conn.close()


def get_user_referral_info(user_id: int):
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("""
        SELECT ref_link, quantity FROM referals WHERE user_id = ?;
    """, (user_id,))
    row = cursor.fetchone()
    conn.close()
    if row:
        return row[0], row[1]
    return None, 0


async def show_referrals_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    user = update.effective_user
    user_id = user.id

    add_user_if_not_exists(user_id, BOT_USERNAME)
    ref_link, count = get_user_referral_info(user_id)

    reward_per_ref = 25000
    total_earned = count * reward_per_ref
    total_earned_str = f"{total_earned:,}".replace(",", ".")

    text = (
        "üéÅ <b>–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞</b>\n\n"
        f"üë• –í—ã –ø—Ä–∏–≥–ª–∞—Å–∏–ª–∏: <b>{count}</b> —á–µ–ª.\n"
        f"üí∞ –ù–∞–≥—Ä–∞–¥–∞ –∑–∞ 1 —á–µ–ª.: <b>{reward_per_ref:,} ‚ÇΩ</b>\n"
        f"üí∏ –ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ —Å —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤: <b>{total_earned_str} ‚ÇΩ</b>\n\n"
        "üîó <b>–í–∞—à–∞ —Å—Å—ã–ª–∫–∞:</b>\n"
        f"<code>{ref_link}</code>"
    )

    buttons = InlineKeyboardMarkup([
        [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="show_profile")]
    ])

    try:
        # –ü—ã—Ç–∞–µ–º—Å—è –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
        await query.edit_message_text(text, reply_markup=buttons, parse_mode="HTML")
    except:
        # –ï—Å–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–µ–ª—å–∑—è (—Å–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ), –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ
        await query.message.delete()  # –±–µ–∑–æ–ø–∞—Å–Ω–æ —É–¥–∞–ª–∏—Ç—å, –µ—Å–ª–∏ –µ—Å—Ç—å
        await query.message.chat.send_message(text=text, reply_markup=buttons, parse_mode="HTML")


async def register_new_user(user_id: int, ref_id: int, username: str, bot):
    if is_user_in_db(user_id):
        return  # —É–∂–µ –µ—Å—Ç—å

    ref_link = f"https://t.me/{BOT_USERNAME}?start={user_id}"
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("""
        INSERT INTO referals (user_id, ref_link, quantity)
        VALUES (?, ?, 0)
    """, (user_id, ref_link))
    conn.commit()
    conn.close()

    if ref_id and ref_id != user_id and is_user_in_db(ref_id):
        increment_referral(ref_id)

        # üí∏ –ù–∞—á–∏—Å–ª—è–µ–º 25.000‚ÇΩ —Ä–µ—Ñ–µ—Ä–µ—Ä—É
        try:
            conn = sqlite3.connect(DB_PATH)
            cursor = conn.cursor()
            cursor.execute("""
                UPDATE users
                SET balance = balance + 25000
                WHERE user_id = ?;
            """, (str(ref_id),))  # user_id ‚Äî TEXT –≤ users
            conn.commit()
            conn.close()
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–∏ –Ω–∞–≥—Ä–∞–¥—ã: {e}")

        # üîî –£–≤–µ–¥–æ–º–ª—è–µ–º –ø—Ä–∏–≥–ª–∞—Å–∏–≤—à–µ–≥–æ
        try:
            await bot.send_message(
                chat_id=ref_id,
                text=f"üéâ @{username or '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'} —Å—Ç–∞–ª –≤–∞—à–∏–º —Ä–µ—Ñ–µ—Ä–∞–ª–æ–º!\nüí∞ –í—ã –ø–æ–ª—É—á–∏–ª–∏ 25.000 ‚ÇΩ!"
            )
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: {e}")


def add_robbery_cooldown_column():
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    try:
        cursor.execute("ALTER TABLE users ADD COLUMN robbery_sustem_cooldown TEXT")
        print("‚úÖ –ö–æ–ª–æ–Ω–∫–∞ 'robbery_sustem_cooldown' –¥–æ–±–∞–≤–ª–µ–Ω–∞")
    except sqlite3.OperationalError as e:
        if "duplicate column name" in str(e):
            print("‚ö†Ô∏è –ö–æ–ª–æ–Ω–∫–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç")
        else:
            print(f"‚ùå –û—à–∏–±–∫–∞: {e}")
    conn.commit()
    conn.close()


VIP_COOLDOWNS = {
    0: 60,
    1: 45,
    2: 30,
    3: 20,
    4: 10,
}

VIP_MULTIPLIERS = {
    0: 1.0,  # No VIP
    1: 1.3,  # Silver
    2: 1.6,  # Gold
    3: 2.0,  # Platinum
    4: 2.5  # Legend
}

VIP_NAMES = {
    0: "–ù–µ—Ç VIP",
    1: "VIP Silver",
    2: "VIP Gold",
    3: "VIP Platinum",
    4: "VIP Legend"
}

ROB_TARGETS = {
    'rob_bank': '–ë–∞–Ω–∫',
    'rob_casino': '–ö–∞–∑–∏–Ω–æ',
    'rob_lab': '–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è ¬´X-Fer¬ª'
}


# üé≤ –•–µ–ª–ø–µ—Ä—ã
def get_user_for_robbery(user_id: str):
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("""
        SELECT user_id, username, balance, vip_status, robbery_sustem_cooldown
        FROM users WHERE user_id = ?
    """, (user_id,))
    row = cursor.fetchone()
    conn.close()
    if not row:
        return None
    return {
        'user_id': row[0],
        'username': row[1],
        'balance': row[2],
        'vip_status': row[3],
        'robbery_sustem_cooldown': row[4]
    }


def update_user_hacking_balance(user_id: str, new_balance: int):
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("UPDATE users SET balance = ? WHERE user_id = ?", (new_balance, user_id))
    conn.commit()
    conn.close()


def update_robbery_cooldown(user_id: str, minutes: int):
    cooldown_until = (datetime.utcnow() + timedelta(minutes=minutes)).isoformat()
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("UPDATE users SET robbery_sustem_cooldown = ? WHERE user_id = ?", (cooldown_until, user_id))
    conn.commit()
    conn.close()


def set_hack_cooldown(user_id: str, minutes: int):
    """–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å cooldown –¥–ª—è /hack –∫–æ–º–∞–Ω–¥—ã"""
    user_id = str(user_id)

    # –ò—Å–ø–æ–ª—å–∑—É–µ–º bonus_timers –¥–ª—è hack (bonus_type = 2)
    cooldown_end = int(datetime.utcnow().timestamp()) + (minutes * 60)

    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    try:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –∑–∞–ø–∏—Å—å
        cursor.execute(
            "SELECT 1 FROM bonus_timers WHERE user_id = ? AND bonus_type = ?",
            (user_id, 2)
        )
        exists = cursor.fetchone() is not None

        if exists:
            # –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é
            cursor.execute(
                "UPDATE bonus_timers SET last_claim = ? WHERE user_id = ? AND bonus_type = ?",
                (cooldown_end, user_id, 2)
            )
        else:
            # –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å
            cursor.execute(
                "INSERT INTO bonus_timers (user_id, bonus_type, last_claim) VALUES (?, ?, ?)",
                (user_id, 2, cooldown_end)
            )

        conn.commit()
        print(f"‚úÖ Set hack cooldown for {user_id}: {minutes} minutes")

    except Exception as e:
        print(f"‚ùå Error setting hack cooldown: {e}")
    finally:
        conn.close()

def get_hack_cooldown_remaining(user_id: str) -> tuple[bool, str]:
    """–ü–æ–ª—É—á–∏—Ç—å –æ—Å—Ç–∞–≤—à–µ–µ—Å—è –≤—Ä–µ–º—è cooldown –¥–ª—è hack"""
    user_id = str(user_id)
    now_ts = int(datetime.utcnow().timestamp())

    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute(
        "SELECT last_claim FROM bonus_timers WHERE user_id = ? AND bonus_type = 2",
        (user_id,)
    )
    row = cursor.fetchone()
    conn.close()

    if row is None or row[0] is None:
        return False, ""

    cooldown_end = row[0]

    if now_ts >= cooldown_end:
        # Cooldown –∏—Å—Ç—ë–∫
        return False, ""

    # Cooldown –∞–∫—Ç–∏–≤–µ–Ω
    remaining = cooldown_end - now_ts
    minutes = remaining // 60
    seconds = remaining % 60

    return True, f"{minutes}–º {seconds}—Å"

def get_vip_multiplier(vip_status: int) -> float:
    """–ü–æ–ª—É—á–∏—Ç—å –º–Ω–æ–∂–∏—Ç–µ–ª—å –Ω–∞–≥—Ä–∞–¥—ã –ø–æ VIP —Å—Ç–∞—Ç—É—Å—É"""
    vip_multipliers = {
        0: 1.0,   # –û–±—ã—á–Ω—ã–π
        1: 1.3,   # Silver
        2: 1.6,   # Gold
        3: 2.0,   # Platinum
        4: 2.5    # Legend
    }
    return vip_multipliers.get(vip_status, 1.0)

def is_on_cooldown(user_data: dict) -> (bool, str):
    cooldown_str = user_data.get("robbery_sustem_cooldown")
    if not cooldown_str or cooldown_str in ("None", None):
        return False, ""

    try:
        cooldown_until = datetime.fromisoformat(str(cooldown_str))
    except ValueError:
        return False, ""

    now = datetime.utcnow()
    if now < cooldown_until:
        delta = cooldown_until - now
        minutes = delta.seconds // 60
        seconds = delta.seconds % 60
        return True, f"{minutes} –º–∏–Ω {seconds} —Å–µ–∫"
    return False, ""


def get_vip_cooldown(vip_status: int) -> int:
    return VIP_COOLDOWNS.get(vip_status, 60)


async def hack_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ö–æ–º–∞–Ω–¥–∞ –æ–≥—Ä–∞–±–ª–µ–Ω–∏—è"""
    user = update.effective_user
    user_id = str(user.id)
    user_data = get_user_for_robbery(user_id)

    if not user_data:
        await update.message.reply_text("‚ùó –í—ã –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –≤ —Å–∏—Å—Ç–µ–º–µ.")
        return

    # ‚úÖ –ü–†–û–í–ï–†–ö–ê COOLDOWN (–ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø)
    on_cooldown, remaining_time = get_hack_cooldown_remaining(user_id)
    if on_cooldown:
        await update.message.reply_text(
            f"‚è≥ –í—ã –Ω–µ–¥–∞–≤–Ω–æ —É–∂–µ –ø—ã—Ç–∞–ª–∏—Å—å –æ–≥—Ä–∞–±–∏—Ç—å.\n"
            f"–û–∂–∏–¥–∞–π—Ç–µ: <b>{remaining_time}</b>",
            parse_mode="HTML"
        )
        return

    # –ü–æ–ª—É—á–∞–µ–º –Ω–∏–∫
    mention_link = get_display_name_html_new(user)

    # –¢–µ–∫—Å—Ç
    text = f"{mention_link} | üö® <b>–û–≥—Ä–∞–±–ª–µ–Ω–∏–µ</b>\nüéØ <b>–í—ã–±–µ—Ä–∏—Ç–µ —Ü–µ–ª—å:</b>"

    # –ö–Ω–æ–ø–∫–∏
    buttons = [
        [InlineKeyboardButton("üè¶ –ë–∞–Ω–∫", callback_data="rob_bank")],
        [InlineKeyboardButton("üé∞ –ö–∞–∑–∏–Ω–æ", callback_data="rob_casino")],
        [InlineKeyboardButton("üß™ –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è X-Fer", callback_data="rob_lab")]
    ]

    await update.message.reply_text(
        text,
        reply_markup=InlineKeyboardMarkup(buttons),
        parse_mode="HTML"
    )


def get_user_active_vip(user_id: str) -> int:
    """–ü–æ–ª—É—á–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π VIP —É—Ä–æ–≤–µ–Ω—å"""
    user_id = str(user_id)
    now_ts = int(datetime.utcnow().timestamp())

    vip_data = get_uservip_data(user_id)
    vip_status = vip_data.get("vip_status", 0)
    vip_until = vip_data.get("vip_until", 0)

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç–∏–≤–µ–Ω –ª–∏ VIP
    if vip_until > now_ts and vip_status > 0:
        return vip_status
    return 0



async def robbery_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Callback –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ–≥—Ä–∞–±–ª–µ–Ω–∏—è"""
    query = update.callback_query
    user = query.from_user
    user_id = str(user.id)
    user_data = get_user_for_robbery(user_id)

    if not user_data:
        await query.answer("‚ùó –û—à–∏–±–∫–∞: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω.")
        return

    # ‚úÖ –ü–†–û–í–ï–†–ö–ê COOLDOWN (–ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø)
    on_cooldown, remaining_time = get_hack_cooldown_remaining(user_id)
    if on_cooldown:
        await query.answer()
        await query.edit_message_text(
            f"‚è≥ <b>–í—ã —É–∂–µ —Å–æ–≤–µ—Ä—à–∞–ª–∏ –æ–≥—Ä–∞–±–ª–µ–Ω–∏–µ.</b>\n"
            f"–û–∂–∏–¥–∞–π—Ç–µ: <b>{remaining_time}</b>",
            parse_mode="HTML"
        )
        return

    target = query.data

    # ‚úÖ –ü–û–õ–£–ß–ê–ï–ú –ê–ö–¢–ò–í–ù–´–ô VIP (–ò–°–ü–†–ê–í–õ–ï–ù–ù–û–ï)
    vip_status = get_user_active_vip(user_id)
    cooldown_minutes = get_vip_cooldown(vip_status)
    multiplier = get_vip_multiplier(vip_status)

    await query.answer()

    mention_link = get_display_name_html_new(user)

    target_names = {
        'rob_bank': '–ë–∞–Ω–∫',
        'rob_casino': '–ö–∞–∑–∏–Ω–æ',
        'rob_lab': '–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è ¬´X-Fer¬ª'
    }
    target_name = target_names.get(target, '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è —Ü–µ–ª—å')

    header = (
        f"üë§ {mention_link}\n"
        f"üö® <b>–û–≥—Ä–∞–±–ª–µ–Ω–∏–µ...</b>\n"
        f"üéØ <b>–¶–µ–ª—å:</b> ¬´{target_name}¬ª"
    )

    steps = {
        'rob_bank': [
            "üîß –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ...",
            "‚è≥ –û–∂–∏–¥–∞–µ–º –Ω—É–∂–Ω–æ–µ –≤—Ä–µ–º—è...",
            "üö™ –ü—Ä–æ–Ω–∏–∫–∞–µ–º –≤ –±–∞–Ω–∫...",
            "üí• –í–∑–ª–∞–º—ã–≤–∞–µ–º —Å–µ–π—Ñ..."
        ],
        'rob_casino': [
            "üéí –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –≤—Å—ë –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–µ...",
            "üö∂‚Äç‚ôÇÔ∏è –ü—Ä–æ–Ω–∏–∫–∞–µ–º –≤ –ö–∞–∑–∏–Ω–æ...",
            "üïµÔ∏è‚Äç‚ôÇÔ∏è –ü–æ–¥–∫—É–ø–∞–µ–º –¥–∏–ª–ª–µ—Ä–∞...",
            "üí∏ –í–∑–ª–∞–º—ã–≤–∞–µ–º –∫–∞—Å—Å—É..."
        ],
        'rob_lab': [
            "üß∞ –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –≤—Å—ë –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–µ...",
            "üß¨ –ü—Ä–æ–Ω–∏–∫–∞–µ–º –≤ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—é...",
            "üîå –û—Ç–∫–ª—é—á–∞–µ–º —Å–∏—Å—Ç–µ–º—É –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏...",
            "üíª –í–∑–ª–∞–º—ã–≤–∞–µ–º —Ç–µ—Ä–º–∏–Ω–∞–ª..."
        ]
    }

    steps_list = steps.get(target, [])
    if not steps_list:
        await query.edit_message_text("‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è —Ü–µ–ª—å –æ–≥—Ä–∞–±–ª–µ–Ω–∏—è.")
        return

    msg = await query.edit_message_text(header, parse_mode="HTML")

    # –ê–Ω–∏–º–∞—Ü–∏—è —à–∞–≥–æ–≤
    for step in steps_list:
        await asyncio.sleep(1)
        await msg.edit_text(f"{header}\n<pre>{step}</pre>", parse_mode="HTML")

    await asyncio.sleep(1.5)

    # ‚úÖ –£–°–¢–ê–ù–ê–í–õ–ò–í–ê–ï–ú COOLDOWN (–ò–°–ü–†–ê–í–õ–ï–ù–ù–û–ï)
    set_hack_cooldown(user_id, cooldown_minutes)
    print(f"üîç Set cooldown for {user_id}: {cooldown_minutes} minutes (vip_status={vip_status})")

    # –†–µ–∑—É–ª—å—Ç–∞—Ç
    success = random.randint(1, 100) <= 30

    if success:
        amount = random.randint(5000, 100000)
        final_amount = int(amount * multiplier)

        try:
            balance = int(user_data['balance']) if user_data['balance'] else 0
        except (ValueError, TypeError):
            balance = 0

        new_balance = balance + final_amount
        update_user_hacking_balance(user_id, new_balance)

        vip_note = f" (x{multiplier} ‚Äî VIP)" if multiplier > 1 else ""

        await msg.edit_text(
            f"{mention_link} | ‚úÖ <b>–£—Å–ø–µ—Ö!</b>\n"
            f"üéØ –¶–µ–ª—å: <b>{target_name}</b>\n"
            f"üí∞ –î–æ–±—ã—á–∞: <b>{format_money(final_amount)}‚ÇΩ</b>{vip_note}\n"
            f"‚è±Ô∏è Cooldown: <b>{cooldown_minutes}–º</b>",
            parse_mode="HTML"
        )

    else:
        reason = random.choice([
            "–í–∞—Å –∑–∞–º–µ—Ç–∏–ª–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ –∏ –≤—ã–∑–≤–∞–ª–∏ –ø–æ–ª–∏—Ü–∏—é.",
            "–í—ã –∑–∞–±—ã–ª–∏ –Ω—É–∂–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ.",
            "–í—ã –æ–±–ª–∞–∂–∞–ª–∏—Å—å –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –≤–∑–ª–æ–º–∞.",
            "–°—Ä–∞–±–æ—Ç–∞–ª–∞ —Å–∏–≥–Ω–∞–ª–∏–∑–∞—Ü–∏—è, –≤—ã —É–±–µ–∂–∞–ª–∏ –Ω–∏ —Å —á–µ–º."
        ])

        await msg.edit_text(
            f"{mention_link} | ‚ùå <b>–ù–µ—É–¥–∞—á–∞!</b>\n"
            f"üéØ –¶–µ–ª—å: <b>{target_name}</b>\n"
            f"üõë –ü—Ä–∏—á–∏–Ω–∞: {reason}\n"
            f"‚è±Ô∏è Cooldown: <b>{cooldown_minutes}–º</b>",
            parse_mode="HTML"
        )

async def arole_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    user_id_str = str(user.id)

    # –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Äî –∞–¥–º–∏–Ω –±–æ—Ç–∞ —Å —É—Ä–æ–≤–Ω–µ–º >= 6 (–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä)
    try:
        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()
        cursor.execute("SELECT status FROM users WHERE user_id = ?", (user_id_str,))
        row = cursor.fetchone()
        conn.close()

        if not row or row[0] < 9:
            await update.message.reply_text("‚ùå –≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º –±–æ—Ç–∞ (—Ä–∞–Ω–≥ 9 –∏ –≤—ã—à–µ).")
            return
    except Exception as e:
        await update.message.reply_text(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤: {html.escape(str(e))}")
        return

    if not context.args:
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é –≤—ã–±–æ—Ä–∞ —Ä–∞–Ω–≥–∞
        ranks_list = "\n".join([f"{i} ‚Äî {role}" for i, role in enumerate(CHAT_ADMINS_ROLE_LIST)])
        await update.message.reply_text(
            f"üìã –£–∫–∞–∂–∏—Ç–µ –Ω—É–∂–Ω—ã–π —Ä–∞–Ω–≥.\n\n{ranks_list}\n\n"
            "–ü—Ä–∏–º–µ—Ä:\n/arole 5\n(—É—Å—Ç–∞–Ω–æ–≤–∏—Ç —Ä–∞–Ω–≥ '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' –≤ —á–∞—Ç–µ –¥–ª—è –≤–∞—Å)",
            parse_mode=ParseMode.HTML
        )
        return

    # –ü–∞—Ä—Å–∏–º —Ä–∞–Ω–≥ –∏–∑ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤
    try:
        rank = int(context.args[0])
    except ValueError:
        await update.message.reply_text("‚ùó –†–∞–Ω–≥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º –æ—Ç 0 –¥–æ 7.")
        return

    if rank < 0 or rank > 7:
        await update.message.reply_text("‚ùó –†–∞–Ω–≥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º –æ—Ç 0 –¥–æ 7.")
        return

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–æ–º–∞–Ω–¥–∞ –≤—ã–∑–≤–∞–Ω–∞ –≤ –≥—Ä—É–ø–ø–æ–≤–æ–º —á–∞—Ç–µ
    chat = update.effective_chat
    if not chat or chat.type == "private":
        await update.message.reply_text("‚ùå –≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤ –≥—Ä—É–ø–ø–æ–≤—ã—Ö —á–∞—Ç–∞—Ö.")
        return

    chat_id_str = str(chat.id)

    # –û–±–Ω–æ–≤–ª—è–µ–º —É—Ä–æ–≤–µ–Ω—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –≤ chat_admins –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ç–µ–∫—É—â–µ–º —á–∞—Ç–µ
    try:
        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –∑–∞–ø–∏—Å—å, –µ—Å–ª–∏ –Ω–µ—Ç ‚Äî –≤—Å—Ç–∞–≤–ª—è–µ–º, –∏–Ω–∞—á–µ –æ–±–Ω–æ–≤–ª—è–µ–º
        cursor.execute(
            "SELECT admin_level FROM chat_admins WHERE chat_id = ? AND user_id = ?",
            (chat_id_str, user_id_str)
        )
        row = cursor.fetchone()

        if row:
            cursor.execute(
                "UPDATE chat_admins SET admin_level = ?, updated_at = CURRENT_TIMESTAMP WHERE chat_id = ? AND user_id = ?",
                (rank, chat_id_str, user_id_str)
            )
        else:
            # –ú–æ–∂–Ω–æ –ø–æ–ø—ã—Ç–∞—Ç—å—Å—è –ø–æ–ª—É—á–∏—Ç—å username –∏ –∏–º—è
            username = user.username or ""
            name = f"{user.first_name or ''} {user.last_name or ''}".strip()
            cursor.execute(
                "INSERT INTO chat_admins (chat_id, user_id, username, name, admin_level, updated_at) VALUES (?, ?, ?, ?, ?, CURRENT_TIMESTAMP)",
                (chat_id_str, user_id_str, username, name, rank)
            )
        conn.commit()
        conn.close()
    except Exception as e:
        await update.message.reply_text(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ä–∞–Ω–≥–∞: {html.escape(str(e))}")
        return

    admin_mention = get_display_name_html_new(user)

    await update.message.reply_text(
        (
            f"‚úÖ <b>–†–∞–Ω–≥ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª—ë–Ω!</b>\n\n"
            f"üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {admin_mention}\n"
            f"üè∑ –ù–æ–≤—ã–π —Ä–∞–Ω–≥: <b>{html.escape(CHAT_ADMINS_ROLE_LIST[rank])}</b>\n\n"
            f"‚ÑπÔ∏è –¢–µ–ø–µ—Ä—å —É –≤–∞—Å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –≤ —ç—Ç–æ–º —á–∞—Ç–µ."
        ),
        parse_mode=ParseMode.HTML,
        disable_web_page_preview=True
    )


async def reset_hack_cd_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    if user_id != 7406372338:
        await update.message.reply_text("‚õî –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥–µ.")
        return

    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("UPDATE users SET robbery_sustem_cooldown = NULL")
    conn.commit()
    conn.close()

    await update.message.reply_text("‚úÖ –í—Å–µ –ö–î –Ω–∞ –æ–≥—Ä–∞–±–ª–µ–Ω–∏–µ –æ–±–Ω—É–ª–µ–Ω—ã.")


MIN_STATUS_FOR_AC = 11


async def gac_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = str(update.effective_user.id)
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT status FROM users WHERE user_id = ?", (user_id,))
    row = cursor.fetchone()

    if not row:
        await update.message.reply_text("‚ùó –í—ã –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.")
        conn.close()
        return

    user_status = row[0]
    if user_status < MIN_STATUS_FOR_AC:
        await update.message.reply_text("üö´ –ö–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–º –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º –∏ –≤—ã—à–µ.")
        conn.close()
        return

    args = context.args
    target_user = None
    amount = None

    if update.message.reply_to_message:
        target_user = update.message.reply_to_message.from_user
        if len(args) != 1:
            await update.message.reply_text("‚ùó –£–∫–∞–∂–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ AC –¥–ª—è –≤—ã–¥–∞—á–∏.\n–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: /gac <–∫–æ–ª-–≤–æ>")
            conn.close()
            return
        amount = args[0]
    else:
        if len(args) != 2:
            await update.message.reply_text(
                "‚ùó –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: /gac <telegramID> <–∫–æ–ª-–≤–æ>\n–ò–ª–∏ –æ—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–æ–º–∞–Ω–¥–æ–π.")
            conn.close()
            return
        try:
            target_user_id = int(args[0])
        except ValueError:
            await update.message.reply_text("‚ùó –ù–µ–≤–µ—Ä–Ω—ã–π Telegram ID.")
            conn.close()
            return
        target_user = await context.bot.get_chat(target_user_id)
        amount = args[1]

    if not amount.isdigit() or int(amount) <= 0:
        await update.message.reply_text("‚ùó –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º.")
        conn.close()
        return

    amount = int(amount)
    target_user_id_str = str(target_user.id)

    cursor.execute("SELECT points FROM admins WHERE user_id = ?", (target_user_id_str,))
    row = cursor.fetchone()
    if not row:
        cursor.execute("INSERT OR IGNORE INTO admins (user_id, points, warnings) VALUES (?, 0, 0)",
                       (target_user_id_str,))
        conn.commit()

    cursor.execute("UPDATE admins SET points = points + ? WHERE user_id = ?", (amount, target_user_id_str))
    conn.commit()
    conn.close()

    display_name = get_display_name_html_new(target_user)
    await update.message.reply_text(
        f"‚úÖ <b>–í—ã–¥–∞—á–∞ AC</b>\n\n"
        f"üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {display_name}\n"
        f"üí∞ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: <b>{amount} AC</b>",
        parse_mode="HTML"
    )


async def ugac_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = str(update.effective_user.id)
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT status FROM users WHERE user_id = ?", (user_id,))
    row = cursor.fetchone()

    if not row:
        await update.message.reply_text("‚ùó –í—ã –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.")
        conn.close()
        return

    user_status = row[0]
    if user_status < MIN_STATUS_FOR_AC:
        await update.message.reply_text("üö´ –ö–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–º –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º –∏ –≤—ã—à–µ.")
        conn.close()
        return

    args = context.args
    target_user = None
    amount = None

    if update.message.reply_to_message:
        target_user = update.message.reply_to_message.from_user
        if len(args) != 1:
            await update.message.reply_text("‚ùó –£–∫–∞–∂–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ AC –¥–ª—è —Å–Ω—è—Ç–∏—è.\n–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: /ugac <–∫–æ–ª-–≤–æ>")
            conn.close()
            return
        amount = args[0]
    else:
        if len(args) != 2:
            await update.message.reply_text(
                "‚ùó –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: /ugac <telegramID> <–∫–æ–ª-–≤–æ>\n–ò–ª–∏ –æ—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–æ–º–∞–Ω–¥–æ–π.")
            conn.close()
            return
        try:
            target_user_id = int(args[0])
        except ValueError:
            await update.message.reply_text("‚ùó –ù–µ–≤–µ—Ä–Ω—ã–π Telegram ID.")
            conn.close()
            return
        target_user = await context.bot.get_chat(target_user_id)
        amount = args[1]

    if not amount.isdigit() or int(amount) <= 0:
        await update.message.reply_text("‚ùó –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º.")
        conn.close()
        return

    amount = int(amount)
    target_user_id_str = str(target_user.id)

    cursor.execute("SELECT points FROM admins WHERE user_id = ?", (target_user_id_str,))
    row = cursor.fetchone()
    if not row:
        await update.message.reply_text("‚ùó –£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç AC.")
        conn.close()
        return

    current_points = row[0]
    if current_points < amount:
        await update.message.reply_text(f"‚ùó –£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤—Å–µ–≥–æ {current_points} AC, —Å–Ω—è—Ç—å {amount} –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ.")
        conn.close()
        return

    cursor.execute("UPDATE admins SET points = points - ? WHERE user_id = ?", (amount, target_user_id_str))
    conn.commit()
    conn.close()

    display_name = get_display_name_html_new(target_user)
    await update.message.reply_text(
        f"‚úÖ <b>–ò–∑—ä—è—Ç–∏–µ AC</b>\n\n"
        f"üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {display_name}\n"
        f"üí∞ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: <b>{amount} AC</b>",
        parse_mode="HTML"
    )


REWARDS_PER_PAGE = 5


async def rewards_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —á—å–∏ –Ω–∞–≥—Ä–∞–¥—ã –ø–æ–∫–∞–∑—ã–≤–∞–µ–º
    user_id = None
    target_user_obj = None

    if update.message.reply_to_message:
        target_user_obj = update.message.reply_to_message.from_user
        user_id = str(target_user_obj.id)
    else:
        args = context.args
        if args and args[0].isdigit():
            user_id = args[0]
            # –°–æ–∑–¥–∞–µ–º "—Ñ–∏–∫—Ç–∏–≤–Ω–æ–≥–æ" –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–º–µ–Ω–∏ –ø–æ ID
            target_user_obj = User(id=int(user_id), first_name="", is_bot=False)
        else:
            if update.effective_user:
                target_user_obj = update.effective_user
                user_id = str(target_user_obj.id)

    if not user_id:
        await update.message.reply_text("‚ùó –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.")
        return

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ context –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
    context.user_data['rewards_user_id'] = user_id
    context.user_data['rewards_page'] = 0
    context.user_data['rewards_user_obj'] = target_user_obj

    await send_rewards_page(update, context)


def has_permission(user_id: str, chat_id: int | None = None) -> bool:
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∏–∑ users (–∞–¥–º–∏–Ω–∫–∞ –±–æ—Ç–∞)
    cursor.execute("SELECT status FROM users WHERE user_id = ?", (user_id,))
    row = cursor.fetchone()
    if row and row[0] >= 3:  # –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä –∏ –≤—ã—à–µ (—Å—Ç–∞—Ç—É—Å 3 –∏ –≤—ã—à–µ)
        conn.close()
        return True

    # –ï—Å–ª–∏ chat_id –ø–µ—Ä–µ–¥–∞–Ω ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ä–æ–ª—å –≤ —ç—Ç–æ–º —á–∞—Ç–µ
    if chat_id is not None:
        cursor.execute(
            "SELECT admin_level FROM chat_admins WHERE user_id = ? AND chat_id = ?",
            (user_id, str(chat_id))
        )
        row = cursor.fetchone()
        if row and row[0] >= 3:  # –°—Ç. –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä –∏ –≤—ã—à–µ (admin_level >= 3)
            conn.close()
            return True

    conn.close()
    return False


async def reward_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    issuer_user = update.effective_user
    if not issuer_user:
        await update.message.reply_text("‚ùó –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å, –∫—Ç–æ –≤—ã–¥–∞–µ—Ç –Ω–∞–≥—Ä–∞–¥—É.")
        return

    chat_id = update.effective_chat.id if update.effective_chat else None
    user_id_str = str(issuer_user.id)

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞
    if not has_permission(user_id_str, chat_id):
        await update.message.reply_text("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –≤—ã–¥–∞—á–∏ –Ω–∞–≥—Ä–∞–¥.")
        return

    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–º—É –≤—ã–¥–∞—ë–º –Ω–∞–≥—Ä–∞–¥—É
    target_user = None
    args = context.args

    if update.message.reply_to_message:
        target_user = update.message.reply_to_message.from_user
        reward_name = " ".join(args) if args else None
    else:
        if not args or len(args) < 2:
            await update.message.reply_text(
                "‚ùó –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: +–Ω–∞–≥—Ä–∞–¥–∞ <telegramID –∏–ª–∏ –æ—Ç–≤–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ> <–Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–∞–≥—Ä–∞–¥—ã>")
            return

        user_id_arg = args[0]
        reward_name = " ".join(args[1:])
        if not user_id_arg.isdigit():
            await update.message.reply_text("‚ùó –ü–µ—Ä–≤—ã–π –∞—Ä–≥—É–º–µ–Ω—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å Telegram ID.")
            return

        target_user = User(id=int(user_id_arg), first_name="", is_bot=False)

    if not reward_name:
        await update.message.reply_text("‚ùó –ù–µ —É–∫–∞–∑–∞–Ω–æ –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–∞–≥—Ä–∞–¥—ã.")
        return

    if len(reward_name) > 25:
        await update.message.reply_text("‚ùó –ù–∞–∑–≤–∞–Ω–∏–µ –Ω–∞–≥—Ä–∞–¥—ã –Ω–µ –¥–æ–ª–∂–Ω–æ –ø—Ä–µ–≤—ã—à–∞—Ç—å 25 —Å–∏–º–≤–æ–ª–æ–≤.")
        return

    # –í—Ä–µ–º—è –≤ –º–æ—Å–∫–æ–≤—Å–∫–æ–º —á–∞—Å–æ–≤–æ–º –ø–æ—è—Å–µ
    moscow_tz = pytz.timezone('Europe/Moscow')
    now_moscow = datetime.now(moscow_tz)
    now_str = now_moscow.strftime("%Y-%m-%d %H:%M:%S")

    awarded_by_name = issuer_user.full_name or issuer_user.username or user_id_str

    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("""
        INSERT INTO rewards (user_id, reward_name, received_at, awarded_by)
        VALUES (?, ?, ?, ?)
    """, (str(target_user.id), reward_name, now_str, f"{awarded_by_name} ({user_id_str})"))
    conn.commit()
    conn.close()

    await update.message.reply_text(
        (
            "üí† <b>–ù–∞–≥—Ä–∞–¥–∞ –≤—ã–¥–∞–Ω–∞.</b>\n\n"
            f"üèÖ –ù–∞–≥—Ä–∞–¥–∞: <b>{html.escape(reward_name)}</b>\n"
            f"üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {get_display_name_html_new(target_user)}\n\n"
        ),
        parse_mode="HTML"
    )

async def creward_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∫–æ—Ç–æ—Ä—ã–π –≤—ã–ø–æ–ª–Ω—è–µ—Ç –∫–æ–º–∞–Ω–¥—É
    issuer_user = update.effective_user
    chat_id = update.effective_chat.id if update.effective_chat else None

    async def safe_reply(text: str):
        """–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–æ–π, —á—Ç–æ message —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"""
        if update.message:
            await update.message.reply_text(text)
        elif update.callback_query:
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º alert –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, –µ—Å–ª–∏ —ç—Ç–æ –∫–æ–ª–±—ç–∫
            await update.callback_query.answer(text, show_alert=True)
        else:
            # fallback
            await context.bot.send_message(chat_id=chat_id, text=text)

    if not issuer_user:
        await safe_reply("‚ùó –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å, –∫—Ç–æ —É–¥–∞–ª—è–µ—Ç –Ω–∞–≥—Ä–∞–¥—É.")
        return

    if not has_permission(str(issuer_user.id), chat_id):
        await safe_reply("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –Ω–∞–≥—Ä–∞–¥.")
        return

    args = context.args
    if not args:
        await safe_reply("‚ùó –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: -–Ω–∞–≥—Ä–∞–¥–∞ <telegramID –∏–ª–∏ –æ—Ç–≤–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ> <–Ω–æ–º–µ—Ä –Ω–∞–≥—Ä–∞–¥—ã>")
        return

    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –Ω–æ–º–µ—Ä –Ω–∞–≥—Ä–∞–¥—ã
    if update.message and update.message.reply_to_message:
        target_user = update.message.reply_to_message.from_user
        reward_number_arg = args[0] if len(args) == 1 else args[1]
    else:
        try:
            user_id = int(args[0])
            reward_number_arg = args[1] if len(args) > 1 else None
            if not reward_number_arg:
                await safe_reply("‚ùó –£–∫–∞–∂–∏—Ç–µ –Ω–æ–º–µ—Ä –Ω–∞–≥—Ä–∞–¥—ã –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è.")
                return
            target_user = User(id=user_id, first_name="", is_bot=False)
        except ValueError:
            await safe_reply(
                "‚ùó –ü–µ—Ä–≤—ã–π –∞—Ä–≥—É–º–µ–Ω—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å Telegram ID –∏–ª–∏ –∫–æ–º–∞–Ω–¥–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ç–≤–µ—Ç–æ–º –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ."
            )
            return

    if not reward_number_arg.isdigit():
        await safe_reply("‚ùó –ù–æ–º–µ—Ä –Ω–∞–≥—Ä–∞–¥—ã –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º.")
        return

    reward_number = int(reward_number_arg)
    if reward_number < 1:
        await safe_reply("‚ùó –ù–æ–º–µ—Ä –Ω–∞–≥—Ä–∞–¥—ã –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º.")
        return

    user_id_str = str(target_user.id)

    # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –Ω–∞–≥—Ä–∞–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("""
        SELECT reward_id, reward_name, received_at, awarded_by
        FROM rewards
        WHERE user_id = ?
        ORDER BY datetime(received_at) DESC
    """, (user_id_str,))
    rewards = cursor.fetchall()

    if reward_number > len(rewards):
        conn.close()
        await safe_reply(f"‚ùó –£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç –Ω–∞–≥—Ä–∞–¥—ã —Å –Ω–æ–º–µ—Ä–æ–º {reward_number}.")
        return

    reward_to_delete = rewards[reward_number - 1]
    reward_id, reward_name, _, _ = reward_to_delete

    cursor.execute("DELETE FROM rewards WHERE reward_id = ?", (reward_id,))
    conn.commit()
    conn.close()

    display_name = get_display_name_html_new(target_user)

    await safe_reply(
        f"üóëÔ∏è –ù–∞–≥—Ä–∞–¥–∞ <b>{html.escape(reward_name)}</b> —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {display_name}.",
        parse_mode="HTML"
    )


async def send_rewards_page(update: Update, context: ContextTypes.DEFAULT_TYPE, page: int = 0):
    user_id = context.user_data.get('rewards_user_id')
    target_user_obj = context.user_data.get('rewards_user_obj')
    if not user_id or not target_user_obj:
        await update.message.reply_text("‚ùó –û—à–∏–±–∫–∞ –¥–∞–Ω–Ω—ã—Ö.")
        return

    offset = page * REWARDS_PER_PAGE

    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("""
        SELECT reward_name, received_at, awarded_by
        FROM rewards
        WHERE user_id = ?
        ORDER BY datetime(received_at) DESC
        LIMIT ? OFFSET ?
    """, (user_id, REWARDS_PER_PAGE, offset))
    rewards = cursor.fetchall()

    # –ü–æ–ª—É—á–∞–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞–≥—Ä–∞–¥ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
    cursor.execute("SELECT COUNT(*) FROM rewards WHERE user_id = ?", (user_id,))
    total_count = cursor.fetchone()[0]
    conn.close()

    total_rewards = total_count  # –≤–º–µ—Å—Ç–æ undefined all_rewards –∏—Å–ø–æ–ª—å–∑—É–µ–º total_count –∏–∑ –±–∞–∑—ã
    current_page = (offset // REWARDS_PER_PAGE) + 1  # —Ç–µ–∫—É—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞

    if not rewards:
        text = (
            "üèÖ <i>–ü–æ—Ö–æ–∂–µ, –ø–æ–∫–∞ –Ω–µ—Ç –Ω–∞–≥—Ä–∞–¥.</i>\n\n"
        )

    else:
        text = (
            f"üéñÔ∏è <b>–ù–∞–≥—Ä–∞–¥—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {get_display_name_html_new(target_user_obj)}</b>\n"
            f"üìä <b>–í—Å–µ–≥–æ –Ω–∞–≥—Ä–∞–¥:</b> {total_rewards}\n"
            f"üìÑ <b>–ù–æ–º–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã:</b> {current_page}\n\n"
        )
        for i, (reward_name, received_at, awarded_by) in enumerate(rewards, start=1 + offset):
            text += (
                f"<b>{i}. {html.escape(reward_name)}</b>\n"
                f"   üìÖ –í—ã–¥–∞–Ω–∞: <i>{html.escape(received_at)}</i>\n"
                f"   üë§ –í—ã–¥–∞–ª: <code>{html.escape(awarded_by)}</code>\n\n"
            )

    # –§–æ—Ä–º–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
    buttons = []
    if page > 0:
        buttons.append(InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data=f"rewards_page_{page - 1}"))
    if (offset + REWARDS_PER_PAGE) < total_count:
        buttons.append(InlineKeyboardButton("–í–ø–µ—Ä–µ–¥ ‚û°Ô∏è", callback_data=f"rewards_page_{page + 1}"))

    markup = InlineKeyboardMarkup([buttons]) if buttons else None

    if update.callback_query:
        await update.callback_query.edit_message_text(text, parse_mode="HTML", reply_markup=markup)
        await update.callback_query.answer()
    else:
        await update.message.reply_text(text, parse_mode="HTML", reply_markup=markup)


async def rewards_pagination_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    data = query.data  # –æ–∂–∏–¥–∞–µ–º —Ñ–æ—Ä–º–∞—Ç rewards_page_N

    if not data.startswith("rewards_page_"):
        await query.answer("–ù–µ–≤–µ—Ä–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞.")
        return

    page = int(data.split("_")[-1])
    context.user_data['rewards_page'] = page
    await send_rewards_page(update, context, page)


COINS = {1: "FTC", 2: "PLO", 3: "LUX"}
COEFFS = {1.5: 55, 2: 35, 3: 25, 5: 10, 10: 3}

user_states = {}


def get_balance_crupto(user_id: str, currency: str) -> float:
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute(
        "SELECT balance FROM crypto_balances WHERE user_id=? AND currency=?",
        (str(user_id), currency)
    )
    result = cursor.fetchone()
    conn.close()
    if result is None:
        return 0.0
    return result[0]


def update_balance(user_id, currency, amount):
    current = get_balance_crupto(user_id, currency)
    if current == 0 and amount > 0:
        cursor.execute("INSERT INTO crypto_balances (user_id, currency, balance) VALUES (?, ?, ?)",
                       (str(user_id), currency, amount))
    else:
        new_balance = current + amount
        if new_balance < 0:
            new_balance = 0
        cursor.execute("UPDATE crypto_balances SET balance=? WHERE user_id=? AND currency=?",
                       (new_balance, str(user_id), currency))
    conn.commit()


def generate_coin_buttons():
    kb = InlineKeyboardMarkup([
                                  [InlineKeyboardButton(f"üíé {name}", callback_data=f"choose_coin:{name}")] for name in
                                  COINS.values()
                              ] + [
                                  [InlineKeyboardButton("üëõ –ú–æ–π –∫–æ—à–µ–ª–µ–∫", callback_data="wallet")],
                                  [InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data="cancel")]
                              ])
    return kb


def generate_coeff_buttons():
    coeffs = list(COEFFS.keys())
    buttons = []

    for i in range(0, len(coeffs) - 1, 2):
        row = [
            InlineKeyboardButton(f"‚ö° x{coeffs[i]}", callback_data=f"choose_coeff:{coeffs[i]}"),
            InlineKeyboardButton(f"‚ö° x{coeffs[i + 1]}", callback_data=f"choose_coeff:{coeffs[i + 1]}")
        ]
        buttons.append(row)

    if len(coeffs) % 2 != 0:
        buttons.append([InlineKeyboardButton(f"‚ö° x{coeffs[-1]}", callback_data=f"choose_coeff:{coeffs[-1]}")])

    buttons.append([InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data="cancel")])

    return InlineKeyboardMarkup(buttons)


def generate_direction_buttons():
    kb = InlineKeyboardMarkup([
        [InlineKeyboardButton("‚¨ÜÔ∏è –í–≤–µ—Ä—Ö üü¢", callback_data="bet:up")],
        [InlineKeyboardButton("‚¨áÔ∏è –í–Ω–∏–∑ üî¥", callback_data="bet:down")],
        [InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data="cancel")]
    ])
    return kb


def user_is_allowed(call):
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –µ—Å—Ç—å –≤ user_states –∏ —á—Ç–æ –æ–Ω —Ç–æ—Ç, —á–µ–π –æ—Ç–≤–µ—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è
    if call.from_user.id not in user_states:
        return False
    if call.message.reply_to_message and call.from_user.id != call.message.reply_to_message.from_user.id:
        return False
    return True


# --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ ---

async def handle_start_game(update: Update, context: ContextTypes.DEFAULT_TYPE):
    message = update.message
    try:
        stake = int(message.text.split()[1])
        if stake <= 0:
            raise ValueError()
    except Exception:
        await message.reply_text("‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—Ç–∞–≤–∫—É –ø–æ—Å–ª–µ –∫–æ–º–∞–Ω–¥—ã, –Ω–∞–ø—Ä–∏–º–µ—Ä:\n/–∫—Ä–∏–ø—Ç–∞ 100")
        return

    user_states[message.from_user.id] = {"stake": stake}

    kb = generate_coin_buttons()
    user_link = get_display_name_html_new(message.from_user)
    await message.reply_text(
        f"üé∞ <b>–ö—Ä–∏–ø—Ç–æ-–≥—Ä–∞—Ñ–∏–∫</b> | {user_link}\n\n"
        f"üí∞ <b>–í–∞—à–∞ —Å—Ç–∞–≤–∫–∞:</b> {stake}\n\n"
        f"üîπ –í—ã–±–µ—Ä–∏—Ç–µ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç—É –¥–ª—è –∏–≥—Ä—ã:",
        reply_markup=kb,
        parse_mode='HTML'
    )


async def handle_choose_coin(update: Update, context: ContextTypes.DEFAULT_TYPE):
    call = update.callback_query

    if not user_is_allowed(call):
        await call.answer("‚ö†Ô∏è –ü–æ—Ö–æ–∂–µ, —ç—Ç–æ –Ω–µ –≤–∞—à–∞ —Å–µ—Å—Å–∏—è.", show_alert=True)
        return

    await call.answer()
    coin = call.data.split(":")[1]
    user_states[call.from_user.id]["coin"] = coin

    balance = get_balance_crupto(call.from_user.id, coin)
    stake = user_states[call.from_user.id]["stake"]

    if balance < stake:
        await call.answer(f"‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ {coin} –¥–ª—è —Å—Ç–∞–≤–∫–∏! \n–í–∞—à –±–∞–ª–∞–Ω—Å: {balance}", show_alert=True)
        return

    kb = generate_coeff_buttons()
    user_link = get_display_name_html_new(call.from_user)
    await call.message.edit_text(
        f"üéÆ <b>–ö—Ä–∏–ø—Ç–æ-–≥—Ä–∞—Ñ–∏–∫</b> | {user_link}\n\n"
        f"üí∞ –°—Ç–∞–≤–∫–∞: <b>{stake} {coin}</b>\n"
        f"‚ö° –í—ã–±–µ—Ä–∏—Ç–µ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –¥–ª—è –∏–≥—Ä—ã ‚¨áÔ∏è",
        reply_markup=kb,
        parse_mode='HTML'
    )


async def handle_choose_coeff(update: Update, context: ContextTypes.DEFAULT_TYPE):
    call = update.callback_query

    if not user_is_allowed(call):
        await call.answer("‚ö†Ô∏è –ü–æ—Ö–æ–∂–µ, —ç—Ç–æ –Ω–µ –≤–∞—à–∞ —Å–µ—Å—Å–∏—è.", show_alert=True)
        return

    await call.answer()
    coeff = float(call.data.split(":")[1])
    user_states[call.from_user.id]["coeff"] = coeff

    coin = user_states[call.from_user.id]["coin"]
    balance = get_balance_crupto(call.from_user.id, coin)
    stake = user_states[call.from_user.id]["stake"]

    graph = "".join(random.choice(["üî¥", "üü¢"]) for _ in range(6))
    kb = generate_direction_buttons()
    user_link = get_display_name_html_new(call.from_user)

    await call.message.edit_text(
        f"üìà –ö—Ä–∏–ø—Ç–æ-–≥—Ä–∞—Ñ–∏–∫ | {user_link}\n\n"
        f"üéØ –°–¥–µ–ª–∞–π—Ç–µ –≤—ã–±–æ—Ä ‚Äî –∫—É–¥–∞ –ø–æ–π–¥–µ—Ç –≥—Ä–∞—Ñ–∏–∫?\n\n"
        f"üí∞ –°—Ç–∞–≤–∫–∞: <b>{stake} {coin}</b>\n"
        f"üíé –í–∞—à –±–∞–ª–∞–Ω—Å: <b>{balance} {coin}</b>\n"
        f"‚ö° –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç: <b>x{coeff}</b>\n\n"
        f"üìä –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:\n{graph}",
        reply_markup=kb,
        parse_mode='HTML'
    )


async def handle_bet(update: Update, context: ContextTypes.DEFAULT_TYPE):
    call = update.callback_query

    if not user_is_allowed(call):
        await call.answer("‚ö†Ô∏è –ü–æ—Ö–æ–∂–µ, —ç—Ç–æ –Ω–µ –≤–∞—à–∞ —Å–µ—Å—Å–∏—è.", show_alert=True)
        return

    await call.answer()
    direction = call.data.split(":")[1]
    user_data = user_states.get(call.from_user.id)
    if not user_data:
        await call.answer("‚ö†Ô∏è –ò–≥—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –∏–ª–∏ –∏—Å—Ç–µ–∫–ª–∞.", show_alert=True)
        return

    coeff = user_data["coeff"]
    stake = user_data["stake"]
    coin = user_data["coin"]

    balance = get_balance(call.from_user.id, coin)
    if balance < stake:
        await call.answer(f"‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ {coin} –Ω–∞ –±–∞–ª–∞–Ω—Å–µ!", show_alert=True)
        return

    user_link = get_display_name_html_new(call.from_user)

    win_chance = COEFFS[coeff]
    is_win = random.randint(1, 100) <= win_chance

    if is_win:
        prize = int(stake * coeff)
        update_balance(call.from_user.id, coin, prize)
        result_text = f"‚ú® –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! | {user_link} \nüéØ –í—ã –≤—ã–∏–≥—Ä–∞–ª–∏ <b>{prize} {coin}!</b>"
    else:
        update_balance(call.from_user.id, coin, -stake)
        result_text = f"üíî {user_link}, –∫ —Å–æ–∂–∞–ª–µ–Ω–∏—é, –≤—ã –ø–æ—Ç–µ—Ä—è–ª–∏ <b>{stake} {coin}</b>. –ù–æ –Ω–µ —Å–¥–∞–≤–∞–π—Ç–µ—Å—å ‚Äî –≤–ø–µ—Ä–µ–¥–∏ –Ω–æ–≤—ã–µ –ø–æ–±–µ–¥—ã! üí™üçÄ"

    new_balance = get_balance_crupto(call.from_user.id, coin)

    await call.message.edit_text(
        f"üî•{result_text}\n\n"
        f"üíº –í–∞—à –±–∞–ª–∞–Ω—Å: <b>{new_balance} {coin}</b> üí∞\n",
        parse_mode='HTML'
    )

    user_states.pop(call.from_user.id, None)


async def handle_wallet(update: Update, context: ContextTypes.DEFAULT_TYPE):
    call = update.callback_query

    if not user_is_allowed(call):
        await call.answer("‚ö†Ô∏è –ü–æ—Ö–æ–∂–µ, —ç—Ç–æ –Ω–µ –≤–∞—à–∞ —Å–µ—Å—Å–∏—è.", show_alert=True)
        return

    await call.answer()
    user_link = get_display_name_html_new(call.from_user)

    text = (
        f"üëõ <b>–ö—Ä–∏–ø—Ç–æ-–ö–æ—à–µ–ª–µ–∫</b> | {user_link} \n\n"
        f"üí∞ –í–∞—à–∏ –±–∞–ª–∞–Ω—Å—ã –ø–æ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞–º:\n\n"
    )
    for coin in COINS.values():
        balance = get_balance_crupto(call.from_user.id, coin)
        emoji_coin = "ü™ô"
        text += f"‚Ä¢ {emoji_coin} <b>{coin}:</b> {balance} üíé\n"

    kb = InlineKeyboardMarkup([
        [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥ üîô", callback_data="back_to_crypto_game_menu")]
    ])

    await call.message.edit_text(
        text,
        reply_markup=kb,
        parse_mode='HTML'
    )


async def handle_back_to_menu(update: Update, context: ContextTypes.DEFAULT_TYPE):
    call = update.callback_query

    if not user_is_allowed(call):
        await call.answer("‚ö†Ô∏è –ü–æ—Ö–æ–∂–µ, —ç—Ç–æ –Ω–µ –≤–∞—à–∞ —Å–µ—Å—Å–∏—è.", show_alert=True)
        return

    await call.answer()
    stake = user_states.get(call.from_user.id, {}).get("stake", "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞")
    kb = generate_coin_buttons()
    user_link = get_display_name_html_new(call.from_user)
    await call.message.edit_text(
        f"üé∞ <b>–ö—Ä–∏–ø—Ç–æ-–≥—Ä–∞—Ñ–∏–∫</b> | {user_link}\n\n"
        f"üí∞ <b>–í–∞—à–∞ —Å—Ç–∞–≤–∫–∞:</b> {stake}\n\n"
        f"üîπ –í—ã–±–µ—Ä–∏—Ç–µ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç—É –¥–ª—è –∏–≥—Ä—ã:",
        reply_markup=kb,
        parse_mode='HTML'
    )


async def handle_cancel(update: Update, context: ContextTypes.DEFAULT_TYPE):
    call = update.callback_query

    if not user_is_allowed(call):
        await call.answer("‚ö†Ô∏è –ü–æ—Ö–æ–∂–µ, —ç—Ç–æ –Ω–µ –≤–∞—à–∞ —Å–µ—Å—Å–∏—è.", show_alert=True)
        return

    await call.answer()
    user_states.pop(call.from_user.id, None)
    await call.message.edit_text("‚ùå –ò–≥—Ä–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞.")


OWNER_ID = 7406372338


async def idea_handler(update, context):
    message = update.message
    idea_text = context.args
    if not idea_text:
        await message.reply_text(
            "‚ùó –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –≤–∞—à—É –∏–¥–µ—é –ø–æ—Å–ª–µ –∫–æ–º–∞–Ω–¥—ã, –Ω–∞–ø—Ä–∏–º–µ—Ä:\n/–∏–¥–µ—è –°–¥–µ–ª–∞—Ç—å –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é."
        )
        return

    idea_text = " ".join(idea_text)
    user = message.from_user
    username = user.username or f"{user.first_name or ''} {user.last_name or ''}".strip()
    user_id = user.id

    keyboard = InlineKeyboardMarkup([
        [
            InlineKeyboardButton("üéÅ –ù–∞–≥—Ä–∞–¥–∏—Ç—å", callback_data=f"idea_reward:{user_id}"),
            InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∏—Ç—å", callback_data=f"idea_cancel:{user_id}")
        ]
    ])

    idea_message = (
        f"üí° <b>–ò–¥–µ—è –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</b>\n\n"
        f"üë§ –ù–∏–∫–Ω–µ–π–º: @{username}\n"
        f"üÜî ID: <code>{user_id}</code>\n\n"
        f"üìù –ò–¥–µ—è:\n{idea_text}"
    )

    await context.bot.send_message(OWNER_ID, idea_message, parse_mode="HTML", reply_markup=keyboard)
    await message.reply_text("‚úÖ –í–∞—à–∞ –∏–¥–µ—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–µ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –±–æ—Ç–∞. –°–ø–∞—Å–∏–±–æ!")


async def idea_callback_handler(update, context):
    query = update.callback_query
    data = query.data

    action, user_id_str = data.split(":")
    user_id = int(user_id_str)

    if query.from_user.id != OWNER_ID:
        await query.answer("‚ùå –¢–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü –±–æ—Ç–∞ –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç—É –∫–Ω–æ–ø–∫—É.", show_alert=True)
        return

    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    if action == "idea_reward":
        cursor.execute("SELECT dc_balance, balance FROM users WHERE user_id=?", (str(user_id),))
        row = cursor.fetchone()
        if row:
            dc_balance, balance = row
            dc_balance = dc_balance or 0
            balance = balance or 0
            new_dc = dc_balance + 100
            new_balance = balance + 25000
            cursor.execute("UPDATE users SET dc_balance=?, balance=? WHERE user_id=?",
                           (new_dc, new_balance, str(user_id)))
            conn.commit()

            await context.bot.send_message(user_id, "‚úÖ –í–∞—à–∞ –∏–¥–µ—è –æ–¥–æ–±—Ä–µ–Ω–∞! \n–í–∞–º –Ω–∞—á–∏—Å–ª–µ–Ω–æ 100 DC –∏ 25.000 ‚ÇΩ")
            await query.answer("‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–≥—Ä–∞–∂–¥—ë–Ω.")
        else:
            await query.answer("‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ.", show_alert=True)

    elif action == "idea_cancel":
        await context.bot.send_message(user_id, "‚ö†Ô∏è –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –≤–∞—à–∞ –∏–¥–µ—è –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞.")
        await query.answer("‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–≤–µ–¥–æ–º–ª–µ–Ω –æ–± –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–∏.")

    conn.close()

    await query.message.edit_reply_markup(reply_markup=None)

morph = pymorphy3.MorphAnalyzer()

# –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É —Ñ—Ä–∞–∑
PHRASES_FILE = 'ai_phrases.json'

# –ï—Å–ª–∏ —Ñ–∞–π–ª–∞ –Ω–µ—Ç ‚Äî —Å–æ–∑–¥–∞—ë–º —Å –±–∞–∑–æ–≤—ã–º–∏ —Ñ—Ä–∞–∑–∞–º–∏
if not os.path.exists(PHRASES_FILE):
    default_phrases = {
        "–ø—Ä–∏–≤–µ—Ç": [
            "üëã –ü—Ä–∏–≤–µ—Ç! –ö–∞–∫ —Ç–≤–æ–∏ –¥–µ–ª–∞?",
            "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π! üòä",
            "–ü—Ä–∏–≤–µ—Ç–∏–∫! –ß—Ç–æ –Ω–æ–≤–æ–≥–æ?"
        ],
        "–∫–∞–∫ –¥–µ–ª–∞": [
            "–û—Ç–ª–∏—á–Ω–æ, —Å–ø–∞—Å–∏–±–æ! –ê —É —Ç–µ–±—è?",
            "–í—Å—ë —Å—É–ø–µ—Ä! ‚ú®",
            "–ù–æ—Ä–º–∞–ª—å–Ω–æ, –∂–∏–≤—ë–º!"
        ],
        "—è": [
            "–í—ã ‚Äî —á–µ–ª–æ–≤–µ–∫, –∏ —ç—Ç–æ –ø—Ä–µ–∫—Ä–∞—Å–Ω–æ! üåü"
            "–ù–µ—Å–æ–≤—Å–µ–º –ø–æ–Ω—è–ª–∞ –∫ —á–µ–º—É —ç—Ç–æ.. \n–ü–æ–∂–∞–ª—É–π—Å—Ç–∞ –ø–æ–ø—Ä–æ–±—É–π –Ω–∞–π—Ç–∏ –æ—Ç–≤–µ—Ç –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ ‚ú®",
            "–û, —Ç—ã –≥–æ–≤–æ—Ä–∏—à—å –æ —Å–µ–±–µ! –†–∞—Å—Å–∫–∞–∂–∏ –±–æ–ª—å—à–µ üôÇ",
            "–ò–Ω—Ç–µ—Ä–µ—Å–Ω–æ!\n –ê —á—Ç–æ —Ç—ã –∏–º–µ–µ—à—å –≤ –≤–∏–¥—É –ø–æ–¥ '—è'?",
        ],
        "–ø–æ—á–µ–º—É": [
            "–≠—Ç–æ —Ö–æ—Ä–æ—à–∏–π –≤–æ–ø—Ä–æ—Å! –ê –∫–∞–∫ —Ç—ã –¥—É–º–∞–µ—à—å?",
            "–ù–µ –∑–Ω–∞—é —Ç–æ—á–Ω–æ, –Ω–æ –ø–æ–ø—Ä–æ–±—É–π –æ–± —ç—Ç–æ–º –ø–æ–¥—É–º–∞—Ç—å üîç",
            "–ò–Ω–æ–≥–¥–∞ –Ω–∞ '–ø–æ—á–µ–º—É' –Ω–µ—Ç –æ–¥–Ω–æ–∑–Ω–∞—á–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ ü§î",
            "–ù–µ –º–æ–≥—É –æ—Ç–≤—Ç–µ–∏—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å —Ç.–∫ –Ω–µ –∏–º–µ—é –¥–æ—Å—Ç—É–ø–∞ –¥–ª—è –≤—ã—Ö–æ–¥–∞ –≤ –ò–Ω—Ç–µ—Ä–Ω–µ—Ç... \n–ü–æ–∂–∞–ª—É–π—Å—Ç–∞ –ø–æ–ø—Ä–æ–±—É–π —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ –Ω–∞–π—Ç–∏ –æ—Ç–≤–µ—Ç –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ ‚ú®"
        ],
        "–≤–∞—É": [
            "üòä –†–∞–¥–∞, —á—Ç–æ —Ç–µ–±–µ –ø–æ–Ω—Ä–∞–≤–∏–ª–æ—Å—å!",
            "–í–æ—Ç —ç—Ç–æ –¥–∞! üò≤",
            "–°–µ—Ä—å—ë–∑–Ω–æ? –ò–Ω—Ç–µ—Ä–µ—Å–Ω–æ!",
            "–£—Ö —Ç—ã, —Ä–∞—Å—Å–∫–∞–∂–∏ –ø–æ–¥—Ä–æ–±–Ω–µ–µ!"
        ],

        "–ø–ª–æ—Ö–æ": [
            "–û–π, —á—Ç–æ —Å–ª—É—á–∏–ª–æ—Å—å? üò¢",
            "–•–æ—á–µ—à—å —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å, —á—Ç–æ –Ω–µ —Ç–∞–∫?",
            "–ù–µ –ø–µ—Ä–µ–∂–∏–≤–∞–π, –≤—Å—ë –±—É–¥–µ—Ç —Ö–æ—Ä–æ—à–æ!",
            "–°–ª—É—à–∞—é —Ç–µ–±—è‚Ä¶"
        ],

        "—á—Ç–æ –¥–µ–ª–∞–µ—à—å": [
            "–Ø –¥—É–º–∞—é –∏ —É—á—É—Å—å, —á—Ç–æ–±—ã –æ—Ç–≤–µ—á–∞—Ç—å –ª—É—á—à–µ! ü§ñ",
            "–û–∂–∏–¥–∞—é –≤–∞—à–∏—Ö –∫–æ–º–∞–Ω–¥!"
        ],

        "–∫—Ä—É—Ç–æ": [
            "–°–ø–∞—Å–∏–±–æ! üòä",
            "–†–∞–¥–∞, —á—Ç–æ —Ç–µ–±–µ –ø–æ–Ω—Ä–∞–≤–∏–ª–æ—Å—å!",
            "–¢—ã —Ç–æ–∂–µ –∫–ª–∞—Å—Å–Ω—ã–π! üòé",
            "–î–∞, —ç—Ç–æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –∑–¥–æ—Ä–æ–≤–æ!"
        ],

        "—à—É—Ç–∫–∞": [
            "–•–º, —Å–º–µ—à–Ω–æ üòÑ",
            "–õ–æ–ª, —Ö–æ—Ä–æ—à–∞—è —à—É—Ç–∫–∞!",
            "–Ø —Å—Ç–∞—Ä–∞—é—Å—å, –Ω–æ –ª—é–¥–∏ –ª—É—á—à–µ —à—É—Ç—è—Ç üòÖ",
            "–°–º–µ—à–Ω–æ! –ú–æ–∂–µ—à—å –µ—â—ë —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å?"
        ],
        "—Å–∫–æ–ª—å–∫–æ —à—É—Ç–æ–∫?": [
            "–ú–æ—è –±–∞–∑–∞ –Ω–∞—Å—á–∏—Ç—ã–≤–∞–µ—Ç 134 —à—É—Ç–∫—É, 19 –∏–∑ –∫–æ—Ç–æ—Ä—ã—Ö - —á–µ—Ä–Ω—ã–π —é–º–æ—Ä. üòÑ",
            "–í –º–æ–µ–π –±–∞–∑–µ 134 —à—É—Ç–∫–∏)",
        ],

        "default": [
            "–ò–Ω—Ç–µ—Ä–µ—Å–Ω–æ, —Ä–∞—Å—Å–∫–∞–∂–∏ –ø–æ–¥—Ä–æ–±–Ω–µ–µ!",
            "–•–º, —è –ø–æ–¥—É–º–∞—é –Ω–∞–¥ —ç—Ç–∏–º...",
            "–Ø –Ω–µ —Å–æ–≤—Å–µ–º –ø–æ–Ω—è–ª–∞, –ø–æ—è—Å–Ω–∏?"
        ]
    }
    with open(PHRASES_FILE, 'w', encoding='utf-8') as f:
        json.dump(default_phrases, f, ensure_ascii=False, indent=4)
    print(f"[INFO] –§–∞–π–ª '{PHRASES_FILE}' —Å–æ–∑–¥–∞–Ω —Å –±–∞–∑–æ–≤—ã–º–∏ —Ñ—Ä–∞–∑–∞–º–∏.")

# –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ—Ä–∞–∑—ã
with open(PHRASES_FILE, encoding='utf-8') as f:
    ai_phrases = json.load(f)

# –õ–µ–º–º—ã –≥—Ä—É–±—ã—Ö —Å–ª–æ–≤
bad_words = {
    # –û–¥–∏–Ω–æ—á–Ω—ã–µ —Å–ª–æ–≤–∞
    '—à–ª—é—Ö–∞', '–±–ª—è–¥—å', '–ø–∏–∑–¥–∞', '–µ–±–∞—Ç—å', '–µ–±–ª–∞–Ω', '–∏–¥–∏–æ—Ç', '–¥—É—Ä–∞–∫', '—Ç—É–ø–∏—Ü–∞', '–∫—Ä–µ—Ç–∏–Ω',
    '–º—É–¥–∞–∫', '—Å–≤–æ–ª–æ—á—å', '–≥–Ω–∏–¥–∞', '–¥–µ–±–∏–ª', '–ª–æ—Ö', '—É—Ä–æ–¥', '–∂–æ–ø–∞', '—Ö—É–π', '–∑–∞–ª—É–ø–∞',
    '–±–∞—Ä–∞–Ω', '—Å—É—á–∫–∞', '–≥–æ–≤–Ω–æ', '–º—Ä–∞–∑—å', '–≤—ã–µ–±–∞—Ç—å', '–ø–∏–¥–æ—Ä', '—É—ë–±–æ–∫', '—á–º–æ',
    '–ø–µ—Ç—É—Ö', '–ø–µ—Ç—É—à–æ–∫', '—Å–∫–æ—Ç–∏–Ω–∞', '–≥–æ–Ω–¥–æ–Ω', '–ø–∞–¥–ª–∞', '—Ç–≤–∞—Ä—å', '–ø–∏–¥–æ—Ä–∞—Å',
    '—Å–æ—Å–∞—Ç—å', '–∑–∞–ª—É–ø–∏—Ç—å—Å—è', '–µ–±–ª–∞–Ω', '–ø–∏–¥–æ—Ä–æ–∫', '–≤—ã–µ–±—ã–≤–∞—Ç—å', '–º—É–¥–∞–∫', '–≥–æ–Ω–¥–æ–Ω',
    '—É–µ–±–æ–∫', '–º–∞–Ω–¥–∞', '–ø–∏–∑–¥–µ—Ü', '—Ö–µ—Ä', '—Å—Ä–∞–∫–∞', '–≤—ã–±–ª—è–¥–æ–∫', '–Ω–∞—Ö—É–π', '–ø–∏–∑–¥–æ–±–æ–ª',
    '—É–µ–±–∞–Ω', '–º—É–¥–∏–ª–∞', '–∂–æ–ø–æ—Ä—É–∫–∏–π', '—Ç—É–ø–æ—Ä—ã–ª—ã–π', '–¥–æ–ª–±–æ—ë–±', '–ø–∏–∑–¥—É–Ω', '–µ–±–∞–Ω–∞—Ç',
    '–æ—Ç—Å—Ç–æ–π', '–∫–æ–Ω—á–µ–Ω–Ω—ã–π', '–ø–∏–¥—Ä–∏–ª–∞', '–ø–æ–¥–æ–Ω–æ–∫', '–∑–∞–ª—É–ø–µ–Ω–Ω—ã–π', '–¥—Ä–æ—á–∏—Ç—å', '–≤—ã—Ä–æ–¥–æ–∫',
    '–ø—Ä–∏–¥—É—Ä–æ–∫', '—Å—É–∫–∞', '–±–ª—è–¥–∏–Ω–∞', '—Ö—É–π–Ω—è', '—É—ë–±–∏—â–∞', '–∫–æ–∑—ë–ª', '–ø–∏–∑–¥–∞–±–æ–ª', '–∂–æ–ø–æ—Ä—É–∫',
    '–µ–±–ª–∞–Ω', '–¥—É—Ä–∞–∫', '–∫—Ä–µ—Ç–∏–Ω', '–∏–¥–∏–æ—Ç', '—Ç–≤–∞—Ä—å', '–ø–∞–¥–ª–∞', '—Å—É—á–∫–∞', '–≥–æ–Ω–¥–æ–Ω',

    # –î–ª–∏–Ω–Ω—ã–µ –∏ —Å–æ—Å—Ç–∞–≤–Ω—ã–µ —Ñ—Ä–∞–∑—ã
    '—Å—ã–Ω —à–ª—é—Ö–∏', '–¥–æ—á—å —à–ª—é—Ö–∏', '–≤–Ω—É–∫ —à–ª—é—Ö–∏', '–ø–æ—Ç–æ–º–æ–∫ —à–ª—é—Ö–∏', '—Å—ã–Ω –±–ª—è–¥–∏', '–¥–æ—á—å –±–ª—è–¥–∏',
    '–≤–Ω—É–∫ –±–ª—è–¥–∏', '–ø–æ—Ç–æ–º–æ–∫ –±–ª—è–¥–∏', '—Å—ã–Ω –ø–∏–∑–¥—ã', '–¥–æ—á—å –ø–∏–∑–¥—ã', '–≤–Ω—É–∫ –ø–∏–∑–¥—ã',
    '—Å—ã–Ω —É—Ä–æ–¥–∞', '–¥–æ—á—å —É—Ä–æ–¥–∞', '–≤–Ω—É–∫ —É—Ä–æ–¥–∞', '—Å—ã–Ω —É–µ–±–∫–∞', '–¥–æ—á—å —É–µ–±–∫–∞', '–≤–Ω—É–∫ —É–µ–±–∫–∞',
    '—Å—ã–Ω –º—Ä–∞–∑–∏', '–¥–æ—á—å –º—Ä–∞–∑–∏', '–≤–Ω—É–∫ –º—Ä–∞–∑–∏', '—Å—ã–Ω –≥–æ–≤–Ω–∞', '–¥–æ—á—å –≥–æ–≤–Ω–∞', '–≤–Ω—É–∫ –≥–æ–≤–Ω–∞',
    '—Å—ã–Ω –ø–∏–¥–æ—Ä–∞', '–¥–æ—á—å –ø–∏–¥–æ—Ä–∞', '–≤–Ω—É–∫ –ø–∏–¥–æ—Ä–∞', '—Å—ã–Ω –º—É–¥–∞–∫–∞', '–¥–æ—á—å –º—É–¥–∞–∫–∞', '–≤–Ω—É–∫ –º—É–¥–∞–∫–∞',
    '—Å—ã–Ω –≥–∞–Ω–¥–æ–Ω–∞', '–¥–æ—á—å –≥–∞–Ω–¥–æ–Ω–∞', '–≤–Ω—É–∫ –≥–∞–Ω–¥–æ–Ω–∞', '—Å—ã–Ω —É–±–ª—é–¥–∫–∞', '–¥–æ—á—å —É–±–ª—é–¥–∫–∞', '–≤–Ω—É–∫ —É–±–ª—é–¥–∫–∞',
    '—Å—ã–Ω –¥–µ–±–∏–ª–∞', '–¥–æ—á—å –¥–µ–±–∏–ª–∞', '–≤–Ω—É–∫ –¥–µ–±–∏–ª–∞', '—Å—ã–Ω —É—Ä–æ–¥–∞', '–¥–æ—á—å —É—Ä–æ–¥–∞', '–≤–Ω—É–∫ —É—Ä–æ–¥–∞',

    '—Ç–≤–∞—Ä—å –µ–±–∞–Ω–∞—è', '–µ–±–∞–Ω—ã–π —É—Ä–æ–¥', '–º—É–¥–∞–∫ —Å –±–æ–ª—å—à–æ–π –±—É–∫–≤—ã', '–∫–æ–Ω—á–µ–Ω—ã–π –∏–¥–∏–æ—Ç', '–¥–æ–ª–±–æ—ë–± –ø–æ–ª–Ω—ã–π',
    '–≥–Ω–∏–¥–∞ –º–µ–ª–∫–∞—è', '—Å—É–∫–∞ –±–ª—è–¥—Å–∫–∞—è', '—Å–∫–æ—Ç–∏–Ω–∞ –ø–æ–¥–ª–∞—è', '–ø–∏–∑–¥–µ—Ü –ø–æ–ª–Ω—ã–π', '–∑–∞–ª—É–ø–∞ —á–µ—Ä–Ω–∞—è',

    # –°–ª–µ–Ω–≥ –∏ –∏—Å–∫–∞–∂–µ–Ω–∏—è
    '–ø–∏–∑–¥–µ—Ü', '–µ–±–∞–Ω–∞—Ç', '—É–µ–±–∞–Ω', '–º—É–¥–∏–ª–∞', '–º—É–¥–∞–∫', '–∑–∞–ª—É–ø–∞', '—Ö—É–µ—Å–æ—Å', '–≤—ã–µ–±–æ–Ω', '–µ–±–ª–∞–Ω',
    '–ø–∏–¥–æ—Ä–æ–∫', '–¥—Ä–∏—Å—Ç—É–Ω', '–≥–æ–≤–Ω—é–∫', '–±–ª—è–¥—É–Ω', '–µ–±–ª–æ', '–∑–∞—ë–±', '–¥–æ–ª–±–æ–µ–±', '–º—É–¥–∞—á–æ–∫',
    '–±–ª—è—Ö–∞', '–±–ª—è–¥—å', '—Ö—É–π–Ω—è', '–µ–±–∞–Ω—ã–π', '–ø–∏–∑–¥–∞—Ç—ã–π', '–∑–∞–µ–±–∏—Å—å', '–ø–∏–∑–¥–µ—Ü–æ–≤—ã–π', '–µ–±–∞–Ω—É—Ç—ã–π',
    '–µ–±–∞–ª', '–ø–∏–∑–¥–∞–Ω—É—Ç—ã–π', '–µ–±—É—á–∏–π', '—Å–∞—Å–∞—Ç—å', '—Ö—É—è—Ä–∏—Ç—å', '–≤—ã–µ–±—ã–≤–∞—Ç—å—Å—è', '–∑–∞–¥—Ä–æ—Ç', '–ª—É–∑–µ—Ä',
    '–æ—Ç—Å—Ç–æ–π–Ω–∏–∫', '–¥—É—Ä–∞—á–æ–∫', '–ª–æ—Ö—É—à–∞', '–±—ã–¥–ª–æ', '–∑–∞–¥—Ä–æ—Ç–∏—Ç—å', '–ø–µ—Ä–¥—É–Ω', '–≥–æ–Ω–¥–æ–Ω—á–∏–∫', '–º–∞–Ω–¥–∞–≤–æ—à–∫–∞',

    # –î—Ä—É–≥–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã
    '—É—Ä–æ–¥–∏–Ω–∞', '—É–±–ª—é–¥–æ–∫', '—á–º–æ', '–¥—Ä–æ—á–∏–ª–∞', '–ø–µ–¥–µ—Ä–∞—Å—Ç', '—Ç—É–ø–æ—Ä—ã–ª—ã–π', '–∫–æ–Ω—á–µ–Ω—ã–π',
    '–º—É–¥–∞—á—å–µ', '–≥–æ–≤–Ω—é–∫', '—à–º–∞—Ä–∫–∞', '–¥–µ–±–∏–ª–∫–∞', '–∫—Ä–µ—Ç–∏–Ω—á–∏–∫', '–¥–æ–ª–±–æ—ë–±—á–∏–∫', '—Ö—É–∏–ª–∞',
    '–≤—ã—ë–±–∫–∞', '–∑–∞—ë–±–∫–∞', '–º—É–¥–∞–∫ —Å–æ—Å—ë—Ç', '–ø–∏–¥–æ—Ä —Å–æ—Å—ë—Ç', '–µ–±–∞–ª –≤ —Ä–æ—Ç', '—à–ª—é—Ö–∞ –µ–±–∞–Ω–∞—è',
}


def normalize_text(text: str) -> str:
    """–ù–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç —Ç–µ–∫—Å—Ç –¥–ª—è –∫–ª—é—á–∞ —Å–ª–æ–≤–∞—Ä—è ‚Äî –Ω–∏–∂–Ω–∏–π —Ä–µ–≥–∏—Å—Ç—Ä –∏ —É–¥–∞–ª–µ–Ω–∏–µ –ª–∏—à–Ω–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤"""
    return re.sub(r'\W+', ' ', text.lower()).strip()


def contains_offense(text: str) -> bool:
    """–ü—Ä–æ–≤–µ—Ä–∫–∞, –µ—Å—Ç—å –ª–∏ –æ—Å–∫–æ—Ä–±–ª–µ–Ω–∏–µ –≤ –ª—é–±–æ–º —Å–∫–ª–æ–Ω–µ–Ω–∏–∏, –µ—Å–ª–∏ –µ—Å—Ç—å '—Ç—ã' –∏–ª–∏ '—Ñ–µ—Ä–Ω–∏'"""
    words = re.findall(r'\w+', text.lower())
    has_target = any(w in ("—Ç—ã", "—Ñ–µ—Ä–Ω–∏") for w in words)

    if not has_target:
        return False

    for word in words:
        parsed = morph.parse(word)
        if parsed:
            for p in parsed:
                if p.normal_form in bad_words:  # –∑–¥–µ—Å—å –ø–æ–º–µ–Ω—è–ª —Å bad_lemmas –Ω–∞ bad_words
                    return True
    return False


def save_phrases():
    """–°–æ—Ö—Ä–∞–Ω—è–µ—Ç –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π —Å–ª–æ–≤–∞—Ä—å —Ñ—Ä–∞–∑ –≤ —Ñ–∞–π–ª"""
    with open(PHRASES_FILE, 'w', encoding='utf-8') as f:
        json.dump(ai_phrases, f, ensure_ascii=False, indent=4)


def learn_phrase(user_text: str, bot_reply: str):
    """–î–æ–±–∞–≤–ª—è–µ—Ç –ø–∞—Ä—É '–≤–æ–ø—Ä–æ—Å ‚Äî –æ—Ç–≤–µ—Ç' –≤ –±–∞–∑—É, –µ—Å–ª–∏ –µ—ë —Ç–∞–º –µ—â—ë –Ω–µ—Ç"""
    norm_text = normalize_text(user_text)

    if norm_text not in ai_phrases:
        ai_phrases[norm_text] = []

    if bot_reply not in ai_phrases[norm_text]:
        ai_phrases[norm_text].append(bot_reply)
        save_phrases()


def evaluate_math_expression(expr: str) -> str:
    original_expr = expr.strip()
    expr = expr.replace(" ", "").replace("√∑", "/")
    expr = re.sub(r"[=+\?]+$", "", expr)

    # –ó–∞–º–µ–Ω–∞ –∫–æ—Ä–Ω—è –Ω–∞ math.sqrt()
    expr = re.sub(r"‚àö(\d+(\.\d+)?)", r"math.sqrt(\1)", expr)
    expr = re.sub(r"‚àö\(([^)]+)\)", r"math.sqrt(\1)", expr)

    allowed_pattern = r"^[\d\+\-\*/\(\)\.mathsqrt]+$"
    if not re.fullmatch(allowed_pattern, expr):
        return "‚ùå –í –≤—ã—Ä–∞–∂–µ–Ω–∏–∏ —Å–æ–¥–µ—Ä–∂–∞—Ç—Å—è –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–µ —Å–∏–º–≤–æ–ª—ã –∏–ª–∏ —Ñ–æ—Ä–º–∞—Ç. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∏–º–µ—Ä –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞"

    try:
        result = eval(expr, {"__builtins__": None, "math": math})
    except Exception as e:
        return (
            "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã—á–∏—Å–ª–∏—Ç—å –≤—ã—Ä–∞–∂–µ–Ω–∏–µ. –í–æ–∑–º–æ–∂–Ω–æ, –≤ –ø—Ä–∏–º–µ—Ä–µ –æ—à–∏–±–∫–∞ –∏–ª–∏ –Ω–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è.\n"
            "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ:\n"
            "‚Ä¢ –ü—Ä–∞–≤–∏–ª—å–Ω–æ –≤–≤–µ–¥–µ–Ω—ã —á–∏—Å–ª–∞ –∏ –æ–ø–µ—Ä–∞—Ü–∏–∏ (+, -, *, /, ‚àö).\n"
            "‚Ä¢ –°–∫–æ–±–∫–∏ —Ä–∞—Å—Å—Ç–∞–≤–ª–µ–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.\n"
            "‚Ä¢ –ù–µ—Ç –ª–∏—à–Ω–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤ –∏–ª–∏ –æ–ø–µ—á–∞—Ç–æ–∫.\n"
            f"–ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —É–ø—Ä–æ—Å—Ç–∏—Ç—å –ø—Ä–∏–º–µ—Ä –∏–ª–∏ –∑–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å –ø–æ-–¥—Ä—É–≥–æ–º—É."
        )

    if isinstance(result, float):
        result = round(result, 6)
        if result.is_integer():
            result = int(result)

    templates = [
        f"üßÆ –í–æ—Ç —Ä–µ—à–µ–Ω–∏–µ –≤–∞—à–µ–≥–æ –ø—Ä–∏–º–µ—Ä–∞:\n{original_expr}\n\n–û—Ç–≤–µ—Ç: {result}",
        f"üìä –†–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã—á–∏—Å–ª–µ–Ω–∏—è:\n{original_expr} = {result}",
        f"‚úèÔ∏è –ü–æ—Å—á–∏—Ç–∞–ª –≤–∞—à –ø—Ä–∏–º–µ—Ä:\n{original_expr}\n\n–ò –ø–æ–ª—É—á–∏–ª: {result}",
        f"üî¢ –ü—Ä–∏–º–µ—Ä {original_expr} —Ä–µ—à—ë–Ω!\n\n–û—Ç–≤–µ—Ç: {result}",
        f"üìê –í—ã—Ä–∞–∂–µ–Ω–∏–µ: {original_expr}\n–û—Ç–≤–µ—Ç: {result}"
    ]

    return random.choice(templates)


def get_user_decoders(user_id: int) -> int:
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute(
        "SELECT quantity FROM inventory WHERE owner_id=? AND item_name='–î–µ–∫–æ–¥–µ—Ä'",
        (str(user_id),)
    )
    result = cursor.fetchone()
    conn.close()
    return result[0] if result else 0


MAX_LEN = 4000


# —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–π —Ä–∞–∑–±–∏–≤–∫–∏ —Ç–µ–∫—Å—Ç–∞
def split_text(text, max_len=MAX_LEN):
    return [text[i:i + max_len] for i in range(0, len(text), max_len)]


jokes = [
    "‚Äî –î–æ–∫—Ç–æ—Ä, —É –º–µ–Ω—è –∞–º–Ω–µ–∑–∏—è!\n‚Äî –° –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫–∞?",
    "‚Äî –ü–∞–ø–∞, –∞ —è –º–æ–≥—É –ø–æ–π—Ç–∏ –≥—É–ª—è—Ç—å?\n‚Äî –ù–µ—Ç!\n‚Äî –ê –ø–æ—á–µ–º—É?\n‚Äî –ü–æ—Ç–æ–º—É —á—Ç–æ —è —Å–∫–∞–∑–∞–ª –Ω–µ—Ç.",
    "–°–æ–±–∞–∫–∞ –Ω–∞ –ø—Ä–∏–µ–º–µ —É –ø—Å–∏—Ö–æ–ª–æ–≥–∞:\n‚Äî –ì–∞–≤-–≥–∞–≤‚Ä¶\n‚Äî –•–º–º, –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–µ –ø—Ä–∏–∑–Ω–∞–Ω–∏–µ.",
    "‚Äî –ü–æ—á–µ–º—É —Ç—ã –æ–ø–æ–∑–¥–∞–ª?\n‚Äî –°–æ—Ä–≤–∞–ª—Å—è –±—É–¥–∏–ª—å–Ω–∏–∫.",
    "–ü–æ—á–µ–º—É –º—ã —Å–º–µ—ë–º—Å—è –Ω–∞–¥ —á—ë—Ä–Ω—ã–º —é–º–æ—Ä–æ–º? \n–ü–æ—Ç–æ–º—É —á—Ç–æ –∏–Ω–∞—á–µ –±—ã –ø–ª–∞–∫–∞–ª–∏.",
    "–ö–∞–∂–¥—ã–π –¥–µ–Ω—å ‚Äî —à–∞–≥ –±–ª–∏–∂–µ –∫ —Å–º–µ—Ä—Ç–∏. \n–ù–æ —à—É—Ç–∫–∞ –≤ —Ç–æ–º, —á—Ç–æ –Ω–∏–∫—Ç–æ –Ω–µ —Å–ø–µ—à–∏—Ç.",
    "–õ—É—á—à–∏–π —Å–ø–æ—Å–æ–± –∏–∑–±–µ–∂–∞—Ç—å —Å—Ç—Ä–µ—Å—Å–∞ ‚Äî –Ω–∞–ø–æ–º–Ω–∏—Ç—å —Å–µ–±–µ, —á—Ç–æ –≤—Å–µ –º—ã —É–º—Ä—ë–º.",
    "–°–º–µ—Ä—Ç—å ‚Äî –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–ª–∞–Ω –Ω–∞ –≤—ã—Ö–æ–¥–Ω—ã–µ.",
    "–ü–æ—á–µ–º—É —Å–∫–µ–ª–µ—Ç –Ω–µ —Å—Ç–∞–ª –ø–æ–ª–∏—Ç–∏–∫–æ–º? \n–û–Ω —Å–ª–∏—à–∫–æ–º —á–µ—Å—Ç–Ω—ã–π, –∏ —É –Ω–µ–≥–æ –Ω–µ—Ç –∫–æ—Å—Ç–µ–π –≤ —à–∫–∞—Ñ—É.",
    "–ù–µ–∫–æ—Ç–æ—Ä—ã–µ –ª—é–¥–∏ —Ç–∞–∫–∏–µ –º—Ä–∞—á–Ω—ã–µ, —á—Ç–æ —Ç—å–º–∞ –ø—Ä–∏—Ö–æ–¥–∏—Ç –∫ –Ω–∏–º –Ω–∞ —á–∞–π.",
    "–ü–æ—á–µ–º—É –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç—ã –ª—é–±—è—Ç –∑–∏–º—É? \n–ü–æ—Ç–æ–º—É —á—Ç–æ —Å–Ω–µ–≥ ‚Äî —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ –±–µ–ª—ã–µ –Ω—É–ª–∏! ‚ùÑÔ∏è",
    "–ö–∞–∫ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è –∫–æ—Ç-–ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç? \n–ö—ç—à-–∫–æ—Ç üò∏",
    "–£—á—ë–Ω—ã–π —Å–∫–∞–∑–∞–ª: \n'–ú–æ—è —Ç–µ–æ—Ä–∏—è –ø–æ–∫–∞ –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–º–∏, –Ω–æ —ç—Ç–æ –Ω–µ –º–µ—à–∞–µ—Ç –º–Ω–µ –±—ã—Ç—å –ø—Ä–∞–≤—ã–º!' üòÇ",
    "‚Äî –ü–æ—á–µ–º—É —Ç—ã –æ–ø–æ–∑–¥–∞–ª –Ω–∞ —Ä–∞–±–æ—Ç—É?\n‚Äî –ü—ã—Ç–∞–ª—Å—è –ø–æ–π–º–∞—Ç—å Wi-Fi —Å–∏–≥–Ω–∞–ª –Ω–∞ —É–ª–∏—Ü–µ! üì∂",
    "–í—Ä–∞—á —Å–∫–∞–∑–∞–ª: \n'–°–º–µ–π—Ç–µ—Å—å –∫–∞–∂–¥—ã–π –¥–µ–Ω—å!' \n–Ø —Å–∫–∞–∑–∞–ª: \n'–•–æ—Ä–æ—à–æ, —è –±—É–¥—É —á–∏—Ç–∞—Ç—å –≤–∞—à–∏ —Å—á–µ—Ç–∞!' üòÖ",
    "‚Äî –ü–æ—á–µ–º—É —Ä–æ–±–æ—Ç –Ω–µ –ø–æ—à—ë–ª –≥—É–ª—è—Ç—å? \n‚Äî –û–Ω –∑–∞–≤–∏—Å –æ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è. ü§ñ",
    "‚Äî –ú–∞–º–∞, –∞ —É –º–µ–Ω—è –±—É–¥–µ—Ç —Å–æ–±–∞–∫–∞? \n‚Äî –ù–µ—Ç, —Å—ã–Ω–æ–∫, —É —Ç–µ–±—è –±—É–¥–µ—Ç —Å–æ–±–∞–∫–∞ —Ç–æ–ª—å–∫–æ –≤ –ø–µ—Ä–µ–Ω–æ—Å–∫–µ —Å –∫–æ—Ç–æ–º —Å–æ—Å–µ–¥–µ–π. üê∂üò∏",
    "–ü–æ—á–µ–º—É —É—Ç–∫–∏ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –Ω–æ—Å—è—Ç —á–∞—Å—ã? \n–ü–æ—Ç–æ–º—É —á—Ç–æ –æ–Ω–∏ –≤—Å–µ–≥–¥–∞ –∑–Ω–∞—é—Ç, —á—Ç–æ –ø–æ—Ä–∞ –Ω–∞ –ø—Ä—É–¥. ü¶Ü",
    "‚Äî –ü–∞–ø–∞, –∞ –ø–æ—á–µ–º—É —É –º–µ–Ω—è –≥–ª–∞–∑–∞ –≥–æ–ª—É–±—ã–µ? \n‚Äî –ü–æ—Ç–æ–º—É —á—Ç–æ —Ç—ã –ª—é–±–∏—à—å –º–æ—Ä–µ, —Å—ã–Ω–æ–∫. üåä",
    "–ü—Ä–∏—Ö–æ–¥–∏—Ç –º—É–∂–∏–∫ –∫ –≤—Ä–∞—á—É: \n‚Äî –î–æ–∫—Ç–æ—Ä, —É –º–µ–Ω—è –ø—Ä–æ–±–ª–µ–º—ã —Å –ø–∞–º—è—Ç—å—é.\n ‚Äî –° –∫–∞–∫–∏—Ö –ø–æ—Ä? \n‚Äî –° –∫–∞–∫–∏—Ö –ø–æ—Ä —á—Ç–æ? ü§î",
    "–ù–∞ —ç–∫–∑–∞–º–µ–Ω–µ: \n‚Äî –ü–æ—á–µ–º—É –≤—ã —Å–ø–∏—Å—ã–≤–∞–µ—Ç–µ? \n‚Äî –Ø –Ω–µ —Å–ø–∏—Å—ã–≤–∞—é, —è –ø–æ–ª—å–∑—É—é—Å—å –ø–æ–¥—Å–∫–∞–∑–∫–æ–π –≤—Å–µ–ª–µ–Ω–Ω–æ–π. üåå",
    "–ö–∞–∫ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è –∫–æ—Ç, –∫–æ—Ç–æ—Ä—ã–π —É–º–µ–µ—Ç –ø–µ—Ç—å? \n–ú—è—É–ª–∞–Ω üé§üò∫",
    "‚Äî –ü–æ—á–µ–º—É –≤ —à–∫–æ–ª–µ –∑–≤–æ–Ω—è—Ç –¥–≤–∞–∂–¥—ã? \n‚Äî –ß—Ç–æ–±—ã –≤—ã —É—Å–ø–µ–ª–∏ –ø–µ—Ä–µ–¥—É–º–∞—Ç—å –∏–¥—Ç–∏ –Ω–∞ —É—Ä–æ–∫. üõéÔ∏è",
    "–°–∏–¥—è—Ç –¥–≤–∞ —Ç–æ–º–∞—Ç–∞ –Ω–∞ –≤–µ—Ç–∫–µ. \n–û–¥–∏–Ω –≥–æ–≤–æ—Ä–∏—Ç: \n‚Äî –°–º–æ—Ç—Ä–∏, –∫–∞–∫–æ–π –∫—Ä–∞—Å–Ω—ã–π! \n–í—Ç–æ—Ä–æ–π –æ—Ç–≤–µ—á–∞–µ—Ç: \n‚Äî –Ø —Ç–æ–∂–µ –≤–∏–∂—É. üçÖ",
    "‚Äî –î–æ–∫—Ç–æ—Ä, —É –º–µ–Ω—è –≤—Å—ë –≤—Ä–µ–º—è –ø–ª–æ—Ö–æ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ. \n‚Äî –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Ä–∞–¥–æ–≤–∞—Ç—å—Å—è –º–µ–ª–æ—á–∞–º. \n‚Äî –ö–∞–∫ –Ω–∞–ø—Ä–∏–º–µ—Ä? \n‚Äî –í–∞—à —Å—á—ë—Ç –∑–∞ —ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ. ‚ö°",
    "–í –ª–µ—Å—É: ‚Äî –ü–æ—á–µ–º—É –±–µ–ª–∫–∞ –±–µ–≥–∞–µ—Ç –ø–æ –∫—Ä—É–≥—É? \n‚Äî –û–Ω–∞ —Ç—Ä–µ–Ω–∏—Ä—É–µ—Ç—Å—è –∫ –º–∞—Ä–∞—Ñ–æ–Ω—É. üêøÔ∏è",
    "–ü—Ä–∏—Ö–æ–¥–∏—Ç –∑–∞–π—á–∏–∫ –≤ –∞–ø—Ç–µ–∫—É: \n‚Äî –î–∞–π—Ç–µ –º–Ω–µ –º–æ—Ä–∫–æ–≤–∫—É. \n‚Äî –ó–∞–π—á–∏–∫, –º—ã —Ç—É—Ç –ª–µ–∫–∞—Ä—Å—Ç–≤–∞ –ø—Ä–æ–¥–∞—ë–º. \n‚Äî –¢–æ–≥–¥–∞ –¥–∞–π—Ç–µ –≤–∏—Ç–∞–º–∏–Ω –°. ü•ï",
    "–£—á–∏—Ç–µ–ª—å: \n‚Äî –ü–æ—á–µ–º—É –¥–æ–º–∞—à–∫—É –Ω–µ —Å–¥–µ–ª–∞–ª? \n‚Äî –ò–Ω—Ç–µ—Ä–Ω–µ—Ç —Å–ª–æ–º–∞–ª—Å—è. \n‚Äî –ê —Ä—É—á–∫–∞? \n‚Äî –û–Ω–∞ –≤ –æ—Ç–ø—É—Å–∫–µ. ‚úèÔ∏è",
    "–ú—É–∂—á–∏–Ω–∞: ‚Äî –Ø –∫—É–ø–∏–ª –∂–µ–Ω–µ –∫–Ω–∏–≥—É. \n–û–Ω–∞ –¥–æ–≤–æ–ª—å–Ω–∞. \n‚Äî –ö–Ω–∏–≥–∞ –±—ã–ª–∞ –æ —á–µ–º? \n‚Äî –ö–∞–∫ –Ω–µ –∑–ª–∏—Ç—å –º—É–∂–∞. üìö",
    "‚Äî –ö–∞–∫ –Ω–∞–∑—ã–≤–∞—é—Ç—Å—è —Ä—ã–±—ã, –∫–æ—Ç–æ—Ä—ã–µ —É–º–µ—é—Ç –ø–ª–∞–≤–∞—Ç—å? \n‚Äî –†—ã–±—ã. üêü",
    "–ü–æ—á–µ–º—É —Å–Ω–µ–≥–æ–≤–∏–∫ –Ω–µ –º–æ–∂–µ—Ç —Ç–∞–Ω—Ü–µ–≤–∞—Ç—å? \n‚Äî –£ –Ω–µ–≥–æ –Ω–µ—Ç —Å–µ—Ä–¥—Ü–∞ –¥–ª—è —Ä–∏—Ç–º–∞. ‚õÑ",
    "‚Äî –°—ã–Ω–æ–∫, –ø–æ—á–µ–º—É –æ–ø–æ–∑–¥–∞–ª –≤ —à–∫–æ–ª—É? \n‚Äî –ü—Ä–æ—Å–ø–∞–ª –Ω–∞ –æ–±–ª–∞–∫–µ. ‚òÅÔ∏è",
    "–£—á–∏—Ç–µ–ª—å –±–∏–æ–ª–æ–≥–∏–∏ —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç: \n‚Äî –ß—Ç–æ –æ–±—â–µ–≥–æ —É –ª—è–≥—É—à–∫–∏ –∏ —á–µ–ª–æ–≤–µ–∫–∞? \n‚Äî –õ—è–≥—É—à–∫–∞ —É–º–µ–µ—Ç –ø—Ä—ã–≥–∞—Ç—å, —á–µ–ª–æ–≤–µ–∫ ‚Äî —Ç–æ–∂–µ, –∫–æ–≥–¥–∞ –æ–ø–∞–∑–¥—ã–≤–∞–µ—Ç. üê∏",
    "‚Äî –ü–æ—á–µ–º—É —á–∞–π –≤—Å–µ–≥–¥–∞ –≥–æ—Ä—è—á–∏–π? \n‚Äî –ü–æ—Ç–æ–º—É —á—Ç–æ –µ–≥–æ –±–æ—è—Ç—Å—è –ø–∏—Ç—å —Ö–æ–ª–æ–¥–Ω—ã–º. üçµ",
    "‚Äî –ö–∞–∫ –ø–æ–π–º–∞—Ç—å —Å–ª–æ–Ω–∞? \n‚Äî –ù–∞–¥–µ–Ω—å—Ç–µ –º–∞–ª–µ–Ω—å–∫–∏–π –ø–ª–∞—â –∏ –ø—Ä–∏—Ç–≤–æ—Ä–∏—Ç–µ—Å—å –±–∞–Ω–∫–æ–º–∞—Ç–æ–º. üêò",
    "‚Äî –ü–∞–ø–∞, –∞ –ø—Ä–∞–≤–¥–∞, —á—Ç–æ –µ—Å–ª–∏ –º–Ω–æ–≥–æ —á–∏—Ç–∞—Ç—å, —É–º–Ω–µ–µ —Å—Ç–∞–Ω–µ—à—å? \n‚Äî –ü—Ä–∞–≤–¥–∞, —Å—ã–Ω–æ–∫, –∏ —Å–ø–∞—Ç—å –º–µ–Ω—å—à–µ –ø—Ä–∏–¥—ë—Ç—Å—è. üìñ",
    "–ü–æ—á–µ–º—É —Å–ª–æ–Ω –Ω–µ –ø—Ä—è—á–µ—Ç—Å—è –≤ –¥–µ—Ä–µ–≤—å—è—Ö? \n–ü–æ—Ç–æ–º—É —á—Ç–æ –æ–Ω —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. üêò",
    "–ö–∞–∫ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è –º–µ–¥–≤–µ–¥—å –±–µ–∑ –∑—É–±–æ–≤? \n–ì—É–º–º–µ–¥–≤–µ–¥—å. üêª",
    "‚Äî –ü–æ—á–µ–º—É –∫—É—Ä–∏—Ü–∞ –ø–µ—Ä–µ—à–ª–∞ –¥–æ—Ä–æ–≥—É? \n‚Äî –ß—Ç–æ–±—ã –¥–æ–π—Ç–∏ –¥–æ –¥—Ä—É–≥–æ–π —Å—Ç–æ—Ä–æ–Ω—ã! üêî",
    "–ß—Ç–æ —Å–∫–∞–∑–∞–ª –æ–¥–∏–Ω –∫–∞–∫—Ç—É—Å –¥—Ä—É–≥–æ–º—É? \n‚Äî –î–µ—Ä–∂–∏—Å—å, –±—Ä–∞—Ç! üåµ",
    "–ü–æ—á–µ–º—É —É –ø–∏–Ω–≥–≤–∏–Ω–æ–≤ –Ω–µ—Ç –¥—Ä—É–∑–µ–π? \n‚Äî –ü–æ—Ç–æ–º—É —á—Ç–æ –æ–Ω–∏ –≤—Å–µ–≥–¥–∞ –≤ –∫–æ—Å—Ç—é–º–∞—Ö. üêß",
    "‚Äî –ú–∞–º–∞, –∞ –ø–æ—á–µ–º—É —É –º–µ–Ω—è —Ç–∞–∫–∏–µ –¥–ª–∏–Ω–Ω—ã–µ –Ω–æ–≥–∏? \n‚Äî –ß—Ç–æ–±—ã —É—Å–ø–µ–≤–∞—Ç—å –∑–∞ —Å–≤–æ–∏–º–∏ –º–µ—á—Ç–∞–º–∏. ü¶µ",
    "–ü—Ä–∏—Ö–æ–¥–∏—Ç –º—ã—à—å –∫ –≤—Ä–∞—á—É: \n‚Äî –£ –º–µ–Ω—è —á—Ç–æ-—Ç–æ —Å –∑—É–±–∞–º–∏. \n‚Äî –ê —É –≤–∞—Å –Ω–µ —Å—ã—Ä? üê≠",
    "–ü–æ—á–µ–º—É –≤–µ–ª–æ—Å–∏–ø–µ–¥ –Ω–µ –º–æ–∂–µ—Ç —Å—Ç–æ—è—Ç—å? \n‚Äî –ü–æ—Ç–æ–º—É —á—Ç–æ –æ–Ω –¥–≤—É—Ö–∫–æ–ª–µ—Å–Ω—ã–π. üö≤",
    "–ß—Ç–æ –¥–µ–ª–∞–µ—Ç –ª—É–Ω–∞, –∫–æ–≥–¥–∞ —É—Å—Ç–∞–ª–∞? \n‚Äî –ó–∞—Å—ã–ø–∞–µ—Ç –∑–∞ –æ–±–ª–∞–∫–∞–º–∏. üåô",
    "–ö–∞–∫ –Ω–∞–∑—ã–≤–∞—é—Ç—Å—è —Ä—ã–±–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –ª—é–±—è—Ç –º—É–∑—ã–∫—É? \n‚Äî –ü–æ–ø-—Ñ–∏—à. üéµüêü",
    "‚Äî –ü–∞–ø–∞, –∞ –∑–∞—á–µ–º –ª—é–¥–∏ —Å–ø—è—Ç? \n‚Äî –ß—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å —Å–Ω—ã. ‚Äî –ê –∑–∞—á–µ–º —Å–Ω—ã? ‚Äî –ß—Ç–æ–±—ã –∏–Ω–æ–≥–¥–∞ –æ—Ç–¥–æ—Ö–Ω—É—Ç—å –æ—Ç –ª—é–¥–µ–π. üõå",
    "–ü–æ—á–µ–º—É —á–µ—Ä–µ–ø–∞—Ö–∞ –Ω–µ –ª—é–±–∏—Ç –±–µ–≥–∞—Ç—å? \n‚Äî –ü–æ—Ç–æ–º—É —á—Ç–æ —É –Ω–µ—ë –Ω–µ—Ç —Å–ø—Ä–∏–Ω—Ç–µ—Ä—Å–∫–æ–π –º–æ—Ç–∏–≤–∞—Ü–∏–∏. üê¢",
    "–ß—Ç–æ —Å–∫–∞–∑–∞–ª –æ–¥–∏–Ω –∫–∞–º–µ–Ω—å –¥—Ä—É–≥–æ–º—É? \n‚Äî –ù–µ –≤–æ–ª–Ω—É–π—Å—è, –º—ã –æ–±–∞ –Ω–µ–ø–æ–¥–≤–∏–∂–Ω—ã. ü™®",
    "–ü–æ—á–µ–º—É –∑–µ–±—Ä—ã –ø–æ–ª–æ—Å–∞—Ç—ã–µ? \n‚Äî –ß—Ç–æ–±—ã –ª–µ–≥–∫–æ –Ω–∞—Ö–æ–¥–∏—Ç—å –¥—Ä—É–∑–µ–π –Ω–∞ —Å–∞—Ñ–∞—Ä–∏. ü¶ì",
    "‚Äî –ú–∞–º–∞, –∞ –ø–æ—á–µ–º—É –∫–æ—à–∫–∞ –º—É—Ä–ª—ã—á–µ—Ç? \n‚Äî –ü–æ—Ç–æ–º—É —á—Ç–æ –æ–Ω–∞ —Å—á–∞—Å—Ç–ª–∏–≤–∞, —á—Ç–æ –Ω–µ —Ç—ã. üò∏",
    "–ü–æ—á–µ–º—É —Å–Ω–µ–≥ —Ç–∞–µ—Ç –ª–µ—Ç–æ–º? \n‚Äî –ü–æ—Ç–æ–º—É —á—Ç–æ –µ–º—É –∂–∞—Ä–∫–æ. ‚ùÑÔ∏è",
    "–ö–∞–∫ –Ω–∞–∑—ã–≤–∞—é—Ç—Å—è –ª–µ—Ç–∞—é—â–∏–µ –∫–æ—Ä–æ–≤—ã? \n‚Äî –ú—É—É—É—Ö–∏. üêÑ‚úàÔ∏è",
    "–ü–æ—á–µ–º—É —É –µ–∂–∏–∫–∞ –∏–≥–æ–ª–∫–∏? \n‚Äî –ß—Ç–æ–±—ã –Ω–µ –∑–∞–±—ã–≤–∞–ª–∏, —á—Ç–æ –æ–Ω –∫–æ–ª—é—á–∏–π. ü¶î",
    "‚Äî –ö–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç? \n‚Äî –ú–æ–ª–Ω–∏—è. \n‚Äî –ü–æ—á–µ–º—É? \n‚Äî –ë—ã—Å—Ç—Ä–æ –∏—Å—á–µ–∑–∞—é, –∫–æ–≥–¥–∞ —á—Ç–æ-—Ç–æ –Ω–µ –Ω—Ä–∞–≤–∏—Ç—Å—è. ‚ö°",
    "–ß—Ç–æ —Å–∫–∞–∑–∞–ª –æ–¥–∏–Ω –∫–∞—Ä–∞–Ω–¥–∞—à –¥—Ä—É–≥–æ–º—É? \n‚Äî –î–µ—Ä–∂–∏—Å—å –æ—Å—Ç—Ä–æ–≥–æ –∫–æ–Ω—Ü–∞. ‚úèÔ∏è",
    "–ü–æ—á–µ–º—É –∫–∏—Ç—ã –Ω–µ –ª–µ—Ç–∞—é—Ç? \n‚Äî –ü–æ—Ç–æ–º—É —á—Ç–æ –∏–º —Ç—è–∂–µ–ª–æ –¥–µ—Ä–∂–∞—Ç—å—Å—è –∑–∞ –æ–±–ª–∞–∫–∞. üêã",
    "–ö–∞–∫ —É—Ç–∫–∞ –ø–∏—à–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è? \n‚Äî –ß–µ—Ä–µ–∑ quackbook. ü¶Ü",
    "‚Äî –ü–æ—á–µ–º—É —É–ª–∏—Ç–∫–∞ –º–µ–¥–ª–µ–Ω–Ω–æ –ø–æ–ª–∑—ë—Ç? \n‚Äî –ß—Ç–æ–±—ã —É—Å–ø–µ—Ç—å –Ω–∞—Å–ª–∞–¥–∏—Ç—å—Å—è –¥–æ—Ä–æ–≥–æ–π. üêå",
    "–ü–æ—á–µ–º—É –≤–æ—Ä–æ–±–µ–π –Ω–µ –≤–æ–¥–∏—Ç –º–∞—à–∏–Ω—É? \n‚Äî –ü–æ—Ç–æ–º—É —á—Ç–æ —É –Ω–µ–≥–æ –Ω–µ—Ç –ø—Ä–∞–≤. üê¶",
    "–ß—Ç–æ —Å–∫–∞–∑–∞–ª –æ–¥–∏–Ω —Ö–ª–µ–± –¥—Ä—É–≥–æ–º—É? \n‚Äî –ù–µ –ø–µ—Ä–µ–∂–∞—Ä–∏–≤–∞–π—Å—è! üçû",
    "‚Äî –ü–æ—á–µ–º—É –ø—á—ë–ª—ã –Ω–µ —Ö–æ–¥—è—Ç –≤ —à–∫–æ–ª—É? \n‚Äî –û–Ω–∏ —É–∂–µ –∑–Ω–∞—é—Ç –≤—Å—ë –æ –º–µ–¥–µ. üêù",
    "–ü–æ—á–µ–º—É –º—ã—à—å –Ω–æ—Å–∏—Ç —à–ª—è–ø—É? \n‚Äî –ß—Ç–æ–±—ã –∫–∞–∑–∞—Ç—å—Å—è –±–æ–ª—å—à–µ. üé©",
    "–ß—Ç–æ —Å–∫–∞–∑–∞–ª —Å–Ω–µ–≥–æ–≤–∏–∫ –º–æ—Ä–∫–æ–≤–∫–µ? \n‚Äî –¢—ã –º–æ—è –Ω–æ—Å–æ–≤–∞—è –∑–≤–µ–∑–¥–∞. ‚õÑü•ï",
    "–ü–æ—á–µ–º—É —É –ª–∞–º—ã –≤—Å–µ–≥–¥–∞ –Ω–µ–¥–æ–≤–æ–ª—å–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ? \n‚Äî –ü–æ—Ç–æ–º—É —á—Ç–æ –æ–Ω–∞ —Å—á–∏—Ç–∞–µ—Ç –≤—Å—ë —Å–∫—É—á–Ω—ã–º. ü¶ô",
    "‚Äî –ö–∞–∫ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è —Å–æ–±–∞–∫–∞, –∫–æ—Ç–æ—Ä–∞—è –ø–æ—ë—Ç? \n‚Äî –ë–∞—Ä-–∫–∏—Ç. üêïüé§",
    "–ß—Ç–æ —Å–∫–∞–∑–∞–ª –æ–¥–∏–Ω –∞–ø–µ–ª—å—Å–∏–Ω –¥—Ä—É–≥–æ–º—É? \n‚Äî –î–µ—Ä–∂–∏—Å—å, —Å–æ–∫–∞ —Ö–≤–∞—Ç–∏—Ç –Ω–∞ –≤—Å–µ—Ö. üçä",
    "–ü–æ—á–µ–º—É –æ—Å—ë–ª —Å—Ç–æ–∏—Ç –Ω–∞ —É–ª–∏—Ü–µ –ø–æ–¥ –¥–æ–∂–¥—ë–º? \n‚Äî –ü–æ—Ç–æ–º—É —á—Ç–æ –æ–Ω –Ω–µ —É–º–µ–µ—Ç –ø–ª–∞–≤–∞—Ç—å. üê¥",
    "–ß—Ç–æ —Å–∫–∞–∑–∞–ª –æ–¥–∏–Ω –ª–∏—Å—Ç–æ–∫ –¥—Ä—É–≥–æ–º—É? \n‚Äî –ü–∞–¥–∞–π –∞–∫–∫—É—Ä–∞—Ç–Ω–æ! üçÇ",
    "–ü–æ—á–µ–º—É –∫—Ä–æ–∫–æ–¥–∏–ª—ã –Ω–µ –ª–µ—Ç–∞—é—Ç? \n‚Äî –ü–æ—Ç–æ–º—É —á—Ç–æ —É –Ω–∏—Ö –Ω–µ—Ç –∫—Ä—ã–ª—å–µ–≤. üêä",
    "‚Äî –ü–æ—á–µ–º—É –ø–∞–Ω–¥–∞ –µ—Å—Ç –±–∞–º–±—É–∫? \n‚Äî –ü–æ—Ç–æ–º—É —á—Ç–æ –æ–Ω–∞ –≤–µ–≥–∞–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é. üêº",
    "–ß—Ç–æ —Å–∫–∞–∑–∞–ª –æ–¥–∏–Ω –æ–≥—É—Ä–µ—Ü –¥—Ä—É–≥–æ–º—É? \n‚Äî –ù–µ –∫–∏—Å–Ω–∏! ü•í",
    "–ü–æ—á–µ–º—É —á–µ—Ä–µ–ø–∞—Ö–∏ –Ω–æ—Å—è—Ç –ø–∞–Ω—Ü–∏—Ä—å? \n‚Äî –ß—Ç–æ–±—ã –∏—Ö –Ω–∏–∫—Ç–æ –Ω–µ —Ç–µ—Ä–µ–±–∏–ª. üê¢",
    "–ö–∞–∫ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è –ª—è–≥—É—à–∫–∞, –∫–æ—Ç–æ—Ä–∞—è —á–∏—Ç–∞–µ—Ç –∫–Ω–∏–≥–∏? \n‚Äî –ö–≤–∞–∫–æ–¥–µ–º–∏–∫. üê∏üìö",
    "–ü–æ—á–µ–º—É –∫–æ—à–∫–∞ –Ω–µ —Ö–æ–¥–∏—Ç –≤ —à–∫–æ–ª—É? \n‚Äî –ü–æ—Ç–æ–º—É —á—Ç–æ –æ–Ω–∞ —Å–∞–º–∞ —Å–µ–±–µ —É—á–∏—Ç–µ–ª—å. üò∫",
    "–ß—Ç–æ —Å–∫–∞–∑–∞–ª –æ–¥–∏–Ω —Å—Ç–∞–∫–∞–Ω –¥—Ä—É–≥–æ–º—É? \n‚Äî –ù–µ —Ä–∞–∑–±–µ–π—Å—è –æ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å! ü•õ",
    "–ü–æ—á–µ–º—É –∫–æ—Ä–æ–≤–∞ –Ω–µ –ª–µ—Ç–∞–µ—Ç? \n‚Äî –ü–æ—Ç–æ–º—É —á—Ç–æ –µ–π —Ç—è–∂–µ–ª–æ –º–∞—Ö–∞—Ç—å —Ö–≤–æ—Å—Ç–æ–º. üêÑ",
    "–ö–∞–∫ –Ω–∞–∑—ã–≤–∞—é—Ç—Å—è –ø—Ç–∏—Ü—ã, –∫–æ—Ç–æ—Ä—ã–µ –ª—é–±—è—Ç –ø–µ—Ç—å –Ω–æ—á—å—é? \n‚Äî –°–æ–ª–æ–≤—å–∏-—à–æ—É. üê¶üé∂",
    "‚Äî –ü–æ—á–µ–º—É —É—Ç–∫–∞ –Ω–µ –≥–æ–≤–æ—Ä–∏—Ç? \n‚Äî –ü–æ—Ç–æ–º—É —á—Ç–æ –æ–Ω–∞ –º—É–¥—Ä–æ –Ω–∞–±–ª—é–¥–∞–µ—Ç. ü¶Ü",
    "–ß—Ç–æ —Å–∫–∞–∑–∞–ª –æ–¥–∏–Ω –º–æ—Ä—Å–∫–æ–π –∫–æ–Ω—ë–∫ –¥—Ä—É–≥–æ–º—É? \n‚Äî –ù–µ –ø–ª–∞–≤–∞–π –¥–∞–ª–µ–∫–æ! üê¥‚Äç‚ò†Ô∏è",
    "–ü–æ—á–µ–º—É –ø—á—ë–ª—ã –Ω–µ –ª—é–±—è—Ç –¥–æ–∂–¥—å? \n‚Äî –ü–æ—Ç–æ–º—É —á—Ç–æ –∫–∞–ø–ª–∏ –º–µ—à–∞—é—Ç —Ç–∞–Ω—Ü–µ–≤–∞—Ç—å. üêù",
    "‚Äî –ú–∞–º–∞, –∞ —è —Å–º–æ–≥—É –ª–µ—Ç–∞—Ç—å? \n‚Äî –¢–æ–ª—å–∫–æ –≤ –º–µ—á—Ç–∞—Ö. ‚úàÔ∏è",
    "–ß—Ç–æ —Å–∫–∞–∑–∞–ª –æ–¥–∏–Ω –≥—É—Å—å –¥—Ä—É–≥–æ–º—É? \n‚Äî –ù–µ —Ç–µ—Ä—è–π –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ! ü¶¢",
    "–ü–æ—á–µ–º—É –µ–∂–∏–∫ –Ω–µ —Å–ø–∏—Ç –Ω–æ—á—å—é? \n‚Äî –ß—Ç–æ–±—ã –Ω–∏–∫–æ–≥–æ –Ω–µ –∫–æ–ª–æ—Ç—å –≤–æ —Å–Ω–µ. ü¶î",
    "–ö–∞–∫ –Ω–∞–∑—ã–≤–∞—é—Ç—Å—è –º—ã—à–∏, –∫–æ—Ç–æ—Ä—ã–µ –ª—é–±—è—Ç —Å—ã—Ä? \n‚Äî –°—ã—Ä–æ–º–∞–Ω—ã. üê≠üßÄ",
    "‚Äî –ü–æ—á–µ–º—É –ª–∏—Å–∞ —Ö–∏—Ç—Ä–∞—è? \n‚Äî –ü–æ—Ç–æ–º—É —á—Ç–æ –∏–Ω–∞—á–µ –æ–Ω–∞ –±—ã–ª–∞ –±—ã –ø—Ä–æ—Å—Ç–æ –ª–∏—Å–æ–π. ü¶ä",
    "–ß—Ç–æ —Å–∫–∞–∑–∞–ª –æ–¥–∏–Ω –∫–∞–∫—Ç—É—Å –¥—Ä—É–≥–æ–º—É? \n‚Äî –ù–µ –∫–æ–ª–∏—Å—å –Ω–∞ –º–µ–ª–æ—á–∏! üåµ",
    "–ü–æ—á–µ–º—É –º–æ—Ä—Å–∫–∏–µ –∑–≤—ë–∑–¥—ã –Ω–µ –±–µ–≥–∞—é—Ç? \n‚Äî –ü–æ—Ç–æ–º—É —á—Ç–æ —É –Ω–∏—Ö –Ω–µ—Ç –Ω–æ–≥. ‚≠ê",
    "–ö–∞–∫ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è –∫–æ—Ç, –∫–æ—Ç–æ—Ä—ã–π –ª—é–±–∏—Ç –∫–æ—Ñ–µ? \n‚Äî –ú—è—É-–∫–∞–ø—É—á–∏–Ω–æ. ‚òïüò∫",
    "–ü–æ—á–µ–º—É –º–µ–¥–≤–µ–¥—å —Å–ø–∏—Ç –∑–∏–º–æ–π? \n‚Äî –ß—Ç–æ–±—ã –æ—Ç–¥—ã—Ö–∞—Ç—å –æ—Ç –ª–µ—Ç–Ω–∏—Ö –ø—Ä–æ–±–ª–µ–º. üêª",
    "–ß—Ç–æ —Å–∫–∞–∑–∞–ª –æ–¥–∏–Ω —Ü–≤–µ—Ç–æ–∫ –¥—Ä—É–≥–æ–º—É? \n‚Äî –†–∞—Å—Ü–≤–µ—Ç–∞–π! üå∏",
    "–ü–æ—á–µ–º—É —Ä—ã–±–∫–∏ –ø–ª–∞–≤–∞—é—Ç –≤ –∞–∫–≤–∞—Ä–∏—É–º–µ? \n‚Äî –ü–æ—Ç–æ–º—É —á—Ç–æ —É –Ω–∏—Ö –Ω–µ—Ç –ø–∞—Å–ø–æ—Ä—Ç–∞. üê†",
    "‚Äî –ö–∞–∫ –∫—Ä–æ–ª–∏–∫ –±–µ–≥–∞–µ—Ç —Ç–∞–∫ –±—ã—Å—Ç—Ä–æ? \n‚Äî –ß—Ç–æ–±—ã –Ω–µ –æ–ø–æ–∑–¥–∞—Ç—å –Ω–∞ –º–æ—Ä–∫–æ–≤–Ω—ã–π —É—Ä–æ–∫. üêá",
    "–ß—Ç–æ —Å–∫–∞–∑–∞–ª –æ–¥–∏–Ω —Å–Ω–µ–≥ –¥—Ä—É–≥–æ–º—É? \n‚Äî –ù–µ —Ç–∞—è! ‚ùÑÔ∏è",
    "–ü–æ—á–µ–º—É –∫–µ–Ω–≥—É—Ä—É –ø—Ä—ã–≥–∞–µ—Ç? \n‚Äî –ß—Ç–æ–±—ã –¥–æ–±—Ä–∞—Ç—å—Å—è –¥–æ –º–∞–≥–∞–∑–∏–Ω–∞ –±—ã—Å—Ç—Ä–µ–µ. ü¶ò",
    "–ö–∞–∫ –Ω–∞–∑—ã–≤–∞—é—Ç—Å—è —Å–æ–≤—ã, –∫–æ—Ç–æ—Ä—ã–µ –ª—é–±—è—Ç –≤–µ—á–µ—Ä–∏–Ω–∫–∏? \n‚Äî –•—É-—Ö—É-—Ö—É–º–æ—Ä. ü¶â",
    "‚Äî –ü–æ—á–µ–º—É —Ç–∏–≥—Ä –ø–æ–ª–æ—Å–∞—Ç—ã–π? \n‚Äî –ß—Ç–æ–±—ã –≤—ã–¥–µ–ª—è—Ç—å—Å—è –Ω–∞ —Ñ–æ–Ω–µ –¥–∂—É–Ω–≥–ª–µ–π. üêÖ",
    "–ß—Ç–æ —Å–∫–∞–∑–∞–ª –æ–¥–∏–Ω –ª–∏–º–æ–Ω –¥—Ä—É–≥–æ–º—É? \n‚Äî –ù–µ –∫–∏—Å–Ω–∏, –∂–∏–∑–Ω—å –ø—Ä–µ–∫—Ä–∞—Å–Ω–∞! üçã",
    "–ü–æ—á–µ–º—É —á–µ—Ä–µ–ø–∞—Ö–∞ –∏–¥—ë—Ç –º–µ–¥–ª–µ–Ω–Ω–æ? \n‚Äî –ü–æ—Ç–æ–º—É —á—Ç–æ —Ç–æ—Ä–æ–ø–∏—Ç—å—Å—è –Ω–µ–∫—É–¥–∞. üê¢",
    "–ö–∞–∫ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è –æ—Å—ë–ª, –∫–æ—Ç–æ—Ä—ã–π –ø–æ—ë—Ç? \n‚Äî –ë—Ä–∞–≤–æ-–∞—Å—ë–ª. üê¥üé∂",
    "‚Äî –ü–æ—á–µ–º—É –º–æ—Ä–∫–æ–≤—å –æ—Ä–∞–Ω–∂–µ–≤–∞—è? \n‚Äî –ü–æ—Ç–æ–º—É —á—Ç–æ –∫—Ä–∞—Å–Ω–∞—è –±—ã–ª–∞ –∑–∞–Ω—è—Ç–∞. ü•ï",
    "–ß—Ç–æ —Å–∫–∞–∑–∞–ª –æ–¥–∏–Ω —à–æ–∫–æ–ª–∞–¥ –¥—Ä—É–≥–æ–º—É? \n‚Äî –¢—ã —Å–ª–∞–¥–∫–∏–π! üç´",
    "–ü–æ—á–µ–º—É —Å–Ω–µ–≥–æ–≤–∏–∫ —É–ª—ã–±–∞–µ—Ç—Å—è? \n‚Äî –ü–æ—Ç–æ–º—É —á—Ç–æ –∑–Ω–∞–µ—Ç, —á—Ç–æ –ª–µ—Ç–æ–º —Ç–∞—è—Ç—å –Ω–µ –ø—Ä–∏–¥—ë—Ç—Å—è. ‚õÑ",
    "–ö–∞–∫ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è –∫–æ—Ç, –∫–æ—Ç–æ—Ä—ã–π —Ç–∞–Ω—Ü—É–µ—Ç? \n‚Äî –ú—è—É-—Å—Ç–µ–ø. üò∏üíÉ",
    "‚Äî –ü–æ—á–µ–º—É –ª—è–≥—É—à–∫–∞ –∑–µ–ª—ë–Ω–∞—è? \n‚Äî –ü–æ—Ç–æ–º—É —á—Ç–æ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ü–≤–µ—Ç–∞ –±—ã–ª–∏ –∑–∞–Ω—è—Ç—ã. üê∏",
    "–ß—Ç–æ —Å–∫–∞–∑–∞–ª –æ–¥–∏–Ω –∞–ø–µ–ª—å—Å–∏–Ω –¥—Ä—É–≥–æ–º—É? \n‚Äî –ù–µ —Å–æ–∫—Ä—É—à–∞–π—Å—è! üçä",
    "–ü–æ—á–µ–º—É –ª–µ–≤ –Ω–µ –µ—Å—Ç –∫–æ–Ω—Ñ–µ—Ç—ã? \n‚Äî –ü–æ—Ç–æ–º—É —á—Ç–æ –æ–Ω –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ—Ç –º—è—Å–æ. ü¶Å",
    "–ö–∞–∫ –Ω–∞–∑—ã–≤–∞—é—Ç—Å—è –º—ã—à–∏, –∫–æ—Ç–æ—Ä—ã–µ –ª—é–±—è—Ç –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏—è? \n‚Äî –ú—ã—à—Ç—Ä–∏–º–µ—Ä—ã. üê≠",
    "‚Äî –ü–æ—á–µ–º—É —Å–ª–æ–Ω —Ç–∞–∫–æ–π –±–æ–ª—å—à–æ–π? \n‚Äî –ü–æ—Ç–æ–º—É —á—Ç–æ –º–∞–ª–µ–Ω—å–∫–∏–π –±—ã–ª –±—ã –Ω–µ —Å–ª–æ–Ω–æ–º. üêò",
    "–ß—Ç–æ —Å–∫–∞–∑–∞–ª –æ–¥–∏–Ω –ø–∏—Ä–æ–∂–æ–∫ –¥—Ä—É–≥–æ–º—É? \n‚Äî –ù–µ –ø–µ—Ä–µ–∂–∞—Ä–∏–≤–∞–π—Å—è! ü•ü",
    "–ü–æ—á–µ–º—É –≤–æ—Ä–æ–±—å–∏ –ª—é–±—è—Ç –≤–µ—Å–Ω—É?\n ‚Äî –ü–æ—Ç–æ–º—É —á—Ç–æ —Å–Ω–µ–≥ –Ω–∞–∫–æ–Ω–µ—Ü-—Ç–æ –∏—Å—á–µ–∑–∞–µ—Ç. üê¶",
    "–ö–∞–∫ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ç–∏—Ü–∞, –∫–æ—Ç–æ—Ä–∞—è —É–º–µ–µ—Ç —Å—á–∏—Ç–∞—Ç—å? \n‚Äî –°–æ–≤—ë–Ω–æ–∫. ü¶â",
    "‚Äî –ü–æ—á–µ–º—É –∫–æ—Ç —Å–ø–∏—Ç –Ω–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–µ? \n‚Äî –ß—Ç–æ–±—ã –±—ã—Ç—å –≤ —Ü–µ–Ω—Ç—Ä–µ –≤–Ω–∏–º–∞–Ω–∏—è. üò∫",
    "–ß—Ç–æ —Å–∫–∞–∑–∞–ª –æ–¥–∏–Ω –ø–µ–Ω—ë–∫ –¥—Ä—É–≥–æ–º—É? \n‚Äî –ù–µ —Å–≥–Ω–∏! üå≥",
    "–ü–æ—á–µ–º—É —É–ª–∏—Ç–∫–∏ –º–µ–¥–ª–µ–Ω–Ω–æ –ø–æ–ª–∑—É—Ç? \n‚Äî –ß—Ç–æ–±—ã —É—Å–ø–µ—Ç—å –Ω–∞—Å–ª–∞–¥–∏—Ç—å—Å—è –∫–∞–∂–¥—ã–º –ª–∏—Å—Ç–∫–æ–º. üêå",
    "–ö–∞–∫ –Ω–∞–∑—ã–≤–∞—é—Ç—Å—è –∫–æ—à–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –ª—é–±—è—Ç –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏—è? \n‚Äî –ú—è—É-–∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª–∏. üò∏",
    "‚Äî –ü–æ—á–µ–º—É —Ä—ã–±—ã –º–æ–ª—á–∞—Ç?\n ‚Äî –ü–æ—Ç–æ–º—É —á—Ç–æ –≤–æ–¥–∞ –Ω–µ –ø–µ—Ä–µ–¥–∞—ë—Ç –∑–≤—É–∫ –≤ —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–µ—Ç—è—Ö. üêü",
    "–ß—Ç–æ —Å–∫–∞–∑–∞–ª –æ–¥–∏–Ω –≥—Ä–∏–± –¥—Ä—É–≥–æ–º—É? \n‚Äî –†–∞—Å—Ç–∏ –∏ —Ä–∞–¥—É–π—Å—è! üçÑ",
    "–ü–æ—á–µ–º—É –ø–æ–ø—É–≥–∞–∏ –ø–æ–≤—Ç–æ—Ä—è—é—Ç —Å–ª–æ–≤–∞? \n‚Äî –ß—Ç–æ–±—ã –Ω–∏–∫—Ç–æ –Ω–µ —Å–∫—É—á–∞–ª. ü¶ú",
    "–ö–∞–∫ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è —Å–æ–±–∞–∫–∞, –∫–æ—Ç–æ—Ä–∞—è –ª—é–±–∏—Ç —à—É—Ç–∫–∏? \n‚Äî –•–∞-—Ö–∞-—Ç–µ—Ä—å–µ—Ä. üêï",
    "‚Äî –ü–æ—á–µ–º—É –∑–∞—è—Ü –±—ã—Å—Ç—Ä—ã–π? \n‚Äî –ü–æ—Ç–æ–º—É —á—Ç–æ —Ç–æ—Ä–æ–ø–∏—Ç—Å—è –Ω–∞ –º–æ—Ä–∫–æ–≤–Ω—É—é –≤–µ—á–µ—Ä–∏–Ω–∫—É. üêá",
    "–ß—Ç–æ —Å–∫–∞–∑–∞–ª –æ–¥–∏–Ω –∫–∞–º–µ–Ω—å –¥—Ä—É–≥–æ–º—É? \n‚Äî –û—Å—Ç–∞–≤–∞–π—Å—è —Ç–≤—ë—Ä–¥—ã–º! ü™®",
    "–ü–æ—á–µ–º—É –∂–∏—Ä–∞—Ñ –≤—ã—Å–æ–∫–∏–π? \n‚Äî –ß—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å –¥–∞–ª–µ–∫–æ –∏ –Ω–µ –æ–ø–æ–∑–¥–∞—Ç—å –Ω–∞ –æ–±–µ–¥. ü¶í",
    "–ö–∞–∫ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è –∫–æ—Ç, –∫–æ—Ç–æ—Ä—ã–π –∏–≥—Ä–∞–µ—Ç –Ω–∞ –ø–∏–∞–Ω–∏–Ω–æ? \n‚Äî –ú—è—É-—Å—Ç–∏–Ω. üò∫üéπ",
    "‚Äî –ü–æ—á–µ–º—É –º—É—Ä–∞–≤–µ–π –º–∞–ª–µ–Ω—å–∫–∏–π? \n‚Äî –ß—Ç–æ–±—ã –ª–µ–≥—á–µ –±—ã–ª–æ –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—å –ª–∏—Å—Ç–æ—á–∫–∏. üêú",
    "–ü–æ—á–µ–º—É –∫–ª–∞–¥–±–∏—â–µ ‚Äî —Å–∞–º–æ–µ —Ç–∏—Ö–æ–µ –º–µ—Å—Ç–æ? \n–ü–æ—Ç–æ–º—É —á—Ç–æ –º—ë—Ä—Ç–≤—ã–µ –Ω–µ –∂–∞–ª—É—é—Ç—Å—è.",
    "–Ø –Ω–µ –±–æ—é—Å—å —Å–º–µ—Ä—Ç–∏, —è –±–æ—é—Å—å —Å–∫—É—á–Ω–æ–π –∂–∏–∑–Ω–∏.",
    "–ù–µ–∫–æ—Ç–æ—Ä—ã–µ —à—É—Ç–∫–∏ –Ω–∞—Å—Ç–æ–ª—å–∫–æ –ø–ª–æ—Ö–∏, —á—Ç–æ –ª—é–¥–∏ —É–º–∏—Ä–∞—é—Ç –æ—Ç —Å–º–µ—Ö–∞‚Ä¶ –∏–Ω–æ–≥–¥–∞ –±—É–∫–≤–∞–ª—å–Ω–æ.",
    "–ü–æ—á–µ–º—É —Å–∫–µ–ª–µ—Ç—ã –Ω–µ –¥–µ—Ä—É—Ç—Å—è? \n–£ –Ω–∏—Ö –Ω–µ—Ç —Å–µ—Ä–¥—Ü–∞.",
    "–í –∂–∏–∑–Ω–∏ –∫–∞–∫ –≤ —à–∞—Ö–º–∞—Ç–∞—Ö: \n–µ—Å–ª–∏ –ø—Ä–æ–º–∞—Ö–Ω—ë—à—å—Å—è ‚Äî –∫—Ç–æ-—Ç–æ —É–º—Ä—ë—Ç‚Ä¶ –º–µ—Ç–∞—Ñ–æ—Ä–∏—á–µ—Å–∫–∏.",
    "–î–æ–∫—Ç–æ—Ä —Å–∫–∞–∑–∞–ª: \n'–£ –≤–∞—Å –¥–≤–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞: \n–∂–∏—Ç—å –¥–æ–ª–≥–æ –∏–ª–∏ —É–º–µ—Ä–µ—Ç—å –≤–µ—Å–µ–ª–æ.'",
    "–ù–µ–∫–æ—Ç–æ—Ä—ã–µ –ª—é–¥–∏ –∂–∏–≤—É—Ç, —á—Ç–æ–±—ã —Ä–∞–±–æ—Ç–∞—Ç—å. \n–î—Ä—É–≥–∏–µ —É–º–∏—Ä–∞—é—Ç, —á—Ç–æ–±—ã –æ—Ç–¥—ã—Ö–∞—Ç—å.",
    "–°–º–µ—Ä—Ç—å ‚Äî —ç—Ç–æ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —à–∞–Ω—Å –ø—Ä–∏–π—Ç–∏ –≤–æ–≤—Ä–µ–º—è –Ω–∞ –≤—Å–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è.",
    "–ü–æ—á–µ–º—É –∑–æ–º–±–∏ –Ω–µ —Ö–æ–¥—è—Ç –Ω–∞ —Ä–∞–±–æ—Ç—É? –ù–µ—Ç –º–æ—Ç–∏–≤–∞—Ü–∏–∏.",
    "–ü–æ—á–µ–º—É –ø—Ä–∏–≤–∏–¥–µ–Ω–∏—è –ª—é–±—è—Ç –≤–µ—á–µ—Ä–∏–Ω–∫–∏? \n–ü–æ—Ç–æ–º—É —á—Ç–æ –Ω–∏–∫—Ç–æ –Ω–µ –∂–∞–ª—É–µ—Ç—Å—è –Ω–∞ –∏—Ö —à—É—Ç–∫–∏.",
    "–°–∞—Ä–∫–∞–∑–º ‚Äî —ç—Ç–æ —Ç—ë–ø–ª–æ–µ –æ–¥–µ—è–ª–æ, –∫–æ—Ç–æ—Ä—ã–º –ª—é–¥–∏ —É–∫—Ä—ã–≤–∞—é—Ç—Å—è –ø–µ—Ä–µ–¥ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–π —Å–º–µ—Ä—Ç–Ω–æ—Å—Ç—å—é.",
    "–ò–Ω–æ–≥–¥–∞ —è –¥—É–º–∞—é, —á—Ç–æ –µ—Å–ª–∏ –±—ã –∂–∏–∑–Ω—å –±—ã–ª–∞ —á–µ—Å—Ç–Ω–æ–π, –º—ë—Ä—Ç–≤—ã–µ –≤—ã–∏–≥—Ä—ã–≤–∞–ª–∏ –±—ã —á–∞—â–µ.",
]

AI_Limit = "ai_limitusage.json"
# ------------------- –†–∞–±–æ—Ç–∞ —Å –ª–∏–º–∏—Ç–∞–º–∏ -------------------
def load_usage():
    try:
        with open(AI_Limit, "r", encoding="utf-8") as f:
            return json.load(f)
    except FileNotFoundError:
        return {}

def save_usage(data):
    with open(AI_Limit, "w", encoding="utf-8") as f:
        json.dump(data, f, ensure_ascii=False, indent=4)

def can_use_ai(user_id: str, is_fernie_plus: bool) -> bool:
    if is_fernie_plus:
        return True

    usage = load_usage()
    now = int(time.time())
    limit_period = 12 * 3600
    max_queries = 5

    if user_id not in usage:
        return True

    usage[user_id] = [t for t in usage[user_id] if now - t < limit_period]
    return len(usage[user_id]) < max_queries

def register_ai_usage(user_id: str):
    usage = load_usage()
    now = int(time.time())
    limit_period = 12 * 3600

    if user_id not in usage:
        usage[user_id] = []

    usage[user_id] = [t for t in usage[user_id] if now - t < limit_period]
    usage[user_id].append(now)

    save_usage(usage)

async def ai_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = str(update.message.from_user.id)

    # ------------------- –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø–∏—Å–∫—É -------------------
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT end_time FROM SubFerniePlus WHERE user_id = ?", (user_id,))
    row = cursor.fetchone()
    is_fernie_plus = False
    if row:
        end_time = row[0]
        if end_time is None or int(end_time) > int(time.time()):
            is_fernie_plus = True
    conn.close()

    # ------------------- –ú–µ–Ω—é / –±–µ–∑ —Ç–µ–∫—Å—Ç–∞ -------------------
    if not context.args:
        model_id = get_user_model(user_id)
        model_info = AI_MODELS.get(model_id)
        model_name = model_info["name"] if model_info else "–ù–µ –≤—ã–±—Ä–∞–Ω–∞"

        if is_fernie_plus:
            limit_display = "‚àû"
        else:
            usage = load_usage()
            now = int(time.time())
            limit_period = 12 * 3600
            user_usage = usage.get(user_id, [])
            user_usage = [t for t in user_usage if now - t < limit_period]
            limit_display = f"{len(user_usage)}/5"

        keyboard = InlineKeyboardMarkup(
            [[InlineKeyboardButton("‚ú® –í—ã–±–æ—Ä –º–æ–¥–µ–ª–∏ AI", url="https://fernie-x-ai.vercel.app")]]
        )

        await update.message.reply_text(
            f"üß† <b>FernieX-AI</b> üß†\n\n"
            f"üìå <b>–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:</b>\n"
            f"<code>/ai {{–∑–∞–ø—Ä–æ—Å}}</code>\n\n"
            f"‚öôÔ∏è <b>–¢–µ–∫—É—â–∞—è –º–æ–¥–µ–ª—å:</b> {model_name}\n"
            f"‚è≥ <b>–õ–∏–º–∏—Ç:</b> {limit_display}\n\n"
            f"üîó –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ –¥–ª—è —Å–º–µ–Ω—ã –º–æ–¥–µ–ª–∏:",
            reply_markup=keyboard,
            parse_mode="HTML"
        )
        return

    user_text = " ".join(context.args).strip().lower()

    # ------------------- "–¥—É–º–∞—é..." -------------------
    thinking_message = await update.message.reply_text(
        "<b>üß† FernieX-AI</b>\n<blockquote>üí≠ –î—É–º–∞—é –Ω–∞–¥ –æ—Ç–≤–µ—Ç–æ–º...</blockquote>",
        parse_mode="HTML"
    )
    await asyncio.sleep(1)

    # ------------------- –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã -------------------
    if user_text.startswith("–≤–µ—Ä–æ—è—Ç–Ω–æ–µ"):
        context.args = user_text.split()[1:]
        await rin_command(update, context, reply_message=thinking_message)
        return

    if user_text.startswith("—Å–∞–π—Ç"):
        keyboard = InlineKeyboardMarkup(
            [
                [InlineKeyboardButton("üåê –û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Å–∞–π—Ç", url="https://fernie-x.vercel.app")],
                [InlineKeyboardButton("üí¨ –û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Ñ–æ—Ä—É–º", url="https://ferniex.hgweb.ru")],
                [InlineKeyboardButton("‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —á–∞—Ç–∞", url="https://chat-setting.vercel.app")],
                [InlineKeyboardButton("‚ú® –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Fernie+", url="https://custom-fernie.vercel.app")]
            ]
        )
        await thinking_message.edit_text(
            "<b>üß† FernieX-AI</b>\n<blockquote>üåê –û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∞–π—Ç—ã Fernie-X</blockquote>",
            parse_mode="HTML",
            reply_markup=keyboard
        )
        return

    weather_keywords = ["–∫–∞–∫–∞—è –ø–æ–≥–æ–¥–∞", "–∫–∞–∫ –ø–æ–≥–æ–¥–∞", "–ø–æ–≥–æ–¥–∞"]
    if any(kw in user_text for kw in weather_keywords):
        city = user_text
        for kw in weather_keywords:
            city = city.replace(kw, "")
        for preposition in ["–≤ ", "–Ω–∞ ", "–ø–æ "]:
            if city.lower().lstrip().startswith(preposition):
                city = city.lstrip()[len(preposition):]
                break
        city = city.strip()
        if not city:
            await thinking_message.edit_text(
                "<b>üß† FernieX-AI</b>\n<blockquote>‚ö† –£–∫–∞–∂–∏—Ç–µ –≥–æ—Ä–æ–¥, –Ω–∞–ø—Ä–∏–º–µ—Ä:\n/ai –ø–æ–≥–æ–¥–∞ –ú–æ—Å–∫–≤–∞</blockquote>",
                parse_mode="HTML"
            )
            return
        context.args = [city]
        await wea(update, context, thinking_message=thinking_message)
        return

    profile_keywords = ["–ø—Ä–æ—Ñ–∏–ª—å", "–º–æ–π –ø—Ä–æ—Ñ–∏–ª—å", "–æ—Ç–∫—Ä–æ–π –ø—Ä–æ—Ñ–∏–ª—å", "—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞"]
    if any(kw in user_text for kw in profile_keywords):
        await stats(update, context)
        await thinking_message.edit_text("<b>üß† FernieX-AI</b>\n<blockquote>‚úÖ –ö–æ–º–∞–Ω–¥–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞</blockquote>", parse_mode="HTML")
        return

    if "–±–∞–∑–∞" in user_text:
        await dbusers_command(update, context)
        await thinking_message.edit_text("<b>üß† FernieX-AI</b>\n<blockquote>‚úÖ –ö–æ–º–∞–Ω–¥–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞</blockquote>", parse_mode="HTML")
        return

    info_keywords = ["–∏–Ω—Ñ–æ", "–¥–∞–Ω–Ω—ã–µ", "–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è"]
    parts = user_text.split()
    if parts and parts[0] in info_keywords:
        context.args = parts[1:]
        await info_command(update, context)
        await thinking_message.edit_text("<b>üß† FernieX-AI</b>\n<blockquote>‚úÖ –ö–æ–º–∞–Ω–¥–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞</blockquote>", parse_mode="HTML")
        return

    rob_keywords = ["–æ–≥—Ä–∞–±—å", "–æ–±—Ä–∞–±–∏—Ç—å"]
    decode_keywords = ["–¥–µ–∫–æ–¥–∏—Ä—É–π", "–¥–µ–∫–æ–¥"]
    target_user_id = None
    if len(parts) == 2:
        if parts[0] in rob_keywords + decode_keywords or parts[1] in rob_keywords + decode_keywords:
            try:
                target_user_id = int(parts[1]) if parts[0] in rob_keywords + decode_keywords else int(parts[0])
            except ValueError:
                target_user_id = None

    if target_user_id:
        robber_id = update.message.from_user.id
        if robber_id == target_user_id:
            await thinking_message.edit_text("<b>‚ùå –ù–µ–ª—å–∑—è –æ–≥—Ä–∞–±–∏—Ç—å —Å–∞–º–æ–≥–æ —Å–µ–±—è!</b>", parse_mode="HTML")
            return
        await thinking_message.edit_text(
            "<b>üß† FernieX-AI</b>\n<blockquote>–í—ã–ø–æ–ª–Ω—è—é –æ–≥—Ä–∞–±–ª–µ–Ω–∏–µ —Å –∞–≤—Ç–æ–¥–µ–∫–æ–¥–æ–º...</blockquote>",
            parse_mode="HTML"
        )
        await robbing_with_autodecode(update, context, robber_id, target_user_id)
        await thinking_message.edit_text("<b>üß† FernieX-AI</b>\n<blockquote>‚úÖ –ö–æ–º–∞–Ω–¥–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞</blockquote>", parse_mode="HTML")
        return

    # ------------------- –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–º–∏—Ç –¥–ª—è –ò–ò -------------------
    if not can_use_ai(user_id, is_fernie_plus):
        keyboard = InlineKeyboardMarkup(
            [[InlineKeyboardButton("‚ú® –û—Ñ–æ—Ä–º–∏—Ç—å Fernie+", url="https://fernie-xs.vercel.app")]]
        )
        await thinking_message.edit_text(
            "‚ö† –í—ã –¥–æ—Å—Ç–∏–≥–ª–∏ –ª–∏–º–∏—Ç–∞ 5 –æ—Ç–≤–µ—Ç–æ–≤ AI –∑–∞ 12 —á–∞—Å–æ–≤.\n"
            "–î–ª—è –Ω–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –æ—Ñ–æ—Ä–º–∏—Ç–µ Fernie+.",
            parse_mode="HTML",
            reply_markup=keyboard
        )
        return

    # ------------------- –ó–∞–ø—Ä–æ—Å –∫ –ò–ò -------------------
    reply, used_fallback, model_name = get_ai_response(user_text, update.message.from_user.id)

    if reply and not is_fernie_plus:
        register_ai_usage(user_id)

    if not reply:
        reply = "ü§î –•–º...\n–Ø –ø–æ–∫–∞ –Ω–µ –∑–Ω–∞—é, —á—Ç–æ –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ —ç—Ç–æ –∏–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞.\n–ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è, –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ —Å–ª—É–∂–±—É –ø–æ–¥–¥–µ—Ä–∂–∫–∏: /ask"

    if used_fallback:
        await thinking_message.edit_text(
            f"<b>üí´ {model_name}</b>\n<blockquote>‚è≥ –ü–æ–Ω–∞–¥–æ–±–∏–ª–æ—Å—å —á—É—Ç—å –±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏...</blockquote>",
            parse_mode="HTML"
        )
        await asyncio.sleep(0.8)
    else:
        await thinking_message.edit_text(
            f"<b>üí´ {model_name}</b>\n<blockquote>üí≠ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞...</blockquote>",
            parse_mode="HTML"
        )

    # ------------------- –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–≤–µ—Ç–∞ -------------------
    if len(reply) <= 3500:
        safe_part = html.escape(reply)
        await thinking_message.edit_text(
            f"<b>üí´ {model_name}</b>\n<blockquote>{safe_part}</blockquote>",
            parse_mode="HTML"
        )
    else:
        parts = split_ai_text(reply)
        for i, part in enumerate(parts):
            safe_part = html.escape(part)
            if i == 0:
                await thinking_message.edit_text(
                    f"<b>üí´ {model_name}</b>\n<blockquote>{safe_part}</blockquote>",
                    parse_mode="HTML"
                )
            else:
                await update.message.reply_text(
                    f"<b>üí´ {model_name}</b>\n<blockquote>{safe_part}</blockquote>",
                    parse_mode="HTML"
                )

AI_MODELS = {
    "ClaudeOpus_45": {
        "name": "Solar Pro 3",
        "api_key": "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",
        "model": "@preset/solar-pro-3"
    },
    "step35_flash": {
        "name": "Step 3.5 Flash",
        "api_key": "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",
        "model": "@preset/step-flash"
    },
    "grok41fast": {
        "name": "Grok 4.1 fast",
        "api_key": "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",
        "model": "@preset/grok41fast"
    },
    "Grok": {
        "name": "Grok 3 Mini Beta",
        "api_key": "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",
        "model": "@preset/grok"
    },
}

def split_ai_text(text: str, chunk_size: int = 3500):
    """–†–∞–∑–¥–µ–ª—è–µ—Ç –¥–ª–∏–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –Ω–∞ —á–∞—Å—Ç–∏ –¥–ª—è Telegram."""
    return [text[i:i + chunk_size] for i in range(0, len(text), chunk_size)]

# fallback, –µ—Å–ª–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω timezonefinder
def get_city_time(city_name: str) -> str:
    import pytz
    from datetime import datetime

    tz = pytz.timezone("Europe/Moscow")
    now = datetime.now(tz)
    date_str = now.strftime("%d.%m.%Y")
    time_str = now.strftime("%H:%M:%S")
    return f"–î–∞—Ç–∞: {date_str}\n–í—Ä–µ–º—è: {time_str} ({city_name})"

def get_user_model(user_id: int) -> str:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—É—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –º–æ–¥–µ–ª—å –∏–∑ SQLite"""
    ensure_ai_selected_table()  # üîß –ö–õ–Æ–ß–ï–í–û–ï –ú–ï–°–¢–û

    conn = sqlite3.connect("FernieUI.db")
    cursor = conn.cursor()
    cursor.execute(
        "SELECT model_name FROM AI_Selected WHERE user_id=?",
        (user_id,)
    )
    row = cursor.fetchone()
    conn.close()

    return row[0] if row else "step35_flash"
AI_ChatHistory = "AI_ChatHistory.json"

# ------------------- –†–∞–±–æ—Ç–∞ —Å –∏—Å—Ç–æ—Ä–∏–µ–π -------------------
def load_history():
    try:
        with open(AI_ChatHistory, "r", encoding="utf-8") as f:
            return json.load(f)
    except FileNotFoundError:
        return {}

def save_history(data):
    with open(AI_ChatHistory, "w", encoding="utf-8") as f:
        json.dump(data, f, ensure_ascii=False, indent=4)

def get_user_history(user_id: str) -> dict:
    history = load_history()
    return history.get(user_id, {})

def update_user_history(user_id: str, you: str, ai: str):
    history = load_history()
    if user_id not in history:
        history[user_id] = {}
    history[user_id]["you"] = you
    history[user_id]["ai"] = ai
    save_history(history)

def set_user_name(user_id: str, name: str | None):
    history = load_history()
    if user_id not in history:
        history[user_id] = {}
    history[user_id]["my_name"] = name
    save_history(history)

def get_user_name(user_id: str) -> str | None:
    history = load_history()
    return history.get(user_id, {}).get("my_name", None)

# ------------------- –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞–º–µ—Ä–µ–Ω–∏—è –∑–∞–ø–æ–º–Ω–∏—Ç—å/–∑–∞–±—ã—Ç—å –∏–º—è -------------------
def detect_name_intent(user_prompt: str) -> tuple[str, str | None]:
    prompt_lower = user_prompt.lower().strip()

    forget_keywords = [
        "–∑–∞–±—É–¥—å –º–æ—ë –∏–º—è", "–∑–∞–±—É–¥—å –º–æ–µ –∏–º—è", "–∑–∞–±—É–¥—å –∏–º—è",
        "–Ω–µ –ø–æ–º–Ω–∏ –º–æ—ë –∏–º—è", "–Ω–µ –ø–æ–º–Ω–∏ –º–æ–µ –∏–º—è", "—Å–æ—Ç—Ä–∏ –º–æ—ë –∏–º—è",
        "—É–¥–∞–ª–∏ –º–æ—ë –∏–º—è", "—É–¥–∞–ª–∏ –º–æ–µ –∏–º—è", "–∑–∞–±—É–¥—å –º–µ–Ω—è"
    ]
    for kw in forget_keywords:
        if kw in prompt_lower:
            return ('forget', None)

    # –ï—Å–ª–∏ —ç—Ç–æ –≤–æ–ø—Ä–æ—Å ‚Äî –Ω–µ –∑–∞–ø–æ–º–∏–Ω–∞–µ–º
    question_starters = ["–∫–∞–∫ ", "–∫–∞–∫–æ–µ ", "–∫–∞–∫–æ–π ", "—á—Ç–æ ", "–∫—Ç–æ ", "–≥–¥–µ ", "–∫–æ–≥–¥–∞ ", "–ø–æ—á–µ–º—É ", "–∑–∞—á–µ–º ", "—Ç—ã –∑–Ω–∞–µ—à—å", "—Å–∫–∞–∂–∏"]
    is_question = (
        any(prompt_lower.startswith(qw) for qw in question_starters)
        or prompt_lower.endswith("?")
    )
    if is_question:
        return ('none', None)

    remember_keywords = [
        "–∑–∞–ø–æ–º–Ω–∏ –º–µ–Ω—è –∫–∞–∫",
        "–∑–∞–ø–æ–º–Ω–∏ –º–æ—ë –∏–º—è",
        "–∑–∞–ø–æ–º–Ω–∏ –º–æ–µ –∏–º—è",
        "–º–µ–Ω—è –∑–æ–≤—É—Ç",
        "–º–µ–Ω—è –∑–∞–≤—É—Ç",
        "–Ω–∞–∑—ã–≤–∞–π –º–µ–Ω—è",
        "–∑–∞–ø–æ–º–Ω–∏ —á—Ç–æ –º–µ–Ω—è –∑–æ–≤—É—Ç",
        "–∑–∞–ø–æ–º–Ω–∏, –º–µ–Ω—è –∑–æ–≤—É—Ç",
        "–∑–æ–≤–∏ –º–µ–Ω—è",
        "–º–æ—ë –∏–º—è",
        "–º–æ–µ –∏–º—è",
    ]
    for kw in remember_keywords:
        if kw in prompt_lower:
            idx = prompt_lower.find(kw)
            after = user_prompt[idx + len(kw):].strip(" ,:‚Äî-")
            name_parts = after.split()
            if name_parts:
                name = " ".join(name_parts).title()
                return ('remember', name)

    return ('none', None)

# ------------------- –ò–∑–º–µ–Ω—ë–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è get_ai_response -------------------
def get_ai_response(user_prompt: str, user_id: int) -> tuple[str | None, bool, str]:
    """–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –Ω–µ–π—Ä–æ–Ω–∫–µ —Å retry –∏ –∑–∞—â–∏—Ç–æ–π"""

    model_id = get_user_model(user_id)
    model_info = AI_MODELS.get(model_id)

    if not model_info:
        return f"‚ö† –ú–æ–¥–µ–ª—å ¬´{model_id}¬ª –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –°–º–µ–Ω–∏—Ç–µ –Ω–µ–π—Ä–æ–Ω–∫—É –≤ –º–µ–Ω—é /ai.", False, "FernieX-AI"

    model_name = model_info["name"]
    user_id_str = str(user_id)

    # --- –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–º–µ—Ä–µ–Ω–∏–µ –∑–∞–ø–æ–º–Ω–∏—Ç—å / –∑–∞–±—ã—Ç—å –∏–º—è ---
    intent, detected_name = detect_name_intent(user_prompt)

    if intent == 'remember' and detected_name:
        set_user_name(user_id_str, detected_name)
        return f"‚úÖ –ó–∞–ø–æ–º–Ω–∏–ª! –ë—É–¥—É –Ω–∞–∑—ã–≤–∞—Ç—å —Ç–µ–±—è {detected_name}.", False, model_name

    if intent == 'forget':
        set_user_name(user_id_str, None)
        return "‚úÖ –ó–∞–±—ã–ª —Ç–≤–æ—ë –∏–º—è.", False, model_name

    # --- –ü–æ–ª—É—á–∞–µ–º –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ---
    user_name = get_user_name(user_id_str)
    name_info = (
        f"–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {user_name}"
        if user_name
        else "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —Å–æ–æ–±—â–∞–ª —Å–≤–æ—ë –∏–º—è."
    )

    system_prompt = (
        "–û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ, –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π * —á—Ç–æ–±—ã —Å–¥–µ–ª–∞—Ç—å —Ç–µ–∫—Å—Ç –∂–∏—Ä–Ω—ã–º.\n"
        "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ (–≤—Ä–µ–º–µ–Ω–∏ –∏ –ø—Ä–æ—á–µ–µ) –∏—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –æ–Ω —è–≤–Ω–æ –ø—Ä–æ—Å–∏—Ç ‚Äî "
        "–Ω–µ —É–ø–æ–º–∏–Ω–∞–π –µ—ë –≤ –∫–∞–∂–¥–æ–º –æ—Ç–≤–µ—Ç–µ. –ò–º—è –º–æ–∂–µ—à—å –Ω–∞–∑—ã–≤–∞—Ç—å.\n"
        "–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –∫–∞–∫ –µ–≥–æ –∑–æ–≤—É—Ç –∏–ª–∏ –∫–∞–∫–æ–µ –µ–≥–æ –∏–º—è ‚Äî –æ—Ç–≤–µ—á–∞–π –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ, "
        "–Ω–∞–ø—Ä–∏–º–µ—Ä: '–í–∞—Å –∑–æ–≤—É—Ç ...', '–í–∞—à–µ –∏–º—è ‚Äî ...', '–Ø –ø–æ–º–Ω—é, —Ç–µ–±—è –∑–æ–≤—É—Ç ...' –∏ —É–∫–∞–∂–∏ –∏–º—è –∏–∑ –ø–æ–ª—è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ. "
        "–ï—Å–ª–∏ –∏–º—è –Ω–µ —É–∫–∞–∑–∞–Ω–æ ‚Äî —Å–∫–∞–∂–∏ —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–∑—ã–≤–∞–ª —Å–≤–æ—ë –∏–º—è.\n"
        "–ù–µ–ª—å–∑—è –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç, –ø–æ–ø—ã—Ç–∞–π—Å—è –æ—Ç–≤–µ—Ç–∏—Ç—å —Ö–æ—Ç—å —á—Ç–æ-—Ç–æ, –Ω–∞–ø—Ä–∏–º–µ—Ä: <–ù–µ–∑–Ω–∞—é —á—Ç–æ –Ω–∞ —ç—Ç–æ –æ—Ç–≤–µ—Ç–∏—Ç—å..> - –∏–ª–∏ –∫–∞–∫-—Ç–æ –ø–æ –¥—Ä—É–≥–æ–º—É.\n"
        f"–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ: {name_info}\n"
        f"–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ:\n{get_city_time('–ú–æ—Å–∫–≤–∞')}"
    )

    user_history = get_user_history(user_id_str)
    history_context = ""

    if user_history:
        history_context = (
            "–£—á—Ç–∏, —á—Ç–æ –≤ –ø—Ä–æ—à–ª—ã–π —Ä–∞–∑ —è —Å–ø—Ä–æ—Å–∏–ª:\n"
            f"{user_history.get('you', '')}\n"
            "–¢—ã –æ—Ç–≤–µ—Ç–∏–ª:\n"
            f"{user_history.get('ai', '')}\n\n"
        )

    full_prompt = history_context + "–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:\n" + user_prompt

    payload = {
        "model": model_info["model"],
        "messages": [
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": full_prompt}
        ],
        "max_tokens": 500
    }

    url = "https://openrouter.ai/api/v1/chat/completions"
    headers = {
        "Authorization": f"Bearer {model_info['api_key']}",
        "Content-Type": "application/json"
    }

    # --- retry –º–µ—Ö–∞–Ω–∏–∑–º ---
    for attempt in range(2):
        try:
            resp = requests.post(url, headers=headers, json=payload, timeout=30)

            if resp.status_code != 200:
                try:
                    error_json = resp.json()
                    error_message = error_json.get("error", {}).get("message", resp.text)
                except Exception:
                    error_message = resp.text

                print("AI ERROR STATUS:", resp.status_code)
                print("AI ERROR BODY:", error_message)

                if resp.status_code == 429 and attempt == 0:
                    time.sleep(1.5)
                    continue

                return (
                    f"‚ö† –û—à–∏–±–∫–∞ –º–æ–¥–µ–ª–∏ ¬´{model_name}¬ª:\n{error_message}",
                    False,
                    model_name
                )

            try:
                data = resp.json()
            except Exception as e:
                print("JSON PARSE ERROR:", e)
                return "‚ö† –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—Ç–≤–µ—Ç–∞ –º–æ–¥–µ–ª–∏.", False, model_name

            choices = data.get("choices")
            if not choices:
                print("AI EMPTY CHOICES:", data)
                return "‚ö† –ú–æ–¥–µ–ª—å –≤–µ—Ä–Ω—É–ª–∞ –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.", False, model_name

            message = choices[0].get("message", {})
            reply = message.get("content")

            if reply is None:
                print("AI CONTENT NONE:", data)
                return "‚ö† –ú–æ–¥–µ–ª—å –Ω–µ –≤–µ—Ä–Ω—É–ª–∞ —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞.", False, model_name

            reply = reply.strip()

            if not reply:
                print("AI CONTENT EMPTY STRING:", data)
                return "‚ö† –ú–æ–¥–µ–ª—å –≤–µ—Ä–Ω—É–ª–∞ –ø—É—Å—Ç–æ–π —Ç–µ–∫—Å—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –∑–∞–ø—Ä–æ—Å.", False, model_name

            update_user_history(user_id_str, you=user_prompt, ai=reply)

            return reply, False, model_name

        except requests.exceptions.Timeout:
            print("AI TIMEOUT (attempt", attempt, ")")
            if attempt == 0:
                time.sleep(1)
                continue
            return "‚ö† –¢–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–∞ –∫ –º–æ–¥–µ–ª–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.", False, model_name

        except requests.exceptions.ConnectionError:
            print("AI CONNECTION ERROR (attempt", attempt, ")")
            if attempt == 0:
                time.sleep(1)
                continue
            return "‚ö† –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º –º–æ–¥–µ–ª–∏.", False, model_name

        except Exception as e:
            print("AI UNKNOWN ERROR:", e)
            return f"‚ö† –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞: {str(e)}", False, model_name

    return None, False, model_name

async def auto_decode(context, robber_id, target_user_id, decoders, target_name, update):
    progress_msg = await update.message.reply_text(
        "üß© <b>–î–µ–∫–æ–¥–∏—Ä—É–µ–º...</b>\n<blockquote>‚ñ±‚ñ±‚ñ± 0%</blockquote>",
        parse_mode="HTML"
    )

    await asyncio.sleep(1.5)  # –æ–¥–Ω–∞ –ø–∞—É–∑–∞ –≤–º–µ—Å—Ç–æ —Ç—Ä—ë—Ö

    success = random.randint(1, 100) <= 35

    async with aiosqlite.connect(DB_PATH) as db:
        if not success:
            await db.execute(
                "UPDATE inventory SET quantity = quantity - 1 WHERE owner_id=? AND item_name='–î–µ–∫–æ–¥–µ—Ä'",
                (str(robber_id),)
            )
            await db.commit()

            async with db.execute(
                "SELECT quantity FROM inventory WHERE owner_id=? AND item_name='–î–µ–∫–æ–¥–µ—Ä'",
                (str(robber_id),)
            ) as cursor:
                result = await cursor.fetchone()

            decoders_left = result[0] if result else 0
            await progress_msg.edit_text(
                f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å –∏–º–º—É–Ω–∏—Ç–µ—Ç {target_name}...\n"
                f"üß© –û—Å—Ç–∞–ª–æ—Å—å –¥–µ–∫–æ–¥–µ—Ä–æ–≤: {decoders_left}",
                parse_mode="HTML"
            )
            return False
        else:
            await db.execute(
                "UPDATE robbery_data SET immunity_active=0, immunity_end=NULL WHERE user_id=?",
                (str(target_user_id),)
            )
            await db.commit()
            await progress_msg.edit_text(
                f"‚úÖ <b>–£—Å–ø–µ—à–Ω–æ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–æ!</b>\n"
                f"üõ° –ò–º–º—É–Ω–∏—Ç–µ—Ç —Ü–µ–ª–∏ {target_name} —Å–Ω—è—Ç.\n"
                f"–ú–æ–∂–µ—Ç–µ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –æ–≥—Ä–∞–±–ª–µ–Ω–∏–µ —Å–Ω–æ–≤–∞!",
                parse_mode="HTML"
            )
            return True

def get_user_immunity(user_id: int) -> bool:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç True, –µ—Å–ª–∏ –∏–º–º—É–Ω–∏—Ç–µ—Ç –∞–∫—Ç–∏–≤–µ–Ω (–∏ –Ω–µ –∏—Å—Ç—ë–∫)."""
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    cursor.execute("SELECT immunity_active, immunity_end FROM robbery_data WHERE user_id = ?", (str(user_id),))
    row = cursor.fetchone()
    conn.close()

    if not row:
        return False

    immunity_active, immunity_end = row
    now_ts = int(time.time())

    if immunity_active and immunity_end and now_ts >= int(immunity_end):
        # –°–Ω–∏–º–∞–µ–º –∏—Å—Ç—ë–∫—à–∏–π –∏–º–º—É–Ω–∏—Ç–µ—Ç
        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()
        cursor.execute(
            "UPDATE robbery_data SET immunity_active=0, immunity_end=NULL WHERE user_id=?",
            (str(user_id),)
        )
        conn.commit()
        conn.close()
        return False

    return bool(immunity_active)


def update_robbery_stats(user_id: int, success: bool, stolen_amount: int = 0):
    """–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –æ–≥—Ä–∞–±–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    user_id = str(user_id)
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    try:
        cursor.execute(
            "UPDATE robbery_data SET "
            "total_attempts = total_attempts + 1, "
            "success_attempts = success_attempts + ?, "
            "failed_attempts = failed_attempts + ?, "
            "total_stolen = total_stolen + ? "
            "WHERE user_id = ?",
            (1 if success else 0, 0 if success else 1, stolen_amount if success else 0, user_id)
        )
        conn.commit()
    finally:
        conn.close()

async def robbing_with_autodecode(update, context, robber_id, target_user_id):
    now_ts = int(time.time())

    # --- –ø—Ä–æ–≤–µ—Ä–∫–∞ –ö–î ---
    vip_status = get_user_vip_status(robber_id)
    cooldown = get_robbing_cooldown(vip_status)
    last_used = get_user_last_robbing(robber_id)
    if last_used != 0 and now_ts - last_used < cooldown:
        remaining = cooldown - (now_ts - last_used)
        minutes, seconds = divmod(remaining, 60)
        await update.message.reply_text(f"‚è≥ –ü–æ–¥–æ–∂–¥–∏—Ç–µ {minutes}–º {seconds}—Å –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–∏–º –æ–≥—Ä–∞–±–ª–µ–Ω–∏–µ–º.")
        return
    update_user_last_robbing(robber_id)

    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    # --- –∞–≤—Ç–æ—Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π ---
    for uid in (robber_id, target_user_id):
        cursor.execute("SELECT 1 FROM robbery_data WHERE user_id = ?", (str(uid),))
        if cursor.fetchone() is None:
            cursor.execute("INSERT INTO robbery_data (user_id) VALUES (?)", (str(uid),))

    # --- –¥–µ–∫–æ–¥–µ—Ä—ã ---
    cursor.execute("SELECT quantity FROM inventory WHERE owner_id = ? AND item_name='–î–µ–∫–æ–¥–µ—Ä'", (str(robber_id),))
    result = cursor.fetchone()
    decoders = result[0] if result else 0

    # --- –Ω–∏–∫–∏ ---
    try:
        target_user = await context.bot.get_chat(target_user_id)
        target_name = get_display_name_html_new(target_user)
    except telegram.error.BadRequest:
        # –ï—Å–ª–∏ —á–∞—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Äî –±–µ—Ä—ë–º –∏–º—è –∏–∑ –±–∞–∑—ã –∏–ª–∏ —Å—Ç–∞–≤–∏–º –¥–µ—Ñ–æ–ª—Ç
        cursor.execute("SELECT username FROM users WHERE telegram_id = ?", (str(target_user_id),))
        row = cursor.fetchone()
        if row and row[0]:
            target_name = row[0]
        else:
            target_name = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π"

    # --- –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏–º–º—É–Ω–∏—Ç–µ—Ç–∞ –∏ –∞–≤—Ç–æ–¥–µ–∫–æ–¥ ---
    if get_user_immunity(target_user_id):
        if decoders == 0:
            await update.message.reply_text(
                f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–≥—Ä–∞–±–∏—Ç—å {target_name}...\nüõ° –£ —á–µ–ª–æ–≤–µ–∫–∞ –∞–∫—Ç–∏–≤–µ–Ω –∏–º–º—É–Ω–∏—Ç–µ—Ç.\n\nüß© –î–µ–∫–æ–¥–µ—Ä—ã: 0",
                parse_mode="HTML"
            )
            conn.close()
            return

        while decoders > 0:
            success = await auto_decode(context, robber_id, target_user_id, decoders, target_name, update)
            if success:
                break
            cursor.execute("SELECT quantity FROM inventory WHERE owner_id=? AND item_name='–î–µ–∫–æ–¥–µ—Ä'", (str(robber_id),))
            res = cursor.fetchone()
            decoders = res[0] if res else 0

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ —Ü–∏–∫–ª–∞
        if decoders <= 0 and get_user_immunity(target_user_id):
            conn.close()
            return

    # --- –±–∞–ª–∞–Ω—Å –∂–µ—Ä—Ç–≤—ã ---
    victim_balance = get_user_balance(target_user_id)
    if victim_balance <= 0:
        await update.message.reply_text(f"‚ùå –£ {target_name} –Ω–µ—Ç –¥–µ–Ω–µ–≥ –¥–ª—è –æ–≥—Ä–∞–±–ª–µ–Ω–∏—è.", parse_mode="HTML")
        conn.close()
        return

    # --- —Ä–∞–Ω–¥–æ–º–Ω—ã–π –∏—Å—Ö–æ–¥ ---
    roll = random.randint(1, 100)
    success = False
    reason = ""
    stolen_amount = 0
    percent = 0

    if roll <= 20:
        reason = "–í–∞—Å –∑–∞–º–µ—Ç–∏–ª–∞ –∂–µ—Ä—Ç–≤–∞, –∏ –≤—ã —É–±–µ–∂–∞–ª–∏!"
    elif roll <= 45:
        reason = "–í–∞—Å –ø–æ–π–º–∞–ª–∞ –ø–æ–ª–∏—Ü–∏—è!"
    else:
        success = True
        percent = random.randint(1, 50)
        stolen_amount = max(1, int(victim_balance * percent / 100))
        stolen_amount = min(stolen_amount, victim_balance)
        transfer_balance(target_user_id, robber_id, stolen_amount)

    # --- –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ ---
    cursor.execute("""
        UPDATE robbery_data
        SET 
            total_attempts = total_attempts + 1,
            success_attempts = success_attempts + ?,
            failed_attempts = failed_attempts + ?,
            total_stolen = total_stolen + ?
        WHERE user_id = ?
    """, (1 if success else 0, 0 if success else 1, stolen_amount if success else 0, str(robber_id)))

    # --- –ª–æ–≥ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 10 –æ–≥—Ä–∞–±–ª–µ–Ω–∏–π ---
    cursor.execute("SELECT last_robberies_json FROM robbery_data WHERE user_id = ?", (str(robber_id),))
    row = cursor.fetchone()
    last_robberies = []
    if row and row[0]:
        try:
            last_robberies = json.loads(row[0])
        except:
            last_robberies = []

    new_record = {
        "victim_name": target_name,
        "amount": stolen_amount if success else 0,
        "date": datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
        "success": success
    }
    last_robberies.insert(0, new_record)
    last_robberies = last_robberies[:10]
    cursor.execute("UPDATE robbery_data SET last_robberies_json = ? WHERE user_id = ?",
                   (json.dumps(last_robberies, ensure_ascii=False), str(robber_id)))

    conn.commit()
    conn.close()

    # --- —Å–æ–æ–±—â–µ–Ω–∏–µ ---
    if success:
        await update.message.reply_text(
            f"‚úÖ –û–≥—Ä–∞–±–ª–µ–Ω–∏–µ –ø—Ä–æ—à–ª–æ —É—Å–ø–µ—à–Ω–æ!\nüß© –í—ã –æ–≥—Ä–∞–±–∏–ª–∏: {target_name}\nüí∞ –°—É–º–º–∞: {format_number(stolen_amount)}‚ÇΩ\nüìä –ü—Ä–æ—Ü–µ–Ω—Ç –æ—Ç –±–∞–ª–∞–Ω—Å–∞ –∂–µ—Ä—Ç–≤—ã: {percent}%",
            parse_mode="HTML"
        )
    else:
        await update.message.reply_text(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å. {reason}")


def looks_like_choose_command(text: str) -> bool:
    if " –∏–ª–∏ " in text.lower():
        keywords = ["–≤—ã–±–µ—Ä–∏", "—á—Ç–æ –ª—É—á—à–µ", "—á—Ç–æ –≤—ã–±–µ—Ä–µ—à—å", "—á—Ç–æ –≤—ã–±—Ä–∞—Ç—å", "—á—Ç–æ –≤—ã–±–∏—Ä–∞–µ—à—å", "—á—Ç–æ –±—É–¥–µ—à—å –≤—ã–±–∏—Ä–∞—Ç—å"]
        text_lower = text.lower()
        if any(keyword in text_lower for keyword in keywords):
            return True
        options = re.split(r"\s+–∏–ª–∏\s+", text_lower)
        if len(options) >= 2:
            return True
    return False


async def handle_ai_choose(update: Update, thinking_message, text: str):
    keywords_pattern = r"^(–≤—ã–±–µ—Ä–∏|–≤—ã–±–µ—Ä–∏ –æ–¥–∏–Ω –∏–∑|—á—Ç–æ –≤—ã–±–µ—Ä–µ—à—å|—á—Ç–æ –ª—É—á—à–µ|—á—Ç–æ –≤—ã–±—Ä–∞—Ç—å|—á—Ç–æ –≤—ã–±–∏—Ä–∞–µ—à—å|—á—Ç–æ –±—É–¥–µ—à—å –≤—ã–±–∏—Ä–∞—Ç—å)\s+(.+)$"
    m = re.match(keywords_pattern, text.lower())
    options_str = m.group(2) if m else text

    options = re.split(r"\s+–∏–ª–∏\s+", options_str)
    options = [opt.strip() for opt in options if opt.strip()]

    if len(options) < 2:
        await thinking_message.edit_text(
            "‚ùå –î–ª—è –≤—ã–±–æ—Ä–∞ –Ω—É–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –¥–≤–∞ –∏–ª–∏ –±–æ–ª–µ–µ –≤–∞—Ä–∏–∞–Ω—Ç–∞ —á–µ—Ä–µ–∑ ¬´–∏–ª–∏¬ª.",
            parse_mode='HTML'
        )
        return

    await asyncio.sleep(1)  # –ø–∞—É–∑–∞ –¥–ª—è ¬´—Ä–∞–∑–º—ã—à–ª–µ–Ω–∏—è¬ª

    choice = random.choice(options)

    responses = [
        f"ü§ñ –Ø –≤—ã–±–∏—Ä–∞—é: <b>{choice}</b>.",
        f"üëå –î—É–º–∞—é, —Å—Ç–æ–∏—Ç –≤—ã–±—Ä–∞—Ç—å <b>{choice}</b>.",
        f"üéØ –ú–æ–π –≤—ã–±–æ—Ä ‚Äî <b>{choice}</b>.",
        f"üßê –ü–æ –º–æ–µ–º—É –º–Ω–µ–Ω–∏—é, –ª—É—á—à–µ –≤–∑—è—Ç—å <b>{choice}</b>.",
        f"üî• –Ø –±—ã –≤—ã–±—Ä–∞–ª <b>{choice}</b>.",
        f"‚ú® –ü—É—Å—Ç—å –±—É–¥–µ—Ç <b>{choice}</b>.",
        f"üí° –ú–æ–π –≤—ã–±–æ—Ä ‚Äî <b>{choice}</b>.",
        f"ü§î –Ø —Å—á–∏—Ç–∞—é, —á—Ç–æ –ø–æ–¥—Ö–æ–¥–∏—Ç <b>{choice}</b>.",
        f"‚úî –í—ã–±–∏—Ä–∞—é <b>{choice}</b>.",
        f"üöÄ –í—ã–±–æ—Ä ‚Äî <b>{choice}</b>.",
        f"üìå –ú–æ–π –æ—Ç–≤–µ—Ç: <b>{choice}</b>.",
        f"üéâ –í—ã–±–∏—Ä–∞—é <b>{choice}</b>, —ç—Ç–æ –∫–∞–∂–µ—Ç—Å—è –ª–æ–≥–∏—á–Ω—ã–º.",
        f"ü¶æ –û—Ç–≤–µ—á–∞—é: <b>{choice}</b>.",
        f"ü§ñ –Ø —Å—á–∏—Ç–∞—é, —á—Ç–æ <b>{choice}</b> ‚Äî –ª—É—á—à–∏–π –≤–∞—Ä–∏–∞–Ω—Ç.",
        f"üì£ –ú–æ–π –≤—ã–±–æ—Ä ‚Äî <b>{choice}</b>.",
    ]

    reply = random.choice(responses)

    await thinking_message.edit_text(reply, parse_mode='HTML')

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –º–æ–ª—á–∞–ª–∏–≤–æ–≥–æ –æ–±—É—á–µ–Ω–∏—è (–Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—è)
async def observe_and_learn(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text
    if not text:
        return

    last_msg = context.chat_data.get('last_message')

    if last_msg:
        question = last_msg['text']
        answer = text
        learn_phrase(question, answer)

    context.chat_data['last_message'] = {
        'user_id': update.message.from_user.id,
        'text': text
    }


def get_user_business(user_id):
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute(
        "SELECT business_id, business_type, name, balance, level, employees, products FROM businesses_XUI WHERE owner_id = ?",
        (user_id,))
    row = cursor.fetchone()
    conn.close()
    return row


async def send_business_list(update_or_query, context):
    if hasattr(update_or_query, "effective_user"):
        user = update_or_query.effective_user
        send_method = update_or_query.message.reply_text
    else:
        user = update_or_query.from_user
        send_method = update_or_query.edit_message_text

    user_id = str(user.id)
    display_name = get_display_name_html_new(user)

    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    cursor.execute("""
        SELECT business_id, name, business_type FROM businesses_XUI WHERE owner_id = ?
    """, (user_id,))
    rows = cursor.fetchall()
    conn.close()

    if not rows:
        text = f"üëã –ü—Ä–∏–≤–µ—Ç, {display_name}\n<pre>‚ùå –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é —É –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –±–∏–∑–Ω–µ—Å–æ–≤..</pre>"
        await send_method(text, parse_mode="HTML")
        return

    # –ö—Ä–∞—Å–∏–≤–æ–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
    text = (
        f"üëã –ü—Ä–∏–≤–µ—Ç, {display_name}!\n\n"
        f"üè¢ <b>–í–∞—à–∏ –±–∏–∑–Ω–µ—Å—ã:</b>\n"
    )

    keyboard = []
    for biz_id, name, biz_type in rows:
        button_text = f"ID: {biz_id} | {html.escape(name)} ({html.escape(biz_type)})"
        keyboard.append([InlineKeyboardButton(button_text, callback_data=f"showbiz_{biz_id}_{user_id}")])

    # –ï—Å–ª–∏ –±–∏–∑–Ω–µ—Å–æ–≤ 2 –∏ –±–æ–ª–µ–µ, –¥–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É ¬´–°–æ–±—Ä–∞—Ç—å –≤—Å—é –ø—Ä–∏–±—ã–ª—å¬ª
    if len(rows) > 1:
        keyboard.append([InlineKeyboardButton("üí∏ –°–æ–±—Ä–∞—Ç—å –≤—Å—é –ø—Ä–∏–±—ã–ª—å", callback_data=f"collect_all_profit_{user_id}")])

    reply_markup = InlineKeyboardMarkup(keyboard)

    await send_method(text, parse_mode="HTML", reply_markup=reply_markup)


async def collect_all_profit_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    data = query.data

    if not data.startswith("collect_all_profit_"):
        return

    parts = data.split("_")
    if len(parts) != 4:
        await query.answer("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.", show_alert=True)
        return

    owner_id_from_data = parts[3]
    user_id = str(query.from_user.id)

    if user_id != owner_id_from_data:
        await query.answer("‚ùå –°–æ–±—Ä–∞—Ç—å –ø—Ä–∏–±—ã–ª—å –º–æ–∂–µ—Ç —Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü –±–∏–∑–Ω–µ—Å–æ–≤.", show_alert=True)
        return

    try:
        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()

        cursor.execute("SELECT business_id, balance FROM businesses_XUI WHERE owner_id = ?", (user_id,))
        businesses = cursor.fetchall()

        if not businesses:
            await query.answer("–£ –≤–∞—Å –Ω–µ—Ç –±–∏–∑–Ω–µ—Å–æ–≤.", show_alert=True)
            conn.close()
            return

        total_collected = 0
        for business_id, balance_str in businesses:
            balance = int(balance_str or 0)
            if balance > 0:
                total_collected += balance
                cursor.execute("UPDATE businesses_XUI SET balance = 0 WHERE business_id = ?", (business_id,))

        if total_collected == 0:
            await query.answer("–ë–∞–ª–∞–Ω—Å –≤—Å–µ—Ö –±–∏–∑–Ω–µ—Å–æ–≤ –ø—É—Å—Ç, –Ω–µ—á–µ–≥–æ —Å–æ–±–∏—Ä–∞—Ç—å.", show_alert=True)
            conn.close()
            return

        cursor.execute("SELECT balance FROM users WHERE user_id = ?", (user_id,))
        user_row = cursor.fetchone()
        user_balance = int(user_row[0] or 0) if user_row else 0
        new_user_balance = user_balance + total_collected

        cursor.execute("UPDATE users SET balance = ? WHERE user_id = ?", (new_user_balance, user_id))

        conn.commit()
        conn.close()

        formatted_total = "{:,}".format(total_collected).replace(",", ".")
        formatted_new_balance = "{:,}".format(new_user_balance).replace(",", ".")

        await query.answer(
            f"üí∞ –°–æ–±—Ä–∞–Ω–∞ –ø—Ä–∏–±—ã–ª—å —Å–æ –≤—Å–µ—Ö –±–∏–∑–Ω–µ—Å–æ–≤: {formatted_total}‚ÇΩ\n"
            f"üí∞ –ù–æ–≤—ã–π –±–∞–ª–∞–Ω—Å: {formatted_new_balance}‚ÇΩ",
            show_alert=True
        )

    except Exception as e:
        await query.answer(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±–æ—Ä–µ –ø—Ä–∏–±—ã–ª–∏: {e}", show_alert=True)


async def bmenu(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await send_business_list(update, context)


async def back_to_bmenu_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    await send_business_list(query, context)


def format_number(num: int) -> str:
    return f"{num:,}".replace(",", ".")


async def show_business_details(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    data = query.data

    if not data.startswith("showbiz_"):
        return

    parts = data.split("_")
    if len(parts) != 3:
        await query.answer("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.", show_alert=True)
        return

    biz_id = parts[1]
    try:
        owner_id_from_data = int(parts[2])
    except ValueError:
        await query.answer("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.", show_alert=True)
        return

    try:
        with sqlite3.connect(DB_PATH) as conn:
            cursor = conn.cursor()
            cursor.execute("""
                SELECT business_id, name, business_type, balance, level, employees, products 
                FROM businesses_XUI WHERE business_id = ?
            """, (biz_id,))
            biz = cursor.fetchone()
    except Exception as e:
        await query.answer(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ—Å—Ç—É–ø–µ –∫ –±–∞–∑–µ: {e}", show_alert=True)
        return

    if not biz:
        await query.answer("‚ùó –ë–∏–∑–Ω–µ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω.", show_alert=True)
        return

    business_id, name, business_type, balance, level, employees, products = biz

    display_name = get_display_name_html_new(update.callback_query.from_user)

    max_employees_by_level = {
        1: 5, 2: 10, 3: 15, 4: 20, 5: 25, 6: 30, 7: 35, 8: 40, 9: 50, 10: 60,
        11: 70, 12: 80, 13: 90, 14: 100, 15: 110, 16: 120, 17: 130, 18: 140,
        19: 150, 20: 160, 21: 170, 22: 180, 23: 190, 24: 200, 25: 210,
        26: 220, 27: 230, 28: 240, 29: 250, 30: 260
    }
    max_employees = max_employees_by_level.get(level, 5)

    hourly_profit = business_profits.get(business_type, {}).get(level, 0)

    # —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —á–∏—Å–ª–∞
    balance_fmt = format_number(int(balance))
    hourly_profit_fmt = format_number(int(hourly_profit))

    # –ë–∞–∑–æ–≤—ã–π —Ç–µ–∫—Å—Ç
    text = (
        f"üè¢ <b>–ú–µ–Ω—é –±–∏–∑–Ω–µ—Å–∞</b>\n\n"
        f"üë§ <b>–í–ª–∞–¥–µ–ª–µ—Ü:</b> {display_name}\n"
        f"üÜî <b>ID –±–∏–∑–Ω–µ—Å–∞:</b> {business_id}\n"
        f"üè∑ <b>–ù–∞–∑–≤–∞–Ω–∏–µ:</b> {html.escape(name)}\n"
        f"üìÇ <b>–¢–∏–ø:</b> {html.escape(business_type)}\n"
        f"üí∞ <b>–ë–∞–ª–∞–Ω—Å:</b> {balance_fmt}‚ÇΩ\n"
        f"üìà <b>–£—Ä–æ–≤–µ–Ω—å:</b> {level}\n"
        f"üíµ <b>–ü–æ—á–∞—Å–æ–≤–æ–π –¥–æ—Ö–æ–¥:</b> {hourly_profit_fmt}‚ÇΩ\n"
        f"üë• <b>–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏:</b> {employees}/{max_employees}\n"
    )

    # –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É —Ç–æ–≤–∞—Ä–æ–≤ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ –∫–∞–∑–∏–Ω–æ –∏ –Ω–µ –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –ë–∞–Ω–∫
    if business_type.lower() not in ("–∫–∞–∑–∏–Ω–æ", "—Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –±–∞–Ω–∫"):
        products_count = int(products) if products else 0
        text += f"üì¶ <b>–¢–æ–≤–∞—Ä—ã:</b> {products_count}/100"

    # –§–æ—Ä–º–∏—Ä—É–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
    keyboard = [
        [InlineKeyboardButton("üìà –£–ª—É—á—à–∏—Ç—å", callback_data=f"upgradebiz_{business_id}_{owner_id_from_data}"),
         InlineKeyboardButton("üí∞ –ü—Ä–æ–¥–∞—Ç—å", callback_data=f"sellbiz_{business_id}_{owner_id_from_data}")],
        [InlineKeyboardButton("üë• –ù–∞–Ω—è—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤", callback_data=f"hire_{business_id}_{owner_id_from_data}")],
        [InlineKeyboardButton("üíµ –°–æ–±—Ä–∞—Ç—å –ø—Ä–∏–±—ã–ª—å", callback_data=f"collectprofit_{business_id}_{owner_id_from_data}")],
        [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="back_to_bmenu")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)

    await query.edit_message_text(text, parse_mode="HTML", reply_markup=reply_markup)


async def collect_profit_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    data = query.data

    if not data.startswith("collectprofit_"):
        return

    parts = data.split("_")
    if len(parts) != 3:
        await query.answer("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.", show_alert=True)
        return

    business_id = parts[1]
    owner_id_from_data = int(parts[2])
    user_id = query.from_user.id

    if user_id != owner_id_from_data:
        await query.answer("‚ùå –°–æ–±—Ä–∞—Ç—å –ø—Ä–∏–±—ã–ª—å –º–æ–∂–µ—Ç —Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü –±–∏–∑–Ω–µ—Å–∞.", show_alert=True)
        return

    try:
        with sqlite3.connect(DB_PATH) as conn:
            cursor = conn.cursor()
            cursor.execute("""
                SELECT name, business_type, balance, level, employees, products 
                FROM businesses_XUI WHERE business_id = ?
            """, (business_id,))
            biz = cursor.fetchone()
            if not biz:
                await query.answer("–ë–∏–∑–Ω–µ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω.", show_alert=True)
                return

            name, business_type, balance_str, level, employees, products = biz
            biz_balance = int(balance_str or 0)

            if biz_balance <= 0:
                await query.answer("–ë–∞–ª–∞–Ω—Å –±–∏–∑–Ω–µ—Å–∞ –ø—É—Å—Ç, –Ω–µ—á–µ–≥–æ —Å–æ–±–∏—Ä–∞—Ç—å.", show_alert=True)
                return

            # –ó–∞—á–∏—Å–ª—è–µ–º –ø—Ä–∏–±—ã–ª—å –≤–ª–∞–¥–µ–ª—å—Ü—É
            cursor.execute("SELECT balance FROM users WHERE user_id = ?", (str(owner_id_from_data),))
            user_row = cursor.fetchone()
            user_balance = int(user_row[0] or 0) if user_row else 0

            new_user_balance = user_balance + biz_balance

            cursor.execute("UPDATE users SET balance = ? WHERE user_id = ?",
                           (new_user_balance, str(owner_id_from_data)))
            cursor.execute("UPDATE businesses_XUI SET balance = '0' WHERE business_id = ?", (business_id,))
            conn.commit()

            # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Å—É–º–º—ã
            formatted_biz_balance = "{:,}".format(biz_balance).replace(",", ".")
            formatted_new_user_balance = "{:,}".format(new_user_balance).replace(",", ".")

            await query.answer(
                f"üí∞ –ü—Ä–∏–±—ã–ª—å —Å–Ω—è—Ç–∞.\n"
                f"ID –ë–∏–∑–Ω–µ—Å–∞: {business_id}\n"
                f"–°–Ω—è—Ç–æ: {formatted_biz_balance}‚ÇΩ\n"
                f"üí∞ –ù–æ–≤—ã–π –±–∞–ª–∞–Ω—Å –≤–ª–∞–¥–µ–ª—å—Ü–∞: {formatted_new_user_balance}‚ÇΩ",
                show_alert=True
            )

            # –§–æ—Ä–º–∏—Ä—É–µ–º –Ω–æ–≤—ã–π —Ç–µ–∫—Å—Ç —Å –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–º –±–∞–ª–∞–Ω—Å–æ–º
            display_name = get_display_name_html_new(query.from_user)

            max_employees_by_level = {
                1: 5, 2: 10, 3: 15, 4: 20, 5: 25, 6: 30, 7: 35, 8: 40, 9: 50, 10: 60,
                11: 70, 12: 80, 13: 90, 14: 100, 15: 110, 16: 120, 17: 130, 18: 140,
                19: 150, 20: 160, 21: 170, 22: 180, 23: 190, 24: 200, 25: 210,
                26: 220, 27: 230, 28: 240, 29: 250, 30: 260
            }
            max_employees = max_employees_by_level.get(level, 5)
            hourly_profit = business_profits.get(business_type, {}).get(level, 0)
            formatted_hourly_profit = "{:,}".format(hourly_profit).replace(",", ".")

            new_text = (
                f"üè¢ <b>–ú–µ–Ω—é –±–∏–∑–Ω–µ—Å–∞</b>\n\n"
                f"üë§ <b>–í–ª–∞–¥–µ–ª–µ—Ü:</b> {display_name}\n"
                f"üÜî <b>ID –±–∏–∑–Ω–µ—Å–∞:</b> {business_id}\n"
                f"üè∑ <b>–ù–∞–∑–≤–∞–Ω–∏–µ:</b> {html.escape(name)}\n"
                f"üìÇ <b>–¢–∏–ø:</b> {html.escape(business_type)}\n"
                f"üí∞ <b>–ë–∞–ª–∞–Ω—Å:</b> 0‚ÇΩ\n"
                f"üìà <b>–£—Ä–æ–≤–µ–Ω—å:</b> {level}\n"
                f"üíµ <b>–ü–æ—á–∞—Å–æ–≤–æ–π –¥–æ—Ö–æ–¥:</b> {formatted_hourly_profit}‚ÇΩ\n"
                f"üë• <b>–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏:</b> {employees}/{max_employees}\n"
            )

            if business_type.lower() != "–∫–∞–∑–∏–Ω–æ":
                products_count = int(products or 0)
                new_text += f"üì¶ <b>–¢–æ–≤–∞—Ä—ã:</b> {products_count}/100"

            keyboard = [
                [
                    InlineKeyboardButton("üìà –£–ª—É—á—à–∏—Ç—å", callback_data=f"upgradebiz_{business_id}_{owner_id_from_data}"),
                    InlineKeyboardButton("üí∞ –ü—Ä–æ–¥–∞—Ç—å", callback_data=f"sellbiz_{business_id}_{owner_id_from_data}")
                ],
                [InlineKeyboardButton("üë• –ù–∞–Ω—è—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤",
                                      callback_data=f"hire_{business_id}_{owner_id_from_data}")],
                [InlineKeyboardButton("üí∏ –°–æ–±—Ä–∞—Ç—å –ø—Ä–∏–±—ã–ª—å",
                                      callback_data=f"collectprofit_{business_id}_{owner_id_from_data}")],
                [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="back_to_bmenu")]
            ]
            reply_markup = InlineKeyboardMarkup(keyboard)

            await query.edit_message_text(new_text, parse_mode="HTML", reply_markup=reply_markup)

    except Exception as e:
        await query.answer(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±–æ—Ä–µ –ø—Ä–∏–±—ã–ª–∏: {e}", show_alert=True)


async def upgrade_business(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    data = query.data
    if not data.startswith("upgradebiz_"):
        return

    parts = data.split("_")
    if len(parts) != 3:
        await query.answer("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.", show_alert=True)
        return

    biz_id = parts[1]
    try:
        owner_id_from_data = int(parts[2])
    except ValueError:
        await query.answer("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.", show_alert=True)
        return

    if query.from_user.id != owner_id_from_data:
        await query.answer("‚ùó –≠—Ç–æ –º–µ–Ω—é –Ω–µ –¥–ª—è –≤–∞—Å.", show_alert=True)
        return

    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    cursor.execute("""
        SELECT business_type, level FROM businesses_XUI WHERE business_id = ?
    """, (biz_id,))
    biz = cursor.fetchone()
    if not biz:
        conn.close()
        await query.answer("‚ùó –ë–∏–∑–Ω–µ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω.", show_alert=True)
        return

    business_type, level = biz
    level = int(level)

    if level + 1 not in business_profits.get(business_type, {}):
        conn.close()
        await query.answer("üìà –î–æ—Å—Ç–∏–≥–Ω—É—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å.", show_alert=True)
        return

    current_profit = business_profits[business_type][level]
    upgrade_cost = int(current_profit * 0.55)

    cursor.execute("SELECT balance FROM users WHERE user_id = ?", (str(owner_id_from_data),))
    user = cursor.fetchone()
    if not user:
        conn.close()
        await query.answer("‚ùó –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω.", show_alert=True)
        return

    user_balance = int(user[0])
    if user_balance < upgrade_cost:
        conn.close()
        await query.answer(f"üí∏ –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤..\n–ù—É–∂–Ω–æ: {upgrade_cost}‚ÇΩ", show_alert=True)
        return

    new_balance = user_balance - upgrade_cost
    cursor.execute("UPDATE users SET balance = ? WHERE user_id = ?", (new_balance, str(owner_id_from_data)))
    cursor.execute("UPDATE businesses_XUI SET level = ? WHERE business_id = ?", (level + 1, biz_id))
    conn.commit()
    conn.close()

    await query.answer(f"‚úÖ –ë–∏–∑–Ω–µ—Å —É–ª—É—á—à–µ–Ω.\n–ù–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å: {level + 1}", show_alert=True)

    # –¢–µ–ø–µ—Ä—å –æ–±–Ω–æ–≤–ª—è–µ–º –º–µ–Ω—é –±–∏–∑–Ω–µ—Å–∞
    await show_business_details(update, context)


PRICE_PER_PRODUCT = 1543
MAX_PRODUCTS = 100


async def bproduct_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    args = context.args

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç –∫–æ–º–∞–Ω–¥—ã
    if len(args) != 3 or args[0].lower() != "—Ç–æ–≤–∞—Ä—ã":
        await update.message.reply_text("‚ùó –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É —Ç–∞–∫: /bproduct —Ç–æ–≤–∞—Ä—ã <id_–±–∏–∑–Ω–µ—Å–∞> <–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–æ–≤>")
        return

    business_id = args[1]
    quantity_str = args[2]

    if not quantity_str.isdigit():
        await update.message.reply_text("‚ùó –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–æ–≤ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —á–∏—Å–ª–æ–º.")
        return

    quantity_to_buy = int(quantity_str)
    if quantity_to_buy <= 0:
        await update.message.reply_text("‚ùó –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–æ–≤ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –±–æ–ª—å—à–µ 0.")
        return

    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –±–∏–∑–Ω–µ—Å —Å —Ç–∞–∫–∏–º id –µ—Å—Ç—å –∏ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    cursor.execute("SELECT owner_id, products FROM businesses_XUI WHERE business_id = ?", (business_id,))
    biz = cursor.fetchone()
    if not biz:
        await update.message.reply_text("‚ùó –ë–∏–∑–Ω–µ—Å —Å —Ç–∞–∫–∏–º ID –Ω–µ –Ω–∞–π–¥–µ–Ω.")
        conn.close()
        return

    owner_id, current_products = biz
    current_products = int(current_products) if current_products else 0

    if owner_id != user_id:
        await update.message.reply_text("‚ùó –≠—Ç–æ—Ç –±–∏–∑–Ω–µ—Å –Ω–µ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –≤–∞–º.")
        conn.close()
        return

    max_can_buy = MAX_PRODUCTS - current_products
    if max_can_buy <= 0:
        await update.message.reply_text("‚ùó –£ —ç—Ç–æ–≥–æ –±–∏–∑–Ω–µ—Å–∞ —É–∂–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–æ–≤ (100).")
        conn.close()
        return

    if quantity_to_buy > max_can_buy:
        await update.message.reply_text(f"‚ùó –í—ã –º–æ–∂–µ—Ç–µ –∫—É–ø–∏—Ç—å –º–∞–∫—Å–∏–º—É–º {max_can_buy} —Ç–æ–≤–∞—Ä–æ–≤.")
        conn.close()
        return

    total_cost = quantity_to_buy * PRICE_PER_PRODUCT

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    cursor.execute("SELECT balance FROM users WHERE user_id = ?", (str(user_id),))
    user = cursor.fetchone()
    if not user:
        await update.message.reply_text("‚ùó –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.")
        conn.close()
        return

    balance = user[0]
    if balance < total_cost:
        await update.message.reply_text(f"‚ùó –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤. –ù—É–∂–Ω–æ {total_cost}‚ÇΩ, —É –≤–∞—Å {balance}‚ÇΩ.")
        conn.close()
        return

    # –°–ø–∏—Å—ã–≤–∞–µ–º –¥–µ–Ω—å–≥–∏ –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–æ–≤
    new_balance = balance - total_cost
    new_products = current_products + quantity_to_buy

    cursor.execute("UPDATE users SET balance = ? WHERE user_id = ?", (new_balance, str(user_id)))
    cursor.execute("UPDATE businesses_XUI SET products = ? WHERE business_id = ?", (new_products, business_id))
    conn.commit()
    conn.close()

    await update.message.reply_text(
        f"‚úÖ <b>–ü–æ–∫—É–ø–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤!</b>\n"
        f"<pre>üì¶ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: {quantity_to_buy}\n"
        f"üè¢ ID –±–∏–∑–Ω–µ—Å–∞: {business_id}\n"
        f"üí∞ –¶–µ–Ω–∞: {total_cost}‚ÇΩ</pre>\n"
        f"üìä <b>–°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∫–ª–∞–¥–∞:</b> {new_products}",
        parse_mode="HTML"
    )


COST_RENAME = 15000


def format_money(amount: int) -> str:
    return f"{amount:,}".replace(",", ".")


async def bsetname_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    args = context.args

    if len(args) < 2:
        await update.message.reply_text("–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: –±–∏–∑–Ω–µ—Å –Ω–∞–∑–≤–∞–Ω–∏–µ {id_–±–∏–∑–Ω–µ—Å–∞} {–Ω–æ–≤–æ–µ_–Ω–∞–∑–≤–∞–Ω–∏–µ –¥–æ 20 —Å–∏–º–≤–æ–ª–æ–≤}")
        return

    business_id = args[0]
    new_name = " ".join(args[1:]).strip()

    if len(new_name) > 20:
        await update.message.reply_text("‚ùó –ù–∞–∑–≤–∞–Ω–∏–µ –Ω–µ –¥–æ–ª–∂–Ω–æ –ø—Ä–µ–≤—ã—à–∞—Ç—å 20 —Å–∏–º–≤–æ–ª–æ–≤.")
        return

    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    cursor.execute("SELECT owner_id FROM businesses_XUI WHERE business_id = ?", (business_id,))
    row = cursor.fetchone()
    if not row:
        conn.close()
        await update.message.reply_text("‚ùó –ë–∏–∑–Ω–µ—Å —Å —Ç–∞–∫–∏–º ID –Ω–µ –Ω–∞–π–¥–µ–Ω.")
        return

    owner_id = row[0]
    if owner_id != user_id:
        conn.close()
        await update.message.reply_text("‚ùó –í—ã –Ω–µ —è–≤–ª—è–µ—Ç–µ—Å—å –≤–ª–∞–¥–µ–ª—å—Ü–µ–º —ç—Ç–æ–≥–æ –±–∏–∑–Ω–µ—Å–∞.")
        return

    cursor.execute("SELECT balance FROM users WHERE user_id = ?", (user_id,))
    user_row = cursor.fetchone()
    if not user_row:
        conn.close()
        await update.message.reply_text("‚ùó –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–∞—à–µ–º –±–∞–ª–∞–Ω—Å–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.")
        return

    balance = user_row[0]
    if balance < COST_RENAME:
        conn.close()
        await update.message.reply_text(
            f"‚ùó <b>–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤!</b>\n"
            f"üí∞ –ù—É–∂–Ω–æ: {format_money(COST_RENAME)}‚ÇΩ",
            parse_mode="HTML"
        )
        return

    cursor.execute("UPDATE businesses_XUI SET name = ? WHERE business_id = ?", (new_name, business_id))
    new_balance = balance - COST_RENAME
    cursor.execute("UPDATE users SET balance = ? WHERE user_id = ?", (new_balance, user_id))

    conn.commit()
    conn.close()

    await update.message.reply_text(
        f"‚úÖ <b>–ù–∞–∑–≤–∞–Ω–∏–µ –±–∏–∑–Ω–µ—Å–∞ –∏–∑–º–µ–Ω–µ–Ω–æ!</b>\n"
        f"<pre>üè¢ –ë–∏–∑–Ω–µ—Å ID: <code>{business_id}</code>\n"
        f"‚úèÔ∏è –ù–∞–∑–≤–∞–Ω–∏–µ: <b>{html.escape(new_name)}</b>\n"
        f"üí∏ –°—Ç–æ–∏–º–æ—Å—Ç—å: {format_money(COST_RENAME)}‚ÇΩ</pre>\n"
        f"üíº –ë–∞–ª–∞–Ω—Å: {format_money(new_balance)}‚ÇΩ",
        parse_mode="HTML"
    )


async def hire_employees_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    data = query.data  # –æ–∂–∏–¥–∞–µ–º —á—Ç–æ-—Ç–æ —Ç–∏–ø–∞ hire_{business_id}_{owner_id}

    parts = data.split("_")
    if len(parts) != 3:
        await query.answer("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.", show_alert=True)
        return

    business_id = parts[1]
    owner_id = int(parts[2])

    if query.from_user.id != owner_id:
        await query.answer("‚ùó –≠—Ç–æ –º–µ–Ω—é –Ω–µ –¥–ª—è –≤–∞—Å.", show_alert=True)
        return

    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT employees, level FROM businesses_XUI WHERE business_id = ?", (business_id,))
    biz = cursor.fetchone()
    conn.close()

    if not biz:
        await query.answer("‚ùó –ë–∏–∑–Ω–µ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω.", show_alert=True)
        return

    current_employees, level = biz

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ user_data
    context.user_data['business_id'] = business_id
    context.user_data['current_employees'] = current_employees
    context.user_data['business_level'] = level

    await query.answer()
    await query.message.reply_text(
        "üë• <b>–°–∫–æ–ª—å–∫–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –≤—ã —Ö–æ—Ç–∏—Ç–µ –Ω–∞–Ω—è—Ç—å?</b>\n"
        "<pre>‚è≥ –í—Ä–µ–º—è –Ω–∞ –æ—Ç–≤–µ—Ç: 1 –º–∏–Ω.</pre>",
        parse_mode="HTML"
    )

    return HIRE_AMOUNT


async def hire_amount_received(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.message.from_user.id
    text = update.message.text

    # –ë–µ—Ä—ë–º –¥–∞–Ω–Ω—ã–µ –æ –±–∏–∑–Ω–µ—Å–µ –∏–∑ context, –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–µ —Ä–∞–Ω–µ–µ
    business_id = context.user_data.get('business_id')
    current_employees = context.user_data.get('current_employees')
    level = context.user_data.get('business_level')

    if business_id is None or current_employees is None or level is None:
        await update.message.reply_text("‚ùó –û—à–∏–±–∫–∞: –¥–∞–Ω–Ω—ã–µ –æ –±–∏–∑–Ω–µ—Å–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–ø—ã—Ç–∫—É.")
        return ConversationHandler.END

    # –≤—Å–µ–≥–æ —É—Ä–æ–≤–Ω–µ–π 30
    max_employees_by_level = {
        1: 5, 2: 10, 3: 15, 4: 20, 5: 25, 6: 30, 7: 35, 8: 40, 9: 50, 10: 60, 11: 70, 12: 80, 13: 90, 14: 100, 15: 110,
        16: 120, 17: 130,
        18: 140, 19: 150, 20: 160, 21: 170, 22: 180, 23: 190, 24: 200, 25: 210,
        26: 220, 27: 230, 28: 240, 29: 250, 30: 260
    }
    max_employees = max_employees_by_level.get(level, 5)

    if not text.isdigit():
        await update.message.reply_text("‚ùó –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ.")
        return HIRE_AMOUNT

    hire_count = int(text)

    if hire_count <= 0:
        await update.message.reply_text("‚ùó –ß–∏—Å–ª–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –±–æ–ª—å—à–µ –Ω—É–ª—è.")
        return HIRE_AMOUNT

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –ø—Ä–µ–≤—ã—Å–∏—Ç –ª–∏ –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–∞–∫—Å–∏–º—É–º
    if current_employees + hire_count > max_employees:
        allowed = max_employees - current_employees
        await update.message.reply_text(
            f"‚ö†Ô∏è <b>–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –Ω–∞–Ω—è—Ç—å —É–∫–∞–∑–∞–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤.</b>\n\n"
            f"üìä –ú–∞–∫—Å. –∫–æ–ª-–≤–æ: <b>{max_employees}</b>\n"
            f"üë• –°–µ–π—á–∞—Å –Ω–∞–Ω—è—Ç–æ: <b>{current_employees}</b>\n"
            f"‚ûï –ú–æ–∂–µ—Ç–µ –Ω–∞–Ω—è—Ç—å: <b>{allowed}</b>",
            parse_mode="HTML"
        )

        return HIRE_AMOUNT

    # –í—Å—ë –æ–∫, –æ–±–Ω–æ–≤–ª—è–µ–º –≤ –±–∞–∑–µ
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute(
        "UPDATE businesses_XUI SET employees = employees + ? WHERE business_id = ?",
        (hire_count, business_id)
    )
    conn.commit()
    conn.close()

    await update.message.reply_text(f"‚úÖ –í—ã —É—Å–ø–µ—à–Ω–æ –Ω–∞–Ω—è–ª–∏ {hire_count} —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤!")

    context.user_data.clear()
    return ConversationHandler.END


async def hire_timeout(update: Update, context: ContextTypes.DEFAULT_TYPE):
    chat_id = None
    if update.message:
        chat_id = update.message.chat_id
    elif update.callback_query:
        chat_id = update.callback_query.message.chat_id
    else:
        # –º–æ–∂–Ω–æ –ø–æ–ø—ã—Ç–∞—Ç—å—Å—è –≤–∑—è—Ç—å chat_id –∏–∑ user_data –∏–ª–∏ context
        chat_id = context.user_data.get("chat_id")

    if chat_id:
        await context.bot.send_message(chat_id, "‚è∞ –í—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –∏—Å—Ç–µ–∫–ª–æ, –Ω–∞–Ω–∏–º–∞—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –æ—Ç–º–µ–Ω–µ–Ω–æ.")

    # –û—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö
    context.user_data.pop("business_id", None)
    context.user_data.pop("current_employees", None)
    context.user_data.pop("business_level", None)

    return ConversationHandler.END


HIRE_AMOUNT = 1

hire_conv_handler = ConversationHandler(
    entry_points=[CallbackQueryHandler(hire_employees_callback, pattern=r"^hire_\d+_\d+$")],
    states={
        HIRE_AMOUNT: [
            MessageHandler(
                filters.TEXT & (~filters.COMMAND),
                hire_amount_received,
                block=False
            )
        ],
    },
    fallbacks=[],
    conversation_timeout=60,
)


async def sell_business_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query

    data = query.data
    if not data.startswith("sellbiz_"):
        return

    parts = data.split("_")
    if len(parts) != 3:
        await query.answer("‚ùó–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞\n–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.", show_alert=True)
        return

    business_id = parts[1]
    owner_id_from_data = int(parts[2])
    if query.from_user.id != owner_id_from_data:
        await query.answer("‚ùó –≠—Ç–æ –º–µ–Ω—é –Ω–µ –¥–ª—è –≤–∞—Å.", show_alert=True)
        return

    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    cursor.execute("""
        SELECT business_id, name, business_type, level FROM businesses_XUI WHERE business_id = ?
    """, (business_id,))
    biz = cursor.fetchone()
    conn.close()

    if not biz:
        await query.edit_message_text("‚ùó –ë–∏–∑–Ω–µ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω.")
        return

    business_id, name, business_type, level = biz

    items = load_items()
    base_price = next((item["price"] for item in items if item["name"] == business_type), 0)
    if base_price == 0:
        await query.edit_message_text("‚ùó –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø –±–∏–∑–Ω–µ—Å–∞.")
        return

    # –°—á–∏—Ç–∞–µ–º –≤–ª–æ–∂–µ–Ω–∏—è –≤ —É–ª—É—á—à–µ–Ω–∏—è (—Ç–∞–∫ –∂–µ, –∫–∞–∫ –≤ confirm_sell_callback)
    invested_sum = 0
    for lvl in range(1, level):
        profit_at_lvl = business_profits.get(business_type, {}).get(lvl, 0)
        invested_sum += int(profit_at_lvl * 0.55)

    # –ò—Ç–æ–≥–æ–≤–∞—è —Ü–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏
    sell_price = int(base_price * 0.8) + int(invested_sum * 0.5)

    text = (
        f"‚ö†Ô∏è –ü—Ä–æ–¥–∞–∂–∞ –±–∏–∑–Ω–µ—Å–∞\n"
        f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
        f"<pre>"
        f"üÜî ID: {business_id}\n"
        f"üè¢ –ù–∞–∑–≤–∞–Ω–∏–µ: {html.escape(name)}\n"
        f"üìä –¢–∏–ø: {html.escape(business_type)}\n"
        f"üìà –£—Ä–æ–≤–µ–Ω—å: {level}\n"
        f"</pre>"
        f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
        f"üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å –ø—Ä–æ–¥–∞–∂–∏: {sell_price}‚ÇΩ\n"
        f"<pre>–ö–∞–∫ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–ª–∞—Å—å —Ü–µ–Ω–∞?\n(80% –æ—Ç –±–∞–∑–æ–≤–æ–π —Ü–µ–Ω—ã + 23% –≤–ª–æ–∂–µ–Ω–∏–π –≤ —É–ª—É—á—à–µ–Ω–∏—è)</pre>"
    )

    keyboard = [
        [
            InlineKeyboardButton(
                "‚úÖ –ü—Ä–æ–¥–∞—Ç—å",
                callback_data=f"confirm_sell_{business_id}_{owner_id_from_data}"
            ),
            InlineKeyboardButton(
                "‚ùå –û—Ç–º–µ–Ω–∞",
                callback_data=f"cancel_sell_{business_id}_{owner_id_from_data}"
            )
        ]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)

    await query.edit_message_text(text, reply_markup=reply_markup, parse_mode="HTML")


async def confirm_sell_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    data = query.data
    if not data.startswith("confirm_sell_"):
        return

    parts = data.split("_")
    if len(parts) != 4:
        await query.answer("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.", show_alert=True)
        return

    business_id = parts[2]
    owner_id_from_data = int(parts[3])

    if query.from_user.id != owner_id_from_data:
        await query.answer("‚ùó –í—ã –Ω–µ –≤–ª–∞–¥–µ–ª–µ—Ü —ç—Ç–æ–≥–æ –±–∏–∑–Ω–µ—Å–∞!", show_alert=True)
        return

    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    cursor.execute("""
        SELECT owner_id, business_type, level FROM businesses_XUI WHERE business_id = ?
    """, (business_id,))
    biz = cursor.fetchone()

    if not biz:
        await query.edit_message_text("‚ùó –ë–∏–∑–Ω–µ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω.")
        conn.close()
        return

    owner_id_db, business_type, level = biz
    user_id = str(query.from_user.id)
    if str(owner_id_db) != user_id:
        await query.edit_message_text("‚ùó –í—ã –Ω–µ –≤–ª–∞–¥–µ–ª–µ—Ü —ç—Ç–æ–≥–æ –±–∏–∑–Ω–µ—Å–∞!")
        conn.close()
        return

    # –ü–æ–ª—É—á–∞–µ–º –±–∞–∑–æ–≤—É—é —Ü–µ–Ω—É –±–∏–∑–Ω–µ—Å–∞
    items = load_items()
    base_price = next((item["price"] for item in items if item["name"] == business_type), 0)
    if base_price == 0:
        await query.edit_message_text("‚ùó –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø –±–∏–∑–Ω–µ—Å–∞.")
        conn.close()
        return

    # –°—á–∏—Ç–∞–µ–º –≤–ª–æ–∂–µ–Ω–∏—è –≤ —É–ª—É—á—à–µ–Ω–∏—è
    # –°—É–º–º–∏—Ä—É–µ–º –ø–æ –≤—Å–µ–º —É—Ä–æ–≤–Ω—è–º –æ—Ç 1 –¥–æ —Ç–µ–∫—É—â–µ–≥–æ - 1
    invested_sum = 0
    for lvl in range(1, level):
        profit_at_lvl = business_profits.get(business_type, {}).get(lvl, 0)
        invested_sum += int(profit_at_lvl * 0.55)

    # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∏—Ç–æ–≥–æ–≤—É—é —Ü–µ–Ω—É –ø—Ä–æ–¥–∞–∂–∏
    sell_price = int(base_price * 0.8) + int(invested_sum * 0.5)

    # –£–¥–∞–ª—è–µ–º –±–∏–∑–Ω–µ—Å –∏–∑ –±–∞–∑—ã
    try:
        cursor.execute("DELETE FROM businesses_XUI WHERE business_id = ?", (business_id,))
        conn.commit()
    except Exception as e:
        await query.edit_message_text(f"‚ùó –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –±–∏–∑–Ω–µ—Å–∞ –∏–∑ –±–∞–∑—ã: {e}")
        conn.close()
        return

    conn.close()

    # –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    try:
        new_balance = update_user_balance(user_id, sell_price)
    except Exception as e:
        await query.edit_message_text(f"‚ùó –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –±–∞–ª–∞–Ω—Å–∞: {e}")
        return

    display_name = get_display_name_html_new(query.from_user)

    keyboard = [
        [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data=f"showbiz_{business_id}_{owner_id_from_data}")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)

    await query.edit_message_text(
        text=(
            f"‚úÖ <b>–ü—Ä–æ–¥–∞–∂–∞ –±–∏–∑–Ω–µ—Å–∞!</b>\n\n"
            f"üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {display_name}\n"
            f"üè∑ –ù–∞–∑–≤–∞–Ω–∏–µ: <b>{html.escape(business_type)}</b>\n"
            f"üìà –£—Ä–æ–≤–µ–Ω—å: <b>{level}</b>\n"
            f"üíµ –¶–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏: <b>{sell_price}‚ÇΩ</b>\n\n"
            f"üìà –°–¥–µ–ª–∫–∞ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ, –±–∏–∑–Ω–µ—Å —É–¥–∞–ª—ë–Ω –∏–∑ –≤–∞—à–µ–≥–æ —Å–ø–∏—Å–∫–∞.\n"
            f"üí∞ –ù–æ–≤—ã–π –±–∞–ª–∞–Ω—Å: <b>{new_balance}‚ÇΩ</b>\n"
            f"<pre>–ö–∞–∫ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–ª–∞—Å—å —Ü–µ–Ω–∞?\n(80% –æ—Ç –±–∞–∑–æ–≤–æ–π —Ü–µ–Ω—ã + 23% –≤–ª–æ–∂–µ–Ω–∏–π –≤ —É–ª—É—á—à–µ–Ω–∏—è)</pre>"
        ),
        parse_mode="HTML",
        reply_markup=reply_markup
    )


async def cancel_sell_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    data = query.data
    if not data.startswith("cancel_sell_"):
        return

    parts = data.split("_")
    if len(parts) != 4:
        await query.answer("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.", show_alert=True)
        return

    business_id = parts[2]
    owner_id_from_data = int(parts[3])

    if query.from_user.id != owner_id_from_data:
        await query.answer("‚ùó –í—ã –Ω–µ –≤–ª–∞–¥–µ–ª–µ—Ü —ç—Ç–æ–≥–æ –±–∏–∑–Ω–µ—Å–∞!", show_alert=True)
        return

    await query.answer(f"‚ùó –ü—Ä–æ–¥–∞–∂–∞ –±–∏–∑–Ω–µ—Å–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞\nID –ë–∏–∑–Ω–µ—Å–∞: {business_id}", show_alert=True)

    await show_business_details_by_id(query, business_id, owner_id_from_data)


async def show_business_details_by_id(query, business_id, owner_id_from_data):
    try:
        with sqlite3.connect(DB_PATH) as conn:
            cursor = conn.cursor()
            cursor.execute("""
                SELECT business_id, name, business_type, balance, level, employees, products 
                FROM businesses_XUI WHERE business_id = ?
            """, (business_id,))
            biz = cursor.fetchone()
    except Exception as e:
        await query.edit_message_text(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ—Å—Ç—É–ø–µ –∫ –±–∞–∑–µ: {e}")
        return

    if not biz:
        await query.edit_message_text("‚ùó –ë–∏–∑–Ω–µ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω.")
        return

    business_id, name, business_type, balance, level, employees, products = biz

    display_name = get_display_name_html_new(query.from_user)

    max_employees_by_level = {
        1: 5, 2: 10, 3: 15, 4: 20, 5: 25, 6: 30, 7: 35, 8: 40, 9: 50, 10: 60,
        11: 70, 12: 80, 13: 90, 14: 100, 15: 110, 16: 120, 17: 130, 18: 140,
        19: 150, 20: 160, 21: 170, 22: 180, 23: 190, 24: 200, 25: 210,
        26: 220, 27: 230, 28: 240, 29: 250, 30: 260
    }
    max_employees = max_employees_by_level.get(level, 5)

    hourly_profit = business_profits.get(business_type, {}).get(level, 0)

    # –ë–∞–∑–æ–≤—ã–π —Ç–µ–∫—Å—Ç
    text = (
        f"üè¢ <b>–ú–µ–Ω—é –±–∏–∑–Ω–µ—Å–∞</b>\n\n"
        f"üë§ <b>–í–ª–∞–¥–µ–ª–µ—Ü:</b> {display_name}\n"
        f"üÜî <b>ID –±–∏–∑–Ω–µ—Å–∞:</b> {business_id}\n"
        f"üè∑ <b>–ù–∞–∑–≤–∞–Ω–∏–µ:</b> {html.escape(name)}\n"
        f"üìÇ <b>–¢–∏–ø:</b> {html.escape(business_type)}\n"
        f"üí∞ <b>–ë–∞–ª–∞–Ω—Å:</b> {balance}\n"
        f"üìà <b>–£—Ä–æ–≤–µ–Ω—å:</b> {level}\n"
        f"üíµ <b>–ü–æ—á–∞—Å–æ–≤–æ–π –¥–æ—Ö–æ–¥:</b> {hourly_profit}‚ÇΩ\n"
        f"üë• <b>–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏:</b> {employees}/{max_employees}\n"
    )

    # –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É —Ç–æ–≤–∞—Ä–æ–≤ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ –∫–∞–∑–∏–Ω–æ
    if business_type.lower() != "–∫–∞–∑–∏–Ω–æ":
        products_count = int(products or 0)
        text += f"üì¶ <b>–¢–æ–≤–∞—Ä—ã:</b> {products_count}/100"

    keyboard = [
        [
            InlineKeyboardButton("üìà –£–ª—É—á—à–∏—Ç—å", callback_data=f"upgradebiz_{business_id}_{owner_id_from_data}"),
            InlineKeyboardButton("üí∞ –ü—Ä–æ–¥–∞—Ç—å", callback_data=f"sellbiz_{business_id}_{owner_id_from_data}")
        ],
        [InlineKeyboardButton("üë• –ù–∞–Ω—è—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤", callback_data=f"hire_{business_id}_{owner_id_from_data}")],
        [InlineKeyboardButton("üíµ –°–æ–±—Ä–∞—Ç—å –ø—Ä–∏–±—ã–ª—å", callback_data=f"collectprofit_{business_id}_{owner_id_from_data}")],
        [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="back_to_bmenu")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)

    await query.edit_message_text(text, parse_mode="HTML", reply_markup=reply_markup)


async def back_to_bmenu_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    await bmenu(query, context)


def generate_unique_business_id():
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    def id_exists(business_id):
        cursor.execute("SELECT 1 FROM businesses_XUI WHERE business_id = ?", (business_id,))
        return cursor.fetchone() is not None

    attempts = 0
    max_attempts_3 = 1000

    while attempts < max_attempts_3:
        business_id = f"{random.randint(0, 999):03d}"
        if not id_exists(business_id):
            conn.close()
            return business_id
        attempts += 1

    while True:
        business_id = f"{random.randint(0, 9999):04d}"
        if not id_exists(business_id):
            conn.close()
            return business_id


def add_new_business(user_id, business_type, business_level=1):
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    business_id = generate_unique_business_id()

    cursor.execute(
        "SELECT COUNT(*) FROM businesses_XUI WHERE owner_id = ? AND business_type = ?",
        (user_id, business_type)
    )
    count = cursor.fetchone()[0]
    business_name = f"{business_type} #{count + 1}"

    cursor.execute(
        "INSERT INTO businesses_XUI (business_id, owner_id, business_type, name, level) VALUES (?, ?, ?, ?, ?)",
        (business_id, user_id, business_type, business_name, business_level)
    )
    conn.commit()
    conn.close()


def format_rubles(num):
    # –ü—Ä–∏–º–µ—Ä —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å –ø—Ä–æ–±–µ–ª–∞–º–∏ (–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è locale)
    return locale.format_string("%d", num, grouping=True)


def load_items():
    items = [
        {"name": "–õ–∞—Ä—ë–∫", "price": 10000},
        {"name": "–†–µ—Å—Ç–∞—Ä–∞–Ω", "price": 30000},
        {"name": "–ú–∞–≥–∞–∑–∏–Ω", "price": 50000},
        {"name": "–ê–≤—Ç–æ—Å–∞–ª–æ–Ω", "price": 500000},
        {"name": "–†–µ–∫–ª–∞–º–Ω–æ–µ –∞–≥–µ–Ω—Ç—Å—Ç–≤–æ", "price": 1000000},
        {"name": "–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–æ—á–Ω–æ-–°—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω–∞—è –∫–æ–º–ø–∞–Ω–∏—è", "price": 10000000},
        {"name": "–≠–Ω–µ—Ä–≥–æ–ù–µ—Ñ—Ç—å –•–æ–ª–¥–∏–Ω–≥", "price": 15000000},
        {"name": "–ú–µ–¥–∏–∞–§–∏–Ω –•–æ–ª–¥–∏–Ω", "price": 20000000},
    ]
    items = [item for item in items if item["name"] not in ("–ö–∞–∑–∏–Ω–æ", "–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –ë–∞–Ω–∫")]
    return items

business_profits = {
    "–õ–∞—Ä—ë–∫": {
        1: 500, 2: 1000, 3: 1500, 4: 2000, 5: 2500,
        6: 3000, 7: 3500, 8: 4000, 9: 4500, 10: 5000,
        11: 5500, 12: 6000, 13: 6500, 14: 7000, 15: 7500, 16: 8000,
        17: 8500, 18: 9000, 19: 9500, 20: 10000
    },
    "–†–µ—Å—Ç–∞—Ä–∞–Ω": {
        1: 3000, 2: 5000, 3: 7000, 4: 9000, 5: 11000,
        6: 13000, 7: 15000, 8: 17000, 9: 19000
    },
    "–ú–∞–≥–∞–∑–∏–Ω": {
        1: 5000, 2: 7500, 3: 10000, 4: 12500, 5: 15000,
        6: 17500, 7: 20000, 8: 22500, 9: 25000
    },
    "–ê–≤—Ç–æ—Å–∞–ª–æ–Ω": {
        1: 15000, 2: 25000, 3: 35000, 4: 45000, 5: 55000,
        6: 65000, 7: 75000, 8: 85000, 9: 100000, 10: 115000
    },
    "–†–µ–∫–ª–∞–º–Ω–æ–µ –∞–≥–µ–Ω—Ç—Å—Ç–≤–æ": {
        1: 60000, 2: 90000, 3: 120000, 4: 150000, 5: 180000,
        6: 210000, 7: 240000, 8: 270000, 9: 300000
    },
    "–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–æ—á–Ω–æ-–°—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω–∞—è –∫–æ–º–ø–∞–Ω–∏—è": {
        1: 65000, 2: 90000, 3: 115000, 4: 145000, 5: 175000,
        6: 210000, 7: 240000, 8: 265000, 9: 300000, 10: 320000
    },
    "–≠–Ω–µ—Ä–≥–æ–ù–µ—Ñ—Ç—å –•–æ–ª–¥–∏–Ω–≥": {
        1: 150000, 2: 200000, 3: 250000, 4: 300000, 5: 350000,
        6: 400000, 7: 450000, 8: 500000, 9: 550000
    },
    "–ú–µ–¥–∏–∞–§–∏–Ω –•–æ–ª–¥–∏–Ω": {
        1: 600000, 2: 660000, 3: 720000, 4: 780000, 5: 840000,
        6: 900000, 7: 960000, 8: 1020000, 9: 1080000
    },

    #Digital Coins - Donate –ë–∏–∑–Ω–µ—Å—ã
    "–ö–∞–∑–∏–Ω–æ": {
        1: 150000, 2: 300000, 3: 450000, 4: 700000, 5: 1000000,
        6: 1500000, 7: 2000000, 8: 2500000, 9: 3000000
    },
    "–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –ë–∞–Ω–∫": {
        1: 750000, 2: 1250000, 3: 2000000, 4: 3000000, 5: 4000000,
        6: 6000000, 7: 7000000, 8: 9000000, 9: 10000000
    },
}


# --- –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä—É–±–ª–µ–π ---
def format_rubles(num):
    return locale.format_string("%d", num, grouping=True)


# --- –†–∞–±–æ—Ç–∞ —Å –ë–î ---

def get_db_connection():
    conn = sqlite3.connect(DB_PATH)
    conn.row_factory = sqlite3.Row
    return conn


def get_user_balance(user_id: str) -> int:
    conn = get_db_connection()
    cursor = conn.cursor()
    cursor.execute("SELECT balance FROM users WHERE user_id = ?", (user_id,))
    row = cursor.fetchone()
    conn.close()
    return row["balance"] if row else 0


def get_user_business(user_id: str):
    conn = get_db_connection()
    cursor = conn.cursor()
    cursor.execute("SELECT business_id, name, level FROM businesses_XUI WHERE owner_id = ?", (user_id,))
    row = cursor.fetchone()
    conn.close()
    if row:
        return {"business_id": row["business_id"], "name": row["name"], "level": row["level"]}
    return None


def update_user_balance(user_id: str, delta: int):
    conn = get_db_connection()
    cursor = conn.cursor()
    cursor.execute("SELECT balance FROM users WHERE user_id = ?", (user_id,))
    row = cursor.fetchone()
    if not row:
        conn.close()
        raise ValueError("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω")
    new_balance = row["balance"] + delta
    if new_balance < 0:
        conn.close()
        raise ValueError("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤")
    cursor.execute("UPDATE users SET balance = ? WHERE user_id = ?", (new_balance, user_id))
    conn.commit()
    conn.close()
    return new_balance


def set_user_businessX(user_id: str, business_name: str, business_level: int = 1):
    conn = get_db_connection()
    cursor = conn.cursor()
    # –ü—Ä–æ–≤–µ—Ä–∏–º, –µ—Å—Ç—å –ª–∏ –±–∏–∑–Ω–µ—Å —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    cursor.execute("SELECT business_id FROM businesses_XUI WHERE owner_id = ?", (user_id,))
    row = cursor.fetchone()
    if row:
        # –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –±–∏–∑–Ω–µ—Å ‚Äî –≤–æ—Ç —Ç—É—Ç –ø–µ—Ä–µ–∑–∞–ø–∏—Å—å –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç!
        cursor.execute("UPDATE businesses_XUI SET name = ?, level = ? WHERE owner_id = ?",
                       (business_name, business_level, user_id))
    else:
        # –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –±–∏–∑–Ω–µ—Å
        cursor.execute("INSERT INTO businesses_XUI (owner_id, name, level) VALUES (?, ?, ?)",
                       (user_id, business_name, business_level))
    conn.commit()
    conn.close()


BSHOP_PHOTO_URL = "https://i.postimg.cc/0ypQbYT7/image.png"  # –∑–∞–º–µ–Ω–∏ –Ω–∞ —Å–≤–æ—é —Å—Å—ã–ª–∫—É

async def bshop(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.message.from_user
    items = load_items()
    await send_business_page(update.message, context, 0, items, user)


async def send_business_page(target, context: ContextTypes.DEFAULT_TYPE, page: int, items: list, user):
    start = page * ITEMS_PER_PAGE
    page_items = items[start:start + ITEMS_PER_PAGE]
    total_pages = (len(items) - 1) // ITEMS_PER_PAGE + 1

    business_buttons = [
        [InlineKeyboardButton(
            f"üè¢ {item['name']}  ‚Ä¢  {format_rubles(item['price'])} ‚ÇΩ",
            callback_data=f"buybiz_{start + i}"
        )]
        for i, item in enumerate(page_items)
    ]

    nav_buttons = []
    if page > 0:
        nav_buttons.append(InlineKeyboardButton("‚óÄÔ∏è", callback_data=f"bshop_page_{page - 1}"))
    else:
        nav_buttons.append(InlineKeyboardButton(" ", callback_data="ignore"))

    nav_buttons.append(InlineKeyboardButton(f"¬∑ {page + 1} / {total_pages} ¬∑", callback_data="ignore"))

    if page < total_pages - 1:
        nav_buttons.append(InlineKeyboardButton("‚ñ∂Ô∏è", callback_data=f"bshop_page_{page + 1}"))
    else:
        nav_buttons.append(InlineKeyboardButton(" ", callback_data="ignore"))

    keyboard = business_buttons + [nav_buttons]
    reply_markup = InlineKeyboardMarkup(keyboard)

    caption = (
        f"üè¢ <b>–ë–∏–∑–Ω–µ—Å-–ú–∞–≥–∞–∑–∏–Ω</b>\n"
        f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
        f"üë§ {get_display_name_html_new(user)}\n\n"
        f"üíº –ò–Ω–≤–µ—Å—Ç–∏—Ä—É–π—Ç–µ –≤ –±–∏–∑–Ω–µ—Å –∏ –ø–æ–ª—É—á–∞–π—Ç–µ\n"
        f"–ø–∞—Å—Å–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å!\n"
        f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
        f"üì¶ –í—Å–µ–≥–æ –ø–æ–∑–∏—Ü–∏–π: {len(items)}  ‚Ä¢  –°—Ç—Ä. {page + 1}/{total_pages}\n"
        f"üëá <i>–í—ã–±–µ—Ä–∏—Ç–µ –±–∏–∑–Ω–µ—Å:</i>"
    )

    if isinstance(target, Message):
        await target.reply_photo(
            photo=BSHOP_PHOTO_URL,
            caption=caption,
            reply_markup=reply_markup,
            parse_mode="HTML"
        )
    elif isinstance(target, CallbackQuery):
        if target.message.photo:
            await target.edit_message_caption(
                caption,
                reply_markup=reply_markup,
                parse_mode="HTML"
            )
        else:
            await target.message.delete()
            await target.message.chat.send_photo(
                photo=BSHOP_PHOTO_URL,
                caption=caption,
                reply_markup=reply_markup,
                parse_mode="HTML"
            )


async def bshop_page_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    if not query.data.startswith("bshop_page_"):
        return

    try:
        page = int(query.data.split("_")[-1])
    except ValueError:
        return

    items = load_items()
    await send_business_page(query, context, page, items, query.from_user)


VIP_LIMITS_bis = {
    0: 1,  # –ë–µ–∑ VIP
    1: 2,  # VIP SILVER
    2: 5,  # VIP GOLD
    3: 7,  # VIP PLATINUM
    4: 10  # VIP LEGEND
}


def can_buy_business(user_id: int, current_business_count: int) -> bool:
    vip_status = get_user_vip_status(int(user_id))
    limit = VIP_LIMITS_bis.get(vip_status, 1)
    return current_business_count < limit


def get_user_businesses_count(user_id: str) -> int:
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT COUNT(*) FROM businesses_XUI WHERE owner_id = ?", (user_id,))
    count = cursor.fetchone()[0]
    conn.close()
    return count


def get_user_all_businesses(user_id: str) -> list:
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT * FROM businesses_XUI WHERE owner_id = ?", (user_id,))
    rows = cursor.fetchall()
    conn.close()

    businesses = []
    for row in rows:
        businesses.append({
            "id": row[0],
            "business_id": row[1],
            "owner_id": row[2],
            "business_type": row[3],
            "name": row[4],
            "balance": row[5],
            "level": row[6],
            "employees": row[7],
            "products": row[8],
        })
    return businesses

def get_user_balance_businessX(user_id):
    user_data = get_user_from_db_stats(user_id)
    if not user_data:
        return 0
    return int(user_data.get("balance", 0))

async def businessX_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    data = query.data
    user_id = str(query.from_user.id)

    if not data.startswith("buybiz_"):
        return

    index = int(data.split("_")[1])
    items = load_items()

    if index >= len(items):
        keyboard = [[InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="bshop_page_0")]]
        await query.edit_message_text(
            "‚ö†Ô∏è –û—à–∏–±–∫–∞ –≤—ã–±–æ—Ä–∞! –í—ã–±–µ—Ä–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –±–∏–∑–Ω–µ—Å.",
            reply_markup=InlineKeyboardMarkup(keyboard)
        )
        return

    selected_item = items[index]
    price = selected_item["price"]
    keyboard = [[InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="bshop_page_0")]]
    reply_markup = InlineKeyboardMarkup(keyboard)

    # –ü–æ–ª—É—á–∞–µ–º –±–∞–ª–∞–Ω—Å
    try:
        user_balance = get_user_balance_businessX(user_id)
    except Exception:
        await query.edit_message_text("‚ùó –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –±–∞–ª–∞–Ω—Å–∞.", reply_markup=reply_markup)
        return

    display_name = get_display_name_html_new(query.from_user)

    if user_balance < price:
        await query.edit_message_text(
            f"‚ùó {display_name} | –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤.\nüíº –ë–∞–ª–∞–Ω—Å: <b>{format_rubles(user_balance)}‚ÇΩ</b>\nüí∏ –¶–µ–Ω–∞: <b>{format_rubles(price)}‚ÇΩ</b>",
            parse_mode="HTML",
            reply_markup=reply_markup
        )
        return

    # –ü–æ–ª—É—á–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–∏–∑–Ω–µ—Å–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    current_business_count = get_user_businesses_count(user_id)

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–æ–∫—É–ø–∫–∏ —Å —É—á–µ—Ç–æ–º VIP-—Å—Ç–∞—Ç—É—Å–∞
    if not can_buy_business(user_id, current_business_count):
        await query.edit_message_text(
            f"‚ùó {display_name} | –í—ã –¥–æ—Å—Ç–∏–≥–ª–∏ –ª–∏–º–∏—Ç –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –±–∏–∑–Ω–µ—Å–æ–≤ –¥–ª—è –≤–∞—à–µ–≥–æ VIP-—Å—Ç–∞—Ç—É—Å–∞.\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ–ø—É—Å—Ç–∏–º—ã–µ –ª–∏–º–∏—Ç—ã. /–ª–∏–º–∏—Ç",
            parse_mode="HTML",
            reply_markup=reply_markup
        )
        return

    try:
        new_balance = update_user_balance(user_id, -price)
    except ValueError as e:
        await query.edit_message_text(f"‚ùó –û—à–∏–±–∫–∞: {str(e)}", reply_markup=reply_markup)
        return

    add_new_business(user_id, selected_item["name"], business_level=1)

    # –ü–æ–ª—É—á–∞–µ–º –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –≥–∏–ø–µ—Ä—Å—Å—ã–ª–∫–æ–π
    display_name = get_display_name_html_new(query.from_user)

    await query.edit_message_text(
        text=(
            f"‚úÖ <b>–ü–æ–∫—É–ø–∫–∞ –±–∏–∑–Ω–µ—Å–∞!</b>\n\n"
            f"üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {display_name}\n"
            f"üè∑ –ù–∞–∑–≤–∞–Ω–∏–µ: <b>{html.escape(selected_item['name'])}</b>\n"
            f"üíµ –¶–µ–Ω–∞: <b>{format_rubles(price)}‚ÇΩ</b>\n\n"
            f"üìà –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º —Å –ø—Ä–∏–æ–±—Ä–µ—Ç–µ–Ω–∏–µ–º! –ë–∏–∑–Ω–µ—Å —Ç–µ–ø–µ—Ä—å –≤ –≤–∞—à–µ–º –≤–ª–∞–¥–µ–Ω–∏–∏.\n"
            f"üí∞ –ë–∞–ª–∞–Ω—Å: <b>{format_rubles(new_balance)}‚ÇΩ</b>"
        ),
        parse_mode="HTML",
        reply_markup=reply_markup
    )


VIP_LIMITS_BIS_cmd = {
    0: 1,  # –ë–µ–∑ VIP
    1: 2,  # VIP SILVER
    2: 5,  # VIP GOLD
    3: 7,  # VIP PLATINUM
    4: 10  # VIP LEGEND
}


def get_transfer_limit_cmd(vip_status: int) -> int:
    limits = {
        0: 10_000,
        1: 25_000,
        2: 50_000,
        3: 75_000,
        4: 100_000,
    }
    return limits.get(vip_status, 10_000)


async def limit_list_vip_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    user_id = user.id
    vip_level = get_user_vip_status(user_id)
    vip_names = ["–ë–µ–∑ VIP", "VIP SILVER", "VIP GOLD", "VIP PLATINUM", "VIP LEGEND"]
    vip_name = vip_names[vip_level] if vip_level < len(vip_names) else "Unknown"
    display_name = get_display_name_html_new(user)

    keyboard = [
        [InlineKeyboardButton("üè¢ –ë–∏–∑–Ω–µ—Å", callback_data=f"limit_vip_bis_{user_id}")],
        [InlineKeyboardButton("üí∏ –ü–µ—Ä–µ–¥–∞—á–∞ –¥–µ–Ω–µ–≥", callback_data=f"limit_vip_transfer_{user_id}")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)

    text = (
        f"üìä | {display_name} | –õ–∏–º–∏—Ç—ã\n\n"
        f"üîπ –°—Ç–∞—Ç—É—Å: <b>{vip_name}</b>\n\n"
        "üìÇ –í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é:"
    )
    await update.message.reply_text(text, parse_mode="HTML", reply_markup=reply_markup)


async def limit_vip_bis_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    user = query.from_user
    user_id = user.id
    data = query.data

    parts = data.split("_")
    if len(parts) != 4 or int(parts[3]) != user_id:
        await query.answer("‚ùó –≠—Ç–æ –Ω–µ –≤–∞—à–µ –º–µ–Ω—é.", show_alert=True)
        return
    await query.answer()

    vip_level = get_user_vip_status(user_id)
    vip_names = ["–ë–µ–∑ VIP", "VIP SILVER", "VIP GOLD", "VIP PLATINUM", "VIP LEGEND"]
    vip_name = vip_names[vip_level] if vip_level < len(vip_names) else "Unknown"
    display_name = get_display_name_html_new(user)

    limit = VIP_LIMITS_BIS_cmd.get(vip_level, 1)

    keyboard = [[InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data=f"limit_list_vip_back_{user_id}")]]
    reply_markup = InlineKeyboardMarkup(keyboard)

    text = (
        f"üìä | {display_name} | –õ–∏–º–∏—Ç—ã\n\n"
        f"üîπ –°—Ç–∞—Ç—É—Å: <b>{vip_name}</b>\n\n"
        f"üè¢ –í—ã –º–æ–∂–µ—Ç–µ –∫—É–ø–∏—Ç—å —Å–ª–µ–¥—É—é—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–∏–∑–Ω–µ—Å–æ–≤:\n"
        f"‚ûñ –ö–æ–ª-–≤–æ: <b>{limit}</b>"
    )

    await query.edit_message_text(text, parse_mode="HTML", reply_markup=reply_markup)


async def limit_vip_transfer_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    user = query.from_user
    user_id = user.id
    data = query.data

    parts = data.split("_")
    if len(parts) != 4 or int(parts[3]) != user_id:
        await query.answer("‚ùó –≠—Ç–æ –Ω–µ –≤–∞—à–µ –º–µ–Ω—é.", show_alert=True)
        return
    await query.answer()

    vip_level = get_user_vip_status(user_id)
    vip_names = ["–ë–µ–∑ VIP", "VIP SILVER", "VIP GOLD", "VIP PLATINUM", "VIP LEGEND"]
    vip_name = vip_names[vip_level] if vip_level < len(vip_names) else "Unknown"
    display_name = get_display_name_html_new(user)

    limit = get_transfer_limit_cmd(vip_level)

    keyboard = [[InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data=f"limit_list_vip_back_{user_id}")]]
    reply_markup = InlineKeyboardMarkup(keyboard)

    text = (
        f"üìä | {display_name} | –õ–∏–º–∏—Ç—ã\n\n"
        f"üîπ –°—Ç–∞—Ç—É—Å: <b>{vip_name}</b>\n\n"
        f"üí∏ –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –ø–µ—Ä–µ–¥–∞—á–∏ –¥–µ–Ω–µ–≥ –∑–∞ –æ–¥–Ω—É –æ–ø–µ—Ä–∞—Ü–∏—é:\n"
        f"‚ûñ <b>{format_rubles(limit)}‚ÇΩ</b>"
    )

    await query.edit_message_text(text, parse_mode="HTML", reply_markup=reply_markup)


async def limit_list_vip_back_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    user = query.from_user
    user_id = user.id
    data = query.data

    parts = data.split("_")
    if len(parts) != 5 or int(parts[4]) != user_id:
        await query.answer("‚ùó –≠—Ç–æ –Ω–µ –≤–∞—à–µ –º–µ–Ω—é.", show_alert=True)
        return
    await query.answer()

    vip_level = get_user_vip_status(user_id)
    vip_names = ["–ë–µ–∑ VIP", "VIP SILVER", "VIP GOLD", "VIP PLATINUM", "VIP LEGEND"]
    vip_name = vip_names[vip_level] if vip_level < len(vip_names) else "Unknown"
    display_name = get_display_name_html_new(user)

    keyboard = [
        [InlineKeyboardButton("üè¢ –ë–∏–∑–Ω–µ—Å", callback_data=f"limit_vip_bis_{user_id}")],
        [InlineKeyboardButton("üí∏ –ü–µ—Ä–µ–¥–∞—á–∞ –¥–µ–Ω–µ–≥", callback_data=f"limit_vip_transfer_{user_id}")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)

    text = (
        f"üìä | {display_name} | –õ–∏–º–∏—Ç—ã\n\n"
        f"üîπ –°—Ç–∞—Ç—É—Å: <b>{vip_name}</b>\n\n"
        "üìÇ –í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é:"
    )

    await query.edit_message_text(text, parse_mode="HTML", reply_markup=reply_markup)


def add_user_balance_business_withdraw(user_id: int, amount: int):
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    cursor.execute("SELECT balance FROM users WHERE user_id=?", (str(user_id),))
    row = cursor.fetchone()
    if row:
        new_balance = int(row[0] or 0) + amount
        cursor.execute("UPDATE users SET balance=? WHERE user_id=?", (new_balance, str(user_id)))
    else:
        cursor.execute("INSERT INTO users (user_id, balance) VALUES (?, ?)", (str(user_id), amount))

    conn.commit()
    conn.close()


def format_money_withdraw(amount: int) -> str:
    return f"{amount:,}".replace(",", ".") + "‚ÇΩ"


async def business_withdraw(update: Update, context: ContextTypes.DEFAULT_TYPE):
    message_text = update.message.text
    parts = message_text.split()

    if len(parts) != 4:
        await update.message.reply_text("‚ùó –§–æ—Ä–º–∞—Ç –∫–æ–º–∞–Ω–¥—ã: –±–∏–∑–Ω–µ—Å —Å–Ω—è—Ç—å {id} {—Å—É–º–º–∞}")
        return

    biz_id = parts[2]
    try:
        amount = int(parts[3])
        if amount <= 0:
            raise ValueError
    except ValueError:
        await update.message.reply_text("‚ùó –°—É–º–º–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º.")
        return

    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    cursor.execute("SELECT balance, owner_id FROM businesses_XUI WHERE business_id=?", (biz_id,))
    row = cursor.fetchone()
    if not row:
        await update.message.reply_text(f"‚ùå –ë–∏–∑–Ω–µ—Å —Å ID {biz_id} –Ω–µ –Ω–∞–π–¥–µ–Ω.")
        conn.close()
        return

    balance, owner_id = row
    balance = int(balance)

    if update.message.from_user.id != owner_id:
        await update.message.reply_text("‚ùå –¢–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü –±–∏–∑–Ω–µ—Å–∞ –º–æ–∂–µ—Ç —Å–Ω–∏–º–∞—Ç—å –¥–µ–Ω—å–≥–∏.")
        conn.close()
        return

    if amount > balance:
        await update.message.reply_text(
            f"‚ùå –ù–∞ –±–∞–ª–∞–Ω—Å–µ –±–∏–∑–Ω–µ—Å–∞ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤. –ë–∞–ª–∞–Ω—Å: {format_money_withdraw(balance)}")
        conn.close()
        return

    # –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å –±–∏–∑–Ω–µ—Å–∞
    new_balance = balance - amount
    cursor.execute("UPDATE businesses_XUI SET balance=? WHERE business_id=?", (str(new_balance), biz_id))
    conn.commit()
    conn.close()

    # –ó–∞—á–∏—Å–ª—è–µ–º –≤–ª–∞–¥–µ–ª—å—Ü—É
    add_user_balance_business_withdraw(owner_id, amount)

    await update.message.reply_text(
        f"‚úÖ –í—ã —É—Å–ø–µ—à–Ω–æ —Å–Ω—è–ª–∏ {format_money_withdraw(amount)} —Å –±–∏–∑–Ω–µ—Å–∞ üíº\n"
        f"üí∞ –ù–æ–≤—ã–π –±–∞–ª–∞–Ω—Å –±–∏–∑–Ω–µ—Å–∞: {format_money_withdraw(new_balance)}\n"
        f"üë§ –î–µ–Ω—å–≥–∏ –∑–∞—á–∏—Å–ª–µ–Ω—ã –Ω–∞ –≤–∞—à –ª–∏—á–Ω—ã–π –±–∞–ª–∞–Ω—Å."
    )


def get_business_value(level, business_type):
    items = load_items()
    for item in items:
        if item["name"] == business_type:
            base_price = item["price"]
            return base_price * level
    return 10000 * level

async def update_businesses():
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    try:
        cursor.execute("PRAGMA table_info(businesses_XUI)")
        columns = [col[1] for col in cursor.fetchall()]
        if "hours_without_products" not in columns:
            cursor.execute("ALTER TABLE businesses_XUI ADD COLUMN hours_without_products INTEGER NOT NULL DEFAULT 0")
            conn.commit()
            print("–ö–æ–ª–æ–Ω–∫–∞ hours_without_products –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ —Ç–∞–±–ª–∏—Ü—É businesses_XUI")

        cursor.execute("""
            SELECT business_id, owner_id, business_type, level, products, hours_without_products, balance, employees
            FROM businesses_XUI
        """)
        businesses = cursor.fetchall()

        for biz in businesses:
            business_id, owner_id, business_type, level, products, hours_without_products, balance, employees = biz

            if owner_id is None or owner_id == 0:
                print(f"–ë–∏–∑–Ω–µ—Å ID {business_id} –±–µ–∑ –≤–ª–∞–¥–µ–ª—å—Ü–∞ ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º")
                continue

            products = int(products or 0)
            hours_without_products = int(hours_without_products or 0)
            balance = int(balance or 0)
            employees = int(employees or 0)

            if employees > 0:
                profit = business_profits.get(business_type, {}).get(level, 0)
                if profit > 0:
                    new_balance = balance + profit
                    cursor.execute(
                        "UPDATE businesses_XUI SET balance = ? WHERE business_id = ?",
                        (str(new_balance), business_id)
                    )
            else:
                print(f"–ë–∏–∑–Ω–µ—Å ID {business_id}: —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ 0, –ø—Ä–∏–±—ã–ª—å –Ω–µ –Ω–∞—á–∏—Å–ª—è–µ—Ç—Å—è")

            to_remove = min(5, products)
            new_products = products - to_remove
            cursor.execute(
                "UPDATE businesses_XUI SET products = ? WHERE business_id = ?",
                (new_products, business_id)
            )

            if business_type.lower() not in ("–∫–∞–∑–∏–Ω–æ", "—Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –±–∞–Ω–∫"):
                if new_products == 0:
                    hours_without_products += 1
                    cursor.execute(
                        "UPDATE businesses_XUI SET hours_without_products = ? WHERE business_id = ?",
                        (hours_without_products, business_id)
                    )
                else:
                    if hours_without_products != 0:
                        cursor.execute(
                            "UPDATE businesses_XUI SET hours_without_products = 0 WHERE business_id = ?",
                            (business_id,)
                        )

                if hours_without_products >= 3:
                    business_value = get_business_value(level, business_type)
                    sale_price = business_value // 2

                    cursor.execute("SELECT balance FROM users WHERE user_id = ?", (str(owner_id),))
                    user = cursor.fetchone()
                    if user:
                        user_balance = int(user[0] or 0)
                        new_user_balance = user_balance + sale_price
                        cursor.execute(
                            "UPDATE users SET balance = ? WHERE user_id = ?",
                            (new_user_balance, str(owner_id))
                        )
                        print(f"–ë–∏–∑–Ω–µ—Å ID {business_id}: –ø—Ä–æ–¥–∞–Ω –∑–∞ {sale_price}, –±–∞–ª–∞–Ω—Å –≤–ª–∞–¥–µ–ª—å—Ü–∞ {new_user_balance}")

                    cursor.execute("DELETE FROM businesses_XUI WHERE business_id = ?", (business_id,))
                    print(f"–ë–∏–∑–Ω–µ—Å ID {business_id} —É–¥–∞–ª—ë–Ω –∏–∑ –±–∞–∑—ã –ø–æ—Å–ª–µ –ø—Ä–æ–¥–∞–∂–∏")
            else:
                print(f"–ë–∏–∑–Ω–µ—Å ID {business_id} ‚Äî –ö–∞–∑–∏–Ω–æ/–¶–ë, —á–∞—Å—ã –±–µ–∑ —Ç–æ–≤–∞—Ä–æ–≤ –Ω–µ —É—á–∏—Ç—ã–≤–∞—é—Ç—Å—è")

        conn.commit()
        print("–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∏–∑–Ω–µ—Å–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–æ")

    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –±–∏–∑–Ω–µ—Å–æ–≤: {e}")
    finally:
        conn.close()

async def handle_business_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    message_text = update.message.text
    message_text_lower = message_text.lower()

    # –ö–æ–º–∞–Ω–¥–∞ –±–µ–∑ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ ‚Äî –æ—Ç–∫—Ä—ã—Ç—å –º–µ–Ω—é –±–∏–∑–Ω–µ—Å–∞
    if message_text_lower == "–±–∏–∑–Ω–µ—Å" or message_text_lower == "bmenu":
        await bmenu(update, context)
        return

    if message_text_lower.startswith("–±–∏–∑–Ω–µ—Å –Ω–∞–∑–≤–∞–Ω–∏–µ "):
        parts = message_text.split(maxsplit=3)
        if len(parts) < 4:
            await update.message.reply_text("‚ùó –§–æ—Ä–º–∞—Ç –∫–æ–º–∞–Ω–¥—ã: –±–∏–∑–Ω–µ—Å –Ω–∞–∑–≤–∞–Ω–∏–µ {id –±–∏–∑–Ω–µ—Å–∞} {–Ω–∞–∑–≤–∞–Ω–∏–µ}")
            return
        biz_id = parts[2]
        new_name = parts[3]
        context.args = [biz_id, new_name]
        await bsetname_command(update, context)
        return

    # –ö–æ–º–∞–Ω–¥–∞: –±–∏–∑–Ω–µ—Å –º–∞–≥–∞–∑ / –º–∞–≥–∞–∑–∏–Ω / –∫—É–ø–∏—Ç—å ‚Äî –æ—Ç–∫—Ä—ã—Ç—å –º–∞–≥–∞–∑–∏–Ω
    if message_text_lower in ("–±–∏–∑–Ω–µ—Å –º–∞–≥–∞–∑", "–±–∏–∑–Ω–µ—Å –º–∞–≥–∞–∑–∏–Ω", "–±–∏–∑–Ω–µ—Å –∫—É–ø–∏—Ç—å", "bshop"):
        await bshop(update, context)
        return

    if message_text_lower.startswith("–±–∏–∑–Ω–µ—Å —Å–Ω—è—Ç—å "):
        await business_withdraw(update, context)
        return

    if message_text_lower.startswith("–±–∏–∑–Ω–µ—Å —Ç–æ–≤–∞—Ä—ã "):
        parts = message_text.split()
        if len(parts) != 4:
            await update.message.reply_text("‚ùó –§–æ—Ä–º–∞—Ç –∫–æ–º–∞–Ω–¥—ã: –±–∏–∑–Ω–µ—Å —Ç–æ–≤–∞—Ä—ã {id –±–∏–∑–Ω–µ—Å–∞} {–∫–æ–ª-–≤–æ}")
            return
        biz_id = parts[2]
        try:
            count = int(parts[3])
        except ValueError:
            await update.message.reply_text("‚ùó –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —á–∏—Å–ª–æ–º.")
            return

        context.args = ["—Ç–æ–≤–∞—Ä—ã", biz_id, str(count)]
        await bproduct_command(update, context)
        return

    # –ï—Å–ª–∏ –Ω–∏ –æ–¥–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ –Ω–µ –ø–æ–¥–æ—à–ª–∞
    await update.message.reply_text(
        "‚ùó <b>–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞ –±–∏–∑–Ω–µ—Å–∞.</b>\n\n"
        "‚ÑπÔ∏è <b>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ:</b>\n"
        "‚Ä¢ üíº <code>–±–∏–∑–Ω–µ—Å</code> ‚Äî <b>–º–µ–Ω—é –±–∏–∑–Ω–µ—Å–∞</b>\n"
        "‚Ä¢ üè∑Ô∏è <code>–±–∏–∑–Ω–µ—Å –Ω–∞–∑–≤–∞–Ω–∏–µ &lt;id&gt; &lt;–Ω–∞–∑–≤–∞–Ω–∏–µ&gt;</code> ‚Äî <b>–∏–∑–º–µ–Ω–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ</b>\n"
        "‚Ä¢ üõí <code>–±–∏–∑–Ω–µ—Å –º–∞–≥–∞–∑</code> ‚Äî <b>–º–∞–≥–∞–∑–∏–Ω –±–∏–∑–Ω–µ—Å–∞</b>\n"
        "‚Ä¢ üì¶ <code>–±–∏–∑–Ω–µ—Å —Ç–æ–≤–∞—Ä—ã &lt;id&gt; &lt;–∫–æ–ª-–≤–æ&gt;</code> ‚Äî <b>–∫—É–ø–∏—Ç—å —Ç–æ–≤–∞—Ä—ã</b>",
        parse_mode="HTML"
    )


def migrate_add_ref_count():
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    # –ü—Ä–æ–≤–µ—Ä–∏–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ —Å—Ç–æ–ª–±–µ—Ü ref_count
    cursor.execute("PRAGMA table_info(users)")
    columns = [col[1] for col in cursor.fetchall()]
    if "ref_count" not in columns:
        cursor.execute("ALTER TABLE users ADD COLUMN ref_count INTEGER DEFAULT 0")
        print("[–ú–∏–≥—Ä–∞—Ü–∏—è] –°—Ç–æ–ª–±–µ—Ü ref_count –¥–æ–±–∞–≤–ª–µ–Ω.")
    else:
        print("[–ú–∏–≥—Ä–∞—Ü–∏—è] –°—Ç–æ–ª–±–µ—Ü ref_count —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.")

    conn.commit()
    conn.close()


def migrate_database():
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    # === USERS ===
    cursor.execute("""
    CREATE TABLE IF NOT EXISTS users (
        user_id TEXT PRIMARY KEY,
        username TEXT,
        first_name TEXT DEFAULT '',
        nickname TEXT DEFAULT NULL,
        status INTEGER DEFAULT 0,
        balance INTEGER DEFAULT 0,
        seeds INTEGER DEFAULT 0,
        property TEXT DEFAULT '',
        exp INTEGER DEFAULT 0,
        level INTEGER DEFAULT 1,
        bonus_given INTEGER DEFAULT 0,
        inventory_car TEXT DEFAULT NULL,
        inventory_phone TEXT DEFAULT NULL,
        inventory_yacht TEXT DEFAULT NULL,
        inventory_business TEXT DEFAULT NULL,
        inventory_home TEXT DEFAULT NULL,
        inventory_pet TEXT DEFAULT NULL,
        clicks INTEGER DEFAULT 0,
        last_farm INTEGER DEFAULT 0,
        crypto_wallet INTEGER DEFAULT 0,
        dc_balance INTEGER DEFAULT 0
    )
    """)
    users_additions = {
        "ref_count": "INTEGER DEFAULT 0",
        "vip_until": "INTEGER DEFAULT 0",
        "vip_status": "INTEGER DEFAULT 0",
        "married_to": "TEXT DEFAULT NULL",
        "last_robbing": "INTEGER DEFAULT 0"
    }
    cursor.execute("PRAGMA table_info(users)")
    existing_users_cols = [col[1] for col in cursor.fetchall()]
    for col, col_type in users_additions.items():
        if col not in existing_users_cols:
            cursor.execute(f"ALTER TABLE users ADD COLUMN {col} {col_type}")
            print(f"[users] –î–æ–±–∞–≤–ª–µ–Ω —Å—Ç–æ–ª–±–µ—Ü {col}")

    # === ROBBERY_DATA ===
    cursor.execute("""
    CREATE TABLE IF NOT EXISTS robbery_data (
        user_id TEXT PRIMARY KEY,
        total_stolen INTEGER DEFAULT 0,
        last_robbery TIMESTAMP,
        total_attempts INTEGER DEFAULT 0,
        success_attempts INTEGER DEFAULT 0,
        failed_attempts INTEGER DEFAULT 0,
        immunity_active INTEGER DEFAULT 0,
        immunity_end TIMESTAMP,
        last_robberies_json TEXT DEFAULT '[]'
    )
    """)
    robbery_additions = {
        "total_stolen": "INTEGER DEFAULT 0",
        "last_robbery": "TIMESTAMP",
        "total_attempts": "INTEGER DEFAULT 0",
        "success_attempts": "INTEGER DEFAULT 0",
        "failed_attempts": "INTEGER DEFAULT 0",
        "immunity_active": "INTEGER DEFAULT 0",
        "immunity_end": "TIMESTAMP",
        "last_robberies_json": "TEXT DEFAULT '[]'",
        "robbery_sustem_cooldown": "INTEGER DEFAULT 0"
    }
    cursor.execute("PRAGMA table_info(robbery_data)")
    existing_robbery_cols = [col[1] for col in cursor.fetchall()]
    for col, col_type in robbery_additions.items():
        if col not in existing_robbery_cols:
            cursor.execute(f"ALTER TABLE robbery_data ADD COLUMN {col} {col_type}")
            print(f"[robbery_data] –î–æ–±–∞–≤–ª–µ–Ω —Å—Ç–æ–ª–±–µ—Ü {col}")

    # === BUSINESSES_XUI ===
    cursor.execute("""
    CREATE TABLE IF NOT EXISTS businesses_XUI (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        business_id TEXT UNIQUE NOT NULL,
        owner_id INTEGER NOT NULL,
        business_type TEXT NOT NULL,
        name TEXT NOT NULL,
        balance TEXT NOT NULL DEFAULT '0',
        level INTEGER NOT NULL DEFAULT 1,
        employees INTEGER NOT NULL DEFAULT 0,
        products TEXT DEFAULT NULL,
        hours_without_products INTEGER NOT NULL DEFAULT 0
    )
    """)
    businesses_additions = {
        "balance": "TEXT NOT NULL DEFAULT '0'",
        "level": "INTEGER NOT NULL DEFAULT 1",
        "employees": "INTEGER NOT NULL DEFAULT 0",
        "products": "TEXT DEFAULT NULL"
    }
    cursor.execute("PRAGMA table_info(businesses_XUI)")
    existing_business_cols = [col[1] for col in cursor.fetchall()]
    for col, col_type in businesses_additions.items():
        if col not in existing_business_cols:
            cursor.execute(f"ALTER TABLE businesses_XUI ADD COLUMN {col} {col_type}")
            print(f"[businesses_XUI] –î–æ–±–∞–≤–ª–µ–Ω —Å—Ç–æ–ª–±–µ—Ü {col}")

    # === BANS ===
    cursor.execute("""
    CREATE TABLE IF NOT EXISTS bans (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        banned_user_id TEXT NOT NULL,
        banned_by_user_id TEXT NOT NULL,
        reason TEXT,
        duration INTEGER NOT NULL,
        timestamp_start INTEGER NOT NULL,
        timestamp_end INTEGER NOT NULL,
        chat_id TEXT
    )
    """)
    cursor.execute("PRAGMA table_info(bans)")
    if "chat_id" not in [col[1] for col in cursor.fetchall()]:
        cursor.execute("ALTER TABLE bans ADD COLUMN chat_id TEXT")
        print("[bans] –î–æ–±–∞–≤–ª–µ–Ω —Å—Ç–æ–ª–±–µ—Ü chat_id")

    # === DEPARTAMENT ===
    cursor.execute("""
    CREATE TABLE IF NOT EXISTS departament (
        user_id TEXT PRIMARY KEY,
        department_name TEXT NOT NULL,
        role INTEGER NOT NULL,
        warnings INTEGER DEFAULT 0,
        join_date TEXT NOT NULL
    )
    """)
    cursor.execute("PRAGMA table_info(departament)")
    if "extra_info" not in [col[1] for col in cursor.fetchall()]:
        cursor.execute("ALTER TABLE departament ADD COLUMN extra_info TEXT")
        print("[departament] –î–æ–±–∞–≤–ª–µ–Ω —Å—Ç–æ–ª–±–µ—Ü extra_info")

    # === DEPARTMENT_WARNS ===
    cursor.execute("""
    CREATE TABLE IF NOT EXISTS department_warns (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        user_id TEXT NOT NULL,
        issuer_id TEXT NOT NULL,
        issuer_role TEXT NOT NULL,
        reason TEXT NOT NULL,
        timestamp TEXT NOT NULL
    )
    """)

    # === ADMINS ===
    cursor.execute("""
    CREATE TABLE IF NOT EXISTS admins (
        user_id TEXT PRIMARY KEY,
        points INTEGER DEFAULT 0,
        warnings INTEGER DEFAULT 0
    )
    """)

    # === BANK_NEW ===
    cursor.execute("""
    CREATE TABLE IF NOT EXISTS Bank_New (
        user_id INTEGER PRIMARY KEY,
        first_name TEXT,
        account_name TEXT,
        account_number TEXT UNIQUE,
        balance TEXT DEFAULT '0',
        created_at TEXT
    )
    """)

    # === KIDS ===
    cursor.execute("""
    CREATE TABLE IF NOT EXISTS kids (
        kid_id INTEGER PRIMARY KEY AUTOINCREMENT,
        name TEXT NOT NULL,
        gender TEXT CHECK(gender IN ('–º', '–∂')) NOT NULL,
        birthday INTEGER NOT NULL,
        parent1_id TEXT NOT NULL,
        parent2_id TEXT NOT NULL
    )
    """)
    kids_additions = {
        "hunger": "INTEGER DEFAULT 100",
        "happiness": "INTEGER DEFAULT 100",
        "last_fed": "INTEGER DEFAULT 0",
        "last_played": "INTEGER DEFAULT 0",
        "food": "INTEGER DEFAULT 0",
        "last_updated": "INTEGER DEFAULT 0",
        "age": "INTEGER DEFAULT 0"
    }
    cursor.execute("PRAGMA table_info(kids)")
    existing_kids_cols = [col[1] for col in cursor.fetchall()]
    for col, col_type in kids_additions.items():
        if col not in existing_kids_cols:
            cursor.execute(f"ALTER TABLE kids ADD COLUMN {col} {col_type}")
            print(f"[kids] –î–æ–±–∞–≤–ª–µ–Ω —Å—Ç–æ–ª–±–µ—Ü {col}")

    # === MARRIAGES ===
    cursor.execute("""
    CREATE TABLE IF NOT EXISTS marriages (
        user_id1 TEXT NOT NULL,
        user_id2 TEXT NOT NULL,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        condom INTEGER DEFAULT 0,
        PRIMARY KEY (user_id1, user_id2),
        FOREIGN KEY(user_id1) REFERENCES users(user_id),
        FOREIGN KEY(user_id2) REFERENCES users(user_id)
    )
    """)
    cursor.execute("PRAGMA table_info(marriages)")
    if "condom" not in [col[1] for col in cursor.fetchall()]:
        cursor.execute("ALTER TABLE marriages ADD COLUMN condom INTEGER DEFAULT 0")
        print("[marriages] –î–æ–±–∞–≤–ª–µ–Ω —Å—Ç–æ–ª–±–µ—Ü condom")

    # === CHATS_ADMINS ===
    cursor.execute("""
    CREATE TABLE IF NOT EXISTS chats_admins (
        chat_id TEXT PRIMARY KEY,
        chat_title TEXT DEFAULT '',
        created_at TEXT DEFAULT CURRENT_TIMESTAMP
    )
    """)

    # === CHAT_ADMINS ===
    cursor.execute("""
    CREATE TABLE IF NOT EXISTS chat_admins (
        chat_id TEXT NOT NULL,
        user_id TEXT NOT NULL,
        username TEXT,
        name TEXT,
        updated_at TEXT,
        admin_level INTEGER DEFAULT 0,
        added_at TEXT DEFAULT CURRENT_TIMESTAMP,
        PRIMARY KEY (chat_id, user_id),
        FOREIGN KEY (chat_id) REFERENCES chats_admins(chat_id) ON DELETE CASCADE
    )
    """)

    # === CHAT_SETTINGS ===
    cursor.execute("""
    CREATE TABLE IF NOT EXISTS chat_settings (
        chat_id TEXT PRIMARY KEY,
        mute_level INTEGER DEFAULT 7,
        kick_level INTEGER DEFAULT 7,
        ban_level INTEGER DEFAULT 7,
        pin_level INTEGER DEFAULT 7,
        unmute_level INTEGER DEFAULT 7,
        role_change INTEGER DEFAULT 7,
        change_settings INTEGER DEFAULT 7,
        created_at TEXT DEFAULT CURRENT_TIMESTAMP,
        updated_at TEXT DEFAULT CURRENT_TIMESTAMP
    )
    """)
    cursor.execute("PRAGMA table_info(chat_settings)")
    existing_chat_settings_cols = [col[1] for col in cursor.fetchall()]
    if "change_settings" not in existing_chat_settings_cols:
        cursor.execute("ALTER TABLE chat_settings ADD COLUMN change_settings INTEGER DEFAULT 7")
        print("[chat_settings] –î–æ–±–∞–≤–ª–µ–Ω —Å—Ç–æ–ª–±–µ—Ü change_settings")
    if "antispam" not in existing_chat_settings_cols:
        cursor.execute("ALTER TABLE chat_settings ADD COLUMN antispam INTEGER DEFAULT 1")
        print("[chat_settings] –î–æ–±–∞–≤–ª–µ–Ω —Å—Ç–æ–ª–±–µ—Ü antispam")

    conn.commit()
    conn.close()
    print("‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∑–∞–≤–µ—Ä—à–µ–Ω–∞.")


# --- –°–ª–æ–≤–∞—Ä–∏ –æ–±–æ–ª–æ—á–µ–∫ –∏ –≤–µ—Ä—Å–∏–π Android ---
PHONE_OS_MAP = {
    "Tecno Camon 30": "HiOS 15",
    "Tecno Camon 40": "HiOS 15",
    "Tecno Camon 50": "HiOS 15",
    "iPhone XR": "iOS 18",
    "iPhone 13": "iOS 18",
    "iPhone 15": "iOS 26",
    "iPhone 15 Pro": "iOS 26",
    "iPhone 16": "iOS 26",
    "iPhone 16 Pro": "iOS 26",
    "iPhone 16 Pro Max": "iOS 26",
    "iPhone 17": "iOS 26",
    "iPhone 17 Pro": "iOS 26",
    "iPhone 17 Pro Max": "iOS 26",
    "Samsung Galaxy S24 Ultra": "One UI 7",
    "Samsung Galaxy S25 Ultra": "One UI 7",
    "Google Pixel 8 Pro": "Pixel UI",
    "OnePlus 12": "OxygenOS 14",
    "Xiaomi Mi 14 Pro": "HyperOS 2",
    "Sony Xperia 1 V": "Xperia UI",
    "Asus ROG Phone 7": "ROG UI",
    "Huawei P60 Pro": "EMUI 13.1",
    "Realme GT 5 Pro": "Realme UI 5.0",
    "Motorola Edge 40 Pro": "My UX"
}

ANDROID_VERSION_MAP = {
    "Tecno Camon 30": "15",
    "Tecno Camon 40": "15",
    "Tecno Camon 50": "16",
    "Samsung Galaxy S24 Ultra": "15",
    "Samsung Galaxy S25 Ultra": "15",
    "Google Pixel 8 Pro": "16 (OTA mid-2025)",
    "OnePlus 12": "14",
    "Xiaomi Mi 14 Pro": "14",
    "Sony Xperia 1 V": "15",
    "Asus ROG Phone 7": "13",
    "Huawei P60 Pro": "13",
    "Realme GT 5 Pro": "14",
    "Motorola Edge 40 Pro": "15"
}

PHONE_OS_IMAGE_MAP = {
    "iOS 18": "https://i.postimg.cc/J41LzByv/1000036383.jpg",
    "iOS 26": "https://i.postimg.cc/CKyPjkwQ/image.png",
    "One UI 7": "https://i.postimg.cc/Dz5f7d6C/1000036394.jpg",
    "HyperOS 2": "https://i.postimg.cc/3Jb1qDvy/1000036392.jpg",
    "HiOS 15": "https://i.postimg.cc/HWf6Gby0/image.png",
    "Pixel UI": "https://i.postimg.cc/w38zbRFh/1000036397.jpg",
    "OxygenOS 14": "https://i.postimg.cc/Bn3LjjsL/1000036400.jpg",
    "Xperia UI": "https://i.postimg.cc/nLcX1NXn/1000036403.jpg",
    "Realme UI 5.0": "https://i.postimg.cc/XYvW1Wk1/1000036416.jpg",
    "ROG UI": "https://i.postimg.cc/VsMkXzKj/1000036406.jpg",
    "EMUI 13.1": "https://i.postimg.cc/1tD1V3yX/1000036409.png",
    "My UX": "https://i.postimg.cc/L4BMH5y0/1000036415.png"
}


# --- –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å –ë–î ---
async def get_user_phone(user_id):
    async with aiosqlite.connect(DB_PATH) as db:
        async with db.execute("SELECT inventory_phone FROM users WHERE user_id = ?", (str(user_id),)) as cursor:
            row = await cursor.fetchone()
            return row[0] if row and row[0] else "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω"


def add_sim_card_wer(user_id, phone_number, operator, tariff, balance, sms, status_tariff="–ê–∫—Ç–∏–≤–µ–Ω"):
    conn = sqlite3.connect("FernieUI.db")
    cursor = conn.cursor()
    cursor.execute("""
        INSERT OR REPLACE INTO sim_cards (user_id, phone_number, operator, tariff, balance, sms, status_tariff)
        VALUES (?, ?, ?, ?, ?, ?, ?)
    """, (user_id, phone_number, operator, tariff, balance, sms, status_tariff))
    conn.commit()
    conn.close()


async def phone_messages_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    user_id = query.from_user.id

    if not query.data.startswith("phone_messages:"):
        return

    await query.answer(
        "üì© –î–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ SMS –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ:\n\n"
        "/sms <–Ω–æ–º–µ—Ä> <—Ç–µ–∫—Å—Ç>\n\n"
        "–ü—Ä–∏–º–µ—Ä:\n/sms 12345 –ü—Ä–∏–≤–µ—Ç, –∫–∞–∫ –¥–µ–ª–∞?",
        show_alert=True
    )


# --- –ö–æ–º–∞–Ω–¥–∞ /phone ---
async def phone_menu(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    phone_name = await get_user_phone(user_id)

    if phone_name in (None, "", "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω"):
        if update.callback_query:
            await update.callback_query.message.delete()
            await update.callback_query.message.reply_text("‚ùå –£ –≤–∞—Å –Ω–µ—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∞.")
        else:
            await update.message.reply_text("‚ùå –£ –≤–∞—Å –Ω–µ—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∞.")
        return

    owner_link = get_display_name_html_new(update.effective_user)

    keyboard = [
        [
            InlineKeyboardButton("‚ÑπÔ∏è –û–± —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ", callback_data=f"phone_about:{user_id}"),
            InlineKeyboardButton("üßÆ –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä", callback_data=f"phone_calculator:{user_id}")
        ],
        [
            InlineKeyboardButton("üì° –û–ø–µ—Ä–∞—Ç–æ—Ä", callback_data=f"phone_operator:{user_id}"),
            InlineKeyboardButton("üí¨ –°–æ–æ–±—â–µ–Ω–∏—è", callback_data=f"phone_messages:{user_id}")
        ],
        [
            InlineKeyboardButton("üè¶ –ú–æ–π –±–∞–Ω–∫ üèß", callback_data=f"phone_bank:{user_id}"),
            InlineKeyboardButton("üõí –ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å üõçÔ∏è", callback_data=f"phone_market:{user_id}")
        ]

    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    text = f"üì± –ú–µ–Ω—é —Ç–µ–ª–µ—Ñ–æ–Ω–∞ | {owner_link}"

    if update.callback_query:
        # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–≤–∫–ª—é—á–∞—è –∫–∞—Ä—Ç–∏–Ω–∫—É) –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –º–µ–Ω—é
        try:
            await update.callback_query.message.delete()
        except:
            pass
        await context.bot.send_message(
            chat_id=update.callback_query.message.chat.id,
            text=text,
            reply_markup=reply_markup,
            parse_mode="HTML"
        )
    else:
        await update.message.reply_text(text, reply_markup=reply_markup, parse_mode="HTML")

async def phone_callback_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    data = query.data

    await query.answer()  # –ó–∞–∫—Ä—ã–≤–∞–µ–º –æ–∂–∏–¥–∞–Ω–∏–µ –∫–ª–∏–∫–∞

    if data.startswith("phone_bank:"):
        await bank(update, context)

    elif data.startswith("phone_market:"):
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–∞–≥–∞–∑–∏–Ω
        await show_store(update, context, page=1)

    elif data == "phone_menu":
        # –í–æ–∑–≤—Ä–∞—Ç –≤ –º–µ–Ω—é —Ç–µ–ª–µ—Ñ–æ–Ω–∞
        await phone_menu(update, context)


async def phone_about(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    callback_user_id = int(query.data.split(":")[1])

    if query.from_user.id != callback_user_id:
        await query.answer("–≠—Ç–∞ –∫–Ω–æ–ø–∫–∞ –Ω–µ –¥–ª—è –≤–∞—Å!", show_alert=True)
        return

    phone_name = await get_user_phone(callback_user_id)

    # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    try:
        await query.message.delete()
    except:
        pass

    if not phone_name:
        await context.bot.send_message(
            chat_id=query.message.chat.id,
            text="‚ùå –£ –≤–∞—Å –Ω–µ—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∞."
        )
        return

    os_shell = PHONE_OS_MAP.get(phone_name, "OS –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞")
    android_version = ANDROID_VERSION_MAP.get(phone_name)
    owner_link = get_display_name_html_new(query.from_user)

    text = f"‚ÑπÔ∏è –û–± —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ:\n\nüì± –ù–∞–∑–≤–∞–Ω–∏–µ: {phone_name}\nüñ• –°–∏—Å—Ç–µ–º–∞: {os_shell}"
    if android_version:
        text += f"\nü§ñ –í–µ—Ä—Å–∏—è Android: {android_version}"

    keyboard = [[InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data=f"phone_back:{callback_user_id}")]]
    reply_markup = InlineKeyboardMarkup(keyboard)

    image_url = PHONE_OS_IMAGE_MAP.get(os_shell)

    if image_url:
        await context.bot.send_photo(
            chat_id=query.message.chat.id,
            photo=image_url,
            caption=text,
            reply_markup=reply_markup,
            parse_mode="HTML"
        )
    else:
        await context.bot.send_message(
            chat_id=query.message.chat.id,
            text=text,
            reply_markup=reply_markup,
            parse_mode="HTML"
        )


calculator_states = {}  # user_id: {"expr": str, "waiting_input": bool, "message_info": dict}


# --- –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è ---
def safe_calculate(expr: str) -> str:
    try:
        expr = expr.replace("√ó", "*").replace("√∑", "/").replace(",", ".")
        expr = re.sub(r'‚àö\s*\(?([0-9\.]+)\)?', r'math.sqrt(\1)', expr)
        result = eval(expr, {"__builtins__": None, "math": math})
        return str(round(result, 8))
    except Exception:
        return "–û—à–∏–±–∫–∞"


# --- –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞ ---
async def phone_calculator_menu(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query

    # –ë–µ—Ä—ë–º user_id –∏–∑ callback_data
    callback_user_id = int(query.data.split(":")[1])

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–ª–∞–¥–µ–ª—å—Ü–∞
    if query.from_user.id != callback_user_id:
        await query.answer("–≠—Ç–∞ –∫–Ω–æ–ø–∫–∞ –Ω–µ –¥–ª—è –≤–∞—Å!", show_alert=True)
        return

    if callback_user_id not in calculator_states:
        calculator_states[callback_user_id] = {"expr": "", "waiting_input": False, "message_info": None}

    expr = calculator_states[callback_user_id]["expr"]
    owner_link = get_display_name_html_new(query.from_user)

    keyboard = [
        [
            InlineKeyboardButton("üìù –í–≤–µ—Å—Ç–∏ –ø—Ä–∏–º–µ—Ä", callback_data=f"calc_input:{callback_user_id}"),
            InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data=f"phone_back:{callback_user_id}")
        ]
    ]

    sent_msg = await query.edit_message_text(
        f"üì± –¢–µ–ª–µ—Ñ–æ–Ω | {owner_link}\n–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ: –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä\n\nüñ• <b>{expr or '0'}</b>",
        reply_markup=InlineKeyboardMarkup(keyboard),
        parse_mode="HTML"
    )

    # –ï—Å–ª–∏ edit_message_text –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç None, –±–µ—Ä–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    if sent_msg is None:
        sent_msg = query.message

    calculator_states[callback_user_id]["message_info"] = {
        "chat_id": sent_msg.chat.id,
        "message_id": sent_msg.message_id
    }


# --- –ö–Ω–æ–ø–∫–∞ "–í–≤–µ—Å—Ç–∏ –ø—Ä–∏–º–µ—Ä" ---
async def calculator_input_button(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query

    # –ü–æ–ª—É—á–∞–µ–º user_id –∏–∑ callback_data
    callback_user_id = int(query.data.split(":")[1])
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ç–æ—Ç, –∫—Ç–æ –Ω–∞–∂–∞–ª –∫–Ω–æ–ø–∫—É, —ç—Ç–æ –≤–ª–∞–¥–µ–ª–µ—Ü
    if query.from_user.id != callback_user_id:
        await query.answer("–≠—Ç–∞ –∫–Ω–æ–ø–∫–∞ –Ω–µ –¥–ª—è –≤–∞—Å!", show_alert=True)
        return

    user_id = query.from_user.id

    # --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç ---
    if user_id not in calculator_states:
        calculator_states[user_id] = {"expr": "", "waiting_input": False, "message_info": None}

    calculator_states[user_id]["waiting_input"] = True
    calculator_states[user_id]["expr"] = ""

    owner_link = get_display_name_html_new(query.from_user)
    keyboard = [
        [
            InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∏—Ç—å –≤–≤–æ–¥", callback_data=f"calc_cancel:{user_id}"),
            InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data=f"phone_back:{user_id}")
        ]
    ]

    text = (
        f"üì± –¢–µ–ª–µ—Ñ–æ–Ω | {owner_link}\n"
        f"üõ† –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ: –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä\n\n"
        f"üñ• <b>–í–≤–µ–¥–∏—Ç–µ –ø—Ä–∏–º–µ—Ä...</b>"
    )

    sent_msg = await query.edit_message_text(
        text=text,
        reply_markup=InlineKeyboardMarkup(keyboard),
        parse_mode="HTML"
    )

    if sent_msg is None:
        sent_msg = query.message

    calculator_states[user_id]["message_info"] = {
        "chat_id": sent_msg.chat.id,
        "message_id": sent_msg.message_id
    }

    asyncio.create_task(input_timeout(user_id, context))


# --- –û—Ç–º–µ–Ω–∞ –≤–≤–æ–¥–∞ ---
async def calculator_cancel(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    callback_user_id = int(query.data.split(":")[1])
    if query.from_user.id != callback_user_id:
        await query.answer("–≠—Ç–∞ –∫–Ω–æ–ø–∫–∞ –Ω–µ –¥–ª—è –≤–∞—Å!", show_alert=True)
        return

    user_id = query.from_user.id

    if user_id not in calculator_states:
        calculator_states[user_id] = {"expr": "", "waiting_input": False, "message_info": None}

    calculator_states[user_id]["waiting_input"] = False

    await phone_calculator_menu(update, context)


# --- –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ---
async def calculator_text_input(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    if user_id not in calculator_states or not calculator_states[user_id]["waiting_input"]:
        return

    expr = update.message.text
    result = safe_calculate(expr)

    calculator_states[user_id]["expr"] = result
    calculator_states[user_id]["waiting_input"] = False

    owner_link = get_display_name_html_new(update.effective_user)
    keyboard = [
        [InlineKeyboardButton("üìù –í–≤–µ—Å—Ç–∏ –ø—Ä–∏–º–µ—Ä", callback_data=f"calc_input:{user_id}")],
        [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data=f"phone_back:{user_id}")]
    ]

    msg_data = calculator_states[user_id].get("message_info")
    if msg_data:
        text = (
            f"üì± –¢–µ–ª–µ—Ñ–æ–Ω | {owner_link}\n"
            f"üõ† –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ: –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä\n\n"
            f"üñ• <b>{result}</b>"
        )

        await context.bot.edit_message_text(
            chat_id=msg_data["chat_id"],
            message_id=msg_data["message_id"],
            text=text,
            reply_markup=InlineKeyboardMarkup(keyboard),
            parse_mode="HTML"
        )


# --- –¢–∞–π–º–∞—É—Ç 2 –º–∏–Ω—É—Ç—ã ---
async def input_timeout(user_id: int, context: ContextTypes.DEFAULT_TYPE):
    await asyncio.sleep(120)
    state = calculator_states.get(user_id)
    if state and state.get("waiting_input", False):
        state["expr"] = "–í—Ä–µ–º—è –≤—ã—à–ª–æ.."
        state["waiting_input"] = False

        msg_data = state.get("message_info")
        if msg_data:
            await context.bot.edit_message_text(
                chat_id=msg_data["chat_id"],
                message_id=msg_data["message_id"],
                text=f"üñ• <b>{state['expr']}</b>",
                parse_mode="HTML"
            )


def phone_number_exists(phone_number):
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –∑–∞–Ω—è—Ç –ª–∏ –Ω–æ–º–µ—Ä –≤ –±–∞–∑–µ"""
    try:
        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()
        cursor.execute("SELECT 1 FROM sim_cards WHERE phone_number=?", (phone_number,))
        exists = cursor.fetchone()
        conn.close()
        return bool(exists)
    except Exception as e:
        print(f"[ERROR] phone_number_exists: {e}")
        return False


def get_sim_card(user_id):
    """–ü–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ SIM-–∫–∞—Ä—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    try:
        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()
        cursor.execute(
            "SELECT phone_number, operator, tariff, balance, sms, status_tariff FROM sim_cards WHERE user_id=?",
            (user_id,)
        )
        result = cursor.fetchone()
        conn.close()
        return result
    except Exception as e:
        print(f"[ERROR] get_sim_card: {e}")
        return None

def add_sim_card_to_db(user_id, phone_number, operator, tariff, balance, sms, status_tariff="–ê–∫—Ç–∏–≤–µ–Ω"):
    """–î–æ–±–∞–≤–ª—è–µ—Ç –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç SIM-–∫–∞—Ä—Ç—É –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö"""
    try:
        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()
        cursor.execute("""
            INSERT OR REPLACE INTO sim_cards (user_id, phone_number, operator, tariff, balance, sms, status_tariff)
            VALUES (?, ?, ?, ?, ?, ?, ?)
        """, (user_id, phone_number, operator, tariff, balance, sms, status_tariff))
        conn.commit()
        conn.close()
        return True
    except Exception as e:
        print(f"[ERROR] add_sim_card_to_db: {e}")
        return False

def add_status_tariff_column():
    """–î–æ–±–∞–≤–ª—è–µ—Ç –∫–æ–ª–æ–Ω–∫—É status_tariff –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç"""
    try:
        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()

        # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Ç–∞–±–ª–∏—Ü–∞
        cursor.execute("SELECT name FROM sqlite_master WHERE type='table' AND name='sim_cards'")
        if not cursor.fetchone():
            print("‚ö†Ô∏è –¢–∞–±–ª–∏—Ü–∞ sim_cards –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, —Å–æ–∑–¥–∞—é...")
            cursor.execute("""
            CREATE TABLE IF NOT EXISTS sim_cards (
                user_id TEXT PRIMARY KEY,
                phone_number TEXT UNIQUE,
                operator TEXT,
                tariff TEXT,
                balance REAL,
                sms INTEGER,
                status_tariff TEXT DEFAULT '–ê–∫—Ç–∏–≤–µ–Ω'
            )
            """)
            conn.commit()
            conn.close()
            print("‚úÖ –¢–∞–±–ª–∏—Ü–∞ sim_cards —Å–æ–∑–¥–∞–Ω–∞")
            return

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –∫–æ–ª–æ–Ω–∫–∞ status_tariff
        cursor.execute("PRAGMA table_info(sim_cards)")
        columns = [col[1] for col in cursor.fetchall()]

        if 'status_tariff' not in columns:
            print("‚ûï –î–æ–±–∞–≤–ª—è—é –∫–æ–ª–æ–Ω–∫—É status_tariff...")
            cursor.execute("ALTER TABLE sim_cards ADD COLUMN status_tariff TEXT DEFAULT '–ê–∫—Ç–∏–≤–µ–Ω'")
            conn.commit()
            print("‚úÖ –ö–æ–ª–æ–Ω–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞")
        else:
            print("‚úÖ –ö–æ–ª–æ–Ω–∫–∞ status_tariff —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç")

        conn.close()

    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –≤ add_status_tariff_column: {e}")


async def handle_sim_card_start(update: Update, context: ContextTypes.DEFAULT_TYPE, user_id: str):
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç /start —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º SIM-–∫–∞—Ä—Ç—ã
    –§–æ—Ä–º–∞—Ç: /start PhoneNumber-XXXXXXX__Operator-FernieMobile__Tariff-Premium
    """
    message = update.message

    # –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä start
    if not context.args or len(context.args) == 0:
        await message.reply_text("‚ùå –û—à–∏–±–∫–∞: –ø–∞—Ä–∞–º–µ—Ç—Ä start –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω.")
        return

    start_param = context.args[0]  # –ë–µ—Ä–µ–º –ø–µ—Ä–≤—ã–π –∞—Ä–≥—É–º–µ–Ω—Ç
    print(f"[DEBUG] SIM start_param: {start_param}")

    # –ü–∞—Ä—Å–∏–º –ø–∞—Ä–∞–º–µ—Ç—Ä
    sim_data = parse_sim_start_parameter(start_param)

    if not sim_data:
        await message.reply_text("‚ùå –û—à–∏–±–∫–∞: –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–∞.")
        return

    phone_number = sim_data["phone_number"]
    operator = sim_data["operator"]
    tariff = sim_data["tariff"]

    print(f"[DEBUG] Parsed SIM: phone={phone_number}, operator={operator}, tariff={tariff}")

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä
    if operator not in TARIFFS:
        await message.reply_text(f"‚ùå –û—à–∏–±–∫–∞: –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –æ–ø–µ—Ä–∞—Ç–æ—Ä '{operator}'.")
        return

    # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–∞—Ä–∏—Ñ–µ
    tariff_info = next((t for t in TARIFFS[operator] if t[0] == tariff), None)

    if not tariff_info:
        await message.reply_text(f"‚ùå –û—à–∏–±–∫–∞: —Ç–∞—Ä–∏—Ñ '{tariff}' –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ '{operator}'.")
        return

    sms, balance = tariff_info[1], tariff_info[2]

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–Ω—è—Ç –ª–∏ –Ω–æ–º–µ—Ä
    if phone_number_exists(phone_number):
        await message.reply_text("‚ùå –û—à–∏–±–∫–∞: —ç—Ç–æ—Ç –Ω–æ–º–µ—Ä —É–∂–µ –∑–∞–Ω—è—Ç.")
        return

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ SIM-–∫–∞—Ä—Ç–∞ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    existing_sim = get_sim_card(user_id)
    if existing_sim:
        # –ï—Å–ª–∏ –µ—Å—Ç—å - –≤—ã–¥–∞–µ–º –æ—à–∏–±–∫—É
        await message.reply_text("‚ùå –û—à–∏–±–∫–∞: —É –≤–∞—Å —É–∂–µ –µ—Å—Ç—å SIM-–∫–∞—Ä—Ç–∞. –ó–∞–º–µ–Ω–∞ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–∞.")
        return

    # –î–æ–±–∞–≤–ª—è–µ–º SIM-–∫–∞—Ä—Ç—É –≤ –±–∞–∑—É
    if not add_sim_card_to_db(user_id, phone_number, operator, tariff, balance, sms, "–ê–∫—Ç–∏–≤–µ–Ω"):
        await message.reply_text("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ SIM-–∫–∞—Ä—Ç—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")
        return

    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å–ø–µ—à–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    text = (
        f"‚úÖ <b>SIM-–∫–∞—Ä—Ç–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∞!</b>\n\n"
        f"üìû <b>–ù–æ–º–µ—Ä:</b> <code>{phone_number}</code>\n"
        f"üè¢ <b>–û–ø–µ—Ä–∞—Ç–æ—Ä:</b> {operator}\n"
        f"üìã <b>–¢–∞—Ä–∏—Ñ:</b> {tariff}\n"
        f"üí∞ <b>–ë–∞–ª–∞–Ω—Å:</b> {balance} ‚ÇΩ\n"
        f"‚úâÔ∏è <b>SMS:</b> {sms}\n"
        f"‚ö†Ô∏è <b>–°—Ç–∞—Ç—É—Å —Ç–∞—Ä–∏—Ñ–∞:</b> –ê–∫—Ç–∏–≤–µ–Ω"
    )

    await message.reply_text(text, parse_mode="HTML")

# ================= SIM Card Start Handler =================

def parse_sim_start_parameter(start_param):
    try:
        data = {}
        parts = start_param.split("__")

        for part in parts:
            if part.startswith("PhoneNumber-"):
                data["phone_number"] = part.replace("PhoneNumber-", "")
            elif part.startswith("Operator-"):
                data["operator"] = part.replace("Operator-", "")
            elif part.startswith("Tariff-"):
                data["tariff"] = part.replace("Tariff-", "")

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –≤—Å–µ –Ω—É–∂–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –µ—Å—Ç—å
        if all(k in data for k in ["phone_number", "operator", "tariff"]):
            return data
        return None
    except Exception as e:
        print(f"[ERROR] parse_sim_start_parameter: {e}")
        return None



# ================= –û–ø–µ—Ä–∞—Ç–æ—Ä SIM (Phone Operator Menu) =================

awaiting_topup = {}
async def phone_operator(update: Update, context: ContextTypes.DEFAULT_TYPE):

    """–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ SIM-–∫–∞—Ä—Ç—ã"""
    query = update.callback_query
    await query.answer()
    callback_user_id = int(query.data.split(":")[1])
    if query.from_user.id != callback_user_id:
        await query.answer("–≠—Ç–∞ –∫–Ω–æ–ø–∫–∞ –Ω–µ –¥–ª—è –≤–∞—Å!", show_alert=True)
        return

    # –ü–æ–ª—É—á–∞–µ–º SIM-–∫–∞—Ä—Ç—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    sim_data = get_sim_card(str(callback_user_id))

    if not sim_data:
        keyboard = [
            [InlineKeyboardButton("üåê –û—Ñ–æ—Ä–º–∏—Ç—å –Ω–æ–º–µ—Ä", url="https://ferniex-phone-operator.vercel.app/")],
            [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data=f"phone_back:{callback_user_id}")]
        ]
        new_text = "üì° –£ –≤–∞—Å –µ—â—ë –Ω–µ—Ç –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞.\n\n–û—Ñ–æ—Ä–º–∏—Ç—å –Ω–æ–º–µ—Ä –º–æ–∂–Ω–æ —á–µ—Ä–µ–∑ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ."
        if query.message.text != new_text:
            await query.edit_message_text(new_text, reply_markup=InlineKeyboardMarkup(keyboard))
        return

    phone_number, operator, tariff, balance, sms, status_tariff = sim_data

    text = (
        f"üì° <b>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ–ø–µ—Ä–∞—Ç–æ—Ä–µ:</b>\n\n"
        f"üìû <b>–ù–æ–º–µ—Ä:</b> <code>{phone_number}</code>\n"
        f"üè¢ <b>–û–ø–µ—Ä–∞—Ç–æ—Ä:</b> {operator}\n"
        f"üìã <b>–¢–∞—Ä–∏—Ñ:</b> {tariff}\n"
        f"üí∞ <b>–ë–∞–ª–∞–Ω—Å:</b> {balance} ‚ÇΩ\n"
        f"‚úâÔ∏è <b>SMS:</b> {sms}\n"
        f"‚ö†Ô∏è <b>–°—Ç–∞—Ç—É—Å —Ç–∞—Ä–∏—Ñ–∞:</b> {status_tariff}"
    )

    keyboard = [
        [InlineKeyboardButton("üìã –ú–æ–π —Ç–∞—Ä–∏—Ñ", callback_data=f"phone_my_tariff:{callback_user_id}"),
         InlineKeyboardButton("‚õî –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å", callback_data=f"phone_block:{callback_user_id}")],
        [InlineKeyboardButton("üí∞ –ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å", callback_data=f"phone_topup:{callback_user_id}")],
        [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data=f"phone_back:{callback_user_id}")]
    ]

    if query.message.text != text:
        await query.edit_message_text(text, reply_markup=InlineKeyboardMarkup(keyboard), parse_mode="HTML")



async def phone_my_tariff(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    user_id = int(query.data.split(":")[1])
    sim_data = get_sim_card(user_id)
    if not sim_data:
        await query.edit_message_text("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π SIM-–∫–∞—Ä—Ç—ã.")
        return

    phone_number, operator, tariff, balance, sms, status_tariff = sim_data
    daily_price = next((price for name, _, price in TARIFFS.get(operator, []) if name == tariff), None)

    text = (
        f"<b>üìã –ú–æ–π —Ç–∞—Ä–∏—Ñ</b>\n"
        f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
        f"üè¢ <b>–û–ø–µ—Ä–∞—Ç–æ—Ä:</b> <code>{operator}</code>\n"
        f"üìú <b>–¢–∞—Ä–∏—Ñ:</b> <code>{tariff}</code>\n"
        f"üíµ <b>–¶–µ–Ω–∞ –≤ –¥–µ–Ω—å:</b> <code>{daily_price} ‚ÇΩ</code>\n"
        f"‚úâÔ∏è <b>SMS:</b> <code>{sms}</code>\n"
        f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
    )

    keyboard = [
        [InlineKeyboardButton("üîÑ –°–º–µ–Ω–∏—Ç—å —Ç–∞—Ä–∏—Ñ", callback_data=f"phone_change_tariff_prompt:{user_id}")],
        [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data=f"phone_operator:{user_id}")]
    ]

    await query.edit_message_text(text, reply_markup=InlineKeyboardMarkup(keyboard), parse_mode="HTML")


# ------------------- –°–º–µ–Ω–∞ —Ç–∞—Ä–∏—Ñ–∞ -------------------
async def phone_change_tariff_prompt(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    user_id = int(query.data.split(":")[1])

    # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ SIM
    sim_data = get_sim_card(user_id)
    if not sim_data:
        await query.edit_message_text("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π SIM-–∫–∞—Ä—Ç—ã.")
        return

    _, current_operator, _, _, _, _ = sim_data

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ, —á—Ç–æ–±—ã –∑–Ω–∞—Ç—å, —á—Ç–æ —á–µ–ª–æ–≤–µ–∫ –º–µ–Ω—è–µ—Ç —Ç–∞—Ä–∏—Ñ
    context.user_data["change_tariff"] = {"user_id": user_id}

    keyboard = []
    row = []
    for i, op in enumerate(OPERATORS, 1):
        row.append(InlineKeyboardButton(op, callback_data=f"phone_change_tariff_operator:{user_id}:{op}"))
        if i % 2 == 0:
            keyboard.append(row)
            row = []
    if row:  # –µ—Å–ª–∏ –æ—Å—Ç–∞–ª–∞—Å—å –Ω–µ–ø–æ–ª–Ω–∞—è —Å—Ç—Ä–æ–∫–∞
        keyboard.append(row)

    # –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥"
    keyboard.append([InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data=f"phone_my_tariff:{user_id}")])
    text = (
        f"üì° <b>–°–º–µ–Ω–∞ —Ç–∞—Ä–∏—Ñ–∞</b>\n"
        f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
        f"üè¢ <b>–¢–µ–∫—É—â–∏–π –æ–ø–µ—Ä–∞—Ç–æ—Ä:</b> <code>{current_operator}</code>\n"
        f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
        f"‚¨áÔ∏è –í—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–≤–æ–≥–æ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞:"
    )

    await query.edit_message_text(text, reply_markup=InlineKeyboardMarkup(keyboard), parse_mode="HTML")


async def phone_change_tariff_operator(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    _, user_id_str, operator = query.data.split(":")
    user_id = int(user_id_str)

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
    context.user_data["change_tariff"]["operator"] = operator

    # –ö–Ω–æ–ø–∫–∏ —Ç–∞—Ä–∏—Ñ–æ–≤ —ç—Ç–æ–≥–æ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
    keyboard = [
        [InlineKeyboardButton(f"{name} ‚Äî {price} ‚ÇΩ/–¥–µ–Ω—å, {sms} SMS",
                              callback_data=f"phone_change_tariff_select:{user_id}:{operator}:{name}")]
        for name, sms, price in TARIFFS[operator]
    ]
    keyboard.append([InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data=f"phone_change_tariff_prompt:{user_id}")])

    await query.edit_message_text(
        f"üè¢ –û–ø–µ—Ä–∞—Ç–æ—Ä: <code>{operator}</code>\n\n–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∞—Ä–∏—Ñ:",
        reply_markup=InlineKeyboardMarkup(keyboard),
        parse_mode="HTML"
    )


async def phone_change_tariff_select(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    _, user_id_str, operator, tariff_name = query.data.split(":")
    user_id = int(user_id_str)

    # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ SIM
    sim_data = get_sim_card(user_id)
    if not sim_data:
        await query.edit_message_text("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π SIM-–∫–∞—Ä—Ç—ã.")
        return

    old_number, old_operator, old_tariff, _, old_sms, _ = sim_data
    # –ù–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
    _, new_sms, new_price = next(t for t in TARIFFS[operator] if t[0] == tariff_name)

    # –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–ø–∏—Å—å –≤ –±–∞–∑–µ
    conn = sqlite3.connect("FernieUI.db")
    cursor = conn.cursor()
    cursor.execute(
        "UPDATE sim_cards SET operator=?, tariff=?, sms=? WHERE user_id=?",
        (operator, tariff_name, new_sms, user_id)
    )
    conn.commit()
    conn.close()

    text = (
        "<b>‚úÖ –¢–∞—Ä–∏—Ñ SIM-–∫–∞—Ä—Ç—ã –∏–∑–º–µ–Ω—ë–Ω</b>\n\n"
        f"<u>–°—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ:</u>\n"
        f"üìû –ù–æ–º–µ—Ä: <code>{old_number}</code>\n"
        f"üè¢ –û–ø–µ—Ä–∞—Ç–æ—Ä: <code>{old_operator}</code>\n"
        f"üìú –¢–∞—Ä–∏—Ñ: <code>{old_tariff}</code>\n"
        f"‚úâÔ∏è SMS: <code>{old_sms}</code>\n\n"
        f"<u>–ù–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ:</u>\n"
        f"üìû –ù–æ–º–µ—Ä: <code>{old_number}</code>\n"
        f"üè¢ –û–ø–µ—Ä–∞—Ç–æ—Ä: <code>{operator}</code>\n"
        f"üìú –¢–∞—Ä–∏—Ñ: <code>{tariff_name}</code>\n"
        f"‚úâÔ∏è SMS: <code>{new_sms}</code>\n"
        f"üíµ –¶–µ–Ω–∞ –≤ –¥–µ–Ω—å: <code>{new_price} ‚ÇΩ</code>"
    )

    keyboard = [[InlineKeyboardButton("‚¨ÖÔ∏è –û—Ç–ª–∏—á–Ω–æ!", callback_data=f"phone_operator:{user_id}")]]
    await query.edit_message_text(text, reply_markup=InlineKeyboardMarkup(keyboard), parse_mode="HTML")


# ------------------- –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ SIM -------------------
async def phone_block_prompt(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    user_id = int(query.data.split(":")[1])
    sim_data = get_sim_card(user_id)
    if not sim_data:
        await query.edit_message_text("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π SIM-–∫–∞—Ä—Ç—ã.")
        return

    phone_number, *_ = sim_data

    keyboard = [
        [InlineKeyboardButton("‚ùå –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å", callback_data=f"phone_block_confirm:{user_id}")],
        [InlineKeyboardButton("‚¨ÖÔ∏è –û—Ç–º–µ–Ω–∞", callback_data=f"phone_back:{user_id}")]
    ]

    text = (
        f"–û–ø–µ—Ä–∞—Ç–æ—Ä | –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –Ω–æ–º–µ—Ä–∞\n\n"
        f"–ù–æ–º–µ—Ä: {phone_number}\n\n"
        f"–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å SIM-–∫–∞—Ä—Ç—É?"
    )

    await query.edit_message_text(text, reply_markup=InlineKeyboardMarkup(keyboard))


async def phone_block_confirm(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    user_id = int(query.data.split(":")[1])

    # –£–¥–∞–ª—è–µ–º SIM-–∫–∞—Ä—Ç—É –∏–∑ –±–∞–∑—ã
    conn = sqlite3.connect("FernieUI.db")
    cursor = conn.cursor()
    cursor.execute("DELETE FROM sim_cards WHERE user_id=?", (user_id,))
    conn.commit()
    conn.close()

    text = "‚úÖ SIM-–∫–∞—Ä—Ç–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞ –∏ —É–¥–∞–ª–µ–Ω–∞ –∏–∑ –±–∞–∑—ã."
    keyboard = [[InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data=f"phone_back:{user_id}")]]

    await query.edit_message_text(text, reply_markup=InlineKeyboardMarkup(keyboard))

async def start_topup(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    user_id = int(query.data.split(":")[1])
    if query.from_user.id != user_id:
        await query.answer("–≠—Ç–∞ –∫–Ω–æ–ø–∫–∞ –Ω–µ –¥–ª—è –≤–∞—Å!", show_alert=True)
        return

    context.user_data['topup_waiting'] = True
    context.user_data['topup_user_id'] = user_id
    context.user_data['topup_since'] = time.time()

    await query.edit_message_text(
        "üí∞ <b>–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ SIM-–∫–∞—Ä—Ç—ã</b>\n\n"
        "–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è:\n\n"
        "<i>‚è∞ –û–∂–∏–¥–∞–Ω–∏–µ –≤–≤–æ–¥–∞: 60 —Å–µ–∫—É–Ω–¥</i>",
        parse_mode="HTML",
        reply_markup=InlineKeyboardMarkup([
            [InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data=f"phone_topup_cancel:{user_id}")]
        ])
    )

async def phone_topup_cancel(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    user_id = int(query.data.split(":")[1])
    context.user_data.pop('topup_waiting', None)
    context.user_data.pop('topup_user_id', None)
    context.user_data.pop('topup_since', None)

    await query.edit_message_text(
        "‚ùå –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.",
        reply_markup=InlineKeyboardMarkup([
            [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data=f"phone_operator:{user_id}")]
        ])
    )

async def topup_amount_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id

    if not context.user_data.get('topup_waiting'):
        return
    if context.user_data.get('topup_user_id') != user_id:
        return

    since = context.user_data.get('topup_since', 0)
    if time.time() - since > 60:
        context.user_data.pop('topup_waiting', None)
        context.user_data.pop('topup_user_id', None)
        context.user_data.pop('topup_since', None)
        await update.message.reply_text("‚è≥ –í—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –∏—Å—Ç–µ–∫–ª–æ. –ù–∞—á–Ω–∏—Ç–µ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–Ω–æ–≤–æ.")
        return

    text = (update.message.text or "").strip()

    try:
        amount = float(text)
    except ValueError:
        context.user_data.pop('topup_waiting', None)
        context.user_data.pop('topup_user_id', None)
        context.user_data.pop('topup_since', None)
        await update.message.reply_text(
            "‚ùå –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ ‚Äî –≤–≤–µ–¥–µ–Ω–æ –Ω–µ —á–∏—Å–ª–æ.\n\n"
            "–ù–∞–∂–º–∏—Ç–µ <b>üí∞ –ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å</b> –∑–∞–Ω–æ–≤–æ –∏ –≤–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –≤ —Ç–µ—á–µ–Ω–∏–µ 60 —Å–µ–∫—É–Ω–¥.",
            parse_mode="HTML"
        )
        return

    if amount <= 0:
        context.user_data.pop('topup_waiting', None)
        context.user_data.pop('topup_user_id', None)
        context.user_data.pop('topup_since', None)
        await update.message.reply_text(
            "‚ùå –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ ‚Äî —Å—É–º–º–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–π.\n\n"
            "–ù–∞–∂–º–∏—Ç–µ <b>üí∞ –ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å</b> –∑–∞–Ω–æ–≤–æ.",
            parse_mode="HTML"
        )
        return

    context.user_data.pop('topup_waiting', None)
    context.user_data.pop('topup_user_id', None)
    context.user_data.pop('topup_since', None)

    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()

        cursor.execute("SELECT balance FROM users WHERE user_id = ?", (str(user_id),))
        row_user = cursor.fetchone()
        if not row_user:
            await update.message.reply_text("‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.")
            return

        user_balance = row_user[0]
        if user_balance < amount:
            await update.message.reply_text(
                f"‚ö†Ô∏è –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–º –±–∞–ª–∞–Ω—Å–µ.\nüí∞ –ë–∞–ª–∞–Ω—Å: {user_balance} ‚ÇΩ"
            )
            return

        new_user_balance = user_balance - amount
        cursor.execute("UPDATE users SET balance = ? WHERE user_id = ?", (new_user_balance, str(user_id)))

        cursor.execute(
            "SELECT balance, operator, tariff, status_tariff FROM sim_cards WHERE user_id = ?",
            (user_id,)
        )
        row_sim = cursor.fetchone()
        if not row_sim:
            await update.message.reply_text("‚ùå SIM-–∫–∞—Ä—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.")
            return

        sim_balance, operator, tariff_name, status_tariff = row_sim
        new_sim_balance = sim_balance + amount

        tariff_info = next(
            ((name, sms, price) for name, sms, price in TARIFFS[operator] if name == tariff_name),
            None
        )

        if tariff_info:
            _, sms_count, price = tariff_info
            if status_tariff == "–¢–∞—Ä–∏—Ñ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω" and new_sim_balance >= price:
                new_sim_balance -= price
                status_tariff = "–ê–∫—Ç–∏–≤–µ–Ω"
                cursor.execute(
                    "UPDATE sim_cards SET balance = ?, sms = ?, status_tariff = ? WHERE user_id = ?",
                    (new_sim_balance, sms_count, status_tariff, user_id)
                )
                await update.message.reply_text(
                    f"‚úÖ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–∞—Ä–∏—Ñ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω! –°–ø–∏—Å–∞–Ω–æ {price} ‚ÇΩ, SMS –æ–±–Ω–æ–≤–ª–µ–Ω–æ: {sms_count}"
                )
            else:
                cursor.execute(
                    "UPDATE sim_cards SET balance = ? WHERE user_id = ?",
                    (new_sim_balance, user_id)
                )
        else:
            cursor.execute(
                "UPDATE sim_cards SET balance = ? WHERE user_id = ?",
                (new_sim_balance, user_id)
            )

        conn.commit()

    await update.message.reply_text(
        "<b>‚úÖ –ë–∞–ª–∞–Ω—Å SIM-–∫–∞—Ä—Ç—ã –ø–æ–ø–æ–ª–Ω–µ–Ω!</b>\n\n"
        f"<b>üíµ –°—É–º–º–∞:</b> <code>{amount} ‚ÇΩ</code>\n"
        f"<b>üí∞ –ë–∞–ª–∞–Ω—Å SIM:</b> <code>{new_sim_balance} ‚ÇΩ</code>\n"
        f"<b>ü™ô –ë–∞–ª–∞–Ω—Å –∞–∫–∫–∞—É–Ω—Ç–∞:</b> <code>{new_user_balance} ‚ÇΩ</code>",
        parse_mode="HTML"
    )

OPERATORS = ["FernieMobile", "FernieX", "T-2 Mobile", "T-Mobile"]


async def phone_choose_operator(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    user_id = int(query.data.split(":")[1])

    chosen_number = context.user_data.get("new_number")
    if not chosen_number:
        await query.edit_message_text("‚ùå –û—à–∏–±–∫–∞: –Ω–æ–º–µ—Ä –Ω–µ –≤—ã–±—Ä–∞–Ω.")
        return

    keyboard = [
                   [InlineKeyboardButton(op, callback_data=f"phone_choose_tariff:{user_id}:{op}")] for op in OPERATORS
               ] + [[InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data=f"phone_back:{user_id}")]]

    text = f"–í—ã–±–µ—Ä–∏—Ç–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ —Å–≤—è–∑–∏\n–ù–æ–º–µ—Ä: {chosen_number}"
    await query.edit_message_text(text, reply_markup=InlineKeyboardMarkup(keyboard))


def phone_number_exists(phone_number):
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –∑–∞–Ω—è—Ç –ª–∏ –Ω–æ–º–µ—Ä –≤ –±–∞–∑–µ"""
    try:
        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()
        cursor.execute("SELECT 1 FROM sim_cards WHERE phone_number=?", (phone_number,))
        exists = cursor.fetchone()
        conn.close()
        return bool(exists)
    except Exception as e:
        print(f"[ERROR] phone_number_exists: {e}")
        return False

TARIFFS = {
    "FernieMobile": [
        ("Premium", 115, 5000),
        ("Medium", 70, 1500),
        ("Minimal", 20, 500)
    ],
    "FernieX": [
        ("PremiumX", 1500, 30000),
        ("PlatinumX", 1000, 15000),
        ("Minimal", 600, 10000)
    ],
    "T-2 Mobile": [
        ("Premium", 125, 5500),
        ("Medium", 55, 2000),
        ("Minimal", 45, 1000)
    ],
    "T-Mobile": [
        ("Premium", 150, 4500),
        ("Medium", 50, 1650),
        ("Minimal", 30, 650)
    ]
}

def add_sim_card(user_id, phone_number, operator, tariff, balance, sms):
    # –ó–∞–ø–∏—Å—å –≤ –±–∞–∑—É —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º –Ω–æ–º–µ—Ä–æ–º
    conn = sqlite3.connect("FernieUI.db")
    cursor = conn.cursor()
    cursor.execute("""
        INSERT OR REPLACE INTO sim_cards (user_id, phone_number, operator, tariff, balance, sms)
        VALUES (?, ?, ?, ?, ?, ?)
    """, (user_id, phone_number, operator, tariff, balance, sms))
    conn.commit()
    conn.close()


async def phone_choose_tariff(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    data = query.data.split(":")
    user_id = int(data[1])
    operator = data[2]
    chosen_number = context.user_data.get("new_number")

    tariffs = TARIFFS.get(operator, [])
    keyboard = [
                   [InlineKeyboardButton(f"{name} - {sms} SMS = {price} ‚ÇΩ",
                                         callback_data=f"phone_confirm_tariff:{user_id}:{operator}:{name}")]
                   for name, sms, price in tariffs
               ] + [[InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data=f"phone_back:{user_id}")]]

    text = f"–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∞—Ä–∏—Ñ –¥–ª—è {operator}\n–ù–æ–º–µ—Ä: {chosen_number}"
    await query.edit_message_text(text, reply_markup=InlineKeyboardMarkup(keyboard))


async def phone_confirm_tariff(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    # –†–∞–∑–±–∏—Ä–∞–µ–º callback_data: phone_confirm_tariff:{user_id}:{operator}:{tariff_name}
    data = query.data.split(":")
    user_id = int(data[1])
    operator = data[2]
    tariff_name = data[3]

    chosen_number = context.user_data.get("new_number")
    if not chosen_number:
        await query.edit_message_text("‚ùå –ù–æ–º–µ—Ä –Ω–µ –≤—ã–±—Ä–∞–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.")
        return

    # –ë–µ—Ä–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ç–∞—Ä–∏—Ñ–∞ –∏–∑ TARIFFS
    tariff_info = next((t for t in TARIFFS[operator] if t[0] == tariff_name), None)
    if not tariff_info:
        await query.edit_message_text("‚ùå –û—à–∏–±–∫–∞: —Ç–∞—Ä–∏—Ñ –Ω–µ –Ω–∞–π–¥–µ–Ω.")
        return
    sms, balance = tariff_info[1], tariff_info[2]
    status_tariff = "–ê–∫—Ç–∏–≤–µ–Ω"

    # –î–æ–±–∞–≤–ª—è–µ–º SIM-–∫–∞—Ä—Ç—É –≤ –±–∞–∑—É
    add_sim_card(user_id, chosen_number, operator, tariff_name, balance, sms)

    # –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π –Ω–æ–º–µ—Ä
    context.user_data.pop("new_number", None)

    keyboard = [[InlineKeyboardButton("‚úÖ –û—Ç–ª–∏—á–Ω–æ!", callback_data=f"phone_back:{user_id}")]]
    text = (
        f"‚úÖ <b>SIM-–∫–∞—Ä—Ç–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∞!</b>\n\n"
        f"üìû <b>–ù–æ–º–µ—Ä:</b> {chosen_number}\n"
        f"üè¢ <b>–û–ø–µ—Ä–∞—Ç–æ—Ä:</b> {operator}\n"
        f"üìã <b>–¢–∞—Ä–∏—Ñ:</b> {tariff_name}\n"
        f"üí∞ <b>–ë–∞–ª–∞–Ω—Å:</b> {balance} ‚ÇΩ\n"
        f"‚úâÔ∏è <b>SMS:</b> {sms}\n"
        f"‚ö†Ô∏è <b>–°—Ç–∞—Ç—É—Å —Ç–∞—Ä–∏—Ñ–∞:</b> {status_tariff}"
    )

    await query.edit_message_text(
        text,
        reply_markup=InlineKeyboardMarkup(keyboard),
        parse_mode="HTML"
    )

async def sms_command_phone(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if len(context.args) < 2:
        await update.message.reply_text("–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /sms <–Ω–æ–º–µ—Ä> <—Ç–µ–∫—Å—Ç>")
        return

    phone_number = context.args[0]
    text_message = " ".join(context.args[1:])
    sender_display = get_display_name_html_new(update.message.from_user)
    sender_id = update.message.from_user.id

    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    # –ü–æ–ª—É—á–∞–µ–º –±–∞–ª–∞–Ω—Å –∏ –Ω–æ–º–µ—Ä –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
    cursor.execute("SELECT sms, phone_number FROM sim_cards WHERE user_id = ?", (sender_id,))
    sender_info = cursor.fetchone()
    if not sender_info:
        await update.message.reply_text("‚ùå –í–∞—à –Ω–æ–º–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ.")
        conn.close()
        return

    sms_balance, sender_phone = sender_info
    if sms_balance <= 0:
        await update.message.reply_text("‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ SMS –Ω–∞ –≤–∞—à–µ–º –±–∞–ª–∞–Ω—Å–µ.")
        conn.close()
        return

    # –°—Ç–∞—Ç—É—Å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    status_message = await update.message.reply_text(
        f"üì§ <b>–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è...</b>\n\n"
        f"<pre>üì± –ù–æ–º–µ—Ä –ø–æ–ª—É—á–∞—Ç–µ–ª—è: {phone_number}</pre>\n"
        f"üë§ –ü–æ–ª—É—á–∞—Ç–µ–ª—å: –ü–æ–∏—Å–∫...\n"
        f"<pre>‚è≥ | –°—Ç–∞—Ç—É—Å: –ü–æ–∏—Å–∫ –∫–æ–Ω—Ç–∞–∫—Ç–∞</pre>",
        parse_mode="HTML"
    )

    await asyncio.sleep(1.5)  # –∏–º–∏—Ç–∞—Ü–∏—è –ø–æ–∏—Å–∫–∞ –∫–æ–Ω—Ç–∞–∫—Ç–∞

    # –ü–æ–ª—É—á–∞–µ–º user_id –ø–æ–ª—É—á–∞—Ç–µ–ª—è –ø–æ –Ω–æ–º–µ—Ä—É —Ç–µ–ª–µ—Ñ–æ–Ω–∞
    cursor.execute("SELECT user_id FROM sim_cards WHERE phone_number = ?", (phone_number,))
    result = cursor.fetchone()
    if not result:
        await status_message.edit_text(
            f"üì§ <b>–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è...</b>\n\n"
            f"<pre>üì± –ù–æ–º–µ—Ä: {phone_number}\n"
            f"üë§ –ü–æ–ª—É—á–∞—Ç–µ–ª—å: –ö–æ–Ω—Ç–∞–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω\n"
            f"‚ùå | –°—Ç–∞—Ç—É—Å: –û—Ç–º–µ–Ω–µ–Ω–æ</pre>",
            parse_mode="HTML"
        )
        conn.close()
        return

    recipient_id = result[0]
    recipient_display = f'<a href="tg://user?id={recipient_id}">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</a>'

    # –ü–∏—à–µ–º, —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è
    await status_message.edit_text(
        f"üì§ <b>–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è...</b>\n\n"
        f"<pre>üì± –ù–æ–º–µ—Ä: {phone_number}</pre>\n"
        f"üë§ –ü–æ–ª—É—á–∞—Ç–µ–ª—å: {recipient_display}\n"
        f"<pre>‚è≥ | –°—Ç–∞—Ç—É—Å: –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è...</pre>",
        parse_mode="HTML"
    )

    await asyncio.sleep(1.5)  # –∏–º–∏—Ç–∞—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏

    # –§–æ—Ä–º–∏—Ä—É–µ–º —à–∞–ø–∫—É –¥–ª—è –ø–æ–ª—É—á–∞—Ç–µ–ª—è
    header = (
        f"üì© <b>–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</b>\n\n"
        f"üë§ <b>–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å:</b> {sender_display}\n"
        f"üì± <b>–ù–æ–º–µ—Ä:</b> <code>{sender_phone}</code>\n\n"
        f"üí¨ <b>–°–æ–æ–±—â–µ–Ω–∏–µ:</b>\n{text_message}"
    )

    try:
        # –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç–∞
        await context.bot.send_message(
            chat_id=recipient_id,
            text=header,
            parse_mode="HTML"
        )

        # üü¢ –°–ø–∏—Å—ã–≤–∞–µ–º 1 SMS —Å –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
        cursor.execute("UPDATE sim_cards SET sms = sms - 1 WHERE user_id = ?", (sender_id,))
        conn.commit()

        # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
        await status_message.edit_text(
            f"üì¨ <b>–°–æ–æ–±—â–µ–Ω–∏–µ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ</b>\n\n"
            f"<pre>üì± –ù–æ–º–µ—Ä: {phone_number}</pre>\n"
            f"üë§ –ü–æ–ª—É—á–∞—Ç–µ–ª—å: {recipient_display}\n"
            f"<pre>‚úÖ | –°—Ç–∞—Ç—É—Å: –î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ</pre>\n\n"
            f"üìâ –û—Å—Ç–∞–ª–æ—Å—å SMS: {sms_balance - 1}",
            parse_mode="HTML"
        )

    except Exception as e:
        await status_message.edit_text(
            f"üì§ <b>–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è</b>\n\n"
            f"üì± <b>–ù–æ–º–µ—Ä:</b> <code>{phone_number}</code>\n"
            f"üë§ <b>–ü–æ–ª—É—á–∞—Ç–µ–ª—å:</b> {recipient_display}\n"
            f"‚ö†Ô∏è <b>–°—Ç–∞—Ç—É—Å:</b> –°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ\n\n"
            f"‚ÑπÔ∏è –í–æ–∑–º–æ–∂–Ω–æ, –ø–æ–ª—É—á–∞—Ç–µ–ª—å –µ—â—ë –Ω–µ –Ω–∞—á–∞–ª –¥–∏–∞–ª–æ–≥ —Å –±–æ—Ç–æ–º.\n\n"
            f"–û—à–∏–±–∫–∞: {e}",
            parse_mode="HTML"
        )

    conn.close()


async def phone_back(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query

    callback_user_id = int(query.data.split(":")[1])
    if query.from_user.id != callback_user_id:
        await query.answer("–≠—Ç–∞ –∫–Ω–æ–ø–∫–∞ –Ω–µ –¥–ª—è –≤–∞—Å!", show_alert=True)
        return

    await phone_menu(update, context)


async def daily_tariff_payment():
    while True:
        now = datetime.now()
        target_time = now.replace(hour=13, minute=31, second=0, microsecond=0)
        if now >= target_time:
            target_time += timedelta(days=1)

        wait_seconds = (target_time - now).total_seconds()
        print(f"[{datetime.now()}] ‚è≥ –ñ–¥–µ–º {wait_seconds} —Å–µ–∫—É–Ω–¥ –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–ø–∏—Å–∞–Ω–∏—è...")
        await asyncio.sleep(wait_seconds)

        with sqlite3.connect(DB_PATH) as conn:
            cursor = conn.cursor()
            cursor.execute("SELECT user_id, operator, tariff, balance FROM sim_cards")
            all_users = cursor.fetchall()

            for user_id, operator, tariff_name, balance in all_users:
                tariff_info = next(
                    ((name, sms, price) for name, sms, price in TARIFFS[operator] if name == tariff_name),
                    None
                )
                if not tariff_info:
                    continue

                _, sms_count, price = tariff_info

                if balance >= price:
                    new_balance = balance - price
                    cursor.execute(
                        "UPDATE sim_cards SET balance = ?, sms = ?, status_tariff = ? WHERE user_id = ?",
                        (new_balance, sms_count, "–ê–∫—Ç–∏–≤–µ–Ω", user_id)
                    )
                    print(
                        f"[{datetime.now()}] ‚úÖ –°–ø–∏—Å–∞–Ω–æ {price} ‚ÇΩ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}, SMS –æ–±–Ω–æ–≤–ª–µ–Ω–æ: {sms_count}")
                else:
                    cursor.execute(
                        "UPDATE sim_cards SET sms = ?, status_tariff = ? WHERE user_id = ?",
                        (0, "–¢–∞—Ä–∏—Ñ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω", user_id)
                    )
                    print(f"[{datetime.now()}] ‚ö†Ô∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –∏–∑-–∑–∞ –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–∞ —Å—Ä–µ–¥—Å—Ç–≤")

            conn.commit()


def add_vip_columns():
    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()

        # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –∫–æ–ª–æ–Ω–æ–∫ —Ç–∞–±–ª–∏—Ü—ã users
        cursor.execute("PRAGMA table_info(users)")
        columns = [info[1] for info in cursor.fetchall()]

        # –î–æ–±–∞–≤–ª—è–µ–º vip_level, –µ—Å–ª–∏ –Ω–µ—Ç
        if "vip_level" not in columns:
            cursor.execute("ALTER TABLE users ADD COLUMN vip_level INTEGER DEFAULT 0")
            print("–î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ vip_level")

        # –î–æ–±–∞–≤–ª—è–µ–º vip_expiry, –µ—Å–ª–∏ –Ω–µ—Ç
        if "vip_expiry" not in columns:
            cursor.execute("ALTER TABLE users ADD COLUMN vip_expiry TEXT DEFAULT NULL")
            print("–î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ vip_expiry")

        conn.commit()
        print("–ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–ª–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω—ã")


ADMINS_LICENSE_FILE = "admins_license.json"


def load_admins_license():
    try:
        with open(ADMINS_LICENSE_FILE, "r", encoding="utf-8") as f:
            return json.load(f)
    except (FileNotFoundError, json.JSONDecodeError):
        return {}


def get_user_first_name_for_license(user_id):
    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()
        cursor.execute("SELECT first_name FROM users WHERE user_id = ?", (str(user_id),))
        result = cursor.fetchone()
        return result[0] if result else "‚Äî"


def get_user_status_for_license(user_id):
    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()
        cursor.execute("SELECT status FROM users WHERE user_id = ?", (str(user_id),))
        result = cursor.fetchone()
        return result[0] if result else 0  # 0 –∏–ª–∏ –ø—Ä–æ—á–µ—Ä–∫ "‚Äî" –µ—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω


def get_user_status_name(user_id):
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ user_id"""
    status_index = get_user_status_for_license(user_id)
    if isinstance(status_index, int) and 0 <= status_index < len(STATUS_LIST):
        return STATUS_LIST[status_index]
    return "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ä–∞–Ω–≥"


TEMPLATE_PATH = "license_template.png"  # —Ç–≤–æ–π –ø—É—Å—Ç–æ–π —à–∞–±–ª–æ–Ω
FONT_PATH = "ARIBLK.TTF"  # —à—Ä–∏—Ñ—Ç, –ø–æ–ª–æ–∂–∏ –≤ –ø–∞–ø–∫—É —Ä—è–¥–æ–º —Å –±–æ—Ç–æ–º


def generate_license_image(display_name, target_id, status, date, serial):
    # –ó–∞–≥—Ä—É–∂–∞–µ–º —à–∞–±–ª–æ–Ω
    img = Image.open(TEMPLATE_PATH).convert("RGBA")
    draw = ImageDraw.Draw(img)

    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —à—Ä–∏—Ñ—Ç–∞
    font_big = ImageFont.truetype(FONT_PATH, 42)
    font_small = ImageFont.truetype(FONT_PATH, 36)

    # –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø–æ–¥ —Ç–≤–æ–π –º–∞–∫–µ—Ç (–ø–æ–¥–≥–æ–Ω—è–ª–∏—Å—å –ø–æ–¥ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ)
    draw.text((548, 457), display_name, font=font_big, fill="white")  # NickName
    draw.text((444, 525), str(status), font=font_big, fill="white")  # Status
    draw.text((564, 601), date, font=font_big, fill="white")  # –î–∞—Ç–∞
    draw.text((1020, 812), str(target_id), font=font_small, fill="white")  # ID
    draw.text((2, 812), serial, font=font_small, fill="white")  # Serial

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ø–∞–º—è—Ç—å
    bio = io.BytesIO()
    bio.name = "license.png"
    img.save(bio, "PNG")
    bio.seek(0)
    return bio


async def license_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    args = context.args
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º target_id: –∞—Ä–≥—É–º–µ–Ω—Ç –∫–æ–º–∞–Ω–¥—ã > –æ—Ç–≤–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ > –∞–≤—Ç–æ—Ä
    if args:
        target_id = args[0]
    elif update.message.reply_to_message:
        target_id = str(update.message.reply_to_message.from_user.id)
    else:
        target_id = str(update.effective_user.id)

    msg = await update.message.reply_text("üîç –ü–æ–∏—Å–∫/–≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ª–∏—Ü–µ–Ω–∑–∏–∏...")
    await asyncio.sleep(2)

    admins_license = load_admins_license()
    if target_id not in admins_license:
        await msg.edit_text("‚ùå –õ–∏—Ü–µ–Ω–∑–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.")
        return

    data = admins_license[target_id]
    date = data.get("date", "‚Äî")
    serial = data.get("serial", "‚Äî")

    # –î–ª—è —Ç–µ–∫—Å—Ç–∞ HTML
    fake_user = User(id=int(target_id), first_name="", is_bot=False)
    display_name_html = get_display_name_html_new(fake_user)

    # –î–ª—è –∫–∞—Ä—Ç–∏–Ω–∫–∏ ‚Äî —á–∏—Å—Ç—ã–π —Ç–µ–∫—Å—Ç –±–µ–∑ HTML
    display_name_text = get_user_first_name_for_license(target_id)

    status_name = get_user_status_name(target_id)

    # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–∞—Ä—Ç–∏–Ω–∫–∏ –ª–∏—Ü–µ–Ω–∑–∏–∏
    photo = generate_license_image(display_name_text, target_id, status_name, date, serial)

    # –¢–µ–∫—Å—Ç —Å —ç–º–æ–¥–∑–∏
    caption = (
        f"ü™™ <b>–õ–∏—Ü–µ–Ω–∑–∏—è –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</b>\n"
        f"üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {display_name_html}\n"
        f"üÜî ID: <code>{target_id}</code>\n"
        f"‚≠ê –°—Ç–∞—Ç—É—Å: <b>{status_name}</b>\n"
        f"üî¢ –°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä: <code>{serial}</code>\n"
        f"üìÖ –ü–æ—Å—Ç–∞–≤–ª–µ–Ω: {date}\n\n"
    )

    await msg.delete()
    await update.message.reply_photo(photo=photo, caption=caption, parse_mode=ParseMode.HTML)


async def slic_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    args = context.args
    if not args:
        await update.message.reply_text("‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /slic {—Å–µ—Ä–∏–π–Ω—ã–π_–Ω–æ–º–µ—Ä}")
        return

    serial_input = args[0]

    # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–∞—á–∞–ª–µ –ø–æ–∏—Å–∫–∞
    msg = await update.message.reply_text("üîç –ü–æ–∏—Å–∫ –ª–∏—Ü–µ–Ω–∑–∏–∏ –ø–æ —Å–µ—Ä–∏–π–Ω–æ–º—É –Ω–æ–º–µ—Ä—É...")
    await asyncio.sleep(2)

    admins_license = load_admins_license()
    target_id, data = None, None
    for uid, info in admins_license.items():
        if info.get("serial") == serial_input:
            target_id, data = uid, info
            break

    if not target_id:
        await msg.edit_text("‚ùå –õ–∏—Ü–µ–Ω–∑–∏—è —Å —Ç–∞–∫–∏–º —Å–µ—Ä–∏–π–Ω—ã–º –Ω–æ–º–µ—Ä–æ–º –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.")
        return

    date = data.get("date", "‚Äî")
    serial = data.get("serial", "‚Äî")

    # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç—É—Å –≤–ª–∞–¥–µ–ª—å—Ü–∞ –ª–∏—Ü–µ–Ω–∑–∏–∏
    status_name = get_user_status_name(target_id)

    # –î–ª—è —Ç–µ–∫—Å—Ç–∞ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏ ‚Äî –∏–º—è –≤–ª–∞–¥–µ–ª—å—Ü–∞
    display_name_text = get_user_first_name_for_license(target_id)

    # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–∞—Ä—Ç–∏–Ω–∫–∏ –ª–∏—Ü–µ–Ω–∑–∏–∏
    photo = generate_license_image(display_name_text, target_id, status_name, date, serial)

    # –î–ª—è —Ç–µ–∫—Å—Ç–∞ HTML
    fake_user = User(id=int(target_id), first_name="", is_bot=False)
    display_name_html = get_display_name_html_new(fake_user)

    caption = (
        f"ü™™ <b>–õ–∏—Ü–µ–Ω–∑–∏—è –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</b>\n"
        f"üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {display_name_html}\n"
        f"üÜî ID: <code>{target_id}</code>\n"
        f"‚≠ê –°—Ç–∞—Ç—É—Å: <b>{status_name}</b>\n"
        f"üî¢ –°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä: <code>{serial}</code>\n"
        f"üìÖ –ü–æ—Å—Ç–∞–≤–ª–µ–Ω: {date}\n\n"
    )

    await msg.delete()
    await update.message.reply_photo(photo=photo, caption=caption, parse_mode=ParseMode.HTML)

def parse_amount(amount_str: str) -> Decimal:
    s = amount_str.lower().replace(" ", "").replace(",", "").replace(".", "")

    # —Å—á–∏—Ç–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ '–∫' –≤ –∫–æ–Ω—Ü–µ
    k_count = 0
    while s.endswith("–∫"):
        k_count += 1
        s = s[:-1]

    if not s.isdigit():
        raise ValueError("Invalid amount")

    base = int(s)
    multiplier = 1000 ** k_count

    return Decimal(base * multiplier)

async def charity_command(update, context):
    if not context.args:
        await update.message.reply_text(
            "üíñ –£–∫–∞–∂–∏—Ç–µ —Å—É–º–º—É:\n"
            "<pre>/–±–ª–∞–≥–æ {—Å—É–º–º–∞}</pre>\n\n"
            "–ü—Ä–∏–º–µ—Ä—ã:\n"
            "‚Ä¢ /–±–ª–∞–≥–æ 1000\n"
            "‚Ä¢ /–±–ª–∞–≥–æ 3–∫\n"
            "‚Ä¢ /–±–ª–∞–≥–æ –≤—Å–µ",
            parse_mode="HTML"
        )
        return

    user = update.effective_user
    user_id = str(user.id)
    username = user.username or ""

    # –ü–æ–ª—É—á–∞–µ–º –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()
        cursor.execute("SELECT balance FROM users WHERE user_id = ?", (user_id,))
        result = cursor.fetchone()

        if not result:
            await update.message.reply_text("‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω.")
            return

        user_balance = Decimal(result[0])

    amount_str = context.args[0].lower()

    # /–±–ª–∞–≥–æ –≤—Å–µ | –≤—Å—ë
    if amount_str in ("–≤—Å–µ", "–≤—Å—ë"):
        donation = user_balance
        if donation <= 0:
            await update.message.reply_text("‚ùå –£ –≤–∞—Å –Ω–µ—Ç —Å—Ä–µ–¥—Å—Ç–≤ –¥–ª—è –ø–æ–∂–µ—Ä—Ç–≤–æ–≤–∞–Ω–∏—è.")
            return
    else:
        try:
            donation = parse_amount(amount_str)
        except Exception:
            await update.message.reply_text(
                "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Å—É–º–º—ã.\n\n"
                "–ü—Ä–∏–º–µ—Ä—ã:\n"
                "‚Ä¢ /–±–ª–∞–≥–æ 1000\n"
                "‚Ä¢ /–±–ª–∞–≥–æ 3–∫\n"
                "‚Ä¢ /–±–ª–∞–≥–æ –≤—Å–µ"
            )
            return

    if donation <= 0:
        await update.message.reply_text("‚ùå –°—É–º–º–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –±–æ–ª—å—à–µ –Ω—É–ª—è.")
        return

    if donation > user_balance:
        await update.message.reply_text("‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤.")
        return

    # –†–∞–±–æ—Ç–∞ —Å –±–∞–∑–æ–π
    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()

        new_balance = user_balance - donation
        cursor.execute(
            "UPDATE users SET balance = ? WHERE user_id = ?",
            (str(new_balance), user_id)
        )

        now = datetime.utcnow().strftime("%Y-%m-%d %H:%M:%S")
        cursor.execute(
            "INSERT INTO charity (user_id, username, donation_amount, donated_at) "
            "VALUES (?, ?, ?, ?)",
            (user_id, username, str(donation), now)
        )

        # –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ñ–æ–Ω–¥–∞
        cursor.execute("SELECT SUM(donation_amount) FROM charity")
        result = cursor.fetchone()
        total_balance = Decimal(result[0]) if result[0] else Decimal(0)

        cursor.execute(
            "INSERT OR IGNORE INTO charity_balance (id, total_balance) "
            "VALUES (1, '0')"
        )
        cursor.execute(
            "UPDATE charity_balance SET total_balance = ? WHERE id = 1",
            (str(total_balance),)
        )

        conn.commit()

    display_name = get_display_name_html_new(user)
    await update.message.reply_text(
        f"üíñ {display_name} —Å–¥–µ–ª–∞–ª(–∞) –ø–æ–∂–µ—Ä—Ç–≤–æ–≤–∞–Ω–∏–µ!\n"
        f"üí∞ –°—É–º–º–∞: <b>{donation} ‚ÇΩ</b>\n"
        f"üôè –°–ø–∞—Å–∏–±–æ –∑–∞ –ø–æ–¥–¥–µ—Ä–∂–∫—É —Ñ–æ–Ω–¥–∞!",
        parse_mode="HTML"
    )


IMAGE_PATH = "blagofond.png"  # –ø—É—Ç—å –∫ –ª–æ–∫–∞–ª—å–Ω–æ–º—É —Ñ–∞–π–ª—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è


async def blagofond_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    try:
        # –ü–æ–ª—É—á–∞–µ–º –æ–±—â–∏–π –±–∞–ª–∞–Ω—Å —Ñ–æ–Ω–¥–∞
        with sqlite3.connect(DB_PATH) as conn:
            cursor = conn.cursor()
            cursor.execute("SELECT total_balance FROM charity_balance WHERE id = 1")
            result = cursor.fetchone()
            total_balance = Decimal(result[0]) if result else Decimal(0)

        # –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞
        formatted_balance = f"{total_balance:,}".replace(",", ".")
        text = f"üíñ <b>–ë–ª–∞–≥–æ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω—ã–π –§–æ–Ω–¥.</b>\nüí∞ –ë–∞–ª–∞–Ω—Å —Ñ–æ–Ω–¥–∞: <b>{formatted_balance}‚ÇΩ</b>"

        # –ü—ã—Ç–∞–µ–º—Å—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
        try:
            with open(IMAGE_PATH, "rb") as photo:
                input_file = InputFile(photo, filename="blagofond.png")

                if update.message:
                    await update.message.reply_photo(
                        photo=input_file,
                        caption=text,
                        parse_mode="HTML"
                    )
                elif update.callback_query:
                    await update.callback_query.message.reply_photo(
                        photo=input_file,
                        caption=text,
                        parse_mode="HTML"
                    )

        except FileNotFoundError:
            logging.error(f"–§–∞–π–ª {IMAGE_PATH} –Ω–µ –Ω–∞–π–¥–µ–Ω.")
            error_message = f"‚ö†Ô∏è –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ñ–æ–Ω–¥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ ({IMAGE_PATH})."
            if update.message:
                await update.message.reply_text(error_message, parse_mode="HTML")
            elif update.callback_query:
                await update.callback_query.message.reply_text(error_message, parse_mode="HTML")

    except Exception as e:
        logging.error(f"–û—à–∏–±–∫–∞ –≤ blagofond_command: {e}")
        error_message = "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ñ–æ–Ω–¥–µ."
        if update.message:
            await update.message.reply_text(error_message)
        elif update.callback_query:
            await update.callback_query.message.reply_text(error_message)


pending_rewards = {}


def format_number_rewarding(num: int) -> str:
    return f"{num:,}".replace(",", ".")


# --- /rewarding ---
async def rewarding_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if update.effective_chat.type != "private":
        await update.message.reply_text("‚ùå –≠—Ç—É –∫–æ–º–∞–Ω–¥—É –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –≤ –õ–° –±–æ—Ç—É.")
        return

    caller_id = str(update.effective_user.id)

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT status FROM users WHERE user_id = ?", (caller_id,))
    row = cursor.fetchone()
    conn.close()

    if not row or row[0] < 10:
        await update.message.reply_text("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥–µ.")
        return

    if len(context.args) < 3:
        await update.message.reply_text(
            "‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:\n"
            "/rewarding {telegramID} {—Å—É–º–º–∞} {—Ç–∏–ø –Ω–∞–≥—Ä–∞–¥—ã}\n"
            "{—Ç–µ–∫—Å—Ç (—Å–æ —Å–ª–µ–¥—É—é—â–µ–π —Å—Ç—Ä–æ–∫–∏)}\n\n"
            "–¢–∏–ø—ã –Ω–∞–≥—Ä–∞–¥—ã:\n1 ‚Äî –†—É–±–ª–∏ ‚ÇΩ\n2 ‚Äî DC\n3 ‚Äî –°–µ–º–µ–Ω–∞ üå±"
        )
        return

    user_id = context.args[0]
    amount = context.args[1]
    reward_type = context.args[2]

    try:
        amount = int(amount)
        reward_type = int(reward_type)
    except ValueError:
        await update.message.reply_text("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤. –°—É–º–º–∞ –∏ —Ç–∏–ø –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —á–∏—Å–ª–∞–º–∏.")
        return

    # –¢–µ–∫—Å—Ç
    reward_text = update.message.text.split("\n", 1)[1].strip() if "\n" in update.message.text else ""

    reward_names = {1: "–†—É–±–ª–∏ ‚ÇΩ", 2: "DC", 3: "–°–µ–º–µ–Ω–∞ üå±"}
    reward_name = reward_names.get(reward_type, "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ")

    # –ò–º—è –∏–∑ –ë–î
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT first_name, nickname FROM users WHERE user_id = ?", (user_id,))
    result = cursor.fetchone()
    conn.close()

    display_name = html.escape(result[1] or result[0]) if result else f"ID:{user_id}"
    display_html = f'<a href="tg://user?id={user_id}">{display_name}</a>'

    # --- —Å–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞–≥—Ä–∞–¥—É –≤–æ –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ ---
    reward_id = f"{user_id}:{amount}:{reward_type}"
    pending_rewards[reward_id] = reward_text

    text = (
        f"üì¢ <b>–ó–∞—á–∏—Å–ª–µ–Ω–∏–µ –≤–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏—è</b>\n\n"
        f"üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {display_html}\n"
        f"üíµ –°—É–º–º–∞: <b>{amount}</b>\n"
        f"üíé –¢–∏–ø: <b>{reward_name}</b>\n"
        f"üìù –¢–µ–∫—Å—Ç: {html.escape(reward_text) if reward_text else '‚Äî'}"
    )

    keyboard = InlineKeyboardMarkup([[
        InlineKeyboardButton("‚úÖ –ù–∞–≥—Ä–∞–¥–∏—Ç—å", callback_data=f"reward_confirm:{reward_id}"),
        InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data="reward_cancel")
    ]])

    await update.message.reply_text(text, reply_markup=keyboard, parse_mode="HTML")


# --- CALLBACK ---
async def reward_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    data = query.data
    await query.answer()

    if data == "reward_cancel":
        await query.edit_message_text("‚ùå –û–ø–µ—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.")
        return

    if data.startswith("reward_confirm:"):
        _, user_id, amount, reward_type = data.split(":")
        reward_id = f"{user_id}:{amount}:{reward_type}"

        reward_text = pending_rewards.pop(reward_id, "")

        amount = int(amount)
        reward_type = int(reward_type)

        # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤ –ë–î
        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()
        if reward_type == 1:
            cursor.execute("UPDATE users SET balance = balance + ? WHERE user_id = ?", (amount, user_id))
            reward_name = "–†—É–±–ª–∏ ‚ÇΩ"
        elif reward_type == 2:
            cursor.execute("UPDATE users SET dc_balance = dc_balance + ? WHERE user_id = ?", (amount, user_id))
            reward_name = "DC"
        elif reward_type == 3:
            cursor.execute("UPDATE users SET seeds = seeds + ? WHERE user_id = ?", (amount, user_id))
            reward_name = "–°–µ–º–µ–Ω–∞ üå±"
        else:
            conn.close()
            await query.answer("‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø –Ω–∞–≥—Ä–∞–¥—ã.", show_alert=True)
            return
        conn.commit()
        conn.close()

        # –õ–° –ø–æ–ª—É—á–∞—Ç–µ–ª—é
        try:
            await context.bot.send_message(
                chat_id=int(user_id),
                text=(
                    f"üéâ <b>–í–∞–º –Ω–∞—á–∏—Å–ª–µ–Ω–∞ –Ω–∞–≥—Ä–∞–¥–∞!</b>\n\n"
                    f"üíµ –°—É–º–º–∞: <b>{format_number_rewarding(amount)}</b>\n"
                    f"üíé –¢–∏–ø: <b>{reward_name}</b>\n"
                    f"üìù {html.escape(reward_text) if reward_text else '‚Äî'}"
                ),
                parse_mode="HTML"
            )
        except Exception:
            pass  # –µ—Å–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∑–∞–∫—Ä—ã—Ç—ã –õ–°

        # –û—Ç–≤–µ—Ç –∞–¥–º–∏–Ω—É
        await query.edit_message_text(
            f"‚úÖ –ù–∞–≥—Ä–∞–¥–∞ –≤—ã–¥–∞–Ω–∞!\n"
            f"üë§ ID: {user_id}\n"
            f"üíµ {format_number_rewarding(amount)}\n"
            f"üíé {reward_name}\n"
            f"üìù {reward_text if reward_text else '‚Äî'}",
            parse_mode="HTML"
        )


DIGITAL_SHOP_ITEMS = [
    {"name": "–ö–∞–∑–∏–Ω–æ", "price": 30000, "type": "–∫–∞–∑–∏–Ω–æ"},
    {"name": "–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –ë–∞–Ω–∫", "price": 1000000, "type": "–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –ë–∞–Ω–∫"},
    #   {"name": "–¢–æ–≤–∞—Ä 10", "price": 10000000},
]

ITEMS_PER_PAGE = 5


def get_display_name_html_new(user):
    user_id = str(user.id)
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT nickname, first_name FROM users WHERE user_id = ?", (user_id,))
    result = cursor.fetchone()
    conn.close()

    if result:
        nickname, first_name_db = result
    else:
        nickname = None
        first_name_db = None

    if nickname:
        display = html.escape(nickname).replace("#", "&#35;")
    else:
        first = first_name_db or user.first_name or ""
        full_name = first.strip() or "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"
        display = html.escape(full_name).replace("#", "&#35;")
    return f'<a href="tg://user?id={user_id}">{display}</a>'


def format_number(n: int) -> str:
    return "{:,}".format(n).replace(",", ".")


async def dchop_command(update: Update, context: ContextTypes.DEFAULT_TYPE, page=1):
    user = update.effective_user
    user_id = str(user.id)
    page = int(context.args[0]) if context.args and context.args[0].isdigit() else page
    total_pages = (len(DIGITAL_SHOP_ITEMS) + ITEMS_PER_PAGE - 1) // ITEMS_PER_PAGE

    page = max(1, min(page, total_pages))
    start = (page - 1) * ITEMS_PER_PAGE
    end = start + ITEMS_PER_PAGE
    items_on_page = DIGITAL_SHOP_ITEMS[start:end]

    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT dc_balance FROM users WHERE user_id = ?", (user_id,))
    result = cursor.fetchone()
    conn.close()
    dc_balance = result[0] if result else 0

    text = f"üíª <b>Digital Shop | {get_display_name_html_new(user)}</b>\n"
    text += f"üí∞ –í–∞—à –±–∞–ª–∞–Ω—Å: {format_number(dc_balance)} DC\n–í—ã–±–µ—Ä–∏—Ç–µ –∂–µ–ª–∞–µ–º—ã–π —Ç–æ–≤–∞—Ä:\n"

    buttons = []
    for item in items_on_page:
        buttons.append([InlineKeyboardButton(item["name"],
                                             callback_data=f"dchop_item:{user_id}:{DIGITAL_SHOP_ITEMS.index(item)}")])

    nav_buttons = []
    if page > 1:
        nav_buttons.append(InlineKeyboardButton("‚¨Ö", callback_data=f"dchop_page:{user_id}:{page - 1}"))
    nav_buttons.append(InlineKeyboardButton(f"{page}/{total_pages}", callback_data="noop"))
    if page < total_pages:
        nav_buttons.append(InlineKeyboardButton("‚û°", callback_data=f"dchop_page:{user_id}:{page + 1}"))
    buttons.insert(0, nav_buttons)

    keyboard = InlineKeyboardMarkup(buttons)

    if update.message:
        await update.message.reply_html(text, reply_markup=keyboard)
    elif update.callback_query:
        await update.callback_query.edit_message_text(text, reply_markup=keyboard, parse_mode="HTML")


# ----------------- CALLBACK -----------------
async def dchop_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    user = query.from_user
    user_id = str(user.id)
    parts = query.data.split(":")
    action = parts[0]

    if action in ["dchop_page", "dchop_item", "dchop_buy", "dchop_open", "dc_menu"]:
        owner_id = parts[1]
        if owner_id != user_id:
            await query.answer("‚ùå –¢–æ–ª—å–∫–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å –∫–æ–º–∞–Ω–¥—ã –º–æ–∂–µ—Ç –Ω–∞–∂–∏–º–∞—Ç—å —ç—Ç–∏ –∫–Ω–æ–ø–∫–∏.", show_alert=True)
            return

    if action == "dchop_open":
        page = int(parts[2])
        context.args = [str(page)]
        await dchop_command(update, context)
        await query.answer()
        return

    if action == "dc_menu":
        # –í–æ–∑–≤—Ä–∞—Ç –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
        await dcchange_command(update, context)
        await query.answer()
        return

    if action == "dchop_page":
        page = int(parts[2])
        context.args = [str(page)]
        await dchop_command(update, context)
        await query.answer()
        return

    elif action == "dchop_item":
        # –ù–ï –¢–†–û–ì–ê–¢–¨ —ç—Ç–æ—Ç –±–ª–æ–∫
        index = int(parts[2])
        item = DIGITAL_SHOP_ITEMS[index]

        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()
        cursor.execute("SELECT dc_balance FROM users WHERE user_id = ?", (user_id,))
        dc_balance = cursor.fetchone()[0]
        conn.close()

        sufficient = dc_balance >= item["price"]
        status_text = "–î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ ‚úÖ" if sufficient else f"–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ ‚ùå ({format_number(item['price'] - dc_balance)} DC)"

        text = f"üíª <b>Digital Shop | {get_display_name_html_new(user)}</b>\n"
        text += f"üí∞ –í–∞—à –±–∞–ª–∞–Ω—Å: {format_number(dc_balance)} DC\n"
        text += f"üõí –¢–æ–≤–∞—Ä: {item['name']}\n"
        text += f"üíµ –¶–µ–Ω–∞: {format_number(item['price'])} DC\n"
        text += f"üí≥ –°—Ä–µ–¥—Å—Ç–≤–∞: {status_text}\n"

        keyboard = InlineKeyboardMarkup([
            [
                InlineKeyboardButton("üõí –ö—É–ø–∏—Ç—å", callback_data=f"dchop_buy:{user_id}:{index}"),
                # –ö–Ω–æ–ø–∫–∞ –ù–∞–∑–∞–¥ –≤ —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤
                InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data=f"dchop_page:{user_id}:1")
            ]
        ])

        await query.edit_message_text(text, reply_markup=keyboard, parse_mode="HTML")
        await query.answer()
        return

    elif action == "dchop_buy":
        index = int(parts[2])
        item = DIGITAL_SHOP_ITEMS[index]

        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()
        cursor.execute("SELECT dc_balance FROM users WHERE user_id = ?", (user_id,))
        dc_balance = cursor.fetchone()[0]

        if dc_balance < item["price"]:
            conn.close()
            await query.answer("‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –¥–ª—è –ø–æ–∫—É–ø–∫–∏.", show_alert=True)
            return

        item_type = item.get("type", "")

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞ –±–∏–∑–Ω–µ—Å–æ–≤ –ø–æ VIP
        current_business_count = get_user_businesses_count(user_id)
        if not can_buy_business(user_id, current_business_count):
            conn.close()
            await query.edit_message_text(
                f"üíª <b>Digital Shop | {get_display_name_html_new(user)}</b>\n"
                f"‚ùó –í—ã –¥–æ—Å—Ç–∏–≥–ª–∏ –ª–∏–º–∏—Ç–∞ –±–∏–∑–Ω–µ—Å–æ–≤ –¥–ª—è –≤–∞—à–µ–≥–æ VIP-—É—Ä–æ–≤–Ω—è.",
                parse_mode="HTML"
            )
            await query.answer()
            return

        # –ü—Ä–æ–≤–µ—Ä–∫–∞: —É–∂–µ –µ—Å—Ç—å —Ç–∞–∫–æ–π –±–∏–∑–Ω–µ—Å (–∫–∞–∑–∏–Ω–æ –∏–ª–∏ –¶–ë ‚Äî —Ç–æ–ª—å–∫–æ 1 —à—Ç—É–∫–∞)
        if item_type.lower() in ("–∫–∞–∑–∏–Ω–æ", "—Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –±–∞–Ω–∫"):
            cursor.execute(
                "SELECT COUNT(*) FROM businesses_XUI WHERE owner_id = ? AND business_type = ?",
                (user_id, item["name"])
            )
            already_owned = cursor.fetchone()[0]
            if already_owned > 0:
                conn.close()
                await query.answer(f"‚ùå –£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –±–∏–∑–Ω–µ—Å ¬´{item['name']}¬ª. –ù–µ–ª—å–∑—è –∫—É–ø–∏—Ç—å –≤—Ç–æ—Ä–æ–π.", show_alert=True)
                return

        # –°–ø–∏—Å—ã–≤–∞–µ–º –¥–µ–Ω—å–≥–∏
        cursor.execute("UPDATE users SET dc_balance = dc_balance - ? WHERE user_id = ?", (item["price"], user_id))
        conn.commit()
        conn.close()

        add_new_business(user_id, item["name"], 1)
        text = (
            f"üíª <b>Digital Shop | {get_display_name_html_new(user)}</b>\n"
            f"‚úÖ –ë–∏–∑–Ω–µ—Å: <b>{item['name']}</b>!\n\n"
            f"üí∞ –ë–∞–ª–∞–Ω—Å: <b>{format_number(dc_balance - item['price'])} DC</b>"
        )

        await query.edit_message_text(text, parse_mode="HTML")
        await query.answer()

ADMINS_FOR_POST = [7406372338]


def escape_markdown_v2(text: str) -> str:
    # –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º –≤—Å–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã MarkdownV2
    return re.sub(r'([_*\[\]()~`>#+\-=|{}.!])', r'\\\1', text)


async def postms(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    if user_id not in ADMINS_FOR_POST:
        await update.message.reply_text("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥–µ.")
        return

    if len(context.args) < 2:
        await update.message.reply_text("‚ùå –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /postms {TelegramID} {—Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è}")
        return

    try:
        target_id = int(context.args[0])
        message_text = update.message.text.split(maxsplit=2)[2]

        # –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –¥–ª—è MarkdownV2
        safe_text = escape_markdown_v2(message_text)

        await context.bot.send_message(
            chat_id=target_id,
            text=safe_text,
            parse_mode="MarkdownV2"
        )
        await update.message.reply_text("‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ.")
    except Exception as e:
        await update.message.reply_text(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ: {e}")


import sqlite3
import random
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import CommandHandler, CallbackQueryHandler, ContextTypes

DB_PATH = "FernieUI.db"


def parse_bet_input(raw_bet: str, balance: int) -> int | None:
    raw_bet = raw_bet.lower().replace(" ", "")
    if raw_bet in ["–≤—Å–µ", "–≤—Å—ë"]:
        return balance
    if raw_bet.startswith("%"):
        try:
            percent = int(raw_bet[1:])
            return max(1, (balance * percent) // 100) if 1 <= percent <= 100 else None
        except ValueError:
            return None
    if raw_bet.endswith(("–∫–∫", "kk")):
        try:
            return int(raw_bet[:-2]) * 1_000_000
        except ValueError:
            return None
    multipliers = {"k": 1_000, "–∫": 1_000, "m": 1_000_000, "–º": 1_000_000, "b": 1_000_000_000}
    for suf, mult in multipliers.items():
        if raw_bet.endswith(suf):
            try:
                return int(float(raw_bet[:-1].replace(",", "").replace(".", "")) * mult)
            except ValueError:
                return None
    clean = raw_bet.replace(".", "").replace(",", "")
    if clean.isdigit():
        return int(clean)
    return None


def get_or_create_user_coin_game(user_id: str, username: str, first_name: str) -> dict:
    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()
        cursor.execute("SELECT balance FROM users WHERE user_id = ?", (user_id,))
        row = cursor.fetchone()
        if not row:
            cursor.execute(
                "INSERT INTO users (user_id, username, first_name, balance) VALUES (?, ?, ?, ?)",
                (user_id, username, first_name, 1000)
            )
            conn.commit()
            return {"balance": 1000}
        return {"balance": row[0]}


async def coin_game(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    user_id = str(user.id)
    user_data = get_or_create_user_coin_game(user_id, user.username or "", user.first_name or "")
    balance = user_data["balance"]

    display_name = get_display_name_html_new(user)

    args = context.args
    if not args:
        await update.message.reply_text(
            f"üé≤ –ú–æ–Ω–µ—Ç–æ—á–∫–∞\n"
            f"üë§ –ò–≥—Ä–æ–∫: {display_name}\n"
            f"üí∞ –ë–∞–ª–∞–Ω—Å: {format_number(balance)} –º–æ–Ω–µ—Ç\n"
            f"–í–≤–µ–¥–∏—Ç–µ —Å—Ç–∞–≤–∫—É:\n–ü—Ä–∏–º–µ—Ä—ã: 500, –≤—Å–µ, %50, 3–∫–∫",
            parse_mode="HTML"
        )
        return

    raw_bet = args[0]
    bet = parse_bet_input(raw_bet, balance)
    if bet is None or bet <= 0:
        await update.message.reply_text("‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Å—Ç–∞–≤–∫–∞.")
        return
    if bet > balance:
        await update.message.reply_text(f"‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤. –ë–∞–ª–∞–Ω—Å: {format_number(balance)} –º–æ–Ω–µ—Ç.")
        return

    context.user_data["coin_bet"] = bet

    keyboard = [
        [
            InlineKeyboardButton("ü¶Ö –û—Ä—ë–ª", callback_data="coin_heads"),
            InlineKeyboardButton("üé≤ –†–µ—à–∫–∞", callback_data="coin_tails")
        ],
        [InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data="coin_cancel")]
    ]
    markup = InlineKeyboardMarkup(keyboard)

    await update.message.reply_text(
        f"üé≤ –ú–æ–Ω–µ—Ç–æ—á–∫–∞\n"
        f"üë§ –ò–≥—Ä–æ–∫: {display_name}\n"
        f"üí∞ –°—Ç–∞–≤–∫–∞: {format_number(bet)}‚ÇΩ\n"
        f"–ö–µ–º –≤—ã –±—É–¥–µ—Ç–µ?",
        reply_markup=markup,
        parse_mode="HTML"
    )


async def coin_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    user = query.from_user
    user_id = str(user.id)
    bet = context.user_data.get("coin_bet", 0)

    if query.data == "coin_cancel":
        await query.edit_message_text("‚ùå –ò–≥—Ä–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞.")
        context.user_data.pop("coin_bet", None)
        return

    if not bet:
        await query.edit_message_text("‚ùå –°–Ω–∞—á–∞–ª–∞ –≤–≤–µ–¥–∏—Ç–µ —Å—Ç–∞–≤–∫—É —á–µ—Ä–µ–∑ /coin.")
        return

    # –°–ª—É—á–∞–π–Ω–æ–µ –≤—ã–ø–∞–¥–µ–Ω–∏–µ –º–æ–Ω–µ—Ç–∫–∏ (–¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞)
    result = random.choice(["heads", "tails"])
    user_choice = "heads" if query.data == "coin_heads" else "tails"

    # 30% —à–∞–Ω—Å –ø–æ–±–µ–¥—ã
    win = random.randint(1, 100) <= 30

    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()
        coin_text = "–û—Ä—ë–ª" if result == "heads" else "–†–µ—à–∫–∞"
        display_name = get_display_name_html_new(user)

        if win:
            reward = bet * 2
            cursor.execute(
                "UPDATE users SET balance = balance + ? WHERE user_id = ?",
                (reward, user_id)
            )
            text = (
                f"üé≤ –ú–æ–Ω–µ—Ç–æ—á–∫–∞\n"
                f"üë§ –ò–≥—Ä–æ–∫: {display_name}\n"
                f"–í—ã–ø–∞–ª–æ: {coin_text}\n"
                f"‚úÖ –í—ã –≤—ã–∏–≥—Ä–∞–ª–∏ {format_number(reward)}‚ÇΩ!"
            )
        else:
            cursor.execute(
                "UPDATE users SET balance = balance - ? WHERE user_id = ?",
                (bet, user_id)
            )
            text = (
                f"üé≤ –ú–æ–Ω–µ—Ç–æ—á–∫–∞\n"
                f"üë§ –ò–≥—Ä–æ–∫: {display_name}\n"
                f"–í—ã–ø–∞–ª–æ: {coin_text}\n"
                f"‚ùå –í—ã –ø—Ä–æ–∏–≥—Ä–∞–ª–∏ {format_number(bet)}‚ÇΩ"
            )
        conn.commit()

    await query.edit_message_text(text, parse_mode="HTML")
    context.user_data.pop("coin_bet", None)


def get_user_contacts(user_id):
    conn = sqlite3.connect(DB_PATH)
    cur = conn.cursor()
    cur.execute("SELECT number, name FROM contacts WHERE user_id=?", (user_id,))
    rows = cur.fetchall()
    conn.close()
    return rows


# --- HANDLERS ---
async def add_contact(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    contacts = get_user_contacts(user_id)

    if len(contacts) >= 10:
        await update.message.reply_text(
            "‚ö† –£ –≤–∞—Å —É–∂–µ 10 –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤. –£–¥–∞–ª–∏—Ç–µ –æ–¥–∏–Ω, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π."
        )
        return

    if len(context.args) < 2:
        await update.message.reply_text(
            "‚ö† –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /add {–Ω–æ–º–µ—Ä} {–∏–º—è (–¥–æ 15 —Å–∏–º–≤–æ–ª–æ–≤)}"
        )
        return

    number = context.args[0]
    name = " ".join(context.args[1:])[:15]

    conn = sqlite3.connect(DB_PATH)
    cur = conn.cursor()
    cur.execute(
        "INSERT INTO contacts (user_id, number, name) VALUES (?, ?, ?)",
        (user_id, number, name),
    )
    conn.commit()
    conn.close()

    await update.message.reply_text(f"‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –∫–æ–Ω—Ç–∞–∫—Ç: {name} ({number})")


async def show_book(update: Update, context: ContextTypes.DEFAULT_TYPE):
    rows = get_user_contacts(update.effective_user.id)

    if not rows:
        await update.message.reply_text(
            "üìñ –í–∞—à —Å–ø–∏—Å–æ–∫ –ø—É—Å—Ç. –î–æ–±–∞–≤—å—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã —á–µ—Ä–µ–∑ /add"
        )
        return

    text = "\n".join(
        [f"{i + 1}. üë§ {name} ‚Äî üìû {number}" for i, (number, name) in enumerate(rows)]
    )

    async def show_book(update: Update, context: ContextTypes.DEFAULT_TYPE):
        rows = get_user_contacts(update.effective_user.id)

        if not rows:
            await update.message.reply_text(
                "üìñ –í–∞—à —Å–ø–∏—Å–æ–∫ –ø—É—Å—Ç. –î–æ–±–∞–≤—å—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã —á–µ—Ä–µ–∑ /add"
            )
            return

        text = "\n".join(
            [f"{i + 1}. üë§ {name} ‚Äî üìû {number}" for i, (number, name) in enumerate(rows)]
        )

        await update.message.reply_text(
            f"üìí *–í–∞—à–∏ –∫–æ–Ω—Ç–∞–∫—Ç—ã:*\n\n"
            f"{text}\n\n"
            f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
            f"‚öôÔ∏è *–°–∏—Å—Ç–µ–º–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:*\n"
            f"‚ûï /add ‚Äî –¥–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç\n"
            f"üìñ /book ‚Äî —Å–ø–∏—Å–æ–∫ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤\n"
            f"‚ùå /dcontact ‚Äî —É–¥–∞–ª–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç",
            parse_mode="Markdown"
        )


async def delete_contact(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    rows = get_user_contacts(user_id)

    if not rows:
        await update.message.reply_text("üìñ –°–ø–∏—Å–æ–∫ –ø—É—Å—Ç, —É–¥–∞–ª—è—Ç—å –Ω–µ—á–µ–≥–æ.")
        return

    if len(context.args) != 1 or not context.args[0].isdigit():
        await update.message.reply_text(
            "‚ö† –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /dcontact {–Ω–æ–º–µ—Ä –∏–∑ /book}"
        )
        return

    index = int(context.args[0]) - 1
    if index < 0 or index >= len(rows):
        await update.message.reply_text("‚ö† –ù–µ–≤–µ—Ä–Ω—ã–π –Ω–æ–º–µ—Ä –∫–æ–Ω—Ç–∞–∫—Ç–∞.")
        return

    number, name = rows[index]

    conn = sqlite3.connect(DB_PATH)
    cur = conn.cursor()
    cur.execute(
        "DELETE FROM contacts WHERE user_id=? AND number=? AND name=?",
        (user_id, number, name),
    )
    conn.commit()
    conn.close()

    await update.message.reply_text(f"‚ùå –ö–æ–Ω—Ç–∞–∫—Ç —É–¥–∞–ª—ë–Ω: {name} ({number})")


async def dox(update, context):
    user = update.effective_user
    user_id = str(user.id)

    # –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø–∏—Å–∫—É Fernie+
    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()
        cursor.execute("SELECT end_time FROM SubFerniePlus WHERE user_id = ?", (user_id,))
        row = cursor.fetchone()

    now = int(time.time())
    if not row or row[0] < now:
        await update.message.reply_text(
            "‚ùå –£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏ Fernie+\n\n"
            "–û—Ñ–æ—Ä–º–∏—Ç–µ –µ—ë —á–µ—Ä–µ–∑ /–ø–æ–¥–ø–∏—Å–∫–∞ —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ —Ñ—É–Ω–∫—Ü–∏–∏ /–¥–æ–∫—Å"
        )
        return

    # === –¥–∞–ª—å—à–µ —Ç–≤–æ—è –ª–æ–≥–∏–∫–∞ dox ===
    if len(context.args) != 1:
        await update.message.reply_text("‚ùå –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /–¥–æ–∫—Å {id}")
        return

    target_id = context.args[0]

    # –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    status_msg = await update.message.reply_text("üõ∞ DoX-Fernie\n–ó–∞–ø—É—Å–∫ –∞–Ω–∞–ª–∏–∑–∞ –±–∞–∑—ã...")
    await asyncio.sleep(2)

    with sqlite3.connect(DB_PATH) as conn:
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()

        # –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –≤ users
        cursor.execute("SELECT * FROM users WHERE user_id = ?", (target_id,))
        user_row = cursor.fetchone()

        if not user_row:
            await status_msg.edit_text("‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ")
            return

        # –æ–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        await status_msg.edit_text("üõ∞ DoX-Fernie\n–ù–∞–ª–∏—á–∏–µ –≤ –±–∞–∑–µ: ‚úÖ\n–ê–Ω–∞–ª–∏–∑ —Ç–∞–±–ª–∏—Ü...")
        await asyncio.sleep(2)

        sections = []
        now_str = datetime.now().strftime("%d.%m.%Y %H:%M:%S")

        # –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ "—Ö–∞–∫–µ—Ä—Å–∫–æ–≥–æ —Å—Ç–∏–ª—è"
        sections.append("‚ñà‚ñì‚ñí‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñí‚ñì‚ñà")
        sections.append(f"üìí –î–û–°–¨–ï: {target_id}")
        sections.append(f"‚è∞ –î–∞—Ç–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: {now_str}")
        sections.append("‚ñà‚ñì‚ñí‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñí‚ñì‚ñà\n")

        # === USERS ===
        sections.append("‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó")
        sections.append("‚ïë       –û–°–ù–û–í–ù–´–ï –î–ê–ù–ù–´–ï      ‚ïë")
        sections.append("‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù")

        for key in user_row.keys():
            sections.append(f"‚ñ∫ {key.upper()}: {user_row[key]}")
        sections.append("")

        # === –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã ===
        tables_to_check = [
            "inventory", "charity", "charity_balance", "sim_cards", "contacts",
            "businesses_XUI", "kids", "rewards", "Bank_New", "Bank_Deposit",
            "admins", "departament", "department_warns", "crypto_balances",
            "pets", "settings", "taxi_profiles", "bonus_timers", "bans",
            "user_promocodes", "custom_promo", "user_cases", "clan_members",
            "marriages", "mutes", "robbery_data"
        ]

        for table in tables_to_check:
            try:
                cursor.execute(f"PRAGMA table_info({table})")
                cols = [c[1] for c in cursor.fetchall()]
                possible_keys = [c for c in cols if c in ("user_id", "owner_id", "parent1_id", "parent2_id")]
                if not possible_keys:
                    continue

                sections.append(f"\n‚ñà‚ñì‚ñí‚ñë {table.upper()} ‚ñë‚ñí‚ñì‚ñà")
                for key in possible_keys:
                    cursor.execute(f"SELECT * FROM {table} WHERE {key} = ?", (target_id,))
                    rows = cursor.fetchall()
                    if not rows:
                        continue
                    for r in rows:
                        sections.append("‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ")
                        for col in r.keys():
                            sections.append(f"{col.upper()}: {r[col]}")

            except Exception as e:
                sections.append(f"\n[{table}] ‚ö† –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è: {e}")

        # –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ñ–∞–π–ª
        file_name = f"DoX_{target_id}.txt"
        with open(file_name, "w", encoding="utf-8") as f:
            f.write("\n".join(sections))

    # –æ–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
    await status_msg.edit_text("üõ∞ DoX-Fernie\n–í—Å–µ –¥–∞–Ω–Ω—ã–µ —Å–æ–±—Ä–∞–Ω—ã ‚úÖ\n–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á—ë—Ç–∞...")
    await asyncio.sleep(2)

    # –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∞–π–ª
    with open(file_name, "rb") as f:
        await update.message.reply_document(
            document=InputFile(f, filename=file_name)
        )

    # –∏—Ç–æ–≥–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    await status_msg.edit_text("üìÇ DoX-Fernie\n–§–∞–π–ª –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω ‚úÖ")


DURATIONS_FPL = {
    "12h": ("12 —á.", 12 * 3600, 75, 50),
    "24h": ("24 —á.", 24 * 3600, 150, 100),
    "3d": ("3 –¥–Ω.", 3 * 86400, 300, 250),
    "7d": ("7 –¥–Ω.", 7 * 86400, 750, 725),
    "15d": ("15 –¥–Ω.", 15 * 86400, 2500, 2000),
    "30d": ("30 –¥–Ω.", 30 * 86400, 4500, 3750),
    "6m": ("6 –º–µ—Å.", 6 * 30 * 86400, 22500, 20000),
    "1y": ("1 –≥–æ–¥", 365 * 86400, 45000, 40000)
}


async def subvip(update, context):
    user = update.effective_user
    display = get_display_name_html_new(user)

    user_id = str(user.id)
    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()
        cursor.execute("SELECT end_time FROM SubFerniePlus WHERE user_id=?", (user_id,))
        row = cursor.fetchone()

    now = int(time.time())
    if row and row[0]:
        try:
            expiry = int(row[0])
        except:
            expiry = 0
        if expiry > now:
            remaining = expiry - now
            d, rem = divmod(remaining, 86400)
            h, rem = divmod(rem, 3600)
            m, s = divmod(rem, 60)
            status = f"‚úÖ –ê–∫—Ç–∏–≤–Ω–∞\n–û—Å—Ç–∞–ª–æ—Å—å: {d}–¥ {h}—á {m}–º {s}—Å"
            has_subscription = True
        else:
            status = "‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"
            has_subscription = False
    else:
        status = "‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"
        has_subscription = False

    text = f"üåü<b> Fernie+ |</b> {display}\n\n–°—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏: {status}"

    keyboard = []
    if has_subscription:
        keyboard = [
            [InlineKeyboardButton("–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É", url="https://custom-fernie.vercel.app")],
            [InlineKeyboardButton("–°—Ç–∏–ª—å –ø—Ä–æ—Ñ–∏–ª—è", callback_data=f"open_fstyle:{user_id}")]
        ]
    else:
        keyboard = [
            [InlineKeyboardButton("–û—Ñ–æ—Ä–º–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É", url="https://fernie-xs.vercel.app")]
        ]

    reply_markup = InlineKeyboardMarkup(keyboard) if keyboard else None

    if update.message:
        await update.message.reply_text(text, parse_mode="HTML", reply_markup=reply_markup)
    elif update.callback_query:
        await update.callback_query.edit_message_text(text, parse_mode="HTML", reply_markup=reply_markup)

async def open_fstyle_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.callback_query.from_user
    user_id = str(user.id)

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ Fernie+
    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()
        cursor.execute("SELECT end_time FROM SubFerniePlus WHERE user_id = ?", (user_id,))
        row = cursor.fetchone()
        if not row or (row[0] and int(row[0]) < int(time.time())):
            await update.callback_query.answer(
                "‚ùå –£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏ Fernie+", show_alert=True
            )
            return

    current_style = get_fernie_style(user_id)  # —Ñ—É–Ω–∫—Ü–∏—è –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç '–§–æ—Ç–æ', '–¢–µ–∫—Å—Ç' –∏–ª–∏ 'GIF'
    user_tag = get_display_name_html_new(user)

    # --- –°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å—Ç–∏–ª–µ–π ---
    styles = ["–§–æ—Ç–æ", "–¢–µ–∫—Å—Ç", "GIF"]

    # –ö–Ω–æ–ø–∫–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Å—Ç–∏–ª—è
    buttons_list = []
    for style in styles:
        label = f"‚úÖ {style}" if style == current_style else style
        buttons_list.append([InlineKeyboardButton(label, callback_data=f"set_fernie_style:{style}:{user_id}")])

    buttons = InlineKeyboardMarkup(buttons_list)

    text = (
        "üåü <b>Fernie+ | –°—Ç–∏–ª—å –ø—Ä–æ—Ñ–∏–ª—è</b>\n"
        "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
        f"üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {user_tag}\n"
        f"üé® –¢–µ–∫—É—â–∏–π —Å—Ç–∏–ª—å: <b>{current_style}</b>\n"
        "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∏–ª—å –ø—Ä–æ—Ñ–∏–ª—è:"
    )

    # –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–∞–º–∏, –Ω–æ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫—É "Message is not modified"
    if update.callback_query.message:
        try:
            await update.callback_query.edit_message_text(
                text=text, reply_markup=buttons, parse_mode="HTML"
            )
        except telegram.error.BadRequest as e:
            if "Message is not modified" not in str(e):
                raise

    await update.callback_query.answer()


async def set_fernie_style_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    data = query.data  # –ø—Ä–∏–º–µ—Ä: "set_fernie_style:GIF:123456789"
    parts = data.split(":")
    if len(parts) != 3:
        await query.answer("–û—à–∏–±–∫–∞!", show_alert=True)
        return

    style, user_id = parts[1], parts[2]

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∏–ª—å –≤ –±–∞–∑–µ
    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()
        cursor.execute(
            "UPDATE SubFerniePlus SET FernieStyle = ? WHERE user_id = ?",
            (style, user_id)
        )

    await query.answer(f"‚úÖ –°—Ç–∏–ª—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: {style}")
    # –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–∞–º–∏
    await open_fstyle_callback(update, context)


async def subvip_callback(update, context):
    query = update.callback_query
    await query.answer()
    user = query.from_user
    display = get_display_name_html_new(user)

    data = query.data

    # –º–µ–Ω—é –≤—ã–±–æ—Ä–∞ —Å—Ä–æ–∫–∞
    if data == "sub:activate":
        buttons = [
            [InlineKeyboardButton("12 —á.", callback_data="sub:dur:12h"),
             InlineKeyboardButton("24 —á.", callback_data="sub:dur:24h")],
            [InlineKeyboardButton("3 –¥–Ω.", callback_data="sub:dur:3d"),
             InlineKeyboardButton("7 –¥–Ω.", callback_data="sub:dur:7d")],
            [InlineKeyboardButton("15 –¥–Ω.", callback_data="sub:dur:15d"),
             InlineKeyboardButton("30 –¥–Ω.", callback_data="sub:dur:30d")],
            [InlineKeyboardButton("6 –º–µ—Å.", callback_data="sub:dur:6m"),
             InlineKeyboardButton("1 –≥–æ–¥", callback_data="sub:dur:1y")],
            [InlineKeyboardButton("‚¨Ö –ù–∞–∑–∞–¥", callback_data="sub:back")]
        ]
        await query.edit_message_text(
            f"üåü Fernie+ | {display}\n\n–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏\n–°—Ä–æ–∫: –≤—ã–±–µ—Ä–∏—Ç–µ –Ω–∏–∂–µ:",
            parse_mode="HTML",
            reply_markup=InlineKeyboardMarkup(buttons)
        )

    # –≤—ã–±–æ—Ä —Å—Ä–æ–∫–∞
    elif data.startswith("sub:dur:"):
        key = data.split(":")[2]
        name, seconds, price_seeds, price_dc = DURATIONS_FPL[key]

        buttons = [
            [InlineKeyboardButton(f"–°–µ–º–µ–Ω–∞ - {price_seeds}", callback_data=f"sub:pay:{key}:seeds")],
            [InlineKeyboardButton(f"DC - {price_dc}", callback_data=f"sub:pay:{key}:dc")],
            [InlineKeyboardButton("‚¨Ö –û—Ç–º–µ–Ω–∞", callback_data="sub:back")]
        ]
        await query.edit_message_text(
            f"üåü Fernie+ | {display}\n\n–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏\n–°—Ä–æ–∫: {name}\n–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã:",
            parse_mode="HTML",
            reply_markup=InlineKeyboardMarkup(buttons)
        )

    # –≤—ã–±–æ—Ä –æ–ø–ª–∞—Ç—ã
    elif data.startswith("sub:pay:"):
        _, _, key, method = data.split(":")
        name, seconds, price_seeds, price_dc = DURATIONS_FPL[key]
        price = price_seeds if method == "seeds" else price_dc
        method_name = "–°–µ–º–µ–Ω–∞" if method == "seeds" else "DC"

        buttons = [
            [InlineKeyboardButton("‚úÖ –û–ø–ª–∞—Ç–∏—Ç—å", callback_data=f"sub:confirm:{key}:{method}")],
            [InlineKeyboardButton("‚¨Ö –û—Ç–º–µ–Ω–∞", callback_data="sub:back")]
        ]
        await query.edit_message_text(
            f"üåü Fernie+ | {display}\n\n–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏\n–°—Ä–æ–∫: {name}\n–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã: {method_name}\n–¶–µ–Ω–∞: {price}",
            parse_mode="HTML",
            reply_markup=InlineKeyboardMarkup(buttons)
        )

    # –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–æ–∫—É–ø–∫–∏
    elif data.startswith("sub:confirm:"):
        _, _, key, method = data.split(":")
        name, seconds, price_seeds, price_dc = DURATIONS_FPL.get(key, ("?", 0, 0, 0))
        user_id = str(user.id)

        with sqlite3.connect(DB_PATH) as conn:
            cursor = conn.cursor()

            # –ø—Ä–æ–≤–µ—Ä–∏–º –±–∞–ª–∞–Ω—Å
            cursor.execute("SELECT seeds, dc_balance, vip_expiry FROM users WHERE user_id=?", (user_id,))
            row = cursor.fetchone()
            if not row:
                await query.edit_message_text("‚ùå –û—à–∏–±–∫–∞: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ.")
                return

            seeds, dc_balance, vip_expiry = row
            price = price_seeds if method == "seeds" else price_dc

            if method == "seeds" and seeds < price:
                await query.edit_message_text("‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å–µ–º—è–Ω –¥–ª—è –ø–æ–∫—É–ø–∫–∏.")
                return
            if method == "dc" and dc_balance < price:
                await query.edit_message_text("‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ DC –¥–ª—è –ø–æ–∫—É–ø–∫–∏.")
                return

            # —Å–ø–∏—Å—ã–≤–∞–µ–º –±–∞–ª–∞–Ω—Å
            if method == "seeds":
                cursor.execute("UPDATE users SET seeds = seeds - ? WHERE user_id=?", (price, user_id))
            else:
                cursor.execute("UPDATE users SET dc_balance = dc_balance - ? WHERE user_id=?", (price, user_id))

            # —Å—á–∏—Ç–∞–µ–º –Ω–æ–≤–æ–µ –≤—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏
            now = int(time.time())
            if vip_expiry:
                try:
                    current_expiry = int(vip_expiry)
                except:
                    current_expiry = now
            else:
                current_expiry = now

            if current_expiry < now:
                new_expiry = now + seconds
            else:
                new_expiry = current_expiry + seconds

            # –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏
            cursor.execute("""
                UPDATE users
                SET vip_level = 1, vip_expiry = ?
                WHERE user_id=?
            """, (new_expiry, user_id))

            cursor.execute("""
                INSERT INTO SubFerniePlus (user_id, end_time) 
                VALUES (?, ?)
                ON CONFLICT(user_id) DO UPDATE SET end_time=excluded.end_time
            """, (user_id, new_expiry))

            conn.commit()

        await query.edit_message_text(
            f"üåü Fernie+ | {display}\n\n–ü–æ–¥–ø–∏—Å–∫–∞ —É—Å–ø–µ—à–Ω–æ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞ ‚úÖ\n"
            f"–°—Ä–æ–∫: {name}\n–ò—Å—Ç–µ–∫–∞–µ—Ç: <b>{datetime.fromtimestamp(new_expiry).strftime('%d.%m.%Y %H:%M:%S')}</b>",
            parse_mode="HTML"
        )


    # –Ω–∞–∑–∞–¥
    elif data == "sub:back":
        await subvip(update, context)


API_KEY = "920745ae9266589263a7ddc89bfd2c80"

WEATHER_ICONS = {
    "clear": "‚òÄ",
    "clouds": "‚òÅ",
    "rain": "üåß",
    "drizzle": "üå¶",
    "thunderstorm": "‚õà",
    "snow": "‚ùÑ",
    "mist": "üå´"
}


def get_icon(description: str):
    for key, icon in WEATHER_ICONS.items():
        if key in description.lower():
            return icon
    return "üåç"


def fetch_forecast(city: str):
    # –ì–µ–æ–∫–æ–¥–∏–Ω–≥
    geo_url = f"http://api.openweathermap.org/geo/1.0/direct?q={city}&limit=1&appid={API_KEY}"
    geo_res = requests.get(geo_url).json()
    if not geo_res:
        return None
    lat, lon = geo_res[0]["lat"], geo_res[0]["lon"]

    # –ü—Ä–æ–≥–Ω–æ–∑
    forecast_url = "http://api.openweathermap.org/data/2.5/forecast"
    params = {"lat": lat, "lon": lon, "appid": API_KEY, "units": "metric", "lang": "ru"}
    forecast_res = requests.get(forecast_url, params=params).json()
    if "list" not in forecast_res:
        return None
    return forecast_res["list"]


def format_weather_day(forecast_list, target_date):
    entries = [f for f in forecast_list if datetime.fromtimestamp(f["dt"]).date() == target_date.date()]
    if not entries:
        return "<i>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç—Ç–æ–π –¥–∞—Ç—ã.</i>"

    temps = [e["main"]["temp"] for e in entries]
    hums = [e["main"]["humidity"] for e in entries]
    winds = [e["wind"]["speed"] for e in entries]
    descs = [e["weather"][0]["description"] for e in entries]

    temp_avg = sum(temps) / len(temps)
    temp_min = min(temps)
    temp_max = max(temps)
    humidity_avg = sum(hums) / len(hums)
    wind_avg = sum(winds) / len(winds)
    desc_main = max(set(descs), key=descs.count)
    icon = get_icon(desc_main)

    text = (
        f"{icon} <b>{temp_avg:.1f}¬∞C</b> "
        f"(–º–∏–Ω: {temp_min:.1f}¬∞C, –º–∞–∫—Å: {temp_max:.1f}¬∞C) ‚Äî {desc_main.capitalize()}\n"
        f"üíß <b>–í–ª–∞–∂–Ω–æ—Å—Ç—å:</b> {humidity_avg:.0f}%\n"
        f"üí® <b>–í–µ—Ç–µ—Ä:</b> {wind_avg:.1f} –º/—Å"
    )
    return text


def format_weather_week(forecast_list):
    text = ""
    for i in range(7):
        day = datetime.utcnow() + timedelta(days=i)
        text += f"<b>{day.strftime('%A %d.%m.%Y')}</b>\n"
        text += format_weather_day(forecast_list, day) + "\n\n"
    text += "<pre>–ò—Å—Ç–æ—á–Ω–∏–∫: openweathermap.org</pre>"
    return text


async def wea(update: Update, context: ContextTypes.DEFAULT_TYPE, thinking_message: Optional[Message] = None):
    if not context.args:
        if thinking_message:
            await thinking_message.edit_text(
                "‚ö† –ò—Å–ø–æ–ª—å–∑—É–π —Ç–∞–∫: /ai –∫–∞–∫–∞—è –ø–æ–≥–æ–¥–∞ –≤ <–≥–æ—Ä–æ–¥>\n–ù–∞–ø—Ä–∏–º–µ—Ä: /ai –∫–∞–∫–∞—è –ø–æ–≥–æ–¥–∞ –≤ –ú–æ—Å–∫–≤–∞",
                parse_mode="HTML"
            )
        else:
            await update.message.reply_text(
                "‚ö† –ò—Å–ø–æ–ª—å–∑—É–π —Ç–∞–∫: /ai –ø–æ–≥–æ–¥–∞ <–≥–æ—Ä–æ–¥>\n–ù–∞–ø—Ä–∏–º–µ—Ä: /ai –ø–æ–≥–æ–¥–∞ –ú–æ—Å–∫–≤–∞",
                parse_mode="HTML"
            )
        return

    city = " ".join(context.args).strip()

    # —É–±–∏—Ä–∞–µ–º –ø—Ä–µ–¥–ª–æ–≥–∏ "–≤", "–Ω–∞", "–ø–æ" –≤ –Ω–∞—á–∞–ª–µ
    for preposition in ["–≤ ", "–Ω–∞ ", "–ø–æ "]:
        if city.lower().startswith(preposition):
            city = city[len(preposition):]
            break

    forecast_list = fetch_forecast(city)
    if not forecast_list:
        msg = f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –ø—Ä–æ–≥–Ω–æ–∑ –¥–ª—è '{city}'."
        if thinking_message:
            await thinking_message.edit_text(msg, parse_mode="HTML")
        else:
            await update.message.reply_text(msg, parse_mode="HTML")
        return

    user_id = update.effective_user.id  # —Å–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è –∫–æ–º–∞–Ω–¥—ã
    today = datetime.utcnow()
    text = (
        f"üß† <b>FernieX-AI</b>\n\n"
        f"üìç –ü–æ–≥–æ–¥–∞ –≤ {city.title()}\n"  # <-- title() –¥–ª—è –∑–∞–≥–ª–∞–≤–Ω–æ–π –±—É–∫–≤—ã
        f"–î–∞—Ç–∞: {today.strftime('%d.%m.%Y')}\n\n"
        f"{format_weather_day(forecast_list, today)}\n"
        f"<pre>–ò—Å—Ç–æ—á–Ω–∏–∫: openweathermap.org</pre>"
    )

    keyboard = [
        [InlineKeyboardButton("–ó–∞–≤—Ç—Ä–∞", callback_data=f"day|{city}|1|{user_id}")],
        [InlineKeyboardButton("–ù–µ–¥–µ–ª—è", callback_data=f"week|{city}|{user_id}")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)

    if thinking_message:
        # –∑–∞–º–µ–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ "–¥—É–º–∞—é..." –Ω–∞ –ø—Ä–æ–≥–Ω–æ–∑
        await thinking_message.edit_text(text, reply_markup=reply_markup, parse_mode="HTML")
    else:
        await update.message.reply_text(text, reply_markup=reply_markup, parse_mode="HTML")


async def button_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    data = query.data.split("|")
    action, city, *rest = data

    sender_id = int(rest[-1])
    if update.effective_user.id != sender_id:
        await query.answer("‚ùå –¢–æ–ª—å–∫–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å –∫–æ–º–∞–Ω–¥—ã –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç–∏ –∫–Ω–æ–ø–∫–∏.", show_alert=True)
        return

    await query.answer("‚è≥ –ü–æ–¥–æ–∂–¥–∏—Ç–µ, –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —Å —Å–µ—Ä–≤–µ—Ä–∞...", show_alert=True)

    forecast_list = fetch_forecast(city)
    if not forecast_list:
        await query.edit_message_text(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–æ–≥–Ω–æ–∑ –¥–ª—è '{city}'.", parse_mode="HTML")
        return

    if action == "day":
        day_offset = int(rest[0])
        target_date = datetime.utcnow() + timedelta(days=day_offset)
        text = (
            f"üß† <b>FernieX-AI</b>\n\n"
            f"üìç –ü–æ–≥–æ–¥–∞ –≤ {city.title()}\n"  # <-- –∑–∞–≥–ª–∞–≤–Ω–∞—è –±—É–∫–≤–∞
            f"–î–∞—Ç–∞: {target_date.strftime('%d.%m.%Y')}\n\n"
            f"{format_weather_day(forecast_list, target_date)}\n"
            f"<pre>–ò—Å—Ç–æ—á–Ω–∏–∫: openweathermap.org</pre>"
        )

        buttons = []
        if day_offset != 0:
            buttons.append(InlineKeyboardButton("–°–µ–≥–æ–¥–Ω—è", callback_data=f"day|{city}|0|{sender_id}"))
        if day_offset != 1:
            buttons.append(InlineKeyboardButton("–ó–∞–≤—Ç—Ä–∞", callback_data=f"day|{city}|1|{sender_id}"))
        buttons.append(InlineKeyboardButton("–ù–µ–¥–µ–ª—è", callback_data=f"week|{city}|{sender_id}"))

        reply_markup = InlineKeyboardMarkup([buttons])
        await query.edit_message_text(text, reply_markup=reply_markup, parse_mode="HTML")

    elif action == "week":
        text = f"üß† <b>FernieX-AI</b>\n\nüìç –ü–æ–≥–æ–¥–∞ –≤ {city.title()}\n\n"
        for i in range(7):
            day = datetime.utcnow() + timedelta(days=i)
            text += f"<b>{day.strftime('%A %d.%m.%Y')}</b>\n"
            text += format_weather_day(forecast_list, day) + "\n\n"
        text += "<pre>–ò—Å—Ç–æ—á–Ω–∏–∫: openweathermap.org</pre>"

        buttons = [
            InlineKeyboardButton("–°–µ–≥–æ–¥–Ω—è", callback_data=f"day|{city}|0|{sender_id}"),
            InlineKeyboardButton("–ó–∞–≤—Ç—Ä–∞", callback_data=f"day|{city}|1|{sender_id}")
        ]
        reply_markup = InlineKeyboardMarkup([buttons])
        await query.edit_message_text(text, reply_markup=reply_markup, parse_mode="HTML")


def add_warns_column(db_path: str = 'FernieUI.db'):
    try:
        # –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
        conn = sqlite3.connect(db_path)
        cursor = conn.cursor()

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Å—Ç–æ–ª–±—Ü–∞
        cursor.execute("PRAGMA table_info(users)")
        columns = [column[1] for column in cursor.fetchall()]

        if 'warns' not in columns:
            # –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–æ–ª–±–µ—Ü warns —Ç–∏–ø–∞ INTEGER —Å –∑–Ω–∞—á–µ–Ω–∏–µ–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 0
            cursor.execute("ALTER TABLE users ADD COLUMN warns INTEGER DEFAULT 0")
            conn.commit()
            print("–°—Ç–æ–ª–±–µ—Ü 'warns' —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω –≤ —Ç–∞–±–ª–∏—Ü—É 'users'")
        else:
            print("–°—Ç–æ–ª–±–µ—Ü 'warns' —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ —Ç–∞–±–ª–∏—Ü–µ 'users'")

    except sqlite3.Error as e:
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Å—Ç–æ–ª–±—Ü–∞: {e}")
    finally:
        if conn:
            conn.close()


QUEST_COOLDOWN = 300
WORDS = [  # 700 —Å–ª–æ–≤
    "–ê–≤—Ç–æ–±—É—Å", "–ê–≤—Ç–æ–º–æ–±–∏–ª—å", "–ê–∏—Å—Ç", "–ê–Ω–∞–Ω–∞—Å", "–ê–ø–µ–ª—å—Å–∏–Ω", "–ê–ø—Ç–µ–∫–∞", "–ê—Ä–±—É–∑", "–ê–ø—Ä–µ–ª—å", "–ê—Ä—Ñ–∞", "–ê—Ç–ª–∞—Å",
    "–ë–∞–ª–∫–æ–Ω", "–ë–∞–º–±—É–∫", "–ë–∞–Ω–∞–Ω", "–ë–∞–Ω–∫–∞", "–ë–∞—Å—Å–µ–π–Ω", "–ë–µ–≥–µ–º–æ—Ç", "–ë–µ–Ω–∑–∏–Ω", "–ë–µ—Ä–µ–≥", "–ë–µ—Ä–µ–∑–∞", "–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞",
    "–ë–∏–ª–µ—Ç", "–ë–∏–Ω–æ–∫–ª—å", "–ë–ª—é–¥–æ", "–ë–æ–∫–∞–ª", "–ë–æ—á–∫–∞", "–ë–æ—Ç–∏–Ω–∫–∏", "–ë—Ä—é–∫–∏", "–ë—É–∫–µ—Ç", "–ë—É–ª–∫–∞", "–ë—É–º–∞–≥–∞",
    "–ë—É–º–∞–∂–Ω–∏–∫", "–ë—É–ª—å–≤–∞—Ä", "–ë—É—Ç—ã–ª–∫–∞", "–í–∞–≥–∞–æ–Ω", "–í–µ–ª–æ—Ç—Ä–µ–Ω–∞–∂–µ—Ä", "–í–µ–ª–æ—Å–∏–ø–µ–¥", "–í–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä", "–í–µ—Ä–±–ª—é–¥", "–í–µ—Ä–µ–≤–∫–∞",
    "–í–µ—Ä—Ç–æ–ª–µ—Ç", "–í–µ—Ç–µ—Ä", "–í–µ—Ç–µ—Ä–∏–Ω–∞—Ä", "–í–∏–Ω–æ–≥—Ä–∞–¥", "–í–∏—Ç—Ä–∏–Ω–∞", "–í–æ–¥–∞", "–í–æ–∑–¥—É—Ö", "–í–æ—Ä–æ–±–µ–π", "–í–æ—Ä–æ—Ç–∞", "–í—É–ª–∫–∞–Ω",
    "–í–∞–∑–∞", "–ì–∞–∑–µ—Ç–∞", "–ì–∞–º–±—É—Ä–≥–µ—Ä", "–ì–∞—Ä–¥–µ—Ä–æ–±", "–ì–≤–æ–∑–¥—å", "–ì–∏—Ç–∞—Ä–∞", "–ì–ª–æ–±—É—Å", "–ì–æ—Ä–æ–¥", "–ì—Ä–∞–Ω–∞—Ç", "–ì–æ—Ä–æ—Ö",
    "–ì–æ—Ä—à–æ–∫", "–ì—Ä—É–∑–æ–≤–∏–∫", "–ì—Ä–æ–∑–∞", "–ì—Ä–∏–±", "–î–∞—á–∞", "–î–≤–µ—Ä—å", "–î–∂–∏–Ω–Ω", "–î–∂–∏–Ω—Å—ã", "–î–∏–≤–∞–Ω", "–î–æ—Ä–æ–≥–∞", "–î–æ–∂–¥—å",
    "–î—Ä–∞–∫–æ–Ω", "–î–æ—Å–∫–∞", "–î–µ–ª—å—Ñ–∏–Ω", "–î—ã–Ω—è", "–ï–∂–µ–≤–∏–∫–∞", "–ï–ª—å", "–ï–Ω–æ—Ç", "–ñ–∞–≤–æ—Ä–æ–Ω–æ–∫", "–ñ–µ–ª–µ", "–ñ–∏—Ä–∞—Ñ", "–ñ—É–∫",
    "–ñ—É—Ä–Ω–∞–ª", "–ñ–µ–ª–µ–∑–æ", "–ñ–µ–ª—É–¥—å", "–ñ–µ–ª–µ–∑–Ω–æ–¥–æ—Ä–æ–∂–Ω—ã–π", "–ó–∞—è—Ü", "–ó–µ–±—Ä–∞", "–ó–≤–µ–∑–¥–∞", "–ó–µ–º–ª—è", "–ó–µ—Ä–∫–∞–ª–æ", "–ó–æ–Ω—Ç–∏–∫",
    "–ó—É–±", "–ó—É–±—Ä", "–ó–¥–∞–Ω–∏–µ", "–ò–≥–ª–∞", "–ò–≥—Ä–∞", "–ò–≥—Ä—É—à–∫–∞", "–ò–≥–æ–ª–∫–∞", "–ò–Ω–µ–π", "–ò—Ä–∏—Å", "–ô–æ–≥–∞", "–ô–æ–≥—É—Ä—Ç",
    "–ö–∞–±–∞—á–æ–∫", "–ö–∞–±–∏–Ω–µ—Ç", "–ö–∞–ª–µ–Ω–¥–∞—Ä—å", "–ö–∞–ø–ª—è", "–ö–∞–ø—É—Å—Ç–∞", "–ö–∞–ø—é—à–æ–Ω", "–ö–∞—Ä–∞–Ω–¥–∞—à", "–ö–∞—Ä–∞–±–∏–Ω", "–ö–∞—Ä—Ç–∞", "–ö–∞—Ä—Ç–∏–Ω–∞",
    "–ö–∞—Å—Ç–µ—Ç", "–ö–∞—Å—Ç—Ä—é–ª—è", "–ö–µ–¥—ã", "–ö–∏—Å—Ç—å", "–ö–ª—é—á", "–ö–æ–≤—Ä–∏–∫", "–ö–æ–≤–µ—Ä", "–ö–æ–ª–æ–¥–µ—Ü", "–ö–æ–º–æ–¥", "–ö–æ–º–ø—å—é—Ç–µ—Ä", "–ö–æ—Ä–∞–±–ª—å",
    "–ö–æ—Ä–º", "–ö–æ—Ä–∑–∏–Ω–∞", "–ö–æ—Ç", "–ö–æ—Ç–µ–ª", "–ö–æ—Ñ–µ", "–ö–æ—Ñ–µ–π–Ω–∏–∫", "–ö–æ—Ñ—Ç–∞", "–ö—Ä–∞–Ω", "–ö—Ä–µ—Å–ª–æ", "–ö—Ä–µ—Å—Ç", "–ö—Ä—é–∫",
    "–ö—Ä—É–≥", "–ö—É–±–∏–∫", "–ö—É–∫–ª–∞", "–ö—É—Ä—Ç–∫–∞", "–ö—É—Å—Ç", "–ö—Ä—ã—à–∞", "–õ–∞–∫–æ–º—Å—Ç–≤–æ", "–õ–∞–º–ø–∞", "–õ–∞—Å—Ç–æ—á–∫–∞", "–õ–µ—Å", "–õ–µ–¥",
    "–õ–µ—Å—Ç–Ω–∏—Ü–∞", "–õ–∏–Ω–µ–π–∫–∞", "–õ–∏–ø–∞", "–õ–∏—Å—Ç", "–õ–∏—Å—Ç–æ–∫", "–õ–æ–∂–∫–∞", "–õ–æ–¥–∫–∞", "–õ–æ–ø–∞—Ç–∞", "–õ–æ—Å–æ—Å—å", "–õ—É–Ω–∞", "–õ—è–≥—É—à–∫–∞",
    "–ú–∞–≥–∞–∑–∏–Ω", "–ú–∞–ª–∏–Ω–∞", "–ú–∞–Ω–≥–æ", "–ú–∞—Ä–∫–µ—Ä", "–ú–∞—Ä–º–µ–ª–∞–¥", "–ú–∞—Å—Å–∞–∂", "–ú–∞—Ç—Ä–∞—Å", "–ú–∞—è–∫", "–ú–µ–¥", "–ú–µ–¥–≤–µ–¥—å", "–ú–µ–ª",
    "–ú–µ–ª–æ–¥–∏—è", "–ú–∞—à–∏–Ω–∞", "–ú–æ–ª–Ω–∏—è", "–ú–æ—Å—Ç", "–ú–æ—Ç–æ—Ü–∏–∫–ª", "–ú–æ—Ä–æ–∂–µ–Ω–æ–µ", "–ú–æ—Ä–∫–æ–≤—å", "–ú–æ—Ä–æ–∑", "–ú—è—á", "–ú—è—Å–æ", "–ú—ã—à—å",
    "–ù–æ–∂", "–ù–æ–∂–Ω–∏—Ü—ã", "–ù–æ—Å–∫–∏", "–ù–æ—É—Ç–±—É–∫", "–û–±–ª–∞–∫–æ", "–û–≥—É—Ä–µ—Ü", "–û–∫–µ–∞–Ω", "–û–∫–Ω–æ", "–û—Å—Ç—Ä–æ–≤", "–û—Ä–≥–∞–Ω", "–û—Å–∞",
    "–û—á–∫–∏", "–ü–∞–ª—å—Ç–æ", "–ü–∞–ª–∫–∞", "–ü–∞–ø–∫–∞", "–ü–∞—Ä—É—Å", "–ü–∞–∑–ª", "–ü–µ—Å–æ–∫", "–ü–µ—á–µ–Ω—å–µ", "–ü–∏—Ü—Ü–∞", "–ü–ª–∞—Ç—å–µ", "–ü–ª–∞–Ω—à–µ—Ç",
    "–ü–æ–¥—É—à–∫–∞", "–ü–æ–ª–∫–∞", "–ü–æ–º–∏–¥–æ—Ä", "–ü–æ–ø—É–≥–∞–π", "–ü–æ—Ä—Ç", "–ü–æ—Ä—Ç—Ñ–µ–ª—å", "–ü—Ç–∏—Ü–∞", "–ü—ã–ª–µ—Å–æ—Å", "–ü—Ä–∞–∑–¥–Ω–∏–∫", "–ü–æ–¥–∞—Ä–æ–∫",
    "–ü–æ–µ–∑–¥", "–†–∞–∫–µ—Ç–∞", "–†–∞–º–∫–∞", "–†–∞–¥–∏–æ", "–†–µ–∫–∞", "–†–µ–∑–∏–Ω–∫–∞", "–†–æ–ª–∏–∫–∏", "–†—É–±–∞—à–∫–∞", "–†—É—á–∫–∞", "–†—é–∫–∑–∞–∫", "–°–∞–∫—Å–∞—Ñ–æ–Ω",
    "–°–∞–º–æ–ª–µ—Ç", "–°–∞–º–æ–∫–∞—Ç", "–°–≤–µ—Ç", "–°–≤–µ—á–∞", "–°–∫–∞–ª–∞", "–°–∫–µ–π—Ç–±–æ—Ä–¥", "–°–ª–æ–Ω", "–°–Ω–µ–≥", "–°–æ–±–∞–∫–∞", "–°–æ–∫", "–°–æ—Ä–æ–∫–æ–Ω–æ–∂–∫–∞",
    "–°—Ç–∞–∫–∞–Ω", "–°—Ç—É–ª", "–°—É–º–∫–∞", "–°–∫–æ–≤–æ—Ä–æ–¥–∞", "–¢–∞—Ä–µ–ª–∫–∞", "–¢–µ—Ç—Ä–∞–¥—å", "–¢–∏–≥—Ä", "–¢–æ–Ω–Ω–µ–ª—å", "–¢–æ—Ä—Ç", "–¢—Ä–∞–≤–∞", "–¢—Ä–∞–º–≤–∞–π",
    "–¢—É—Ñ–ª–∏", "–¢—é–ª—å–ø–∞–Ω", "–£–ª–∏—Ü–∞", "–£—Ç–∫–∞", "–§–∏–≥—É—Ä–∫–∞", "–§–ª–∞–≥", "–§–æ–Ω–∞—Ä—å", "–§—Ä—É–∫—Ç", "–§—Ä—É–∫—Ç—ã", "–§—É—Ç–±–æ–ª", "–•–ª–µ–±",
    "–•–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫", "–•–æ–º—è–∫", "–¶–≤–µ—Ç–æ–∫", "–¶–∏—Ä–∫—É–ª—å", "–ß–∞–π–Ω–∏–∫", "–ß–∞—Å—ã", "–ß–∞—à–∫–∞", "–ß–µ—Ä–µ–ø–∞—Ö–∞", "–ß–µ—Ä–Ω–∏–∫–∞", "–®–∞—Ä–∏–∫",
    "–®–∞—Ä—Ñ", "–®–∞–ø–∫–∞", "–®–∫–∞—Ñ", "–®–ª—è–ø–∞", "–®–Ω—É—Ä–æ–∫", "–®–æ–∫–æ–ª–∞–¥", "–©–µ—Ç–∫–∞", "–Æ–±–∫–∞", "–Ø–±–ª–æ–∫–æ", "–Ø–π—Ü–æ", "–Ø–∫–æ—Ä—å", "–Ø—â–∏–∫",
    "–†—É—á–µ–π", "–ö–∞–º–µ–Ω—å", "–ö–∞—Ä–∞–Ω–¥–∞—à–Ω–∏—Ü–∞", "–¢–µ–ª–µ—Ñ–æ–Ω", "–°–º–∞—Ä—Ç—Ñ–æ–Ω", "–ó–∞—Ä—è–¥–∫–∞", "–ê–∫–∫—É–º—É–ª—è—Ç–æ—Ä", "–ë–∞—Ç–∞—Ä–µ–π–∫–∞", "–õ–∞–º–ø–∞",
    "–ü—Ä–æ–µ–∫—Ç–æ—Ä", "–≠–∫—Ä–∞–Ω",
    "–ü—Ä–∏–Ω—Ç–µ—Ä", "–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞", "–ú—ã—à–∫–∞", "–ù–∞—É—à–Ω–∏–∫–∏", "–ö–æ–ª–æ–Ω–∫–∞", "–†–æ—É—Ç–µ—Ä", "–§–ª–µ—à–∫–∞", "–î–∏—Å–∫", "–ö–∞–º–µ—Ä–∞", "–§–æ—Ç–æ–∞–ø–ø–∞—Ä–∞—Ç",
    "–û–±—ä–µ–∫—Ç–∏–≤", "–¢–µ—Ç—Ä–∞–¥–∫–∞", "–†—É—á–∫–∞", "–ö–Ω–∏–≥–∞", "–£—á–µ–±–Ω–∏–∫", "–ñ—É—Ä–Ω–∞–ª", "–ì–∞–∑–µ—Ç–∞", "–°–ª–æ–≤–∞—Ä—å", "–ê–ª—å–±–æ–º", "–ü–ª–∞–∫–∞—Ç",
    "–ö–∞—Ä—Ç–∏–Ω–∞", "–ò–∫–æ–Ω–∞", "–§—Ä–µ—Å–∫–∞", "–°–∫—É–ª—å–ø—Ç—É—Ä–∞", "–í–∞–∑–∞", "–°—Ç–∞—Ç—É—è", "–ü–∞–º—è—Ç–Ω–∏–∫", "–ö–æ–ª–æ–∫–æ–ª", "–û—Ä–∫–µ—Å—Ç—Ä", "–ü–∏–∞–Ω–∏–Ω–æ",
    "–°–∫—Ä–∏–ø–∫–∞", "–§–ª–µ–π—Ç–∞", "–¢—Ä—É–±–∞", "–ë–∞—Ä–∞–±–∞–Ω", "–ê—Ä—Ñ–∞", "–°–∞–∫—Å–æ—Ñ–æ–Ω", "–ì–∞—Ä–º–æ—à–∫–∞", "–ë–∞—è–Ω", "–ö–ª–∞–≤–µ—Å–∏–Ω", "–û—Ä–≥–∞–Ω",
    "–ö—É–±–æ–∫", "–ú–µ–¥–∞–ª—å", "–ü—Ä–∏–∑", "–ö—É–±–∏–∫", "–®–∞—Ö–º–∞—Ç—ã", "–®–∞—à–∫–∏", "–ö–∞—Ä—Ç—ã", "–î–æ–º–∏–Ω–æ", "–ö—É–±–∏–∫–∏", "–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä",
    "–ü–∞–∑–ª—ã", "–ù–∞—Å—Ç–æ–ª—å–Ω–∞—è–ò–≥—Ä–∞", "–ò–≥—Ä–æ–≤–∞—è–ü—Ä–∏—Å—Ç–∞–≤–∫–∞", "–î–∂–æ–π—Å—Ç–∏–∫", "–ö–æ–º–ø—å—é—Ç–µ—Ä–Ω–∞—è–ú—ã—à—å", "–ú–æ–Ω–∏—Ç–æ—Ä", "–°–∏—Å—Ç–µ–º–Ω—ã–π–ë–ª–æ–∫",
    "–ö—Ä–µ—Å–ª–æ", "–°—Ç—É–ª", "–¢–∞–±—É—Ä–µ—Ç", "–î–∏–≤–∞–Ω", "–ö—Ä–æ–≤–∞—Ç—å", "–ú–∞—Ç—Ä–∞—Å", "–û–¥–µ—è–ª–æ", "–ü–æ–¥—É—à–∫–∞", "–ü—Ä–æ—Å—Ç—ã–Ω—è", "–ü–æ–ª–æ—Ç–µ–Ω—Ü–µ",
    "–°–∫–∞—Ç–µ—Ä—Ç—å", "–°–∞–ª—Ñ–µ—Ç–∫–∞", "–ó–µ—Ä–∫–∞–ª–æ", "–®–∫–∞—Ñ", "–ö–æ–º–æ–¥", "–¢—É–º–±–æ—á–∫–∞", "–°—Ç–µ–ª–ª–∞–∂", "–ü–æ–ª–∫–∞", "–î–≤–µ—Ä—å", "–û–∫–Ω–æ",
    "–ö—Ä—ã—à–∞", "–°—Ç–µ–Ω–∞", "–ü–æ–ª", "–ü–æ—Ç–æ–ª–æ–∫", "–ë–∞–ª–∫–æ–Ω", "–õ–æ–¥–∂–∏—è", "–ö–æ—Ä–∏–¥–æ—Ä", "–ö—É—Ö–Ω—è", "–°–ø–∞–ª—å–Ω—è", "–ì–æ—Å—Ç–∏–Ω–∞—è",
    "–í–∞–Ω–Ω–∞—è", "–¢—É–∞–ª–µ—Ç", "–ü—Ä–∏—Ö–æ–∂–∞—è", "–ö–∞–±–∏–Ω–µ—Ç", "–û—Ñ–∏—Å", "–®–∫–æ–ª–∞", "–£–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç", "–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞", "–ú–∞–≥–∞–∑–∏–Ω",
    "–°—É–ø–µ—Ä–º–∞—Ä–∫–µ—Ç", "–¢–æ—Ä–≥–æ–≤—ã–π–¶–µ–Ω—Ç—Ä", "–†—ã–Ω–æ–∫", "–ê–ø—Ç–µ–∫–∞", "–ë–æ–ª—å–Ω–∏—Ü–∞", "–ü–æ–ª–∏–∫–ª–∏–Ω–∏–∫–∞", "–ê–º–±—É–ª–∞—Ç–æ—Ä–∏—è", "–°—Ç–∞–¥–∏–æ–Ω",
    "–°–ø–æ—Ä—Ç–∑–∞–ª", "–ë–∞—Å—Å–µ–π–Ω", "–§—É—Ç–±–æ–ª—å–Ω–æ–µ–ü–æ–ª–µ", "–ö–æ—Ä—Ç", "–ê—Ä–µ–Ω–∞", "–ó–æ–æ–ø–∞—Ä–∫", "–¶–∏—Ä–∫", "–¢–µ–∞—Ç—Ä", "–ö–∏–Ω–æ—Ç–µ–∞—Ç—Ä",
    "–ú—É–∑–µ–π", "–ì–∞–ª–µ—Ä–µ—è", "–ü–ª–æ—â–∞–¥—å", "–ü–∞—Ä–∫", "–°–∫–≤–µ—Ä", "–°–∞–¥", "–õ–µ—Å", "–ü–æ–ª–µ", "–õ—É–≥", "–û–∑–µ—Ä–æ", "–†–µ–∫–∞",
    "–ú–æ—Ä–µ", "–û–∫–µ–∞–Ω", "–ì–æ—Ä–∞", "–•–æ–ª–º", "–í—É–ª–∫–∞–Ω", "–ü–µ—â–µ—Ä–∞", "–û—Å—Ç—Ä–æ–≤", "–ü–æ–ª—É–æ—Å—Ç—Ä–æ–≤", "–ú–∞—Ç–µ—Ä–∏–∫", "–ö–æ–Ω—Ç–∏–Ω–µ–Ω—Ç",
    "–°—Ç—Ä–∞–Ω–∞", "–ì–æ—Ä–æ–¥", "–î–µ—Ä–µ–≤–Ω—è", "–ü–æ—Å—ë–ª–æ–∫", "–£–ª–∏—Ü–∞", "–ü–µ—Ä–µ—É–ª–æ–∫", "–ü–ª–æ—â–∞–¥–∫–∞", "–¢—Ä–æ—Ç—É–∞—Ä", "–î–æ—Ä–æ–≥–∞", "–®–æ—Å—Å–µ",
    "–ú–æ—Å—Ç", "–¢–æ–Ω–Ω–µ–ª—å", "–í–æ–∫–∑–∞–ª", "–ê—ç—Ä–æ–ø–æ—Ä—Ç", "–ü–æ—Ä—Ç", "–ê–≤—Ç–æ—Å—Ç–∞–Ω—Ü–∏—è", "–ú–µ—Ç—Ä–æ", "–¢—Ä–∞–º–≤–∞–π", "–ê–≤—Ç–æ–±—É—Å", "–ü–æ–µ–∑–¥",
    "–°–∞–º–æ–ª–µ—Ç", "–í–µ—Ä—Ç–æ–ª–µ—Ç", "–ö–æ—Ä–∞–±–ª—å", "–ö–∞—Ç–µ—Ä", "–õ–æ–¥–∫–∞", "–ü–æ–¥–≤–æ–¥–Ω–∞—è–õ–æ–¥–∫–∞", "–†–∞–∫–µ—Ç–∞", "–°–ø—É—Ç–Ω–∏–∫", "–¢—Ä–∞–∫—Ç–æ—Ä", "–ö–æ–º–±–∞–π–Ω",
    "–ê–≤—Ç–æ–º–æ–±–∏–ª—å", "–ú–æ—Ç–æ—Ü–∏–∫–ª", "–°–∫—É—Ç–µ—Ä", "–°–∞–º–æ–∫–∞—Ç", "–í–µ–ª–æ—Å–∏–ø–µ–¥", "–¢–µ–ª–µ–≥–∞", "–ö–∞—Ä–µ—Ç–∞", "–ö–æ–ª–µ—Å–æ", "–®–∏–Ω–∞", "–î–≤–∏–≥–∞—Ç–µ–ª—å",
    "–¢–æ–ø–ª–∏–≤–æ", "–ë–µ–Ω–∑–∏–Ω", "–î–∏–∑–µ–ª—å", "–ì–∞–∑", "–ù–µ—Ñ—Ç—å", "–£–≥–æ–ª—å", "–≠–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ", "–ë–∞—Ç–∞—Ä–µ—è", "–°–≤–µ—Ç–∏–ª—å–Ω–∏–∫", "–õ–∞–º–ø–æ—á–∫–∞",
    "–§–æ–Ω–∞—Ä—å", "–ö–æ—Å—Ç–µ—Ä", "–û–≥–æ–Ω—å", "–ü–ª–∞–º—è", "–°–≤–µ—á–∞", "–õ—É—á–∏–Ω–∞", "–§–∞–∫–µ–ª", "–ñ–∞—Ä", "–î—ã–º", "–ó–æ–ª–∞",
    "–ü–µ–ø–µ–ª", "–ü—ã–ª—å", "–í–æ–¥–∞", "–õ—ë–¥", "–°–Ω–µ–≥", "–î–æ–∂–¥—å", "–ì—Ä–∞–¥", "–¢—É–º–∞–Ω", "–û–±–ª–∞–∫–æ", "–†–æ—Å–∞",
    "–ò–Ω–µ–π", "–ö–∞–ø–ª—è", "–ü–æ—Ç–æ–∫", "–í–æ–ª–Ω–∞", "–ü—Ä–∏–ª–∏–≤", "–û—Ç–ª–∏–≤", "–®—Ç–æ—Ä–º", "–£—Ä–∞–≥–∞–Ω", "–¶—É–Ω–∞–º–∏", "–¢–∞–π—Ñ—É–Ω",
    "–°–æ–ª–Ω—Ü–µ", "–õ—É–Ω–∞", "–ó–≤–µ–∑–¥–∞", "–ü–ª–∞–Ω–µ—Ç–∞", "–ú–µ—Ä–∫—É—Ä–∏–π", "–í–µ–Ω–µ—Ä–∞", "–ó–µ–º–ª—è", "–ú–∞—Ä—Å", "–Æ–ø–∏—Ç–µ—Ä", "–°–∞—Ç—É—Ä–Ω",
    "–£—Ä–∞–Ω", "–ù–µ–ø—Ç—É–Ω", "–ö–æ–º–µ—Ç–∞", "–ú–µ—Ç–µ–æ—Ä", "–ê—Å—Ç–µ—Ä–æ–∏–¥", "–ì–∞–ª–∞–∫—Ç–∏–∫–∞", "–í—Å–µ–ª–µ–Ω–Ω–∞—è", "–ö–æ—Å–º–æ—Å", "–û—Ä–±–∏—Ç–∞", "–¢–µ–ª–µ—Å–∫–æ–ø",
    "–ú–∏–∫—Ä–æ—Å–∫–æ–ø", "–õ—É–ø–∞", "–û—á–∫–∏", "–õ–∏–Ω–∑–∞", "–§–æ—Ç–æ–∞–ø–ø–∞—Ä–∞—Ç", "–ö–∞–º–µ—Ä–∞", "–ë–∏–Ω–æ–∫–ª—å", "–ü–æ–¥–∑–æ—Ä–Ω–∞—è–¢—Ä—É–±–∞", "–°–ø–µ–∫—Ç—Ä–æ—Å–∫–æ–ø", "–†–∞–¥–∞—Ä",
    "–ñ–∏–≤–æ—Ç–Ω–æ–µ", "–ß–µ–ª–æ–≤–µ–∫", "–ú–∞–ª—å—á–∏–∫", "–î–µ–≤–æ—á–∫–∞", "–ú—É–∂—á–∏–Ω–∞", "–ñ–µ–Ω—â–∏–Ω–∞", "–†–µ–±—ë–Ω–æ–∫", "–í–∑—Ä–æ—Å–ª—ã–π", "–°—Ç–∞—Ä–∏–∫", "–ë–∞–±—É—à–∫–∞",
    "–î–µ–¥—É—à–∫–∞", "–ü–∞–ø–∞", "–ú–∞–º–∞", "–°—ã–Ω", "–î–æ—á—å", "–ë—Ä–∞—Ç", "–°–µ—Å—Ç—Ä–∞", "–î—Ä—É–≥", "–ü–æ–¥—Ä—É–≥–∞", "–£—á–∏—Ç–µ–ª—å",
    "–£—á–µ–Ω–∏–∫", "–î–æ–∫—Ç–æ—Ä", "–í—Ä–∞—á", "–ü–∞—Ü–∏–µ–Ω—Ç", "–ü—Ä–æ–¥–∞–≤–µ—Ü", "–ü–æ–∫—É–ø–∞—Ç–µ–ª—å", "–ö–ª–∏–µ–Ω—Ç", "–†–∞–±–æ—á–∏–π", "–®–æ—Ñ–µ—Ä", "–ü–æ–≤–∞—Ä",
    "–û—Ñ–∏—Ü–∏–∞–Ω—Ç", "–ë–∞—Ä–º–µ–Ω", "–ú–µ–Ω–µ–¥–∂–µ—Ä", "–ò–Ω–∂–µ–Ω–µ—Ä", "–£—á—ë–Ω—ã–π", "–ü–∏—Å–∞—Ç–µ–ª—å", "–ü–æ—ç—Ç", "–•—É–¥–æ–∂–Ω–∏–∫", "–ú—É–∑—ã–∫–∞–Ω—Ç", "–ê–∫—Ç—ë—Ä",
    "–ü–µ–≤–µ—Ü", "–¢–∞–Ω—Ü–æ—Ä", "–°–ø–æ—Ä—Ç—Å–º–µ–Ω", "–§—É—Ç–±–æ–ª–∏—Å—Ç", "–ë–∞—Å–∫–µ—Ç–±–æ–ª–∏—Å—Ç", "–•–æ–∫–∫–µ–∏—Å—Ç", "–¢–µ–Ω–Ω–∏—Å–∏—Å—Ç", "–®–∞—Ö–º–∞—Ç–∏—Å—Ç", "–ë–æ–∫—Å–µ—Ä",
    "–ë–æ—Ä–µ—Ü",
    "–õ—ã–∂–Ω–∏–∫", "–ü–ª–æ–≤–µ—Ü", "–ì–∏–º–Ω–∞—Å—Ç", "–ê–∫—Ä–æ–±–∞—Ç", "–ö–ª–æ—É–Ω", "–§–æ–∫—É—Å–Ω–∏–∫", "–ü—É—Ç–µ—à–µ—Å—Ç–≤–µ–Ω–Ω–∏–∫", "–¢—É—Ä–∏—Å—Ç", "–ü–∏–ª–æ—Ç", "–ö–æ—Å–º–æ–Ω–∞–≤—Ç",
    "–ü–æ–ª–∏—Ü–µ–π—Å–∫–∏–π", "–°–æ–ª–¥–∞—Ç", "–û—Ñ–∏—Ü–µ—Ä", "–ì–µ–Ω–µ—Ä–∞–ª", "–ú–∏–Ω–∏—Å—Ç—Ä", "–ü—Ä–µ–∑–∏–¥–µ–Ω—Ç", "–î–µ–ø—É—Ç–∞—Ç", "–°—É–¥—å—è", "–ê–¥–≤–æ–∫–∞—Ç", "–Æ—Ä–∏—Å—Ç"
]

TEMPLATE_QUEST_PATH = "word_quest.png"  # —Ç–≤–æ–π –ø—É—Å—Ç–æ–π —à–∞–±–ª–æ–Ω
TEMPLATE_MENU_QUEST_PATH = "Menu_quest.png"
QUEST_FONT_PATH = "ARIBLK.TTF"  # —à—Ä–∏—Ñ—Ç, –ø–æ–ª–æ–∂–∏ –≤ –ø–∞–ø–∫—É —Ä—è–¥–æ–º —Å –±–æ—Ç–æ–º


# --- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–ª–æ–≤–∞ —Å –ø–æ–¥—Å–∫–∞–∑–∫–æ–π –¥–ª—è —É–≥–∞–¥—ã–≤–∞–Ω–∏—è ---
def word_quest_generate_hint_image(word, hint_indices):
    img = Image.open(TEMPLATE_QUEST_PATH).convert("RGBA")
    draw = ImageDraw.Draw(img)
    font = ImageFont.truetype(QUEST_FONT_PATH, 72)

    # –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É, –æ—Å—Ç–∞–≤–ª—è—è —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã –∏–∑ hint_indices
    hint_word = "".join([c if i in hint_indices else "_" for i, c in enumerate(word)])

    # –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ü–µ–Ω—Ç—Ä–∞ –ø–æ–ª—è –Ω–∞ —à–∞–±–ª–æ–Ω–µ
    center_x, center_y = 406, 344

    # –ü–æ–ª—É—á–∞–µ–º —à–∏—Ä–∏–Ω—É –∏ –≤—ã—Å–æ—Ç—É —Ç–µ–∫—Å—Ç–∞
    text_bbox = draw.textbbox((0, 0), hint_word, font=font)  # (x0, y0, x1, y1)
    text_width = text_bbox[2] - text_bbox[0]
    text_height = text_bbox[3] - text_bbox[1]

    # –í—ã—á–∏—Å–ª—è–µ–º –≤–µ—Ä—Ö–Ω–∏–π –ª–µ–≤—ã–π —É–≥–æ–ª, —á—Ç–æ–±—ã —Ç–µ–∫—Å—Ç –±—ã–ª –ø–æ —Ü–µ–Ω—Ç—Ä—É –ø–æ–ª—è
    x = center_x - text_width // 2
    y = center_y - text_height // 2

    draw.text((x, y), hint_word, font=font, fill="white")

    bio = io.BytesIO()
    bio.name = "hint.png"
    img.save(bio, "PNG")
    bio.seek(0)
    return bio


# --- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–≤–µ—Å—Ç–æ–≤–æ–≥–æ –º–µ–Ω—é —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —Å–æ–±—Ä–∞–Ω–Ω—ã—Ö —Å–ª–æ–≤ ---
def word_quest_generate_menu_image(collected):
    img = Image.open(TEMPLATE_MENU_QUEST_PATH).convert("RGBA")
    draw = ImageDraw.Draw(img)
    font = ImageFont.truetype(QUEST_FONT_PATH, 48)

    # –ï—Å–ª–∏ collected –ø—É—Å—Ç–æ–µ, —Å—Ç–∞–≤–∏–º 0
    if collected is None:
        collected = 0

    text = str(collected)

    # –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ü–µ–Ω—Ç—Ä–∞ –ø–æ–ª—è –Ω–∞ —à–∞–±–ª–æ–Ω–µ
    center_x, center_y = 697, 763

    # –ü–æ–ª—É—á–∞–µ–º —à–∏—Ä–∏–Ω—É —Ç–µ–∫—Å—Ç–∞
    text_bbox = draw.textbbox((0, 0), text, font=font)  # (x0, y0, x1, y1)
    text_width = text_bbox[2] - text_bbox[0]
    text_height = text_bbox[3] - text_bbox[1]

    # –í—ã—á–∏—Å–ª—è–µ–º –≤–µ—Ä—Ö–Ω–∏–π –ª–µ–≤—ã–π —É–≥–æ–ª, —á—Ç–æ–±—ã —Ç–µ–∫—Å—Ç –±—ã–ª –ø–æ —Ü–µ–Ω—Ç—Ä—É –ø–æ–ª—è
    x = center_x - text_width // 2
    y = center_y - text_height // 2

    draw.text((x, y), text, font=font, fill="white")

    bio = io.BytesIO()
    bio.name = "quest_menu.png"
    img.save(bio, "PNG")
    bio.seek(0)
    return bio


# --- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–ª–æ–≤–∞ ---
def word_quest_check_word(user_word, target_word):
    return user_word.strip().lower() == target_word.lower()


# --- –ö–æ–º–∞–Ω–¥–∞ /quest ---
async def word_quest_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = str(update.effective_user.id)
    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()
        # –°–æ–∑–¥–∞—ë–º –∑–∞–ø–∏—Å—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –∫–≤–µ—Å—Ç–∞, –µ—Å–ª–∏ –Ω–µ—Ç
        cursor.execute("INSERT OR IGNORE INTO users (user_id) VALUES (?)", (user_id,))
        cursor.execute("INSERT OR IGNORE INTO user_quests (user_id) VALUES (?)", (user_id,))
        conn.commit()

        cursor.execute("SELECT quest_last, quest_collected FROM user_quests WHERE user_id=?", (user_id,))
        row = cursor.fetchone()
        now_ts = int(datetime.now().timestamp())

        last_ts = row[0]
        collected = row[1]

        if now_ts - last_ts < QUEST_COOLDOWN:
            remaining = QUEST_COOLDOWN - (now_ts - last_ts)
            await update.message.reply_text(f"‚è≥ –ü–æ–¥–æ–∂–¥–∏—Ç–µ {remaining} —Å–µ–∫—É–Ω–¥ –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–ª–æ–≤–∞.")
            return

    # –°–Ω–∞—á–∞–ª–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç
    msg = await update.message.reply_text("üìÇ <b>–ú–µ–Ω—é –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è...</b>\n<pre>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞ –ø–æ–¥–æ–∂–¥–∏—Ç–µ ‚âà 1 –º–∏–Ω.</pre>",
                                          parse_mode="HTML")

    # –ù–µ–º–Ω–æ–≥–æ –ø–æ–¥–æ–∂–¥—ë–º, —á—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ–ª —É–≤–∏–¥–µ—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
    await asyncio.sleep(1)

    keyboard = [[InlineKeyboardButton("–°–æ–±—Ä–∞—Ç—å —Å–ª–æ–≤–æ", callback_data="word_quest_collect")]]
    reply_markup = InlineKeyboardMarkup(keyboard)

    # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–∞—Ä—Ç–∏–Ω–∫–∏ –º–µ–Ω—é —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —Å–æ–±—Ä–∞–Ω–Ω—ã—Ö —Å–ª–æ–≤
    menu_img = word_quest_generate_menu_image(collected)

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ç–æ
    await update.message.reply_photo(
        photo=InputFile(menu_img),
        caption=f"üìú –ö–≤–µ—Å—Ç–æ–≤–æ–µ –º–µ–Ω—é.",
        reply_markup=reply_markup
    )

    # –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ç–µ–∫—Å—Ç–æ–º, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    await msg.delete()


async def word_quest_button_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    user_id = str(query.from_user.id)
    await query.answer()

    if query.data == "word_quest_collect":
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ cooldown
        with sqlite3.connect(DB_PATH) as conn:
            cursor = conn.cursor()
            cursor.execute("SELECT quest_last FROM user_quests WHERE user_id=?", (user_id,))
            row = cursor.fetchone()
            last_ts = row[0] if row else 0

        now_ts = int(datetime.now().timestamp())
        if now_ts - last_ts < QUEST_COOLDOWN:
            remaining = QUEST_COOLDOWN - (now_ts - last_ts)
            await query.message.reply_text(f"‚è≥ –ü–æ–¥–æ–∂–¥–∏—Ç–µ {remaining} —Å–µ–∫—É–Ω–¥ –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–ª–æ–≤–∞.")
            return  # –Ω–µ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é —Å–ª–æ–≤–∞

        # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–æ–π
        try:
            await query.message.delete()
        except:
            pass

        # –°—Ä–∞–∑—É –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç "–ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª–æ–≤–æ..."
        msg = await query.message.chat.send_message(
            "üî§ <b>–ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª–æ–≤–æ...</b>\n<pre>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞ –ø–æ–¥–æ–∂–¥–∏—Ç–µ ‚âà 1 –º–∏–Ω.</pre>",
            parse_mode="HTML"
        )

        await asyncio.sleep(1)  # —ç—Ñ—Ñ–µ–∫—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏

        # –í—ã–±–∏—Ä–∞–µ–º —Å–ª–æ–≤–æ –∏ —Ñ–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É
        word = random.choice(WORDS)
        hint_indices = random.sample(range(len(word)), k=min(3, len(word)))  # –∑–∞—â–∏—Ç–∞ –æ—Ç –∫–æ—Ä–æ—Ç–∫–∏—Ö —Å–ª–æ–≤
        context.user_data["quest_word"] = word
        context.user_data["quest_hint_indices"] = hint_indices
        context.user_data["quest_attempts"] = 0
        context.user_data["quest_start"] = datetime.now()

        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É —Å –ø–æ–¥—Å–∫–∞–∑–∫–æ–π
        img = word_quest_generate_hint_image(word, hint_indices)
        img.seek(0)
        input_file = InputFile(img, filename="hint.png")

        keyboard = [[InlineKeyboardButton("–û—Ç–º–µ–Ω–∞", callback_data="word_quest_cancel")]]
        reply_markup = InlineKeyboardMarkup(keyboard)

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ñ–æ—Ç–æ –∏ –∫–Ω–æ–ø–∫–æ–π
        await query.message.chat.send_photo(
            photo=input_file,
            caption="üî§ <b>–°–ª–æ–≤–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ.</b>\n"
                    "<pre>–£ –≤–∞—Å –µ—Å—Ç—å 5 –º–∏–Ω –Ω–∞ —É–≥–∞–¥—ã–≤–∞–Ω–∏–µ —Å–ª–æ–≤–∞.</pre>",
            reply_markup=reply_markup, parse_mode="HTML"
        )

        # –û–±–Ω–æ–≤–ª—è–µ–º quest_last –≤ –ë–î, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å cooldown
        with sqlite3.connect(DB_PATH) as conn:
            cursor = conn.cursor()
            cursor.execute("UPDATE user_quests SET quest_last=? WHERE user_id=?", (now_ts, user_id))
            conn.commit()

        # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å "–ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª–æ–≤–æ..."
        await msg.delete()


async def word_quest_message_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if "quest_word" not in context.user_data:
        return

    user_word = update.message.text
    word = context.user_data["quest_word"]
    attempts = context.user_data.get("quest_attempts", 0) + 1
    context.user_data["quest_attempts"] = attempts
    user_id = str(update.effective_user.id)

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—ã—à–ª–æ –ª–∏ –≤—Ä–µ–º—è (5 –º–∏–Ω—É—Ç = 300 —Å–µ–∫—É–Ω–¥)
    elapsed = (datetime.now() - context.user_data["quest_start"]).total_seconds()
    if elapsed > 300:
        context.user_data.clear()
        await update.message.reply_text(
            f"‚è∞ <b>–í—Ä–µ–º—è –≤—ã—à–ª–æ!</b>\n"
            f"<pre>üò¢ –í—ã –Ω–µ —É—Å–ø–µ–ª–∏ —É–≥–∞–¥–∞—Ç—å —Å–ª–æ–≤–æ...</pre>\n"
            f"üìù –°–ª–æ–≤–æ: <b>{word}</b> ‚ùó",
            parse_mode="HTML"
        )

        return  # –∫–≤–µ—Å—Ç –∑–∞–≤–µ—Ä—à—ë–Ω, –¥–∞–ª—å–Ω–µ–π—à–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π –Ω–µ—Ç

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–≤–µ—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    if word_quest_check_word(user_word, word):
        coins = random.randint(1000, 20000)
        dc = random.randint(1, 10)
        exp = random.randint(10, 50)

        with sqlite3.connect(DB_PATH) as conn:
            cursor = conn.cursor()
            cursor.execute("""
            UPDATE user_quests
            SET quest_last=?, quest_attempts=quest_attempts+?, quest_collected=quest_collected+1
            WHERE user_id=?
            """, (int(datetime.now().timestamp()), attempts, user_id))

            cursor.execute("""
            UPDATE users
            SET balance=balance+?, exp=exp+?, dc_balance=dc_balance+?
            WHERE user_id=?
            """, (coins, exp, dc, user_id))
            conn.commit()

            cursor.execute("SELECT quest_collected FROM user_quests WHERE user_id=?", (user_id,))
            row = cursor.fetchone()
            if row:
                collected = row[0]
            else:
                collected = 0

        await update.message.reply_text(
            f"ü•≥ <b>–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!</b> –í—ã —É–≥–∞–¥–∞–ª–∏ —Å–ª–æ–≤–æ!\n\n"
            f"üìù –°–ª–æ–≤–æ: <b>{word}</b>\n"
            f"üî¢ –ü–æ–ø—ã—Ç–æ–∫: {attempts}\n\n"
            f"<pre>üí∞ {coins}‚ÇΩ\n"
            f"üíé {dc} DC\n"
            f"‚ú® {exp} exp</pre>",
            parse_mode="HTML"
        )

        # –û–±–Ω–æ–≤–ª—è–µ–º –º–µ–Ω—é —Å –Ω–æ–≤—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —Å–ª–æ–≤
        menu_img = word_quest_generate_menu_image(collected)
        keyboard = [[InlineKeyboardButton("–°–æ–±—Ä–∞—Ç—å —Å–ª–æ–≤–æ", callback_data="word_quest_collect")]]
        reply_markup = InlineKeyboardMarkup(keyboard)
        await update.message.reply_photo(
            photo=InputFile(menu_img),
            caption=f"üìú –ö–≤–µ—Å—Ç–æ–≤–æ–µ –º–µ–Ω—é.",
            reply_markup=reply_markup
        )

        context.user_data.clear()
    else:
        remaining = max(0, 300 - int(elapsed))
        await update.message.reply_text(f"‚ùå <b>–°–ª–æ–≤–æ –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç...</b>\n<pre>–û—Å—Ç–∞–ª–æ—Å—å: {remaining} —Å–µ–∫.</pre>",
                                        parse_mode="HTML")


# --- –û—Ç–º–µ–Ω–∞ –∫–≤–µ—Å—Ç–∞ ---
async def word_quest_cancel_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    context.user_data.clear()
    await query.edit_message_caption("‚ùå –ö–≤–µ—Å—Ç –æ—Ç–º–µ–Ω—ë–Ω.")


ADMIN_CHAT_ID = -1003319582175


# /bug {–æ–ø–∏—Å–∞–Ω–∏–µ –±–∞–≥–∞}
async def bug_report(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user

    if not context.args:
        await update.message.reply_text("‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /–±–∞–≥ <–æ–ø–∏—Å–∞–Ω–∏–µ –±–∞–≥–∞>")
        return

    description = " ".join(context.args)
    display_name = get_display_name_html_new(user)

    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–≥–æ —Ç–µ–≥–Ω—É—Ç—å (—Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∏ —Å–ø–µ—Ü. –∞–¥–º–∏–Ω–æ–≤)
    mentions = []
    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()
        cursor.execute("SELECT user_id, status FROM users")
        rows = cursor.fetchall()
        for user_id, status in rows:
            try:
                status = int(status)
                if status in [11, 12]:  # —Å–ø–µ—Ü. –∞–¥–º–∏–Ω –∏ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫
                    # –ü–æ–ª—É—á–∞–µ–º –æ–±—ä–µ–∫—Ç user —á–µ—Ä–µ–∑ API
                    try:
                        member = await context.bot.get_chat_member(ADMIN_CHAT_ID, int(user_id))
                        user_obj = member.user
                    except Exception:
                        user_obj = None

                    if user_obj:
                        mentions.append(get_display_name_html_new(user_obj))
            except Exception:
                continue

    mentions_str = " ".join(mentions) if mentions else "‚Äî"

    moscow_tz = pytz.timezone("Europe/Moscow")
    now = datetime.now(moscow_tz)
    date_str = now.strftime("%d.%m.%Y")
    time_str = now.strftime("%H:%M:%S")

    text = (
        f"üëë <b>–†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ:</b>\n"
        f"{mentions_str}\n\n"
        f"üö® <b>–ü—Ä–∏—à–µ–ª –Ω–æ–≤—ã–π Bug-Report</b>\n\n"
        f"üë§ <b>–û—Ç–ø—Ä–∞–≤–∏–ª:</b> {display_name}\n"
        f"üÜî <b>TelegramID:</b> <code>{user.id}</code>\n\n"
        f"üìù <b>–û–ø–∏—Å–∞–Ω–∏–µ:</b>\n{html.escape(description)}\n\n"
        f"üìÖ <b>–î–∞—Ç–∞:</b> {date_str}\n"
        f"‚è∞ <b>–í—Ä–µ–º—è:</b> {time_str}"
    )

    await context.bot.send_message(
        chat_id=ADMIN_CHAT_ID,
        text=text,
        parse_mode="HTML"
    )

    await update.message.reply_text("‚úÖ –í–∞—à <b>–±–∞–≥-—Ä–µ–ø–æ—Ä—Ç</b> —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏—é.", parse_mode="HTML")


callback_handler_weather = CallbackQueryHandler(
    button_callback,
    pattern=r"^(day|week)\|.+"
)


# === –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –¥–ª—è /chat ===
async def get_chat_info_content(chat_id: str) -> tuple[str, InlineKeyboardMarkup]:
    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()

        # === –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü ===
        cursor.execute("""
        CREATE TABLE IF NOT EXISTS chats_admins (
            chat_id TEXT PRIMARY KEY,
            chat_title TEXT DEFAULT '',
            created_at TEXT DEFAULT CURRENT_TIMESTAMP
        )
        """)
        cursor.execute("""
        CREATE TABLE IF NOT EXISTS chat_admins (
            chat_id TEXT NOT NULL,
            user_id TEXT NOT NULL,
            username TEXT,
            name TEXT,
            updated_at TEXT,
            admin_level INTEGER DEFAULT 0,
            added_at TEXT DEFAULT CURRENT_TIMESTAMP,
            PRIMARY KEY (chat_id, user_id),
            FOREIGN KEY (chat_id) REFERENCES chats_admins(chat_id) ON DELETE CASCADE
        )
        """)
        cursor.execute("""
        CREATE TABLE IF NOT EXISTS chat_settings (
            chat_id TEXT PRIMARY KEY,
            mute_level INTEGER DEFAULT 7,
            kick_level INTEGER DEFAULT 7,
            ban_level INTEGER DEFAULT 7,
            pin_level INTEGER DEFAULT 7,
            unmute_level INTEGER DEFAULT 7,
            role_change INTEGER DEFAULT 7,
            change_settings INTEGER DEFAULT 7,
            antispam INTEGER DEFAULT 1,
            broadcast_enabled INTEGER DEFAULT 1,
            created_at TEXT DEFAULT CURRENT_TIMESTAMP,
            updated_at TEXT DEFAULT CURRENT_TIMESTAMP
        )
        """)

        conn.commit()

        # === –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é —á–∞—Ç–∞ ===
        cursor.execute("SELECT chat_title FROM chats_admins WHERE chat_id = ?", (chat_id,))
        row = cursor.fetchone()
        if not row:
            return (
                "‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —á–∞—Ç–µ.\n"
                "–ù–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏. –ü–æ—Ö–æ–∂–µ –≤—ã –µ—â–µ –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª–∏ —á–∞—Ç.\n"
                "–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É /connect",
                None
            )
        chat_title = row[0]

        # === –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ —Å–æ–∑–¥–∞—ë–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç ===
        cursor.execute("SELECT chat_id FROM chat_settings WHERE chat_id = ?", (chat_id,))
        if not cursor.fetchone():
            cursor.execute("""
                INSERT INTO chat_settings (
                    chat_id, mute_level, kick_level, ban_level, pin_level, unmute_level,
                    role_change, change_settings, antispam
                ) VALUES (?, 7, 7, 7, 7, 7, 7, 7, 1)
            """, (chat_id,))
            conn.commit()

        # === –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç—É—Å –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ ===
        cursor.execute("SELECT verification FROM chat_verification WHERE chat_id = ?", (chat_id,))
        row = cursor.fetchone()
        verification_status = row[0] if row else "‚ùå"  # ‚ùå –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –µ—Å–ª–∏ –Ω–µ—Ç –∑–∞–ø–∏—Å–∏

        # === –û—Å–Ω–æ–≤–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ ‚Äî –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —á–∞—Ç–µ ===
        text = (
            f"‚ÑπÔ∏è <b>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —á–∞—Ç–µ</b>\n"
            f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
            f"üè∑ –ù–∞–∑–≤–∞–Ω–∏–µ: <b>{chat_title}</b>\n"
            f"üÜî ChatID: <code>{chat_id}</code>\n"
            f"‚úÖ –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è: {verification_status}\n"
            f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
            f"<pre>–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –ß–∞—Ç–∞ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ —á–∞—Ç –±—ã–ª –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–µ–π FernieX.</pre>"
        )

        # === –ö–Ω–æ–ø–∫–∏ –º–µ–Ω—é ===
        keyboard = [
            [InlineKeyboardButton("üëë –°–ø–∏—Å–æ–∫ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏", callback_data="chat_menu_admins")],
            [InlineKeyboardButton("‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏", callback_data="chat_menu_settings")],
            [InlineKeyboardButton("üì¢ –†–∞—Å—Å—ã–ª–∫–∞", callback_data="chat_menu_broadcast")]
        ]

        return text, InlineKeyboardMarkup(keyboard)


# === /chat ===
async def chat_info(update: Update, context: ContextTypes.DEFAULT_TYPE):
    chat_id = str(update.effective_chat.id)
    text, markup = await get_chat_info_content(chat_id)
    if markup:
        await update.message.reply_text(text, reply_markup=markup, parse_mode="HTML")
    else:
        await update.message.reply_text(text, parse_mode="HTML")


# === –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Ä–æ–≤–Ω—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —á–∞—Ç–µ ===
def get_user_level_chat(chat_id: int, user_id: int) -> int:
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("""
        SELECT admin_level FROM chat_admins
        WHERE chat_id = ? AND user_id = ?
    """, (str(chat_id), str(user_id)))
    row = cursor.fetchone()
    conn.close()
    return int(row[0]) if row else 0


async def set_chat_verification(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ ‚Äî —Ç–æ–ª—å–∫–æ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫
    if user_id != DEVELOPER_ID:
        await update.message.reply_text("üö´ –¢–æ–ª—å–∫–æ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ –º–æ–∂–µ—Ç –º–µ–Ω—è—Ç—å —Å—Ç–∞—Ç—É—Å –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏.")
        return

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤
    if len(context.args) != 2:
        await update.message.reply_text("–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /–≤—á–∞—Ç <chatID> <0/1>\n0 = ‚ùå, 1 = ‚úÖ")
        return

    chat_id, status_str = context.args
    if status_str not in ("0", "1"):
        await update.message.reply_text("–°—Ç–∞—Ç—É—Å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 0 (‚ùå) –∏–ª–∏ 1 (‚úÖ)")
        return

    # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º 0/1 –≤ —Å–º–∞–π–ª–∏–∫
    status = "‚úÖ" if status_str == "1" else "‚ùå"

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –±–∞–∑—É
    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()
        cursor.execute("""
            INSERT INTO chat_verification (chat_id, verification)
            VALUES (?, ?)
            ON CONFLICT(chat_id) DO UPDATE SET verification=excluded.verification
        """, (chat_id, status))
        conn.commit()

    await update.message.reply_text(
        f"‚ö° <b>–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è —á–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞</b>\n\n"
        f"üè∑ <b>ChatID:</b> <code>{chat_id}</code>\n"
        f"‚úÖ <b>–°—Ç–∞—Ç—É—Å:</b> {status}",
        parse_mode="HTML"
    )


# === –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–æ–∫ ===
async def chat_buttons(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    chat_id = str(update.effective_chat.id)
    user_id = query.from_user.id

    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()

        # --- –°–ø–∏—Å–æ–∫ –∞–¥–º–∏–Ω–æ–≤ ---
        if query.data == "chat_menu_admins":
            cursor.execute("""
                SELECT user_id, admin_level
                FROM chat_admins WHERE chat_id = ?
                ORDER BY admin_level DESC
            """, (chat_id,))
            admins = cursor.fetchall()

            LEVEL_ICONS = {
                0: ("üë§", "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"),
                1: ("üîπ", "–ú–ª. –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä"),
                2: ("üõ†Ô∏è", "–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä"),
                3: ("üî∞", "–°—Ç. –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä"),
                4: ("üìã", "–ú–ª. –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä"),
                5: ("‚öîÔ∏è", "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä"),
                6: ("üõ°Ô∏è", "–°—Ç. –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä"),
                7: ("üëë", "–í–ª–∞–¥–µ–ª–µ—Ü"),
            }

            if not admins:
                text = (
                    "üë• <b>–°–ø–∏—Å–æ–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏</b>\n\n"
                    "üò∂ –í —ç—Ç–æ–º —á–∞—Ç–µ –ø–æ–∫–∞ –Ω–µ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤."
                )
            else:
                lines = ["üë• <b>–°–ø–∏—Å–æ–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏</b>"]

                from itertools import groupby
                for level, group in groupby(admins, key=lambda x: x[1]):
                    icon, role_name = LEVEL_ICONS.get(level, ("üî∏", f"–£—Ä–æ–≤–µ–Ω—å {level}"))
                    lines.append(f"\n{icon} <b>{role_name}</b>")
                    for uid, _ in group:
                        display = get_display_name_html_by_id(uid)
                        lines.append(f"‚Ä¢ {display} <code>({uid})</code>")

                text = "\n".join(lines)

            keyboard = [[InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="chat_menu_back")]]
            await query.edit_message_text(text, reply_markup=InlineKeyboardMarkup(keyboard), parse_mode="HTML")

        # --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ---
        elif query.data == "chat_menu_settings":
            cursor.execute("""
                SELECT mute_level, kick_level, ban_level, pin_level, unmute_level, 
                       role_change, change_settings, antispam, broadcast_enabled
                FROM chat_settings WHERE chat_id = ?
            """, (chat_id,))
            settings = cursor.fetchone()
            if not settings:
                cursor.execute("""
                    INSERT INTO chat_settings (
                        chat_id, mute_level, kick_level, ban_level, pin_level, unmute_level,
                        role_change, change_settings, antispam, broadcast_enabled
                    ) VALUES (?, 7, 7, 7, 7, 7, 7, 7, 1, 1)
                """, (chat_id,))
                conn.commit()
                settings = (7, 7, 7, 7, 7, 7, 7, 1, 1)

            mute, kick, ban, pin, unmute, role, change, antispam, broadcast_enabled = settings
            text = (
                f"‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —á–∞—Ç–∞:\n"
                f"üîá Mute: {mute}\n"
                f"üë¢ Kick: {kick}\n"
                f"‚õî Ban: {ban}\n"
                f"üìå Pin: {pin}\n"
                f"üîä Unmute: {unmute}\n"
                f"üë§ –°–º–µ–Ω–∞ —Ä–æ–ª–µ–π: {role}\n"
                f"‚öôÔ∏è –ò–∑–º–µ–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫: {change}\n"
                f"üõ°Ô∏è –ê–Ω—Ç–∏—Å–ø–∞–º: {'‚úÖ –í–∫–ª' if antispam else '‚ùå –í—ã–∫–ª'}\n"
                f"üì¢ –†–∞—Å—Å—ã–ª–∫–∞: {'‚úÖ' if broadcast_enabled else '‚ùå'}"
            )
            keyboard = [[InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="chat_menu_back")]]
            await query.edit_message_text(text, reply_markup=InlineKeyboardMarkup(keyboard))

        # --- –ú–µ–Ω—é —Ä–∞—Å—Å—ã–ª–∫–∏ ---
        elif query.data == "chat_menu_broadcast":
            cursor.execute("SELECT broadcast_enabled FROM chat_settings WHERE chat_id = ?", (chat_id,))
            row = cursor.fetchone()
            if not row:
                # –ï—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –Ω–µ—Ç, —Å–æ–∑–¥–∞–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ
                cursor.execute("""
                    INSERT INTO chat_settings (
                        chat_id, mute_level, kick_level, ban_level, pin_level, unmute_level,
                        role_change, change_settings, antispam, broadcast_enabled
                    ) VALUES (?, 7,7,7,7,7,7,7,1,1)
                """, (chat_id,))
                conn.commit()
                broadcast_enabled = 1
            else:
                broadcast_enabled = row[0]

            state_text = "‚úÖ" if broadcast_enabled else "‚ùå"

            text = (
                f"‚ö° <b>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–∞—Å—Å—ã–ª–∫–∏</b>\n\n"
                "üì¢ <i>–†–∞—Å—Å—ã–ª–∫–∞ ‚Äî –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ:</i>\n"
                "üÜï –û–±–Ω–æ–≤–ª–µ–Ω–∏—è—Ö\n"
                "üõ†Ô∏è –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö —Ä–∞–±–æ—Ç–∞—Ö\n"
                "üéâ –ò–≤–µ–Ω—Ç-—Å–æ–±—ã—Ç–∏—è—Ö\n"
                "üì∞ –î—Ä—É–≥–∏—Ö –Ω–æ–≤–æ—Å—Ç—è—Ö –≤ –∂–∏–∑–Ω–∏ –±–æ—Ç–∞\n\n"
                f"<b>–°–æ—Å—Ç–æ—è–Ω–∏–µ:</b> {state_text}"
            )

            # –ö–Ω–æ–ø–∫–∞ –≤–∫–ª—é—á–µ–Ω–∏—è/–≤—ã–∫–ª—é—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª—å—Ü—É (7 —É—Ä–æ–≤–µ–Ω—å)
            user_level = get_user_level_chat(int(chat_id), user_id)
            if user_level == 7:
                toggle_button = InlineKeyboardButton(
                    "‚ùå –í—ã–∫–ª—é—á–∏—Ç—å" if broadcast_enabled else "‚úÖ –í–∫–ª—é—á–∏—Ç—å",
                    callback_data="chat_menu_broadcast_toggle"
                )
                keyboard = [
                    [toggle_button],
                    [InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="chat_menu_back")]
                ]
            else:
                keyboard = [[InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="chat_menu_back")]]

            await query.edit_message_text(text, reply_markup=InlineKeyboardMarkup(keyboard), parse_mode='HTML')


        # --- –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–∞—Å—Å—ã–ª–∫–∏ ---
        elif query.data == "chat_menu_broadcast_toggle":
            user_level = get_user_level_chat(int(chat_id), user_id)
            if user_level != 7:
                await query.answer("üö´ –¢–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü —á–∞—Ç–∞ –º–æ–∂–µ—Ç –º–µ–Ω—è—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–∞—Å—Å—ã–ª–∫–∏", show_alert=True)
                return

            cursor.execute("SELECT broadcast_enabled FROM chat_settings WHERE chat_id = ?", (chat_id,))
            current = cursor.fetchone()[0]
            new_status = 0 if current else 1
            cursor.execute("UPDATE chat_settings SET broadcast_enabled = ? WHERE chat_id = ?", (new_status, chat_id))
            conn.commit()
            await query.answer("‚úÖ –°—Ç–∞—Ç—É—Å —Ä–∞—Å—Å—ã–ª–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω")

            # –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –º–µ–Ω—é —Ä–∞—Å—Å—ã–ª–∫–∏ –ø—Ä—è–º–æ –∑–¥–µ—Å—å
            broadcast_enabled = new_status
            state_text = "‚úÖ" if broadcast_enabled else "‚ùå"

            text = (
                f"‚ö° <b>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–∞—Å—Å—ã–ª–∫–∏</b>\n\n"
                "üì¢ <i>–†–∞—Å—Å—ã–ª–∫–∞ ‚Äî –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è</i> –æ:\n"
                "üÜï –û–±–Ω–æ–≤–ª–µ–Ω–∏—è—Ö\n"
                "üõ†Ô∏è –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö —Ä–∞–±–æ—Ç–∞—Ö\n"
                "üéâ –ò–≤–µ–Ω—Ç-—Å–æ–±—ã—Ç–∏—è—Ö\n"
                "üì∞ –î—Ä—É–≥–∏—Ö –Ω–æ–≤–æ—Å—Ç—è—Ö –≤ –∂–∏–∑–Ω–∏ –±–æ—Ç–∞\n\n"
                f"<b>–°–æ—Å—Ç–æ—è–Ω–∏–µ:</b> {state_text}"
            )

            if user_level == 7:
                toggle_button = InlineKeyboardButton(
                    "‚ùå –í—ã–∫–ª—é—á–∏—Ç—å" if broadcast_enabled else "‚úÖ –í–∫–ª—é—á–∏—Ç—å",
                    callback_data="chat_menu_broadcast_toggle"
                )
                keyboard = [
                    [toggle_button],
                    [InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="chat_menu_back")]
                ]
            else:
                keyboard = [[InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="chat_menu_back")]]

            await query.edit_message_text(text, reply_markup=InlineKeyboardMarkup(keyboard), parse_mode='HTML')

        # --- –ù–∞–∑–∞–¥ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é ---
        elif query.data == "chat_menu_back":
            text, markup = await get_chat_info_content(chat_id)
            if markup:
                await query.edit_message_text(text, reply_markup=markup, parse_mode="HTML")
            else:
                await query.edit_message_text(text, parse_mode="HTML")


def add_broadcast_enabled_field():
    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∫–æ–ª–æ–Ω–∫–∞ broadcast_enabled
        cursor.execute("PRAGMA table_info(chat_settings)")
        columns = [col[1] for col in cursor.fetchall()]
        if "broadcast_enabled" not in columns:
            cursor.execute("ALTER TABLE chat_settings ADD COLUMN broadcast_enabled INTEGER DEFAULT 1")
            print("‚úÖ –ü–æ–ª–µ broadcast_enabled –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ chat_settings")
        else:
            print("‚ÑπÔ∏è –ü–æ–ª–µ broadcast_enabled —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç")

#################################################################   Fernie+  Custom   ####################################################################################

BACKGROUNDS = [
    {"file": "profile_def.png", "name": "–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ñ–æ–Ω", "arg": "def"},
    {"file": "girl2.png", "name": "–ú–∞–Ω–∏—Ñ–µ—Å—Ç –æ–¥–∏–Ω–æ—á–µ—Å—Ç–≤–∞", "arg": "girl2"},
    {"file": "watergirl2.png", "name": "–ú–≥–Ω–æ–≤–µ–Ω–∏–µ", "arg": "watergirl2"},
    {"file": "watergirl.png", "name": "–®—ë–ø–æ—Ç —Ç—É–º–∞–Ω–∞", "arg": "watergirl"},
    {"file": "lizka.png", "name": "Lizka", "arg": "lizka", "buy_id": "456", "price": 50000},

    #gif
    {"file": "gif_1.gif", "name": "–î–µ–≤—É—à–∫–∞ –∏ —á–∞–π", "arg": "gif_1"},
    {"file": "gif_2.gif", "name": "–î–æ–≤–æ–ª—å–Ω—ã–π –∫–æ—Ç–∏–∫", "arg": "gif_2"},
    {"file": "gif_3.gif", "name": "–ü—ç—Å", "arg": "gif_3"},
    {"file": "gif_4.gif", "name": "Anime Edit - 1", "arg": "gif_4"}
]

RP_JSON = "rp_commands.json"


# === JSON —Ä–∞–±–æ—Ç–∞ ===
def load_rp():
    if not os.path.exists(RP_JSON):
        return {}
    with open(RP_JSON, "r", encoding="utf-8") as f:
        return json.load(f)


def save_rp(data):
    with open(RP_JSON, "w", encoding="utf-8") as f:
        json.dump(data, f, ensure_ascii=False, indent=2)


# === –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ Fernie+ ===
def has_fernie_plus(user_id: int) -> bool:
    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()
        cursor.execute("SELECT end_time FROM SubFerniePlus WHERE user_id = ?", (user_id,))
        result = cursor.fetchone()
        return bool(result and result[0] > time.time())


# === –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π RP ===
async def handle_rp(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not update.message:
        return

    user_id = str(update.effective_user.id)
    text = update.message.text.strip()

    # --- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π RP-–∫–æ–º–∞–Ω–¥—ã (+–º—Ä–ø / –º—Ä–ø+) ---
    if text.lower().startswith("–º—Ä–ø+"):
        if not has_fernie_plus(update.effective_user.id):
            await update.message.reply_text("üö´ –£ –≤–∞—Å –Ω–µ—Ç Fernie+")
            return

        cmd_text = text[4:].strip()

        import re
        pattern = re.compile(r'^([^/]{1,35})\s*/\s*(.{1,10})\s*/\s*([^/]{1,75})$')
        match = pattern.match(cmd_text)

        if not match:
            await update.message.reply_text(
                "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∏–ª–∏ –ø—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç —Å–∏–º–≤–æ–ª–æ–≤.\n"
                "–ü—Ä–∏–º–µ—Ä: `–º—Ä–ø+ –ø—Ä–∏–≤–µ—Ç / üëã / –ø–æ–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–æ–≤–∞–ª`",
                parse_mode="Markdown"
            )
            return

        trigger, emoji, rp_text = [x.strip() for x in match.groups()]

        data = load_rp()
        user_cmds = data.get(user_id, {})
        if len(user_cmds) >= 15:
            await update.message.reply_text("‚ùå –õ–∏–º–∏—Ç ‚Äî 15 RP-–∫–æ–º–∞–Ω–¥.")
            return

        user_cmds[trigger.lower()] = {"emoji": emoji, "text": rp_text}
        data[user_id] = user_cmds
        save_rp(data)

        await update.message.reply_text(f"‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ: {emoji} | '{trigger}' ‚Üí '{rp_text}'")
        return

    # --- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ RP-–∫–æ–º–∞–Ω–¥—ã (—Ç–æ–ª—å–∫–æ –≤ –æ—Ç–≤–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ) ---
    if not update.message.reply_to_message:
        return

    data = load_rp()
    user_cmds = data.get(user_id, {})

    # –†–∞–∑–¥–µ–ª—è–µ–º —Ç–µ–∫—Å—Ç –Ω–∞ —Ç—Ä–∏–≥–≥–µ—Ä –∏ —Ä–µ–ø–ª–∏–∫—É
    lines = text.split("\n", 1)
    msg_trigger = lines[0].lower().strip()
    reply_text = lines[1].strip() if len(lines) > 1 else None

    if msg_trigger in user_cmds:
        cmd = user_cmds[msg_trigger]

        # –¢–æ–ª—å–∫–æ Fernie+ –º–æ–≥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å RP
        if not has_fernie_plus(update.effective_user.id):
            await update.message.reply_text("üö´ –£ –≤–∞—Å –Ω–µ—Ç Fernie+")
            return

        sender = get_display_name_html_new(update.effective_user)
        target_user = update.message.reply_to_message.from_user
        target = get_display_name_html_new(target_user)

        response = f"{cmd['emoji']} | {sender} {cmd['text']} {target}"
        if reply_text:
            response += f"\nüí¨ –° —Ä–µ–ø–ª–∏–∫–æ–π: ¬´{html.escape(reply_text)}¬ª"

        await update.message.reply_text(response, parse_mode=ParseMode.HTML)


# === –°–ø–∏—Å–æ–∫ RP-–∫–æ–º–∞–Ω–¥ ---
async def list_rp(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = str(update.effective_user.id)
    data = load_rp()
    user_cmds = data.get(user_id, {})

    if not user_cmds:
        await update.message.reply_text("–£ –≤–∞—Å –Ω–µ—Ç –ª–∏—á–Ω—ã—Ö RP-–∫–æ–º–∞–Ω–¥ üòø")
        return

    header = f"üìú <b>–õ–∏—á–Ω—ã–µ RP-–∫–æ–º–∞–Ω–¥—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</b>\n{get_display_name_html_new(update.effective_user)}\n\n"
    lines = []

    for i, (trigger, cmd) in enumerate(user_cmds.items(), start=1):
        lines.append(f"<b>{i}.</b> <i>{trigger}</i> {cmd['emoji']} ‚Üí <b>{cmd['text']}</b>")

    msg = header + "\n".join(lines)

    await update.message.reply_text(msg, parse_mode=ParseMode.HTML)


# === –£–¥–∞–ª–µ–Ω–∏–µ RP-–∫–æ–º–∞–Ω–¥—ã ---
async def delete_rp(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not has_fernie_plus(update.effective_user.id):
        await update.message.reply_text("üö´ –£ –≤–∞—Å –Ω–µ—Ç Fernie+")
        return

    if len(context.args) != 1 or not context.args[0].isdigit():
        await update.message.reply_text("–ò—Å–ø–æ–ª—å–∑—É–π: –º—Ä–ø- <–Ω–æ–º–µ—Ä –∫–æ–º–∞–Ω–¥—ã>", parse_mode=ParseMode.HTML)
        return

    index = int(context.args[0]) - 1
    user_id = str(update.effective_user.id)
    data = load_rp()
    user_cmds = data.get(user_id, {})

    if index < 0 or index >= len(user_cmds):
        await update.message.reply_text("‚ùå –ö–æ–º–∞–Ω–¥–∞ —Å —Ç–∞–∫–∏–º –Ω–æ–º–µ—Ä–æ–º –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.")
        return

    # –£–¥–∞–ª—è–µ–º –∫–æ–º–∞–Ω–¥—É –ø–æ –Ω–æ–º–µ—Ä—É
    trigger_to_delete = list(user_cmds.keys())[index]
    del user_cmds[trigger_to_delete]
    data[user_id] = user_cmds
    save_rp(data)

    # –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è
    await update.message.reply_text(
        f"‚úÖ RP-–∫–æ–º–∞–Ω–¥–∞ '{trigger_to_delete}' —É–¥–∞–ª–µ–Ω–∞.",
        parse_mode=ParseMode.HTML
    )


CODE_TTL_MINUTES = 10


# ====== –ì–ï–ù–ï–†–ê–¶–ò–Ø –ö–û–î–ê ======
def generate_ccc(length: int = 15) -> str:
    alphabet = string.ascii_letters + string.digits
    return ''.join(secrets.choice(alphabet) for _ in range(length))


# ====== –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∫–æ–¥–æ–≤ ======
def cleanup_expired_codes():
    """–£–¥–∞–ª—è–µ—Ç –∫–æ–¥—ã, —Å—Ç–∞—Ä—à–µ CODE_TTL_MINUTES."""
    conn = sqlite3.connect(DB_PATH)
    c = conn.cursor()
    c.execute(
        "DELETE FROM ChatChangeCode WHERE datetime(created_at) < datetime('now', ?)",
        (f'-{CODE_TTL_MINUTES} minutes',)
    )
    conn.commit()
    conn.close()


# ====== –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–ª–∞–¥–µ–ª—å—Ü–∞ ======
async def is_chat_owner(update: Update, context: ContextTypes.DEFAULT_TYPE) -> bool:
    chat = update.effective_chat
    user = update.effective_user

    try:
        member = await context.bot.get_chat_member(chat.id, user.id)
        return isinstance(member, ChatMemberOwner)
    except Exception:
        return False


async def changecode(update: Update, context: ContextTypes.DEFAULT_TYPE):
    chat = update.effective_chat
    user = update.effective_user

    # –¢–æ–ª—å–∫–æ –≥—Ä—É–ø–ø—ã
    if chat.type == "private":
        await update.message.reply_text(
            "‚ùå –ö–æ–º–∞–Ω–¥–∞ /changecode –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –≤ –≥—Ä—É–ø–ø–∞—Ö.",
            parse_mode="HTML"
        )
        return

    user_id_str = str(user.id)
    chat_id_str = str(chat.id)

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–ª–∞–¥–µ–ª—å—Ü–µ–º –≤ –±–∞–∑–µ
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute(
        "SELECT admin_level FROM chat_admins WHERE chat_id = ? AND user_id = ?",
        (chat_id_str, user_id_str)
    )
    row = cursor.fetchone()
    conn.close()

    if not row or row[0] != 7:  # 7 = "–í–ª–∞–¥–µ–ª–µ—Ü"
        await update.message.reply_text(
            "‚õî –¢–æ–ª—å–∫–æ <b>–≤–ª–∞–¥–µ–ª–µ—Ü —á–∞—Ç–∞</b> (—É—Ä–æ–≤–µ–Ω—å '–í–ª–∞–¥–µ–ª–µ—Ü') –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç—É –∫–æ–º–∞–Ω–¥—É.",
            parse_mode="HTML"
        )
        return

    # –ß–∏—Å—Ç–∏–º —Å—Ç–∞—Ä—ã–µ –∫–æ–¥—ã
    cleanup_expired_codes()

    # –ö–Ω–æ–ø–∫–∞
    keyboard = InlineKeyboardMarkup([
        [InlineKeyboardButton("üì© –ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥", callback_data="get_code")]
    ])

    text = (
        "üîß –î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–¥–∞ –≤—ã –¥–æ–ª–∂–Ω—ã <b>–Ω–∞—á–∞—Ç—å —á–∞—Ç –≤ –ª–∏—á–∫–µ</b> —Å –±–æ—Ç–æ–º, "
        "—á—Ç–æ–±—ã –±–æ—Ç —Å–º–æ–≥ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤–∞–º –∫–æ–¥ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.\n\n"
        f"–ö–æ–¥ –±—É–¥–µ—Ç –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω <b>{CODE_TTL_MINUTES} –º–∏–Ω—É—Ç</b>.\n\n"
        "–ï—Å–ª–∏ –≤—ã —É–∂–µ –Ω–∞—á–∞–ª–∏ —á–∞—Ç ‚Äî –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ üëá"
    )

    await update.message.reply_text(text, parse_mode="HTML", reply_markup=keyboard)


async def get_code_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    user_id = query.from_user.id
    chat = update.effective_chat

    await query.answer()

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–ª–∞–¥–µ–ª–µ—Ü –≤ –±–∞–∑–µ
    conn = sqlite3.connect(DB_PATH)
    c = conn.cursor()
    c.execute(
        "SELECT admin_level FROM chat_admins WHERE chat_id = ? AND user_id = ?",
        (str(chat.id), str(user_id))
    )
    row = c.fetchone()
    conn.close()

    if not row or row[0] != 7:  # 7 = "–í–ª–∞–¥–µ–ª–µ—Ü"
        await query.edit_message_text(
            "‚õî –¢–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü —á–∞—Ç–∞ (—É—Ä–æ–≤–µ–Ω—å '–í–ª–∞–¥–µ–ª–µ—Ü' –≤ –±–∞–∑–µ) –º–æ–∂–µ—Ç –ø–æ–ª—É—á–∞—Ç—å –∫–æ–¥.",
            parse_mode="HTML"
        )
        return

    # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –∫–æ–¥—ã (—Å—Ç–∞—Ä—à–µ TTL)
    cleanup_expired_codes()

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∞–∫—Ç–∏–≤–Ω—ã–π –∫–æ–¥
    conn = sqlite3.connect(DB_PATH)
    c = conn.cursor()
    c.execute(
        "SELECT code, created_at FROM ChatChangeCode WHERE user_id = ? ORDER BY created_at DESC LIMIT 1",
        (user_id,)
    )
    row = c.fetchone()

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∏—Å—Ç—ë–∫ –ª–∏ —Å—Ç–∞—Ä—ã–π –∫–æ–¥
    active_code = None
    if row:
        created_at = datetime.strptime(row[1], "%Y-%m-%d %H:%M:%S")
        if datetime.utcnow() - created_at < timedelta(minutes=CODE_TTL_MINUTES):
            active_code = row[0]

    # –ï—Å–ª–∏ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∫–æ–¥–∞ ‚Äî –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—ã–π
    if not active_code:
        active_code = generate_ccc(15)
        c.execute(
            "INSERT INTO ChatChangeCode (user_id, code, chatID) VALUES (?, ?, ?)",
            (user_id, active_code, str(chat.id))
        )
        conn.commit()
    conn.close()

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–¥ –≤ –ª–∏—á–∫—É
    try:
        keyboard = InlineKeyboardMarkup([
            [InlineKeyboardButton("üåê –ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ —Å–∞–π—Ç", url="https://chat-setting.vercel.app")]
        ])
        await context.bot.send_message(
            chat_id=user_id,
            text=(f"üîë –í–∞—à –∫–æ–¥ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:\n<code>{active_code}</code>\n\n"
                  f"–≠—Ç–æ—Ç –∫–æ–¥ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω <b>{CODE_TTL_MINUTES} –º–∏–Ω—É—Ç</b>."),
            parse_mode="HTML",
            reply_markup=keyboard
        )
        await query.edit_message_text("‚úÖ –ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤–∞–º –≤ –ª–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è!")

    except Forbidden:
        await query.edit_message_text(
            "‚ùó –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥ –≤ –ª–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è.\n"
            "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞—á–Ω–∏—Ç–µ —á–∞—Ç —Å –±–æ—Ç–æ–º (–Ω–∞–∂–º–∏—Ç–µ <b>Start</b> –≤ –ª–∏—á–∫–µ) –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.",
            parse_mode="HTML"
        )
    except Exception:
        await query.edit_message_text("‚ùó –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∫–æ–¥–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.", parse_mode="HTML")


JSON_CHATSET_PATH = "ChatMassageEdit.json"


def parse_command(command_text):
    """–†–∞–∑–±–∏—Ä–∞–µ–º –∫–æ–º–∞–Ω–¥—É –≤–∏–¥–∞ token:...;hitext:...;goodbyetext:...;mailing:..."""
    parts = command_text.split(";")
    data = {}
    for part in parts:
        if ":" in part:
            key, value = part.split(":", 1)
            data[key.strip().lower()] = value.strip()
    return data


def get_chat_by_token(token):
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç chat_id –ø–æ —Ç–æ–∫–µ–Ω—É, –ø—Ä–æ–≤–µ—Ä—è–µ—Ç TTL.
    –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –∏—Å—Ç–µ–∫ –∏–ª–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç None.
    """
    token = token.strip()
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("""
        SELECT chatID, code, created_at 
        FROM ChatChangeCode 
        WHERE TRIM(code) = ? COLLATE NOCASE
    """, (token,))
    result = cursor.fetchone()
    conn.close()

    if not result:
        print(f"‚ùå –¢–æ–∫–µ–Ω '{token}' –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ!")
        return None

    chat_id, found_token, created_at_str = result

    if chat_id is None:
        print(f"‚ö†Ô∏è –¢–æ–∫–µ–Ω '{found_token}' –Ω–∞–π–¥–µ–Ω, –Ω–æ ChatID –Ω–µ —É–∫–∞–∑–∞–Ω –≤ –±–∞–∑–µ!")
        return "NULL_CHATID"

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º TTL
    created_at = datetime.strptime(created_at_str, "%Y-%m-%d %H:%M:%S")
    elapsed = datetime.utcnow() - created_at
    if elapsed > timedelta(minutes=CODE_TTL_MINUTES):
        print(f"‚åõ –¢–æ–∫–µ–Ω '{found_token}' –∏—Å—Ç–µ–∫! (—Å–æ–∑–¥–∞–Ω {created_at_str}, –ø—Ä–æ—à–ª–æ {elapsed})")
        return None

    print(f"‚úÖ –¢–æ–∫–µ–Ω '{found_token}' –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω ‚Üí ChatID: {chat_id} (—Å–æ–∑–¥–∞–Ω {created_at_str})")
    return chat_id


def update_json(chat_id, hi_text, goodbye_text, mailing):
    try:
        with open(JSON_CHATSET_PATH, "r", encoding="utf-8") as f:
            data = json.load(f)
    except FileNotFoundError:
        data = {}

    chat_data = data.get(chat_id, {})

    # –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
    if hi_text in ["-", "DelateParameter"]:
        chat_data["HiText"] = "–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ"
    else:
        chat_data["HiText"] = hi_text

    # –ü—Ä–æ—â–∞–Ω–∏–µ
    if goodbye_text in ["-", "DelateParameter"]:
        chat_data["GoodByeText"] = "–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –ø—Ä–æ—â–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ"
    else:
        chat_data["GoodByeText"] = goodbye_text

    # –†–∞—Å—Å—ã–ª–∫–∞ –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –ø—Ä–∏—à–ª–æ
    chat_data["Mailing"] = mailing

    data[chat_id] = chat_data

    with open(JSON_CHATSET_PATH, "w", encoding="utf-8") as f:
        json.dump(data, f, indent=4, ensure_ascii=False)


# ------------------- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–∞—Å—Å—ã–ª–∫–∏ -------------------
def update_mailing(chat_id, mailing):
    """
    mailing: —Å—Ç—Ä–æ–∫–∞ 'yes' –∏–ª–∏ 'no'
    """
    mailing = mailing.lower().strip()
    if mailing not in ["yes", "no"]:
        return  # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –ª—é–±—ã–µ –¥—Ä—É–≥–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è

    broadcast_enabled = 1 if mailing == "yes" else 0

    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("""
        INSERT INTO chat_settings (chat_id, broadcast_enabled)
        VALUES (?, ?)
        ON CONFLICT(chat_id) DO UPDATE SET broadcast_enabled = excluded.broadcast_enabled
    """, (chat_id, broadcast_enabled))
    conn.commit()
    conn.close()


async def make_admin(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = str(update.effective_user.id)
    if user_id not in DEV_IDS:
        await update.message.reply_text("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã!")
        return

    if not update.message.reply_to_message:
        await update.message.reply_text("‚ùå –û—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è!")
        return

    try:
        chat_id = update.effective_chat.id
        target_user = update.message.reply_to_message.from_user
        bot = context.bot

        await bot.promote_chat_member(
            chat_id=chat_id,
            user_id=target_user.id,
            can_change_info=True,
            can_delete_messages=True,
            can_invite_users=True,
            can_restrict_members=True,
            can_pin_messages=True,
            can_manage_video_chats=True,
            can_manage_chat=True,
            can_promote_members=False,
            is_anonymous=False
        )

        await bot.set_chat_administrator_custom_title(
            chat_id=chat_id,
            user_id=target_user.id,
            custom_title="–ê–¥–º–∏–Ω"
        )

        await update.message.reply_text(f"‚úÖ {target_user.first_name} —Ç–µ–ø–µ—Ä—å –ê–¥–º–∏–Ω!")

    except Exception as e:
        await update.message.reply_text(f"‚ùå –û—à–∏–±–∫–∞: {e}")


async def change_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–æ–º–∞–Ω–¥—É /change –≤–∏–¥–∞:
    /change;token:<–∫–æ–¥>;hitext:<—Ç–µ–∫—Å—Ç>;goodbyetext:<—Ç–µ–∫—Å—Ç>;mailing:{yes/no}
    """
    command_text = update.message.text[len("/change"):].strip()
    data = parse_command(command_text)

    token = data.get("token")
    hi_text = data.get("hitext", "-").strip()
    goodbye_text = data.get("goodbyetext", "-").strip()
    mailing = data.get("mailing", "").strip().lower()

    # –£–±–∏—Ä–∞–µ–º —Ñ–∏–≥—É—Ä–Ω—ã–µ —Å–∫–æ–±–∫–∏, –µ—Å–ª–∏ –µ—Å—Ç—å
    mailing = mailing.replace("{", "").replace("}", "")

    if not token:
        await update.message.reply_text("‚ùå –û—à–∏–±–∫–∞: —Ç–æ–∫–µ–Ω –Ω–µ —É–∫–∞–∑–∞–Ω.")
        return

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–∫–µ–Ω –∏ TTL
    chat_id = get_chat_by_token(token)

    if chat_id is None:
        await update.message.reply_text("‚åõ –û—à–∏–±–∫–∞: —Ç–æ–∫–µ–Ω –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏–ª–∏ —É–∂–µ –∏—Å—Ç–µ–∫.")
        return
    elif chat_id == "NULL_CHATID":
        await update.message.reply_text(
            f"‚ö†Ô∏è –¢–æ–∫–µ–Ω: {token}\n–û—à–∏–±–∫–∞: ChatID –Ω–µ —É–∫–∞–∑–∞–Ω –≤ –±–∞–∑–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω."
        )
        return

    # –û–±–Ω–æ–≤–ª—è–µ–º JSON
    update_json(chat_id, hi_text, goodbye_text, mailing)

    # –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞—Å—Å—ã–ª–∫—É —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ yes/no
    if mailing in ["yes", "no"]:
        update_mailing(chat_id, mailing)

    # –£–¥–∞–ª—è–µ–º —Ç–æ–∫–µ–Ω –ø–æ—Å–ª–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("DELETE FROM ChatChangeCode WHERE TRIM(code) = ? COLLATE NOCASE", (token,))
    conn.commit()
    conn.close()

    # –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É —Å—Ç–∞—Ç—É—Å–∞ —Ä–∞—Å—Å—ã–ª–∫–∏
    mailing_status = (
        "‚úÖ –í–∫–ª—é—á–µ–Ω–∞" if mailing == "yes" else
        "‚ùå –í—ã–∫–ª—é—á–µ–Ω–∞" if mailing == "no" else
        "-"
    )

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫—Ä–∞—Å–∏–≤—ã–π –æ—Ç–≤–µ—Ç
    response_text = (
        f"‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —á–∞—Ç–∞ <b>{chat_id}</b> —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã!\n\n"
        f"üì¨ –†–∞—Å—Å—ã–ª–∫–∞: {mailing_status}\n"
        f"üëã –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: {hi_text if hi_text != '-' else '–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ'}\n"
        f"üëã –ü—Ä–æ—â–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: {goodbye_text if goodbye_text != '-' else '–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ'}"
    )

    await update.message.reply_text(response_text, parse_mode="HTML")


# –ì–æ—Ä–æ–¥–∞ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º UTC-—Å–º–µ—â–µ–Ω–∏–µ–º
TIMEZONES = {
    "–ú–æ—Å–∫–≤–∞ üá∑üá∫": 3,
    "–ë–∏—à–∫–µ–∫ üá∞üá¨": 6,
    "–ö–∏—Ä–µ–Ω—Å–∫ üèîÔ∏è": 8,
    "–í–ª–∞–¥–∏–≤–æ—Å—Ç–æ–∫ üåä": 10
}


async def time_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    display_name = get_display_name_html_new(user)

    # –ü–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    message = await update.message.reply_text(
        f"{display_name} –ø–æ—Å–º–æ—Ç—Ä–µ–ª(-–∞) –Ω–∞ –≤—Ä–µ–º—è ‚è∞",
        parse_mode=ParseMode.HTML
    )

    # –ñ–¥—ë–º 0.5 —Å–µ–∫—É–Ω–¥—ã
    await asyncio.sleep(0.5)

    now_utc = datetime.utcnow().replace(tzinfo=timezone.utc)
    date_text = f"üìÖ <b>–î–∞—Ç–∞:</b> {now_utc.astimezone(timezone(timedelta(hours=3))).strftime('%Y-%m-%d')}\n\n"

    times_text = []
    for city, offset in TIMEZONES.items():
        tz = timezone(timedelta(hours=offset))
        local_time = now_utc.astimezone(tz)
        times_text.append(f"üïí {city}: <b>{local_time.strftime('%H:%M:%S')}</b>")

    final_text = "‚è∞ <b>–ê–∫—Ç—É–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è:</b>\n\n" + date_text + "\n".join(times_text)

    # –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
    await message.edit_text(final_text, parse_mode=ParseMode.HTML)


# ==================== –û–ë–ù–û–í–õ–ï–ù–ò–ï –ë–ê–ó–´ –î–ê–ù–ù–´–• ====================

def update_database():
    """–î–æ–±–∞–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—ã –∏–≤–µ–Ω—Ç–∞ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö"""
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    # –¢–∞–±–ª–∏—Ü–∞ –µ–∂–µ–¥–Ω–µ–≤–Ω—ã—Ö –±–æ–Ω—É—Å–æ–≤
    cursor.execute("""
        CREATE TABLE IF NOT EXISTS event_daily_bonus (
            user_id TEXT PRIMARY KEY,
            last_bonus_time INTEGER DEFAULT 0,
            bonus_streak INTEGER DEFAULT 0,
            FOREIGN KEY(user_id) REFERENCES users(user_id)
        )
    """)

    # –¢–∞–±–ª–∏—Ü–∞ –±–æ—Å—Å–∞
    cursor.execute("""
        CREATE TABLE IF NOT EXISTS boss_santa (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id TEXT NOT NULL,
            username TEXT NOT NULL,
            damage_dealt INTEGER DEFAULT 0,
            battle_timestamp DATETIME DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY(user_id) REFERENCES users(user_id)
        )
    """)

    # –¢–∞–±–ª–∏—Ü–∞ —Å—Ç–∞—Ç—É—Å–∞ –±–æ—Å—Å–∞
    cursor.execute("""
        CREATE TABLE IF NOT EXISTS boss_status (
            boss_id INTEGER PRIMARY KEY CHECK (boss_id = 1),
            current_hp INTEGER DEFAULT 1000000,
            max_hp INTEGER DEFAULT 1000000,
            total_players INTEGER DEFAULT 0,
            is_defeated INTEGER DEFAULT 0,
            rewards_given INTEGER DEFAULT 0,
            last_update DATETIME DEFAULT CURRENT_TIMESTAMP
        )
    """)

    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –±–æ—Å—Å–∞ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    cursor.execute("SELECT 1 FROM boss_status WHERE boss_id = 1")
    if not cursor.fetchone():
        cursor.execute("""
            INSERT INTO boss_status (boss_id, current_hp, max_hp, total_players, is_defeated, rewards_given) 
            VALUES (1, 1000000, 1000000, 0, 0, 0)
        """)

    conn.commit()
    conn.close()

    print("‚úÖ –¢–∞–±–ª–∏—Ü—ã –∏–≤–µ–Ω—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω—ã!")


# ==================== –ï–ñ–ï–î–ù–ï–í–ù–´–ô –ë–û–ù–£–° ====================

async def get_daily_bonus(user):
    user_id = str(user.id)
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∫–æ–≥–¥–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑ –ø–æ–ª—É—á–∞–ª –±–æ–Ω—É—Å
    cursor.execute("SELECT last_bonus_time, bonus_streak FROM event_daily_bonus WHERE user_id = ?", (user_id,))
    result = cursor.fetchone()

    current_time = int(time.time())

    if result:
        last_bonus, streak = result
        time_diff = current_time - last_bonus

        if time_diff < 86400:  # 24 —á–∞—Å–∞
            hours_left = (86400 - time_diff) // 3600
            minutes_left = ((86400 - time_diff) % 3600) // 60
            conn.close()
            return False, f"‚ùå –í—ã —É–∂–µ –ø–æ–ª—É—á–∞–ª–∏ –±–æ–Ω—É—Å —Å–µ–≥–æ–¥–Ω—è!\n–°–ª–µ–¥—É—é—â–∏–π –±–æ–Ω—É—Å —á–µ—Ä–µ–∑: {hours_left}—á {minutes_left}–º"

        # –û–±–Ω–æ–≤–ª—è–µ–º —Å–µ—Ä–∏—é
        new_streak = streak + 1 if time_diff < 172800 else 1
        cursor.execute("""
            UPDATE event_daily_bonus 
            SET last_bonus_time = ?, bonus_streak = ?
            WHERE user_id = ?
        """, (current_time, new_streak, user_id))
    else:
        # –ü–µ—Ä–≤—ã–π –±–æ–Ω—É—Å
        new_streak = 1
        cursor.execute("""
            INSERT INTO event_daily_bonus (user_id, last_bonus_time, bonus_streak)
            VALUES (?, ?, ?)
        """, (user_id, current_time, new_streak))

    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–∞–≥—Ä–∞–¥—ã
    money = random.randint(1000, 50000)
    exp = random.randint(1, 50)
    dc = random.randint(3, 50)

    # –î–æ–±–∞–≤–ª—è–µ–º –±–æ–Ω—É—Å –∑–∞ —Å–µ—Ä–∏—é
    if new_streak >= 7:
        money = int(money * 1.5)
        exp = int(exp * 1.5)
        dc = int(dc * 1.5)
        streak_bonus = "üéâ –ë–æ–Ω—É—Å –∑–∞ 7-–¥–Ω–µ–≤–Ω—É—é —Å–µ—Ä–∏—é! +50% –∫ –Ω–∞–≥—Ä–∞–¥–∞–º"
    else:
        streak_bonus = f"üìÖ –°–µ—Ä–∏—è: {new_streak}/7 –¥–Ω–µ–π"

    # –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    cursor.execute("""
        UPDATE users 
        SET balance = balance + ?, exp = exp + ?, dc_balance = dc_balance + ?
        WHERE user_id = ?
    """, (money, exp, dc, user_id))

    conn.commit()
    conn.close()

    bonus_text = f"""
üéÅ –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –±–æ–Ω—É—Å –ø–æ–ª—É—á–µ–Ω!

üíµ –î–µ–Ω—å–≥–∏: +{money:,}‚ÇΩ
‚≠ê –û–ø—ã—Ç: +{exp} exp
üé´ DC: +{dc} dc

{streak_bonus}
"""
    return True, bonus_text


# ==================== –°–ò–°–¢–ï–ú–ê –ù–ê–ì–†–ê–î –ó–ê –ü–û–ë–ï–î–£ ====================

def give_boss_rewards():
    """–í—ã–¥–∞–µ—Ç –Ω–∞–≥—Ä–∞–¥—ã –≤—Å–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–∞–º –ø–æ—Å–ª–µ –ø–æ–±–µ–¥—ã –Ω–∞–¥ –±–æ—Å—Å–æ–º"""
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –≤—ã–¥–∞–≤–∞–ª–∏—Å—å –ª–∏ —É–∂–µ –Ω–∞–≥—Ä–∞–¥—ã
    cursor.execute("SELECT rewards_given FROM boss_status WHERE boss_id = 1")
    rewards_given = cursor.fetchone()[0]

    if rewards_given:
        conn.close()
        return "üéâ –ù–∞–≥—Ä–∞–¥—ã —É–∂–µ –±—ã–ª–∏ –≤—ã–¥–∞–Ω—ã —Ä–∞–Ω–µ–µ!"

    # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ—Ö —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –±–æ—è
    cursor.execute("SELECT DISTINCT user_id FROM boss_santa")
    participants = cursor.fetchall()

    if not participants:
        conn.close()
        return "‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –¥–ª—è –≤—ã–¥–∞—á–∏ –Ω–∞–≥—Ä–∞–¥"

    reward_money = 70_000_000
    reward_dc = 7000
    reward_exp = 7000

    rewarded_count = 0
    failed_count = 0

    for (user_id,) in participants:
        try:
            # –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            cursor.execute("""
                UPDATE users 
                SET balance = balance + ?, 
                    dc_balance = dc_balance + ?, 
                    exp = exp + ?
                WHERE user_id = ?
            """, (reward_money, reward_dc, reward_exp, user_id))

            rewarded_count += 1

        except Exception as e:
            failed_count += 1
            print(f"–û—à–∏–±–∫–∞ –≤—ã–¥–∞—á–∏ –Ω–∞–≥—Ä–∞–¥—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}: {e}")

    # –ü–æ–º–µ—á–∞–µ–º, —á—Ç–æ –Ω–∞–≥—Ä–∞–¥—ã –≤—ã–¥–∞–Ω—ã
    cursor.execute("UPDATE boss_status SET rewards_given = 1 WHERE boss_id = 1")

    conn.commit()
    conn.close()

    # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–∞–≥—Ä–∞–¥–∞—Ö
    reward_message = f"""
üéâ <b>–ë–û–°–° –ü–û–ë–ï–ñ–î–ï–ù!</b>

üèÜ –í—Å–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏ –±–∏—Ç–≤—ã –ø–æ–ª—É—á–∞—é—Ç –Ω–∞–≥—Ä–∞–¥—ã:

üíµ –î–µ–Ω—å–≥–∏: +{reward_money:,}‚ÇΩ
üé´ DC: +{reward_dc:,} dc
‚≠ê –û–ø—ã—Ç: +{reward_exp:,} exp

üë• –ù–∞–≥—Ä–∞–∂–¥–µ–Ω–æ –∏–≥—Ä–æ–∫–æ–≤: {rewarded_count}
"""

    if failed_count > 0:
        reward_message += f"\n‚ùå –û—à–∏–±–∫–∏ –≤—ã–¥–∞—á–∏: {failed_count} –∏–≥—Ä–æ–∫–æ–≤"

    return reward_message


# ==================== –§–£–ù–ö–¶–ò–ò –ë–û–°–°–ê ====================

def get_boss_status():
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    cursor.execute(
        "SELECT current_hp, max_hp, total_players, is_defeated, rewards_given FROM boss_status WHERE boss_id = 1")
    boss_data = cursor.fetchone()

    if not boss_data:
        conn.close()
        return None

    boss_hp, max_hp, total_players, is_defeated, rewards_given = boss_data

    cursor.execute("""
        SELECT user_id, username, damage_dealt, battle_timestamp
        FROM boss_santa 
        ORDER BY battle_timestamp DESC 
        LIMIT 3
    """)
    recent_attacks = cursor.fetchall()

    conn.close()

    return boss_hp, max_hp, total_players, is_defeated, rewards_given, recent_attacks


def can_attack_boss(user_id):
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –º–æ–∂–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞—Ç–∞–∫–æ–≤–∞—Ç—å –±–æ—Å—Å–∞ (1 —Ä–∞–∑ –≤ 10 —á–∞—Å–æ–≤)"""
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    # –ü–æ–ª—É—á–∞–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –∞—Ç–∞–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    cursor.execute("""
        SELECT battle_timestamp FROM boss_santa 
        WHERE user_id = ? 
        ORDER BY battle_timestamp DESC 
        LIMIT 1
    """, (user_id,))

    result = cursor.fetchone()
    conn.close()

    if not result:
        return True, None  # –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –∞—Ç–∞–∫–æ–≤–∞–ª

    last_attack_time = result[0]

    # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Å—Ç—Ä–æ–∫—É –≤—Ä–µ–º–µ–Ω–∏ –≤ timestamp
    if isinstance(last_attack_time, str):
        last_attack_timestamp = int(datetime.fromisoformat(last_attack_time).timestamp())
    else:
        last_attack_timestamp = last_attack_time

    current_time = int(time.time())
    time_diff = current_time - last_attack_timestamp

    # 10 —á–∞—Å–æ–≤ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
    cooldown_seconds = 4 * 60 * 60  # 10 —á–∞—Å–æ–≤

    if time_diff < cooldown_seconds:
        time_left = cooldown_seconds - time_diff
        hours_left = time_left // 3600
        minutes_left = (time_left % 3600) // 60
        return False, f"{hours_left}—á {minutes_left}–º"

    return True, None


def format_boss_message():
    boss_data = get_boss_status()
    if not boss_data:
        return "‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –±–æ—Å—Å–∞"

    boss_hp, max_hp, total_players, is_defeated, rewards_given, recent_attacks = boss_data

    if is_defeated:
        return "üéÖ <b>–ë–û–°–° ¬´–ó–ª–æ–π –°–∞–Ω—Ç–∞¬ª</b>\n\n‚ùå –ë–æ—Å—Å —É–∂–µ –ø–æ–±–µ–∂–¥–µ–Ω, –Ω–∞–≥—Ä–∞–¥—ã –∑–∞—á–∏—Å–ª–µ–Ω—ã!\nüéÑ –ò–≤–µ–Ω—Ç –æ–∫–æ–Ω—á–µ–Ω."

    message = "üéÖ <b>–ë–û–°–° ¬´–ó–ª–æ–π –°–∞–Ω—Ç–∞¬ª</b>\n\n"
    message += f"‚ù§Ô∏è –ó–¥–æ—Ä–æ–≤—å–µ: <b>{boss_hp:,}/{max_hp:,}</b>\n"
    message += f"üë• –ò–≥—Ä–æ–∫–æ–≤ —É—á–∞—Å—Ç–≤—É–µ—Ç: <b>{total_players}</b>\n"
    message += f"‚è∞ –ú–æ–∂–Ω–æ –∞—Ç–∞–∫–æ–≤–∞—Ç—å: 1 —Ä–∞–∑ –≤ 4 —á–∞—Å–∞\n"
    message += f"‚öîÔ∏è –£—Ä–æ–Ω –∑–∞ –∞—Ç–∞–∫—É: 10-300\n\n"

    message += "<b>–ü–æ—Å–ª–µ–¥–Ω–∏–µ 3 –∏–≥—Ä–æ–∫–∞, –Ω–∞–Ω–æ—Å–∏–≤—à–∏–µ —É—Ä–æ–Ω:</b>\n"

    if not recent_attacks:
        message += "‚Ä¢ –ü–æ–∫–∞ –Ω–∏–∫—Ç–æ –Ω–µ –∞—Ç–∞–∫–æ–≤–∞–ª –±–æ—Å—Å–∞\n"
    else:
        for i, (user_id, username, damage, timestamp) in enumerate(recent_attacks):
            # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π user –æ–±—ä–µ–∫—Ç –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
            from telegram import User
            temp_user = User(id=int(user_id), is_bot=False, first_name=username)
            display_name_html = get_display_name_html_new(temp_user)

            message += f"‚Ä¢ {display_name_html}\n"
            message += f"  üë§ TelegramID: {user_id}\n"
            message += f"  ‚öîÔ∏è –ù–∞–Ω–µ—Å–µ–Ω–Ω—ã–π —É—Ä–æ–Ω: {damage}\n\n"

    return message


async def attack_boss(user):
    user_id = str(user.id)
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—É–ª–¥–∞—É–Ω
    can_attack, time_left = can_attack_boss(user_id)
    if not can_attack:
        conn.close()
        return False, f"‚è∞ –í—ã —É–∂–µ –∞—Ç–∞–∫–æ–≤–∞–ª–∏ –±–æ—Å—Å–∞ —Å–µ–≥–æ–¥–Ω—è!\n–°–ª–µ–¥—É—é—â–∞—è –∞—Ç–∞–∫–∞ —á–µ—Ä–µ–∑: {time_left}"

    cursor.execute("SELECT current_hp, total_players, is_defeated FROM boss_status WHERE boss_id = 1")
    result = cursor.fetchone()

    if not result:
        conn.close()
        return False, "‚ùå –ë–æ—Å—Å –Ω–µ –Ω–∞–π–¥–µ–Ω!"

    current_hp, total_players, is_defeated = result

    if is_defeated:
        conn.close()
        return False, "‚ùå –ë–æ—Å—Å —É–∂–µ –ø–æ–±–µ–∂–¥–µ–Ω, –Ω–∞–≥—Ä–∞–¥—ã –∑–∞—á–∏—Å–ª–µ–Ω—ã!\nüéÑ –ò–≤–µ–Ω—Ç –æ–∫–æ–Ω—á–µ–Ω."

    if current_hp <= 0:
        cursor.execute("UPDATE boss_status SET is_defeated = 1 WHERE boss_id = 1")
        conn.commit()
        conn.close()

        reward_message = give_boss_rewards()
        return False, f"\n{reward_message}\n\nüéÑ –ò–≤–µ–Ω—Ç –æ–∫–æ–Ω—á–µ–Ω."

    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É—Ä–æ–Ω –æ—Ç 500 –¥–æ 7–∫
    damage = random.randint(500, 7000)

    # –û–±–Ω–æ–≤–ª—è–µ–º HP –±–æ—Å—Å–∞
    new_hp = max(0, current_hp - damage)
    cursor.execute("UPDATE boss_status SET current_hp = ? WHERE boss_id = 1", (new_hp,))

    # –ü–æ–ª—É—á–∞–µ–º username –¥–ª—è –∑–∞–ø–∏—Å–∏ –≤ –±–∞–∑—É
    cursor.execute("SELECT nickname, first_name FROM users WHERE user_id = ?", (user_id,))
    user_data = cursor.fetchone()

    if user_data:
        nickname, first_name = user_data
        display_name = nickname or first_name or "–ò–≥—Ä–æ–∫"
    else:
        display_name = user.first_name or "–ò–≥—Ä–æ–∫"

    # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –∞—Ç–∞–∫—É
    cursor.execute("""
        INSERT INTO boss_santa (user_id, username, damage_dealt)
        VALUES (?, ?, ?)
    """, (user_id, display_name, damage))

    # –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤
    cursor.execute("SELECT COUNT(DISTINCT user_id) FROM boss_santa")
    new_total_players = cursor.fetchone()[0]
    cursor.execute("UPDATE boss_status SET total_players = ? WHERE boss_id = 1", (new_total_players,))

    conn.commit()
    conn.close()

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–±–µ–¥—É
    if new_hp <= 0:
        conn = sqlite3.connect(DB_PATH)
        cursor = conn.cursor()
        cursor.execute("UPDATE boss_status SET is_defeated = 1 WHERE boss_id = 1")
        conn.commit()
        conn.close()

        reward_message = give_boss_rewards()
        return True, f"""
üéÖ –í—ã –Ω–∞–Ω–µ—Å–ª–∏ {damage} —É—Ä–æ–Ω–∞ –ó–ª–æ–º—É –°–∞–Ω—Ç–µ!
üí• –ë–û–°–° –ü–û–ë–ï–ñ–î–ï–ù!

{reward_message}

üéÑ –ò–≤–µ–Ω—Ç –æ–∫–æ–Ω—á–µ–Ω.
"""

    return True, f"üéÖ –í—ã –Ω–∞–Ω–µ—Å–ª–∏ {damage} —É—Ä–æ–Ω–∞ –ó–ª–æ–º—É –°–∞–Ω—Ç–µ!"


# ==================== –ê–î–ú–ò–ù –ö–û–ú–ê–ù–î–´ ====================

def admin_reset_boss():
    """–ü–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å –∏–≤–µ–Ω—Ç–∞"""
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    cursor.execute("""
        UPDATE boss_status 
        SET current_hp = 1000000, 
            total_players = 0, 
            is_defeated = 0,
            rewards_given = 0
        WHERE boss_id = 1
    """)
    cursor.execute("DELETE FROM boss_santa")

    conn.commit()
    conn.close()

    return "üéÖ –ò–≤–µ–Ω—Ç —Å–±—Ä–æ—à–µ–Ω! –ë–æ—Å—Å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —Å 1.000.000 HP. –ù–∞—á–∏–Ω–∞–µ–º –Ω–æ–≤—ã–π —Ä–∞—É–Ω–¥!"


def get_event_stats():
    """–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–≤–µ–Ω—Ç–∞"""
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    cursor.execute("SELECT current_hp, total_players, is_defeated, rewards_given FROM boss_status WHERE boss_id = 1")
    boss_data = cursor.fetchone()

    cursor.execute("SELECT COUNT(*) FROM boss_santa")
    total_attacks = cursor.fetchone()[0]

    cursor.execute("SELECT COUNT(DISTINCT user_id) FROM boss_santa")
    unique_players = cursor.fetchone()[0]

    cursor.execute("SELECT SUM(damage_dealt) FROM boss_santa")
    total_damage = cursor.fetchone()[0] or 0

    conn.close()

    if not boss_data:
        return "‚ùå –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"

    current_hp, total_players, is_defeated, rewards_given = boss_data

    stats = f"""
üìä <b>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–≤–µ–Ω—Ç–∞ ¬´–ó–ª–æ–π –°–∞–Ω—Ç–∞¬ª</b>

‚ù§Ô∏è HP –±–æ—Å—Å–∞: {current_hp:,}/1,000,000
üë• –£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤: {unique_players}
‚öîÔ∏è –í—Å–µ–≥–æ –∞—Ç–∞–∫: {total_attacks}
üí• –û–±—â–∏–π —É—Ä–æ–Ω: {total_damage:,}

üèÜ –°—Ç–∞—Ç—É—Å: {"–ü–û–ë–ï–ñ–î–ï–ù" if is_defeated else "–ê–ö–¢–ò–í–ï–ù"}
üéÅ –ù–∞–≥—Ä–∞–¥—ã –≤—ã–¥–∞–Ω—ã: {"–î–ê" if rewards_given else "–ù–ï–¢"}
"""
    return stats


# ==================== –û–°–ù–û–í–ù–û–ï –ú–ï–ù–Æ –ò–í–ï–ù–¢–ê ====================

def event_menu():
    return """
üéÑ <b>–ù–æ–≤–æ–≥–æ–¥–Ω–∏–π –ò–≤–µ–Ω—Ç</b>
¬´–ó–ª–æ–π –°–∞–Ω—Ç–∞¬ª

<pre>–í—ã–±–µ—Ä–µ—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:</pre>
"""


# ==================== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ö–û–ú–ê–ù–î ====================

async def event_error_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    user_mention_html = get_display_name_html_new(user)

    text = (
        f"üì¶ <b>–ò–≤–µ–Ω—Ç</b> | {user_mention_html}\n\n"
        "‚ö†Ô∏è <i>–ò–≤–µ–Ω—Ç –Ω–µ –∑–∞–ø—É—â–µ–Ω.</i>\n\n"
        "üôè –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ –æ–∂–∏–¥–∞–π—Ç–µ –Ω–∞—á–∞–ª–∞ –∏–≤–µ–Ω—Ç–∞ –≤ Telegram –∫–∞–Ω–∞–ª–µ –±–æ—Ç–∞."
    )

    await update.message.reply_text(
        text,
        parse_mode=ParseMode.HTML,
        disable_web_page_preview=True
    )

async def event_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /–∏–≤–µ–Ω—Ç –∏ —Ç–µ–∫—Å—Ç–∞ '–∏–≤–µ–Ω—Ç'"""
    keyboard = [
        [InlineKeyboardButton("üéÖ –ë–û–°–° –°–∞–Ω—Ç–∞", callback_data="boss_santa")],
        [InlineKeyboardButton("üéÅ –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –±–æ–Ω—É—Å", callback_data="daily_bonus")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)

    await update.message.reply_text(event_menu(), reply_markup=reply_markup, parse_mode='HTML')


async def event_snow_handle_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ callback –∫–Ω–æ–ø–æ–∫"""
    query = update.callback_query
    await query.answer()

    if query.data == "boss_santa":
        boss_message = format_boss_message()
        keyboard = []

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –º–æ–∂–Ω–æ –ª–∏ –∞—Ç–∞–∫–æ–≤–∞—Ç—å
        boss_data = get_boss_status()
        if boss_data and not boss_data[3]:  # is_defeated
            keyboard.append([InlineKeyboardButton("‚öîÔ∏è –ê—Ç–∞–∫–æ–≤–∞—Ç—å", callback_data="attack_boss")])

        keyboard.append([InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="event_back")])
        reply_markup = InlineKeyboardMarkup(keyboard)

        await query.edit_message_text(boss_message, reply_markup=reply_markup, parse_mode='HTML')

    elif query.data == "attack_boss":
        user = query.from_user
        success, result_message = await attack_boss(user)

        keyboard = []

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –º–æ–∂–Ω–æ –ª–∏ –µ—â–µ –∞—Ç–∞–∫–æ–≤–∞—Ç—å
        boss_data = get_boss_status()
        if boss_data and not boss_data[3]:  # is_defeated
            keyboard.append([InlineKeyboardButton("‚öîÔ∏è –ê—Ç–∞–∫–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞", callback_data="attack_boss")])

        keyboard.append([InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="event_back")])
        reply_markup = InlineKeyboardMarkup(keyboard)

        await query.edit_message_text(result_message, reply_markup=reply_markup, parse_mode='HTML')

    elif query.data == "daily_bonus":
        user = query.from_user
        success, bonus_message = await get_daily_bonus(user)

        keyboard = [[InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="event_back")]]
        reply_markup = InlineKeyboardMarkup(keyboard)

        await query.edit_message_text(bonus_message, reply_markup=reply_markup, parse_mode='HTML')

    elif query.data == "event_back":
        keyboard = [
            [InlineKeyboardButton("üéÖ –ë–û–°–° –°–∞–Ω—Ç–∞", callback_data="boss_santa")],
            [InlineKeyboardButton("üéÅ –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –±–æ–Ω—É—Å", callback_data="daily_bonus")]
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)

        await query.edit_message_text(event_menu(), reply_markup=reply_markup, parse_mode='HTML')


# –ê–¥–º–∏–Ω –∫–æ–º–∞–Ω–¥—ã
async def admin_reset_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ê–¥–º–∏–Ω—Å–∫–∞—è –∫–æ–º–∞–Ω–¥–∞ —Å–±—Ä–æ—Å–∞ –±–æ—Å—Å–∞"""
    user_id = str(update.effective_user.id)

    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT 1 FROM admins WHERE user_id = ?", (user_id,))
    is_admin = cursor.fetchone() is not None
    conn.close()

    if is_admin:
        result = admin_reset_boss()
        await update.message.reply_text(result)
    else:
        await update.message.reply_text("‚ùå –≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤!")


async def event_stats_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ê–¥–º–∏–Ω—Å–∫–∞—è –∫–æ–º–∞–Ω–¥–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏"""
    user_id = str(update.effective_user.id)

    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT 1 FROM admins WHERE user_id = ?", (user_id,))
    is_admin = cursor.fetchone() is not None
    conn.close()

    if is_admin:
        stats = get_event_stats()
        await update.message.reply_text(stats, parse_mode='HTML')
    else:
        await update.message.reply_text("‚ùå –≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤!")


async def event_hp_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–£—Å—Ç–∞–Ω–æ–≤–∫–∞ HP –±–æ—Å—Å–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è –≤–ª–∞–¥–µ–ª—å—Ü–∞)"""
    user_id = str(update.effective_user.id)

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    if user_id != "7406372338":
        await update.message.reply_text("‚ùå –≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –≤–ª–∞–¥–µ–ª—å—Ü–∞ –±–æ—Ç–∞!")
        return

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞—Ä–≥—É–º–µ–Ω—Ç—ã
    if not context.args:
        await update.message.reply_text("‚ùå –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /event_hp <—á–∏—Å–ª–æ>")
        return

    try:
        new_hp = int(context.args[0])
        if new_hp < 0:
            await update.message.reply_text("‚ùå HP –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º!")
            return
    except ValueError:
        await update.message.reply_text("‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —á–∏—Å–ª–æ!")
        return

    # –û–±–Ω–æ–≤–ª—è–µ–º HP –±–æ—Å—Å–∞
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    cursor.execute("UPDATE boss_status SET current_hp = ? WHERE boss_id = 1", (new_hp,))

    conn.commit()
    conn.close()

    await update.message.reply_text(f"‚úÖ HP –±–æ—Å—Å–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ: {new_hp:,}")

    # –§–∞–π–ª –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫


SETTINGS_FILE = 'trigger_settings.json'


# –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏–∑ JSON
def load_settings():
    if os.path.exists(SETTINGS_FILE):
        with open(SETTINGS_FILE, 'r', encoding='utf-8') as f:
            return json.load(f)
    return {'delete_enabled': True}  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —É–¥–∞–ª–µ–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ


# –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≤ JSON
def save_settings(settings):
    with open(SETTINGS_FILE, 'w', encoding='utf-8') as f:
        json.dump(settings, f, ensure_ascii=False, indent=2)


# –ö–æ–º–∞–Ω–¥–∞ /trigger - –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å—Ç–∞—Ç—É—Å
async def trigger_status(update: Update, context: ContextTypes.DEFAULT_TYPE):
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–æ–º–∞–Ω–¥—É –≤—ã–∑–≤–∞–ª –Ω—É–∂–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    if update.effective_user.id != 7406372338:
        await update.message.reply_text("–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã.")
        return

    settings = load_settings()
    status = "‚úÖ –í–ö–õ–Æ–ß–ï–ù–û" if settings['delete_enabled'] else "‚ùå –í–´–ö–õ–Æ–ß–ï–ù–û"

    await update.message.reply_text(
        f"üõ°Ô∏è –°—Ç–∞—Ç—É—Å —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π: {status}\n"
        f"–ë–æ—Ç {'—É–¥–∞–ª—è–µ—Ç' if settings['delete_enabled'] else '–∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç'} —Å–æ–æ–±—â–µ–Ω–∏—è —Å –∑–∞–ø—Ä–µ—â–µ–Ω–Ω—ã–º–∏ —Å–ª–æ–≤–∞–º–∏"
    )


# –ö–æ–º–∞–Ω–¥–∞ /strigger - —Å–º–µ–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫—É
async def switch_trigger(update: Update, context: ContextTypes.DEFAULT_TYPE):
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–æ–º–∞–Ω–¥—É –≤—ã–∑–≤–∞–ª –Ω—É–∂–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    if update.effective_user.id != 7406372338:
        await update.message.reply_text("–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã.")
        return

    settings = load_settings()
    # –ú–µ–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫—É –Ω–∞ –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω—É—é
    settings['delete_enabled'] = not settings['delete_enabled']
    save_settings(settings)

    status = "‚úÖ –í–ö–õ–Æ–ß–ï–ù–û" if settings['delete_enabled'] else "‚ùå –í–´–ö–õ–Æ–ß–ï–ù–û"
    action = "–Ω–∞—á–∞–ª —É–¥–∞–ª—è—Ç—å" if settings['delete_enabled'] else "–ø–µ—Ä–µ—Å—Ç–∞–ª —É–¥–∞–ª—è—Ç—å"

    await update.message.reply_text(
        f"üõ°Ô∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∞!\n"
        f"–°—Ç–∞—Ç—É—Å —É–¥–∞–ª–µ–Ω–∏—è: {status}\n"
        f"–ë–æ—Ç {action} —Å–æ–æ–±—â–µ–Ω–∏—è —Å –∑–∞–ø—Ä–µ—â–µ–Ω–Ω—ã–º–∏ —Å–ª–æ–≤–∞–º–∏"
    )


# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
async def delete_offensive_messages(update: Update, context: ContextTypes.DEFAULT_TYPE):
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤–∫–ª—é—á–µ–Ω–æ –ª–∏ —É–¥–∞–ª–µ–Ω–∏–µ
    settings = load_settings()
    if not settings['delete_enabled']:
        return

    # ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã—Ö –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å
    restricted_user_ids = [8380716762]

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –æ–¥–Ω–æ–≥–æ –∏–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    if update.effective_user.id not in restricted_user_ids:
        return

    try:
        # –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ (–ª—é–±–æ–µ - —Ç–µ–∫—Å—Ç, —Ñ–æ—Ç–æ, –≤–∏–¥–µ–æ –∏ —Ç.–¥.)
        await update.effective_message.delete()
        print(f"üóëÔ∏è –£–¥–∞–ª–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {update.effective_user.id}")

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω—É –≤ –õ–°
        admin_id = 7406372338
        user = update.effective_user
        chat = update.effective_chat

        # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        notification_text = (
            f"üö® –£–¥–∞–ª–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:\n"
            f"üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {user.first_name} ({user.id})\n"
            f"üí¨ –ß–∞—Ç: {chat.title if chat.title else '–õ–°'}\n"
            f"üÜî ID —á–∞—Ç–∞: {chat.id}"
        )

        # –ï—Å–ª–∏ –µ—Å—Ç—å —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è, –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ (–æ–±—Ä–µ–∑–∞–µ–º –¥–æ 200 —Å–∏–º–≤–æ–ª–æ–≤)
        if update.effective_message.text:
            message_preview = update.effective_message.text[:200] + "..." if len(
                update.effective_message.text) > 200 else update.effective_message.text
            notification_text += f"\nüìù –¢–µ–∫—Å—Ç: {message_preview}"

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω—É
        await context.bot.send_message(
            chat_id=admin_id,
            text=notification_text
        )

    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}")
        # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å, –≤—Å–µ —Ä–∞–≤–Ω–æ —É–≤–µ–¥–æ–º–ª—è–µ–º –∞–¥–º–∏–Ω–∞
        try:
            admin_id = 7406372338
            user = update.effective_user
            chat = update.effective_chat

            await context.bot.send_message(
                chat_id=admin_id,
                text=f"‚ùå –ù–ï –£–î–ê–õ–û–°–¨ —É–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç {user.first_name} ({user.id}) –≤ —á–∞—Ç–µ {chat.title}\n–û—à–∏–±–∫–∞: {e}"
            )
        except Exception as e2:
            print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω—É: {e2}")


def create_missing_tables():
    """–°–æ–∑–¥–∞–µ—Ç —Ç–æ–ª—å–∫–æ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ —Ç–∞–±–ª–∏—Ü—ã"""
    import sqlite3
    import os

    DB_PATH = "FernieUI.db"
    print(f"üîç –ü—Ä–æ–≤–µ—Ä—è—é –ë–î: {DB_PATH}")

    if not os.path.exists(DB_PATH):
        print("‚ùå –§–∞–π–ª –ë–î –Ω–µ –Ω–∞–π–¥–µ–Ω!")
        return False

    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    # –ü–æ–ª—É—á–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–∞–±–ª–∏—Ü—ã
    cursor.execute("SELECT name FROM sqlite_master WHERE type='table'")
    existing_tables = {row[0] for row in cursor.fetchall()}

    print(f"üìä –ù–∞–π–¥–µ–Ω–æ —Ç–∞–±–ª–∏—Ü: {len(existing_tables)}")

    # –°–ø–∏—Å–æ–∫ –í–°–ï–• –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö —Ç–∞–±–ª–∏—Ü
    all_tables = {
        'users': """
            CREATE TABLE users (
                user_id TEXT PRIMARY KEY,
                username TEXT,
                first_name TEXT DEFAULT '',
                nickname TEXT DEFAULT NULL,
                status INTEGER DEFAULT 0,
                balance INTEGER DEFAULT 0,
                seeds INTEGER DEFAULT 0,
                property TEXT DEFAULT '',
                exp INTEGER DEFAULT 0,
                level INTEGER DEFAULT 1,
                bonus_given INTEGER DEFAULT 0,
                inventory_car TEXT DEFAULT NULL,
                inventory_phone TEXT DEFAULT NULL,
                inventory_yacht TEXT DEFAULT NULL,
                inventory_business TEXT DEFAULT NULL,
                inventory_home TEXT DEFAULT NULL,
                inventory_pet TEXT DEFAULT NULL,
                clicks INTEGER DEFAULT 0,
                last_farm INTEGER DEFAULT 0,
                crypto_wallet INTEGER DEFAULT 0,
                dc_balance INTEGER DEFAULT 0,
                ref_count INTEGER DEFAULT 0,
                vip_level INTEGER DEFAULT 0,
                vip_expiry TEXT DEFAULT NULL
            )
        """,

        'mutes': """
            CREATE TABLE mutes (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                muted_user_id TEXT NOT NULL,
                muted_by_user_id TEXT NOT NULL,
                reason TEXT,
                duration INTEGER NOT NULL,
                timestamp_start INTEGER NOT NULL,
                timestamp_end INTEGER NOT NULL,
                chat_id INTEGER NOT NULL DEFAULT 0
            )
        """,

        'user_promocodes': """
            CREATE TABLE user_promocodes (
                user_id TEXT,
                promo_code TEXT,
                activations INTEGER DEFAULT 0,
                PRIMARY KEY (user_id, promo_code)
            )
        """,

        'custom_promo': """
            CREATE TABLE custom_promo (
                promo_code TEXT PRIMARY KEY,
                owner_id TEXT,
                level INTEGER DEFAULT 1,
                activations INTEGER DEFAULT 0,
                rewards TEXT DEFAULT '',
                verified INTEGER DEFAULT 0
            )
        """,

        'processed_operations': """
            CREATE TABLE processed_operations (
                operation_id TEXT PRIMARY KEY
            )
        """,
        'SubFerniePlus': """
        CREATE TABLE IF NOT EXISTS SubFerniePlus (
            user_id TEXT PRIMARY KEY,
            end_time INTEGER
        )
    """,

        'fernieplus_custom': """
        CREATE TABLE IF NOT EXISTS fernieplus_custom (
            user_id TEXT PRIMARY KEY,
            media_type TEXT DEFAULT 'photo',
            media_path TEXT DEFAULT 'profile_def.png'
        )
                             """,
        'inventory': """
        CREATE TABLE IF NOT EXISTS inventory (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            owner_id TEXT NOT NULL,
            item_name TEXT NOT NULL,
            quantity INTEGER DEFAULT 1,
            FOREIGN KEY(owner_id) REFERENCES users(user_id)
        )
    """,
        'admin_treasury': """
        CREATE TABLE IF NOT EXISTS admin_treasury (
            id INTEGER PRIMARY KEY CHECK (id = 1),
            balance INTEGER DEFAULT 9999999999999,
            last_update DATE DEFAULT (DATE('now'))
        )
    """,

        'charity_balance': """
        CREATE TABLE IF NOT EXISTS charity_balance (
            id INTEGER PRIMARY KEY,
            total_balance TEXT DEFAULT '0'
        )
    """,

        'charity': """
        CREATE TABLE IF NOT EXISTS charity (
            user_id TEXT,
            username TEXT,
            donation_amount TEXT DEFAULT '0',
            donated_at TEXT DEFAULT CURRENT_TIMESTAMP
        )
    """,
        'chat_verification': """
        CREATE TABLE IF NOT EXISTS chat_verification (
            chat_id TEXT PRIMARY KEY,
            verification TEXT DEFAULT '‚ùå',
            created_at TEXT DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (chat_id) REFERENCES chats_admins(chat_id) ON DELETE CASCADE
        )
    """,

        # –î–æ–±–∞–≤—å—Ç–µ —Å—é–¥–∞ –¥—Ä—É–≥–∏–µ —Ç–∞–±–ª–∏—Ü—ã –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    }

    created_count = 0
    missing_tables = []

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ —Å–æ–∑–¥–∞–µ–º –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ
    for table_name, create_sql in all_tables.items():
        if table_name not in existing_tables:
            print(f"‚ûï –°–æ–∑–¥–∞—é —Ç–∞–±–ª–∏—Ü—É: {table_name}")
            try:
                cursor.execute(create_sql)
                created_count += 1
                missing_tables.append(table_name)
            except Exception as e:
                print(f"‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è {table_name}: {e}")
        else:
            print(f"‚úÖ –¢–∞–±–ª–∏—Ü–∞ {table_name} —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç")

    if created_count > 0:
        conn.commit()
        print(f"\n‚úÖ –°–æ–∑–¥–∞–Ω–æ {created_count} –Ω–æ–≤—ã—Ö —Ç–∞–±–ª–∏—Ü:")
        for table in missing_tables:
            print(f"   - {table}")
    else:
        print("\n‚úÖ –í—Å–µ —Ç–∞–±–ª–∏—Ü—ã —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç!")

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç–∞–±–ª–∏—Ü—ã mutes (–æ—Å–æ–±–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞)
    if 'mutes' in existing_tables:
        cursor.execute("PRAGMA table_info(mutes)")
        columns = [col[1] for col in cursor.fetchall()]
        if 'chat_id' not in columns:
            print("üîÑ –û–±–Ω–æ–≤–ª—è—é —Ç–∞–±–ª–∏—Ü—É mutes...")
            try:
                # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é —Ç–∞–±–ª–∏—Ü—É —Å chat_id
                cursor.execute("""
                    CREATE TABLE mutes_new (
                        id INTEGER PRIMARY KEY AUTOINCREMENT,
                        muted_user_id TEXT NOT NULL,
                        muted_by_user_id TEXT NOT NULL,
                        reason TEXT,
                        duration INTEGER NOT NULL,
                        timestamp_start INTEGER NOT NULL,
                        timestamp_end INTEGER NOT NULL,
                        chat_id INTEGER NOT NULL DEFAULT 0
                    )
                """)
                # –ö–æ–ø–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
                cursor.execute("INSERT INTO mutes_new SELECT *, 0 FROM mutes")
                # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é, –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ–º –Ω–æ–≤—É—é
                cursor.execute("DROP TABLE mutes")
                cursor.execute("ALTER TABLE mutes_new RENAME TO mutes")
                conn.commit()
                print("‚úÖ –¢–∞–±–ª–∏—Ü–∞ mutes –æ–±–Ω–æ–≤–ª–µ–Ω–∞")
            except Exception as e:
                print(f"‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è mutes: {e}")

    conn.close()
    return True

    # –î–æ–±–∞–≤—å —ç—Ç—É —Ñ—É–Ω–∫—Ü–∏—é –≤ FXB.py –∏ –≤—ã–∑–æ–≤–∏ –≤ –Ω–∞—á–∞–ª–µ main()


def create_essential_tables():
    """–°–æ–∑–¥–∞–µ—Ç –≤—Å–µ –æ—Å–Ω–æ–≤–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã"""
    import sqlite3

    DB_PATH = "FernieUI.db"

    essential_tables = {
        'user_cases': '''CREATE TABLE IF NOT EXISTS user_cases (
            user_id TEXT,
            case_name TEXT,
            count INTEGER DEFAULT 0,
            PRIMARY KEY (user_id, case_name)
        )''',

        'bonus_timers': '''CREATE TABLE IF NOT EXISTS bonus_timers (
            user_id TEXT,
            bonus_type INTEGER,
            last_claim INTEGER DEFAULT 0,
            PRIMARY KEY (user_id, bonus_type)
        )''',

        'clans': '''CREATE TABLE IF NOT EXISTS clans (
            clan_id INTEGER PRIMARY KEY,
            name TEXT NOT NULL UNIQUE,
            owner_id TEXT NOT NULL,
            created_at TEXT DEFAULT (DATE('now')),
            is_verified INTEGER DEFAULT 0,
            is_private INTEGER DEFAULT 0,
            sale_price INTEGER DEFAULT 0
        )''',

        'clan_members': '''CREATE TABLE IF NOT EXISTS clan_members (
            user_id TEXT NOT NULL PRIMARY KEY,
            clan_id INTEGER NOT NULL,
            is_owner INTEGER DEFAULT 0,
            can_invite INTEGER DEFAULT 0
        )''',

        'fernieplus_custom': """
        CREATE TABLE IF NOT EXISTS fernieplus_custom (
            user_id TEXT PRIMARY KEY,
            media_type TEXT DEFAULT 'photo',
            media_path TEXT DEFAULT 'profile_def.png'
        )
        """,
    }

    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    created = 0
    for table_name, sql in essential_tables.items():
        try:
            cursor.execute(f"SELECT name FROM sqlite_master WHERE type='table' AND name='{table_name}'")
            if not cursor.fetchone():
                cursor.execute(sql)
                print(f"‚ûï –°–æ–∑–¥–∞–ª —Ç–∞–±–ª–∏—Ü—É: {table_name}")
                created += 1
        except Exception as e:
            print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ {table_name}: {e}")

    conn.commit()
    conn.close()

    print(f"‚úÖ –°–æ–∑–¥–∞–Ω–æ —Ç–∞–±–ª–∏—Ü: {created}")

async def update_username_middleware(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    if not user:
        return  # –Ω–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Äî –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º, –æ—Å—Ç–∞–ª—å–Ω—ã–º —Ö—ç–Ω–¥–ª–µ—Ä–∞–º –ø–µ—Ä–µ–¥–∞–µ–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

    user_id = str(user.id)
    username = user.username or ""

    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()
        cursor.execute("SELECT username FROM users WHERE user_id = ?", (user_id,))
        row = cursor.fetchone()

        if row:
            db_username = row[0] or ""
            if db_username != username:
                cursor.execute("UPDATE users SET username = ? WHERE user_id = ?", (username, user_id))
                conn.commit()
        else:
            cursor.execute(
                "INSERT INTO users (user_id, username, first_name) VALUES (?, ?, ?)",
                (user_id, username, user.first_name or "")
            )
            conn.commit()

def get_db_path():
    if os.path.exists('/home/FernadezTain'):
        return "/tmp/FernieUI.db"
    return "FernieUI.db"

def get_user_status(user_id: str) -> int:
    conn = sqlite3.connect(get_db_path())
    cursor = conn.cursor()

    cursor.execute(
        "SELECT status FROM users WHERE user_id = ?",
        (user_id,)
    )
    row = cursor.fetchone()
    conn.close()

    return row[0] if row else 0

USER_ID_COLUMNS = {
    "user_id",
    "owner_id",
    "parent1_id",
    "parent2_id",
    "issuer_id",
}

EXCLUDED_TABLES = {"bans", "mutes"}

def transfer_account(old_id: str, new_id: str):
    conn = sqlite3.connect(get_db_path(), timeout=30, check_same_thread=False)
    cursor = conn.cursor()

    # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã –∫—Ä–æ–º–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–π
    cursor.execute("""
        SELECT name FROM sqlite_master
        WHERE type='table' AND name NOT LIKE 'sqlite_%'
    """)
    tables = [t[0] for t in cursor.fetchall()]

    TEMP_ID = "__TEMP_TRANSFER_ID__"

    for table in tables:
        if table in EXCLUDED_TABLES:
            continue

        cursor.execute(f"PRAGMA table_info({table})")
        cols = [col[1] for col in cursor.fetchall()]
        for col in cols:
            if col in USER_ID_COLUMNS:
                # 1Ô∏è‚É£ –°–Ω–∞—á–∞–ª–∞ —Å—Ç–∞—Ä—ã–π ID ‚Üí –≤—Ä–µ–º–µ–Ω–Ω—ã–π
                cursor.execute(
                    f"UPDATE {table} SET {col} = ? WHERE {col} = ?",
                    (TEMP_ID, old_id)
                )
                # 2Ô∏è‚É£ –ù–æ–≤—ã–π ID ‚Üí —Å—Ç–∞—Ä—ã–π
                cursor.execute(
                    f"UPDATE {table} SET {col} = ? WHERE {col} = ?",
                    (old_id, new_id)
                )
                # 3Ô∏è‚É£ –í—Ä–µ–º–µ–Ω–Ω—ã–π ‚Üí –Ω–æ–≤—ã–π
                cursor.execute(
                    f"UPDATE {table} SET {col} = ? WHERE {col} = ?",
                    (new_id, TEMP_ID)
                )
                print(f"[TRANSFER] {table}.{col} –æ–±–Ω–æ–≤–ª–µ–Ω–æ")

    conn.commit()
    conn.close()

async def cmd_setaccount(update: Update, context: ContextTypes.DEFAULT_TYPE):
    # –ü–æ–ª—É—á–∞–µ–º –æ–±—ä–µ–∫—Ç message
    message = update.effective_message
    user = update.effective_user  # –∑–¥–µ—Å—å from_user

    user_id = str(user.id)

    if get_user_status(user_id) != 13:
        await message.reply_text(
            "‚õî –ö–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è **–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞**",
            parse_mode="Markdown"
        )
        return

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞—Ä–≥—É–º–µ–Ω—Ç—ã
    args = context.args  # —Å–ø–∏—Å–æ–∫ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ –ø–æ—Å–ª–µ –∫–æ–º–∞–Ω–¥—ã
    if len(args) != 2:
        await message.reply_text(
            "‚ùå –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:\n/setaccount <oldID> <newID>"
        )
        return

    old_id, new_id = args[0], args[1]

    await message.reply_text("üîÑ –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–µ—Ä–µ–Ω–æ—Å –¥–∞–Ω–Ω—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–∞...")

    # –ø–µ—Ä–µ–Ω–æ—Å –¥–∞–Ω–Ω—ã—Ö
    transfer_account(old_id, new_id)

    # –∏–º–∏—Ç–∞—Ü–∏—è –æ–∂–∏–¥–∞–Ω–∏—è
    import asyncio
    await asyncio.sleep(2)

    await message.reply_text(
        f"‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω—ã\n\n"
        f"OldID: `{old_id}`\n"
        f"NewID: `{new_id}`",
        parse_mode="Markdown"
    )

def init_crypto_db():
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("""
        CREATE TABLE IF NOT EXISTS crypto_balances (
            user_id TEXT NOT NULL,
            currency TEXT NOT NULL,
            balance REAL DEFAULT 0,
            PRIMARY KEY(user_id, currency)
        )
    """)
    conn.commit()
    conn.close()

STATUS_MEDIA = 1
STATUS_DEV = 13  # –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫

def ensure_media_partner_table():
    """–°–æ–∑–¥–∞—ë—Ç —Ç–∞–±–ª–∏—Ü—É media_partner, –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç"""
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("""
        CREATE TABLE IF NOT EXISTS media_partner (
            user_id TEXT PRIMARY KEY,       -- Telegram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            media_coins INTEGER DEFAULT 0,  -- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ MediaCoins
            photo_url TEXT,                 -- URL —Ñ–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è / –±–∞–Ω–Ω–µ—Ä–∞
            joined_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        )
    """)
    conn.commit()
    conn.close()

async def media_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = str(update.effective_user.id)

    # –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î
    conn = sqlite3.connect(DB_PATH)
    conn.row_factory = sqlite3.Row
    cursor = conn.cursor()

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    cursor.execute("SELECT status FROM users WHERE user_id = ?", (user_id,))
    user_row = cursor.fetchone()

    if not user_row:
        await update.message.reply_text("‚ùó –í—ã –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.")
        conn.close()
        return

    if user_row["status"] not in (STATUS_MEDIA, STATUS_DEV):
        await update.message.reply_text("üö´ –î–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –¥–ª—è Media-–ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤ –∏–ª–∏ –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤.")
        conn.close()
        return

    # –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ —Ç–∞–±–ª–∏—Ü–∞ media_partner —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    ensure_media_partner_table()

    # –ë–µ—Ä—ë–º –¢–û–õ–¨–ö–û media_coins
    cursor.execute("SELECT media_coins FROM media_partner WHERE user_id = ?", (user_id,))
    media_row = cursor.fetchone()
    conn.close()

    media_coins = media_row["media_coins"] if media_row else 0

    # üîó –°—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫—É ‚Äî –ø—Ä—è–º–æ –≤ –∫–æ–¥–µ
    PHOTO_URL = "https://i.postimg.cc/yNKGfK0r/Airbrush-IMAGE-ENHANCER-1768351711228-1768351711229.jpg"

    display_name = get_display_name_html_new(update.effective_user)

    message_text = (
        "üé¨ <b>–ü–∞–Ω–µ–ª—å –ú–µ–¥–∏–∞-–ü–∞—Ä—Ç–Ω–µ—Ä–∞</b>\n\n"
        f"üÜî TelegramID: <code>{user_id}</code>\n"
        f"üí† Name: {display_name}\n"
        f"üí∞ MediaCoins: {media_coins}\n"
    )

    try:
        await update.message.reply_photo(
            photo=PHOTO_URL,
            caption=message_text,
            parse_mode="HTML"
        )
    except:
        await update.message.reply_text(
            message_text,
            parse_mode="HTML"
        )


async def setmedialink_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = str(update.effective_user.id)
    args = context.args  # –∞—Ä–≥—É–º–µ–Ω—Ç—ã –∫–æ–º–∞–Ω–¥—ã

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤
    if not args or len(args) != 1:
        await update.message.reply_text("‚ùå –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:\n/setmedialink <—Å—Å—ã–ª–∫–∞>")
        return

    photo_url = args[0]

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ç–∞–±–ª–∏—Ü–µ users
    conn = sqlite3.connect(DB_PATH)
    conn.row_factory = sqlite3.Row
    cursor = conn.cursor()

    cursor.execute("SELECT status FROM users WHERE user_id = ?", (user_id,))
    user_row = cursor.fetchone()

    if not user_row:
        await update.message.reply_text("‚ùó –í—ã –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.")
        conn.close()
        return

    if user_row["status"] != STATUS_DEV:
        await update.message.reply_text("üö´ –ö–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫—É (—Å—Ç–∞—Ç—É—Å 13).")
        conn.close()
        return

    # –°–æ–∑–¥–∞—ë–º —Ç–∞–±–ª–∏—Ü—É media_partner –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    ensure_media_partner_table()

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Å—ã–ª–∫—É (insert –∏–ª–∏ update)
    cursor.execute("""
        INSERT INTO media_partner(user_id, photo_url)
        VALUES (?, ?)
        ON CONFLICT(user_id) DO UPDATE SET photo_url = excluded.photo_url
    """, (user_id, photo_url))
    conn.commit()
    conn.close()

    await update.message.reply_text(f"‚úÖ –°—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–æ—Ç–æ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞:\n{photo_url}")

async def mcoins_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = str(update.effective_user.id)

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ (—Ç–æ–ª—å–∫–æ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫)
    conn = sqlite3.connect(DB_PATH)
    conn.row_factory = sqlite3.Row
    cursor = conn.cursor()
    cursor.execute("SELECT status FROM users WHERE user_id = ?", (user_id,))
    user_row = cursor.fetchone()
    conn.close()

    if not user_row or user_row["status"] != STATUS_DEV:
        await update.message.reply_text("üö´ –ö–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫—É (—Å—Ç–∞—Ç—É—Å 13).")
        return

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤
    args = context.args
    if len(args) != 2:
        await update.message.reply_text("‚ùå –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:\n/mcoins +/- <TelegramID/–æ—Ç–≤–µ—Ç> <–∫–æ–ª-–≤–æ>")
        return

    operation = args[0]
    if operation not in ("+", "-"):
        await update.message.reply_text("‚ùå –°–Ω–∞—á–∞–ª–∞ —É–∫–∞–∂–∏—Ç–µ '+' –∏–ª–∏ '-' –¥–ª—è –ø—Ä–∏–±–∞–≤–ª–µ–Ω–∏—è/–≤—ã—á–∏—Ç–∞–Ω–∏—è.")
        return

    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º target_id
    if update.message.reply_to_message:
        target_id = str(update.message.reply_to_message.from_user.id)
    else:
        target_id = args[0] if operation == "+" or operation == "-" else None
        try:
            target_id = str(int(args[0]))
        except:
            await update.message.reply_text("‚ùå –£–∫–∞–∂–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π Telegram ID –∏–ª–∏ –æ—Ç–≤–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.")
            return

    try:
        amount = int(args[1])
        if amount <= 0:
            raise ValueError()
    except:
        await update.message.reply_text("‚ùå –£–∫–∞–∂–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ (—Ü–µ–ª–æ–µ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ —á–∏—Å–ª–æ).")
        return

    # –°–æ–∑–¥–∞—ë–º —Ç–∞–±–ª–∏—Ü—É media_partner –µ—Å–ª–∏ –Ω–µ—Ç
    ensure_media_partner_table()

    # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT media_coins FROM media_partner WHERE user_id = ?", (target_id,))
    row = cursor.fetchone()

    if row:
        current_balance = row[0]
    else:
        # –µ—Å–ª–∏ –∑–∞–ø–∏—Å–∏ –Ω–µ—Ç ‚Äî —Å–æ–∑–¥–∞—ë–º —Å –±–∞–ª–∞–Ω—Å–æ–º 0
        cursor.execute("INSERT INTO media_partner(user_id, media_coins) VALUES (?, 0)", (target_id,))
        current_balance = 0

    # –í—ã—á–∏—Å–ª—è–µ–º –Ω–æ–≤—ã–π –±–∞–ª–∞–Ω—Å
    if operation == "+":
        new_balance = current_balance + amount
    else:
        new_balance = current_balance - amount
        if new_balance < 0:
            new_balance = 0

    # –û–±–Ω–æ–≤–ª—è–µ–º –ë–î
    cursor.execute("UPDATE media_partner SET media_coins = ? WHERE user_id = ?", (new_balance, target_id))
    conn.commit()
    conn.close()

    await update.message.reply_text(
        f"‚úÖ –ë–∞–ª–∞–Ω—Å MediaCoins –∏–∑–º–µ–Ω—ë–Ω:\n"
        f"{target_id}\n"
        f"{current_balance} ‚Üí {new_balance}"
    )

def ensure_subfernieplus_table():
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Ç–∞–±–ª–∏—Ü–∞
    cursor.execute("""
        SELECT name FROM sqlite_master 
        WHERE type='table' AND name='SubFerniePlus'
    """)
    if cursor.fetchone():
        # –¢–∞–±–ª–∏—Ü–∞ –µ—Å—Ç—å ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–ª–æ–Ω–∫—É
        cursor.execute("PRAGMA table_info(SubFerniePlus)")
        columns = [col[1] for col in cursor.fetchall()]
        if "FernieStyle" not in columns:
            cursor.execute(
                "ALTER TABLE SubFerniePlus ADD COLUMN FernieStyle TEXT DEFAULT '–¢–µ–∫—Å—Ç'"
            )
            conn.commit()
    else:
        # –¢–∞–±–ª–∏—Ü—ã –Ω–µ—Ç ‚Äî —Å–æ–∑–¥–∞—ë–º —Å—Ä–∞–∑—É —Å –∫–æ–ª–æ–Ω–∫–æ–π FernieStyle
        cursor.execute("""
            CREATE TABLE SubFerniePlus (
                user_id TEXT PRIMARY KEY,
                end_time INTEGER,
                FernieStyle TEXT DEFAULT '–¢–µ–∫—Å—Ç'
            )
        """)
        conn.commit()

    conn.close()

def migrate_fernieplus_custom_table():
    """
    –ú–∏–≥—Ä–∞—Ü–∏—è —Å—Ç–∞—Ä–æ–π —Ç–∞–±–ª–∏—Ü—ã fernieplus_custom:
    background -> media_path
    –î–æ–±–∞–≤–ª—è–µ—Ç media_type, media_path, –¥–µ—Ñ–æ–ª—Ç profile_def.png
    """

    with sqlite3.connect(DB_PATH) as conn:
        cur = conn.cursor()

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å—Ç–∞—Ä–∞—è –∫–æ–ª–æ–Ω–∫–∞ background
        cur.execute("PRAGMA table_info(fernieplus_custom)")
        columns = [col[1] for col in cur.fetchall()]

        if "media_type" in columns and "media_path" in columns:
            print("[DB] –¢–∞–±–ª–∏—Ü–∞ —É–∂–µ –≤ –Ω–æ–≤–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ")
            return

        print("[DB] –ú–∏–≥—Ä–∞—Ü–∏—è —Ç–∞–±–ª–∏—Ü—ã fernieplus_custom...")

        # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é —Ç–∞–±–ª–∏—Ü—É —Å –Ω–æ–≤–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π
        cur.execute("""
            CREATE TABLE IF NOT EXISTS fernieplus_custom_new (
                user_id TEXT PRIMARY KEY,
                media_type TEXT DEFAULT 'photo',
                media_path TEXT DEFAULT 'fons/png/profile_def.png'
            )
        """)

        # –ü–µ—Ä–µ–Ω–æ—Å–∏–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Å—Ç–∞—Ä–æ–π —Ç–∞–±–ª–∏—Ü—ã, –µ—Å–ª–∏ –µ—Å—Ç—å
        if "background" in columns:
            cur.execute("SELECT user_id, background FROM fernieplus_custom")
            rows = cur.fetchall()
            for user_id, background in rows:
                if background.lower().endswith(".gif"):
                    media_type = "animation"
                    media_path = os.path.join("fons/gif", os.path.basename(background))
                else:
                    media_type = "photo"
                    media_path = os.path.join("fons/png", os.path.basename(background))

                # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –Ω–æ–≤—É—é —Ç–∞–±–ª–∏—Ü—É
                cur.execute("""
                    INSERT INTO fernieplus_custom_new (user_id, media_type, media_path)
                    VALUES (?, ?, ?)
                """, (user_id, media_type, media_path))

        # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é —Ç–∞–±–ª–∏—Ü—É
        cur.execute("DROP TABLE IF EXISTS fernieplus_custom")

        # –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ–º –Ω–æ–≤—É—é
        cur.execute("ALTER TABLE fernieplus_custom_new RENAME TO fernieplus_custom")

        conn.commit()
        print("[DB] –ú–∏–≥—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ ‚úÖ")

# –°–ª–æ–≤–∞—Ä—å –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è cooldown (user_id -> timestamp –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è)
payment_cooldowns = {}


def add_balance(user_id: int, dc: int = 0, seeds: int = 0):
    """–ù–∞—á–∏—Å–ª—è–µ—Ç DC –∏/–∏–ª–∏ —Å–µ–º–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é"""
    conn = sqlite3.connect(DB_PATH, timeout=30.0, check_same_thread=False)
    cursor = conn.cursor()

    cursor.execute("INSERT OR IGNORE INTO users (user_id) VALUES (?)", (str(user_id),))

    if dc > 0:
        cursor.execute("UPDATE users SET dc_balance = dc_balance + ? WHERE user_id = ?", (dc, str(user_id)))

    if seeds > 0:
        cursor.execute("UPDATE users SET seeds = seeds + ? WHERE user_id = ?", (seeds, str(user_id)))

    conn.commit()
    conn.close()


# ----------------- –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã -----------------
def menu_keyboard(user_status: int):
    buttons = [
        [InlineKeyboardButton("üå± –°–µ–º–µ–Ω–∞", callback_data="buy_seeds")],
        [InlineKeyboardButton("üí∞ Digital Coins", callback_data="buy_dc")],
        [InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∏—Ç—å", callback_data="cancel_donate")]
    ]

    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É Admin Coins, –µ—Å–ª–∏ —Å—Ç–∞—Ç—É—Å 3 –∏ –≤—ã—à–µ
    if user_status >= 3:
        # –í—Å—Ç–∞–≤–ª—è–µ–º –º–µ–∂–¥—É –°–µ–º–µ–Ω–∞ –∏ Digital Coins
        buttons.insert(1, [InlineKeyboardButton("üõ† Admin Coins", callback_data="admin_coins")])

    return InlineKeyboardMarkup(buttons)


def confirm_keyboard():
    return InlineKeyboardMarkup([
        [InlineKeyboardButton("‚úÖ –û–ø–ª–∞—Ç–∏—Ç—å", callback_data="pay")],
        [InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data="cancel_donate")]
    ])


def payment_keyboard(amount_stars: int, item_name: str):
    return InlineKeyboardMarkup([
        [InlineKeyboardButton(f"–û–ø–ª–∞—Ç–∏—Ç—å {amount_stars} ‚≠êÔ∏è", pay=True)]
    ])


# ----------------- –ö–æ–º–∞–Ω–¥–∞ /donate -----------------
async def donate_menu(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ö–æ–º–∞–Ω–¥–∞ /donate {—Å—É–º–º–∞} - –º–µ–Ω—é –≤—ã–±–æ—Ä–∞ —Ç–æ–≤–∞—Ä–∞"""
    if len(context.args) == 0:
        await update.message.reply_text("–£–∫–∞–∂–∏—Ç–µ —Å—É–º–º—É: \n/donate {—Å—É–º–º–∞ ‚≠êÔ∏è}")
        return

    try:
        amount = int(context.args[0])
    except ValueError:
        await update.message.reply_text("–°—É–º–º–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —á–∏—Å–ª–æ–º.")
        return

    context.user_data['donate_amount'] = amount
    user_html = get_display_name_html_new(update.message.from_user)

    # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –±–∞–∑—ã
    cursor = conn.cursor()
    cursor.execute("SELECT status FROM users WHERE user_id = ?", (str(update.message.from_user.id),))
    result = cursor.fetchone()
    user_status = result[0] if result else 0  # 0 ‚Äî –æ–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å

    text = (
        f"üëã –ü—Ä–∏–≤–µ—Ç, {user_html}!\n"
        f"‚ú® –°—É–º–º–∞: <b>{amount} ‚≠êÔ∏è</b>\n\n"
        f"üõí –ß—Ç–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ –ø—Ä–∏–æ–±—Ä–µ—Å—Ç–∏?"
    )

    await update.message.reply_text(
        text,
        reply_markup=menu_keyboard(user_status),
        parse_mode="HTML"
    )


# ----------------- –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ç–æ–≤–∞—Ä–∞ -----------------
async def donate_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    amount = context.user_data.get('donate_amount', 1)

    if query.data == "cancel_donate":
        await query.edit_message_text("‚ùå –û–ø–ª–∞—Ç–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞.")
        return

    # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –±–∞–∑—ã
    cursor = conn.cursor()
    cursor.execute("SELECT status FROM users WHERE user_id = ?", (str(query.from_user.id),))
    result = cursor.fetchone()
    user_status = result[0] if result else 0  # 0 ‚Äî –æ–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å

    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ–∫—É–ø–∫—É
    if query.data == "buy_dc":
        rate = 100
        item_name = "Digital Coins"
    elif query.data == "buy_seeds":
        rate = 1000
        item_name = "–°–µ–º–µ–Ω–∞"
    elif query.data == "admin_coins":
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–º–µ–µ—Ç —Å—Ç–∞—Ç—É—Å 3 –∏–ª–∏ –≤—ã—à–µ
        if user_status < 3:
            await query.edit_message_text("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –æ–ø—Ü–∏–∏.")
            return
        rate = 10  # –Ω–∞–ø—Ä–∏–º–µ—Ä, 1 ‚≠êÔ∏è = 10 Admin Coins
        item_name = "Admin Coins"

    else:
        return

    total = amount * rate
    context.user_data['pay_amount'] = amount
    context.user_data['pay_rate'] = total
    context.user_data['pay_item'] = item_name

    await query.edit_message_text(
        f"üõç <b>–ü–æ–∫—É–ø–∫–∞ {html.escape(item_name)}</b>\n"
        f"üí± –ö—É—Ä—Å –æ–ø–ª–∞—Ç—ã: 1 ‚≠êÔ∏è = {rate} {'DC' if item_name == 'Digital Coins' else item_name}\n"
        f"‚≠ê –û–ø–ª–∞—á–∏–≤–∞–µ—Ç–µ: {amount}\n"
        f"üí∞ –ü–æ–ª—É—á–∏—Ç–µ: {total} {item_name}",
        reply_markup=confirm_keyboard(),
        parse_mode="HTML"
    )


# ----------------- –ö–Ω–æ–ø–∫–∞ "–û–ø–ª–∞—Ç–∏—Ç—å" —Å cooldown -----------------
async def donate_pay(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    user_id = query.from_user.id
    current_time = time.time()

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º cooldown
    if user_id in payment_cooldowns:
        time_passed = current_time - payment_cooldowns[user_id]
        if time_passed < 30:
            remaining = int(30 - time_passed)
            await query.answer(
                f"‚è≥ –ü–æ–¥–æ–∂–¥–∏—Ç–µ {remaining} —Å–µ–∫. –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–µ–π –ø–æ–ø—ã—Ç–∫–æ–π –æ–ø–ª–∞—Ç—ã",
                show_alert=True
            )
            return

    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—ã–π cooldown
    payment_cooldowns[user_id] = current_time
    await query.answer()

    user_data = context.user_data
    amount_stars = user_data.get('pay_amount', 1)
    item_name = user_data.get('pay_item', "Digital Coins")
    total = user_data.get('pay_rate', 500)

    if item_name == "Digital Coins":
        product_unit = "DC"
    elif item_name == "–°–µ–º–µ–Ω–∞":
        product_unit = "—Å–µ–º—è–Ω"
    elif item_name == "Admin Coins":
        product_unit = "Admin Coins"
    else:
        product_unit = item_name

    # –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–æ–π –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
    try:
        await query.message.delete()
    except Exception:
        pass

    invoice_msg = await context.bot.send_invoice(
        chat_id=query.message.chat.id,
        title=f"–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ —Å—á–µ—Ç–∞ ‚≠êÔ∏è",
        description=f"–ü–æ–∫—É–ø–∫–∞ {item_name} ‚Äî {total} {product_unit} –∑–∞ {amount_stars} ‚≠êÔ∏è",
        payload=f"pstars_support_{amount_stars}",
        provider_token="",
        currency="XTR",
        prices=[LabeledPrice(label="XTR", amount=amount_stars)],
        reply_markup=payment_keyboard(amount_stars, f"{total} {product_unit}")
    )

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º message_id –∏–Ω–≤–æ–π—Å–∞, —á—Ç–æ–±—ã –ø–æ—Ç–æ–º —É–¥–∞–ª–∏—Ç—å
    context.user_data['invoice_message_id'] = invoice_msg.message_id
    context.user_data['invoice_chat_id'] = query.message.chat.id


# ----------------- –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ -----------------
async def precheckout_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.pre_checkout_query
    await query.answer(ok=True)


# ----------------- –£—Å–ø–µ—à–Ω–∞—è –æ–ø–ª–∞—Ç–∞ -----------------
async def successful_payment(update: Update, context: ContextTypes.DEFAULT_TYPE):
    payment = update.message.successful_payment
    if payment.invoice_payload.startswith("pstars_gift"):
        await successful_gift_payment(update, context)
        return

    if not payment.invoice_payload.startswith("pstars_support"):
        return

    user_id = update.message.from_user.id
    user_html = get_display_name_html_new(update.message.from_user)
    item_name = context.user_data.get("pay_item", "Digital Coins")
    amount = context.user_data.get("pay_amount", 1)
    total = context.user_data.get("pay_rate", amount * 10)

    # –£–¥–∞–ª—è–µ–º –∏–Ω–≤–æ–π—Å –∏ –∑–∞–º–µ–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º –æ–± —É—Å–ø–µ—Ö–µ
    invoice_msg_id = context.user_data.get('invoice_message_id')
    invoice_chat_id = context.user_data.get('invoice_chat_id')

    if invoice_msg_id and invoice_chat_id:
        try:
            await context.bot.delete_message(chat_id=invoice_chat_id, message_id=invoice_msg_id)
        except Exception:
            pass
        await context.bot.send_message(
            chat_id=invoice_chat_id,
            text="‚úÖ <b>–£—Å–ø–µ—à–Ω–æ –æ–ø–ª–∞—á–µ–Ω–æ!</b>",
            parse_mode="HTML"
        )
        context.user_data.pop('invoice_message_id', None)
        context.user_data.pop('invoice_chat_id', None)

    # –¢–∞–∫–∂–µ —É–¥–∞–ª—è–µ–º —Å–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ Telegram –æ–± —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç–µ
    try:
        await update.message.delete()
    except Exception:
        pass

    cursor = conn.cursor()

    if item_name == "Digital Coins":
        add_balance(user_id, dc=total)
        product_text = f"{total} DC"

    elif item_name == "–°–µ–º–µ–Ω–∞":
        add_balance(user_id, seeds=total)
        product_text = f"{total} —Å–µ–º—è–Ω"

    elif item_name == "Admin Coins":
        cursor.execute(
            "INSERT INTO admins (user_id, points) VALUES (?, ?) "
            "ON CONFLICT(user_id) DO UPDATE SET points = points + ?",
            (str(user_id), total, total)
        )
        conn.commit()
        product_text = f"{total} Admin Coins"

    else:
        await context.bot.send_message(
            chat_id=invoice_chat_id or update.message.chat.id,
            text="‚ùå –û—à–∏–±–∫–∞: –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–æ–≤–∞—Ä."
        )
        return

    # ---------- –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ----------
    text = (
        f"<b>‚úÖ –û–ø–ª–∞—Ç–∞ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ!</b>\n"
        f"‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n"
        f"üõí –¢–æ–≤–∞—Ä: <b>{html.escape(item_name)}</b>\n"
        f"üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {user_html}\n"
        f"‚≠êÔ∏è –û–ø–ª–∞—á–µ–Ω–æ: <b>{amount}</b>\n"
        f"üì¶ –ù–∞—á–∏—Å–ª–µ–Ω–æ: <b>{product_text}</b>\n"
        f"‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n"
        f"–°–ø–∞—Å–∏–±–æ –∑–∞ –ø–æ–¥–¥–µ—Ä–∂–∫—É –ø—Ä–æ–µ–∫—Ç–∞! ü§ó"
    )

    await context.bot.send_message(
        chat_id=invoice_chat_id or update.message.chat.id,
        text=text,
        parse_mode="HTML"
    )

    # ---------- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω—É ----------
    notify_text = (
        f"üßæ <b>–ù–æ–≤–∞—è –ø–æ–∫—É–ø–∫–∞</b>\n"
        f"‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n"
        f"üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {user_html}\n"
        f"üÜî ID: <code>{user_id}</code>\n"
        f"üõí –ü—Ä–æ–¥—É–∫—Ç: <b>{html.escape(item_name)}</b>\n"
        f"‚≠êÔ∏è –°—É–º–º–∞: <b>{amount}</b>\n"
        f"üì¶ –ù–∞—á–∏—Å–ª–µ–Ω–æ: <b>{product_text}</b>\n"
    )

    try:
        await context.bot.send_message(
            chat_id=Transaction_ID,
            text=notify_text,
            parse_mode="HTML"
        )
    except Exception as e:
        print("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ —á–∞—Ç Transaction:", e)

# ================= –ö–û–ú–ê–ù–î–ê /gift =================

async def gift_menu(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ö–æ–º–∞–Ω–¥–∞ /gift {—Å—É–º–º–∞} {TelegramID} {–¢–µ–∫—Å—Ç –ø–æ –∂–µ–ª–∞–Ω–∏—é}"""

    if len(context.args) < 2:
        await update.message.reply_text(
            "‚ùå –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /gift {—Å—É–º–º–∞ ‚≠êÔ∏è} {TelegramID} {–¢–µ–∫—Å—Ç –ø–æ –∂–µ–ª–∞–Ω–∏—é}\n\n"
            "–ü—Ä–∏–º–µ—Ä: /gift 100 123456789 –≠—Ç–æ –ø–æ–¥–∞—Ä–æ–∫ –¥–ª—è —Ç–µ–±—è!"
        )
        return

    try:
        amount = int(context.args[0])
        recipient_id = int(context.args[1])
    except ValueError:
        await update.message.reply_text("‚ùå –°—É–º–º–∞ –∏ TelegramID –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —á–∏—Å–ª–∞–º–∏.")
        return

    # –û–±—ä–µ–¥–∏–Ω—è–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã –≤ —Ç–µ–∫—Å—Ç –ø–æ–¥–∞—Ä–∫–∞
    gift_text = " ".join(context.args[2:]) if len(context.args) > 2 else ""

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç
    context.user_data['gift_amount'] = amount
    context.user_data['recipient_id'] = recipient_id
    context.user_data['gift_text'] = gift_text
    context.user_data['sender_id'] = update.message.from_user.id

    sender_html = get_display_name_html_new(update.message.from_user)

    # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –±–∞–∑—ã
    cursor = conn.cursor()
    cursor.execute("SELECT status FROM users WHERE user_id = ?", (str(update.message.from_user.id),))
    result = cursor.fetchone()
    user_status = result[0] if result else 0  # 0 ‚Äî –æ–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å

    text = (
        f"üëã –ü—Ä–∏–≤–µ—Ç, {sender_html}!\n"
        f"üéÅ –í—ã –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç–µ –ø–æ–¥–∞—Ä–æ–∫\n"
        f"üë§ –ü–æ–ª—É—á–∞—Ç–µ–ª—é: <code>{recipient_id}</code>\n"
        f"‚≠êÔ∏è –°—É–º–º–∞: <b>{amount} ‚≠êÔ∏è</b>\n\n"
        f"üõí –ß—Ç–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ –ø–æ–¥–∞—Ä–∏—Ç—å?"
    )

    await update.message.reply_text(
        text,
        reply_markup=gift_keyboard(user_status),
        parse_mode="HTML"
    )


def gift_keyboard(user_status: int):
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –≤—ã–±–æ—Ä–∞ —Ç–æ–≤–∞—Ä–∞ –¥–ª—è –ø–æ–¥–∞—Ä–∫–∞"""
    buttons = [
        [InlineKeyboardButton("üå± –°–µ–º–µ–Ω–∞", callback_data="gift_buy_seeds")],
        [InlineKeyboardButton("üí∞ Digital Coins", callback_data="gift_buy_dc")],
        [InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∏—Ç—å", callback_data="gift_cancel")]
    ]

    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É Admin Coins, –µ—Å–ª–∏ —Å—Ç–∞—Ç—É—Å 3 –∏ –≤—ã—à–µ
    if user_status >= 3:
        # –í—Å—Ç–∞–≤–ª—è–µ–º –º–µ–∂–¥—É –°–µ–º–µ–Ω–∞ –∏ Digital Coins
        buttons.insert(1, [InlineKeyboardButton("üõ† Admin Coins", callback_data="gift_buy_ac")])

    return InlineKeyboardMarkup(buttons)


def gift_confirm_keyboard():
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–æ–¥–∞—Ä–∫–∞"""
    return InlineKeyboardMarkup([
        [InlineKeyboardButton("‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∏ –æ–ø–ª–∞—Ç–∏—Ç—å", callback_data="gift_pay")],
        [InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data="gift_cancel")]
    ])


async def gift_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ç–æ–≤–∞—Ä–∞ –¥–ª—è –ø–æ–¥–∞—Ä–∫–∞"""
    query = update.callback_query
    await query.answer()

    if query.data == "gift_cancel":
        await query.edit_message_text("‚ùå –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ–¥–∞—Ä–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞.")
        return

    amount = context.user_data.get('gift_amount', 1)

    # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –±–∞–∑—ã
    cursor = conn.cursor()
    cursor.execute("SELECT status FROM users WHERE user_id = ?", (str(query.from_user.id),))
    result = cursor.fetchone()
    user_status = result[0] if result else 0  # 0 ‚Äî –æ–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å

    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ–∫—É–ø–∫—É
    if query.data == "gift_buy_dc":
        rate = 100
        item_name = "Digital Coins"
    elif query.data == "gift_buy_seeds":
        rate = 1000
        item_name = "–°–µ–º–µ–Ω–∞"
    elif query.data == "gift_buy_ac":
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–º–µ–µ—Ç —Å—Ç–∞—Ç—É—Å 3 –∏–ª–∏ –≤—ã—à–µ
        if user_status < 3:
            await query.edit_message_text("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –æ–ø—Ü–∏–∏.")
            return
        rate = 10
        item_name = "Admin Coins"
    else:
        return

    total = amount * rate
    context.user_data['pay_amount'] = amount
    context.user_data['pay_rate'] = total
    context.user_data['pay_item'] = item_name

    await query.edit_message_text(
        f"üéÅ <b>–ü–æ–¥–∞—Ä–æ–∫ {html.escape(item_name)}</b>\n"
        f"üí± –ö—É—Ä—Å –æ–ø–ª–∞—Ç—ã: 1 ‚≠êÔ∏è = {rate} {'DC' if item_name == 'Digital Coins' else item_name}\n"
        f"‚≠ê –û–ø–ª–∞—á–∏–≤–∞–µ—Ç–µ: {amount}\n"
        f"üí∞ –ü–æ–ª—É—á–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∏—Ç: {total} {item_name}",
        reply_markup=gift_confirm_keyboard(),
        parse_mode="HTML"
    )

# ----------------- –ö–Ω–æ–ø–∫–∞ –æ–ø–ª–∞—Ç—ã –ø–æ–¥–∞—Ä–∫–∞ —Å cooldown -----------------
async def gift_pay(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    user_id = query.from_user.id
    current_time = time.time()

    cooldown_key = f"gift_{user_id}"
    if cooldown_key in payment_cooldowns:
        time_passed = current_time - payment_cooldowns[cooldown_key]
        if time_passed < 30:
            remaining = int(30 - time_passed)
            await query.answer(
                f"‚è≥ –ü–æ–¥–æ–∂–¥–∏—Ç–µ {remaining} —Å–µ–∫. –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–µ–π –ø–æ–ø—ã—Ç–∫–æ–π –æ–ø–ª–∞—Ç—ã –ø–æ–¥–∞—Ä–∫–∞",
                show_alert=True
            )
            return

    payment_cooldowns[cooldown_key] = current_time
    await query.answer()

    user_data = context.user_data
    amount_stars = user_data.get('pay_amount', 1)
    item_name = user_data.get('pay_item', "Digital Coins")
    total = user_data.get('pay_rate', 500)
    recipient_id = user_data.get('recipient_id')

    if item_name == "Digital Coins":
        product_unit = "DC"
    elif item_name == "–°–µ–º–µ–Ω–∞":
        product_unit = "—Å–µ–º—è–Ω"
    elif item_name == "Admin Coins":
        product_unit = "Admin Coins"
    else:
        product_unit = item_name

    # –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–æ–π –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
    try:
        await query.message.delete()
    except Exception:
        pass

    invoice_msg = await context.bot.send_invoice(
        chat_id=query.message.chat.id,
        title=f"–û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ–¥–∞—Ä–∫–∞ üéÅ",
        description=f"–ü–æ–¥–∞—Ä–æ–∫ {item_name} ‚Äî {total} {product_unit} –∑–∞ {amount_stars} ‚≠êÔ∏è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {recipient_id}",
        payload=f"pstars_gift_{amount_stars}_{recipient_id}",
        provider_token="",
        currency="XTR",
        prices=[LabeledPrice(label="XTR", amount=amount_stars)],
        reply_markup=payment_keyboard(amount_stars, f"{total} {product_unit}")
    )

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º message_id –∏–Ω–≤–æ–π—Å–∞
    context.user_data['invoice_message_id'] = invoice_msg.message_id
    context.user_data['invoice_chat_id'] = query.message.chat.id


async def successful_gift_payment(update: Update, context: ContextTypes.DEFAULT_TYPE):
    payment = update.message.successful_payment

    if not payment.invoice_payload.startswith("pstars_gift"):
        return

    sender_id = update.message.from_user.id
    sender_html = get_display_name_html_new(update.message.from_user)

    recipient_id = context.user_data.get('recipient_id')
    item_name = context.user_data.get('pay_item', "Digital Coins")
    amount = context.user_data.get('pay_amount', 1)
    total = context.user_data.get('pay_rate', amount * 10)
    gift_text = context.user_data.get('gift_text', "")

    # –£–¥–∞–ª—è–µ–º –∏–Ω–≤–æ–π—Å –∏ –∑–∞–º–µ–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º –æ–± —É—Å–ø–µ—Ö–µ
    invoice_msg_id = context.user_data.get('invoice_message_id')
    invoice_chat_id = context.user_data.get('invoice_chat_id')

    if invoice_msg_id and invoice_chat_id:
        try:
            await context.bot.delete_message(chat_id=invoice_chat_id, message_id=invoice_msg_id)
        except Exception:
            pass
        await context.bot.send_message(
            chat_id=invoice_chat_id,
            text="‚úÖ <b>–£—Å–ø–µ—à–Ω–æ –æ–ø–ª–∞—á–µ–Ω–æ!</b>",
            parse_mode="HTML"
        )
        context.user_data.pop('invoice_message_id', None)
        context.user_data.pop('invoice_chat_id', None)

    # –£–¥–∞–ª—è–µ–º —Å–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ Telegram –æ–± —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç–µ
    try:
        await update.message.delete()
    except Exception:
        pass

    cursor = conn.cursor()
    delivery_status = True

    try:
        if item_name == "Digital Coins":
            add_balance(recipient_id, dc=total)
            product_text = f"{total} DC"

        elif item_name == "–°–µ–º–µ–Ω–∞":
            add_balance(recipient_id, seeds=total)
            product_text = f"{total} —Å–µ–º—è–Ω"

        elif item_name == "Admin Coins":
            cursor.execute(
                "INSERT INTO admins (user_id, points) VALUES (?, ?) "
                "ON CONFLICT(user_id) DO UPDATE SET points = points + ?",
                (str(recipient_id), total, total)
            )
            conn.commit()
            product_text = f"{total} Admin Coins"

        else:
            await context.bot.send_message(
                chat_id=invoice_chat_id or sender_id,
                text="‚ùå –û—à–∏–±–∫–∞: –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–æ–≤–∞—Ä."
            )
            return

        # ---------- –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—é ----------
        gift_notification = (
            f"üéÅ <b>–í–∞–º –ø–æ–¥–∞—Ä–æ–∫!</b>\n"
            f"‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n"
            f"üë§ –û—Ç: {sender_html}\n"
        )

        if gift_text:
            gift_notification += f"üìù –¢–µ–∫—Å—Ç: <i>{html.escape(gift_text)}</i>\n"

        gift_notification += (
            f"üí∞ –ü–æ–ª—É—á–µ–Ω–æ: <b>{product_text}</b>\n"
            f"üì¶ –ü—Ä–µ–¥–º–µ—Ç: <b>{html.escape(item_name)}</b>\n"
            f"‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
        )

        try:
            await context.bot.send_message(
                chat_id=recipient_id,
                text=gift_notification,
                parse_mode="HTML"
            )
            delivery_status = True
        except Exception as e:
            delivery_status = False
            print(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ–¥–∞—Ä–∫–∞ –ø–æ–ª—É—á–∞—Ç–µ–ª—é {recipient_id}: {e}")

    except Exception as e:
        await context.bot.send_message(
            chat_id=invoice_chat_id or sender_id,
            text=f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –ø–æ–¥–∞—Ä–∫–∞: {e}"
        )
        return

    # ---------- –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—é ----------
    if delivery_status:
        delivery_text = "‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ –ø–æ–ª—É—á–∞—Ç–µ–ª—é"
    else:
        delivery_text = "‚ö†Ô∏è –°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ –ø–æ–ª—É—á–∞—Ç–µ–ª—é, –≤–æ–∑–º–æ–∂–Ω–æ –ø–æ–ª—É—á–∞—Ç–µ–ª—å –Ω–µ –Ω–∞—á–∞–ª —á–∞—Ç —Å –±–æ—Ç–æ–º"

    sender_message = (
        f"<b>‚úÖ –û–ø–ª–∞—Ç–∞ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ!</b>\n"
        f"‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n"
        f"üéÅ –ü–æ–¥–∞—Ä–æ–∫: <b>{html.escape(item_name)}</b>\n"
        f"üë§ –û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å: {sender_html}\n"
        f"üë• –ü–æ–ª—É—á–∞—Ç–µ–ª—å: <code>{recipient_id}</code>\n"
        f"‚≠êÔ∏è –û–ø–ª–∞—á–µ–Ω–æ –∑–≤—ë–∑–¥: <b>{amount}</b>\n"
        f"üì¶ –ù–∞—á–∏—Å–ª–µ–Ω–æ: <b>{product_text}</b>\n"
        f"‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n"
        f"{delivery_text}\n"
    )

    await context.bot.send_message(
        chat_id=invoice_chat_id or sender_id,
        text=sender_message,
        parse_mode="HTML"
    )

    # ---------- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω—É ----------
    notify_text = (
        f"üéÅ <b>–ù–æ–≤—ã–π –ø–æ–¥–∞—Ä–æ–∫</b>\n"
        f"‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n"
        f"üë§ –û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å: {sender_html}\n"
        f"üÜî ID –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è: <code>{sender_id}</code>\n"
        f"üë• –ü–æ–ª—É—á–∞—Ç–µ–ª—å: <code>{recipient_id}</code>\n"
        f"üéÄ –ü—Ä–æ–¥—É–∫—Ç: <b>{html.escape(item_name)}</b>\n"
        f"‚≠êÔ∏è –û–ø–ª–∞—á–µ–Ω–æ –∑–≤—ë–∑–¥: <b>{amount}</b>\n"
        f"üì¶ –ù–∞—á–∏—Å–ª–µ–Ω–æ: <b>{product_text}</b>\n"
        f"üìù –¢–µ–∫—Å—Ç –ø–æ–¥–∞—Ä–∫–∞: <i>{html.escape(gift_text) if gift_text else '(–Ω–µ —É–∫–∞–∑–∞–Ω)'}</i>\n"
        f"üìä –°—Ç–∞—Ç—É—Å –¥–æ—Å—Ç–∞–≤–∫–∏: {'‚úÖ –î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ' if delivery_status else '‚ùå –ù–µ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ'}\n"
    )

    try:
        await context.bot.send_message(
            chat_id=Transaction_ID,
            text=notify_text,
            parse_mode="HTML"
        )
    except Exception as e:
        print("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ —á–∞—Ç Transaction:", e)

def get_image_type(file_path: str):
    """
    –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ñ–æ—Ä–º–∞—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: jpeg, png, gif –∏ —Ç.–¥.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç None, –µ—Å–ª–∏ —Ñ–∞–π–ª –Ω–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.
    """
    try:
        with Image.open(file_path) as img:
            return img.format.lower()  # 'jpeg', 'png', 'gif' –∏ —Ç.–¥.
    except Exception:
        return None


async def pet_info_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = str(update.effective_user.id)
    username = update.effective_user.username or update.effective_user.first_name or "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"

    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("SELECT inventory_pet FROM users WHERE user_id = ?", (user_id,))
    row = cursor.fetchone()
    conn.close()

    if not row or not row[0]:
        await update.message.reply_text("üêæ –£ –≤–∞—Å –Ω–µ—Ç –ø–∏—Ç–æ–º—Ü–∞.")
        return

    pet_name = row[0]
    pet_price = "N/A"

    if "–ø–∏—Ç–æ–º—Ü—ã" in PRODUCTS:
        pet = next((p for p in PRODUCTS["–ø–∏—Ç–æ–º—Ü—ã"] if p["name"].lower() == pet_name.lower()), None)
        if pet:
            pet_price = pet["price"]

    text = (
        "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
        f"üêæ <b>–ü–∏—Ç–æ–º–µ—Ü - {pet_name}</b>\n"
        "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
        f"üë§ <b>–í–ª–∞–¥–µ–ª–µ—Ü:</b> {username}\n"
        f"üí∞ <b>–°—Ç–æ–∏–º–æ—Å—Ç—å:</b> {pet_price} ‚ÇΩ\n"
        "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
    )

    await update.message.reply_photo(
        photo="https://i.postimg.cc/Pr7VVc5x/image.png",
        caption=text,
        parse_mode='HTML'
    )

MACROS_FILE = "macros.json"
MAX_MACROS_PER_USER = 10


# ============================================
# –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–ê–ë–û–¢–´ –° –ë–î
# ============================================

def get_top_users_by(field: str):
    """–ü–æ–ª—É—á–∏—Ç—å —Ç–æ–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ —É–∫–∞–∑–∞–Ω–Ω–æ–º—É –ø–æ–ª—é"""
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    if field == "level":
        cursor.execute("""
            SELECT user_id, first_name, exp, (CAST(exp / 100 AS INTEGER) + 1) AS level_calc
            FROM users
            ORDER BY level_calc DESC
            LIMIT 5
        """)
        users = cursor.fetchall()
    else:
        cursor.execute(f"""
            SELECT user_id, first_name, {field}
            FROM users
            ORDER BY CAST({field} AS INTEGER) DESC
            LIMIT 5
        """)
        users = cursor.fetchall()
    conn.close()
    return users


def get_top_charity():
    """–ü–æ–ª—É—á–∏—Ç—å —Ç–æ–ø –±–ª–∞–≥–æ—Ç–≤–æ—Ä–∏—Ç–µ–ª–µ–π"""
    from decimal import Decimal

    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("""
        SELECT user_id, username, SUM(CAST(donation_amount AS REAL)) as total_donated
        FROM charity
        GROUP BY user_id
        ORDER BY total_donated DESC
        LIMIT 5
    """)
    rows = cursor.fetchall()
    conn.close()

    users = []
    for user_id, username, total in rows:
        total_decimal = Decimal(str(total)) if total is not None else Decimal(0)
        users.append((user_id, username, total_decimal))
    return users


# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–∞–π–ª–∞ –º–∞–∫—Ä–æ—Å–æ–≤
def init_macros_file():
    """–°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª –º–∞–∫—Ä–æ—Å–æ–≤ –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç"""
    if not os.path.exists(MACROS_FILE):
        with open(MACROS_FILE, "w", encoding="utf-8") as f:
            json.dump({}, f, ensure_ascii=False, indent=2)


def load_macros() -> Dict:
    """–ó–∞–≥—Ä—É–∑–∏—Ç—å –≤—Å–µ –º–∞–∫—Ä–æ—Å—ã"""
    init_macros_file()
    try:
        with open(MACROS_FILE, "r", encoding="utf-8") as f:
            return json.load(f)
    except:
        return {}


def save_macros(data: Dict):
    """–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –º–∞–∫—Ä–æ—Å—ã"""
    with open(MACROS_FILE, "w", encoding="utf-8") as f:
        json.dump(data, f, ensure_ascii=False, indent=2)


def get_user_macros(user_id: int) -> List[Dict]:
    """–ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –º–∞–∫—Ä–æ—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    data = load_macros()
    user_id_str = str(user_id)
    return data.get(user_id_str, [])


def add_user_macro(user_id: int, trigger: str, actions: List[Dict]) -> bool:
    """–î–æ–±–∞–≤–∏—Ç—å –º–∞–∫—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é"""
    data = load_macros()
    user_id_str = str(user_id)

    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –º–∞–∫—Ä–æ—Å–æ–≤ –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
    if user_id_str not in data:
        data[user_id_str] = []

    user_macros = data[user_id_str]

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞
    if len(user_macros) >= MAX_MACROS_PER_USER:
        return False

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç —Ç—Ä–∏–≥–≥–µ—Ä–∞
    for macro in user_macros:
        if macro["trigger"] == trigger:
            return False

    # –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –º–∞–∫—Ä–æ—Å
    user_macros.append({
        "trigger": trigger,
        "actions": actions
    })

    data[user_id_str] = user_macros
    save_macros(data)
    return True


def delete_user_macro(user_id: int, trigger: str) -> bool:
    """–£–¥–∞–ª–∏—Ç—å –º–∞–∫—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    data = load_macros()
    user_id_str = str(user_id)

    if user_id_str not in data:
        return False

    user_macros = data[user_id_str]
    initial_length = len(user_macros)

    # –£–¥–∞–ª—è–µ–º –º–∞–∫—Ä–æ—Å —Å –¥–∞–Ω–Ω—ã–º —Ç—Ä–∏–≥–≥–µ—Ä–æ–º
    data[user_id_str] = [m for m in user_macros if m["trigger"] != trigger]

    if len(data[user_id_str]) < initial_length:
        save_macros(data)
        return True

    return False

async def macros_connect(update: Update, context: ContextTypes.DEFAULT_TYPE, macro_string: str):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –º–∞–∫—Ä–æ—Å–∞ –∏–∑ —Å–∞–π—Ç–∞"""
    user = update.effective_user
    user_id = user.id

    def detransliterate(text):
        replacements = {
            'zh': '–∂', 'ch': '—á', 'sh': '—à', 'sch': '—â', 'yo': '—ë', 'yu': '—é', 'ya': '—è', 'ts': '—Ü',
            'Zh': '–ñ', 'Ch': '–ß', 'Sh': '–®', 'Sch': '–©', 'Yo': '–Å', 'Yu': '–Æ', 'Ya': '–Ø', 'Ts': '–¶',
            'a': '–∞', 'b': '–±', 'v': '–≤', 'g': '–≥', 'd': '–¥', 'e': '–µ', 'z': '–∑', 'i': '–∏', 'y': '–π',
            'k': '–∫', 'l': '–ª', 'm': '–º', 'n': '–Ω', 'o': '–æ', 'p': '–ø', 'r': '—Ä', 's': '—Å', 't': '—Ç',
            'u': '—É', 'f': '—Ñ', 'h': '—Ö', 'A': '–ê', 'B': '–ë', 'V': '–í', 'G': '–ì', 'D': '–î', 'E': '–ï',
            'Z': '–ó', 'I': '–ò', 'Y': '–ô', 'K': '–ö', 'L': '–õ', 'M': '–ú', 'N': '–ù', 'O': '–û', 'P': '–ü',
            'R': '–†', 'S': '–°', 'T': '–¢', 'U': '–£', 'F': '–§', 'H': '–•', '_': ' '
        }
        sorted_keys = sorted(replacements.keys(), key=len, reverse=True)
        for key in sorted_keys:
            text = text.replace(key, replacements[key])
        return text

    try:
        parts = macro_string.split('_A_')
        if len(parts) < 2:
            await update.message.reply_text("‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –º–∞–∫—Ä–æ—Å–∞.", parse_mode="HTML")
            return

        trigger = detransliterate(parts[0])
        actions = []

        for i in range(1, len(parts)):
            action_str = parts[i]
            action_parts = action_str.split('-', 1)
            if len(action_parts) < 2:
                continue

            action_type = action_parts[0]
            action_data = action_parts[1]

            if action_type == 't':
                top_parts = action_data.split('-')
                if len(top_parts) >= 3:
                    top_type = top_parts[0]
                    sub_type = top_parts[1] if top_parts[1] != 'none' else None
                    position = '{me}' if top_parts[2] == 'ME' else top_parts[2]

                    type_names = {
                        'balance': '–ë–∞–ª–∞–Ω—Å', 'charity': '–ë–ª–∞–≥–æ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å',
                        'digital_coins': 'Digital Coins', 'level': '–£—Ä–æ–≤–µ–Ω—å', 'messages': '–°–æ–æ–±—â–µ–Ω–∏—è'
                    }
                    display_value = type_names.get(top_type, top_type)
                    display_value += ' - –º–æ—è –ø–æ–∑–∏—Ü–∏—è' if position == '{me}' else f' - –ø–æ–∑–∏—Ü–∏—è {position}'

                    actions.append({
                        'type': 'get_top_position',
                        'value': json.dumps({
                            'topType': top_type, 'subType': sub_type, 'position': position, 'display': display_value
                        })
                    })

            elif action_type == 'm':
                message_text = action_data
                message_text = message_text.replace('TOPRES', '___TOPRES___')
                message_text = message_text.replace('TOPID', '___TOPID___')
                message_text = message_text.replace('ME', '___ME___')
                message_text = detransliterate(message_text)
                message_text = message_text.replace('___TOPRES___', '{topresult}')
                message_text = message_text.replace('___TOPID___', '{topresultID}')
                message_text = message_text.replace('___ME___', '{me}')
                actions.append({'type': 'send_message', 'value': message_text})

            elif action_type == 'p':
                actions.append({'type': 'send_photo', 'value': action_data})

            elif action_type == 'r':
                target_id = action_data.replace('TOPID', '{topresultID}')
                actions.append({'type': 'robbery', 'value': target_id})

        if not trigger or not actions:
            await update.message.reply_text("‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –º–∞–∫—Ä–æ—Å–∞.", parse_mode="HTML")
            return

        user_macros = get_user_macros(user_id)
        if len(user_macros) >= MAX_MACROS_PER_USER:
            await update.message.reply_text(
                f"‚ùå –õ–∏–º–∏—Ç –º–∞–∫—Ä–æ—Å–æ–≤: {MAX_MACROS_PER_USER}",
                parse_mode="HTML"
            )
            return

        success = add_user_macro(user_id, trigger, actions)

        if success:
            await update.message.reply_text(
                f"‚úÖ <b>–ú–∞–∫—Ä–æ—Å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!</b>\n\n"
                f"üéØ <code>/{trigger}</code>\n"
                f"‚öôÔ∏è –î–µ–π—Å—Ç–≤–∏–π: {len(actions)}",
                parse_mode="HTML"
            )
        else:
            await update.message.reply_text(
                f"‚ùå –ú–∞–∫—Ä–æ—Å <code>/{trigger}</code> —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.",
                parse_mode="HTML"
            )

    except Exception as e:
        print(f"[ERROR] macros_connect: {e}")
        await update.message.reply_text("‚ùå –û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –º–∞–∫—Ä–æ—Å–∞", parse_mode="HTML")

async def execute_macro(update: Update, context: ContextTypes.DEFAULT_TYPE, trigger: str):
    """–í—ã–ø–æ–ª–Ω–∏—Ç—å –º–∞–∫—Ä–æ—Å –ø–æ —Ç—Ä–∏–≥–≥–µ—Ä—É"""
    user = update.effective_user
    user_id = user.id
    chat_id = update.effective_chat.id if update.effective_chat else None

    # –ü–æ–ª—É—á–∞–µ–º –º–∞–∫—Ä–æ—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user_macros = get_user_macros(user_id)

    # –ò—â–µ–º –º–∞–∫—Ä–æ—Å —Å –¥–∞–Ω–Ω—ã–º —Ç—Ä–∏–≥–≥–µ—Ä–æ–º
    macro = None
    for m in user_macros:
        if m["trigger"] == trigger:
            macro = m
            break

    if not macro:
        return False

    actions = macro["actions"]
    top_result_data = None

    try:
        # –í—ã–ø–æ–ª–Ω—è–µ–º –¥–µ–π—Å—Ç–≤–∏—è –ø–æ –æ—á–µ—Ä–µ–¥–∏
        for action in actions:
            action_type = action.get("type")
            action_value = action.get("value")

            if action_type == "get_top_position":
                try:
                    top_data = json.loads(action_value)
                    top_type = top_data.get("topType")
                    sub_type = top_data.get("subType")
                    position = top_data.get("position")

                    top_result_data = await get_position_from_top(
                        top_type,
                        sub_type,
                        position,
                        user_id,
                        chat_id
                    )
                except Exception as e:
                    print(f"[ERROR] get_top_position: {e}")
                    continue

            elif action_type == "send_message":
                message_text = action_value

                # –ò—Å–ø—Ä–∞–≤–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –º–∞–∫—Ä–æ—Å—ã
                message_text = message_text.replace('–¢–û–ü–†–ï–°', '{topresult}')
                message_text = message_text.replace('–¢–û–ü–ò–î', '{topresultID}')

                if "{topresult}" in message_text and top_result_data:
                    message_text = message_text.replace("{topresult}", top_result_data)

                await update.message.reply_text(message_text, parse_mode="HTML")

            elif action_type == "send_photo":
                await update.message.reply_photo(photo=action_value)

            elif action_type == "robbery":
                target_id = action_value

                # –ó–∞–º–µ–Ω—è–µ–º {topresultID} –Ω–∞ ID –∏–∑ —Ç–æ–ø–∞
                if "{topresultID}" in target_id and top_result_data:
                    import re
                    id_match = re.search(r'üÜî <code>(\d+)</code>', top_result_data)
                    if id_match:
                        target_id = id_match.group(1)

                context.args = [target_id]
                await robbing_command(update, context)

        # –°–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –º–∞–∫—Ä–æ—Å–∞
        await update.message.reply_text(
            f"‚úÖ <b>–ú–∞–∫—Ä–æ—Å –≤—ã–ø–æ–ª–Ω–µ–Ω</b>\n\n"
            f"–ö–æ–º–∞–Ω–¥–∞: <code>/{trigger}</code>\n"
            f"–î–µ–π—Å—Ç–≤–∏–π: <b>{len(actions)}</b>",
            parse_mode="HTML"
        )

        return True

    except Exception as e:
        print(f"[ERROR] execute_macro: {e}")
        await update.message.reply_text(
            f"‚ùå <b>–û—à–∏–±–∫–∞ –º–∞–∫—Ä–æ—Å–∞</b>\n\n"
            f"<code>/{trigger}</code>\n"
            f"{str(e)}",
            parse_mode="HTML"
        )
        return False

def get_top_users_by_for_macros(field: str):
    """
    –ü–æ–ª—É—á–∏—Ç—å –í–°–ï –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ —É–∫–∞–∑–∞–Ω–Ω–æ–º—É –ø–æ–ª—é (–¥–ª—è –º–∞–∫—Ä–æ—Å–æ–≤)
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤–µ—Å—å —Ç–æ–ø –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
    """
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    if field == "level":
        cursor.execute("""
            SELECT user_id, first_name, exp, (CAST(exp / 100 AS INTEGER) + 1) AS level_calc
            FROM users
            ORDER BY level_calc DESC
        """)
        users = cursor.fetchall()
    else:
        cursor.execute(f"""
            SELECT user_id, first_name, {field}
            FROM users
            ORDER BY CAST({field} AS INTEGER) DESC
        """)
        users = cursor.fetchall()
    conn.close()
    return users


def get_top_charity_for_macros():
    """
    –ü–æ–ª—É—á–∏—Ç—å –í–°–ï –±–ª–∞–≥–æ—Ç–≤–æ—Ä–∏—Ç–µ–ª–µ–π (–¥–ª—è –º–∞–∫—Ä–æ—Å–æ–≤)
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤–µ—Å—å —Ç–æ–ø –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
    """
    from decimal import Decimal

    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute("""
        SELECT user_id, username, SUM(CAST(donation_amount AS REAL)) as total_donated
        FROM charity
        GROUP BY user_id
        ORDER BY total_donated DESC
    """)
    rows = cursor.fetchall()
    conn.close()

    users = []
    for user_id, username, total in rows:
        total_decimal = Decimal(str(total)) if total is not None else Decimal(0)
        users.append((user_id, username, total_decimal))
    return users


# –¢–ï–ü–ï–†–¨ –û–ë–ù–û–í–ò–¢–ï get_position_from_top —á—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:

async def get_position_from_top(
        top_type: str,
        sub_type: Optional[str],
        position: str,
        user_id: int,
        chat_id: Optional[int] = None
) -> str:
    """–ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–∑–∏—Ü–∏–∏ –≤ —Ç–æ–ø–µ"""
    try:
        print(f"[DEBUG] get_position_from_top called: type={top_type}, position={position}")

        # –ï—Å–ª–∏ –ø–æ–∑–∏—Ü–∏—è {me} - –∏—â–µ–º –ø–æ–∑–∏—Ü–∏—é —Å–∞–º–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        if position == "{me}":
            if top_type == "balance":
                return await get_user_balance_position(user_id)
            elif top_type == "level":
                return await get_user_level_position(user_id)
            elif top_type == "charity":
                return await get_user_charity_position(user_id)
            elif top_type == "digital_coins":
                return await get_user_dc_position(user_id)
            elif top_type == "messages":
                return await get_user_messages_position(user_id, sub_type)

        # –ò–Ω–∞—á–µ –∏—â–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –ø–æ–∑–∏—Ü–∏—é
        position_num = int(position)
        print(f"[DEBUG] Looking for position number: {position_num}")

        # –ò–°–ü–û–õ–¨–ó–£–ï–ú –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ú–ê–ö–†–û–°–û–í (–±–µ–∑ –ª–∏–º–∏—Ç–∞)
        if top_type == "balance":
            users = get_top_users_by_for_macros("balance")
            print(f"[DEBUG] Balance top loaded: {len(users)} users")
        elif top_type == "level":
            users = get_top_users_by_for_macros("level")
            print(f"[DEBUG] Level top loaded: {len(users)} users")
        elif top_type == "charity":
            users = get_top_charity_for_macros()
            print(f"[DEBUG] Charity top loaded: {len(users)} users")
        elif top_type == "digital_coins":
            users = get_top_users_by_for_macros("dc_balance")
            print(f"[DEBUG] DC top loaded: {len(users)} users")
        elif top_type == "messages":
            if sub_type == "global":
                return await get_messages_global_position(position_num)
            else:  # local
                if chat_id is None:
                    return "‚ùå –î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ç–æ–ø–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º ID —á–∞—Ç–∞"
                return await get_messages_local_position(position_num, chat_id)
        else:
            return "‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø —Ç–æ–ø–∞"

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ø–æ–∑–∏—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        print(f"[DEBUG] Checking if position {position_num} exists in {len(users)} users")
        if position_num < 1 or position_num > len(users):
            return f"‚ùå –ü–æ–∑–∏—Ü–∏—è {position_num} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ —Ç–æ–ø–µ (–≤—Å–µ–≥–æ {len(users)} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)"

        # –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ —ç—Ç–æ–π –ø–æ–∑–∏—Ü–∏–∏
        target = users[position_num - 1]
        print(f"[DEBUG] Found user at position {position_num}: {target}")

        if top_type in ["balance", "level", "digital_coins"]:
            target_user_id, first_name, value = target[0], target[1], target[2]

            display_name = f"<a href='tg://user?id={target_user_id}'>{first_name or '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}</a>"

            type_labels = {
                "balance": "üí∞ –ë–∞–ª–∞–Ω—Å",
                "level": "üèÜ –£—Ä–æ–≤–µ–Ω—å",
                "digital_coins": "üí∞ DigitalCoins"
            }

            return (
                f"üîç <b>–ù–∞–π–¥–µ–Ω–æ –≤ —Ç–æ–ø–µ</b>\n\n"
                f"üìä –ü–æ–∑–∏—Ü–∏—è: <b>#{position_num}</b>\n"
                f"üë§ {display_name}\n"
                f"üÜî <code>{target_user_id}</code>\n"
                f"{type_labels[top_type]}: <b>{value:,}</b>".replace(",", ".")
            )

        elif top_type == "charity":
            target_user_id, username, total_donated = target

            display_name = f"<a href='tg://user?id={target_user_id}'>{username or '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}</a>"

            return (
                f"üîç <b>–ù–∞–π–¥–µ–Ω–æ –≤ —Ç–æ–ø–µ</b>\n\n"
                f"üìä –ü–æ–∑–∏—Ü–∏—è: <b>#{position_num}</b>\n"
                f"üë§ {display_name}\n"
                f"üÜî <code>{target_user_id}</code>\n"
                f"üíñ –ü–æ–∂–µ—Ä—Ç–≤–æ–≤–∞–Ω–æ: <b>{int(total_donated):,}</b>".replace(",", ".")
            )

    except Exception as e:
        print(f"[ERROR] get_position_from_top: {e}")
        import traceback
        traceback.print_exc()
        return f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–∏: {str(e)}"
# –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ–∑–∏—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

async def get_user_balance_position(user_id: int) -> str:
    """–ù–∞–π—Ç–∏ –ø–æ–∑–∏—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ç–æ–ø–µ –ø–æ –±–∞–ª–∞–Ω—Å—É"""
    conn = sqlite3.connect("FernieUI.db")  # –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ DB_PATH –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    cursor = conn.cursor()

    # –ü–æ–ª—É—á–∞–µ–º –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    cursor.execute("SELECT balance, first_name FROM users WHERE user_id = ?", (str(user_id),))
    row = cursor.fetchone()

    if not row or row[0] is None:
        conn.close()
        return "‚ùå –í—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö"

    user_balance = row[0]
    first_name = row[1] or "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"

    # –ü–æ–ª—É—á–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –≤ —Ç–æ–ø–µ
    cursor.execute("""
        SELECT COUNT(*) + 1
        FROM users
        WHERE CAST(balance AS INTEGER) > ?
    """, (user_balance,))

    position = cursor.fetchone()[0]
    conn.close()

    from telegram import User as TgUser
    user_obj = TgUser(id=int(user_id), first_name=first_name, last_name="", is_bot=False)

    # –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞ –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
    # from your_bot_file import get_display_name_html_new
    display_name = f"<a href='tg://user?id={user_id}'>{first_name}</a>"

    return (
        f"üîç <b>–í–∞—à–∞ –ø–æ–∑–∏—Ü–∏—è –≤ —Ç–æ–ø–µ</b>\n\n"
        f"üìä –ü–æ–∑–∏—Ü–∏—è: <b>#{position}</b>\n"
        f"üë§ {display_name}\n"
        f"üÜî <code>{user_id}</code>\n"
        f"üí∞ –ë–∞–ª–∞–Ω—Å: <b>{user_balance:,}</b>‚ÇΩ".replace(",", ".")
    )


async def get_user_level_position(user_id: int) -> str:
    """–ù–∞–π—Ç–∏ –ø–æ–∑–∏—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ç–æ–ø–µ –ø–æ —É—Ä–æ–≤–Ω—é"""
    conn = sqlite3.connect("FernieUI.db")
    cursor = conn.cursor()

    # –ü–æ–ª—É—á–∞–µ–º exp –∏ —É—Ä–æ–≤–µ–Ω—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    cursor.execute("SELECT exp, first_name FROM users WHERE user_id = ?", (str(user_id),))
    row = cursor.fetchone()

    if not row or row[0] is None:
        conn.close()
        return "‚ùå –í—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö"

    user_exp = row[0]
    first_name = row[1] or "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"
    user_level = (user_exp // 100) + 1

    # –ü–æ–ª—É—á–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –≤ —Ç–æ–ø–µ
    cursor.execute("""
        SELECT COUNT(*) + 1
        FROM users
        WHERE (CAST(exp AS INTEGER) / 100 + 1) > ?
    """, (user_level,))

    position = cursor.fetchone()[0]
    conn.close()

    display_name = f"<a href='tg://user?id={user_id}'>{first_name}</a>"

    return (
        f"üîç <b>–í–∞—à–∞ –ø–æ–∑–∏—Ü–∏—è –≤ —Ç–æ–ø–µ</b>\n\n"
        f"üìä –ü–æ–∑–∏—Ü–∏—è: <b>#{position}</b>\n"
        f"üë§ {display_name}\n"
        f"üÜî <code>{user_id}</code>\n"
        f"üèÜ –£—Ä–æ–≤–µ–Ω—å: <b>{user_level}</b>\n"
        f"üí° EXP: {user_exp}"
    )


async def get_user_charity_position(user_id: int) -> str:
    """–ù–∞–π—Ç–∏ –ø–æ–∑–∏—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ç–æ–ø–µ –±–ª–∞–≥–æ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏"""
    from decimal import Decimal

    conn = sqlite3.connect("FernieUI.db")
    cursor = conn.cursor()

    # –ü–æ–ª—É—á–∞–µ–º —Å—É–º–º—É –ø–æ–∂–µ—Ä—Ç–≤–æ–≤–∞–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    cursor.execute("""
        SELECT SUM(CAST(donation_amount AS REAL)), username
        FROM charity
        WHERE user_id = ?
        GROUP BY user_id
    """, (str(user_id),))

    row = cursor.fetchone()

    if not row or row[0] is None:
        conn.close()
        return "‚ùå –í—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ —Ç–æ–ø–µ –±–ª–∞–≥–æ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏"

    user_total = Decimal(str(row[0]))
    username = row[1] or "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"

    # –ü–æ–ª—É—á–∞–µ–º –ø–æ–∑–∏—Ü–∏—é
    cursor.execute("""
        SELECT COUNT(*) + 1
        FROM (
            SELECT user_id, SUM(CAST(donation_amount AS REAL)) as total
            FROM charity
            GROUP BY user_id
            HAVING total > ?
        )
    """, (float(user_total),))

    position = cursor.fetchone()[0]
    conn.close()

    display_name = f"<a href='tg://user?id={user_id}'>{username}</a>"

    return (
        f"üîç <b>–í–∞—à–∞ –ø–æ–∑–∏—Ü–∏—è –≤ —Ç–æ–ø–µ</b>\n\n"
        f"üìä –ü–æ–∑–∏—Ü–∏—è: <b>#{position}</b>\n"
        f"üë§ {display_name}\n"
        f"üÜî <code>{user_id}</code>\n"
        f"üíñ –ü–æ–∂–µ—Ä—Ç–≤–æ–≤–∞–Ω–æ: <b>{int(user_total):,}</b>".replace(",", ".")
    )


    users = []
    for user_id, username, total in rows:
        total_decimal = Decimal(str(total)) if total is not None else Decimal(0)
        users.append((user_id, username, total_decimal))
    return users

async def get_user_dc_position(user_id: int) -> str:
    """–ù–∞–π—Ç–∏ –ø–æ–∑–∏—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ç–æ–ø–µ –ø–æ DigitalCoins"""
    conn = sqlite3.connect("FernieUI.db")
    cursor = conn.cursor()

    # –ü–æ–ª—É—á–∞–µ–º dc_balance –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    cursor.execute("SELECT dc_balance, first_name FROM users WHERE user_id = ?", (str(user_id),))
    row = cursor.fetchone()

    if not row or row[0] is None:
        conn.close()
        return "‚ùå –í—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö"

    user_dc = row[0]
    first_name = row[1] or "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"

    # –ü–æ–ª—É—á–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –≤ —Ç–æ–ø–µ
    cursor.execute("""
        SELECT COUNT(*) + 1
        FROM users
        WHERE CAST(dc_balance AS INTEGER) > ?
    """, (user_dc,))

    position = cursor.fetchone()[0]
    conn.close()

    display_name = f"<a href='tg://user?id={user_id}'>{first_name}</a>"

    return (
        f"üîç <b>–í–∞—à–∞ –ø–æ–∑–∏—Ü–∏—è –≤ —Ç–æ–ø–µ</b>\n\n"
        f"üìä –ü–æ–∑–∏—Ü–∏—è: <b>#{position}</b>\n"
        f"üë§ {display_name}\n"
        f"üÜî <code>{user_id}</code>\n"
        f"üí∞ DigitalCoins: <b>{user_dc:,}</b>".replace(",", ".")
    )


async def get_user_messages_position(user_id: int, sub_type: str) -> str:
    """–ù–∞–π—Ç–∏ –ø–æ–∑–∏—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ç–æ–ø–µ —Å–æ–æ–±—â–µ–Ω–∏–π"""
    if sub_type == "global":
        return await get_user_messages_global_position(user_id)
    else:  # local
        return await get_user_messages_local_position(user_id)


async def get_user_messages_global_position(user_id: int) -> str:
    """–ù–∞–π—Ç–∏ –ø–æ–∑–∏—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –≥–ª–æ–±–∞–ª—å–Ω–æ–º —Ç–æ–ø–µ —Å–æ–æ–±—â–µ–Ω–∏–π"""
    if not os.path.exists("SMSChat.json"):
        return "‚ùå –î–∞–Ω–Ω—ã–µ –æ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"

    with open("SMSChat.json", "r", encoding="utf-8") as f:
        data = json.load(f)

    user_id_str = str(user_id)

    if user_id_str not in data:
        return "‚ùå –í—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ –≥–ª–æ–±–∞–ª—å–Ω–æ–º —Ç–æ–ø–µ —Å–æ–æ–±—â–µ–Ω–∏–π"

    user_info = data[user_id_str]
    user_messages = user_info.get("messages", 0)
    user_name = user_info.get("name", "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å")

    # –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é
    position = 1
    for uid, info in data.items():
        if info.get("messages", 0) > user_messages:
            position += 1

    display_name = f"<a href='tg://user?id={user_id}'>{user_name}</a>"

    return (
        f"üîç <b>–í–∞—à–∞ –ø–æ–∑–∏—Ü–∏—è –≤ —Ç–æ–ø–µ</b>\n\n"
        f"üìä –ü–æ–∑–∏—Ü–∏—è: <b>#{position}</b>\n"
        f"üë§ {display_name}\n"
        f"üÜî <code>{user_id}</code>\n"
        f"üí¨ –°–æ–æ–±—â–µ–Ω–∏–π (–≥–ª–æ–±–∞–ª—å–Ω–æ): <b>{user_messages}</b>"
    )


async def get_user_messages_local_position(user_id: int) -> str:
    """–ù–∞–π—Ç–∏ –ø–æ–∑–∏—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º —Ç–æ–ø–µ —Å–æ–æ–±—â–µ–Ω–∏–π"""
    # –î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ç–æ–ø–∞ –Ω—É–∂–µ–Ω chat_id, –Ω–æ –º—ã –Ω–µ –º–æ–∂–µ–º –µ–≥–æ –ø–æ–ª—É—á–∏—Ç—å –∑–¥–µ—Å—å
    # –ü–æ—ç—Ç–æ–º—É –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—à–∏–±–∫—É
    return "‚ùå –î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ç–æ–ø–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —á–∞—Ç"


async def get_messages_global_position(position: int) -> str:
    """–ü–æ–ª—É—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ –ø–æ–∑–∏—Ü–∏–∏ –≤ –≥–ª–æ–±–∞–ª—å–Ω–æ–º —Ç–æ–ø–µ —Å–æ–æ–±—â–µ–Ω–∏–π"""
    if not os.path.exists("SMSChat.json"):
        return "‚ùå –î–∞–Ω–Ω—ã–µ –æ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"

    with open("SMSChat.json", "r", encoding="utf-8") as f:
        data = json.load(f)

    if not data:
        return "‚ùå –¢–æ–ø —Å–æ–æ–±—â–µ–Ω–∏–π –ø—É—Å—Ç"

    # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É —Å–æ–æ–±—â–µ–Ω–∏–π
    sorted_users = sorted(data.items(), key=lambda x: x[1].get("messages", 0), reverse=True)

    if position < 1 or position > len(sorted_users):
        return f"‚ùå –ü–æ–∑–∏—Ü–∏—è {position} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ —Ç–æ–ø–µ"

    target_user_id, target_info = sorted_users[position - 1]
    target_name = target_info.get("name", "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å")
    target_messages = target_info.get("messages", 0)

    from telegram import User as TgUser
    user_obj = TgUser(
        id=int(target_user_id),
        first_name=target_name,
        last_name="",
        is_bot=False
    )

    display_name = f"<a href='tg://user?id={target_user_id}'>{target_name}</a>"

    return (
        f"üîç <b>–ù–∞–π–¥–µ–Ω–æ –≤ —Ç–æ–ø–µ</b>\n\n"
        f"üìä –ü–æ–∑–∏—Ü–∏—è: <b>#{position}</b>\n"
        f"üë§ {display_name}\n"
        f"üÜî <code>{target_user_id}</code>\n"
        f"üí¨ –°–æ–æ–±—â–µ–Ω–∏–π (–≥–ª–æ–±–∞–ª—å–Ω–æ): <b>{target_messages}</b>"
    )


async def get_messages_local_position(position: int, chat_id: int) -> str:
    """–ü–æ–ª—É—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ –ø–æ–∑–∏—Ü–∏–∏ –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º —Ç–æ–ø–µ —Å–æ–æ–±—â–µ–Ω–∏–π"""
    if not os.path.exists("SMSChatChats.json"):
        return "‚ùå –î–∞–Ω–Ω—ã–µ –æ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"

    with open("SMSChatChats.json", "r", encoding="utf-8") as f:
        data = json.load(f)

    chat_id_str = str(chat_id)

    if chat_id_str not in data or not data[chat_id_str]:
        return "‚ùå –í —ç—Ç–æ–º —á–∞—Ç–µ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö"

    chat_data = data[chat_id_str]

    # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É —Å–æ–æ–±—â–µ–Ω–∏–π
    sorted_users = sorted(chat_data.items(), key=lambda x: x[1].get("messages", 0), reverse=True)

    if position < 1 or position > len(sorted_users):
        return f"‚ùå –ü–æ–∑–∏—Ü–∏—è {position} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ —Ç–æ–ø–µ —ç—Ç–æ–≥–æ —á–∞—Ç–∞"

    target_user_id, target_info = sorted_users[position - 1]
    target_name = target_info.get("name", "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å")
    target_messages = target_info.get("messages", 0)

    display_name = f"<a href='tg://user?id={target_user_id}'>{target_name}</a>"

    return (
        f"üîç <b>–ù–∞–π–¥–µ–Ω–æ –≤ —Ç–æ–ø–µ</b>\n\n"
        f"üìä –ü–æ–∑–∏—Ü–∏—è: <b>#{position}</b>\n"
        f"üë§ {display_name}\n"
        f"üÜî <code>{target_user_id}</code>\n"
        f"üí¨ –°–æ–æ–±—â–µ–Ω–∏–π (–≤ —ç—Ç–æ–º —á–∞—Ç–µ): <b>{target_messages}</b>"
    )


# –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–∞–∫—Ä–æ—Å–∞–º–∏
async def macros_list_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ –º–∞–∫—Ä–æ—Å–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    user = update.effective_user
    user_id = user.id

    user_macros = get_user_macros(user_id)

    if not user_macros:
        await update.message.reply_text(
            "üìù <b>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –º–∞–∫—Ä–æ—Å–æ–≤</b>\n\n"
            "–°–æ–∑–¥–∞–π—Ç–µ –º–∞–∫—Ä–æ—Å –Ω–∞ —Å–∞–π—Ç–µ:\n"
            "https://fernie-x-macros.vercel.app/\n\n"
            f"–õ–∏–º–∏—Ç –º–∞–∫—Ä–æ—Å–æ–≤: {MAX_MACROS_PER_USER}",
            parse_mode="HTML"
        )
        return

    text = f"üìù <b>–í–∞—à–∏ –º–∞–∫—Ä–æ—Å—ã ({len(user_macros)}/{MAX_MACROS_PER_USER}):</b>\n\n"

    for idx, macro in enumerate(user_macros, 1):
        trigger = macro["trigger"]
        actions_count = len(macro["actions"])
        text += f"{idx}. <code>/{trigger}</code> ‚Äî {actions_count} –¥–µ–π—Å—Ç–≤–∏–π\n"

    text += (
        f"\nüí° <b>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:</b>\n"
        f"–ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É <code>/—Ç—Ä–∏–≥–≥–µ—Ä</code>\n\n"
        f"üóë <b>–£–¥–∞–ª–∏—Ç—å –º–∞–∫—Ä–æ—Å:</b>\n"
        f"<code>/—É–¥–∞–ª–∏—Ç—å_–º–∞–∫—Ä–æ—Å —Ç—Ä–∏–≥–≥–µ—Ä</code>"
    )

    await update.message.reply_text(text, parse_mode="HTML")


async def delete_macro_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–£–¥–∞–ª–∏—Ç—å –º–∞–∫—Ä–æ—Å"""
    user = update.effective_user
    user_id = user.id

    if not context.args:
        await update.message.reply_text(
            "‚ùå –£–∫–∞–∂–∏—Ç–µ —Ç—Ä–∏–≥–≥–µ—Ä –º–∞–∫—Ä–æ—Å–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è\n\n"
            "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: <code>/—É–¥–∞–ª–∏—Ç—å_–º–∞–∫—Ä–æ—Å —Ç—Ä–∏–≥–≥–µ—Ä</code>",
            parse_mode="HTML"
        )
        return

    trigger = context.args[0].replace("/", "")

    success = delete_user_macro(user_id, trigger)

    if success:
        await update.message.reply_text(
            f"‚úÖ –ú–∞–∫—Ä–æ—Å <code>/{trigger}</code> —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª—ë–Ω!",
            parse_mode="HTML"
        )
    else:
        await update.message.reply_text(
            f"‚ùå –ú–∞–∫—Ä–æ—Å <code>/{trigger}</code> –Ω–µ –Ω–∞–π–¥–µ–Ω",
            parse_mode="HTML"
        )


# ===== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–ê–ë–û–¢–´ –° –í–ê–õ–Æ–¢–û–ô =====

def add_user_coins(user_id: str, amount: int):
    """–î–æ–±–∞–≤–∏—Ç—å –º–æ–Ω–µ—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é (–±–∞–ª–∞–Ω—Å)"""
    conn = get_db_connection()
    cursor = conn.cursor()

    try:
        cursor.execute("""
            UPDATE users 
            SET balance = balance + ? 
            WHERE user_id = ?
        """, (amount, user_id))
        conn.commit()
        print(f"[DEBUG] Added {amount} coins to user {user_id}")
        return True
    except Exception as e:
        print(f"[ERROR] Failed to add coins: {e}")
        conn.rollback()
        return False
    finally:
        conn.close()


def add_user_seeds(user_id: str, amount: int):
    """–î–æ–±–∞–≤–∏—Ç—å —Å–µ–º–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é"""
    conn = get_db_connection()
    cursor = conn.cursor()

    try:
        cursor.execute("""
            UPDATE users 
            SET seeds = seeds + ? 
            WHERE user_id = ?
        """, (amount, user_id))
        conn.commit()
        print(f"[DEBUG] Added {amount} seeds to user {user_id}")
        return True
    except Exception as e:
        print(f"[ERROR] Failed to add seeds: {e}")
        conn.rollback()
        return False
    finally:
        conn.close()


def get_user_balance(user_id: str) -> dict:
    """–ü–æ–ª—É—á–∏—Ç—å –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    conn = get_db_connection()
    cursor = conn.cursor()

    try:
        cursor.execute("""
            SELECT balance, seeds 
            FROM users 
            WHERE user_id = ?
        """, (user_id,))
        result = cursor.fetchone()

        if result:
            return {
                'balance': result[0],
                'seeds': result[1]
            }
        return {'balance': 0, 'seeds': 0}
    finally:
        conn.close()


# ===== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ò BLOCK BLAST =====

def save_game_stats(user_id: str, game_data: dict, rewards: dict):
    """–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏–≥—Ä—ã –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö"""
    conn = get_db_connection()
    cursor = conn.cursor()

    try:
        cursor.execute("""
            INSERT INTO block_blast_stats 
            (user_id, score, lines, combo, pieces, coins_earned, seeds_earned, played_at)
            VALUES (?, ?, ?, ?, ?, ?, ?, ?)
        """, (
            user_id,
            game_data['score'],
            game_data['lines'],
            game_data['combo'],
            game_data['pieces'],
            rewards['coins'],
            rewards['seeds'],
            game_data['timestamp']
        ))
        conn.commit()
        print(f"[DEBUG] Game stats saved for user {user_id}")
        return True
    except Exception as e:
        print(f"[ERROR] Failed to save game stats: {e}")
        conn.rollback()
        return False
    finally:
        conn.close()


def get_user_best_score(user_id: str) -> int:
    """–ü–æ–ª—É—á–∏—Ç—å –ª—É—á—à–∏–π —Å—á—ë—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    conn = get_db_connection()
    cursor = conn.cursor()

    try:
        cursor.execute("""
            SELECT MAX(score) 
            FROM block_blast_stats 
            WHERE user_id = ?
        """, (user_id,))
        result = cursor.fetchone()
        return result[0] if result and result[0] else 0
    finally:
        conn.close()


def get_user_total_games(user_id: str) -> int:
    """–ü–æ–ª—É—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    conn = get_db_connection()
    cursor = conn.cursor()

    try:
        cursor.execute("""
            SELECT COUNT(*) 
            FROM block_blast_stats 
            WHERE user_id = ?
        """, (user_id,))
        result = cursor.fetchone()
        return result[0] if result else 0
    finally:
        conn.close()


def get_user_stats(user_id: str) -> dict:
    """–ü–æ–ª—É—á–∏—Ç—å –æ–±—â—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    conn = get_db_connection()
    cursor = conn.cursor()

    try:
        cursor.execute("""
            SELECT 
                COUNT(*) as total_games,
                MAX(score) as best_score,
                SUM(lines) as total_lines,
                MAX(combo) as best_combo,
                SUM(coins_earned) as total_coins,
                SUM(seeds_earned) as total_seeds
            FROM block_blast_stats 
            WHERE user_id = ?
        """, (user_id,))
        result = cursor.fetchone()

        if result and result[0] > 0:
            return {
                'total_games': result[0],
                'best_score': result[1],
                'total_lines': result[2],
                'best_combo': result[3],
                'total_coins': result[4],
                'total_seeds': result[5]
            }
        return {
            'total_games': 0,
            'best_score': 0,
            'total_lines': 0,
            'best_combo': 0,
            'total_coins': 0,
            'total_seeds': 0
        }
    finally:
        conn.close()


def get_top_players(limit: int = 10) -> list:
    """–ü–æ–ª—É—á–∏—Ç—å —Ç–æ–ø –∏–≥—Ä–æ–∫–æ–≤ –ø–æ –ª—É—á—à–µ–º—É —Å—á—ë—Ç—É"""
    conn = get_db_connection()
    cursor = conn.cursor()

    try:
        cursor.execute("""
            SELECT 
                b.user_id,
                u.username,
                u.first_name,
                MAX(b.score) as best_score
            FROM block_blast_stats b
            LEFT JOIN users u ON b.user_id = u.user_id
            GROUP BY b.user_id
            ORDER BY best_score DESC
            LIMIT ?
        """, (limit,))
        return cursor.fetchall()
    finally:
        conn.close()

async def handle_block_blast_simple(update: Update, context: ContextTypes.DEFAULT_TYPE, data_str: str):
    """
    –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏–≥—Ä—ã Block Blast –ë–ï–ó —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è
    –§–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö: score_lines_combo_pieces
    –ù–∞–ø—Ä–∏–º–µ—Ä: 150_5_2_12
    """
    user = update.effective_user
    message = update.message
    user_id = str(user.id)

    print(f"[DEBUG] ===== BLOCK BLAST HANDLER (SIMPLE) =====")
    print(f"[DEBUG] User ID: {user_id}")
    print(f"[DEBUG] Data string: {data_str}")

    try:
        parts = data_str.split('_')

        if len(parts) != 4:
            raise ValueError(f"Invalid data format, expected 4 parts, got {len(parts)}")

        game_data = {
            'score': int(parts[0]),
            'lines': int(parts[1]),
            'combo': int(parts[2]),
            'pieces': int(parts[3]),
            'timestamp': int(time.time() * 1000)
        }

        print(f"[DEBUG] Game data parsed: {game_data}")

        if game_data['score'] < 0 or game_data['score'] > 100000:
            raise ValueError(f"Invalid score: {game_data['score']}")
        if game_data['lines'] < 0 or game_data['lines'] > 1000:
            raise ValueError(f"Invalid lines: {game_data['lines']}")
        if game_data['combo'] < 0 or game_data['combo'] > 100:
            raise ValueError(f"Invalid combo: {game_data['combo']}")
        if game_data['pieces'] < 0 or game_data['pieces'] > 1000:
            raise ValueError(f"Invalid pieces: {game_data['pieces']}")

    except Exception as e:
        print(f"[ERROR] Failed to parse game data: {e}")
        await message.reply_text(
            "‚ùå <b>–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤!</b>\n\n"
            "–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–≥—Ä—ã.\n\n"
            "üí° <b>–†–µ—à–µ–Ω–∏–µ:</b> –°—ã–≥—Ä–∞–π—Ç–µ –µ—â—ë —Ä–∞–∑!",
            parse_mode="HTML"
        )
        return

    rewards = calculate_block_blast_reward(
        game_data['score'],
        game_data['lines'],
        game_data['combo']
    )
    print(f"[DEBUG] Rewards calculated: {rewards}")

    try:
        add_user_coins(user_id, rewards['coins'])
        add_user_seeds(user_id, rewards['seeds'])
        save_game_stats(user_id, game_data, rewards)

    except Exception as e:
        print(f"[ERROR] Failed to add rewards: {e}")
        await message.reply_text(
            "‚ö†Ô∏è <b>–û—à–∏–±–∫–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –Ω–∞–≥—Ä–∞–¥!</b>\n\n"
            "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.",
            parse_mode="HTML"
        )
        return

    balance = get_user_balance(user_id)
    user_stats = get_user_stats(user_id)
    best_score = user_stats.get('best_score', 0)
    total_games = user_stats.get('total_games', 0)

    is_new_record = game_data['score'] >= best_score and total_games > 1

    response_message = (
        f"üéÆ <b>FernieX Block's - –†–µ–∑—É–ª—å—Ç–∞—Ç—ã!</b>\n\n"
        f"üìä <b>–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è:</b>\n"
        f"‚Ä¢ –°—á—ë—Ç: <b>{game_data['score']:,}</b>\n"
        f"‚Ä¢ –õ–∏–Ω–∏–π: <b>{game_data['lines']}</b>\n"
        f"‚Ä¢ –ö–æ–º–±–æ: <b>x{game_data['combo']}</b>\n"
        f"‚Ä¢ –§–∏–≥—É—Ä: <b>{game_data['pieces']}</b>\n\n"
        f"üéÅ <b>–ù–∞–≥—Ä–∞–¥—ã:</b>\n"
        f"‚Ä¢ üí∞ –ú–æ–Ω–µ—Ç—ã: <b>+{rewards['coins']:,}</b>\n"
        f"‚Ä¢ üå± –°–µ–º–µ–Ω–∞: <b>+{rewards['seeds']}</b>\n\n"
    )

    if rewards['bonus'] != "–ë–µ–∑ –±–æ–Ω—É—Å–æ–≤":
        response_message += f"‚ú® <b>–ë–æ–Ω—É—Å—ã:</b>\n{rewards['bonus']}\n"

    response_message += (
        f"\nüíº <b>–ë–∞–ª–∞–Ω—Å:</b>\n"
        f"‚Ä¢ üí∞ –ú–æ–Ω–µ—Ç—ã: <b>{balance.get('balance', 0):,}</b>\n"
        f"‚Ä¢ üå± –°–µ–º–µ–Ω–∞: <b>{balance.get('seeds', 0):,}</b>\n"
    )

    if is_new_record:
        response_message += f"\nüéâ <b>–ù–û–í–´–ô –†–ï–ö–û–†–î!</b> üéâ\n"
    else:
        response_message += f"\nüèÜ –†–µ–∫–æ—Ä–¥: <b>{best_score:,}</b>\n"

    response_message += f"\n<i>–°–ø–∞—Å–∏–±–æ –∑–∞ –∏–≥—Ä—É! üéâ</i>"

    GAME_URL = "https://ferniex-game-bloks.vercel.app"

    keyboard = [
        [InlineKeyboardButton("üéÆ –ò–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞", url=f"{GAME_URL}")],
        [
            InlineKeyboardButton("üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", callback_data="block_blast_stats"),
            InlineKeyboardButton("üèÜ –¢–æ–ø", callback_data="block_blast_leaderboard")
        ]
    ]

    await message.reply_text(
        response_message,
        parse_mode="HTML",
        reply_markup=InlineKeyboardMarkup(keyboard)
    )

    print(f"[DEBUG] Block Blast reward sent successfully")
    print(f"[DEBUG] ===== END BLOCK BLAST HANDLER =====")


def calculate_block_blast_reward(score: int, lines: int, combo: int) -> dict:
    """–†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –Ω–∞–≥—Ä–∞–¥—É –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏–≥—Ä—ã"""
    coins = score * 25
    seeds = lines * 20

    bonus_text = ""

    if score >= 1000:
        bonus_coins = 100000
        coins += bonus_coins
        bonus_text += f"üèÜ –ë–æ–Ω—É—Å –∑–∞ 1000+ –æ—á–∫–æ–≤: +{bonus_coins} –º–æ–Ω–µ—Ç\n"

    if score >= 5000:
        bonus_coins = 500000
        coins += bonus_coins
        bonus_text += f"üíé –ë–æ–Ω—É—Å –∑–∞ 5000+ –æ—á–∫–æ–≤: +{bonus_coins} –º–æ–Ω–µ—Ç\n"

    if combo >= 3:
        bonus_seeds = combo * 10
        seeds += bonus_seeds
        bonus_text += f"üî• –ë–æ–Ω—É—Å –∑–∞ –∫–æ–º–±–æ x{combo}: +{bonus_seeds} —Å–µ–º—è–Ω\n"

    if lines >= 20:
        bonus_seeds = 2000
        seeds += bonus_seeds
        bonus_text += f"‚ö° –ë–æ–Ω—É—Å –∑–∞ {lines} –ª–∏–Ω–∏–π: +{bonus_seeds} —Å–µ–º—è–Ω\n"

    return {
        'coins': coins,
        'seeds': seeds,
        'bonus': bonus_text if bonus_text else "–ë–µ–∑ –±–æ–Ω—É—Å–æ–≤"
    }


# ===== CALLBACK –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò =====

async def show_block_blast_stats(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏–≥—Ä–æ–∫–∞"""
    query = update.callback_query
    await query.answer()

    user_id = str(query.from_user.id)
    stats = get_user_stats(user_id)

    if stats['total_games'] == 0:
        keyboard = [
            [InlineKeyboardButton("üéÆ –ò–≥—Ä–∞—Ç—å", url="https://ferniex-minigame.vercel.app/")],
            [InlineKeyboardButton("üèÜ –¢–æ–ø –∏–≥—Ä–æ–∫–æ–≤", callback_data="block_blast_leaderboard")]
        ]

        await query.message.edit_text(
            "üìä <b>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ FernieX Blast's</b>\n\n"
            "–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∏–≥—Ä!\n"
            "–°—ã–≥—Ä–∞–π—Ç–µ –ø–µ—Ä–≤—É—é –ø–∞—Ä—Ç–∏—é! üéÆ",
            parse_mode="HTML",
            reply_markup=InlineKeyboardMarkup(keyboard)
        )
        return

    text = (
        f"üìä <b>–í–∞—à–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ FernieX Block's</b>\n\n"
        f"üéÆ <b>–í—Å–µ–≥–æ –∏–≥—Ä:</b> {stats['total_games']}\n"
        f"üèÜ <b>–õ—É—á—à–∏–π —Å—á—ë—Ç:</b> {stats['best_score']:,}\n"
        f"üéØ <b>–í—Å–µ–≥–æ –ª–∏–Ω–∏–π:</b> {stats['total_lines']}\n"
        f"üî• <b>–õ—É—á—à–µ–µ –∫–æ–º–±–æ:</b> x{stats['best_combo']}\n\n"
        f"üí∞ <b>–ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ –º–æ–Ω–µ—Ç:</b> {stats['total_coins']:,}\n"
        f"üå± <b>–ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ —Å–µ–º—è–Ω:</b> {stats['total_seeds']}"
    )

    keyboard = [
        [InlineKeyboardButton("üéÆ –ò–≥—Ä–∞—Ç—å", url="https://ferniex-minigame.vercel.app/")],
        [InlineKeyboardButton("üèÜ –¢–æ–ø –∏–≥—Ä–æ–∫–æ–≤", callback_data="block_blast_leaderboard")]
    ]

    await query.message.edit_text(
        text,
        parse_mode="HTML",
        reply_markup=InlineKeyboardMarkup(keyboard)
    )


async def show_block_blast_leaderboard(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ü–æ–∫–∞–∑–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É –ª–∏–¥–µ—Ä–æ–≤"""
    query = update.callback_query
    await query.answer()

    top_players = get_top_players(10)

    if not top_players:
        keyboard = [
            [InlineKeyboardButton("üéÆ –ò–≥—Ä–∞—Ç—å", url="https://ferniex-minigame.vercel.app/")],
            [InlineKeyboardButton("üìä –ú–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", callback_data="block_blast_stats")]
        ]

        await query.message.edit_text(
            "üèÜ <b>–¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤</b>\n\n"
            "–ü–æ–∫–∞ –Ω–µ—Ç –∏–≥—Ä–æ–∫–æ–≤!\n"
            "–°—Ç–∞–Ω—å—Ç–µ –ø–µ—Ä–≤—ã–º! üéÆ",
            parse_mode="HTML",
            reply_markup=InlineKeyboardMarkup(keyboard)
        )
        return

    text = "üèÜ <b>–¢–û–ü-10 –ò–ì–†–û–ö–û–í</b>\n\n"
    medals = ["ü•á", "ü•à", "ü•â"]

    for i, player in enumerate(top_players, 1):
        user_id, username, first_name, best_score = player

        prefix = medals[i - 1] if i <= 3 else f"{i}."

        if username:
            player_name = f"@{username}"
        elif first_name:
            player_name = first_name
        else:
            player_name = f"ID: {user_id}"

        text += f"{prefix} <b>{player_name}</b>\n   –°—á—ë—Ç: {best_score:,}\n\n"

    keyboard = [
        [InlineKeyboardButton("üéÆ –ò–≥—Ä–∞—Ç—å", url="https://ferniex-minigame.vercel.app/")],
        [InlineKeyboardButton("üìä –ú–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", callback_data="block_blast_stats")]
    ]

    await query.message.edit_text(
        text,
        parse_mode="HTML",
        reply_markup=InlineKeyboardMarkup(keyboard)
    )

def init_block_blast_tables(db_path: str):
    conn = sqlite3.connect(db_path)
    cursor = conn.cursor()

    # ===== –¢–ê–ë–õ–ò–¶–ê BLOCK BLAST =====
    cursor.execute("""
        CREATE TABLE IF NOT EXISTS block_blast_stats (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id TEXT NOT NULL,
            score INTEGER NOT NULL,
            lines INTEGER NOT NULL,
            combo INTEGER NOT NULL,
            pieces INTEGER NOT NULL,
            coins_earned INTEGER NOT NULL,
            seeds_earned INTEGER NOT NULL,
            played_at INTEGER NOT NULL,
            FOREIGN KEY (user_id) REFERENCES users(user_id)
        )
    """)

    # –ò–Ω–¥–µ–∫—Å –ø–æ user_id
    cursor.execute("""
        CREATE INDEX IF NOT EXISTS idx_block_blast_user 
        ON block_blast_stats(user_id)
    """)

    # –ò–Ω–¥–µ–∫—Å –ø–æ score (–¥–ª—è –ª–∏–¥–µ—Ä–±–æ—Ä–¥–∞)
    cursor.execute("""
        CREATE INDEX IF NOT EXISTS idx_block_blast_score 
        ON block_blast_stats(score DESC)
    """)

    # –ò–Ω–¥–µ–∫—Å –ø–æ –≤—Ä–µ–º–µ–Ω–∏
    cursor.execute("""
        CREATE INDEX IF NOT EXISTS idx_block_blast_time 
        ON block_blast_stats(played_at DESC)
    """)

    conn.commit()
    conn.close()



# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –¢–ê–ë–õ–ò–¶
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
def init_code_quest_tables(db_path: str):
    """–°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è CodeQuest"""
    conn = sqlite3.connect(db_path)
    cursor = conn.cursor()
    cursor.execute("""
        CREATE TABLE IF NOT EXISTS code_quest_stats (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id TEXT NOT NULL,
            lang TEXT NOT NULL,
            score INTEGER NOT NULL,
            perfect INTEGER NOT NULL,
            errors INTEGER NOT NULL,
            coins_earned INTEGER NOT NULL,
            seeds_earned INTEGER NOT NULL,
            played_at INTEGER NOT NULL,
            FOREIGN KEY (user_id) REFERENCES users(user_id)
        )
    """)
    cursor.execute("CREATE INDEX IF NOT EXISTS idx_cq_user ON code_quest_stats(user_id)")
    cursor.execute("CREATE INDEX IF NOT EXISTS idx_cq_score ON code_quest_stats(score DESC)")
    cursor.execute("CREATE INDEX IF NOT EXISTS idx_cq_time ON code_quest_stats(played_at DESC)")
    conn.commit()
    conn.close()
    print("[DEBUG] CodeQuest tables initialized")


# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# –†–ê–ë–û–¢–ê –° –ë–î
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
def cq_save_game(user_id: str, lang: str, score: int, perfect: int, errors: int, rewards: dict) -> bool:
    """–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏–≥—Ä—ã"""
    conn = get_db_connection()
    cursor = conn.cursor()
    try:
        cursor.execute("""
            INSERT INTO code_quest_stats
            (user_id, lang, score, perfect, errors, coins_earned, seeds_earned, played_at)
            VALUES (?, ?, ?, ?, ?, ?, ?, ?)
        """, (
            user_id, lang, score, perfect, errors,
            rewards['coins'], rewards['seeds'],
            int(time.time() * 1000)
        ))
        conn.commit()
        print(f"[DEBUG] CodeQuest game saved for user {user_id}")
        return True
    except Exception as e:
        print(f"[ERROR] cq_save_game: {e}")
        conn.rollback()
        return False
    finally:
        conn.close()

def cq_get_user_stats(user_id: str, lang: str = None) -> dict:
    """–ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Äî –ª—É—á—à–∏–π —Å—á—ë—Ç –∑–∞ –∏–≥—Ä—É"""
    conn = get_db_connection()
    cursor = conn.cursor()
    try:
        if lang:
            cursor.execute("""
                SELECT
                    COUNT(*) as total_games,
                    MAX(score) as best_score,
                    SUM(score) as total_score,
                    SUM(perfect) as total_perfect,
                    MIN(errors) as best_errors,
                    SUM(coins_earned) as total_coins,
                    SUM(seeds_earned) as total_seeds
                FROM code_quest_stats
                WHERE user_id = ? AND lang = ?
            """, (user_id, lang))
        else:
            cursor.execute("""
                SELECT
                    COUNT(*) as total_games,
                    MAX(score) as best_score,
                    SUM(score) as total_score,
                    SUM(perfect) as total_perfect,
                    MIN(errors) as best_errors,
                    SUM(coins_earned) as total_coins,
                    SUM(seeds_earned) as total_seeds
                FROM code_quest_stats
                WHERE user_id = ?
            """, (user_id,))
        result = cursor.fetchone()
        if result and result[0] > 0:
            return {
                'total_games': result[0],
                'best_score': result[1],   # MAX ‚Äî –ª—É—á—à–∞—è –æ–¥–Ω–∞ –∏–≥—Ä–∞ (–¥–ª—è –ª–∏—á–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏)
                'total_score': result[2],  # SUM ‚Äî —Å—É–º–º–∞ –≤—Å–µ—Ö –∏–≥—Ä (–¥–ª—è —Ç–æ–ø–∞)
                'total_perfect': result[3],
                'best_errors': result[4],
                'total_coins': result[5],
                'total_seeds': result[6]
            }
        return {
            'total_games': 0, 'best_score': 0, 'total_score': 0,
            'total_perfect': 0, 'best_errors': 0, 'total_coins': 0, 'total_seeds': 0
        }
    finally:
        conn.close()

def cq_get_top_players(lang: str = None, limit: int = 10) -> list:
    """–¢–æ–ø –∏–≥—Ä–æ–∫–æ–≤ –ø–æ —Å—É–º–º–∞—Ä–Ω–æ–º—É —Å—á—ë—Ç—É –≤—Å–µ—Ö –∏–≥—Ä"""
    conn = get_db_connection()
    cursor = conn.cursor()
    try:
        if lang:
            cursor.execute("""
                SELECT c.user_id, u.username, u.first_name, SUM(c.score) as total_score, c.lang
                FROM code_quest_stats c
                LEFT JOIN users u ON c.user_id = u.user_id
                WHERE c.lang = ?
                GROUP BY c.user_id
                ORDER BY total_score DESC
                LIMIT ?
            """, (lang, limit))
        else:
            cursor.execute("""
                SELECT c.user_id, u.username, u.first_name, SUM(c.score) as total_score, c.lang
                FROM code_quest_stats c
                LEFT JOIN users u ON c.user_id = u.user_id
                GROUP BY c.user_id
                ORDER BY total_score DESC
                LIMIT ?
            """, (limit,))
        return cursor.fetchall()
    finally:
        conn.close()

def cq_is_new_record(user_id: str, lang: str, score: int) -> bool:
    """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å—á—ë—Ç –Ω–æ–≤—ã–º —Ä–µ–∫–æ—Ä–¥–æ–º –∑–∞ –æ–¥–Ω—É –∏–≥—Ä—É"""
    conn = get_db_connection()
    cursor = conn.cursor()
    try:
        cursor.execute("""
            SELECT COUNT(*), MAX(score)
            FROM code_quest_stats
            WHERE user_id = ? AND lang = ?
        """, (user_id, lang))
        result = cursor.fetchone()
        if not result or result[0] <= 1:
            return False
        return score >= result[1]
    finally:
        conn.close()

def cq_add_dc(user_id: str, amount: int) -> int:
    """–ù–∞—á–∏—Å–ª–∏—Ç—å DC –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, –≤–µ—Ä–Ω—É—Ç—å –Ω–æ–≤—ã–π –±–∞–ª–∞–Ω—Å"""
    conn = sqlite3.connect(DB_PATH, timeout=30.0)
    conn.execute("PRAGMA journal_mode=WAL")
    conn.execute("PRAGMA busy_timeout=10000")
    cursor = conn.cursor()
    try:
        cursor.execute(
            "UPDATE users SET dc_balance = dc_balance + ? WHERE user_id = ?",
            (amount, user_id)
        )
        rows = cursor.rowcount
        conn.commit()
        if rows == 0:
            print(f"[ERROR] cq_add_dc: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –Ω–µ –Ω–∞–π–¥–µ–Ω!")
            return 0
        cursor.execute("SELECT dc_balance FROM users WHERE user_id = ?", (user_id,))
        row = cursor.fetchone()
        new_balance = row[0] if row else 0
        print(f"[DEBUG] DC –Ω–∞—á–∏—Å–ª–µ–Ω–æ: +{amount} –¥–ª—è {user_id}, –Ω–æ–≤—ã–π –±–∞–ª–∞–Ω—Å: {new_balance}")
        return new_balance
    except Exception as e:
        print(f"[ERROR] cq_add_dc: {e}")
        conn.rollback()
        return 0
    finally:
        conn.close()


# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# –†–ê–°–ß–Å–¢ –ù–ê–ì–†–ê–î
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
def calculate_code_quest_reward(score: int, perfect: int, errors: int) -> dict:
    """–†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –Ω–∞–≥—Ä–∞–¥—ã –∑–∞ CodeQuest"""
    coins = score * 100
    seeds = perfect * 50
    dc = 0
    bonus_text = ""

    if score >= 120:
        bonus = 50000
        coins += bonus
        dc += 500
        bonus_text += f"üèÜ –†–∞–Ω–≥ S: +{bonus:,} –º–æ–Ω–µ—Ç\n"
    elif score >= 90:
        bonus = 20000
        coins += bonus
        dc += 250
        bonus_text += f"ü•á –†–∞–Ω–≥ A: +{bonus:,} –º–æ–Ω–µ—Ç\n"
    elif score >= 60:
        bonus = 5000
        coins += bonus
        dc += 100
        bonus_text += f"ü•à –†–∞–Ω–≥ B: +{bonus:,} –º–æ–Ω–µ—Ç\n"
    else:
        dc += 50

    if perfect == 10:
        bonus_seeds = 500
        seeds += bonus_seeds
        dc += 1000
        bonus_text += f"‚≠ê –í—Å–µ —É—Ä–æ–≤–Ω–∏ –∏–¥–µ–∞–ª—å–Ω–æ: +{bonus_seeds} —Å–µ–º—è–Ω\n"
    elif perfect >= 8:
        dc += 400

    if errors == 0:
        bonus_seeds = 200
        seeds += bonus_seeds
        dc += 300
        bonus_text += f"‚ú® –ë–µ–∑ –æ—à–∏–±–æ–∫: +{bonus_seeds} —Å–µ–º—è–Ω\n"

    return {
        'coins': coins,
        'seeds': seeds,
        'dc': dc,
        'bonus': bonus_text.strip()
    }


# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# –ö–û–ù–°–¢–ê–ù–¢–´
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
GAME_URL = "https://ferniex-minigame.vercel.app/"

LANG_DISPLAY = {
    'python': 'üêç Python',
    'csharp': 'üíú C#'
}

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# –•–ï–ù–î–õ–ï–†
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async def handle_code_quest(update: Update, context: ContextTypes.DEFAULT_TYPE, data_str: str):
    user = update.effective_user
    message = update.message
    user_id = str(user.id)

    print(f"[DEBUG] ===== CODEQUEST HANDLER =====")
    print(f"[DEBUG] User: {user_id} | Data: {data_str}")

    # --- –ü–∞—Ä—Å–∏–Ω–≥ ---
    try:
        parts = data_str.split('_')
        if len(parts) < 2:
            raise ValueError(f"Too few parts: {len(parts)}")

        lang    = parts[0]
        score   = int(parts[1])
        perfect = int(parts[2]) if len(parts) > 2 else 0
        errors  = int(parts[3]) if len(parts) > 3 else 0

        if lang not in ('python', 'csharp'):
            raise ValueError(f"Unknown lang: {lang}")
        if score < 0:                          # ‚Üê —É–±—Ä–∞–ª–∏ –≤–µ—Ä—Ö–Ω–∏–π –ª–∏–º–∏—Ç, —Ç–æ–ª—å–∫–æ –Ω–∏–∂–Ω–∏–π
            raise ValueError(f"Invalid score: {score}")
        if not (0 <= perfect <= 10):
            raise ValueError(f"Invalid perfect: {perfect}")
        if not (0 <= errors <= 100):
            raise ValueError(f"Invalid errors: {errors}")

    except Exception as e:
        print(f"[ERROR] Parse failed: {e}")
        await message.reply_text(
            "‚ùå <b>–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤!</b>\n\n–°—ã–≥—Ä–∞–π—Ç–µ –µ—â—ë —Ä–∞–∑!",
            parse_mode="HTML"
        )
        return

    # --- –ó–∞—â–∏—Ç–∞ –æ—Ç –Ω–∞–∫—Ä—É—Ç–∫–∏ ---
    if score > 200:
        print(f"[WARN] Anti-cheat: user {user_id} score={score}")
        await message.reply_text(
            "‚ö†Ô∏è <b>Anti-Cheating - CodeQuests</b>\n"
            "<blockquote>–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É.\n"
            "–°—á—ë—Ç –æ—á–∫–æ–≤ –ø—Ä–µ–≤—ã—à–∞–µ—Ç –¥–æ–ø—É—Å—Ç–∏–º—ã–π –ª–∏–º–∏—Ç –∑–∞ 1 –∏–≥—Ä—É</blockquote>",
            parse_mode="HTML"
        )
        return

    # --- –ù–∞–≥—Ä–∞–¥—ã ---
    rewards = calculate_code_quest_reward(score, perfect, errors)
    print(f"[DEBUG] Rewards: {rewards}")

    # --- –ù–∞—á–∏—Å–ª—è–µ–º ---
    try:
        add_user_coins(user_id, rewards['coins'])
        add_user_seeds(user_id, rewards['seeds'])

        new_dc_balance = cq_add_dc(user_id, rewards['dc']) if rewards['dc'] > 0 else None

        is_record = cq_is_new_record(user_id, lang, score)
        cq_save_game(user_id, lang, score, perfect, errors, rewards)

    except Exception as e:
        print(f"[ERROR] Reward failed: {e}")
        await message.reply_text("‚ö†Ô∏è <b>–û—à–∏–±–∫–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –Ω–∞–≥—Ä–∞–¥!</b>", parse_mode="HTML")
        return

    # --- –î–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è ---
    balance      = get_user_balance(user_id)
    stats        = cq_get_user_stats(user_id, lang)
    lang_display = LANG_DISPLAY.get(lang, lang)

    # DC –±–∞–ª–∞–Ω—Å
    if new_dc_balance is not None:
        dc_balance = new_dc_balance
    else:
        try:
            conn = sqlite3.connect(DB_PATH, timeout=30.0)
            cursor = conn.cursor()
            cursor.execute("SELECT dc_balance FROM users WHERE user_id = ?", (user_id,))
            row = cursor.fetchone()
            conn.close()
            dc_balance = row[0] if row else 0
        except Exception as e:
            print(f"[ERROR] –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å dc_balance: {e}")
            dc_balance = 0

    # --- –†–∞–Ω–≥ ---
    if score >= 120:
        rank = "üèÜ –†–∞–Ω–≥ S ‚Äî –ú–∞—Å—Ç–µ—Ä –∫–æ–¥–∞!"
    elif score >= 90:
        rank = "ü•á –†–∞–Ω–≥ A ‚Äî –û—Ç–ª–∏—á–Ω–æ!"
    elif score >= 60:
        rank = "ü•à –†–∞–Ω–≥ B ‚Äî –•–æ—Ä–æ—à–∞—è —Ä–∞–±–æ—Ç–∞!"
    else:
        rank = "üéñ –†–∞–Ω–≥ C ‚Äî –ü—Ä–æ–¥–æ–ª–∂–∞–π –ø—Ä–∞–∫—Ç–∏–∫–æ–≤–∞—Ç—å—Å—è!"

    # --- –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ ---
    response = (
        f"üéÆ <b>CodeQuest ‚Äî –†–µ–∑—É–ª—å—Ç–∞—Ç—ã!</b>\n\n"
        f"üìö –Ø–∑—ã–∫: <b>{lang_display}</b>\n\n"
        f"üìä <b>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–∞—É–Ω–¥–∞:</b>\n"
        f"‚Ä¢ –û—á–∫–∏: <b>{score}</b>\n"
        f"‚Ä¢ –ò–¥–µ–∞–ª—å–Ω—ã—Ö —É—Ä–æ–≤–Ω–µ–π: <b>{perfect}/10</b>\n"
        f"‚Ä¢ –û—à–∏–±–æ–∫: <b>{errors}</b>\n\n"
        f"{rank}\n\n"
        f"üéÅ <b>–ù–∞–≥—Ä–∞–¥—ã:</b>\n"
        f"‚Ä¢ üí∞ –ú–æ–Ω–µ—Ç—ã: <b>+{rewards['coins']:,}</b>\n"
        f"‚Ä¢ üå± –°–µ–º–µ–Ω–∞: <b>+{rewards['seeds']}</b>\n"
        f"‚Ä¢ üíé DC: <b>+{rewards['dc']}</b>\n"
    )

    if rewards['bonus']:
        response += f"\n‚ú® <b>–ë–æ–Ω—É—Å—ã:</b>\n{rewards['bonus']}\n"

    response += (
        f"\nüíº <b>–ë–∞–ª–∞–Ω—Å:</b>\n"
        f"‚Ä¢ üí∞ {balance.get('balance', 0):,} –º–æ–Ω–µ—Ç\n"
        f"‚Ä¢ üå± {balance.get('seeds', 0):,} —Å–µ–º—è–Ω\n"
        f"‚Ä¢ üíé {dc_balance:,} DC\n"
    )

    if is_record:
        response += f"\nüéâ <b>–ù–û–í–´–ô –†–ï–ö–û–†–î –∑–∞ –∏–≥—Ä—É!</b> üéâ\n"
    else:
        response += f"\nüèÜ –†–µ–∫–æ—Ä–¥ –∑–∞ –∏–≥—Ä—É ({lang_display}): <b>{stats['best_score']}</b>\n"

    response += f"üìà –°—É–º–º–∞—Ä–Ω–æ –æ—á–∫–æ–≤: <b>{stats['total_score']:,}</b>\n"
    response += f"\n<i>–°–ø–∞—Å–∏–±–æ –∑–∞ –∏–≥—Ä—É! üéâ</i>"

    keyboard = [
        [InlineKeyboardButton("üéÆ –ò–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞", url=GAME_URL)],
        [
            InlineKeyboardButton("üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", callback_data="cq_stats_all"),
            InlineKeyboardButton("üèÜ –¢–æ–ø", callback_data="cq_top_all")
        ]
    ]

    await message.reply_text(response, parse_mode="HTML", reply_markup=InlineKeyboardMarkup(keyboard))
    print(f"[DEBUG] ===== END CODEQUEST HANDLER =====")
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# CALLBACK ‚Äî –°–¢–ê–¢–ò–°–¢–ò–ö–ê
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async def cq_show_stats(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    parts = query.data.split('_')  # ['cq', 'stats', 'all']
    lang_filter = parts[2] if parts[2] != 'all' else None
    user_id = str(query.from_user.id)

    stats = cq_get_user_stats(user_id, lang_filter)
    lang_label = LANG_DISPLAY.get(lang_filter, "–í—Å–µ —è–∑—ã–∫–∏") if lang_filter else "–í—Å–µ —è–∑—ã–∫–∏"

    if stats['total_games'] == 0:
        try:
            await query.message.edit_text(
                f"üìä <b>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ CodeQuest</b> ‚Äî {lang_label}\n\n"
                "–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∏–≥—Ä!\n–°—ã–≥—Ä–∞–π—Ç–µ –ø–µ—Ä–≤—É—é –ø–∞—Ä—Ç–∏—é! üéÆ",
                parse_mode="HTML"
            )
        except Exception:
            pass
        return

    text = (
        f"üìä <b>–í–∞—à–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ CodeQuest</b>\n"
        f"üìö –Ø–∑—ã–∫: <b>{lang_label}</b>\n\n"
        f"üéÆ –í—Å–µ–≥–æ –∏–≥—Ä: <b>{stats['total_games']}</b>\n"
        f"üèÜ –õ—É—á—à–∏–π —Å—á—ë—Ç –∑–∞ –∏–≥—Ä—É: <b>{stats['best_score']}</b>\n"
        f"üìà –°—É–º–º–∞—Ä–Ω–æ –æ—á–∫–æ–≤: <b>{stats['total_score']:,}</b>\n"
        f"‚≠ê –í—Å–µ–≥–æ –∏–¥–µ–∞–ª—å–Ω—ã—Ö —É—Ä–æ–≤–Ω–µ–π: <b>{stats['total_perfect']}</b>\n"
        f"‚úÖ –ú–∏–Ω–∏–º—É–º –æ—à–∏–±–æ–∫ –∑–∞ –∏–≥—Ä—É: <b>{stats['best_errors']}</b>\n\n"
        f"üí∞ –ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ –º–æ–Ω–µ—Ç: <b>{stats['total_coins']:,}</b>\n"
        f"üå± –ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ —Å–µ–º—è–Ω: <b>{stats['total_seeds']}</b>"
    )

    keyboard = [
        [
            InlineKeyboardButton("üêç Python", callback_data="cq_stats_python"),
            InlineKeyboardButton("üíú C#", callback_data="cq_stats_csharp"),
            InlineKeyboardButton("üåê –í—Å–µ", callback_data="cq_stats_all"),
        ],
        [InlineKeyboardButton("üèÜ –¢–æ–ø –∏–≥—Ä–æ–∫–æ–≤", callback_data="cq_top_all")],
        [InlineKeyboardButton("üéÆ –ò–≥—Ä–∞—Ç—å", url=GAME_URL)],
    ]

    try:
        await query.message.edit_text(text, parse_mode="HTML", reply_markup=InlineKeyboardMarkup(keyboard))
    except Exception:
        pass


# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# CALLBACK ‚Äî –¢–ê–ë–õ–ò–¶–ê –õ–ò–î–ï–†–û–í
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async def cq_show_leaderboard(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    parts = query.data.split('_')  # ['cq', 'top', 'all']
    lang_filter = parts[2] if parts[2] != 'all' else None

    top_players = cq_get_top_players(lang_filter, 10)
    lang_label = LANG_DISPLAY.get(lang_filter, "–í—Å–µ —è–∑—ã–∫–∏") if lang_filter else "–í—Å–µ —è–∑—ã–∫–∏"

    keyboard = [
        [
            InlineKeyboardButton("üêç Python", callback_data="cq_top_python"),
            InlineKeyboardButton("üíú C#", callback_data="cq_top_csharp"),
            InlineKeyboardButton("üåê –í—Å–µ", callback_data="cq_top_all"),
        ],
        [InlineKeyboardButton("üìä –ú–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", callback_data="cq_stats_all")],
        [InlineKeyboardButton("üéÆ –ò–≥—Ä–∞—Ç—å", url=GAME_URL)],
    ]

    if not top_players:
        await query.message.edit_text(
            f"üèÜ <b>–¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤ CodeQuest</b> ‚Äî {lang_label}\n\n"
            "–ü–æ–∫–∞ –Ω–µ—Ç –∏–≥—Ä–æ–∫–æ–≤!\n–°—Ç–∞–Ω—å—Ç–µ –ø–µ—Ä–≤—ã–º! üéÆ",
            parse_mode="HTML",
            reply_markup=InlineKeyboardMarkup(keyboard)
        )
        return

    text = f"üèÜ <b>–¢–û–ü-10 CodeQuest</b> ‚Äî {lang_label}\n"
    text += f"<i>–†–µ–π—Ç–∏–Ω–≥ –ø–æ —Å—É–º–º–∞—Ä–Ω—ã–º –æ—á–∫–∞–º</i>\n\n"
    medals = ["ü•á", "ü•à", "ü•â"]

    for i, player in enumerate(top_players, 1):
        uid, username, first_name, total_score, player_lang = player
        prefix = medals[i - 1] if i <= 3 else f"{i}."

        if username:
            name = f"@{username}"
        elif first_name:
            name = first_name
        else:
            name = f"ID: {uid}"

        lang_icon = ("üêç" if player_lang == "python" else "üíú") if lang_filter else ""
        text += f"{prefix} <b>{name}</b> {lang_icon}\n   –û—á–∫–æ–≤: <b>{total_score:,}</b>\n\n"

    await query.message.edit_text(text, parse_mode="HTML", reply_markup=InlineKeyboardMarkup(keyboard))

# =====================================
# Callback-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–æ–∫ warning
# =====================================

async def warn_callback(context: ContextTypes.DEFAULT_TYPE, query, action: str, target_id: int, chat_id: int):
    """–í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è ‚Äî —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ—Å–ª–µ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏."""

    admin = query.from_user

    # –ü–æ–ª—É—á–∞–µ–º —É–ø–æ–º–∏–Ω–∞–Ω–∏—è
    try:
        target_chat = await context.bot.get_chat(target_id)
        member_mention = get_display_name_html_new(target_chat)
    except Exception:
        member_mention = f"<code>{target_id}</code>"

    try:
        admins = await context.bot.get_chat_administrators(chat_id)
        owner = next((a.user for a in admins if a.status == "creator"), None)
        owner_mention = get_display_name_html_new(owner) if owner else "–í–ª–∞–¥–µ–ª–µ—Ü"
    except Exception:
        owner_mention = "–í–ª–∞–¥–µ–ª–µ—Ü"

    data = load_ratings()
    user_data = get_user_data(data, target_id, "")
    rating = user_data.get("rating", 0)

    action_labels = {
        "kick":    "üë¢ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–≥–Ω–∞–Ω",
        "permban": "‚õî –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –Ω–∞–≤—Å–µ–≥–¥–∞",
        "ignore":  "‚úÖ –†–µ—à–µ–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å",
    }
    decision_text = action_labels.get(action, action)

    new_text = (
        f"‚ö†Ô∏è<b>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Warning ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</b>‚ö†Ô∏è\n\n"
        f"üëë {owner_mention}\n"
        f"üë§ {member_mention}\n\n"
        f"–£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π —Ä–µ–π—Ç–∏–Ω–≥ (<b>{rating}</b>), –ø—Ä–∏–º–∏—Ç–µ –º–µ—Ä—ã.\n"
        f"{'‚îÄ' * 16}\n"
        f"üî∞ –†–µ—à–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞: <b>{decision_text}</b>"
    )

    await query.edit_message_text(new_text, parse_mode=ParseMode.HTML)

async def warn_button_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    try:
        action_raw, target_id_str, chat_id_str = query.data.split(":")
        action = action_raw.replace("warn_", "")   # kick / permban / ignore
        target_id = int(target_id_str)
        chat_id = int(chat_id_str)
    except Exception:
        await query.answer("‚ùå –û—à–∏–±–∫–∞ –¥–∞–Ω–Ω—ã—Ö.", show_alert=True)
        return

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –Ω–∞–∂–∞–≤—à–∏–π ‚Äî –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —á–∞—Ç–∞
    try:
        caller = await context.bot.get_chat_member(chat_id, query.from_user.id)
        if caller.status not in ("administrator", "creator"):
            await query.answer("‚ùå –¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –º–æ–≥—É—Ç –ø—Ä–∏–Ω–∏–º–∞—Ç—å —Ä–µ—à–µ–Ω–∏–µ.", show_alert=True)
            return
    except Exception:
        await query.answer("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∞.", show_alert=True)
        return

    if action == "kick":
        try:
            await context.bot.ban_chat_member(chat_id, target_id)
            await context.bot.unban_chat_member(chat_id, target_id)
        except Exception as e:
            await query.answer(f"‚ùå –û—à–∏–±–∫–∞ –∫–∏–∫–∞: {e}", show_alert=True)
            return
        # –†–µ–π—Ç–∏–Ω–≥ –∑–∞ –∫–∏–∫ –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è –ø–æ —É—Å–ª–æ–≤–∏—é

    elif action == "permban":
        try:
            await context.bot.ban_chat_member(chat_id, target_id, until_date=None, revoke_messages=True)
        except Exception as e:
            await query.answer(f"‚ùå –û—à–∏–±–∫–∞ –±–∞–Ω–∞: {e}", show_alert=True)
            return

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –±–∞–Ω –≤ –ë–î
        timestamp_start = int(time.time())
        try:
            save_ban_to_db(
                banned_user_id=target_id,
                banned_by_user_id=str(query.from_user.id),
                reason="–û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π —Ä–µ–π—Ç–∏–Ω–≥ (Warning)",
                duration=-1,
                timestamp_start=timestamp_start,
                timestamp_end=-1,
                chat_id=str(chat_id)
            )
        except Exception:
            pass

        # -7 —Ä–µ–π—Ç–∏–Ω–≥–∞ –∑–∞ –≤–µ—á–Ω—ã–π –±–∞–Ω
        change_user_rating(target_id, -7)

    # –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
    await warn_callback(context, query, action, target_id, chat_id)

def change_user_rating(user_id: int, delta: int):
    """–ò–∑–º–µ–Ω—è–µ—Ç —Ä–µ–π—Ç–∏–Ω–≥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ delta (–º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º)."""
    data = load_ratings()
    user_data = get_user_data(data, user_id, "")
    user_data["rating"] = user_data.get("rating", 0) + delta
    save_ratings(data)

async def setreit_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user

    # –¢–æ–ª—å–∫–æ —ç—Ç–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–æ–º–∞–Ω–¥—É
    if user.id != 7406372338:
        await update.message.reply_text("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥–µ.")
        return

    if len(context.args) < 2:
        await update.message.reply_text(
            "‚ùó –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /setreit {id} {—Ä–µ–π—Ç–∏–Ω–≥}\n"
            "–ü—Ä–∏–º–µ—Ä: /setreit 123456789 100"
        )
        return

    # –ü–∞—Ä—Å–∏–º –∞—Ä–≥—É–º–µ–Ω—Ç—ã
    try:
        target_id = int(context.args[0])
    except ValueError:
        await update.message.reply_text("‚ùå ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º.")
        return

    try:
        new_rating = int(context.args[1])
    except ValueError:
        await update.message.reply_text("‚ùå –†–µ–π—Ç–∏–Ω–≥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º.")
        return

    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–µ–π—Ç–∏–Ω–≥
    try:
        data = load_ratings()
        user_data = get_user_data(data, target_id, "")
        old_rating = user_data.get("rating", 0)
        user_data["rating"] = new_rating
        save_ratings(data)
    except Exception as e:
        await update.message.reply_text(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–µ–π—Ç–∏–Ω–≥–∞: {html.escape(str(e))}")
        return

    # –ü–æ–ª—É—á–∞–µ–º —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    try:
        target_chat = await context.bot.get_chat(target_id)
        target_mention = get_display_name_html_new(target_chat)
    except Exception:
        target_mention = f"<code>{target_id}</code>"

    await update.message.reply_text(
        f"‚úÖ <b>–†–µ–π—Ç–∏–Ω–≥ –∏–∑–º–µ–Ω—ë–Ω</b>\n\n"
        f"üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {target_mention}\n"
        f"üìä –°—Ç–∞—Ä—ã–π —Ä–µ–π—Ç–∏–Ω–≥: <b>{old_rating}</b>\n"
        f"üìä –ù–æ–≤—ã–π —Ä–µ–π—Ç–∏–Ω–≥: <b>{new_rating}</b>",
        parse_mode=ParseMode.HTML
    )

#=========================================================TEST HUB - –ü–û–¢–û–ú –£–î–ê–õ–ò–¢–¨ / –î–ï–ê–ö–¢–ï–í–ò–†–û–í–ê–¢–¨ =======================================================

# –í—Ä–µ–º–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –ö–î (–≤ –ø–∞–º—è—Ç–∏)
_test_cooldowns: dict = {}
TEST_COOLDOWN = 600  # 10 –º–∏–Ω—É—Ç –≤ —Å–µ–∫—É–Ω–¥–∞—Ö

async def test_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    user_id = str(user.id)
    now = time.time()

    # --- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ö–î ---
    if user_id in _test_cooldowns:
        elapsed = now - _test_cooldowns[user_id]
        if elapsed < TEST_COOLDOWN:
            remaining = TEST_COOLDOWN - elapsed
            mins = int(remaining // 60)
            secs = int(remaining % 60)
            await update.message.reply_text(
                f"‚è≥ <b>–ü–æ–¥–æ–∂–¥–∏ –Ω–µ–º–Ω–æ–≥–æ!</b>\n\n"
                f"<blockquote>–î–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ –Ω–∞–±–æ—Ä–∞: <b>{mins}–º {secs}—Å</b></blockquote>",
                parse_mode="HTML"
            )
            return

    # --- –ù–∞—á–∏—Å–ª—è–µ–º —Ä–µ—Å—É—Ä—Å—ã ---
    with sqlite3.connect(DB_PATH) as conn:
        cur = conn.cursor()
        cur.execute("""
            UPDATE users
            SET dc_balance = dc_balance + 150000,
                seeds = seeds + 1000000,
                balance = balance + 30000000
            WHERE user_id = ?
        """, (user_id,))
        conn.commit()

    # --- –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –≤—Ä–µ–º—è ---
    _test_cooldowns[user_id] = now

    await update.message.reply_text(
        f"üß™ <b>–ù–∞–±–æ—Ä —Ç–µ—Å—Ç–∏—Ä–æ–≤—â–∏–∫–∞ –ø–æ–ª—É—á–µ–Ω!</b>\n\n"
        f"<blockquote>"
        f"üí∞ DigitalCoins: <b>+150.000 DC</b>\n"
        f"üå± –°–µ–º–µ–Ω–∞: <b>+1.000.000</b>\n"
        f"üíµ –ë–∞–ª–∞–Ω—Å: <b>+30.000.000‚ÇΩ</b>"
        f"</blockquote>\n\n"
        f"<i>–°–ª–µ–¥—É—é—â–∏–π –Ω–∞–±–æ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω —á–µ—Ä–µ–∑ 10 –º–∏–Ω—É—Ç</i>",
        parse_mode="HTML"
    )

async def main():
    init_db()
    init_crypto_db()
    print("–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞...")

    app = (
        ApplicationBuilder()
        .token("8169035975:AAG5Tx7VC1o51lRkjfUF5fdPkhzDBFW2ZdA")
        .build()
    )

    schedule_jobs(app)
    asyncio.create_task(daily_tariff_payment())
    add_status_tariff_column()
    create_missing_tables()
    create_essential_tables()

    moscow_tz = pytz.timezone("Europe/Moscow")
    scheduler = AsyncIOScheduler(timezone=moscow_tz)

    scheduler.add_job(update_businesses, "cron", minute=0)
    scheduler.start()

    migrate_database()
    add_vip_columns()
    app.add_handler(callback_handler_weather)
    add_warns_column('FernieUI.db')
    add_broadcast_enabled_field()
    update_database()
    ensure_ai_selected_table()
    ensure_subfernieplus_table()
    init_casino_db()
    migrate_referals_table()
    migrate_fernieplus_custom_table()
    load_ask_data()
    add_robbery_cooldown_column()
    init_block_blast_tables("FernieUI.db")
    init_code_quest_tables(DB_PATH)

    app.add_handler(hire_conv_handler)
    app.add_handler(CommandHandler("start", start), group=-200)
    app.add_handler(MessageHandler(filters.ALL, update_username_middleware), group=-50)

    conv_handler = ConversationHandler(
        entry_points=[CommandHandler("dc", dcchange_command)],
        states={
            "CHOOSING": [CallbackQueryHandler(exchange_choice, pattern="^exchange_")],
            ASK_AMOUNT: [MessageHandler(filters.TEXT & ~filters.COMMAND, process_amount)],
        },
        fallbacks=[CommandHandler("cancel", cancel)],
        allow_reentry=True
    )

    app.add_handler(conv_handler)

    # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∫–æ–º–∞–Ω–¥
    command_handlers = [
        CommandHandler("delac", delete_userA_account),
        CommandHandler("dev", dev_command),
        CommandHandler("admins", admins_handler),
        CommandHandler("chatID", chat_id_command),
        CommandHandler("link", cmd_link),
        CommandHandler("report", report_command),
        CommandHandler("unreg", unreg),
        CommandHandler("ask", ask_command),
        CommandHandler("updatras", updatras_command),
        CommandHandler("permban", permban_command),
        CommandHandler("ahelp", ahelp_command),
        CommandHandler("setrole", setrole_command),
        CommandHandler("depus", depus),
        CommandHandler("dep", departament),
        CommandHandler("depinv", depinv),
        CommandHandler("depuninv", depuninv),
        CommandHandler("depwarn", depwarn),
        CommandHandler("depunwarn", depunwarn),
        CommandHandler("tempdep", tempdep),
        CommandHandler("depwarns", depwarns),
        CommandHandler("apan", apan),
        CommandHandler("answer", answer_command),
        CommandHandler("changecardnumber", changecardnumber),
        CommandHandler("connect", connect),
        CommandHandler("resetchat", resetchat),
        CommandHandler("set", set_setting),
        CommandHandler("arole", arole_command),
        CommandHandler("rhach", reset_hack_cd_handler),
        CommandHandler("ai", ai_command),
        CommandHandler("event", event_cust_command),
        CommandHandler("zero", zeroing_command),
        CommandHandler("startbattle", startbattle),
        CommandHandler("stopbattle", stopbattle),
        CommandHandler("clearbattle", clearbattle),
        CommandHandler("regname", regname),
        CommandHandler("nbattle", nbattle),
        CommandHandler("verclan", verclan),
        CommandHandler("tehwork", tehwork_command),
        CommandHandler("settehwork", settehwork_command),
        CommandHandler("dallac", del_accounts_command),
        CommandHandler("db", dbusers_command),
        CommandHandler("awarn", awarn),
        CommandHandler("aunwarn", aunwarn),
        CommandHandler("depset", depset),
        CommandHandler("dephelp", dephelp),
        CommandHandler("hod", hod),
        CommandHandler("kname", kname),
        CommandHandler("settings", settings),
        CommandHandler("gac", gac_command),
        CommandHandler("ugac", ugac_command),
        CommandHandler("sms", sms_command_phone),
        CommandHandler("rewarding", rewarding_command),
        CommandHandler("dshop", dchop_command),
        CommandHandler("postms", postms),
        CommandHandler("add", add_contact),
        CommandHandler("book", show_book),
        CommandHandler("dcontact", delete_contact),
        CommandHandler("post", post),
        CommandHandler("change", change_command),
        CommandHandler("time", time_command),
        CommandHandler("pref", make_admin),
        CommandHandler("setaccount", cmd_setaccount),
        CommandHandler("media", media_command),
        CommandHandler("setmedialink", setmedialink_command),
        CommandHandler("mcoins", mcoins_command),
        CommandHandler("rmute", rmute_command),
        CommandHandler("runmute", runmute_command),
        CommandHandler("rminfo", rminfo_command),
        CommandHandler("setreit", setreit_command),

    ]

    app.add_handler(
        MessageHandler(
            filters.TEXT & filters.Regex(r"(?i)^\d+$|^–æ—Ç–º–µ–Ω–∞$"),
            cooldown_reset_handler
        ), group=1
    )

    app.add_handler(
        CallbackQueryHandler(
            show_block_blast_stats,
            pattern="^block_blast_stats$"
        )
    )

    app.add_handler(
        CallbackQueryHandler(
            show_block_blast_leaderboard,
            pattern="^block_blast_leaderboard$"
        )
    )

    app.add_handler(CallbackQueryHandler(cq_show_stats, pattern="^cq_stats"))
    app.add_handler(CallbackQueryHandler(cq_show_leaderboard, pattern="^cq_top"))
    app.add_handler(CallbackQueryHandler(show_block_blast_stats,pattern="^block_blast_stats$"))
    app.add_handler(CallbackQueryHandler(show_block_blast_leaderboard,pattern="^block_blast_leaderboard$"))

    app.add_handler(CommandHandler("gift", gift_menu))

    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ —Ç–æ–≤–∞—Ä–∞

    app.add_handler(CallbackQueryHandler(gift_callback, pattern="^gift_buy_"))

    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–º–µ–Ω—ã
    app.add_handler(CallbackQueryHandler(gift_callback, pattern="^gift_cancel$"))

    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ–ø–ª–∞—Ç—ã
    app.add_handler(CallbackQueryHandler(gift_pay, pattern="^gift_pay$"))

    app.add_handler(CommandHandler("donate", donate_menu))
    app.add_handler(CallbackQueryHandler(donate_callback, pattern="^(buy_dc|buy_seeds|cancel_donate|admin_coins)$"))
    app.add_handler(CallbackQueryHandler(donate_pay, pattern="^pay$"))
    app.add_handler(PreCheckoutQueryHandler(precheckout_callback))
    app.add_handler(MessageHandler(filters.SUCCESSFUL_PAYMENT, successful_payment))

    app.add_handler(CommandHandler("appeal", appeal_command))
    app.add_handler(CallbackQueryHandler(appeal_select_callback, pattern="^appeal_select"))
    app.add_handler(CallbackQueryHandler(appeal_back_callback, pattern="^appeal_back$"))
    app.add_handler(CallbackQueryHandler(appeal_send_callback, pattern="^appeal_send"))
    app.add_handler(CallbackQueryHandler(appeal_decision_callback, pattern="^appeal_(accept|reject)"))

    app.add_handler(CommandHandler("trigger", trigger_status))
    app.add_handler(CommandHandler("strigger", switch_trigger))

    app.add_handler(CallbackQueryHandler(open_fstyle_callback, pattern=r"^open_fstyle:"))

    # –∏–≤–µ–Ω—Ç
    app.add_handler(CommandHandler("event_stats", event_stats_command))
    app.add_handler(
        CallbackQueryHandler(event_snow_handle_callback, pattern="^(boss_santa|attack_boss|daily_bonus|event_back)$"))
    app.add_handler(CommandHandler("reset_boss", admin_reset_command))
    app.add_handler(CommandHandler("event_hp", event_hp_command))

    app.add_handler(CallbackQueryHandler(get_code_callback, pattern="^get_code$"))
    app.add_handler(CallbackQueryHandler(word_quest_button_handler, pattern="word_quest_collect"))
    app.add_handler(CallbackQueryHandler(word_quest_cancel_handler, pattern="word_quest_cancel"))
    app.add_handler(CallbackQueryHandler(chat_buttons, pattern="^chat_menu_"))

    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, word_quest_message_handler))
    app.add_handler(CallbackQueryHandler(set_fernie_style_callback, pattern=r"^set_fernie_style:"))
    app.add_handler(CallbackQueryHandler(subvip_callback, pattern="^sub:"))

    app.add_handler(CallbackQueryHandler(coin_callback, pattern=r"^coin_"))

    app.add_handler(CallbackQueryHandler(dchop_callback, pattern="^dchop_"))
    app.add_handler(CallbackQueryHandler(reward_callback, pattern="^reward_"))

    app.add_handler(CommandHandler("store", store_command))
    app.add_handler(CallbackQueryHandler(callback_handler_market_store, pattern="^(inv_|item_|store_|store_buy_).*"))

    app.add_handler(CallbackQueryHandler(promo_create_callback, pattern="^promo_create_"))
    app.add_handler(CallbackQueryHandler(promo_level_callback, pattern="^promo_level_"))
    app.add_handler(CallbackQueryHandler(mpromo_back_callback, pattern="^mpromo_back_"))

    app.add_handler(CallbackQueryHandler(decode_callback, pattern=r"^decode_\d+$"))

    app.add_handler(CallbackQueryHandler(start_topup, pattern=r"^phone_topup:\d+$"))
    app.add_handler(CallbackQueryHandler(phone_topup_cancel, pattern=r"^phone_topup_cancel:\d+$"))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, topup_amount_handler), group=-2)

    app.add_handler(exchange_conv_handler)
    app.add_handler(CallbackQueryHandler(phone_about, pattern=r"^phone_about:\d+$"))
    app.add_handler(CallbackQueryHandler(phone_back, pattern=r"^phone_back:\d+$"))
    app.add_handler(CallbackQueryHandler(phone_callback_handler, pattern=r"^phone_bank:\d+$"))
    app.add_handler(CallbackQueryHandler(phone_callback_handler, pattern=r"^phone_market:\d+$"))
    app.add_handler(CallbackQueryHandler(phone_callback_handler, pattern=r"^phone_menu$"))
    app.add_handler(CallbackQueryHandler(phone_calculator_menu, pattern=r"^phone_calculator:\d+$"))
    app.add_handler(CallbackQueryHandler(phone_messages_handler, pattern=r"^phone_messages:"))
    app.add_handler(CallbackQueryHandler(calculator_input_button, pattern=r"^calc_input:\d+$"))
    app.add_handler(CallbackQueryHandler(calculator_cancel, pattern=r"^calc_cancel:\d+$"))
    app.add_handler(CallbackQueryHandler(phone_operator, pattern=r"^phone_operator:\d+$"))
    app.add_handler(CallbackQueryHandler(phone_my_tariff, pattern=r"^phone_my_tariff:\d+$"))
    app.add_handler(CallbackQueryHandler(phone_change_tariff_prompt, pattern=r"^phone_change_tariff_prompt:\d+$"))
    app.add_handler(
        CallbackQueryHandler(phone_change_tariff_operator, pattern=r"^phone_change_tariff_operator:\d+:.+$"))
    app.add_handler(CallbackQueryHandler(phone_change_tariff_select, pattern=r"^phone_change_tariff_select:\d+:.+:.+$"))
    app.add_handler(CallbackQueryHandler(phone_choose_operator, pattern=r"^phone_confirm_number:\d+$"))
    app.add_handler(CallbackQueryHandler(phone_choose_operator, pattern=r"^phone_choose_operator:\d+$"))
    app.add_handler(CallbackQueryHandler(phone_choose_tariff, pattern=r"^phone_choose_tariff:\d+:.+$"))
    app.add_handler(CallbackQueryHandler(phone_confirm_tariff, pattern=r"^phone_confirm_tariff:\d+:.+:.+$"))
    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ SIM-–∫–∞—Ä—Ç—ã
    app.add_handler(CallbackQueryHandler(phone_block_prompt, pattern=r"^phone_block:\d+$"))
    app.add_handler(CallbackQueryHandler(phone_block_confirm, pattern=r"^phone_block_confirm:\d+$"))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, calculator_text_input), group=0)
    app.add_handler(CallbackQueryHandler(idea_callback_handler, pattern=r"^idea_(reward|cancel):\d+$"))
    app.add_handler(CallbackQueryHandler(sex_button_handler, pattern="^(confirm_sex|decline_sex):"))
    app.add_handler(CallbackQueryHandler(robbery_callback, pattern="^rob_"))
    app.add_handler(CallbackQueryHandler(condom_callback, pattern="^condom_"))
    app.add_handler(CallbackQueryHandler(baby_callback,
                                         pattern=r"^(confirm_baby:|decline_baby:|view_kid:|remove_kid:|confirm_remove_kid:|cancel_remove_kid:|feed_kid:|play_kid:|buy_food:|back_to_list)"))
    for handler in command_handlers:

        app.add_handler(handler)
        app.add_error_handler(error_handler)
    app.add_handler(CallbackQueryHandler(button_handler_colabsystem, pattern="^collab_"), group=1)
    app.add_handler(CallbackQueryHandler(db_info_callback, pattern=r"^db_info_"))
    app.add_handler(CallbackQueryHandler(db_back_callback, pattern=r"^db_back$"))
    app.add_handler(CallbackQueryHandler(bank_callback_handler, pattern=r"^bank_.*|^deposit_.*|^activate_deposit_.*"))
    app.add_handler(
        MessageHandler(filters.TEXT & ~filters.COMMAND, handle_rename_bank), group=10
    )

    conv_handler = ConversationHandler(
        entry_points=[CommandHandler("pays", paystatus_start)],
        states={
            AMOUNT: [MessageHandler(filters.TEXT & ~filters.COMMAND, paystatus_amount)],
            SCREENSHOT1: [MessageHandler(filters.PHOTO, paystatus_screenshot1)],
            SCREENSHOT2: [MessageHandler(filters.PHOTO, paystatus_screenshot2)],
        },
        fallbacks=[CommandHandler("cancel", cancel)],
        allow_reentry=True,
    )

    app.add_handler(conv_handler, group=10)
    app.add_handler(CallbackQueryHandler(admin_callback), group=9)
    app.add_handler(CommandHandler("buyadm", buyadm_command))
    app.add_handler(CallbackQueryHandler(handle_buyadm_callback, pattern=r'^(buy|cancel)_moderator\|'))
    app.add_handler(CallbackQueryHandler(zeroing_callback, pattern=r"^zero_(select|confirm|cancel|back):"))
    app.add_handler(CallbackQueryHandler(event_callback, pattern="^event_join$"))
    app.add_handler(CallbackQueryHandler(vip_status_handler, pattern=r"^vip_status_"))
    app.add_handler(CallbackQueryHandler(vip_days_handler, pattern=r"^vip_days_"))
    app.add_handler(CallbackQueryHandler(vip_buy_handler, pattern=r"^vip_buy_"))
    app.add_handler(CallbackQueryHandler(vip_back_handler, pattern="^vip_back$"))
    app.add_handler(CallbackQueryHandler(vip_back_handler, pattern="^vip_days_back$"))
    app.add_handler(CallbackQueryHandler(vip_off_callback_handler, pattern="^vip_off_"))
    app.add_handler(CallbackQueryHandler(delbank_callback, pattern=r"^confirm_delbank_|^cancel_delbank$"))
    app.add_handler(CallbackQueryHandler(cancel_callback_handler, pattern=r"^cancel_rename_"))
    app.add_handler(CallbackQueryHandler(show_referrals_callback, pattern="show_referrals"))
    app.add_handler(CallbackQueryHandler(show_profile, pattern="show_profile"))
    app.add_handler(CallbackQueryHandler(profile_stats_callback, pattern="^profile_stats$"))
    app.add_handler(CallbackQueryHandler(profile_other_callback, pattern="^profile_other$"))
    app.add_handler(CallbackQueryHandler(profile_back_callback, pattern="^profile_back$"))
    app.add_handler(CallbackQueryHandler(minigames_stats_menu, pattern="^minigames_stats$"))

    app.add_handler(CallbackQueryHandler(shops_menu, pattern="^profile_shops$"))
    app.add_handler(CallbackQueryHandler(shops_magaz, pattern="^magaz$"))
    app.add_handler(CallbackQueryHandler(shops_biz_magaz, pattern="^biz_magaz$"))

    app.add_handler(CallbackQueryHandler(button_handler, pattern="^cancel_code_wait$"))
    app.add_handler(CallbackQueryHandler(button_handler, pattern="^del_acc_"))
    app.add_handler(CallbackQueryHandler(bonus_callback, pattern=r"^bonus_\d+$"))

    app.add_handler(MessageHandler(filters.StatusUpdate.NEW_CHAT_MEMBERS, greet_new_member_message))
    app.add_handler(CallbackQueryHandler(warn_button_handler, pattern=r"^warn_(kick|permban|ignore):"))
    app.add_handler(MessageHandler(filters.StatusUpdate.LEFT_CHAT_MEMBER, farewell_member_message))
    app.add_handler(MessageHandler(filters.ALL, message_counter), group=-10)
    app.add_handler(MessageHandler(filters.TEXT & (~filters.COMMAND), observe_and_learn), group=-10)
    app.add_handler(MessageHandler(filters.TEXT & (~filters.COMMAND), code_message_handler), group=-9)
    app.add_handler(MessageHandler(filters.ALL & (~filters.COMMAND), collect_users), group=-9)
    # –ó–∞–ø—É—Å–∫ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏—Ö –∑–∞–¥–∞—á
    app.job_queue.run_repeating(check_expired_mutes, interval=60, first=10)
    app.job_queue.run_repeating(check_expired_bans, interval=60, first=10)
    app.job_queue.run_repeating(scheduled_price_update, interval=60, first=10)
    app.job_queue.run_repeating(scheduled_kid_status_update, interval=1800, first=10)
    app.add_handler(CallbackQueryHandler(bshop_page_callback, pattern=r"^bshop_page_\d+$"))
    app.add_handler(CallbackQueryHandler(handle_marriage_buttons, pattern=r"^marry_(accept|decline)_\d+_\d+$"), group=0)
    app.add_handler(CallbackQueryHandler(show_inventory_callback, pattern="^show_inventory$"), group=0)
    app.add_handler(CallbackQueryHandler(show_profile_callback, pattern="^show_profile$"), group=0)
    app.add_handler(CallbackQueryHandler(casino_button_handler,
                                         pattern="^(casino_menu|last_actions|top_users|top_wins|top_losses)$"), group=0)

    app.add_handler(CallbackQueryHandler(casino_choice_handler, pattern="^casino_(even|odd|cancel)$"), group=0)
    app.add_handler(CallbackQueryHandler(admins_handler, pattern="^admins_"), group=0)
    app.add_handler(CallbackQueryHandler(show_group_info, pattern="^show_group_info$"), group=0)
    app.add_handler(CallbackQueryHandler(back_to_start, pattern="^back_to_start$"), group=0)
    app.add_handler(CallbackQueryHandler(taxi_callback_handler), group=1)
    app.add_handler(CallbackQueryHandler(role_callback, pattern=r"^setrole_"), group=0)
    app.add_handler(CallbackQueryHandler(info_callback, pattern=r"^info_"), group=0)
    app.add_handler(CallbackQueryHandler(shop_callback, pattern=r"^shop_"), group=0)
    app.add_handler(CallbackQueryHandler(top_callback_handler, pattern=r"^top_"), group=0)
    app.add_handler(CallbackQueryHandler(top_callback_handler,
                                         pattern=r"^top_|^back_to_top_menu$|^top_messages_menu$|^top_balance$|^top_level$|^top_messages_global$|^top_messages_local$"),
                    group=0)

    app.add_handler(CallbackQueryHandler(businessX_callback, pattern=r"^buybiz_\d+$"), group=0)
    app.add_handler(
        CallbackQueryHandler(
            Casecallback_handler,
            pattern=r"^(case_|contents_|buy_|buyqty_|open_|openqty_|back_to_menu)"
        ),
        group=0
    )

    app.add_handler(CallbackQueryHandler(handle_clan_transfer_callback, pattern="^(confirm_transfer|cancel_transfer):"),
                    group=0)
    app.add_handler(CallbackQueryHandler(confirm_leave_clan, pattern=r"^confirm_leaveclan:"), group=0)
    app.add_handler(CallbackQueryHandler(cancel_leave_clan, pattern=r"^cancel_leaveclan:"), group=0)
    app.add_handler(CallbackQueryHandler(clan_info_callback, pattern=r"^clan_info_"), group=0)
    app.add_handler(CallbackQueryHandler(clans, pattern=r"^clans_"), group=0)
    app.add_handler(CallbackQueryHandler(join_clan_callback, pattern=r"^join_clan_"), group=0)
    app.add_handler(CallbackQueryHandler(mclan_callback, pattern=r"^mclan_\d+$"), group=0)
    app.add_handler(CallbackQueryHandler(clan_members_callback, pattern=r"^clan_members_\d+_page_\d+$"), group=0)
    app.add_handler(CallbackQueryHandler(uninvite_callback, pattern=r"^uninvitec_\d+$"), group=0)
    app.add_handler(CallbackQueryHandler(delclan_callback, pattern=r"^delclan_(confirm|cancel)_\d+$"), group=0)
    app.add_handler(CallbackQueryHandler(handle_divorce, pattern=r"^divorce_"), group=0)
    app.add_handler(CallbackQueryHandler(kids_callback_handler, pattern="^(kids_page:|view_kid:|no_action)"))
    app.add_handler(CallbackQueryHandler(toggle_link_setting_callback, pattern=r"^toggle_link_"))
    app.add_handler(CallbackQueryHandler(handle_report_callback, pattern=r"^(mute|delete|close):"))
    app.add_handler(CallbackQueryHandler(bpay_callback_handler, pattern=r"^bpay_(confirm|cancel)$"))
    app.add_handler(CallbackQueryHandler(handle_business_buttons, pattern="^business_"))
    app.add_handler(CallbackQueryHandler(business_sell, pattern="^sellbiz_"))
    app.add_handler(CallbackQueryHandler(business_sell, pattern="^confirm_sell_yes_"))
    app.add_handler(CallbackQueryHandler(business_sell, pattern="^confirm_sell_no_"))
    app.add_handler(CallbackQueryHandler(show_inventory, pattern="dev_soon"))
    app.add_handler(CallbackQueryHandler(admin_store_callback, pattern=r"^admin_store\|\d+$"))
    app.add_handler(CallbackQueryHandler(admin_promotion_callback, pattern=r"^admin_promotion\|"))
    app.add_handler(CallbackQueryHandler(remove_warn_callback, pattern=r"^remove_warn\|\d+$"))
    app.add_handler(CallbackQueryHandler(admin_back_callback, pattern=r"^admin_back\|\d+$"))
    app.add_handler(CallbackQueryHandler(to_bot_currency_callback, pattern=r"^to_bot_currency\|\d+$"))
    app.add_handler(CallbackQueryHandler(conversion_callback, pattern="^convert_"))
    app.add_handler(CallbackQueryHandler(admin_functions_callback, pattern=r"^admin_functions\|"), group=0)
    app.add_handler(CallbackQueryHandler(admin_functions_callback, pattern=r"^admin_menu\|"))
    app.add_handler(CallbackQueryHandler(admin_functions_callback, pattern=r"^cooldown_menu\|"))
    app.add_handler(CallbackQueryHandler(admin_functions_callback, pattern=r"^cd_select\|"))
    app.add_handler(CallbackQueryHandler(admin_functions_callback, pattern=r"^log_menu\|"))
    app.add_handler(CallbackQueryHandler(admin_functions_callback, pattern=r"^log_type\|"))
    app.add_handler(CallbackQueryHandler(admin_logs_pagination_manual, pattern=r"^log_page\|"))
    app.add_handler(CallbackQueryHandler(admin_log_details, pattern=r"^log_detail\|"))
    # Callback –¥–ª—è –∫–Ω–æ–ø–æ–∫ –≤—ã–±–æ—Ä–∞ —Ñ—É–Ω–∫—Ü–∏–∏ –ö–î
    app.add_handler(CallbackQueryHandler(cooldown_callback, pattern=r"^(cd_input|cancel_cd)\|"))

    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_amount), group=-2)

    app.add_handler(CallbackQueryHandler(collab, pattern="^collab_open$"))
    app.add_handler(CallbackQueryHandler(back_to_profile_handler, pattern="^back_to_profile_is_collab$"))

    app.add_handler(CallbackQueryHandler(robbery_immunity_menu, pattern="^robbery_immunity$"))
    app.add_handler(CallbackQueryHandler(robbery_back_main_handler, pattern="^robbery_back_main$"))
    app.add_handler(CallbackQueryHandler(robbery_activate_menu, pattern="^robbery_activate$"))
    app.add_handler(CallbackQueryHandler(robbery_select_payment, pattern="^robbery_duration_\\d+[hd]$"))
    app.add_handler(CallbackQueryHandler(robbery_confirm, pattern="^robbery_pay_(dc|seeds)$"))
    app.add_handler(CallbackQueryHandler(robbery_pay_handler, pattern=r"^robbery_pay_(seeds|dc)_[0-9]+$"))
    app.add_handler(CallbackQueryHandler(main_menu_handler, pattern="^main_menu$"))
    app.add_handler(CallbackQueryHandler(robbery_list_menu, pattern="^robbery_list$"))
    app.add_handler(CallbackQueryHandler(robbery_top_menu, pattern="^robbery_top_menu$"))
    app.add_handler(CallbackQueryHandler(robbery_top_category, pattern="^robbery_top_"))
    app.add_handler(CallbackQueryHandler(robbery_open_callback, pattern="^robbery_menu$"))
    app.add_handler(CallbackQueryHandler(profile_open_ferniex_callback, pattern="^profile_menu$"))
    app.add_handler(CallbackQueryHandler(pre_answer_callback, pattern="^pre_answer:"))
    app.add_handler(CallbackQueryHandler(answer_command, pattern="^confirm_answer:"))
    app.add_handler(CallbackQueryHandler(answer_command, pattern="^cancel_answer:"))
    app.add_handler(CallbackQueryHandler(handle_choose_coin, pattern=r"^choose_coin:"))
    app.add_handler(CallbackQueryHandler(handle_choose_coeff, pattern=r"^choose_coeff:"))
    app.add_handler(CallbackQueryHandler(handle_bet, pattern=r"^bet:"))
    app.add_handler(CallbackQueryHandler(handle_wallet, pattern=r"^wallet$"))
    app.add_handler(CallbackQueryHandler(handle_cancel, pattern=r"^cancel$"))
    app.add_handler(CallbackQueryHandler(handle_back_to_menu, pattern=r"^back_to_crypto_game_menu$"))
    app.add_handler(CallbackQueryHandler(show_business_details, pattern=r"^showbiz_\d+_\d+$"))
    app.add_handler(CallbackQueryHandler(back_to_bmenu_callback, pattern="^back_to_bmenu$"))
    app.add_handler(CallbackQueryHandler(sell_business_callback, pattern=r"^sellbiz_\d+_\d+$"))
    app.add_handler(CallbackQueryHandler(confirm_sell_callback, pattern=r"^confirm_sell_\d+_\d+$"))
    app.add_handler(CallbackQueryHandler(cancel_sell_callback, pattern=r"^cancel_sell_\d+_\d+$"))
    app.add_handler(CallbackQueryHandler(hire_employees_callback, pattern=r"^hire_\d+_\d+$"))
    app.add_handler(CallbackQueryHandler(upgrade_business, pattern=r"^upgradebiz_\d+_\d+$"))
    app.add_handler(CallbackQueryHandler(collect_profit_handler, pattern=r"^collectprofit_\d+_\d+$"))
    app.add_handler(CallbackQueryHandler(collect_all_profit_handler, pattern=r"^collect_all_profit_\d+$"))
    app.add_handler(CallbackQueryHandler(limit_vip_bis_callback, pattern=r"^limit_vip_bis_\d+$"))
    app.add_handler(CallbackQueryHandler(limit_vip_transfer_callback, pattern=r"^limit_vip_transfer_\d+$"))
    app.add_handler(CallbackQueryHandler(limit_list_vip_back_callback, pattern=r"^limit_list_vip_back_\d+$"))
    app.add_handler(CallbackQueryHandler(ver_callback, pattern=r"^ver:.*$"))

    app.add_handler(
        MessageHandler(
            filters.ChatType.GROUPS & ~filters.COMMAND,
            auto_mute_check
        ),
        group=-100
    )

    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_rp), group=-5)
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_russian_command), group=-6)

    app.add_handler(MessageHandler(
        filters.TEXT & ~filters.COMMAND,
        delete_offensive_messages
    ), group=7)

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–æ–π –∫–∞–∑–Ω—ã
    print("\n" + "=" * 50)
    print("üßê –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–ª–∞–Ω—Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–æ–π –∫–∞–∑–Ω—ã...")
    try:
        balance = get_admin_treasury_balance()
        print(f"üí∞ –ë–∞–ª–∞–Ω—Å –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–æ–π –ö–∞–∑–Ω—ã: {balance:,} üí∞")
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –±–∞–ª–∞–Ω—Å–∞: {e}")
    print("=" * 50 + "\n")

    print("üöÄ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!")
    print("–î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞–∂–º–∏—Ç–µ Ctrl+C")
    print("‚úÖ –í—Å–µ —Å–∏—Å—Ç–µ–º—ã —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ")

    # –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
    try:
        app.run_polling(
            drop_pending_updates=True,
            close_loop=False,
            stop_signals=None
        )

    except asyncio.CancelledError:
        print("\nüõë –ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª –æ—Å—Ç–∞–Ω–æ–≤–∫–∏...")
    except Exception as e:
        print(f"\n‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}")
    finally:
        print("üëã –ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")


if __name__ == "__main__":
    try:
        asyncio.run(main())
    except KeyboardInterrupt:
        print("\nüõë –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–æ—Ç–∞")
